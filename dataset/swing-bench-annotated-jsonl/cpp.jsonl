{"problem_statement": "Display a warning message for problematic OpenSSL versions\nIn ProxySQL 3.0 we stopped using statically linked OpenSSL in favor of dynamically linked.\nThis also means that an outdated version of OpenSSL can considerably slowdown ProxySQL.\nFor example, in a CI run where OpenSSL 3.0.2 is installed, the test `test_cacert_load_and_verify_duration-t` fails with:\n```\nmsg: not ok 1 - 2025-02-14 22:49:32.351206 - Total duration is '60871 ms' should be less than 20 Seconds\n```\n\nI think we need to take a series of actions:\n* [ ] export via status variables what OpenSSL version is in use\n* [ ] test `test_cacert_load_and_verify_duration-t` should check OpenSSL version using such variable, and adjust the time threshold\n* [ ] When ProxySQL prints the OpenSSL version (ex: `[INFO] Using OpenSSL version: OpenSSL 3.0.2 15 Mar 2022`) it should also display a warning for problematic known OpenSSL versions\n\n\nNote:\nMaybe (not sure) issue #4828 is related to OpenSSL version too\n", "patch": "diff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex c6b477f93..3e314a8c3 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -591,6 +591,7 @@ void ProxySQL_Admin::stats___mysql_global() {\n \t}\n \n \tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"OpenSSL_Version_Num\", OpenSSL_version_num());\n \n \tstatsdb->execute(\"COMMIT\");\n }\ndiff --git a/src/main.cpp b/src/main.cpp\nindex 7c1006c01..8f9ce9316 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -341,8 +341,15 @@ static void init_locks(void) {\n static bool check_openssl_version() {\n \tunsigned long version = OpenSSL_version_num();\n \tconst unsigned long OPENSSL_3_0_0 = 0x30000000L;\n+\tconst unsigned long OPENSSL_3_2_0 = 0x30200000L;\n \n \tproxy_info(\"Using OpenSSL version: %s\\n\", OpenSSL_version(OPENSSL_VERSION));\n+\tif (version > OPENSSL_3_0_0 && version < OPENSSL_3_2_0) {\n+\t\tproxy_warning(\n+\t\t\t\"Detected OpenSSL version has known performance regressions, please upgrade to '3.2.0' or later.\"\n+\t\t\t\" For further details, please refer to: https://github.com/openssl/openssl/issues/18814\\n\"\n+\t\t);\n+\t}\n \tif (version < OPENSSL_3_0_0) {\n \t\tproxy_error(\"%s\\n\", \"ProxySQL server required openssl version 3.0.0 or above\");\n \t\treturn false;\n", "instance_id": "sysown__proxysql-4881", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in outlining the goal of addressing performance issues related to specific OpenSSL versions in ProxySQL by displaying warnings, exporting version information via status variables, and adjusting test thresholds. It specifies the context (dynamic linking of OpenSSL in ProxySQL 3.0), provides an example of a failing test with a specific error message, and lists actionable tasks. However, there are minor ambiguities and missing details. For instance, it does not explicitly define what constitutes a \"problematic\" OpenSSL version beyond the example of 3.0.2, nor does it specify the exact threshold adjustments for the test or how the status variables should be used in practice. Additionally, the reference to issue #4828 as potentially related introduces uncertainty without actionable detail. Overall, while the intent and high-level requirements are clear, some specifics are left to interpretation, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to the relatively straightforward nature of the required changes and the limited scope of technical complexity. Analyzing the factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are confined to two files (`ProxySQL_Admin_Stats.cpp` and `main.cpp`), with minimal modifications. In `ProxySQL_Admin_Stats.cpp`, a single line is added to export the OpenSSL version as a status variable. In `main.cpp`, a conditional check and warning message are added for specific OpenSSL versions. These changes are localized, do not impact the broader system architecture, and involve a small amount of code (less than 10 lines of meaningful additions). No deep understanding of interactions across the codebase is required beyond knowing where OpenSSL version information is accessed and logged.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with C++ (as the codebase appears to be in C++), specifically handling version numbers as unsigned longs, using conditional logic, and interacting with OpenSSL library functions like `OpenSSL_version_num()` and `OpenSSL_version()`. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic OpenSSL version handling is needed. The concepts are relatively simple and accessible to a developer with intermediate C++ experience.\n\n3. **Edge Cases and Error Handling:** The problem statement and code changes do not explicitly address complex edge cases or error handling beyond identifying a version range (between 3.0.0 and 3.2.0) for warnings. There is no indication of needing to handle scenarios like missing OpenSSL libraries, version parsing errors, or dynamic loading failures. The simplicity of the version check logic suggests minimal complexity in this area.\n\n4. **Overall Complexity:** While the problem touches on performance considerations (slowdowns due to OpenSSL versions), the solution itself does not require addressing performance directly—just reporting and warning about versions. The remaining tasks mentioned in the problem statement (e.g., adjusting test thresholds) are not reflected in the provided code changes, so they are not factored into this evaluation. If those tasks were included, the difficulty might slightly increase due to test logic modifications, but it would likely remain in the Easy range.\n\nGiven these points, a difficulty score of 0.35 is appropriate, reflecting a task that requires understanding some code logic (OpenSSL version handling and logging) and making simple modifications, but does not demand deep architectural changes or advanced technical expertise.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[FEATURE] Action to check that the generated code is up to date\n- the `code_generation/` directory contains the code generator including its configuration.\r\n- It is important that the generated code is up to date. i.e.:\r\n  - no manual code changes were made to generated files; generated files should remain generated\r\n  - the generated files are up to date with the latest code generator including its input configuration\r\n\r\nThis issue is about adding a github action check that that is indeed the case.\r\n\r\n## TODO\r\n\r\n* [x] Update all files in the `code_generation/templates/` directory\r\n  * [x] Those files currently contain the string `This header file is automatically generated. DO NOT modify it manually!`\r\n  * [x] There is at least one CPP file that is clearly not a header file but does contain the string `header`. That is clearly wrong (as it's not a header but a CPP file)\r\n  * [x] Instead, the string should be: `This file is automatically generated. DO NOT modify it manually!`\r\n  * [x] Run the `code_generation/code_gen.py` file to update all generated files and check them in\r\n* [x] Create the github action\r\n  * [x] Install all dependencies (found in `code_generation/requirements.txt`)\r\n  * [x] Run `code_generation/code_gen.py`\r\n  * [x] Check that the `git status` is empty\r\n    * [x] should pass if it is empty\r\n    * [x] should fail action if it isn't empty and list the changed files\r\n    * [x] look up the exact command in the `git` documentation to do this\r\n  * [x] To prevent unnecessary checks, the action should only run if and only if the following checked-in files and directories are changed:\r\n    * [x] `code_generation/`\r\n    * [x] All files and directories that contain the string `This file is automatically generated. DO NOT modify it manually!`\r\n      * [x] In particular, those are the files that the templates `code_generation/templates/` map to\r\n      * [x] That is: `code_generation/templates/x/.../y.z` maps to `x/.../y.z`\r\n\n", "patch": "diff --git a/.github/workflows/check-code-quality.yml b/.github/workflows/check-code-quality.yml\nindex 85aabd328..dc3c5a0d8 100644\n--- a/.github/workflows/check-code-quality.yml\n+++ b/.github/workflows/check-code-quality.yml\n@@ -75,3 +75,18 @@ jobs:\n             git status --porcelain --untracked-files=no\n             exit 1\n           fi\n+      \n+      - name: Check generated code\n+        if: success()\n+        run: |\n+          pip install -r code_generation/requirements.txt\n+          python code_generation/code_gen.py\n+          if [ -n \"$(git status --porcelain)\" ]; then\n+            echo\n+            echo \"The following files are outdated or were manually updated:\"\n+            git status --porcelain\n+            exit 1\n+          else\n+            echo\n+            echo \"All the generated files are up to date.\"\n+          fi\ndiff --git a/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja b/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\nindex ff9ff3b7d..ed849f3db 100644\n--- a/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\n+++ b/code_generation/templates/power_grid_model_c/power_grid_model_c/src/dataset_class_maps.cpp.jinja\n@@ -2,7 +2,7 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-// This header file is automatically generated. DO NOT modify it manually!\n+// This file is automatically generated. DO NOT modify it manually!\n \n // clang-format off\n \ndiff --git a/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp b/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\nindex 70bd343b9..52951134e 100644\n--- a/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/dataset_definitions.cpp\n@@ -2,7 +2,7 @@\n //\n // SPDX-License-Identifier: MPL-2.0\n \n-// This header file is automatically generated. DO NOT modify it manually!\n+// This file is automatically generated. DO NOT modify it manually!\n \n // clang-format off\n \n", "instance_id": "PowerGridModel__power-grid-model-658", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "\nThe problem statement is mostly clear in describing the goal of ensuring that generated code remains up-to-date and unmodified manually, as well as implementing a GitHub Action to enforce this. It provides a detailed breakdown of tasks, such as updating template files, running a code generator, and checking for changes via `git status`. The context of the `code_generation/` directory and the mapping of templates to generated files is also explained. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem does not explicitly define what constitutes a \"manual change\" or how to handle cases where generated files might legitimately differ due to external factors (e.g., environment differences). Additionally, while the GitHub Action's logic is outlined, there is no mention of specific edge cases, such as what to do if dependencies fail to install or if the code generator itself encounters errors. These omissions could lead to implementation challenges or misinterpretations.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.35, placing it in the \"Easy\" range (0.2-0.4). Here's the reasoning based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized. The GitHub Action addition involves modifying a single workflow file (`.github/workflows/check-code-quality.yml`) with a straightforward script to install dependencies, run a Python script, and check `git status`. Additionally, there are minor textual updates to template and generated files (changing \"header file\" to \"file\" in comments). These changes do not impact the broader system architecture or require deep interaction with other parts of the codebase. The overall amount of code change is small.\n\n2. **Number of Technical Concepts**: The problem requires basic familiarity with several concepts, but none are particularly complex. These include GitHub Actions (writing a simple workflow with conditional execution and shell commands), basic Git commands (`git status --porcelain`), and Python scripting (running a provided code generator script and installing dependencies via `pip`). There are no advanced algorithms, design patterns, or domain-specific knowledge required beyond general software development practices.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes imply some basic error handling, such as failing the action if `git status` shows changes. However, more complex edge cases (e.g., dependency installation failures, code generator runtime errors, or differences in generated output due to environment variations) are not addressed in the problem or code changes. Implementing robust error handling for these scenarios would increase difficulty, but as presented, the requirements are minimal.\n\n4. **Overall Complexity**: The task is straightforward for a developer with basic experience in CI/CD pipelines and scripting. It involves understanding a small part of the codebase (`code_generation/` directory and GitHub workflows) and making simple modifications. There are no performance considerations, architectural changes, or intricate logic to implement.\n\nIn summary, this problem is easy because it involves limited code changes, basic technical concepts, and minimal complexity in logic or error handling. It is slightly above the \"Very Easy\" range (0.0-0.2) due to the need to understand GitHub Actions and coordinate multiple steps (dependency installation, script execution, and status checking), but it does not reach the \"Medium\" difficulty level (0.4-0.6) as it lacks deeper architectural impact or complex technical challenges.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "build: Boost 1.74.0 incompatible with Clang 18\nPointed out here: https://github.com/bitcoin/bitcoin/pull/30739#pullrequestreview-2267576746.\r\nCompiling with Clang 18 and Boost 1.74.0 fails:\r\n```bash\r\nIn file included from /usr/include/boost/mpl/integral_c.hpp:32:\r\n/usr/include/boost/mpl/aux_/integral_wrapper.hpp:73:31: error: integer value -1 is outside the valid range of values [0, 3] for the enumeration type 'udt_builtin_mixture_enum' [-Wenum-constexpr-conversion]\r\n   73 |     typedef AUX_WRAPPER_INST( BOOST_MPL_AUX_STATIC_CAST(AUX_WRAPPER_VALUE_TYPE, (value - 1)) ) prior;\r\n      |                               ^\r\n/usr/include/boost/mpl/aux_/static_cast.hpp:24:47: note: expanded from macro 'BOOST_MPL_AUX_STATIC_CAST'\r\n   24 | #   define BOOST_MPL_AUX_STATIC_CAST(T, expr) static_cast<T>(expr)\r\n      |                                               ^\r\nIn file included from ../../../src/test/validation_chainstatemanager_tests.cpp:8:\r\nIn file included from ../../../src/node/chainstatemanager_args.h:9:\r\nIn file included from ../../../src/validation.h:28:\r\nIn file included from ../../../src/txmempool.h:26:\r\nIn file included from /usr/include/boost/multi_index/hashed_index.hpp:38:\r\nIn file included from /usr/include/boost/multi_index/detail/node_handle.hpp:22:\r\nIn file included from /usr/include/boost/multi_index_container_fwd.hpp:18:\r\nIn file included from /usr/include/boost/multi_index/indexed_by.hpp:17:\r\nIn file included from /usr/include/boost/mpl/vector.hpp:36:\r\nIn file included from /usr/include/boost/mpl/vector/vector20.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/vector10.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/vector0.hpp:24:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/clear.hpp:18:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/vector0.hpp:22:\r\nIn file included from /usr/include/boost/mpl/vector/aux_/iterator.hpp:19:\r\nIn file included from /usr/include/boost/mpl/plus.hpp:19:\r\nIn file included from /usr/include/boost/mpl/aux_/arithmetic_op.hpp:17:\r\nIn file included from /usr/include/boost/mpl/integral_c.hpp:32:\r\n/usr/include/boost/mpl/aux_/integral_wrapper.hpp:73:31: error: integer value -1 is outside the valid range of values [0, 3] for the enumeration type 'int_float_mixture_enum' [-Wenum-constexpr-conversion]\r\n/usr/include/boost/mpl/aux_/static_cast.hpp:24:47: note: expanded from macro 'BOOST_MPL_AUX_STATIC_CAST'\r\n   24 | #   define BOOST_MPL_AUX_STATIC_CAST(T, expr) static_cast<T>(expr)\r\n      |                                               ^\r\n2 errors generated.\r\n```\r\n\r\nThe same failure does not happen with GCC (12), but may do with later versions: https://sourceware.org/bugzilla/show_bug.cgi?id=31331.\r\n\r\nGiven our documentation currently claims that Boost `1.73.0` is supported, this should be fixed in some way, the documentation updated to drop support for this version, etc. Although, it looks like part of the fix for the Boost code only landed as of 1.86.0? https://github.com/boostorg/mpl/issues/69 (currently the latest release).\n", "patch": "diff --git a/src/txmempool.h b/src/txmempool.h\nindex d0cb41a078ec2..7fdf1c5a39ae9 100644\n--- a/src/txmempool.h\n+++ b/src/txmempool.h\n@@ -23,7 +23,17 @@\n #include <util/result.h>\n #include <util/feefrac.h>\n \n+// This works around a bug in Boost <= 1.80.0 when using Clang >=18.\n+// See https://github.com/bitcoin/bitcoin/issues/30751.\n+#if defined(__clang__)\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wenum-constexpr-conversion\"\n+#endif\n #include <boost/multi_index/hashed_index.hpp>\n+#if defined(__clang__)\n+#pragma clang diagnostic pop\n+#endif\n+\n #include <boost/multi_index/identity.hpp>\n #include <boost/multi_index/indexed_by.hpp>\n #include <boost/multi_index/ordered_index.hpp>\n", "instance_id": "bitcoin__bitcoin-30821", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a compatibility problem between Boost 1.74.0 and Clang 18, leading to compilation errors due to enum conversion issues. It provides detailed error logs, references to related discussions, and links to external resources (e.g., Boost issue tracker and GCC bug reports). The goal is implied—to resolve the compilation failure—though it is not explicitly stated whether the solution should be a code workaround, a documentation update, or a dependency version change. Additionally, there are minor ambiguities regarding the expected long-term resolution (e.g., whether Boost support for versions <1.86.0 should be dropped or if a more permanent fix is needed). Constraints and edge cases are not explicitly discussed in the problem statement, though the provided links hint at broader implications. Overall, the statement is valid and clear but lacks some explicit details about the desired outcome and scope of the fix.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal and localized to a single file (`txmempool.h`). It involves adding a compiler-specific pragma to suppress a warning (`-Wenum-constexpr-conversion`) when using Clang, which is a straightforward workaround. The change does not impact the broader architecture of the system or require modifications across multiple modules. The amount of code change is very small (a few lines).\n\n2. **Technical Concepts Involved:** The solution requires basic knowledge of compiler-specific pragmas and an understanding of how to suppress warnings in Clang. It does not involve complex algorithms, design patterns, or deep domain-specific knowledge beyond familiarity with C++ compilation issues and Boost library usage. The concept of enum conversion warnings is relatively simple for someone with moderate C++ experience.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, and the code change does not introduce new logic that requires handling edge cases or modifying error handling. The workaround is purely a build-time fix and does not affect runtime behavior.\n\n4. **Overall Complexity:** While the underlying issue (Boost and Clang incompatibility) might seem complex, the provided solution is a simple and pragmatic fix that does not require deep investigation or extensive modifications. However, it is worth noting that a more permanent solution (e.g., updating Boost version requirements or contributing a fix upstream) could increase the difficulty, but the current change is limited in scope.\n\nGiven these points, a difficulty score of 0.25 reflects the simplicity of the code change and the minimal technical depth required to implement the workaround. It is slightly above the \"Very Easy\" range due to the need to understand the context of the Boost-Clang compatibility issue and the implications of suppressing warnings, which requires some familiarity with C++ build systems.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Build fails with boost 1.86\nWith Boost 1.86.0-2, I get the following error during build:\r\n```\r\nIn file included from src/exprbase.h:56,\r\n                 from src/draft.h:44,\r\n                 from src/stats.cc:34\r\nsrc/utils.h: In function ‘ledger::string ledger::sha1sum(const string&)’:\r\nsrc/utils.h:602:18: error: cannot convert ‘unsigned int [5]’ to ‘unsigned char (&)[20]’\r\n  602 |   sha.get_digest(message_digest);\r\n      |                  ^~~~~~~~~~~~~~\r\n      |                  |\r\n      |                  unsigned int [5]\r\nIn file included from src/utils.h:46:\r\n/usr/include/boost/uuid/detail/sha1.hpp:179:43: note:   initializing argument 1 of ‘void boost::uuids::detail::sha1::get_digest(unsigned char (&)[20])’\r\n  179 | inline void sha1::get_digest(digest_type& digest)\r\n      |                              ~~~~~~~~~~~~~^~~~~~\r\n```\nBuild fails with boost 1.86\nWith Boost 1.86.0-2, I get the following error during build:\r\n```\r\nIn file included from src/exprbase.h:56,\r\n                 from src/draft.h:44,\r\n                 from src/stats.cc:34\r\nsrc/utils.h: In function ‘ledger::string ledger::sha1sum(const string&)’:\r\nsrc/utils.h:602:18: error: cannot convert ‘unsigned int [5]’ to ‘unsigned char (&)[20]’\r\n  602 |   sha.get_digest(message_digest);\r\n      |                  ^~~~~~~~~~~~~~\r\n      |                  |\r\n      |                  unsigned int [5]\r\nIn file included from src/utils.h:46:\r\n/usr/include/boost/uuid/detail/sha1.hpp:179:43: note:   initializing argument 1 of ‘void boost::uuids::detail::sha1::get_digest(unsigned char (&)[20])’\r\n  179 | inline void sha1::get_digest(digest_type& digest)\r\n      |                              ~~~~~~~~~~~~~^~~~~~\r\n```\n", "patch": "diff --git a/src/filters.cc b/src/filters.cc\nindex b5b7fb19f..523fa7959 100644\n--- a/src/filters.cc\n+++ b/src/filters.cc\n@@ -237,8 +237,6 @@ void anonymize_posts::render_commodity(amount_t& amt)\n \n void anonymize_posts::operator()(post_t& post)\n {\n-\tboost::uuids::detail::sha1  sha;\n-  unsigned int message_digest[5];\n   bool         copy_xact_details = false;\n \n   if (last_xact != post.xact) {\n@@ -255,12 +253,7 @@ void anonymize_posts::operator()(post_t& post)\n     std::ostringstream buf;\n     buf << reinterpret_cast<boost::uintmax_t>(post.xact->payee.c_str())\n         << integer_gen() << post.xact->payee.c_str();\n-\n-\t\tsha.reset();\n-    sha.process_bytes(buf.str().c_str(), buf.str().length());\n-    sha.get_digest(message_digest);\n-\n-    xact.payee = to_hex(message_digest);\n+    xact.payee = sha1sum(buf.str(), 8);\n     xact.note  = none;\n   } else {\n     xact.journal = post.xact->journal;\n@@ -273,12 +266,7 @@ void anonymize_posts::operator()(post_t& post)\n        acct = acct->parent) {\n     std::ostringstream buf;\n     buf << integer_gen() << acct << acct->fullname();\n-\n-    sha.reset();\n-    sha.process_bytes(buf.str().c_str(), buf.str().length());\n-    sha.get_digest(message_digest);\n-\n-    account_names.push_front(to_hex(message_digest));\n+    account_names.push_front(sha1sum(buf.str(), 8));\n   }\n \n   account_t * new_account =\n@@ -1269,7 +1257,7 @@ void budget_posts::report_budget_items(const date_t& date)\n     foreach (pending_posts_list::iterator& i, posts_to_erase)\n       pending_posts.erase(i);\n   }\n-  \n+\n   if (pending_posts.size() == 0)\n     return;\n \ndiff --git a/src/utils.h b/src/utils.h\nindex bc05ff4f9..13cf26f63 100644\n--- a/src/utils.h\n+++ b/src/utils.h\n@@ -578,29 +578,39 @@ inline int peek_next_nonws(std::istream& in) {\n     *_p = '\\0';                                         \\\n   }\n \n-inline string to_hex(unsigned int * message_digest, const int len = 1)\n-{\n+inline string digest_to_hex(\n+  const boost::uuids::detail::sha1::digest_type& message_digest,\n+  size_t len = sizeof(boost::uuids::detail::sha1::digest_type) * 2\n+) {\n   std::ostringstream buf;\n-\n-  for(int i = 0; i < 5 ; i++) {\n-    buf.width(8);\n-    buf.fill('0');\n-    buf << std::hex << message_digest[i];\n-    if (i + 1 >= len)\n-      break;                    // only output the first LEN dwords\n+  buf.setf(std::ios_base::hex, std::ios_base::basefield);\n+  buf.fill('0');\n+\n+  // sha1::digest_type is an array type and may change between Boost versions\n+  const size_t count = std::min(\n+    sizeof(message_digest) / sizeof(message_digest[0]),\n+    (len - 1) / (sizeof(message_digest[0]) * 2) + 1\n+  );\n+  for(size_t i = 0; i < count; i++) {\n+    buf.width(sizeof(message_digest[i]) * 2);\n+    buf << (unsigned int)message_digest[i];\n   }\n-  return buf.str();\n+  string hex = buf.str();\n+  hex.resize(len, '0'); // in case a partial element is requested\n+  return hex;\n }\n \n-inline string sha1sum(const string& str)\n-{\n-\tboost::uuids::detail::sha1 sha;\n+inline string sha1sum(\n+  const string& str,\n+  size_t len = sizeof(boost::uuids::detail::sha1::digest_type) * 2\n+) {\n+\tstatic boost::uuids::detail::sha1 sha;\n+  boost::uuids::detail::sha1::digest_type message_digest;\n \n+\tsha.reset();\n   sha.process_bytes(str.c_str(), str.length());\n-\n-  unsigned int message_digest[5];\n   sha.get_digest(message_digest);\n-  return to_hex(message_digest, 5);\n+  return digest_to_hex(message_digest, len);\n }\n \n extern const string version;\n", "instance_id": "ledger__ledger-2381", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a build failure with Boost 1.86 due to a type mismatch in the SHA1 digest retrieval process. The error message provided in the statement explicitly points to the problematic code in `src/utils.h` and highlights the incompatibility between the expected and actual types for the `get_digest` method. However, the statement lacks additional context about the broader codebase, the purpose of the SHA1 functionality, or any specific constraints or requirements for the fix (e.g., maintaining compatibility with older Boost versions). There are also no examples or test cases provided to validate the solution. While the issue is clear enough to understand the root cause, these missing details prevent it from being comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The changes are relatively localized, primarily affecting `src/utils.h` for the SHA1 digest handling and `src/filters.cc` for updating the usage of the modified functions. The diff shows a moderate amount of code change, but it is focused on refactoring the SHA1 digest retrieval and conversion to hexadecimal format. There is no indication of widespread impact on the system's architecture or interactions with other modules beyond the immediate usage in `filters.cc`.\n\n2. **Number of Technical Concepts**: Solving this requires understanding C++ type systems, specifically array type compatibility and casting between `unsigned int` and `unsigned char` arrays. Additionally, familiarity with the Boost library (specifically `boost::uuids::detail::sha1`) and its API changes across versions is necessary. The concepts involved are not overly complex for an experienced C++ developer, though they do require attention to detail regarding type safety and Boost's internal implementation.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce significant new error handling logic. However, the solution must ensure that the digest-to-hex conversion handles partial digest lengths correctly (as seen in the updated `digest_to_hex` function). This adds a minor layer of complexity, but it is manageable.\n\n4. **Overall Complexity**: The fix involves updating the function signatures and logic to align with the Boost 1.86 API, which is a straightforward compatibility issue. It requires some understanding of the codebase's use of SHA1 for anonymization (as seen in `filters.cc`), but the changes are not deeply intricate or architecturally significant.\n\nGiven these considerations, a difficulty score of 0.35 reflects an Easy problem that requires understanding specific code logic and making targeted modifications to address a library compatibility issue. It is slightly above the lower end of the Easy range due to the need for familiarity with Boost's SHA1 implementation and careful handling of type conversions.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "desktopCapturer crashing on linux w/XDP when the capture portal is dismissed/closed\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.0.0, 33.0.0, 34.0.0\n\n### What operating system(s) are you using?\n\nOther Linux\n\n### Operating System Version\n\nLinux bakery 6.12.9-zen1-1-zen #1 ZEN SMP PREEMPT_DYNAMIC Fri, 10 Jan 2025 00:39:35 +0000 x86_64 GNU/Linux\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n31.3.1 - No crashing but cannot open another portal request. 31.4.0 & later crashes\n\n### Expected Behavior\n\nDoesn't crash & allows following requests\n\n### Actual Behavior\n\nWhen the user closes the portal picker electron will crash.\n\n### Testcase Gist URL\n\nhttps://www.electronjs.org/docs/latest/api/desktop-capturer the example provided is a simple repro\n\n### Additional Information\n\nWhen attempting this from chromium the same errors will be spit out but there is no crash and can make following pick attempts so I believe theyre unrelated. Other than that theres no logs.\n```\n[10356:10356:0114/163419.616405:ERROR:screencast_portal.cc(367)] Failed to start the screen cast session.\n[10356:10356:0114/163419.616432:ERROR:base_capturer_pipewire.cc(81)] ScreenCastPortal failed: 2\n```\n", "patch": "diff --git a/shell/browser/api/electron_api_desktop_capturer.cc b/shell/browser/api/electron_api_desktop_capturer.cc\nindex b7d7177bf47a9..1fcb7fbaa54c7 100644\n--- a/shell/browser/api/electron_api_desktop_capturer.cc\n+++ b/shell/browser/api/electron_api_desktop_capturer.cc\n@@ -15,6 +15,7 @@\n #include \"chrome/browser/media/webrtc/desktop_media_list.h\"\n #include \"chrome/browser/media/webrtc/thumbnail_capturer_mac.h\"\n #include \"chrome/browser/media/webrtc/window_icon_util.h\"\n+#include \"content/public/browser/browser_thread.h\"\n #include \"content/public/browser/desktop_capture.h\"\n #include \"gin/handle.h\"\n #include \"gin/object_template_builder.h\"\n@@ -252,7 +253,8 @@ void DesktopCapturer::DesktopListListener::OnSourceThumbnailChanged(int index) {\n }\n \n void DesktopCapturer::DesktopListListener::OnDelegatedSourceListDismissed() {\n-  std::move(failure_callback_).Run();\n+  content::GetUIThreadTaskRunner({})->PostTask(FROM_HERE,\n+                                               std::move(failure_callback_));\n }\n \n void DesktopCapturer::StartHandling(bool capture_window,\n", "instance_id": "electron__electron-46112", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Electron desktop capturer crashes on Linux with XDP when the capture portal is dismissed or closed. It provides relevant context such as the affected Electron versions (32.0.0 to 34.0.0), the operating system (Linux with a specific kernel version), architecture (x64), and the last known working version (31.3.1). The expected behavior (no crash and ability to make subsequent requests) and actual behavior (crash on portal dismissal) are explicitly stated. Additionally, a reference to a test case and some error logs from Chromium are provided, which helps in understanding the issue's scope. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify the exact conditions under which the crash occurs (e.g., specific user actions or configurations beyond closing the portal). Edge cases, such as behavior with different Linux distributions or desktop environments, are not mentioned. Furthermore, there is no detailed explanation of the error logs or their relevance to the crash, which could be critical for debugging. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of the code change appears limited to a single file (`electron_api_desktop_capturer.cc`), and the diff shows a small modification involving task scheduling on the UI thread using `content::GetUIThreadTaskRunner`. However, the impact of this change is significant as it addresses a crash issue, which likely involves understanding the interaction between Electron's desktop capture functionality and the underlying Linux XDP (X Desktop Portal) system. This requires knowledge of multi-threading and task scheduling in the Chromium codebase, as well as familiarity with Electron's integration of WebRTC-based desktop capture APIs. Second, the technical concepts involved are moderately complex, including browser thread management (`content::BrowserThread`), callback handling, and potentially the PipeWire-based screen capture mechanism on Linux (as hinted by the error logs mentioning `base_capturer_pipewire.cc`). Third, while the problem statement does not explicitly mention edge cases, the nature of the issue (a crash on portal dismissal) implies the need to handle error conditions and ensure robustness in the UI thread task execution, which could involve subtle race conditions or state management issues. Finally, solving this requires a deep understanding of Electron's architecture, particularly how it interfaces with native desktop capture APIs on Linux, which is non-trivial and likely demands experience with both Electron and Chromium internals. The difficulty is not at the highest end (0.8-1.0) because the code change itself is small and localized, but the context and potential for hidden complexities (e.g., ensuring no regressions in other platforms or capture scenarios) push it into the hard range at 0.65.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`shell.readShortcutLink` crashes when parsing Slack shortcut\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.3.1\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11 version 26100\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nShortcut should be parsed/read correctly, and we should be able to handle the error if this fails.\n\n### Actual Behavior\n\nAn exception is thrown:\n\n```\n[1212:0109/171356.871:ERROR:crashpad_client_win.cc(868)] not connected\n```\n\n### Testcase Gist URL\n\nhttps://gist.github.com/dlon/f580673b27ba00d1bedfa25d2f2208c1\n\n### Additional Information\n\nThis seems related to https://github.com/electron/electron/issues/44752, but it affects other shortcuts.\n\nHere is a partial backtrace:\n```\n00 00000072`1e5fc3a0 00007ff7`f38192e9     electron!base::win::ResolveShortcutProperties+0xaaa [C:\\projects\\src\\base\\win\\shortcut.cc @ 345] \n01 00000072`1e5fc6e0 00007ff7`f36ecd16     electron!`anonymous namespace'::ReadShortcutLink+0xd9 [C:\\projects\\src\\electron\\shell\\common\\api\\electron_api_shell.cc @ 154] \n```\n\nI've reproduced the above on v33.3.1, as well as the latest beta.\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex f6471212332bf..671a98a5b49d5 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -139,3 +139,4 @@ build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\n revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n build_remove_vr_directx_helpers_dependency.patch\n+ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\ndiff --git a/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch b/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\nnew file mode 100644\nindex 0000000000000..6f97dd9b9ce80\n--- /dev/null\n+++ b/patches/chromium/ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n@@ -0,0 +1,40 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?David=20L=C3=B6nnhager?= <dv.lnh.d@gmail.com>\n+Date: Fri, 17 Jan 2025 14:30:48 +0100\n+Subject: Ignore parse errors for PKEY_AppUserModel_ToastActivatorCLSID\n+\n+Some shortcuts store this as a string UUID as opposed to VT_CLSID,\n+hitting NOTREACHED() and sometimes breaking parsing in Electron.\n+Ignore this error instead.\n+\n+Bug: N/A\n+Change-Id: I9fc472212b2d3afac2c8e18a2159bc2d50bbdf98\n+\n+diff --git a/AUTHORS b/AUTHORS\n+index 55dc38c1448c1960b802c136018c8be22ed61c18..5cd195df3650331fbfd62b2f964368b5f3217f3c 100644\n+--- a/AUTHORS\n++++ b/AUTHORS\n+@@ -337,6 +337,7 @@ David Futcher <david.mike.futcher@gmail.com>\n+ David Jin <davidjin@amazon.com>\n+ David Lechner <david@pybricks.com>\n+ David Leen <davileen@amazon.com>\n++David Lönnhager <dv.lnh.d@gmail.com>\n+ David Manouchehri <david@davidmanouchehri.com>\n+ David McAllister <mcdavid@amazon.com>\n+ David Michael Barr <david.barr@samsung.com>\n+diff --git a/base/win/shortcut.cc b/base/win/shortcut.cc\n+index e790adb2f1d6529ac0dd77145f5da2796264c7ae..8a7edcfaf9af963468b4b42fe55a771fb31f13a2 100644\n+--- a/base/win/shortcut.cc\n++++ b/base/win/shortcut.cc\n+@@ -342,8 +342,9 @@ bool ResolveShortcutProperties(const FilePath& shortcut_path,\n+               *(pv_toast_activator_clsid.get().puuid));\n+           break;\n+         default:\n+-          NOTREACHED() << \"Unexpected variant type: \"\n+-                       << pv_toast_activator_clsid.get().vt;\n++          // Shortcuts may use strings to represent the CLSID. This case is\n++          // ignored.\n++          break;\n+       }\n+     }\n+   }\ndiff --git a/shell/common/api/electron_api_shell.cc b/shell/common/api/electron_api_shell.cc\nindex a8031264d7cdd..d6097e7efbb84 100644\n--- a/shell/common/api/electron_api_shell.cc\n+++ b/shell/common/api/electron_api_shell.cc\n@@ -163,7 +163,8 @@ v8::Local<v8::Value> ReadShortcutLink(gin_helper::ErrorThrower thrower,\n   options.Set(\"icon\", properties.icon);\n   options.Set(\"iconIndex\", properties.icon_index);\n   options.Set(\"appUserModelId\", properties.app_id);\n-  options.Set(\"toastActivatorClsid\", properties.toast_activator_clsid);\n+  if (properties.options & ShortcutProperties::PROPERTIES_TOAST_ACTIVATOR_CLSID)\n+    options.Set(\"toastActivatorClsid\", properties.toast_activator_clsid);\n   return gin::ConvertToV8(thrower.isolate(), options);\n }\n #endif\n", "instance_id": "electron__electron-45195", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear, earning a score of 2 (Mostly Clear). The goal is explicitly stated: to prevent crashes when parsing certain shortcuts (e.g., Slack shortcuts) in Electron on Windows. The expected behavior (parsing shortcuts correctly and handling errors gracefully) and actual behavior (an exception being thrown) are described, along with relevant context such as the Electron version, OS details, and a partial backtrace. A test case gist is provided, which adds to the clarity. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not fully specify the nature of the parsing error or the exact conditions under which it occurs (beyond mentioning Slack shortcuts and referencing a related issue). Additionally, edge cases or specific constraints around shortcut formats are not detailed, which could impact the solution's completeness. Despite these gaps, the statement provides enough information to understand the issue and align with the provided code changes.", "difficulty_explanation": "I assign a difficulty score of 0.45, placing this problem in the Medium range (0.4-0.6). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The changes are relatively focused, affecting two files (`base/win/shortcut.cc` in Chromium and `shell/common/api/electron_api_shell.cc` in Electron) and a patch file. The modifications are not extensive—primarily a small logic change to ignore parsing errors for a specific property (`PKEY_AppUserModel_ToastActivatorCLSID`) and a conditional check before setting a property in Electron's API. The changes do not significantly impact the broader system architecture but require understanding the interaction between Chromium's shortcut parsing logic and Electron's API layer. This cross-module interaction adds a moderate layer of complexity.\n\n2. **Number of Technical Concepts**: Solving this requires familiarity with several concepts, though none are overly advanced. These include Windows-specific shortcut parsing (via Chromium's `base/win/shortcut.cc`), handling COM-related data types (e.g., CLSID and variant types), and Electron's V8 JavaScript bindings for API exposure. Additionally, understanding patch management in a large project like Electron/Chromium is necessary. While these concepts are not trivial, they are within the grasp of a developer with intermediate experience in C++ and Windows development.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement implies edge cases related to shortcut formats (e.g., CLSID stored as a string instead of `VT_CLSID`), and the code change addresses this by ignoring parsing errors for a specific property. However, the statement does not explicitly list other potential edge cases, and the solution does not introduce complex error-handling logic beyond a simple conditional check. This keeps the difficulty from escalating further, though developers must still consider whether ignoring errors could mask other issues.\n\n4. **Overall Complexity**: The problem requires a targeted fix rather than a deep architectural change or complex algorithm. However, it involves navigating a large, multi-layered codebase (Chromium/Electron) and understanding Windows-specific behaviors, which adds moderate difficulty. The need to create and apply a patch to Chromium also introduces a procedural challenge.\n\nIn summary, this problem is of medium difficulty due to the need to understand specific Windows APIs, manage cross-module interactions, and apply patches in a complex codebase, but it does not require advanced algorithmic work or extensive refactoring. A score of 0.45 reflects this balance—slightly above the lower end of the medium range due to the specialized knowledge required for Windows shortcut parsing.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Desktop capturer thumbnails are generated in a low quality\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n29.1.0\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\nmacOS Sonoma 14.4 (23E214)\r\n\r\n### What arch are you using?\r\n\r\narm64 (including Apple Silicon)\r\n\r\n### Last Known Working Electron version\r\n\r\n29.0.1\r\n\r\n### Expected Behavior\r\n\r\nThumbnails are generated with a good quality. (example from electron 29.0.1)\r\n![image](https://github.com/electron/electron/assets/22202138/42115640-ce22-40d4-b3dc-2586148aac1e)\r\n\r\n\r\n### Actual Behavior\r\n\r\nThumbnails are generated blurry.\r\n![image](https://github.com/electron/electron/assets/22202138/d078749f-a3cd-45cd-ada3-6c990ea658aa)\r\n\r\n\r\n### Testcase Gist URL\r\n\r\nhttps://gist.github.com/7944bd3381db8d1cf6d7a4eca86b073e\r\n\r\n### Additional Information\r\n\r\n_No response_\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex 801b1fef7f816..6c0178b57567d 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -137,3 +137,4 @@ cherry-pick-1b1f34234346.patch\n bindings_refactor_domdatastore.patch\n merge_fix_domarraybuffer_isdetached_and_comment_out_a_check.patch\n cherry-pick-98bcf9ef5cdd.patch\n+cherry-pick-c1f25647c2fc.patch\ndiff --git a/patches/chromium/cherry-pick-c1f25647c2fc.patch b/patches/chromium/cherry-pick-c1f25647c2fc.patch\nnew file mode 100644\nindex 0000000000000..f52bb35ebc6c5\n--- /dev/null\n+++ b/patches/chromium/cherry-pick-c1f25647c2fc.patch\n@@ -0,0 +1,27 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Johannes Kron <kron@chromium.org>\n+Date: Tue, 13 Feb 2024 23:22:49 +0000\n+Subject: Update thumbnail size when sources are selected\n+\n+(cherry picked from commit c1f25647c2fcbf5e5a2d574feb284bc7284b944d)\n+\n+Bug: b/40281869\n+Change-Id: I2d5a3954886bc6a5742321aeab415362da19c0ce\n+Reviewed-on: https://chromium-review.googlesource.com/c/chromium/src/+/5285701\n+Commit-Queue: Johannes Kron <kron@chromium.org>\n+Reviewed-by: Elad Alon <eladalon@chromium.org>\n+Cr-Commit-Position: refs/heads/main@{#1260137}\n+\n+diff --git a/chrome/browser/media/webrtc/thumbnail_capturer_mac.mm b/chrome/browser/media/webrtc/thumbnail_capturer_mac.mm\n+index ebe194e9d4a77d74996cb575364a32b61ccfac52..b27f6348d338d8952716b51825586e5d29b75651 100644\n+--- a/chrome/browser/media/webrtc/thumbnail_capturer_mac.mm\n++++ b/chrome/browser/media/webrtc/thumbnail_capturer_mac.mm\n+@@ -365,6 +365,8 @@ void API_AVAILABLE(macos(14.0))\n+     gfx::Size thumbnail_size) {\n+   DCHECK(task_runner_->RunsTasksInCurrentSequence());\n+ \n++  thumbnail_size_ = thumbnail_size;\n++\n+   // The iteration is in reverse order so that the sources\n+   // first in the list are captured first. This way we make sure that the first\n+   // thumbnails in the view are captured first.\n", "instance_id": "electron__electron-42049", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: desktop capturer thumbnails are generated in low quality in Electron version 29.1.0 on macOS Sonoma 14.4 (arm64), compared to the expected good quality in version 29.0.1. It includes visual examples of the expected and actual behavior, which aids in understanding the issue. Additionally, a test case gist URL is provided for reproducibility. However, the statement lacks specific technical details about the root cause of the quality degradation or explicit constraints and requirements for the fix (e.g., acceptable thumbnail resolution or quality metrics). Edge cases, such as different screen resolutions or specific macOS configurations, are not mentioned. While the goal is clear, these missing minor details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem is rated as easy (0.25) based on the provided factors. The code change is minimal, involving a single patch to update the thumbnail size in a specific file (`thumbnail_capturer_mac.mm`) within the Chromium codebase used by Electron. The modification is localized to a single line update (`thumbnail_size_ = thumbnail_size;`), indicating a straightforward bug fix with no significant impact on the broader system architecture. The scope of understanding required is limited to the specific functionality of thumbnail capturing on macOS, and the technical concepts involved are relatively basic—primarily understanding variable assignment and the context of thumbnail size in the WebRTC module. There are no complex algorithms, design patterns, or domain-specific challenges evident in the change. Additionally, the problem statement and code changes do not highlight specific edge cases or error handling requirements beyond the core issue of thumbnail quality. While familiarity with the Chromium codebase and macOS-specific APIs may be necessary, the overall effort and complexity of the fix are low, aligning with an easy difficulty level.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Duplicate coinbase transaction space reservation in CreateNewBlock\nIn `BlockAssembler::CreateNewBlock`, we initiate `nBlockWeight` to 4000 WU, reserving space for\r\ncoinbase transaction.\r\n\r\nLatter on, while iterating on transactions for block inclusion in `addPackagesTxs`, we verify that candidate package doesn't overflow the max block weight. This check is done in `TestPackage` against `nBlockMaxWeight`. However, default value is DEFAULT_BLOCK_MAX_WEIGHT which is equal to MAX_BLOCK_WEIGHT - 4000 (L20 in `src/policy/policy.cpp`). So block weight assembled is starting at 4000 WU and can't overflow 3996000 WU.\r\n\r\nDo we have duplicated coinbase transaction space reservation ? I can see this a safety margin to avoid creating invalid blocks if you create inflated coinbase transaction, at the price of few weight units leftover.\r\n\r\nIf so, maybe we should leave it as it is but document this behavior, I was surprised hitting this while scratching unrelated tests.\r\n\r\nSee [comment](https://github.com/bitcoin/bitcoin/pull/11100#discussion_r135124178) in #11100\n", "patch": "diff --git a/doc/release-notes-31384.md b/doc/release-notes-31384.md\nnew file mode 100644\nindex 0000000000000..9256ec16f4621\n--- /dev/null\n+++ b/doc/release-notes-31384.md\n@@ -0,0 +1,34 @@\n+- Node and Mining\n+\n+---\n+\n+- **PR #31384** fixed an issue where block reserved weight for fixed-size block header, transactions count,\n+  and coinbase transaction was done in two separate places.\n+  Before this pull request, the policy default for the maximum block weight was `3,996,000` WU, calculated by\n+  subtracting `4,000 WU` from the `4,000,000 WU` consensus limit to account for the fixed-size block header,\n+  transactions count, and coinbase transaction. During block assembly, Bitcoin Core clamped custom `-blockmaxweight`\n+  value to not be more than the policy default.\n+\n+  Additionally, the mining code added another `4,000 WU` to the initial reservation, reducing the effective block template\n+  size to `3,992,000 WU`.\n+\n+  Due to this issue, the total reserved weight was always `8,000 WU`, meaning that even when specifying a `-blockmaxweight`\n+  higher than the policy default, the actual block size never exceeded `3,992,000 WU`.\n+\n+  The fix consolidates the reservation into a single place and introduces a new startup option,\n+  `-blockreservedweight` (default: `8,000 WU`). This startup option specifies the reserved weight for\n+  the fixed-size block header, transactions count, and coinbase transaction.\n+  The default value of `-blockreservedweight` was chosen to preserve the previous behavior.\n+\n+  **Upgrade Note:** The default `-blockreservedweight` ensures backward compatibility for users who relied on the previous behavior.\n+\n+  Users who manually set `-blockmaxweight` to its maximum value of `4,000,000 WU` should be aware that this\n+  value previously had no effect since it was clamped to `3,996,000 WU`.\n+\n+  Users lowering `-blockreservedweight` should ensure that the total weight (for the block header, transaction count, and coinbase transaction)\n+   does not exceed the reduced value.\n+\n+  As a safety check, Bitcoin core will **fail to start** when `-blockreservedweight` init parameter value is lower than `2000` weight units.\n+\n+  Bitcoin Core will also **fail to start** if the `-blockmaxweight` or `-blockreservedweight` init parameter exceeds\n+  consensus limit of `4,000,000` weight units.\ndiff --git a/src/init.cpp b/src/init.cpp\nindex 1f597cb7cb29e..03c525d5b4983 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -19,6 +19,7 @@\n #include <common/args.h>\n #include <common/system.h>\n #include <consensus/amount.h>\n+#include <consensus/consensus.h>\n #include <deploymentstatus.h>\n #include <hash.h>\n #include <httprpc.h>\n@@ -648,6 +649,7 @@ void SetupServerArgs(ArgsManager& argsman, bool can_listen_ipc)\n \n \n     argsman.AddArg(\"-blockmaxweight=<n>\", strprintf(\"Set maximum BIP141 block weight (default: %d)\", DEFAULT_BLOCK_MAX_WEIGHT), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n+    argsman.AddArg(\"-blockreservedweight=<n>\", strprintf(\"Reserve space for the fixed-size block header plus the largest coinbase transaction the mining software may add to the block. (default: %d).\", DEFAULT_BLOCK_RESERVED_WEIGHT), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n     argsman.AddArg(\"-blockmintxfee=<amt>\", strprintf(\"Set lowest fee rate (in %s/kvB) for transactions to be included in block creation. (default: %s)\", CURRENCY_UNIT, FormatMoney(DEFAULT_BLOCK_MIN_TX_FEE)), ArgsManager::ALLOW_ANY, OptionsCategory::BLOCK_CREATION);\n     argsman.AddArg(\"-blockversion=<n>\", \"Override block version to test forking scenarios\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::BLOCK_CREATION);\n \n@@ -1015,6 +1017,23 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         }\n     }\n \n+    if (args.IsArgSet(\"-blockmaxweight\")) {\n+        const auto max_block_weight = args.GetIntArg(\"-blockmaxweight\", DEFAULT_BLOCK_MAX_WEIGHT);\n+        if (max_block_weight > MAX_BLOCK_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockmaxweight (%d) exceeds consensus maximum block weight (%d)\"), max_block_weight, MAX_BLOCK_WEIGHT));\n+        }\n+    }\n+\n+    if (args.IsArgSet(\"-blockreservedweight\")) {\n+        const auto block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", DEFAULT_BLOCK_RESERVED_WEIGHT);\n+        if (block_reserved_weight > MAX_BLOCK_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockreservedweight (%d) exceeds consensus maximum block weight (%d)\"), block_reserved_weight, MAX_BLOCK_WEIGHT));\n+        }\n+        if (block_reserved_weight < MINIMUM_BLOCK_RESERVED_WEIGHT) {\n+            return InitError(strprintf(_(\"Specified -blockreservedweight (%d) is lower than minimum safety value of (%d)\"), block_reserved_weight, MINIMUM_BLOCK_RESERVED_WEIGHT));\n+        }\n+    }\n+\n     nBytesPerSigOp = args.GetIntArg(\"-bytespersigop\", nBytesPerSigOp);\n \n     if (!g_wallet_init_interface.ParameterInteraction()) return false;\ndiff --git a/src/ipc/capnp/mining.capnp b/src/ipc/capnp/mining.capnp\nindex 50b07bda708b7..e57d6679e184a 100644\n--- a/src/ipc/capnp/mining.capnp\n+++ b/src/ipc/capnp/mining.capnp\n@@ -35,7 +35,7 @@ interface BlockTemplate $Proxy.wrap(\"interfaces::BlockTemplate\") {\n \n struct BlockCreateOptions $Proxy.wrap(\"node::BlockCreateOptions\") {\n     useMempool @0 :Bool $Proxy.name(\"use_mempool\");\n-    coinbaseMaxAdditionalWeight @1 :UInt64 $Proxy.name(\"coinbase_max_additional_weight\");\n+    blockReservedWeight @1 :UInt64 $Proxy.name(\"block_reserved_weight\");\n     coinbaseOutputMaxAdditionalSigops @2 :UInt64 $Proxy.name(\"coinbase_output_max_additional_sigops\");\n }\n \ndiff --git a/src/node/miner.cpp b/src/node/miner.cpp\nindex 0ff5a1eadead1..b595d91ed97a7 100644\n--- a/src/node/miner.cpp\n+++ b/src/node/miner.cpp\n@@ -67,11 +67,12 @@ void RegenerateCommitments(CBlock& block, ChainstateManager& chainman)\n \n static BlockAssembler::Options ClampOptions(BlockAssembler::Options options)\n {\n-    Assert(options.coinbase_max_additional_weight <= DEFAULT_BLOCK_MAX_WEIGHT);\n+    Assert(options.block_reserved_weight <= MAX_BLOCK_WEIGHT);\n+    Assert(options.block_reserved_weight >= MINIMUM_BLOCK_RESERVED_WEIGHT);\n     Assert(options.coinbase_output_max_additional_sigops <= MAX_BLOCK_SIGOPS_COST);\n-    // Limit weight to between coinbase_max_additional_weight and DEFAULT_BLOCK_MAX_WEIGHT for sanity:\n-    // Coinbase (reserved) outputs can safely exceed -blockmaxweight, but the rest of the block template will be empty.\n-    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, options.coinbase_max_additional_weight, DEFAULT_BLOCK_MAX_WEIGHT);\n+    // Limit weight to between block_reserved_weight and MAX_BLOCK_WEIGHT for sanity:\n+    // block_reserved_weight can safely exceed -blockmaxweight, but the rest of the block template will be empty.\n+    options.nBlockMaxWeight = std::clamp<size_t>(options.nBlockMaxWeight, options.block_reserved_weight, MAX_BLOCK_WEIGHT);\n     return options;\n }\n \n@@ -91,14 +92,15 @@ void ApplyArgsManOptions(const ArgsManager& args, BlockAssembler::Options& optio\n         if (const auto parsed{ParseMoney(*blockmintxfee)}) options.blockMinFeeRate = CFeeRate{*parsed};\n     }\n     options.print_modified_fee = args.GetBoolArg(\"-printpriority\", options.print_modified_fee);\n+    options.block_reserved_weight = args.GetIntArg(\"-blockreservedweight\", options.block_reserved_weight);\n }\n \n void BlockAssembler::resetBlock()\n {\n     inBlock.clear();\n \n-    // Reserve space for coinbase tx\n-    nBlockWeight = m_options.coinbase_max_additional_weight;\n+    // Reserve space for fixed-size block header, txs count, and coinbase tx.\n+    nBlockWeight = m_options.block_reserved_weight;\n     nBlockSigOpsCost = m_options.coinbase_output_max_additional_sigops;\n \n     // These counters do not include coinbase tx\n@@ -386,7 +388,7 @@ void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpda\n             ++nConsecutiveFailed;\n \n             if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n-                    m_options.nBlockMaxWeight - m_options.coinbase_max_additional_weight) {\n+                    m_options.nBlockMaxWeight - m_options.block_reserved_weight) {\n                 // Give up if we're close to full and haven't succeeded in a while\n                 break;\n             }\ndiff --git a/src/node/miner.h b/src/node/miner.h\nindex 3c4c66b0badf0..18e19ea158d7c 100644\n--- a/src/node/miner.h\n+++ b/src/node/miner.h\n@@ -176,7 +176,9 @@ class BlockAssembler\n     /** Construct a new block template */\n     std::unique_ptr<CBlockTemplate> CreateNewBlock();\n \n+    /** The number of transactions in the last assembled block (excluding coinbase transaction) */\n     inline static std::optional<int64_t> m_last_block_num_txs{};\n+    /** The weight of the last assembled block (including reserved weight for block header, txs count and coinbase tx) */\n     inline static std::optional<int64_t> m_last_block_weight{};\n \n private:\ndiff --git a/src/node/types.h b/src/node/types.h\nindex 4b0de084ab3d0..290bbc23f1401 100644\n--- a/src/node/types.h\n+++ b/src/node/types.h\n@@ -14,6 +14,7 @@\n #define BITCOIN_NODE_TYPES_H\n \n #include <cstddef>\n+#include <policy/policy.h>\n #include <script/script.h>\n \n namespace node {\n@@ -34,11 +35,10 @@ struct BlockCreateOptions {\n      */\n     bool use_mempool{true};\n     /**\n-     * The maximum additional weight which the pool will add to the coinbase\n-     * scriptSig, witness and outputs. This must include any additional\n-     * weight needed for larger CompactSize encoded lengths.\n+     * The default reserved weight for the fixed-size block header,\n+     * transaction count and coinbase transaction.\n      */\n-    size_t coinbase_max_additional_weight{4000};\n+    size_t block_reserved_weight{DEFAULT_BLOCK_RESERVED_WEIGHT};\n     /**\n      * The maximum additional sigops which the pool will add in coinbase\n      * transaction outputs.\ndiff --git a/src/policy/policy.h b/src/policy/policy.h\nindex 4412f2db87ab1..2151ec13dd04a 100644\n--- a/src/policy/policy.h\n+++ b/src/policy/policy.h\n@@ -20,7 +20,14 @@ class CFeeRate;\n class CScript;\n \n /** Default for -blockmaxweight, which controls the range of block weights the mining code will create **/\n-static constexpr unsigned int DEFAULT_BLOCK_MAX_WEIGHT{MAX_BLOCK_WEIGHT - 4000};\n+static constexpr unsigned int DEFAULT_BLOCK_MAX_WEIGHT{MAX_BLOCK_WEIGHT};\n+/** Default for -blockreservedweight **/\n+static constexpr unsigned int DEFAULT_BLOCK_RESERVED_WEIGHT{8000};\n+/** This accounts for the block header, var_int encoding of the transaction count and a minimally viable\n+ * coinbase transaction. It adds an additional safety margin, because even with a thorough understanding\n+ * of block serialization, it's easy to make a costly mistake when trying to squeeze every last byte.\n+ * Setting a lower value is prevented at startup. */\n+static constexpr unsigned int MINIMUM_BLOCK_RESERVED_WEIGHT{2000};\n /** Default for -blockmintxfee, which sets the minimum feerate for a transaction in blocks created by mining code **/\n static constexpr unsigned int DEFAULT_BLOCK_MIN_TX_FEE{1000};\n /** The maximum weight for transactions we're willing to relay/mine */\ndiff --git a/src/rpc/mining.cpp b/src/rpc/mining.cpp\nindex 5e3d1120e3201..702925785bfc8 100644\n--- a/src/rpc/mining.cpp\n+++ b/src/rpc/mining.cpp\n@@ -419,8 +419,8 @@ static RPCHelpMan getmininginfo()\n                     RPCResult::Type::OBJ, \"\", \"\",\n                     {\n                         {RPCResult::Type::NUM, \"blocks\", \"The current block\"},\n-                        {RPCResult::Type::NUM, \"currentblockweight\", /*optional=*/true, \"The block weight of the last assembled block (only present if a block was ever assembled)\"},\n-                        {RPCResult::Type::NUM, \"currentblocktx\", /*optional=*/true, \"The number of block transactions of the last assembled block (only present if a block was ever assembled)\"},\n+                        {RPCResult::Type::NUM, \"currentblockweight\", /*optional=*/true, \"The block weight (including reserved weight for block header, txs count and coinbase tx) of the last assembled block (only present if a block was ever assembled)\"},\n+                        {RPCResult::Type::NUM, \"currentblocktx\", /*optional=*/true, \"The number of block transactions (excluding coinbase) of the last assembled block (only present if a block was ever assembled)\"},\n                         {RPCResult::Type::STR_HEX, \"bits\", \"The current nBits, compact representation of the block difficulty target\"},\n                         {RPCResult::Type::NUM, \"difficulty\", \"The current difficulty\"},\n                         {RPCResult::Type::STR_HEX, \"target\", \"The current target\"},\n", "instance_id": "bitcoin__bitcoin-31384", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in identifying the issue of duplicate space reservation for the coinbase transaction in the `CreateNewBlock` function of Bitcoin Core's block assembly logic. It explains the discrepancy between the initial reservation of 4000 WU (weight units) and the policy default of `MAX_BLOCK_WEIGHT - 4000`, leading to an effective double reservation. The goal of addressing this duplication, either by fixing it or documenting it, is evident. However, the statement lacks specificity on the desired solution—whether to consolidate the reservation logic or simply document the behavior. Additionally, it does not explicitly mention edge cases or constraints related to block weight limits beyond the general observation of a safety margin. The linked comment provides some context, but critical details about expected behavior under various configurations are missing. Thus, while the problem is valid and mostly clear, minor ambiguities remain, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`init.cpp`, `miner.cpp`, `policy.h`, etc.), requiring modifications to core components of Bitcoin Core's mining and block assembly logic. This involves understanding and altering the interaction between command-line arguments, policy defaults, and runtime block creation, which impacts the system's behavior significantly. Second, the number of technical concepts involved is substantial, including knowledge of Bitcoin's block weight system (BIP141), consensus rules, mining policies, and parameter validation. The changes also introduce a new configuration option (`-blockreservedweight`), necessitating careful handling of backward compatibility and safety checks (e.g., enforcing minimum and maximum weight limits). Third, while the problem statement does not explicitly mention edge cases, the code changes address several, such as ensuring the reserved weight does not fall below a safety threshold (2000 WU) and preventing values exceeding consensus limits, which adds complexity to error handling. Finally, the need to maintain compatibility with existing behavior (via default values) and to document the changes thoroughly in release notes indicates a deep understanding of the codebase and its user base. A score of 0.65 reflects the challenge of navigating these complexities, though it does not reach the \"Very Hard\" range as it does not involve entirely new system-level designs or highly intricate domain-specific algorithms.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "wallet: setting changes are subject to race conditions\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nCreating two wallets with `load_on_startup=true` simultaneously will result in only one of the wallets being added to the startup file.\n\n### Expected behaviour\n\nBoth wallets should be added.\n\n### Steps to reproduce\n\nI don't have an easy script to reproduce this, but the issue is quite visible in the code:\r\nhttps://github.com/bitcoin/bitcoin/blob/389cf32aca0be6c4b01151c92cc3be79c120f197/src/wallet/wallet.cpp#L94\r\n\r\nThe setting gets read from a backing JSON file, manipulated in memory, and then saved to the file, without any lock being taken out.\r\n\r\nIt's likely possible to demonstrate this with a quick BASH or python script that fires up bitcoind and creates two wallets simultaneously.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\n27.1\n\n### Operating system and version\n\nMacOS Sonoma 14.6.1\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/interfaces/chain.h b/src/interfaces/chain.h\nindex af45f81f95e45..be596b17657cb 100644\n--- a/src/interfaces/chain.h\n+++ b/src/interfaces/chain.h\n@@ -96,6 +96,17 @@ struct BlockInfo {\n     BlockInfo(const uint256& hash LIFETIMEBOUND) : hash(hash) {}\n };\n \n+//! The action to be taken after updating a settings value.\n+//! WRITE indicates that the updated value must be written to disk,\n+//! while SKIP_WRITE indicates that the change will be kept in memory-only\n+//! without persisting it.\n+enum class SettingsAction {\n+    WRITE,\n+    SKIP_WRITE\n+};\n+\n+using SettingsUpdate = std::function<std::optional<interfaces::SettingsAction>(common::SettingsValue&)>;\n+\n //! Interface giving clients (wallet processes, maybe other analysis tools in\n //! the future) ability to access to the chain state, receive notifications,\n //! estimate fees, and submit transactions.\n@@ -344,9 +355,16 @@ class Chain\n     //! Return <datadir>/settings.json setting value.\n     virtual common::SettingsValue getRwSetting(const std::string& name) = 0;\n \n-    //! Write a setting to <datadir>/settings.json. Optionally just update the\n-    //! setting in memory and do not write the file.\n-    virtual bool updateRwSetting(const std::string& name, const common::SettingsValue& value, bool write=true) = 0;\n+    //! Updates a setting in <datadir>/settings.json.\n+    //! Depending on the action returned by the update function, this will either\n+    //! update the setting in memory or write the updated settings to disk.\n+    virtual bool updateRwSetting(const std::string& name, const SettingsUpdate& update_function) = 0;\n+\n+    //! Replace a setting in <datadir>/settings.json with a new value.\n+    virtual bool overwriteRwSetting(const std::string& name, common::SettingsValue& value, bool write = true) = 0;\n+\n+    //! Delete a given setting in <datadir>/settings.json.\n+    virtual bool deleteRwSettings(const std::string& name, bool write = true) = 0;\n \n     //! Synchronously send transactionAddedToMempool notifications about all\n     //! current mempool transactions to the specified handler and return after\ndiff --git a/src/node/interfaces.cpp b/src/node/interfaces.cpp\nindex 9fe08eb3dd3d4..54b986c926afd 100644\n--- a/src/node/interfaces.cpp\n+++ b/src/node/interfaces.cpp\n@@ -814,14 +814,32 @@ class ChainImpl : public Chain\n         });\n         return result;\n     }\n-    bool updateRwSetting(const std::string& name, const common::SettingsValue& value, bool write) override\n+    bool updateRwSetting(const std::string& name,\n+                         const interfaces::SettingsUpdate& update_settings_func) override\n     {\n+        std::optional<interfaces::SettingsAction> action;\n         args().LockSettings([&](common::Settings& settings) {\n-            if (value.isNull()) {\n-                settings.rw_settings.erase(name);\n-            } else {\n-                settings.rw_settings[name] = value;\n-            }\n+            auto* ptr_value = common::FindKey(settings.rw_settings, name);\n+            // Create value if it doesn't exist\n+            auto& value = ptr_value ? *ptr_value : settings.rw_settings[name];\n+            action = update_settings_func(value);\n+        });\n+        if (!action) return false;\n+        // Now dump value to disk if requested\n+        return *action == interfaces::SettingsAction::SKIP_WRITE || args().WriteSettingsFile();\n+    }\n+    bool overwriteRwSetting(const std::string& name, common::SettingsValue& value, bool write) override\n+    {\n+        if (value.isNull()) return deleteRwSettings(name, write);\n+        return updateRwSetting(name, [&](common::SettingsValue& settings) {\n+            settings = std::move(value);\n+            return write ? interfaces::SettingsAction::WRITE : interfaces::SettingsAction::SKIP_WRITE;\n+        });\n+    }\n+    bool deleteRwSettings(const std::string& name, bool write) override\n+    {\n+        args().LockSettings([&](common::Settings& settings) {\n+            settings.rw_settings.erase(name);\n         });\n         return !write || args().WriteSettingsFile();\n     }\ndiff --git a/src/wallet/load.cpp b/src/wallet/load.cpp\nindex e26347d437af3..129b5c7c2a0a7 100644\n--- a/src/wallet/load.cpp\n+++ b/src/wallet/load.cpp\n@@ -69,7 +69,7 @@ bool VerifyWallets(WalletContext& context)\n             // Pass write=false because no need to write file and probably\n             // better not to. If unnamed wallet needs to be added next startup\n             // and the setting is empty, this code will just run again.\n-            chain.updateRwSetting(\"wallet\", wallets, /* write= */ false);\n+            chain.overwriteRwSetting(\"wallet\", wallets, /*write=*/false);\n         }\n     }\n \ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\nindex 5584b43520aa6..e2d7429f94dbc 100644\n--- a/src/wallet/wallet.cpp\n+++ b/src/wallet/wallet.cpp\n@@ -93,25 +93,30 @@ namespace wallet {\n \n bool AddWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\n {\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\n-    if (!setting_value.isArray()) setting_value.setArray();\n-    for (const common::SettingsValue& value : setting_value.getValues()) {\n-        if (value.isStr() && value.get_str() == wallet_name) return true;\n-    }\n-    setting_value.push_back(wallet_name);\n-    return chain.updateRwSetting(\"wallet\", setting_value);\n+    const auto update_function = [&wallet_name](common::SettingsValue& setting_value) {\n+        if (!setting_value.isArray()) setting_value.setArray();\n+        for (const auto& value : setting_value.getValues()) {\n+            if (value.isStr() && value.get_str() == wallet_name) return interfaces::SettingsAction::SKIP_WRITE;\n+        }\n+        setting_value.push_back(wallet_name);\n+        return interfaces::SettingsAction::WRITE;\n+    };\n+    return chain.updateRwSetting(\"wallet\", update_function);\n }\n \n bool RemoveWalletSetting(interfaces::Chain& chain, const std::string& wallet_name)\n {\n-    common::SettingsValue setting_value = chain.getRwSetting(\"wallet\");\n-    if (!setting_value.isArray()) return true;\n-    common::SettingsValue new_value(common::SettingsValue::VARR);\n-    for (const common::SettingsValue& value : setting_value.getValues()) {\n-        if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);\n-    }\n-    if (new_value.size() == setting_value.size()) return true;\n-    return chain.updateRwSetting(\"wallet\", new_value);\n+    const auto update_function = [&wallet_name](common::SettingsValue& setting_value) {\n+        if (!setting_value.isArray()) return interfaces::SettingsAction::SKIP_WRITE;\n+        common::SettingsValue new_value(common::SettingsValue::VARR);\n+        for (const auto& value : setting_value.getValues()) {\n+            if (!value.isStr() || value.get_str() != wallet_name) new_value.push_back(value);\n+        }\n+        if (new_value.size() == setting_value.size()) return interfaces::SettingsAction::SKIP_WRITE;\n+        setting_value = std::move(new_value);\n+        return interfaces::SettingsAction::WRITE;\n+    };\n+    return chain.updateRwSetting(\"wallet\", update_function);\n }\n \n static void UpdateWalletSetting(interfaces::Chain& chain,\n", "instance_id": "bitcoin__bitcoin-30697", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a race condition when creating multiple wallets with `load_on_startup=true`, resulting in only one wallet being added to the startup file. The current and expected behaviors are explicitly stated, and a specific code location is referenced, which helps in understanding the root cause (lack of locking when reading/writing to a JSON settings file). However, there are minor ambiguities and missing details. For instance, the problem statement does not provide a concrete reproduction script (though it suggests one could be created), and it lacks explicit mention of edge cases or specific constraints (e.g., performance requirements or file system behaviors on different operating systems). Additionally, there are no examples of input/output or detailed logs to illustrate the failure. While the issue is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`chain.h`, `interfaces.cpp`, `load.cpp`, and `wallet.cpp`), requiring modifications to the settings management interface and its usage in the wallet module. This indicates a need to understand interactions between different parts of the Bitcoin Core codebase, particularly how settings are read, updated, and persisted to disk. Second, the technical concepts involved include race condition handling, thread safety (via locking mechanisms), and JSON-based settings management, which are moderately complex and require a solid understanding of C++ concurrency primitives and the Bitcoin Core architecture. Third, the changes introduce a new functional approach to settings updates (`SettingsUpdate` function type) and an enum for controlling write behavior, which adds a layer of abstraction and requires careful integration with existing code. While the amount of code change is not massive, the impact is significant as it touches a critical part of the system (settings persistence) that could affect wallet initialization and overall application stability. Finally, potential edge cases—such as concurrent access to the settings file by multiple processes, file system errors during writes, or handling corrupted JSON data—are not explicitly addressed in the problem statement but are implied by the nature of the issue and must be considered during implementation. This combination of cross-module changes, concurrency concerns, and implicit edge case handling pushes the difficulty to the higher end of the spectrum, though not to the extreme of requiring advanced domain-specific knowledge beyond typical systems programming expertise.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ctrl+Insert does not copy the selected text from Command Palette\n# Environment\r\n\r\n```none\r\nWindows build number: 10.0.19042.867\r\nWindows Terminal version (if applicable): 1.6.10571.0\r\n```\r\n\r\n# Steps to reproduce\r\n\r\n1. Delete any saved Windows Terminal settings.\r\n2. Start Windows Terminal.\r\n3. Use the mouse to select some text in the pane.\r\n4. Press Ctrl+Shift+P to open the command palette.\r\n5. Type `abc`.\r\n6. Press Ctrl+A to select the text `abc`.\r\n7. Press Ctrl+Insert.\r\n\r\n# Expected behavior\r\n\r\nThe text `abc` should be copied to the clipboard, and the command palette should remain open.\r\n\r\n# Actual behavior\r\n\r\nThe command palette closes, and the text that you selected in the pane is copied to the clipboard.\r\n\r\n# Notes\r\n\r\nIf you copy by pressing Ctrl+C instead of Ctrl+Insert, then it works as expected.\n", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.cpp b/src/cascadia/TerminalApp/CommandPalette.cpp\nindex 4817cd52424..bcee25c72dd 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.cpp\n+++ b/src/cascadia/TerminalApp/CommandPalette.cpp\n@@ -359,7 +359,7 @@ namespace winrt::TerminalApp::implementation\n             _switchToMode(CommandPaletteMode::CommandlineMode);\n             e.Handled(true);\n         }\n-        else if (key == VirtualKey::C && ctrlDown)\n+        else if ((key == VirtualKey::C || key == VirtualKey::Insert) && ctrlDown)\n         {\n             _searchBox().CopySelectionToClipboard();\n             e.Handled(true);\n", "instance_id": "microsoft__terminal-18483", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the environment, steps to reproduce, expected behavior, and actual behavior. It specifies the exact bug (Ctrl+Insert not copying selected text from the Command Palette) and contrasts it with the working behavior of Ctrl+C. However, there are minor ambiguities, such as the lack of explicit mention of potential edge cases (e.g., behavior with no text selected, or interaction with other keyboard shortcuts) and constraints (e.g., whether this should work across different Windows Terminal versions or configurations). Additionally, there are no examples beyond the basic reproduction steps, which could have further clarified the scope of the issue. Overall, the statement is valid and clear but misses some minor details that could make it comprehensive.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category. The issue is a straightforward bug fix involving a small, localized code change in a single file (CommandPalette.cpp). The modification simply extends an existing condition to handle the Ctrl+Insert key combination in the same way as Ctrl+C, requiring minimal understanding of the broader codebase or architecture—just basic knowledge of event handling and key bindings in C++ with the WinRT framework. The scope of the change is minimal, with no impact on other modules or system architecture, and the amount of code changed is trivial (a single line modification). There are no complex technical concepts involved beyond understanding virtual key codes and clipboard operations, which are standard in GUI application development. While the problem statement does not explicitly mention edge cases, the nature of the fix suggests minimal additional error handling is needed beyond what is already in place for Ctrl+C. Overall, this is a simple bug fix that a developer with basic to intermediate experience in C++ and GUI programming can resolve quickly.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[WCAG 2.2] [Windows Terminal - Multiple Tab]: No single pointer alternative is provided to move the tabs.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Open Multiple tabs and navigate among the tabs.\r\n3. Now, verify whether any single pointer alternative is provided to move the tabs or not.\r\n5. Observe the issue.\r\n\r\n**User experience:**\r\nUsers who struggle with performing dragging movements will feel difficulty to move tabs, if there is no single pointer alternative is provided to perform the action.\r\n\r\n**WCAG Reference Link:**\r\n[Understanding Success Criterion 2.5.7: Dragging Movements | WAI | W3C](https://www.w3.org/WAI/WCAG22/Understanding/dragging-movements)\r\n\r\n**Attachment:**\r\n[No single pointer alternative is provided to move the tabs.zip](https://github.com/user-attachments/files/16958526/No.single.pointer.alternative.is.provided.to.move.the.tabs.zip)\n\n### Expected Behavior\n\nA single pointer alternative mechanism should be provided to the users to move the tabs.\n\n### Actual Behavior\n\nUser can be able to move the tabs here & there by using mouse, but no alternative method is available for the user to perform action using single pointer.\n", "patch": "diff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 26823366401..217f4e88879 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -193,6 +193,9 @@\n   <data name=\"TabCloseSubMenu\" xml:space=\"preserve\">\r\n     <value>Close</value>\r\n   </data>\r\n+  <data name=\"TabMoveSubMenu\" xml:space=\"preserve\">\r\n+    <value>Move tab</value>\r\n+  </data>\r\n   <data name=\"TabCloseAfter\" xml:space=\"preserve\">\r\n     <value>Close tabs to the right</value>\r\n   </data>\r\n@@ -941,4 +944,10 @@\n   <data name=\"CloseSnippetsPaneButton.[using:Windows.UI.Xaml.Controls]ToolTipService.ToolTip\" xml:space=\"preserve\">\r\n     <value>Close pane</value>\r\n   </data>\r\n-</root>\r\n+  <data name=\"TabMoveLeft\" xml:space=\"preserve\">\r\n+    <value>Move left</value>\r\n+  </data>\r\n+  <data name=\"TabMoveRight\" xml:space=\"preserve\">\r\n+    <value>Move right</value>\r\n+  </data>\r\n+</root>\n\\ No newline at end of file\ndiff --git a/src/cascadia/TerminalApp/TabBase.cpp b/src/cascadia/TerminalApp/TabBase.cpp\nindex 2d5e8da4433..0cedab37d0a 100644\n--- a/src/cascadia/TerminalApp/TabBase.cpp\n+++ b/src/cascadia/TerminalApp/TabBase.cpp\n@@ -7,6 +7,7 @@\n #include \"TabBase.g.cpp\"\r\n #include \"Utils.h\"\r\n #include \"ColorHelper.h\"\r\n+#include \"../inc/WindowingBehavior.h\"\r\n \r\n using namespace winrt;\r\n using namespace winrt::Windows::UI::Xaml;\r\n@@ -56,10 +57,72 @@ namespace winrt::TerminalApp::implementation\n                 tab->RequestFocusActiveControl.raise();\r\n             }\r\n         });\r\n+        _AppendMoveMenuItems(contextMenuFlyout);\r\n         _AppendCloseMenuItems(contextMenuFlyout);\r\n         TabViewItem().ContextFlyout(contextMenuFlyout);\r\n     }\r\n \r\n+    void TabBase::_AppendMoveMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout)\r\n+    {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n+        // Move to new window\r\n+        {\r\n+            Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n+            moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n+            moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n+\r\n+            _moveToNewWindowMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ winrt::to_hstring(NewWindow), MoveTabDirection::Forward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveToNewWindowMenuItem.Text(RS_(L\"MoveTabToNewWindowText\"));\r\n+            _moveToNewWindowMenuItem.Icon(moveTabToNewWindowTabSymbol);\r\n+\r\n+            const auto moveTabToNewWindowToolTip = RS_(L\"MoveTabToNewWindowToolTip\");\r\n+            WUX::Controls::ToolTipService::SetToolTip(_moveToNewWindowMenuItem, box_value(moveTabToNewWindowToolTip));\r\n+            Automation::AutomationProperties::SetHelpText(_moveToNewWindowMenuItem, moveTabToNewWindowToolTip);\r\n+        }\r\n+\r\n+        // Move left\r\n+        {\r\n+            _moveLeftMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ hstring{}, MoveTabDirection::Backward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveLeftMenuItem.Text(RS_(L\"TabMoveLeft\"));\r\n+        }\r\n+\r\n+        // Move right\r\n+        {\r\n+            _moveRightMenuItem.Click([weakThis](auto&&, auto&&) {\r\n+                if (auto tab{ weakThis.get() })\r\n+                {\r\n+                    MoveTabArgs args{ hstring{}, MoveTabDirection::Forward };\r\n+                    ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n+                    tab->_dispatch.DoAction(*tab, actionAndArgs);\r\n+                }\r\n+            });\r\n+            _moveRightMenuItem.Text(RS_(L\"TabMoveRight\"));\r\n+        }\r\n+\r\n+        // Create a sub-menu for our extended move tab items.\r\n+        Controls::MenuFlyoutSubItem moveSubMenu;\r\n+        moveSubMenu.Text(RS_(L\"TabMoveSubMenu\"));\r\n+        moveSubMenu.Items().Append(_moveToNewWindowMenuItem);\r\n+        moveSubMenu.Items().Append(_moveRightMenuItem);\r\n+        moveSubMenu.Items().Append(_moveLeftMenuItem);\r\n+        flyout.Items().Append(moveSubMenu);\r\n+    }\r\n+\r\n     // Method Description:\r\n     // - Append the close menu items to the context menu flyout\r\n     // Arguments:\r\n@@ -75,7 +138,9 @@ namespace winrt::TerminalApp::implementation\n         _closeTabsAfterMenuItem.Click([weakThis](auto&&, auto&&) {\r\n             if (auto tab{ weakThis.get() })\r\n             {\r\n-                tab->_CloseTabsAfter();\r\n+                CloseTabsAfterArgs args{ tab->_TabViewIndex };\r\n+                ActionAndArgs closeTabsAfter{ ShortcutAction::CloseTabsAfter, args };\r\n+                tab->_dispatch.DoAction(*tab, closeTabsAfter);\r\n             }\r\n         });\r\n         _closeTabsAfterMenuItem.Text(RS_(L\"TabCloseAfter\"));\r\n@@ -88,7 +153,9 @@ namespace winrt::TerminalApp::implementation\n         _closeOtherTabsMenuItem.Click([weakThis](auto&&, auto&&) {\r\n             if (auto tab{ weakThis.get() })\r\n             {\r\n-                tab->_CloseOtherTabs();\r\n+                CloseOtherTabsArgs args{ tab->_TabViewIndex };\r\n+                ActionAndArgs closeOtherTabs{ ShortcutAction::CloseOtherTabs, args };\r\n+                tab->_dispatch.DoAction(*tab, closeOtherTabs);\r\n             }\r\n         });\r\n         _closeOtherTabsMenuItem.Text(RS_(L\"TabCloseOther\"));\r\n@@ -129,33 +196,27 @@ namespace winrt::TerminalApp::implementation\n     }\r\n \r\n     // Method Description:\r\n-    // - Enable the Close menu items based on tab index and total number of tabs\r\n+    // - Enable menu items based on tab index and total number of tabs\r\n     // Arguments:\r\n     // - <none>\r\n     // Return Value:\r\n     // - <none>\r\n-    void TabBase::_EnableCloseMenuItems()\r\n+    void TabBase::_EnableMenuItems()\r\n     {\r\n-        // close other tabs is enabled only if there are other tabs\r\n-        _closeOtherTabsMenuItem.IsEnabled(TabViewNumTabs() > 1);\r\n-        // close tabs after is enabled only if there are other tabs on the right\r\n-        _closeTabsAfterMenuItem.IsEnabled(TabViewIndex() < TabViewNumTabs() - 1);\r\n-    }\r\n+        const auto tabIndex = TabViewIndex();\r\n+        const auto numOfTabs = TabViewNumTabs();\r\n \r\n-    void TabBase::_CloseTabsAfter()\r\n-    {\r\n-        CloseTabsAfterArgs args{ _TabViewIndex };\r\n-        ActionAndArgs closeTabsAfter{ ShortcutAction::CloseTabsAfter, args };\r\n+        // enabled if there are other tabs\r\n+        _closeOtherTabsMenuItem.IsEnabled(numOfTabs > 1);\r\n \r\n-        _dispatch.DoAction(closeTabsAfter);\r\n-    }\r\n+        // enabled if there are other tabs on the right\r\n+        _closeTabsAfterMenuItem.IsEnabled(tabIndex < numOfTabs - 1);\r\n \r\n-    void TabBase::_CloseOtherTabs()\r\n-    {\r\n-        CloseOtherTabsArgs args{ _TabViewIndex };\r\n-        ActionAndArgs closeOtherTabs{ ShortcutAction::CloseOtherTabs, args };\r\n+        // enabled if not left-most tab\r\n+        _moveLeftMenuItem.IsEnabled(tabIndex > 0);\r\n \r\n-        _dispatch.DoAction(closeOtherTabs);\r\n+        // enabled if not last tab\r\n+        _moveRightMenuItem.IsEnabled(tabIndex < numOfTabs - 1);\r\n     }\r\n \r\n     void TabBase::UpdateTabViewIndex(const uint32_t idx, const uint32_t numTabs)\r\n@@ -164,7 +225,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         TabViewIndex(idx);\r\n         TabViewNumTabs(numTabs);\r\n-        _EnableCloseMenuItems();\r\n+        _EnableMenuItems();\r\n         _UpdateSwitchToTabKeyChord();\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TabBase.h b/src/cascadia/TerminalApp/TabBase.h\nindex 9a538550b8d..aa4928c669b 100644\n--- a/src/cascadia/TerminalApp/TabBase.h\n+++ b/src/cascadia/TerminalApp/TabBase.h\n@@ -54,6 +54,9 @@ namespace winrt::TerminalApp::implementation\n         winrt::Windows::UI::Xaml::FocusState _focusState{ winrt::Windows::UI::Xaml::FocusState::Unfocused };\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _closeOtherTabsMenuItem{};\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _closeTabsAfterMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveToNewWindowMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveRightMenuItem{};\r\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _moveLeftMenuItem{};\r\n         winrt::TerminalApp::ShortcutActionDispatch _dispatch;\r\n         Microsoft::Terminal::Settings::Model::IActionMapView _actionMap{ nullptr };\r\n         winrt::hstring _keyChord{};\r\n@@ -69,10 +72,9 @@ namespace winrt::TerminalApp::implementation\n \r\n         virtual void _MakeTabViewItem();\r\n \r\n+        void _AppendMoveMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout);\r\n         winrt::Windows::UI::Xaml::Controls::MenuFlyoutSubItem _AppendCloseMenuItems(winrt::Windows::UI::Xaml::Controls::MenuFlyout flyout);\r\n-        void _EnableCloseMenuItems();\r\n-        void _CloseTabsAfter();\r\n-        void _CloseOtherTabs();\r\n+        void _EnableMenuItems();\r\n         void _UpdateSwitchToTabKeyChord();\r\n         void _UpdateToolTip();\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex 0a01e83d13e..e81e452708e 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -10,7 +10,6 @@\n #include \"Utils.h\"\r\n #include \"ColorHelper.h\"\r\n #include \"AppLogic.h\"\r\n-#include \"../inc/WindowingBehavior.h\"\r\n \r\n using namespace winrt;\r\n using namespace winrt::Windows::UI::Xaml;\r\n@@ -1443,23 +1442,6 @@ namespace winrt::TerminalApp::implementation\n             Automation::AutomationProperties::SetHelpText(splitTabMenuItem, splitTabToolTip);\r\n         }\r\n \r\n-        Controls::MenuFlyoutItem moveTabToNewWindowMenuItem;\r\n-        {\r\n-            // \"Move tab to new window\"\r\n-            Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n-            moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n-            moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n-\r\n-            moveTabToNewWindowMenuItem.Click({ get_weak(), &TerminalTab::_moveTabToNewWindowClicked });\r\n-            moveTabToNewWindowMenuItem.Text(RS_(L\"MoveTabToNewWindowText\"));\r\n-            moveTabToNewWindowMenuItem.Icon(moveTabToNewWindowTabSymbol);\r\n-\r\n-            const auto moveTabToNewWindowToolTip = RS_(L\"MoveTabToNewWindowToolTip\");\r\n-\r\n-            WUX::Controls::ToolTipService::SetToolTip(moveTabToNewWindowMenuItem, box_value(moveTabToNewWindowToolTip));\r\n-            Automation::AutomationProperties::SetHelpText(moveTabToNewWindowMenuItem, moveTabToNewWindowToolTip);\r\n-        }\r\n-\r\n         Controls::MenuFlyoutItem closePaneMenuItem = _closePaneMenuItem;\r\n         {\r\n             // \"Close pane\"\r\n@@ -1535,12 +1517,15 @@ namespace winrt::TerminalApp::implementation\n         contextMenuFlyout.Items().Append(renameTabMenuItem);\r\n         contextMenuFlyout.Items().Append(duplicateTabMenuItem);\r\n         contextMenuFlyout.Items().Append(splitTabMenuItem);\r\n-        contextMenuFlyout.Items().Append(moveTabToNewWindowMenuItem);\r\n+        _AppendMoveMenuItems(contextMenuFlyout);\r\n         contextMenuFlyout.Items().Append(exportTabMenuItem);\r\n         contextMenuFlyout.Items().Append(findMenuItem);\r\n         contextMenuFlyout.Items().Append(restartConnectionMenuItem);\r\n         contextMenuFlyout.Items().Append(menuSeparator);\r\n \r\n+        auto closeSubMenu = _AppendCloseMenuItems(contextMenuFlyout);\r\n+        closeSubMenu.Items().Append(closePaneMenuItem);\r\n+\r\n         // GH#5750 - When the context menu is dismissed with ESC, toss the focus\r\n         // back to our control.\r\n         contextMenuFlyout.Closed([weakThis](auto&&, auto&&) {\r\n@@ -1560,8 +1545,6 @@ namespace winrt::TerminalApp::implementation\n                 }\r\n             }\r\n         });\r\n-        auto closeSubMenu = _AppendCloseMenuItems(contextMenuFlyout);\r\n-        closeSubMenu.Items().Append(closePaneMenuItem);\r\n \r\n         TabViewItem().ContextFlyout(contextMenuFlyout);\r\n     }\r\n@@ -2001,13 +1984,6 @@ namespace winrt::TerminalApp::implementation\n         actionAndArgs.Action(ShortcutAction::ExportBuffer);\r\n         _dispatch.DoAction(*this, actionAndArgs);\r\n     }\r\n-    void TerminalTab::_moveTabToNewWindowClicked(const winrt::Windows::Foundation::IInspectable& /* sender */,\r\n-                                                 const winrt::Windows::UI::Xaml::RoutedEventArgs& /* args */)\r\n-    {\r\n-        MoveTabArgs args{ winrt::to_hstring(NewWindow), MoveTabDirection::Forward };\r\n-        ActionAndArgs actionAndArgs{ ShortcutAction::MoveTab, args };\r\n-        _dispatch.DoAction(*this, actionAndArgs);\r\n-    }\r\n     void TerminalTab::_findClicked(const winrt::Windows::Foundation::IInspectable& /* sender */,\r\n                                    const winrt::Windows::UI::Xaml::RoutedEventArgs& /* args */)\r\n     {\r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.h b/src/cascadia/TerminalApp/TerminalTab.h\nindex f38895a3da6..5a2f67b295d 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.h\n+++ b/src/cascadia/TerminalApp/TerminalTab.h\n@@ -196,7 +196,6 @@ namespace winrt::TerminalApp::implementation\n         void _splitTabClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _closePaneClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _exportTextClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n-        void _moveTabToNewWindowClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void _findClicked(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n \r\n         void _bubbleRestartTerminalRequested(TerminalApp::TerminalPaneContent sender, const winrt::Windows::Foundation::IInspectable& args);\r\n", "instance_id": "microsoft__terminal-18107", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the lack of a single pointer alternative for moving tabs in Windows Terminal, which is a violation of WCAG 2.2 accessibility guidelines. It provides context about the user experience issue, references the relevant WCAG criterion, and includes steps to reproduce the problem. The expected behavior (providing a single pointer alternative) and actual behavior (only mouse dragging is available) are explicitly stated. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify what kind of single pointer alternative is expected (e.g., keyboard shortcuts, context menu options) or provide examples of acceptable solutions. Additionally, edge cases or specific constraints (e.g., behavior with a single tab or maximum tabs) are not mentioned. While the intent is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves multiple files (TabBase.cpp, TerminalTab.cpp, TerminalTab.h, TabBase.h, and resource files), indicating a need to understand and modify interactions across different parts of the codebase. The changes primarily focus on adding context menu items for moving tabs (left, right, and to a new window) as an accessibility feature, which requires understanding the existing UI framework (WinRT/XAML) and event handling mechanisms. The technical concepts involved include familiarity with Windows UI programming, context menu creation, and action dispatching in the Windows Terminal architecture, which are moderately complex for someone unfamiliar with the codebase or WinRT. The amount of code change is moderate, with new menu items and associated logic being added, but it does not appear to impact the broader system architecture significantly. Edge cases, such as disabling menu items based on tab position (first or last tab), are handled in the code changes, but the problem statement does not explicitly call out complex error handling or performance considerations. Overall, this task requires a solid understanding of the codebase and UI programming concepts but does not reach the level of hard or very hard due to the localized nature of the changes and the absence of deep architectural or algorithmic complexity.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Support pickling Geography objects\nAt the moment we didn't implement this, so you will get `TypeError: cannot pickle 'spherely.Point' object`, but it would be useful to support it.\r\n\r\nTo provide a full exact roundtrip through pickling, we should maybe pickle the raw unit vector (x, y, z) of the `S2Point`, instead of going through latitude/longitude like other conversions (eg WKB), because there can always be some floating point difference in this conversion.\r\n\r\n\n", "patch": "diff --git a/src/geography.cpp b/src/geography.cpp\nindex d84c177..bd527fc 100644\n--- a/src/geography.cpp\n+++ b/src/geography.cpp\n@@ -7,6 +7,7 @@\n #include <s2/s2loop.h>\n #include <s2/s2point.h>\n #include <s2/s2polygon.h>\n+#include <s2/util/coding/coder.h>\n #include <s2geography/geography.h>\n #include <s2geography/predicates.h>\n #include <s2geography/wkt-writer.h>\n@@ -171,6 +172,53 @@ void Geography::extract_geog_properties() {\n     }\n }\n \n+py::tuple Geography::encode() const {\n+    // encode geography type\n+    using IntType = std::underlying_type_t<GeographyType>;\n+    auto encoded_geog_type = static_cast<IntType>(geog_type());\n+\n+    // encode empty\n+    // (note: this is already handled internally by s2geography::Geography::EncodeTagged() but\n+    // there no current way to get the that information externally when/after decoding)\n+    auto empty = m_is_empty;\n+\n+    // encode geog\n+    Encoder geog_encoder;\n+    s2geog::EncodeOptions encode_opts;\n+    geog().EncodeTagged(&geog_encoder, encode_opts);\n+\n+    std::string encoded_geog;\n+    encoded_geog.assign(geog_encoder.base(), geog_encoder.base() + geog_encoder.length());\n+\n+    return py::make_tuple(encoded_geog_type, empty, py::bytes(encoded_geog));\n+}\n+\n+Geography Geography::decode(const py::tuple &encoded) {\n+    auto decoded = Geography();\n+\n+    // decode geography type\n+    using IntType = std::underlying_type_t<GeographyType>;\n+    GeographyType geog_type{encoded[0].cast<IntType>()};\n+    decoded.m_geog_type = geog_type;\n+\n+    // decode empty\n+    decoded.m_is_empty = encoded[1].cast<bool>();\n+\n+    // decode geog() (s2geography::Geography)\n+    auto encoded_geog = encoded[2].cast<std::string>();\n+    Decoder geog_decoder(encoded_geog.c_str(), encoded_geog.size());\n+    auto decoded_geog_ptr = s2geog::Geography::DecodeTagged(&geog_decoder);\n+\n+    // TODO: remove this quick & dirty fix (https://github.com/paleolimbot/s2geography/issues/54)\n+    if (decoded_geog_ptr->kind() == s2geog::GeographyKind::GEOGRAPHY_COLLECTION) {\n+        decoded.m_s2geog_ptr = clone_s2geography(*decoded_geog_ptr);\n+    } else {\n+        decoded.m_s2geog_ptr = std::move(decoded_geog_ptr);\n+    }\n+\n+    return decoded;\n+}\n+\n /*\n ** Geography properties\n */\n@@ -267,6 +315,9 @@ void init_geography(py::module &m) {\n         return s2geog::s2_equals(idx1, idx2, options);\n     });\n \n+    pygeography.def(py::pickle([](Geography &geog) { return geog.encode(); },\n+                               [](py::tuple &encoded) { return Geography::decode(encoded); }));\n+\n     // Geography properties\n \n     m.def(\"get_type_id\",\ndiff --git a/src/geography.hpp b/src/geography.hpp\nindex bc116ca..c703647 100644\n--- a/src/geography.hpp\n+++ b/src/geography.hpp\n@@ -107,6 +107,9 @@ class Geography {\n     Geography clone() const;\n     std::unique_ptr<s2geog::Geography> clone_geog() const;\n \n+    py::tuple encode() const;\n+    static Geography decode(const py::tuple& encoded);\n+\n private:\n     S2GeographyPtr m_s2geog_ptr;\n     S2GeographyIndexPtr m_s2geog_index_ptr;\n", "instance_id": "benbovy__spherely-82", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to support pickling of Geography objects in a C++ codebase using the s2geography library. It specifies the current issue (TypeError when pickling) and suggests a solution (pickling raw unit vectors to avoid floating-point conversion issues). However, it lacks critical details such as explicit input/output formats for the pickling process, specific constraints or requirements for compatibility with Python's pickle protocol, and any mention of edge cases or performance considerations. Additionally, there are no examples provided to illustrate the expected behavior or potential challenges. While the goal is understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively contained, primarily affecting a single class (Geography) in two files (geography.cpp and geography.hpp), with the addition of encoding and decoding methods for pickling support. The changes involve a moderate amount of code (around 50 lines added), focusing on serialization using the s2 library's Encoder/Decoder utilities and integration with Python's pickle protocol via pybind11. \n\nSecond, the technical concepts required include familiarity with C++ (specifically with pybind11 for Python bindings), the s2geography library's encoding mechanisms, and Python's pickling process. Understanding how to serialize and deserialize complex geographic data structures (like S2Point) while maintaining data integrity (e.g., avoiding floating-point conversion issues) adds a layer of complexity. The code also includes a workaround for a specific issue with GeographyCollection (noted with a TODO), indicating some nuanced handling of library-specific behavior.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest potential challenges, such as ensuring correct handling of empty geographies and different geography types. Error handling is implicitly required to ensure robust decoding, though not extensively detailed in the diff.\n\nFinally, the changes do not appear to impact the broader system architecture significantly, as they are localized to the Geography class and its Python interface. However, the need to understand library-specific encoding (s2/util/coding/coder.h) and manage memory ownership (e.g., cloning vs. moving geography pointers) adds moderate complexity. Overall, this task requires a solid understanding of multiple concepts and careful implementation, placing it in the medium difficulty range at 0.55.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "WebFrameMain frames and name field access SIGSEGV\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.3.0\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sonoma 14.3\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nAccessing WebFrameMain `frames` and `name` attributes on destroyed frames previously threw an error.\n\n### Actual Behavior\n\nAccessing WebFrameMain `frames` and `name` attributes on destroyed frames now segfaults.\n\n```checked if frame is alive 0.8441429125447275\nchecking if frame is alive 0.7526827941185381\nchecked if frame is destroyed 0.7526827941185381\nchecking if frame is detached 0.7526827941185381\nchecked if frame is detached 0.7526827941185381\nchecking .frames 0.7526827941185381\n.../app/node_modules/electron/dist/Electron.app/Contents/MacOS/Electron exited with signal SIGSEGV```\n\nThe trace:\n\n```\nThread 0 (crashed)\n0 Electron Framework!content::FrameTree::SubtreeAndInnerTreeNodes(content::RenderFrameHostImpl*, bool) [frame_tree.cc : 353 + 0x0]\nx0 = 0xefefefefefefefef x1 = 0x0000000000000000\nx2 = 0x000000010c47eb00 x3 = 0x0000000000000000\nx4 = 0x0000000000000000 x5 = 0x000000000000000f\nx6 = 0x0000000000000180 x7 = 0x0000000000000004\nx8 = 0xaaaaaaaaaaaaaaaa x9 = 0x000000010eb2cd94\nx10 = 0xffffffffffff1e48  x11 = 0x00000d6300100000\nx12 = 0x0000000000001685  x13 = 0x0000000000000044\nx14 = 0x0000000000000010  x15 = 0x0000000000000003\nx16 = 0x000000000089cb29  x17 = 0x0000000157e0f6cc\nx18 = 0x0000000000000000  x19 = 0x000000016d59b710\nx20 = 0x0000000000000000  x21 = 0x00000104009d7e00\nx22 = 0x0000000000000000  x23 = 0x000000011528a000\nx24 = 0x00000001153b8000  x25 = 0xefefefefefefefef\nx26 = 0x0000010400510100  x27 = 0x00000d63002cdf65\nx28 = 0x00000d6300000000 fp = 0x000000016d59b680\nlr = 0x000000010eaf767c sp = 0x000000016d59b600\npc = 0x000000010ea57460\nFound by: given as instruction pointer in context\n1 Electron Framework!content::RenderFrameHostImpl::ForEachRenderFrameHostImpl(base::FunctionRef&lt;content::RenderFrameHost::FrameIterationAction (content::RenderFrameHostImpl*)&gt;, bool) [render_frame_host_impl.cc : 2713 + 0xc]\nx19 = 0x0000000000000000  x20 = 0x000000010eb2cd9c\nx21 = 0x000000016d59b790  x22 = 0x00000104009d7e00\nx23 = 0xaaaaaaaaaaaaaaaa  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b770 sp = 0x000000016d59b690\npc = 0x000000010eaf767c\nFound by: call frame info\n2 Electron Framework!content::RenderFrameHostImpl::ForEachRenderFrameHost(base::FunctionRef&lt;void (content::RenderFrameHost*)&gt;) [render_frame_host_impl.cc : 2638 + 0x8]\nx19 = 0x00000104067ccfa0  x20 = 0x000000016d59b7e8\nx21 = 0x000000016d59b8a8  x22 = 0x0000000000000001\nx23 = 0x0000000000000015  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b7a0 sp = 0x000000016d59b780\npc = 0x000000010eaf75c0\nFound by: call frame info\n3 Electron Framework!electron::api::WebFrameMain::Frames() const [electron_api_web_frame_main.cc : 412 + 0x4]\nx19 = 0x00000104067ccfa0  x20 = 0x000000016d59b7e8\nx21 = 0x000000016d59b8a8  x22 = 0x0000000000000001\nx23 = 0x0000000000000015  x24 = 0x00000001153b8000\nx25 = 0x00000104000f0280  x26 = 0x0000010400510100\nx27 = 0x00000d63002cdf65  x28 = 0x00000d6300000000\nfp = 0x000000016d59b7d0 sp = 0x000000016d59b7b0\npc = 0x000000010c47bf8c\nFound by: call frame info```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nThis may be related to [#43473](https://github.com/electron/electron/pull/43473) @samuelmaddock \n", "patch": "diff --git a/shell/browser/api/electron_api_web_frame_main.cc b/shell/browser/api/electron_api_web_frame_main.cc\nindex 3e800659a48c3..cc3d142eef049 100644\n--- a/shell/browser/api/electron_api_web_frame_main.cc\n+++ b/shell/browser/api/electron_api_web_frame_main.cc\n@@ -183,7 +183,7 @@ void WebFrameMain::UpdateRenderFrameHost(content::RenderFrameHost* rfh) {\n }\n \n bool WebFrameMain::CheckRenderFrame() const {\n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n     v8::HandleScope scope(isolate);\n     gin_helper::ErrorThrower(isolate).ThrowError(\n@@ -435,7 +435,7 @@ v8::Local<v8::Promise> WebFrameMain::CollectDocumentJSCallStack(\n   gin_helper::Promise<base::Value> promise(args->isolate());\n   v8::Local<v8::Promise> handle = promise.GetHandle();\n \n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     promise.RejectWithErrorMessage(\n         \"Render frame was disposed before WebFrameMain could be accessed\");\n     return handle;\n@@ -463,7 +463,7 @@ void WebFrameMain::CollectedJavaScriptCallStack(\n     gin_helper::Promise<base::Value> promise,\n     const std::string& untrusted_javascript_call_stack,\n     const std::optional<blink::LocalFrameToken>& remote_frame_token) {\n-  if (render_frame_disposed_) {\n+  if (!HasRenderFrame()) {\n     promise.RejectWithErrorMessage(\n         \"Render frame was disposed before call stack was received\");\n     return;\ndiff --git a/shell/browser/api/electron_api_web_frame_main.h b/shell/browser/api/electron_api_web_frame_main.h\nindex 9191e6f346217..de984aee5db69 100644\n--- a/shell/browser/api/electron_api_web_frame_main.h\n+++ b/shell/browser/api/electron_api_web_frame_main.h\n@@ -101,8 +101,14 @@ class WebFrameMain final : public gin::Wrappable<WebFrameMain>,\n   void TeardownMojoConnection();\n   void OnRendererConnectionError();\n \n-  // WebFrameMain can outlive its RenderFrameHost pointer so we need to check\n-  // whether its been disposed of prior to accessing it.\n+  [[nodiscard]] constexpr bool HasRenderFrame() const {\n+    return !render_frame_disposed_ && render_frame_ != nullptr;\n+  }\n+\n+  // Throws a JS error if HasRenderFrame() is false.\n+  // WebFrameMain can outlive its RenderFrameHost pointer,\n+  // so we need to check whether its been disposed of\n+  // prior to accessing it.\n   bool CheckRenderFrame() const;\n \n   v8::Local<v8::Promise> ExecuteJavaScript(gin::Arguments* args,\n", "instance_id": "electron__electron-45487", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: accessing the `frames` and `name` attributes of a destroyed `WebFrameMain` object in Electron results in a segmentation fault (SIGSEGV) instead of throwing an error as expected. The statement includes relevant details such as the Electron version, operating system, architecture, and a stack trace, which help in understanding the context of the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what constitutes a \"destroyed frame\" or under what specific conditions the frame is considered destroyed. Additionally, there are no detailed reproduction steps or a test case (the Testcase Gist URL is marked as \"No response\"), which could make it harder to replicate the issue consistently. Edge cases or specific scenarios leading to the crash are also not mentioned. Despite these gaps, the overall intent and nature of the bug are understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem is rated at 0.65, placing it in the \"Hard\" category (0.6-0.8). This assessment is based on several factors. First, the scope of code changes appears relatively focused, primarily involving modifications to the `WebFrameMain` class in the Electron codebase, specifically around how the render frame's state is checked before access. The provided diff shows changes in a single file (`electron_api_web_frame_main.cc`) and its header (`electron_api_web_frame_main.h`), replacing a simple boolean flag check (`render_frame_disposed_`) with a more robust condition (`HasRenderFrame()`). However, the impact of these changes is significant as they address a critical issue (SIGSEGV) that can crash the application, requiring a deep understanding of Electron's rendering architecture and frame lifecycle management. \n\nSecond, the technical concepts involved are moderately complex. Solving this requires familiarity with C++ (used in Electron's native layer), understanding of Electron's API design (specifically `WebFrameMain`), and knowledge of Chromium's rendering pipeline (`RenderFrameHost`). Additionally, the developer must understand how JavaScript bindings interact with native code through V8, as the error handling involves throwing JavaScript errors from C++.\n\nThird, the problem touches on edge cases related to frame destruction and detachment, which are not fully detailed in the problem statement but are evident from the stack trace and code changes. Ensuring that the frame state is correctly checked before access is crucial to prevent crashes, and the solution must handle scenarios where the frame might be disposed of or detached unexpectedly. The code changes introduce a more explicit check (`HasRenderFrame()`), indicating a need to account for such edge cases, though the complexity of these edge cases seems moderate based on the diff.\n\nFinally, while the changes are localized, the potential impact on the broader Electron codebase is non-trivial due to the critical nature of frame management. A mistake here could introduce new crashes or regressions in other parts of the application. The problem also references a related pull request (#43473), suggesting that it may be part of a larger context or ongoing issue, which adds to the cognitive load of understanding the full scope. Overall, this problem requires a solid grasp of the Electron internals and careful handling of frame state, justifying a difficulty score of 0.65.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ctrl+C and Ctrl+V shortcuts are broken, they apply to the wrong tab\n### Tested versions\r\n\r\nv4.2.1.stable.mono.official [b09f793f5]\r\n\r\n\r\n\r\n### System information\r\n\r\nGodot v4.2.1.stable.mono - Windows 10.0.19045 - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 6GB (NVIDIA; 31.0.15.3623) - AMD Ryzen 5 2600X Six-Core Processor (12 Threads)\r\n\r\n### Issue description\r\n\r\nWhen I try to use Ctrl+C and Ctrl+V to copy and paste an object in my scene, it instead for some reason pastes an option in the `Import` tab.\r\n\r\n- I do not have the `Import` tab open, I have the `Scene` tab open.\r\n- I do not even have something selected in the `FileSystem` tab which would show up in the `Import` tab when I switch to it.\r\n- But nonetheless I get `Set meshes/force_disable_compression` in the output when trying to Ctrl+C and Ctrl+V, which was the most recent setting I changed in the `Import` tab before moving on to other tasks.\r\n\r\nUsing the right click menu and selecting `Copy` and then selecting `Paste` works as intended. For some reason it is just the keyboard shortcut which is broken.\r\n\r\n### Steps to reproduce\r\n\r\n1. change a setting in the `Import` tab\r\n2. try to copy something in the `Scene` tab\r\n3. it will do nothing and the output will show that it just affected whatever setting you changed in the `Import` tab.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\nOpen a brand new project and follow the steps. Change an import setting of icon.svg and now you cannot Ctrl+C Ctrl+V in the `Scene` tab\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex d9bead1e7832..5611d00814f3 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -579,6 +579,12 @@ void EditorProperty::_notification(int p_what) {\n \t\t\t}\n \t\t} break;\n \t\tcase NOTIFICATION_ENTER_TREE: {\n+\t\t\tEditorInspector *inspector = get_parent_inspector();\n+\t\t\tif (inspector) {\n+\t\t\t\tinspector = inspector->get_root_inspector();\n+\t\t\t}\n+\t\t\tset_shortcut_context(inspector);\n+\n \t\t\tif (has_borders) {\n \t\t\t\tget_parent()->connect(SceneStringName(theme_changed), callable_mp(this, &EditorProperty::_update_property_bg));\n \t\t\t\t_update_property_bg();\n", "instance_id": "godotengine__godot-104485", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Ctrl+C and Ctrl+V shortcuts are malfunctioning in the Godot editor, affecting the wrong tab (pasting settings in the 'Import' tab instead of copying/pasting objects in the 'Scene' tab). The description includes the context (tested version, system information), steps to reproduce, and a minimal reproduction project, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, it does not explicitly mention whether this issue affects all objects or specific types in the 'Scene' tab, nor does it clarify if the issue persists across sessions or is tied to specific user actions beyond the described steps. Additionally, the expected behavior is implied but not explicitly detailed (e.g., what exactly should happen when Ctrl+C and Ctrl+V are pressed in the 'Scene' tab). These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change appears localized to a single file (`editor_inspector.cpp`) and involves a small modification (adding a few lines to set the shortcut context). This suggests a relatively contained impact, not requiring extensive changes across multiple modules or significant architectural modifications. However, understanding the fix requires knowledge of the Godot editor's internal architecture, specifically how shortcut contexts are managed and how the inspector hierarchy interacts with input handling. The change involves setting the shortcut context to the root inspector, which implies a need to understand the relationship between `EditorProperty`, `EditorInspector`, and input event propagation in the Godot engine—a moderately complex concept for someone unfamiliar with the codebase. Additionally, while the problem statement does not explicitly mention edge cases, the nature of input handling suggests potential issues like ensuring the shortcut context does not conflict with other UI elements or tabs, which might require careful testing but not extensive error handling in the provided code change. Overall, this problem requires understanding a specific part of the codebase and making a targeted fix, placing it at 0.45 (Medium difficulty), as it goes beyond a simple bug fix but does not demand deep architectural refactoring or advanced domain-specific knowledge.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Game crashes when adding color preset after clearing presets in another control\n### Tested versions\n\n- Reproducible in: 4.4 (and previous 4.4.dev builds since saving color palettes was introduced #91604)\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - integrated AMD Radeon 780M Graphics (Advanced Micro Devices, Inc.; 32.0.11039.8001) - AMD Ryzen 7 8845HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\nIf you have multiple `ColorPickers` in the scene and one `ColorPicker` uses saved color palette and it was cleared, trying to add color preset in another `ColorPicker`, if that color was added to the presets before, it would crash the game.\n\nhttps://github.com/user-attachments/assets/1e5da6c7-255e-4d99-9793-721f06493741\n\n### Steps to reproduce\n\n1. Add 2 or more `ColorPicker`s to the scene\n2. Assign different colors to each `ColorPicker`\n3. Run the game\n4. Open Swatches in each `ColorPicker` and add current color to presets\n5. Save presets of one `ColorPicker` as color palette (you will see another issue mentioned in #104223)\n6. Clear presets in the `ColorPicker` that you saved the palette in\n7. In another `ColorPicker`  press the button to add current color to presets without chaning the color before (it should be the same color, as was added to presets for this `ColorPicker` before\n8. The game should crash\n\n### Minimal reproduction project (MRP)\n\n[regression-test-project.zip](https://github.com/user-attachments/files/19270277/regression-test-project.zip)\n", "patch": "diff --git a/scene/gui/color_picker.cpp b/scene/gui/color_picker.cpp\nindex 426e0092d71b..655988b3d16e 100644\n--- a/scene/gui/color_picker.cpp\n+++ b/scene/gui/color_picker.cpp\n@@ -1138,16 +1138,21 @@ void ColorPicker::add_preset(const Color &p_color) {\n \tList<Color>::Element *e = presets.find(p_color);\n \tif (e) {\n \t\tpresets.move_to_back(e);\n-\t\tpreset_cache.move_to_back(preset_cache.find(p_color));\n \n \t\tpreset_container->move_child(preset_group->get_pressed_button(), preset_container->get_child_count() - 1);\n \t} else {\n \t\tpresets.push_back(p_color);\n-\t\tpreset_cache.push_back(p_color);\n \n \t\t_add_preset_button(_get_preset_size(), p_color);\n \t}\n \n+\tList<Color>::Element *cache_e = preset_cache.find(p_color);\n+\tif (cache_e) {\n+\t\tpreset_cache.move_to_back(cache_e);\n+\t} else {\n+\t\tpreset_cache.push_back(p_color);\n+\t}\n+\n \tif (!palette_name->get_text().is_empty()) {\n \t\tpalette_name->set_text(vformat(\"%s*\", palette_name->get_text().trim_suffix(\"*\")));\n \t\tpalette_name->set_tooltip_text(ETR(\"The changes to this palette have not been saved to a file.\"));\n", "instance_id": "godotengine__godot-104227", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a game crash occurs when adding a color preset in one ColorPicker after clearing presets in another ColorPicker. It provides detailed steps to reproduce the issue, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the root cause of the crash (e.g., whether it's a null pointer dereference, memory corruption, or something else), which would help in assessing the scope of the fix. Additionally, it references another issue (#104223) without explaining its relevance, which could confuse someone unfamiliar with that issue. Edge cases beyond the specific reproduction steps are not discussed, leaving some uncertainty about the full scope of the problem. Overall, while the statement is actionable, it lacks some critical technical details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is relatively small and localized to a single file (`color_picker.cpp`) and a specific function (`add_preset`). The diff shows a modest modification involving the management of two lists (`presets` and `preset_cache`) to ensure consistency when moving or adding colors, which suggests a straightforward bug fix rather than a complex feature addition or architectural change. Second, the technical concepts involved are relatively basic: understanding of list manipulation in C++ and familiarity with the Godot engine's GUI component logic. No advanced algorithms, design patterns, or domain-specific knowledge beyond typical GUI programming are required. Third, the problem does not appear to involve complex edge cases beyond the specific crash scenario described, and the fix does not introduce significant error handling logic. However, it does require a moderate understanding of the interaction between `presets` and `preset_cache` lists and how they relate to the UI components, which slightly elevates the difficulty above \"Very Easy.\" There is no indication of broader architectural impact or performance considerations. Overall, this is a manageable bug fix for a developer with basic to intermediate experience in C++ and GUI programming, hence the score of 0.35.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "FileSystem panel loses focus after Renaming or Duplicating files\n**Godot version:**\r\n3.2.alpha 35944aebdeb4c3b5869aaeedaaded02397b7ce92\r\n**OS/device including version:**\r\n5.3.7.arch1-1\r\n**Issue description:**\r\nDeleting, renaming or duplicating a file in the FileSystem panel opens a prompt window. If you close this window while deleting a file (either by confirming the deletion or cancelling it) the FileSystem panel regains focus. This doesn't happen when duplicating or renaming a file. **edit:** [and it would be nice if it did.](https://github.com/godotengine/godot/issues/33126#issuecomment-547577403)\r\n**Steps to reproduce:**\r\n1. Select a file in the FileSystem panel\r\n2. Duplicate the file either by right-click -> Duplicate or the shortcut Ctrl+D\r\n3. Type a new name and press Return(Enter) to confirm\r\n\n", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex 4fafdefbb598..267514ffde6a 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1338,6 +1338,10 @@ void FileSystemDock::_fs_changed() {\n \t}\n \n \tset_process(false);\n+\tif (had_focus) {\n+\t\thad_focus->grab_focus();\n+\t\thad_focus = nullptr;\n+\t}\n }\n \n void FileSystemDock::_set_scanning_mode() {\n@@ -2675,6 +2679,12 @@ bool FileSystemDock::_matches_all_search_tokens(const String &p_text) {\n }\n \n void FileSystemDock::_rescan() {\n+\tif (tree->has_focus()) {\n+\t\thad_focus = tree;\n+\t} else if (files->has_focus()) {\n+\t\thad_focus = files;\n+\t}\n+\n \t_set_scanning_mode();\n \tEditorFileSystem::get_singleton()->scan();\n }\ndiff --git a/editor/filesystem_dock.h b/editor/filesystem_dock.h\nindex 0ed0de3d59e9..dac535efb8e9 100644\n--- a/editor/filesystem_dock.h\n+++ b/editor/filesystem_dock.h\n@@ -235,6 +235,7 @@ class FileSystemDock : public VBoxContainer {\n \tbool import_dock_needs_update = false;\n \tTreeItem *resources_item = nullptr;\n \tTreeItem *favorites_item = nullptr;\n+\tControl *had_focus = nullptr;\n \n \tbool holding_branch = false;\n \tVector<TreeItem *> tree_items_selected_on_drag_begin;\n", "instance_id": "godotengine__godot-103734", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the FileSystem panel in Godot loses focus after renaming or duplicating files, unlike after deleting files where focus is regained. The goal is implied—to ensure the FileSystem panel regains focus after renaming or duplicating actions. Steps to reproduce are provided, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly state whether the focus should return to a specific element (e.g., the tree or file list) or just the panel in general. Additionally, there are no mentions of edge cases, such as what should happen if the panel is not visible or if multiple operations are performed in quick succession. Constraints or expected behavior in different UI states are also not specified. Despite these minor gaps, the issue is valid and understandable with the provided context and steps.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following reasons based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively small and localized to a single class (`FileSystemDock`) across two files (`filesystem_dock.cpp` and `filesystem_dock.h`). The modifications involve adding a member variable to track the focused control and logic to restore focus after certain operations. The changes do not impact the broader system architecture or require understanding complex interactions between multiple modules. The amount of code change is minimal, with only a few lines added to store and restore focus.\n\n2. **Number of Technical Concepts:** The solution requires basic understanding of UI handling in Godot, specifically focus management using methods like `grab_focus()`. It involves straightforward C++ concepts such as pointers and conditional checks. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI programming are needed. Familiarity with Godot's editor codebase is helpful but not critical for this isolated fix.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not mention specific edge cases, and the code changes do not introduce complex error handling. However, a developer might need to consider minor edge cases, such as ensuring `had_focus` is properly reset or handling scenarios where the control no longer exists when focus is to be restored. These are not particularly complex to address.\n\n4. **Overall Complexity:** The task is a simple bug fix that involves understanding a small part of the UI logic and making targeted modifications. It does not require deep knowledge of the entire codebase or intricate logic. The primary challenge lies in identifying the correct place to store and restore focus, which is straightforward given the provided diff.\n\nGiven these factors, a difficulty score of 0.30 reflects an easy problem that requires minimal code changes and basic understanding of UI focus management in a C++-based framework like Godot. It is slightly above the \"Very Easy\" range due to the need to understand the specific context of focus handling in the editor UI.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Invalid startup embedded game location and size after resizing editor main area\n### Tested versions\n\n- Reproductive in Godot 4.4 RC3, RC2\n\n### System information\n\nGodot v4.4.rc3 - Windows 11 (build 26100) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.7260) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded in the editor, if when editor main area is resized, the next time the embedded game is started it will startup with the previous location and sizse.\n\n### Steps to reproduce\n\n- Activate embedded without floating window\n- Start the game the first time, location and size will be OK\n- Stop the game\n- Resize a floating dock or the bottom panel when your are not in the Game tab\n- Start the game again\n- For a split second, the game will be displayed at the previous location and size before the resizing in the editor (the location and size of the previous startup)\n\nhttps://github.com/user-attachments/assets/94d29bef-e8b1-4b56-b1f6-6cef7560c6d9\n\n### Minimal reproduction project (MRP)\n\nAny project\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 30c558e0bd5d..bc3b4ceeb2b7 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -257,7 +257,7 @@ void GameView::_show_update_window_wrapper() {\n \tPoint2 offset_embedded_process = embedded_process->get_global_position() - get_global_position();\n \n \t// On the first startup, the global position of the embedded process control is invalid because it was\n-\t// never displayed. We will calculated it manually using the minimum size of the window.\n+\t// never displayed. We will calculate it manually using the minimum size of the window.\n \tif (offset_embedded_process == Point2()) {\n \t\toffset_embedded_process.y = wrapped_min_size.y;\n \t}\n@@ -812,9 +812,8 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \t_update_embed_window_size();\n \tRect2i rect = embedded_process->get_screen_embedded_window_rect();\n \n-\t// On the first startup, the global rect of the embedded process control is invalid because it was\n-\t// never displayed. We will calculated it manually.\n-\tif (!window_wrapper->get_window_enabled() && rect.size.y < embedded_process->get_custom_minimum_size().y) {\n+\t// Usually, the global rect of the embedded process control is invalid because it was hidden. We will calculate it manually.\n+\tif (!window_wrapper->get_window_enabled()) {\n \t\tSize2 old_min_size = embedded_process->get_custom_minimum_size();\n \t\tembedded_process->set_custom_minimum_size(Size2i());\n \n", "instance_id": "godotengine__godot-103436", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when the editor main area is resized in Godot 4.4 RC versions, the embedded game does not update its location and size correctly upon restarting, briefly showing the previous position before adjusting. The steps to reproduce are detailed, and a visual reference (via a GitHub attachment) is provided, which aids in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the game always start with the updated size/location immediately without flickering?). Additionally, there are no mentions of specific edge cases or constraints, such as behavior on different monitor setups beyond the reported dual-monitor configuration, or how different resizing actions might impact the issue. While the issue is reproducible in \"any project,\" the lack of a minimal reproduction project (MRP) with specific configurations could make it slightly harder to debug for someone unfamiliar with Godot's editor. Overall, the description is valid and mostly clear but lacks some precision and completeness in requirements and edge case coverage, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of code changes is relatively small and localized to a single file (`game_view_plugin.cpp`) within the Godot editor plugin. The diff shows minor modifications to two specific sections of the code, focusing on updating the logic for calculating the position and size of the embedded game window. The changes involve straightforward adjustments to conditional checks and comments, indicating a low volume of code modification without impacting the broader system architecture or requiring cross-module interactions.\n\nSecond, the technical concepts required to address this issue are not overly complex. The problem revolves around understanding Godot's editor UI rendering logic, specifically how embedded windows and their sizes/positions are managed during resizing events. Familiarity with Godot's internal APIs (e.g., `get_global_position()`, `get_screen_embedded_window_rect()`) and basic GUI programming concepts (e.g., window positioning and sizing) is necessary, but these are not advanced topics for someone with moderate experience in game engine development or C++ GUI programming.\n\nThird, the potential edge cases and error handling requirements appear minimal based on the problem statement and code changes. The issue description does not highlight specific edge cases beyond the general resizing behavior, and the code modifications do not introduce new error handling logic. However, there might be implicit edge cases to consider, such as rapid resizing events or extreme window sizes, which are not addressed in the diff or problem statement. These could slightly increase the complexity, but not significantly.\n\nOverall, this problem requires understanding some code logic and making simple modifications to fix a UI rendering glitch, without deep architectural changes or advanced technical knowledge. A difficulty score of 0.35 reflects this as an \"Easy\" task, leaning slightly toward the higher end of the range due to the need for familiarity with Godot's editor internals, which might pose a small learning curve for someone new to the codebase.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Window content_scale_factor causes jitter in Control size\n### Tested versions\n\nReproducible in 4.4-beta3, 4.3-stable\n\n### System information\n\nGodot v4.4.beta3 - Ubuntu 24.04.1 LTS 24.04 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) UHD Graphics (CML GT2) - Intel(R) Core(TM) i7-10510U CPU @ 1.80GHz (8 threads)\n\n### Issue description\n\nUsing the recommended way to scale UI to screen resolution by setting `get_tree().root.content_scale_factor` (either in the project settings or from script) causes Control node pixels to jitter on resizing the window. This is true even when the \"Snap Controls to Pixels\" option is enabled.\n\nInterestingly, using the node's own scale factor (or scaling a parent node to rescale the entire UI) doesn't exhibit this behaviour, but causes a host of other issues with GUIs so it's not a possible workaround.\n\nScreenshot of misaligned grid pixels from the MRP:\n\n![Image](https://github.com/user-attachments/assets/c906e43d-2bce-4ecd-b48a-aae6f9bb0015)\n\nScreenshot of the grid looking perfect at a different resolution:\n\n![Image](https://github.com/user-attachments/assets/fb2dea18-5215-41d1-b84b-93b6cceea017)\n\nI also managed to reproduce this in my game with all kinds of control nodes, including fonts. In that case the jitter is a lot more visible even when resizing at high resolutions.\n\n**Update:**\n\nSetting `content_scale_factor = 8.0` shows that this is not even a jitter, the control node's scale is just completely off when resizing to certain resolutions. There's no need for Nearest filtering either, the effect is clearly visible even on Linear filtered textures.\n\nhttps://github.com/user-attachments/assets/3cf1038a-1958-488d-acf5-fd5148140f8e\n\n### Steps to reproduce\n\n1. Place a control node (Confirmed with: TextureRect, Label).\n3. Optionally, set the window resolution to a small value, such as 480x360. For me small window sizes (regardless of the base resolution) greatly exacerbate the effect, but it also happens from time to time on larger window sizes.\n4. Set `display/window/stretch/scale` to a larger value, in my case 4.0 is enough, 8.0 makes it super visible.\n5. Resize the game window by dragging the corner, and watch the control node size jitter.\n\n### Minimal reproduction project (MRP)\n\n[gui-scale.zip](https://github.com/user-attachments/files/18734113/gui-scale.zip)\n", "patch": "diff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex d0054baeff25..e3979837ab69 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -1002,10 +1002,10 @@ void Viewport::update_canvas_items() {\n \t_update_canvas_items(this);\n }\n \n-bool Viewport::_set_size(const Size2i &p_size, const Size2i &p_size_2d_override, bool p_allocated) {\n+bool Viewport::_set_size(const Size2i &p_size, const Size2 &p_size_2d_override, bool p_allocated) {\n \tTransform2D stretch_transform_new = Transform2D();\n \tif (is_size_2d_override_stretch_enabled() && p_size_2d_override.width > 0 && p_size_2d_override.height > 0) {\n-\t\tSize2 scale = Size2(p_size) / Size2(p_size_2d_override);\n+\t\tSize2 scale = Size2(p_size) / p_size_2d_override;\n \t\tstretch_transform_new.scale(scale);\n \t}\n \n@@ -1074,7 +1074,7 @@ Size2i Viewport::_get_size() const {\n \treturn size;\n }\n \n-Size2i Viewport::_get_size_2d_override() const {\n+Size2 Viewport::_get_size_2d_override() const {\n \treturn size_2d_override;\n }\n \n@@ -1092,7 +1092,7 @@ Rect2 Viewport::get_visible_rect() const {\n \t\tr = Rect2(Point2(), size);\n \t}\n \n-\tif (size_2d_override != Size2i()) {\n+\tif (size_2d_override != Size2()) {\n \t\tr.size = size_2d_override;\n \t}\n \n@@ -5223,7 +5223,10 @@ void SubViewport::set_size_2d_override(const Size2i &p_size) {\n \n Size2i SubViewport::get_size_2d_override() const {\n \tERR_READ_THREAD_GUARD_V(Size2i());\n-\treturn _get_size_2d_override();\n+\t// Rounding will cause offset issues with the\n+\t// exact positioning of subwindows, but changing the\n+\t// type of size_2d_override would break compatibility.\n+\treturn Size2i((_get_size_2d_override() + Size2(0.5, 0.5)).floor());\n }\n \n void SubViewport::set_size_2d_override_stretch(bool p_enable) {\ndiff --git a/scene/main/viewport.h b/scene/main/viewport.h\nindex 5260b513a951..5bcb50c55546 100644\n--- a/scene/main/viewport.h\n+++ b/scene/main/viewport.h\n@@ -252,7 +252,7 @@ class Viewport : public Node {\n \tTransform2D stretch_transform;\n \n \tSize2i size = Size2i(512, 512);\n-\tSize2i size_2d_override;\n+\tSize2 size_2d_override;\n \tbool size_allocated = false;\n \n \tRID contact_2d_debug;\n@@ -492,10 +492,10 @@ class Viewport : public Node {\n \tvoid _window_start_resize(SubWindowResize p_edge, Window *p_window);\n \n protected:\n-\tbool _set_size(const Size2i &p_size, const Size2i &p_size_2d_override, bool p_allocated);\n+\tbool _set_size(const Size2i &p_size, const Size2 &p_size_2d_override, bool p_allocated);\n \n \tSize2i _get_size() const;\n-\tSize2i _get_size_2d_override() const;\n+\tSize2 _get_size_2d_override() const;\n \tbool _is_size_allocated() const;\n \n \tvoid _notification(int p_what);\ndiff --git a/scene/main/window.cpp b/scene/main/window.cpp\nindex 1bb01313e721..d6328972b894 100644\n--- a/scene/main/window.cpp\n+++ b/scene/main/window.cpp\n@@ -1133,7 +1133,7 @@ void Window::_update_viewport_size() {\n \t//update the viewport part\n \n \tSize2i final_size;\n-\tSize2i final_size_override;\n+\tSize2 final_size_override;\n \tRect2i attach_to_screen_rect(Point2i(), size);\n \tdouble font_oversampling = 1.0;\n \twindow_transform = Transform2D();\n", "instance_id": "godotengine__godot-102741", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the context (UI scaling in Godot engine), the specific behavior observed (jitter in Control node sizes during window resizing), and steps to reproduce the issue. It also includes visual evidence (screenshots and a video) and a minimal reproduction project (MRP), which significantly aids in understanding the problem. However, there are minor ambiguities that prevent it from being comprehensive. For instance, the problem statement does not explicitly define the expected behavior or the desired outcome of the fix (e.g., Ascending does not clarify whether the goal is to eliminate jitter entirely or to minimize it to an acceptable level. Additionally, while edge cases like different resolutions and window sizes are mentioned, there is no detailed discussion on specific constraints or performance requirements for the fix. These missing details slightly reduce the clarity, as they leave some room for interpretation regarding the scope and success criteria of the solution.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.65, placing it in the \"Hard\" category. This assessment is based on several factors:\n\n1. **Scope and Depth of Code Changes:** The code changes provided affect multiple files (`viewport.cpp`, `viewport.h`, and `window.cpp`) within the Godot engine, a complex and large codebase. The modifications involve changing data types (from `Size2i` to `Size2`) and adjusting calculations related to viewport scaling and size overrides. These changes impact core rendering logic, which is critical to the engine's functionality, and require a deep understanding of how viewports and UI scaling interact across different components. While the actual lines of code changed are relatively few, the impact on the system's architecture (rendering and UI layout) is significant, as errors here could introduce new bugs or performance issues.\n\n2. **Number of Technical Concepts:** Solving this problem requires familiarity with several advanced concepts, including graphics rendering pipelines, viewport transformations, floating-point precision issues, and UI scaling in game engines. Specific knowledge of Godot's internal architecture (e.g., how `content_scale_factor` interacts with window resizing and control nodes) is necessary. Additionally, understanding the implications of type changes (integer to floating-point) on precision and rounding behavior is critical. These concepts are moderately to highly complex, especially for someone not already familiar with game engine internals.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement highlights edge cases such as varying window resolutions, different scale factors (e.g., 4.0 or 8.0), and different display drivers (Wayland, X11). These edge cases are non-trivial, as they involve handling discrepancies in pixel alignment and scaling across diverse hardware and software environments. The code changes also introduce a rounding adjustment in `SubViewport::get_size_2d_override()` to address positioning issues, which suggests attention to subtle precision-related edge cases. However, additional error handling or validation logic does not appear to be a major focus of the changes, which slightly mitigates the difficulty.\n\n4. **Overall Complexity:** The combination of working in a critical area of the codebase (viewport and rendering logic), the need for domain-specific knowledge of game engine internals, and the handling of resolution and scaling edge cases makes this a challenging problem. It is not at the extreme end of difficulty (e.g., implementing a new rendering system from scratch), but it still requires a solid grasp of complex systems and careful testing to ensure the fix does not introduce regressions. Hence, a score of 0.65 reflects the hard but not insurmountable nature of the task, likely requiring a developer with intermediate to advanced experience in graphics programming or game engine development.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": ".NET: Building GodotSharp is broken in current `master` branch\n### Tested versions\n\n- Reproducible in 4.4.dev (4364ed6ccd001cbfe7cb781d074100695c878d90)\n- Not reproducible in 4.4.dev6 and earlier\n\n### System information\n\nFedora 41, .NET 8.0.111\n\n### Issue description\n\nWhen building the GodotSharp assemblies, I get these errors:\n\n```\n$ ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin\nRunning MSBuild:  /usr/bin/dotnet msbuild /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp.sln /restore /t:Build /p:Configuration=Debug /p:NoWarn=1591\n\nWelcome to .NET 8.0!\n---------------------\nSDK Version: 8.0.111\n\n----------------\nInstalled an ASP.NET Core HTTPS development certificate.\nTo trust the certificate, view the instructions: https://aka.ms/dotnet-https-linux\n\n----------------\nWrite your first app: https://aka.ms/dotnet-hello-world\nFind out what's new: https://aka.ms/dotnet-whats-new\nExplore documentation: https://aka.ms/dotnet-docs\nReport issues and find source on GitHub: https://github.com/dotnet/core\nUse 'dotnet --help' to see available commands or visit: https://aka.ms/dotnet-cli\n--------------------------------------------------------------------------------------\nMSBuild version 17.8.5+b5265ef37 for .NET\n  Determining projects to restore...\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharpEditor/GodotSharpEditor.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotPlugins/GodotPlugins.csproj (in 419 ms).\n  Restored /home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj (in 4.05 sec).\n  Godot.SourceGenerators.Internal -> /home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/bin/Debug/netstandard2.0/Godot.SourceGenerators.Internal.dll\nCSC : warning CS9057: The analyzer assembly '/home/akien/Godot/godot/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/bin/Debug/netstandard2.0/Godot.SourceGenerators.Internal.dll' references version '4.9.0.0' of the compiler, which is newer than the currently running version '4.8.0.0'. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(7,13): error CS0234: The type or namespace name 'SourceGenerators' does not exist in the namespace 'Godot' (are you missing an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(18,6): error CS0246: The type or namespace name 'GenerateUnmanagedCallbacksAttribute' could not be found (are you missing a using directive or an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(18,6): error CS0246: The type or namespace name 'GenerateUnmanagedCallbacks' could not be found (are you missing a using directive or an assembly reference?) [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(185,36): error CS8795: Partial method 'NativeFuncs.godotsharp_variant_new_copy(out godot_variant, scoped in godot_variant)' must have an implementation part because it has accessibility modifiers. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/Core/NativeInterop/NativeFuncs.cs(319,36): error CS8795: Partial method 'NativeFuncs.godotsharp_string_name_new_copy(out godot_string_name, scoped in godot_string_name)' must have an implementation part because it has accessibility modifiers. [/home/akien/Godot/godot/modules/mono/glue/GodotSharp/GodotSharp/GodotSharp.csproj]\n```\netc.\n\nFull error log:\n[godotsharp-errors.txt](https://github.com/user-attachments/files/18163050/godotsharp-errors.txt)\n\nThis appears to be a recent regression, possibly from #92131?\n\n<details>\n<summary>dotnet --info</summary>\n\n```\n.NET SDK:\n Version:           8.0.111\n Commit:            ad116b5ce0\n Workload version:  8.0.100-manifests.7198dcc9\n\nRuntime Environment:\n OS Name:     fedora\n OS Version:  41\n OS Platform: Linux\n RID:         fedora.41-x64\n Base Path:   /usr/lib64/dotnet/sdk/8.0.111/\n\n.NET workloads installed:\n Workload version: 8.0.100-manifests.7198dcc9\nThere are no installed workloads to display.\n\nHost:\n  Version:      8.0.11\n  Architecture: x64\n  Commit:       9cb3b725e3\n\n.NET SDKs installed:\n  8.0.111 [/usr/lib64/dotnet/sdk]\n\n.NET runtimes installed:\n  Microsoft.AspNetCore.App 8.0.11 [/usr/lib64/dotnet/shared/Microsoft.AspNetCore.App]\n  Microsoft.NETCore.App 8.0.11 [/usr/lib64/dotnet/shared/Microsoft.NETCore.App]\n\nOther architectures found:\n  None\n\nEnvironment variables:\n  DOTNET_ROOT       [/usr/lib64/dotnet]\n\nglobal.json file:\n  Not found\n\nLearn more:\n  https://aka.ms/dotnet/info\n\nDownload .NET:\n  https://aka.ms/dotnet/download\n```\n\n</details>\n\n### Steps to reproduce\n\n```\nscons module_mono_enabled=yes\n./bin/godot.blabla --generate-mono-glue modules/mono/glue\n./modules/mono/build_scripts/build_assemblies.py --godot-output-dir ./bin\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/.github/workflows/linux_builds.yml b/.github/workflows/linux_builds.yml\nindex 193942a1bb3a..6b786a7b5849 100644\n--- a/.github/workflows/linux_builds.yml\n+++ b/.github/workflows/linux_builds.yml\n@@ -140,6 +140,18 @@ jobs:\n           python-version: 3.8\n           scons-version: 4.0\n \n+      - name: Force remove preinstalled .NET SDKs\n+        if: matrix.build-mono\n+        run: |\n+          sudo rm -rf /usr/share/dotnet/sdk/*\n+\n+      - name: Setup older .NET SDK as baseline\n+        if: matrix.build-mono\n+        uses: actions/setup-dotnet@v4\n+        with:\n+          # Targeting the oldest version we want to support to ensure it still builds.\n+          dotnet-version: '8.0.100'\n+\n       - name: Compilation\n         uses: ./.github/actions/godot-build\n         with:\n@@ -163,6 +175,7 @@ jobs:\n       - name: Build .NET solutions\n         if: matrix.build-mono\n         run: |\n+          dotnet --info\n           ./modules/mono/build_scripts/build_assemblies.py --godot-output-dir=./bin --godot-platform=linuxbsd\n \n       - name: Prepare artifact\ndiff --git a/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj b/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\nindex ee607ff279e2..d291199ad04d 100644\n--- a/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\n+++ b/modules/mono/glue/GodotSharp/Godot.SourceGenerators.Internal/Godot.SourceGenerators.Internal.csproj\n@@ -8,7 +8,7 @@\n   </PropertyGroup>\n \n   <ItemGroup>\n-    <PackageReference Include=\"Microsoft.CodeAnalysis.CSharp\" Version=\"4.9.2\" PrivateAssets=\"all\" />\n+    <PackageReference Include=\"Microsoft.CodeAnalysis.CSharp\" Version=\"4.8.0\" PrivateAssets=\"all\" />\n     <PackageReference Include=\"Microsoft.CodeAnalysis.Analyzers\" Version=\"3.3.4\" PrivateAssets=\"all\" />\n   </ItemGroup>\n \n", "instance_id": "godotengine__godot-100506", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue encountered when building GodotSharp assemblies in the current master branch of the Godot engine. It includes specific error messages, system information (Fedora 41, .NET 8.0.111), steps to reproduce the issue, and a reference to a potential cause (a recent pull request #92131). The goal is implicitly clear: resolve the build errors for GodotSharp. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected outcome beyond \"fixing the build,\" nor does it specify constraints or requirements for the solution (e.g., compatibility with specific .NET versions). Additionally, edge cases or specific scenarios leading to the errors are not detailed beyond the provided logs. While the reproduction steps are provided, they lack context for someone unfamiliar with the Godot build process. Overall, the statement is valid and mostly clear but misses some minor details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily involving a downgrade of the Microsoft.CodeAnalysis.CSharp package version from 4.9.2 to 4.8.0 in a single project file and adjustments to the CI workflow to use an older .NET SDK version (8.0.100). These changes are not extensive in terms of lines of code but require understanding the specific cause of the build failure, which is a version mismatch between the analyzer assembly and the running compiler version as indicated in the error logs. Second, the technical concepts involved include familiarity with .NET SDK versioning, MSBuild, and source generators in the context of GodotSharp, which are moderately complex and require domain-specific knowledge of the Godot engine's Mono module and its build system. Third, the problem impacts a specific part of the codebase (GodotSharp assemblies) but does not appear to affect the broader system architecture significantly. Finally, while the problem statement and logs highlight specific errors (e.g., missing namespaces and partial method implementation issues), there is no explicit mention of complex edge cases or extensive error handling requirements beyond resolving the version incompatibility. However, diagnosing and confirming the root cause (version mismatch) and ensuring compatibility across different environments adds a layer of complexity. Overall, this problem requires understanding multiple concepts and making targeted but non-trivial modifications, placing it in the medium difficulty range at 0.55.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "test: 32-bit Clang `ipc_test` failure at `-O0`\nNoticed as part of this branch #29796, however it can also be reproduced with master (8fa10edcd1706a1f0dc9d8c3adbc8efa3c7755bf) by reproducing the equivalent CI & setting C(XX)FLAGS to -O0:\n```bash\nmake -C depends/ MULTIPROCESS=1 NO_QT=1 NO_WALLET=1 NO_ZMQ=1 NO_USDT=1 CFLAGS=\"-O0\" CXXFLAGS=\"-O0\" DEBUG=1 -j19 HOST=i686-pc-linux-gnu\ncmake -B build --toolchain /root/ci_scratch/depends/i686-pc-linux-gnu/toolchain.cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_COMPILER='clang;-m32' -DCMAKE_CXX_COMPILER='clang++;-m32'\ncmake --build build -j18\n```\n\n```bash\n./build/src/test/test_bitcoin --run_test=ipc*\nRunning 2 test cases...\nterminate called after throwing an instance of 'kj::ExceptionImpl'\n  what():  /root/ci_scratch/depends/i686-pc-linux-gnu/include/kj/common.h:1797: failed: expected start <= end && end <= size_; Out-of-bounds ArrayPtr::slice().\nstack: 5ca0dd6d 5c78b5db 5c8cc599 5ca0adc9 5c94fb37 5c950070 5c9cd709 5c9cf58a 5c9d72fd 5c9d025e 5c776f11 5bf6351d 5bf6347d 5bf633cd 5bf6337b 5bf6331d 5bf63194 f7afa4b0 f773dff6 f77d55b7\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\n    ??:0: returning here\nunknown location(0): fatal error: in \"ipc_tests/ipc_tests\": signal: SIGABRT (application abort requested)\ntest/ipc_tests.cpp(12): last checkpoint: \"ipc_tests\" test entry\ntest_bitcoin: common/args.cpp:578: void ArgsManager::AddArg(const std::string &, const std::string &, unsigned int, const OptionsCategory &): Assertion `ret.second' failed.\nunknown location(0): fatal error: in \"ipc_tests/parse_address_test\": signal: SIGABRT (application abort requested)\ntest/ipc_tests.cpp(20): last checkpoint: \"parse_address_test\" fixture ctor\n\n*** 2 failures are detected in the test module \"Bitcoin Core Test Suite\"\n```\n", "patch": "diff --git a/depends/packages/capnp.mk b/depends/packages/capnp.mk\nindex 7f41d3b5a4ed3..dff92d9e61fe8 100644\n--- a/depends/packages/capnp.mk\n+++ b/depends/packages/capnp.mk\n@@ -4,6 +4,7 @@ $(package)_download_path=$(native_$(package)_download_path)\n $(package)_download_file=$(native_$(package)_download_file)\n $(package)_file_name=$(native_$(package)_file_name)\n $(package)_sha256_hash=$(native_$(package)_sha256_hash)\n+$(package)_patches=abi_placement_new.patch\n \n define $(package)_set_vars :=\n   $(package)_config_opts := -DBUILD_TESTING=OFF\n@@ -12,6 +13,10 @@ define $(package)_set_vars :=\n   $(package)_cxxflags += -fdebug-prefix-map=$($(package)_extract_dir)=/usr -fmacro-prefix-map=$($(package)_extract_dir)=/usr\n endef\n \n+define $(package)_preprocess_cmds\n+  patch -p2 < $($(package)_patch_dir)/abi_placement_new.patch\n+endef\n+\n define $(package)_config_cmds\n   $($(package)_cmake) .\n endef\ndiff --git a/depends/patches/capnp/abi_placement_new.patch b/depends/patches/capnp/abi_placement_new.patch\nnew file mode 100644\nindex 0000000000000..9aef85db8e86b\n--- /dev/null\n+++ b/depends/patches/capnp/abi_placement_new.patch\n@@ -0,0 +1,71 @@\n+From 74560f26f75dda4257dce541ca362a1e763b2971 Mon Sep 17 00:00:00 2001\n+From: Ryan Ofsky <ryan@ofsky.org>\n+Date: Thu, 6 Feb 2025 08:39:05 -0500\n+Subject: [PATCH 1/1] Avoid gcc/clang ABI incompatibility caused by\n+ PlacementNew\n+\n+GCC and clang do not use same calling convention for passing empty struct\n+parameters. There is more information about this in\n+https://itanium-cxx-abi.github.io/cxx-abi/cxx-abi-dev/archives/2015-December/002869.html\n+\n+Unfortunately this can create an issue in capnproto if it is built without\n+optimizations in GCC, and the resulting static libraries are used in a clang\n+program, or vice versa.\n+\n+Depending on what order libraries are specified on the linker command line, and\n+whether code compiled with the other compiler is calling any header functions\n+that cause weak a `operator new(unsigned int, kj::_::PlacementNew, void*)`\n+symbol to be defined in its own objects, this can cause the linker to link a\n+GCC-generated `kj::ctor` with a clang-generated `operator new`, and the\n+resulting program to crash due to the compilers using different calling\n+conventions for `operator new`.\n+\n+This problem is difficult to avoid in general, but pretty easy to avoid here by\n+changing `operator new` parameter order so the empty struct parameter is last.\n+\n+This change should be beneficial for capnproto users that may be compiling it\n+without optimizations, and not necessarily using a single compiler to build all\n+their dependencies.\n+\n+The problem does not occur if any optimizations are enabled because `operator\n+new` calls are inlined in that case.\n+---\n+ c++/src/kj/common.h | 11 +++++++----\n+ 1 file changed, 7 insertions(+), 4 deletions(-)\n+\n+diff --git a/c++/src/kj/common.h b/c++/src/kj/common.h\n+index b8edde3c..28ab11d6 100644\n+--- a/c++/src/kj/common.h\n++++ b/c++/src/kj/common.h\n+@@ -1034,24 +1034,27 @@ private:\n+ \n+ // We want placement new, but we don't want to #include <new>.  operator new cannot be defined in\n+ // a namespace, and defining it globally conflicts with the definition in <new>.  So we have to\n+-// define a dummy type and an operator new that uses it.\n++// define a dummy type and an operator new that uses it.  The dummy type is intentionally passed\n++// as the last parameter so clang and GCC ABI calling conventions for empty struct struct parameters\n++// are compatible, and there are not segfaults trying to call clang operator new/delete from GCC or\n++// vice versa.\n+ \n+ namespace _ {  // private\n+ struct PlacementNew {};\n+ }  // namespace _ (private)\n+ } // namespace kj\n+ \n+-inline void* operator new(size_t, kj::_::PlacementNew, void* __p) noexcept {\n++inline void* operator new(size_t, void* __p, kj::_::PlacementNew) noexcept {\n+   return __p;\n+ }\n+ \n+-inline void operator delete(void*, kj::_::PlacementNew, void* __p) noexcept {}\n++inline void operator delete(void*, void* __p, kj::_::PlacementNew) noexcept {}\n+ \n+ namespace kj {\n+ \n+ template <typename T, typename... Params>\n+ inline void ctor(T& location, Params&&... params) {\n+-  new (_::PlacementNew(), &location) T(kj::fwd<Params>(params)...);\n++  new (&location, _::PlacementNew()) T(kj::fwd<Params>(params)...);\n+ }\n+ \n+ template <typename T>\n", "instance_id": "bitcoin__bitcoin-31998", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a failure in the `ipc_test` when compiled with Clang at optimization level `-O0` on a 32-bit system. It provides specific steps to reproduce the issue, including build commands and the resulting error output, which is helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or the root cause in a concise manner (though the code changes hint at an ABI incompatibility between GCC and Clang). Additionally, it lacks explicit mention of edge cases or constraints beyond the specific build configuration. While the reproduction steps are detailed, the goal of the fix (beyond resolving the crash) and the broader impact are not fully articulated. Hence, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem is rated as Hard (0.75) due to several factors across the evaluation criteria:\n\n1. **Clarity and Complexity of the Problem Description**: While the reproduction steps are clear, understanding the root cause (ABI incompatibility between GCC and Clang for empty struct parameters) requires deep knowledge of compiler behavior and calling conventions. This adds to the inherent complexity of the problem.\n\n2. **Scope and Depth of Code Changes**: The code changes are relatively localized, primarily involving a patch to the `capnp` library's `common.h` file to reorder parameters in a placement new operator to avoid ABI issues. Additionally, there are modifications to the build configuration in `capnp.mk` to apply the patch. While the changes are not extensive in terms of lines of code, they require understanding the interaction between the `capnp` library and the broader Bitcoin Core test suite, as well as the build system (CMake and makefiles). The impact is significant because it affects a third-party dependency used in a critical test suite, potentially influencing other parts of the system if not handled carefully.\n\n3. **Number of Technical Concepts**: Solving this problem demands advanced knowledge of several complex concepts:\n   - Compiler-specific behavior (GCC vs. Clang ABI differences for empty structs).\n   - C++ language intricacies, such as placement new and operator overloading.\n   - Build system modifications (patching dependencies in a `depends/` system).\n   - Low-level debugging of crashes (interpreting stack traces and error messages like `Out-of-bounds ArrayPtr::slice()`).\n   - Cross-compiler compatibility issues, especially in a 32-bit environment with optimization disabled (`-O0`).\n   These concepts are non-trivial and require significant experience to navigate effectively.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases beyond the specific build configuration (`-O0`, 32-bit, Clang). However, the nature of the fix (ABI compatibility) implies potential risks in other build configurations or compiler combinations. The code change itself does not introduce new error handling but addresses a fundamental compatibility issue that could manifest as crashes in various scenarios. Understanding and verifying the fix's correctness across different environments adds to the difficulty.\n\nOverall, this problem is rated as Hard (0.75) because it requires a deep understanding of compiler internals, C++ nuances, and build systems, even though the code changes are relatively small. It falls short of Very Hard (0.8-1.0) because it does not involve extensive architectural changes or system-level redesigns, but it is still a challenging issue that demands specialized knowledge and careful validation.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "log/dump more information if a CheckQueue failure occurs\nI recently saw this on a node running master (90a5786bba4baac1c0270e1f4bf5bb8c790e10de iirc):\r\n```bash\r\n2024-09-23T13:12:14Z UpdateTip: new best=00000000000000000000d3ebbca24c44745cfa14153e758d29af82275e00c00f height=862523 version=0x20026000 log2_work=95.170324 tx=1084781037 date='2024-09-23T13:03:46Z' progress=0.999997 cache=302.1MiB(2120379txo)\r\n2024-09-23T13:12:14Z UpdateTip: new best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267 height=862524 version=0x20150000 log2_work=95.170337 tx=1084782848 date='2024-09-23T13:05:37Z' progress=0.999998 cache=302.4MiB(2117708txo)\r\n2024-09-23T13:12:15Z New outbound-full-relay v1 peer connected: version: 70016, blocks=862524, peer=25\r\n2024-09-23T13:13:09Z Saw new header hash=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 height=862525\r\n2024-09-23T13:13:09Z Saw new cmpctblock header hash=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 peer=1\r\n2024-09-23T13:13:10Z ERROR: ConnectBlock: CheckQueue failed\r\n2024-09-23T13:13:10Z InvalidChainFound: invalid block=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084  height=862525  log2_work=95.170350  date=2024-09-23T13:12:13Z\r\n2024-09-23T13:13:10Z InvalidChainFound:  current best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267  height=862524  log2_work=95.170337  date=2024-09-23T13:05:37Z\r\n2024-09-23T13:13:10Z [error] ConnectTip: ConnectBlock 00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 failed, block-validation-failed\r\n2024-09-23T13:13:10Z InvalidChainFound: invalid block=00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084  height=862525  log2_work=95.170350  date=2024-09-23T13:12:13Z\r\n2024-09-23T13:13:10Z InvalidChainFound:  current best=0000000000000000000164dcfef37624f2cc6b177032bbca57631285c2cd0267  height=862524  log2_work=95.170337  date=2024-09-23T13:05:37Z\r\n2024-09-23T13:13:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862525, peer=27\r\n2024-09-23T13:13:23Z New outbound-full-relay v1 peer connected: version: 70016, blocks=862525, peer=28\r\n```\r\n\r\nIn this case it was possible to restart the node with `-par=1`, to output the actual failure:\r\n```bash\r\n2024-09-23T14:19:04Z [error] ConnectTip: ConnectBlock 00000000000000000000f9892b8210cc52b3f71c1f37ffcfcecc2dab746b6084 failed, mandatory-script-verify-flag-failed (Script evaluated without error but finished with a false/empty top stack element)\r\n```\r\n\r\nHowever it would also be useful to get that information in either case. The cause of the `ConnectBlock` failure here has currently been put down to hardware.\n", "patch": "diff --git a/src/bench/checkqueue.cpp b/src/bench/checkqueue.cpp\nindex d1454f3634d63..8134154eb112b 100644\n--- a/src/bench/checkqueue.cpp\n+++ b/src/bench/checkqueue.cpp\n@@ -34,9 +34,9 @@ static void CCheckQueueSpeedPrevectorJob(benchmark::Bench& bench)\n         explicit PrevectorJob(FastRandomContext& insecure_rand){\n             p.resize(insecure_rand.randrange(PREVECTOR_SIZE*2));\n         }\n-        bool operator()()\n+        std::optional<int> operator()()\n         {\n-            return true;\n+            return std::nullopt;\n         }\n     };\n \n@@ -62,7 +62,7 @@ static void CCheckQueueSpeedPrevectorJob(benchmark::Bench& bench)\n         }\n         // control waits for completion by RAII, but\n         // it is done explicitly here for clarity\n-        control.Wait();\n+        control.Complete();\n     });\n }\n BENCHMARK(CCheckQueueSpeedPrevectorJob, benchmark::PriorityLevel::HIGH);\ndiff --git a/src/checkqueue.h b/src/checkqueue.h\nindex a1de000714d59..be41bf8bac71d 100644\n--- a/src/checkqueue.h\n+++ b/src/checkqueue.h\n@@ -11,19 +11,24 @@\n \n #include <algorithm>\n #include <iterator>\n+#include <optional>\n #include <vector>\n \n /**\n  * Queue for verifications that have to be performed.\n   * The verifications are represented by a type T, which must provide an\n-  * operator(), returning a bool.\n+  * operator(), returning an std::optional<R>.\n+  *\n+  * The overall result of the computation is std::nullopt if all invocations\n+  * return std::nullopt, or one of the other results otherwise.\n   *\n   * One thread (the master) is assumed to push batches of verifications\n   * onto the queue, where they are processed by N-1 worker threads. When\n   * the master is done adding work, it temporarily joins the worker pool\n   * as an N'th worker, until all jobs are done.\n+  *\n   */\n-template <typename T>\n+template <typename T, typename R = std::remove_cvref_t<decltype(std::declval<T>()().value())>>\n class CCheckQueue\n {\n private:\n@@ -47,7 +52,7 @@ class CCheckQueue\n     int nTotal GUARDED_BY(m_mutex){0};\n \n     //! The temporary evaluation result.\n-    bool fAllOk GUARDED_BY(m_mutex){true};\n+    std::optional<R> m_result GUARDED_BY(m_mutex);\n \n     /**\n      * Number of verifications that haven't completed yet.\n@@ -62,24 +67,28 @@ class CCheckQueue\n     std::vector<std::thread> m_worker_threads;\n     bool m_request_stop GUARDED_BY(m_mutex){false};\n \n-    /** Internal function that does bulk of the verification work. */\n-    bool Loop(bool fMaster) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    /** Internal function that does bulk of the verification work. If fMaster, return the final result. */\n+    std::optional<R> Loop(bool fMaster) EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n     {\n         std::condition_variable& cond = fMaster ? m_master_cv : m_worker_cv;\n         std::vector<T> vChecks;\n         vChecks.reserve(nBatchSize);\n         unsigned int nNow = 0;\n-        bool fOk = true;\n+        std::optional<R> local_result;\n+        bool do_work;\n         do {\n             {\n                 WAIT_LOCK(m_mutex, lock);\n                 // first do the clean-up of the previous loop run (allowing us to do it in the same critsect)\n                 if (nNow) {\n-                    fAllOk &= fOk;\n+                    if (local_result.has_value() && !m_result.has_value()) {\n+                        std::swap(local_result, m_result);\n+                    }\n                     nTodo -= nNow;\n-                    if (nTodo == 0 && !fMaster)\n+                    if (nTodo == 0 && !fMaster) {\n                         // We processed the last element; inform the master it can exit and return the result\n                         m_master_cv.notify_one();\n+                    }\n                 } else {\n                     // first iteration\n                     nTotal++;\n@@ -88,18 +97,19 @@ class CCheckQueue\n                 while (queue.empty() && !m_request_stop) {\n                     if (fMaster && nTodo == 0) {\n                         nTotal--;\n-                        bool fRet = fAllOk;\n+                        std::optional<R> to_return = std::move(m_result);\n                         // reset the status for new work later\n-                        fAllOk = true;\n+                        m_result = std::nullopt;\n                         // return the current status\n-                        return fRet;\n+                        return to_return;\n                     }\n                     nIdle++;\n                     cond.wait(lock); // wait\n                     nIdle--;\n                 }\n                 if (m_request_stop) {\n-                    return false;\n+                    // return value does not matter, because m_request_stop is only set in the destructor.\n+                    return std::nullopt;\n                 }\n \n                 // Decide how many work units to process now.\n@@ -112,12 +122,15 @@ class CCheckQueue\n                 vChecks.assign(std::make_move_iterator(start_it), std::make_move_iterator(queue.end()));\n                 queue.erase(start_it, queue.end());\n                 // Check whether we need to do work at all\n-                fOk = fAllOk;\n+                do_work = !m_result.has_value();\n             }\n             // execute work\n-            for (T& check : vChecks)\n-                if (fOk)\n-                    fOk = check();\n+            if (do_work) {\n+                for (T& check : vChecks) {\n+                    local_result = check();\n+                    if (local_result.has_value()) break;\n+                }\n+            }\n             vChecks.clear();\n         } while (true);\n     }\n@@ -146,8 +159,9 @@ class CCheckQueue\n     CCheckQueue(CCheckQueue&&) = delete;\n     CCheckQueue& operator=(CCheckQueue&&) = delete;\n \n-    //! Wait until execution finishes, and return whether all evaluations were successful.\n-    bool Wait() EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n+    //! Join the execution until completion. If at least one evaluation wasn't successful, return\n+    //! its error.\n+    std::optional<R> Complete() EXCLUSIVE_LOCKS_REQUIRED(!m_mutex)\n     {\n         return Loop(true /* master thread */);\n     }\n@@ -188,11 +202,11 @@ class CCheckQueue\n  * RAII-style controller object for a CCheckQueue that guarantees the passed\n  * queue is finished before continuing.\n  */\n-template <typename T>\n+template <typename T, typename R = std::remove_cvref_t<decltype(std::declval<T>()().value())>>\n class CCheckQueueControl\n {\n private:\n-    CCheckQueue<T> * const pqueue;\n+    CCheckQueue<T, R> * const pqueue;\n     bool fDone;\n \n public:\n@@ -207,13 +221,12 @@ class CCheckQueueControl\n         }\n     }\n \n-    bool Wait()\n+    std::optional<R> Complete()\n     {\n-        if (pqueue == nullptr)\n-            return true;\n-        bool fRet = pqueue->Wait();\n+        if (pqueue == nullptr) return std::nullopt;\n+        auto ret = pqueue->Complete();\n         fDone = true;\n-        return fRet;\n+        return ret;\n     }\n \n     void Add(std::vector<T>&& vChecks)\n@@ -226,7 +239,7 @@ class CCheckQueueControl\n     ~CCheckQueueControl()\n     {\n         if (!fDone)\n-            Wait();\n+            Complete();\n         if (pqueue != nullptr) {\n             LEAVE_CRITICAL_SECTION(pqueue->m_control_mutex);\n         }\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex 95f3bc58d7d82..1cc4259919452 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2103,10 +2103,16 @@ void UpdateCoins(const CTransaction& tx, CCoinsViewCache& inputs, CTxUndo &txund\n     AddCoins(inputs, tx, nHeight);\n }\n \n-bool CScriptCheck::operator()() {\n+std::optional<std::pair<ScriptError, std::string>> CScriptCheck::operator()() {\n     const CScript &scriptSig = ptxTo->vin[nIn].scriptSig;\n     const CScriptWitness *witness = &ptxTo->vin[nIn].scriptWitness;\n-    return VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *m_signature_cache, *txdata), &error);\n+    ScriptError error{SCRIPT_ERR_UNKNOWN_ERROR};\n+    if (VerifyScript(scriptSig, m_tx_out.scriptPubKey, witness, nFlags, CachingTransactionSignatureChecker(ptxTo, nIn, m_tx_out.nValue, cacheStore, *m_signature_cache, *txdata), &error)) {\n+        return std::nullopt;\n+    } else {\n+        auto debug_str = strprintf(\"input %i of %s (wtxid %s), spending %s:%i\", nIn, ptxTo->GetHash().ToString(), ptxTo->GetWitnessHash().ToString(), ptxTo->vin[nIn].prevout.hash.ToString(), ptxTo->vin[nIn].prevout.n);\n+        return std::make_pair(error, std::move(debug_str));\n+    }\n }\n \n ValidationCache::ValidationCache(const size_t script_execution_cache_bytes, const size_t signature_cache_bytes)\n@@ -2195,9 +2201,7 @@ bool CheckInputScripts(const CTransaction& tx, TxValidationState& state,\n         CScriptCheck check(txdata.m_spent_outputs[i], tx, validation_cache.m_signature_cache, i, flags, cacheSigStore, &txdata);\n         if (pvChecks) {\n             pvChecks->emplace_back(std::move(check));\n-        } else if (!check()) {\n-            ScriptError error{check.GetScriptError()};\n-\n+        } else if (auto result = check(); result.has_value()) {\n             if (flags & STANDARD_NOT_MANDATORY_VERIFY_FLAGS) {\n                 // Check whether the failure was caused by a\n                 // non-mandatory script verification check, such as\n@@ -2209,21 +2213,23 @@ bool CheckInputScripts(const CTransaction& tx, TxValidationState& state,\n                 // data providers.\n                 CScriptCheck check2(txdata.m_spent_outputs[i], tx, validation_cache.m_signature_cache, i,\n                         flags & ~STANDARD_NOT_MANDATORY_VERIFY_FLAGS, cacheSigStore, &txdata);\n-                if (check2())\n-                    return state.Invalid(TxValidationResult::TX_NOT_STANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(check.GetScriptError())));\n-\n-                // If the second check failed, it failed due to a mandatory script verification\n-                // flag, but the first check might have failed on a non-mandatory script\n-                // verification flag.\n-                //\n-                // Avoid reporting a mandatory script check failure with a non-mandatory error\n-                // string by reporting the error from the second check.\n-                error = check2.GetScriptError();\n+                auto mandatory_result = check2();\n+                if (!mandatory_result.has_value()) {\n+                    return state.Invalid(TxValidationResult::TX_NOT_STANDARD, strprintf(\"non-mandatory-script-verify-flag (%s)\", ScriptErrorString(result->first)), result->second);\n+                } else {\n+                    // If the second check failed, it failed due to a mandatory script verification\n+                    // flag, but the first check might have failed on a non-mandatory script\n+                    // verification flag.\n+                    //\n+                    // Avoid reporting a mandatory script check failure with a non-mandatory error\n+                    // string by reporting the error from the second check.\n+                    result = mandatory_result;\n+                }\n             }\n \n             // MANDATORY flag failures correspond to\n             // TxValidationResult::TX_CONSENSUS.\n-            return state.Invalid(TxValidationResult::TX_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(error)));\n+            return state.Invalid(TxValidationResult::TX_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(result->first)), result->second);\n         }\n     }\n \n@@ -2589,8 +2595,8 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n         for (const auto& tx : block.vtx) {\n             for (size_t o = 0; o < tx->vout.size(); o++) {\n                 if (view.HaveCoin(COutPoint(tx->GetHash(), o))) {\n-                    LogPrintf(\"ERROR: ConnectBlock(): tried to overwrite transaction\\n\");\n-                    return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-BIP30\");\n+                    state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-BIP30\",\n+                                  \"tried to overwrite transaction\");\n                 }\n             }\n         }\n@@ -2629,6 +2635,7 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n     blockundo.vtxundo.reserve(block.vtx.size() - 1);\n     for (unsigned int i = 0; i < block.vtx.size(); i++)\n     {\n+        if (!state.IsValid()) break;\n         const CTransaction &tx = *(block.vtx[i]);\n \n         nInputs += tx.vin.size();\n@@ -2640,14 +2647,15 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n             if (!Consensus::CheckTxInputs(tx, tx_state, view, pindex->nHeight, txfee)) {\n                 // Any transaction validation failure in ConnectBlock is a block consensus failure\n                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,\n-                            tx_state.GetRejectReason(), tx_state.GetDebugMessage());\n-                LogError(\"%s: Consensus::CheckTxInputs: %s, %s\\n\", __func__, tx.GetHash().ToString(), state.ToString());\n-                return false;\n+                              tx_state.GetRejectReason(),\n+                              tx_state.GetDebugMessage() + \" in transaction \" + tx.GetHash().ToString());\n+                break;\n             }\n             nFees += txfee;\n             if (!MoneyRange(nFees)) {\n-                LogPrintf(\"ERROR: %s: accumulated fee in the block out of range.\\n\", __func__);\n-                return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-accumulated-fee-outofrange\");\n+                state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-accumulated-fee-outofrange\",\n+                              \"accumulated fee in the block out of range\");\n+                break;\n             }\n \n             // Check that transaction is BIP68 final\n@@ -2659,8 +2667,9 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n             }\n \n             if (!SequenceLocks(tx, nLockTimeFlags, prevheights, *pindex)) {\n-                LogPrintf(\"ERROR: %s: contains a non-BIP68-final transaction\\n\", __func__);\n-                return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-nonfinal\");\n+                state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-txns-nonfinal\",\n+                              \"contains a non-BIP68-final transaction \" + tx.GetHash().ToString());\n+                break;\n             }\n         }\n \n@@ -2670,8 +2679,8 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n         // * witness (when witness enabled in flags and excludes coinbase)\n         nSigOpsCost += GetTransactionSigOpCost(tx, view, flags);\n         if (nSigOpsCost > MAX_BLOCK_SIGOPS_COST) {\n-            LogPrintf(\"ERROR: ConnectBlock(): too many sigops\\n\");\n-            return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-blk-sigops\");\n+            state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-blk-sigops\", \"too many sigops\");\n+            break;\n         }\n \n         if (!tx.IsCoinBase())\n@@ -2683,9 +2692,7 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n                 // Any transaction validation failure in ConnectBlock is a block consensus failure\n                 state.Invalid(BlockValidationResult::BLOCK_CONSENSUS,\n                               tx_state.GetRejectReason(), tx_state.GetDebugMessage());\n-                LogError(\"ConnectBlock(): CheckInputScripts on %s failed with %s\\n\",\n-                    tx.GetHash().ToString(), state.ToString());\n-                return false;\n+                break;\n             }\n             control.Add(std::move(vChecks));\n         }\n@@ -2705,14 +2712,18 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n              Ticks<MillisecondsDouble>(m_chainman.time_connect) / m_chainman.num_blocks_total);\n \n     CAmount blockReward = nFees + GetBlockSubsidy(pindex->nHeight, params.GetConsensus());\n-    if (block.vtx[0]->GetValueOut() > blockReward) {\n-        LogPrintf(\"ERROR: ConnectBlock(): coinbase pays too much (actual=%d vs limit=%d)\\n\", block.vtx[0]->GetValueOut(), blockReward);\n-        return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-cb-amount\");\n+    if (block.vtx[0]->GetValueOut() > blockReward && state.IsValid()) {\n+        state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"bad-cb-amount\",\n+                      strprintf(\"coinbase pays too much (actual=%d vs limit=%d)\", block.vtx[0]->GetValueOut(), blockReward));\n     }\n \n-    if (!control.Wait()) {\n-        LogPrintf(\"ERROR: %s: CheckQueue failed\\n\", __func__);\n-        return state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, \"block-validation-failed\");\n+    auto parallel_result = control.Complete();\n+    if (parallel_result.has_value() && state.IsValid()) {\n+        state.Invalid(BlockValidationResult::BLOCK_CONSENSUS, strprintf(\"mandatory-script-verify-flag-failed (%s)\", ScriptErrorString(parallel_result->first)), parallel_result->second);\n+    }\n+    if (!state.IsValid()) {\n+        LogInfo(\"Block validation error: %s\", state.ToString());\n+        return false;\n     }\n     const auto time_4{SteadyClock::now()};\n     m_chainman.time_verify += time_4 - time_2;\n@@ -2722,8 +2733,9 @@ bool Chainstate::ConnectBlock(const CBlock& block, BlockValidationState& state,\n              Ticks<SecondsDouble>(m_chainman.time_verify),\n              Ticks<MillisecondsDouble>(m_chainman.time_verify) / m_chainman.num_blocks_total);\n \n-    if (fJustCheck)\n+    if (fJustCheck) {\n         return true;\n+    }\n \n     if (!m_blockman.WriteUndoDataForBlock(blockundo, state, *pindex)) {\n         return false;\ndiff --git a/src/validation.h b/src/validation.h\nindex 723babca31568..6b67dc485b837 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -335,7 +335,6 @@ class CScriptCheck\n     unsigned int nIn;\n     unsigned int nFlags;\n     bool cacheStore;\n-    ScriptError error{SCRIPT_ERR_UNKNOWN_ERROR};\n     PrecomputedTransactionData *txdata;\n     SignatureCache* m_signature_cache;\n \n@@ -348,9 +347,7 @@ class CScriptCheck\n     CScriptCheck(CScriptCheck&&) = default;\n     CScriptCheck& operator=(CScriptCheck&&) = default;\n \n-    bool operator()();\n-\n-    ScriptError GetScriptError() const { return error; }\n+    std::optional<std::pair<ScriptError, std::string>> operator()();\n };\n \n // CScriptCheck is used a lot in std::vector, make sure that's efficient\n", "instance_id": "bitcoin__bitcoin-31112", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in its intent to enhance logging for `CheckQueue` failures during block validation, as seen in the provided log output and the suggestion to include detailed error information without requiring a node restart with specific parameters. The goal is evident: to log more detailed information about the cause of a `ConnectBlock` failure. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the exact format or content of the additional information to be logged beyond the example of a script verification failure. It also lacks clarity on whether this logging should cover all possible failure modes or just specific ones like script verification. Additionally, constraints or performance considerations for logging (e.g., impact on node operation or log size) are not mentioned. Despite these minor gaps, the intent and context are sufficiently clear with the provided logs and the reference to hardware issues as a potential cause.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files (`checkqueue.h`, `validation.cpp`, etc.) and requiring modifications to core components of a blockchain validation system, likely part of Bitcoin Core or a similar project. The changes involve altering the `CCheckQueue` class to support returning detailed error information via `std::optional`, which necessitates a deep understanding of the existing parallel processing and verification logic. Second, the technical concepts involved are moderately complex, including C++ template programming, mutex-based synchronization, and domain-specific knowledge of blockchain transaction validation (e.g., script verification, BIP68, BIP30). Third, the modifications impact critical system behavior—block validation—and require careful handling to avoid introducing bugs in a consensus-critical codebase. While edge cases are not extensively detailed in the problem statement, the code changes show attention to error handling (e.g., script verification errors with detailed debug strings), indicating a need to manage various failure modes. However, this is not at the \"Very Hard\" level (0.8-1.0) because it does not involve fundamental architectural redesign or advanced domain-specific algorithms; it is more about enhancing error reporting within an existing framework. Thus, a score of 0.65 reflects the need for deep codebase familiarity, careful implementation across multiple modules, and attention to error handling in a critical system.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Drag tab into new window lost all panels besides the first\n### Windows Terminal version\n\nPreview 1.23.10353.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nCreate two tabs. In the second one split the screen in two panels. Drag this second tab into a new window.\n\n### Expected Behavior\n\nThe new window will have both panels. Terminal 1.21.10351.0 works as expected.\n\n### Actual Behavior\n\nThe new window have only the terminal in the first panel. From the task explorer, the processes in the lost panels doesn't become detach, they are just killed. \n", "patch": "diff --git a/src/cascadia/LocalTests_TerminalApp/TabTests.cpp b/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\nindex 477e6dcf0ea..941d5fa06fe 100644\n--- a/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\n+++ b/src/cascadia/LocalTests_TerminalApp/TabTests.cpp\n@@ -287,7 +287,7 @@ namespace TerminalAppLocalTests\n             NewTabArgs args{ newTerminalArgs };\r\n             ActionAndArgs newTabAction{ ShortcutAction::NewTab, args };\r\n             // push the arg onto the front\r\n-            page->_startupActions.Append(newTabAction);\r\n+            page->_startupActions.push_back(std::move(newTabAction));\r\n             Log::Comment(L\"Added a single newTab action\");\r\n \r\n             auto app = ::winrt::Windows::UI::Xaml::Application::Current();\r\ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex b2ae698205a..69648929637 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -752,13 +752,11 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         if (const auto& realArgs = actionArgs.ActionArgs().try_as<ExecuteCommandlineArgs>())\r\n         {\r\n-            auto actions = winrt::single_threaded_vector<ActionAndArgs>(\r\n-                TerminalPage::ConvertExecuteCommandlineToActions(realArgs));\r\n-\r\n-            if (actions.Size() != 0)\r\n+            auto actions = ConvertExecuteCommandlineToActions(realArgs);\r\n+            if (!actions.empty())\r\n             {\r\n                 actionArgs.Handled(true);\r\n-                ProcessStartupActions(actions, false);\r\n+                ProcessStartupActions(std::move(actions), false);\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex 7604b4d7d56..7db179c9067 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -62,7 +62,6 @@ namespace winrt::TerminalApp::implementation\n     TerminalPage::TerminalPage(TerminalApp::WindowProperties properties, const TerminalApp::ContentManager& manager) :\n         _tabs{ winrt::single_threaded_observable_vector<TerminalApp::TabBase>() },\n         _mruTabs{ winrt::single_threaded_observable_vector<TerminalApp::TabBase>() },\n-        _startupActions{ winrt::single_threaded_vector<ActionAndArgs>() },\n         _manager{ manager },\n         _hostingHwnd{},\n         _WindowProperties{ std::move(properties) }\n@@ -297,7 +296,7 @@ namespace winrt::TerminalApp::implementation\n         // GH#12267: Don't forget about defterm handoff here. If we're being\n         // created for embedding, then _yea_, we don't need to handoff to an\n         // elevated window.\n-        if (!_startupActions || IsRunningElevated() || _shouldStartInboundListener || _startupActions.Size() == 0)\n+        if (_startupActions.empty() || IsRunningElevated() || _shouldStartInboundListener)\n         {\n             // there aren't startup actions, or we're elevated. In that case, go for it.\n             return false;\n@@ -375,7 +374,7 @@ namespace winrt::TerminalApp::implementation\n     // - <none>\n     void TerminalPage::HandoffToElevated(const CascadiaSettings& settings)\n     {\n-        if (!_startupActions)\n+        if (_startupActions.empty())\n         {\n             return;\n         }\n@@ -489,7 +488,7 @@ namespace winrt::TerminalApp::implementation\n         {\n             _startupState = StartupState::InStartup;\n \n-            ProcessStartupActions(_startupActions, true);\n+            ProcessStartupActions(std::move(_startupActions), true);\n \n             // If we were told that the COM server needs to be started to listen for incoming\n             // default application connections, start it now.\n@@ -546,80 +545,56 @@ namespace winrt::TerminalApp::implementation\n     //   nt -d .` from inside another directory to work as expected.\n     // Return Value:\n     // - <none>\n-    safe_void_coroutine TerminalPage::ProcessStartupActions(Windows::Foundation::Collections::IVector<ActionAndArgs> actions,\n-                                                            const bool initial,\n-                                                            const winrt::hstring cwd,\n-                                                            const winrt::hstring env)\n+    safe_void_coroutine TerminalPage::ProcessStartupActions(std::vector<ActionAndArgs> actions, const bool initial, const winrt::hstring cwd, const winrt::hstring env)\n     {\n-        auto weakThis{ get_weak() };\n-\n-        // Handle it on a subsequent pass of the UI thread.\n-        co_await wil::resume_foreground(Dispatcher(), CoreDispatcherPriority::Normal);\n+        const auto strong = get_strong();\n \n         // If the caller provided a CWD, \"switch\" to that directory, then switch\n-        // back once we're done. This looks weird though, because we have to set\n-        // up the scope_exit _first_. We'll release the scope_exit if we don't\n-        // actually need it.\n-\n+        // back once we're done.\n         auto originalVirtualCwd{ _WindowProperties.VirtualWorkingDirectory() };\n-        auto restoreCwd = wil::scope_exit([&originalVirtualCwd, this]() {\n-            // ignore errors, we'll just power on through. We'd rather do\n-            // something rather than fail silently if the directory doesn't\n-            // actually exist.\n-            _WindowProperties.VirtualWorkingDirectory(originalVirtualCwd);\n-        });\n-\n-        // Literally the same thing with env vars too\n         auto originalVirtualEnv{ _WindowProperties.VirtualEnvVars() };\n-        auto restoreEnv = wil::scope_exit([&originalVirtualEnv, this]() {\n-            _WindowProperties.VirtualEnvVars(originalVirtualEnv);\n+        auto restoreCwd = wil::scope_exit([&]() {\n+            if (!cwd.empty())\n+            {\n+                // ignore errors, we'll just power on through. We'd rather do\n+                // something rather than fail silently if the directory doesn't\n+                // actually exist.\n+                _WindowProperties.VirtualWorkingDirectory(originalVirtualCwd);\n+                _WindowProperties.VirtualEnvVars(originalVirtualEnv);\n+            }\n         });\n+        _WindowProperties.VirtualWorkingDirectory(cwd);\n+        _WindowProperties.VirtualEnvVars(env);\n \n-        if (cwd.empty())\n+        for (size_t i = 0; i < actions.size(); ++i)\n         {\n-            // We didn't actually need to change the virtual CWD, so we don't\n-            // need to restore it\n-            restoreCwd.release();\n-        }\n-        else\n-        {\n-            _WindowProperties.VirtualWorkingDirectory(cwd);\n-        }\n+            if (i != 0)\n+            {\n+                // Each action may rely on the XAML layout of a preceding action.\n+                // Most importantly, this is the case for the combination of NewTab + SplitPane,\n+                // as the former appears to only have a layout size after at least 1 resume_foreground,\n+                // while the latter relies on that information. This is also why it uses Low priority.\n+                //\n+                // Curiously, this does not seem to be required when using startupActions, but only when\n+                // tearing out a tab (this currently creates a new window with injected startup actions).\n+                // This indicates that this is really more of an architectural issue and not a fundamental one.\n+                co_await wil::resume_foreground(Dispatcher(), CoreDispatcherPriority::Low);\n+            }\n \n-        if (env.empty())\n-        {\n-            restoreEnv.release();\n-        }\n-        else\n-        {\n-            _WindowProperties.VirtualEnvVars(env);\n+            _actionDispatch->DoAction(actions[i]);\n         }\n \n-        if (auto page{ weakThis.get() })\n+        // GH#6586: now that we're done processing all startup commands,\n+        // focus the active control. This will work as expected for both\n+        // commandline invocations and for `wt` action invocations.\n+        if (const auto& terminalTab{ _GetFocusedTabImpl() })\n         {\n-            for (const auto& action : actions)\n+            if (const auto& content{ terminalTab->GetActiveContent() })\n             {\n-                if (auto page{ weakThis.get() })\n-                {\n-                    _actionDispatch->DoAction(action);\n-                }\n-                else\n-                {\n-                    co_return;\n-                }\n-            }\n-\n-            // GH#6586: now that we're done processing all startup commands,\n-            // focus the active control. This will work as expected for both\n-            // commandline invocations and for `wt` action invocations.\n-            if (const auto& terminalTab{ _GetFocusedTabImpl() })\n-            {\n-                if (const auto& content{ terminalTab->GetActiveContent() })\n-                {\n-                    content.Focus(FocusState::Programmatic);\n-                }\n+                content.Focus(FocusState::Programmatic);\n             }\n         }\n+\n         if (initial)\n         {\n             _CompleteInitialization();\n@@ -3664,13 +3639,9 @@ namespace winrt::TerminalApp::implementation\n     // - actions: a list of Actions to process on startup.\n     // Return Value:\n     // - <none>\n-    void TerminalPage::SetStartupActions(std::vector<ActionAndArgs>& actions)\n+    void TerminalPage::SetStartupActions(std::vector<ActionAndArgs> actions)\n     {\n-        // The fastest way to copy all the actions out of the std::vector and\n-        // put them into a winrt::IVector is by making a copy, then moving the\n-        // copy into the winrt vector ctor.\n-        auto listCopy = actions;\n-        _startupActions = winrt::single_threaded_vector<ActionAndArgs>(std::move(listCopy));\n+        _startupActions = std::move(actions);\n     }\n \n     // Routine Description:\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex d094e07f0fe..9837f9fe618 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -128,7 +128,7 @@ namespace winrt::TerminalApp::implementation\n         void Maximized(bool newMaximized);\n         void RequestSetMaximized(bool newMaximized);\n \n-        void SetStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs>& actions);\n+        void SetStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions);\n \n         void SetInboundListener(bool isEmbedding);\n         static std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> ConvertExecuteCommandlineToActions(const Microsoft::Terminal::Settings::Model::ExecuteCommandlineArgs& args);\n@@ -146,7 +146,7 @@ namespace winrt::TerminalApp::implementation\n         void ActionSaveFailed(winrt::hstring message);\n         void ShowTerminalWorkingDirectory();\n \n-        safe_void_coroutine ProcessStartupActions(Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions,\n+        safe_void_coroutine ProcessStartupActions(std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> actions,\n                                                   const bool initial,\n                                                   const winrt::hstring cwd = winrt::hstring{},\n                                                   const winrt::hstring env = winrt::hstring{});\n@@ -255,7 +255,7 @@ namespace winrt::TerminalApp::implementation\n         winrt::Windows::UI::Xaml::Controls::Grid::LayoutUpdated_revoker _layoutUpdatedRevoker;\n         StartupState _startupState{ StartupState::NotInitialized };\n \n-        Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::ActionAndArgs> _startupActions;\n+        std::vector<Microsoft::Terminal::Settings::Model::ActionAndArgs> _startupActions;\n         bool _shouldStartInboundListener{ false };\n         bool _isEmbeddingInboundListener{ false };\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 055d6123ccf..4d644666e1c 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -1054,12 +1054,8 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         _contentBounds = bounds;\r\n \r\n-        const auto& args = _contentStringToActions(content, true);\r\n-\r\n-        for (const auto& action : args)\r\n-        {\r\n-            _initialContentArgs.push_back(action);\r\n-        }\r\n+        const auto args = _contentStringToActions(content, true);\r\n+        _initialContentArgs = wil::to_vector(args);\r\n     }\r\n \r\n     // Method Description:\r\n@@ -1085,7 +1081,7 @@ namespace winrt::TerminalApp::implementation\n         if (_appArgs->ExitCode() == 0)\r\n         {\r\n             auto& parsedArgs = _appArgs->ParsedArgs();\r\n-            auto actions = winrt::single_threaded_vector<ActionAndArgs>(std::move(parsedArgs.GetStartupActions()));\r\n+            auto& actions = parsedArgs.GetStartupActions();\r\n \r\n             _root->ProcessStartupActions(actions, false, _appArgs->CurrentDirectory(), _appArgs->CurrentEnvironment());\r\n \r\n@@ -1200,7 +1196,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         try\r\n         {\r\n-            const auto& args = ActionAndArgs::Deserialize(content);\r\n+            const auto args = ActionAndArgs::Deserialize(content);\r\n             if (args == nullptr ||\r\n                 args.Size() == 0)\r\n             {\r\n@@ -1244,9 +1240,9 @@ namespace winrt::TerminalApp::implementation\n \r\n             const bool replaceFirstWithNewTab = tabIndex >= _root->NumberOfTabs();\r\n \r\n-            const auto& args = _contentStringToActions(content, replaceFirstWithNewTab);\r\n+            auto args = _contentStringToActions(content, replaceFirstWithNewTab);\r\n \r\n-            _root->AttachContent(args, tabIndex);\r\n+            _root->AttachContent(std::move(args), tabIndex);\r\n         }\r\n     }\r\n     void TerminalWindow::SendContentToOther(winrt::TerminalApp::RequestReceiveContentArgs args)\r\n", "instance_id": "microsoft__terminal-18627", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when dragging a tab with multiple panels into a new window in Windows Terminal, only the first panel is retained, and the other panels are lost (with their processes being terminated). The goal is to ensure that all panels are preserved in the new window. The statement includes the version of the software, steps to reproduce, expected behavior, and actual behavior, which provides a good foundation for understanding the issue. However, it lacks specific technical details about the root cause or constraints (e.g., whether this is a UI rendering issue, a data serialization issue, or a process management issue). Additionally, edge cases or specific scenarios (e.g., behavior with different types of panels or configurations) are not mentioned, which could be critical for a complete solution. Hence, while the problem is valid and mostly clear, minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (e.g., TerminalPage.cpp, TerminalWindow.cpp, AppActionHandlers.cpp) and involves significant modifications to how startup actions and content are handled when a tab is dragged into a new window. This requires understanding the interactions between different components of the Windows Terminal codebase, such as tab management, action dispatching, and window initialization. Second, the technical concepts involved include C++ with WinRT (Windows Runtime), coroutines (safe_void_coroutine), and specific Windows Terminal abstractions like ActionAndArgs and TerminalPage. These are moderately advanced concepts, especially given the use of asynchronous programming and the need to manage UI state correctly. Third, the changes impact core functionality (tab and panel management), which could have architectural implications if not handled carefully, especially when ensuring that panel state and associated processes are preserved during the drag operation. Finally, while the problem statement does not explicitly mention edge cases, the nature of the issue implies potential complexities, such as handling different panel configurations, ensuring process continuity, and managing UI focus (as seen in the code changes). The code changes themselves are non-trivial, involving refactoring from WinRT collections to standard C++ containers (e.g., std::vector) and adjusting how actions are processed and dispatched. Overall, this problem requires a deep understanding of the codebase and careful handling of state and UI logic, justifying a difficulty score of 0.65.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Clear Buffer is broken in Windows Terminal Preview (1.22.2362.0)\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.4037\r\n\r\n### Steps to reproduce\r\n\r\n* Settings -> Actions -> Add New -> Add \"Ctrl+l\" (lowercase L) for \"Clear Buffer\". Press Save.\r\n* Open tab with \"Command Prompt\".\r\n* Execute \"cd C:\\Windows\". Execute \"dir\" several times to fill the screen.\r\n* Press Ctrl+l (lowercase L).\r\n\r\n### Expected Behavior\r\n\r\nClear Buffer works fine in Windows Terminal v.1.20.11781.0.\r\n\r\n### Actual Behavior\r\n\r\nClear Buffer does not work in Windows Terminal Preview v.1.22.2362.0.\r\n\r\nThe same problem can be reproduced with \"Ubuntu 24.04 LTS\" tab (WSL2).\r\n\r\nI've just noticed that pressing Ctrl+Shift+L works differently from Ctrl+L (but still broken). And I didn't assign Ctrl+Shift+L to anything.\n", "patch": "diff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5c96b5c805c 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -2221,19 +2221,32 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - <none>\r\n     void ControlCore::ClearBuffer(Control::ClearBufferType clearType)\r\n     {\r\n-        if (clearType == Control::ClearBufferType::Scrollback || clearType == Control::ClearBufferType::All)\r\n+        std::wstring_view command;\r\n+        switch (clearType)\r\n+        {\r\n+        case ClearBufferType::Screen:\r\n+            command = L\"\\x1b[H\\x1b[2J\";\r\n+            break;\r\n+        case ClearBufferType::Scrollback:\r\n+            command = L\"\\x1b[3J\";\r\n+            break;\r\n+        case ClearBufferType::All:\r\n+            command = L\"\\x1b[H\\x1b[2J\\x1b[3J\";\r\n+            break;\r\n+        }\r\n+\r\n         {\r\n             const auto lock = _terminal->LockForWriting();\r\n-            _terminal->EraseScrollback();\r\n+            _terminal->Write(command);\r\n         }\r\n \r\n         if (clearType == Control::ClearBufferType::Screen || clearType == Control::ClearBufferType::All)\r\n         {\r\n-            // Send a signal to conpty to clear the buffer.\r\n             if (auto conpty{ _connection.try_as<TerminalConnection::ConptyConnection>() })\r\n             {\r\n-                // ConPTY will emit sequences to sync up our buffer with its new\r\n-                // contents.\r\n+                // Since the clearing of ConPTY occurs asynchronously, this call can result weird issues,\r\n+                // where a console application still sees contents that we've already deleted, etc.\r\n+                // The correct way would be for ConPTY to emit the appropriate CSI n J sequences.\r\n                 conpty.ClearBuffer();\r\n             }\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..4b855b02f6c 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -209,12 +209,6 @@ void Terminal::SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle)\n     engine.Dispatch().SetCursorStyle(cursorStyle);\r\n }\r\n \r\n-void Terminal::EraseScrollback()\r\n-{\r\n-    auto& engine = reinterpret_cast<OutputStateMachineEngine&>(_stateMachine->Engine());\r\n-    engine.Dispatch().EraseInDisplay(DispatchTypes::EraseType::Scrollback);\r\n-}\r\n-\r\n bool Terminal::IsXtermBracketedPasteModeEnabled() const noexcept\r\n {\r\n     return _systemMode.test(Mode::BracketedPaste);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..ae7c2dbe168 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -94,7 +94,6 @@ class Microsoft::Terminal::Core::Terminal final :\n     void UpdateAppearance(const winrt::Microsoft::Terminal::Core::ICoreAppearance& appearance);\r\n     void SetFontInfo(const FontInfo& fontInfo);\r\n     void SetCursorStyle(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::CursorStyle cursorStyle);\r\n-    void EraseScrollback();\r\n     bool IsXtermBracketedPasteModeEnabled() const noexcept;\r\n     std::wstring_view GetWorkingDirectory() noexcept;\r\n \r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex 4620afae09a..e018e1fd2ad 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -304,9 +304,9 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Check the buffer after the clear\");\r\n         VERIFY_ARE_EQUAL(20, core->_terminal->GetViewport().Height());\r\n-        VERIFY_ARE_EQUAL(21, core->ScrollOffset());\r\n+        VERIFY_ARE_EQUAL(41, core->ScrollOffset());\r\n         VERIFY_ARE_EQUAL(20, core->ViewHeight());\r\n-        VERIFY_ARE_EQUAL(41, core->BufferHeight());\r\n+        VERIFY_ARE_EQUAL(61, core->BufferHeight());\r\n \r\n         // In this test, we can't actually check if we cleared the buffer\r\n         // contents. ConPTY will handle the actual clearing of the buffer\r\ndiff --git a/src/host/PtySignalInputThread.cpp b/src/host/PtySignalInputThread.cpp\nindex 45860f9c1a0..fa3893b4dd0 100644\n--- a/src/host/PtySignalInputThread.cpp\n+++ b/src/host/PtySignalInputThread.cpp\n@@ -7,6 +7,7 @@\n \r\n #include \"output.h\"\r\n #include \"handle.h\"\r\n+#include \"_stream.h\"\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n \r\n using namespace Microsoft::Console;\r\n@@ -197,7 +198,9 @@ void PtySignalInputThread::_DoClearBuffer() const\n     }\r\n \r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n-    THROW_IF_FAILED(gci.GetActiveOutputBuffer().ClearBuffer());\r\n+    auto& screenInfo = gci.GetActiveOutputBuffer();\r\n+    auto& stateMachine = screenInfo.GetStateMachine();\r\n+    stateMachine.ProcessString(L\"\\x1b[H\\x1b[2J\");\r\n }\r\n \r\n void PtySignalInputThread::_DoShowHide(const ShowHideData& data)\r\ndiff --git a/src/host/screenInfo.cpp b/src/host/screenInfo.cpp\nindex 8d5e9217246..3e1ae49d4b3 100644\n--- a/src/host/screenInfo.cpp\n+++ b/src/host/screenInfo.cpp\n@@ -2129,38 +2129,6 @@ void SCREEN_INFORMATION::SetViewport(const Viewport& newViewport,\n     Tracing::s_TraceWindowViewport(_viewport);\r\n }\r\n \r\n-// Method Description:\r\n-// - Clear the entire contents of the viewport, except for the cursor's row,\r\n-//   which is moved to the top line of the viewport.\r\n-// - This is used exclusively by ConPTY to support GH#1193, GH#1882. This allows\r\n-//   a terminal to clear the contents of the ConPTY buffer, which is important\r\n-//   if the user would like to be able to clear the terminal-side buffer.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - S_OK\r\n-[[nodiscard]] HRESULT SCREEN_INFORMATION::ClearBuffer()\r\n-{\r\n-    // Rotate the buffer to bring the cursor row to the top of the viewport.\r\n-    const auto cursorPos = _textBuffer->GetCursor().GetPosition();\r\n-    for (auto i = 0; i < cursorPos.y; i++)\r\n-    {\r\n-        _textBuffer->IncrementCircularBuffer();\r\n-    }\r\n-\r\n-    // Erase everything below that point.\r\n-    RETURN_IF_FAILED(SetCursorPosition({ 0, 1 }, false));\r\n-    auto& engine = reinterpret_cast<OutputStateMachineEngine&>(_stateMachine->Engine());\r\n-    engine.Dispatch().EraseInDisplay(DispatchTypes::EraseType::ToEnd);\r\n-\r\n-    // Restore the original cursor x offset, but now on the first row.\r\n-    RETURN_IF_FAILED(SetCursorPosition({ cursorPos.x, 0 }, false));\r\n-\r\n-    _textBuffer->TriggerRedrawAll();\r\n-\r\n-    return S_OK;\r\n-}\r\n-\r\n // Routine Description:\r\n // - Writes cells to the output buffer at the cursor position.\r\n // Arguments:\r\ndiff --git a/src/host/screenInfo.hpp b/src/host/screenInfo.hpp\nindex 4ecd1a4e3e9..c7685cb1c06 100644\n--- a/src/host/screenInfo.hpp\n+++ b/src/host/screenInfo.hpp\n@@ -203,8 +203,6 @@ class SCREEN_INFORMATION : public ConsoleObjectHeader, public Microsoft::Console\n     void SetDefaultAttributes(const TextAttribute& attributes,\r\n                               const TextAttribute& popupAttributes);\r\n \r\n-    [[nodiscard]] HRESULT ClearBuffer();\r\n-\r\n     void UpdateBottom();\r\n \r\n     FontInfo& GetCurrentFont() noexcept;\r\n", "instance_id": "microsoft__terminal-17884", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"Clear Buffer\" functionality is broken in Windows Terminal Preview (version 1.22.2362.0) when using the assigned shortcut Ctrl+L, and it behaves differently with Ctrl+Shift+L. The steps to reproduce are provided, along with the expected and actual behavior, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"Clear Buffer\" should do in terms of technical behavior (e.g., clearing the screen, scrollback, or both), though this can be inferred from context and the code changes. Additionally, there are no mentions of specific edge cases or constraints (e.g., behavior in different terminal profiles or with specific content in the buffer). While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (ControlCore.cpp, Terminal.cpp, Terminal.hpp, PtySignalInputThread.cpp, screenInfo.cpp, screenInfo.hpp, and unit tests), indicating a need to understand interactions across different components of the Windows Terminal codebase. The changes involve replacing direct buffer clearing logic with ANSI escape sequences (e.g., \"\\x1b[H\\x1b[2J\" for screen clearing), which requires familiarity with terminal control sequences and their implications on different terminal environments (e.g., ConPTY, WSL2). \n\nSecond, the technical concepts involved include understanding terminal buffer management, ANSI escape sequence handling, and the interaction between the terminal frontend and backend (ConPTY). While these concepts are not extremely advanced, they require a moderate level of domain-specific knowledge about terminal emulation and Windows console internals. The removal of certain methods (e.g., EraseScrollback, ClearBuffer) and their replacement with sequence-based clearing suggests a shift in design approach, which adds to the complexity of ensuring compatibility and correctness.\n\nThird, the problem involves potential edge cases, such as asynchronous clearing issues with ConPTY (as noted in the code comments) and ensuring consistent behavior across different terminal profiles (e.g., Command Prompt, Ubuntu WSL2). While the problem statement does not explicitly mention edge cases, the code changes and comments hint at challenges like content visibility mismatches post-clearing, which require careful handling. However, no extensive error handling or performance optimization is evident in the changes, limiting the difficulty from reaching the higher end.\n\nFinally, the impact on the system's architecture is moderate. The changes alter how buffer clearing is handled (moving from direct API calls to escape sequences), which could affect other parts of the system relying on the old behavior, but it does not appear to be a fundamental refactoring of core components. Given these considerations, a difficulty score of 0.55 reflects the need for a solid understanding of multiple concepts, cross-file modifications, and handling of implicit edge cases, placing it in the medium difficulty range.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Support querying the colors via OSC\n<!-- \r\n🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\nOSC 4, 10, 11 and friends, with a `?` instead of a color, respond with the current value of that color in xterm, vte and quite a few other terminals, always using the `rgb:RRRR/GGGG/BBBB` notation, and the same terminator (ST vs. BEL) as in the query.\r\n\r\nExamples:\r\n\r\n    echo -ne '\\e]4;1;?\\e\\\\'; cat\r\n\r\n    echo -ne '\\e]11;?\\a'; cat\r\n\r\nThis allows apps (e.g. vim) to automatically pick a color scheme depending on whether the user has a dark-on-bright on bright-on-dark color scheme. I don't know if it's actually being used in practice, though :D\r\n\n", "patch": "diff --git a/.github/actions/spelling/patterns/patterns.txt b/.github/actions/spelling/patterns/patterns.txt\nindex 0089073a434..39fadfec281 100644\n--- a/.github/actions/spelling/patterns/patterns.txt\n+++ b/.github/actions/spelling/patterns/patterns.txt\n@@ -22,6 +22,7 @@ vcvars\\w*\n ROY\\sG\\.\\sBIV\n !(?:(?i)ESC)!\\[\n !(?:(?i)CSI)!(?:\\d+(?:;\\d+|)m|[ABCDF])\n+(?i)rgb:[a-z0-9]{2,4}/[a-z0-9]{2,4}/[a-z0-9]{2,4}\n \n # SSE intrinsics like \"_mm_subs_epu16\"\n \\b_mm(?:|256|512)_\\w+\\b\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex bf4d2cc5bd5..514c8b0c4d9 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -76,9 +76,10 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual bool BackwardsTab(const VTInt numTabs) = 0; // CBT\r\n     virtual bool TabClear(const DispatchTypes::TabClearType clearType) = 0; // TBC\r\n     virtual bool TabSet(const VTParameter setType) = 0; // DECST8C\r\n-    virtual bool SetColorTableEntry(const size_t tableIndex, const DWORD color) = 0; // OSCColorTable\r\n-    virtual bool SetDefaultForeground(const DWORD color) = 0; // OSCDefaultForeground\r\n-    virtual bool SetDefaultBackground(const DWORD color) = 0; // OSCDefaultBackground\r\n+    virtual bool SetColorTableEntry(const size_t tableIndex, const DWORD color) = 0; // OSCSetColorTable\r\n+    virtual bool RequestColorTableEntry(const size_t tableIndex) = 0; // OSCGetColorTable\r\n+    virtual bool SetXtermColorResource(const size_t resource, const DWORD color) = 0; // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\r\n+    virtual bool RequestXtermColorResource(const size_t resource) = 0; // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\r\n     virtual bool AssignColor(const DispatchTypes::ColorItem item, const VTInt fgIndex, const VTInt bgIndex) = 0; // DECAC\r\n \r\n     virtual bool EraseInDisplay(const DispatchTypes::EraseType eraseType) = 0; // ED\r\n@@ -128,7 +129,6 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual bool ScreenAlignmentPattern() = 0; // DECALN\r\n \r\n     virtual bool SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle) = 0; // DECSCUSR\r\n-    virtual bool SetCursorColor(const COLORREF color) = 0; // OSCSetCursorColor, OSCResetCursorColor\r\n \r\n     virtual bool SetClipboard(wil::zwstring_view content) = 0; // OSCSetClipboard\r\n \r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3aca2abfdf9..1c84e939ffb 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -18,6 +18,25 @@ using namespace Microsoft::Console::VirtualTerminal;\n \n static constexpr std::wstring_view whitespace{ L\" \" };\n \n+struct XtermResourceColorTableEntry\n+{\n+    int ColorTableIndex;\n+    int AliasIndex;\n+};\n+\n+static constexpr std::array<XtermResourceColorTableEntry, 10> XtermResourceColorTableMappings{ {\n+    /* 10 */ { TextColor::DEFAULT_FOREGROUND, static_cast<int>(ColorAlias::DefaultForeground) },\n+    /* 11 */ { TextColor::DEFAULT_BACKGROUND, static_cast<int>(ColorAlias::DefaultBackground) },\n+    /* 12 */ { TextColor::CURSOR_COLOR, -1 },\n+    /* 13 */ { -1, -1 },\n+    /* 14 */ { -1, -1 },\n+    /* 15 */ { -1, -1 },\n+    /* 16 */ { -1, -1 },\n+    /* 17 */ { -1, -1 },\n+    /* 18 */ { -1, -1 },\n+    /* 19 */ { -1, -1 },\n+} };\n+\n AdaptDispatch::AdaptDispatch(ITerminalApi& api, Renderer* renderer, RenderSettings& renderSettings, TerminalInput& terminalInput) noexcept :\n     _api{ api },\n     _renderer{ renderer },\n@@ -3439,18 +3458,6 @@ bool AdaptDispatch::SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle)\n     return true;\n }\n \n-// Method Description:\n-// - Sets a single entry of the colortable to a new value\n-// Arguments:\n-// - tableIndex: The VT color table index\n-// - dwColor: The new RGB color value to use.\n-// Return Value:\n-// True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetCursorColor(const COLORREF cursorColor)\n-{\n-    return SetColorTableEntry(TextColor::CURSOR_COLOR, cursorColor);\n-}\n-\n // Routine Description:\n // - OSC Copy to Clipboard\n // Arguments:\n@@ -3491,28 +3498,69 @@ bool AdaptDispatch::SetColorTableEntry(const size_t tableIndex, const DWORD dwCo\n     return true;\n }\n \n+bool AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n+{\n+    const auto color = _renderSettings.GetColorTableEntry(tableIndex);\n+    if (color != INVALID_COLOR)\n+    {\n+        const til::color c{ color };\n+        // Scale values up to match xterm's 16-bit color report format.\n+        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+    }\n+\n+    return true;\n+}\n+\n // Method Description:\n-// - Sets the default foreground color to a new value\n-// Arguments:\n-// - dwColor: The new RGB color value to use, as a COLORREF, format 0x00BBGGRR.\n+// - Sets one Xterm Color Resource such as Default Foreground, Background, Cursor\n // Return Value:\n // True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetDefaultForeground(const DWORD dwColor)\n+bool AdaptDispatch::SetXtermColorResource(const size_t resource, const DWORD color)\n {\n-    _renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DEFAULT_FOREGROUND);\n-    return SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, dwColor);\n+    assert(resource >= 10);\n+    const auto mappingIndex = resource - 10;\n+    const auto& oscMapping = XtermResourceColorTableMappings.at(mappingIndex);\n+    if (oscMapping.ColorTableIndex > 0)\n+    {\n+        if (oscMapping.AliasIndex >= 0) [[unlikely]]\n+        {\n+            // If this color change applies to an aliased color, point the alias at the new color\n+            _renderSettings.SetColorAliasIndex(static_cast<ColorAlias>(oscMapping.AliasIndex), oscMapping.ColorTableIndex);\n+        }\n+        return SetColorTableEntry(oscMapping.ColorTableIndex, color);\n+    }\n+\n+    return true;\n }\n \n // Method Description:\n-// - Sets the default background color to a new value\n-// Arguments:\n-// - dwColor: The new RGB color value to use, as a COLORREF, format 0x00BBGGRR.\n+// - Reports the value of one Xterm Color Resource, if it is set.\n // Return Value:\n // True if handled successfully. False otherwise.\n-bool AdaptDispatch::SetDefaultBackground(const DWORD dwColor)\n+bool AdaptDispatch::RequestXtermColorResource(const size_t resource)\n {\n-    _renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::DEFAULT_BACKGROUND);\n-    return SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, dwColor);\n+    assert(resource >= 10);\n+    const auto mappingIndex = resource - 10;\n+    const auto& oscMapping = XtermResourceColorTableMappings.at(mappingIndex);\n+    if (oscMapping.ColorTableIndex > 0)\n+    {\n+        size_t finalColorIndex = oscMapping.ColorTableIndex;\n+\n+        if (oscMapping.AliasIndex >= 0) [[unlikely]]\n+        {\n+            finalColorIndex = _renderSettings.GetColorAliasIndex(static_cast<ColorAlias>(oscMapping.AliasIndex));\n+        }\n+\n+        const auto color = _renderSettings.GetColorTableEntry(finalColorIndex);\n+        if (color != INVALID_COLOR)\n+        {\n+            const til::color c{ color };\n+            // Scale values up to match xterm's 16-bit color report format.\n+            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        }\n+    }\n+\n+    return true;\n }\n \n // Method Description:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex cba0273665d..ef5636be1e2 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -126,14 +126,14 @@ namespace Microsoft::Console::VirtualTerminal\n         bool HardReset() override; // RIS\n         bool ScreenAlignmentPattern() override; // DECALN\n         bool SetCursorStyle(const DispatchTypes::CursorStyle cursorStyle) override; // DECSCUSR\n-        bool SetCursorColor(const COLORREF cursorColor) override;\n \n         bool SetClipboard(const wil::zwstring_view content) override; // OSCSetClipboard\n \n         bool SetColorTableEntry(const size_t tableIndex,\n-                                const DWORD color) override; // OSCColorTable\n-        bool SetDefaultForeground(const DWORD color) override; // OSCDefaultForeground\n-        bool SetDefaultBackground(const DWORD color) override; // OSCDefaultBackground\n+                                const DWORD color) override; // OSCSetColorTable\n+        bool RequestColorTableEntry(const size_t tableIndex) override; // OSCGetColorTable\n+        bool SetXtermColorResource(const size_t resource, const DWORD color) override; // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\n+        bool RequestXtermColorResource(const size_t resource) override; // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\n         bool AssignColor(const DispatchTypes::ColorItem item, const VTInt fgIndex, const VTInt bgIndex) override; // DECAC\n \n         bool WindowManipulation(const DispatchTypes::WindowManipulationType function,\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex 607089545bf..5d256928712 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -69,9 +69,10 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     bool BackwardsTab(const VTInt /*numTabs*/) override { return false; } // CBT\r\n     bool TabClear(const DispatchTypes::TabClearType /*clearType*/) override { return false; } // TBC\r\n     bool TabSet(const VTParameter /*setType*/) override { return false; } // DECST8C\r\n-    bool SetColorTableEntry(const size_t /*tableIndex*/, const DWORD /*color*/) override { return false; } // OSCColorTable\r\n-    bool SetDefaultForeground(const DWORD /*color*/) override { return false; } // OSCDefaultForeground\r\n-    bool SetDefaultBackground(const DWORD /*color*/) override { return false; } // OSCDefaultBackground\r\n+    bool SetColorTableEntry(const size_t /*tableIndex*/, const DWORD /*color*/) override { return false; } // OSCSetColorTable\r\n+    bool RequestColorTableEntry(const size_t /*tableIndex*/) override { return false; } // OSCGetColorTable\r\n+    bool SetXtermColorResource(const size_t /*resource*/, const DWORD /*color*/) override { return false; } // OSCSetDefaultForeground, OSCSetDefaultBackground, OSCSetCursorColor, OSCResetCursorColor\r\n+    bool RequestXtermColorResource(const size_t /*resource*/) override { return false; } // OSCGetDefaultForeground, OSCGetDefaultBackground, OSCGetCursorColor\r\n     bool AssignColor(const DispatchTypes::ColorItem /*item*/, const VTInt /*fgIndex*/, const VTInt /*bgIndex*/) override { return false; } // DECAC\r\n \r\n     bool EraseInDisplay(const DispatchTypes::EraseType /* eraseType*/) override { return false; } // ED\r\n@@ -121,7 +122,6 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     bool ScreenAlignmentPattern() override { return false; } // DECALN\r\n \r\n     bool SetCursorStyle(const DispatchTypes::CursorStyle /*cursorStyle*/) override { return false; } // DECSCUSR\r\n-    bool SetCursorColor(const COLORREF /*color*/) override { return false; } // OSCSetCursorColor, OSCResetCursorColor\r\n \r\n     bool SetClipboard(wil::zwstring_view /*content*/) override { return false; } // OscSetClipboard\r\n \r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex edd13ddab01..7d571086edd 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -2398,6 +2398,232 @@ class AdapterTest\n         _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n     }\r\n \r\n+    TEST_METHOD(Osc4ColorPaletteReportTests)\r\n+    {\r\n+        _testGetSet->PrepData();\r\n+\r\n+        // The colors below use the same VT525 colors as the other color table report tests.\r\n+        auto& renderSettings = _testGetSet->_renderer._renderSettings;\r\n+        renderSettings.SetColorTableEntry(0, RGB(0, 0, 0));\r\n+        renderSettings.SetColorTableEntry(1, RGB(204, 36, 36));\r\n+        renderSettings.SetColorTableEntry(2, RGB(51, 204, 51));\r\n+        renderSettings.SetColorTableEntry(3, RGB(204, 204, 51));\r\n+        renderSettings.SetColorTableEntry(4, RGB(51, 51, 204));\r\n+        renderSettings.SetColorTableEntry(5, RGB(204, 51, 204));\r\n+        renderSettings.SetColorTableEntry(6, RGB(51, 204, 204));\r\n+        renderSettings.SetColorTableEntry(7, RGB(120, 120, 120));\r\n+        renderSettings.SetColorTableEntry(8, RGB(69, 69, 69));\r\n+        renderSettings.SetColorTableEntry(9, RGB(255, 0, 0));\r\n+        renderSettings.SetColorTableEntry(10, RGB(0, 255, 0));\r\n+        renderSettings.SetColorTableEntry(11, RGB(255, 255, 0));\r\n+        renderSettings.SetColorTableEntry(12, RGB(0, 0, 255));\r\n+        renderSettings.SetColorTableEntry(13, RGB(255, 0, 255));\r\n+        renderSettings.SetColorTableEntry(14, RGB(0, 255, 255));\r\n+        renderSettings.SetColorTableEntry(15, RGB(255, 255, 255));\r\n+        for (size_t i = 16; i < TextColor::TABLE_SIZE; i++)\r\n+        {\r\n+            renderSettings.SetColorTableEntry(i, RGB(0, 0, 0));\r\n+        }\r\n+\r\n+        // Dynamic color reports begin with an OSC, parameter 4, another parameter for the index, and end with ST.\r\n+        const auto OSC = L\"\\033]\";\r\n+        const auto ST = L\"\\033\\\\\";\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        std::wstring expectedResponse = OSC;\r\n+        expectedResponse += L\"4;0;rgb:0000/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(1);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;1;rgb:cccc/2424/2424\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(2);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;2;rgb:3333/cccc/3333\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(3);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;3;rgb:cccc/cccc/3333\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(4);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;4;rgb:3333/3333/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(5);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;5;rgb:cccc/3333/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(6);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;6;rgb:3333/cccc/cccc\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(7);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;7;rgb:7878/7878/7878\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(8);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;8;rgb:4545/4545/4545\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(9);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;9;rgb:ffff/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(10);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;10;rgb:0000/ffff/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;11;rgb:ffff/ffff/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(12);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;12;rgb:0000/0000/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(13);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;13;rgb:ffff/0000/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(14);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;14;rgb:0000/ffff/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        _pDispatch->RequestColorTableEntry(15);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"4;15;rgb:ffff/ffff/ffff\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+    }\r\n+\r\n+    TEST_METHOD(XtermColorResourceReportTests)\r\n+    {\r\n+        _testGetSet->PrepData();\r\n+\r\n+        // The colors below use the same VT525 colors as the other color table report tests.\r\n+        auto& renderSettings = _testGetSet->_renderer._renderSettings;\r\n+        renderSettings.SetColorTableEntry(0, RGB(0, 0, 0));\r\n+        renderSettings.SetColorTableEntry(1, RGB(204, 36, 36));\r\n+        renderSettings.SetColorTableEntry(2, RGB(51, 204, 51));\r\n+        renderSettings.SetColorTableEntry(3, RGB(204, 204, 51));\r\n+        renderSettings.SetColorTableEntry(4, RGB(51, 51, 204));\r\n+        renderSettings.SetColorTableEntry(5, RGB(204, 51, 204));\r\n+        renderSettings.SetColorTableEntry(6, RGB(51, 204, 204));\r\n+        renderSettings.SetColorTableEntry(7, RGB(120, 120, 120));\r\n+        renderSettings.SetColorTableEntry(8, RGB(69, 69, 69));\r\n+        renderSettings.SetColorTableEntry(9, RGB(255, 0, 0));\r\n+        renderSettings.SetColorTableEntry(10, RGB(0, 255, 0));\r\n+        renderSettings.SetColorTableEntry(11, RGB(255, 255, 0));\r\n+        renderSettings.SetColorTableEntry(12, RGB(0, 0, 255));\r\n+        renderSettings.SetColorTableEntry(13, RGB(255, 0, 255));\r\n+        renderSettings.SetColorTableEntry(14, RGB(0, 255, 255));\r\n+        renderSettings.SetColorTableEntry(15, RGB(255, 255, 255));\r\n+\r\n+        renderSettings.SetColorTableEntry(TextColor::DEFAULT_FOREGROUND, RGB(190, 190, 190));\r\n+        renderSettings.SetColorTableEntry(TextColor::DEFAULT_BACKGROUND, RGB(12, 12, 12));\r\n+        renderSettings.SetColorTableEntry(TextColor::CURSOR_COLOR, RGB(255, 0, 0));\r\n+\r\n+        // Dynamic color reports begin with an OSC, a parameter matching the requested value, and end with ST.\r\n+        const auto OSC = L\"\\033]\";\r\n+        const auto ST = L\"\\033\\\\\";\r\n+\r\n+        // Foreground mapped to DARK_WHITE\r\n+        _pDispatch->RequestXtermColorResource(10);\r\n+        std::wstring expectedResponse = OSC;\r\n+        expectedResponse += L\"10;rgb:7878/7878/7878\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Foreground mapped to independent foreground color\r\n+        renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DEFAULT_FOREGROUND);\r\n+        _pDispatch->RequestXtermColorResource(10);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"10;rgb:bebe/bebe/bebe\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Background mapped to DARK_BLACK\r\n+        _pDispatch->RequestXtermColorResource(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"11;rgb:0000/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Background mapped to independent background color\r\n+        renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::DEFAULT_BACKGROUND);\r\n+        _pDispatch->RequestXtermColorResource(11);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"11;rgb:0c0c/0c0c/0c0c\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Foreground and Background mapped to different indices (e.g. via DECAC)\r\n+        {\r\n+            _testGetSet->_response.clear(); // manually clear (since we aren't issuing a call that will empty it)\r\n+            auto retentionScope = _testGetSet->EnableInputRetentionInScope();\r\n+            renderSettings.SetColorAliasIndex(ColorAlias::DefaultForeground, TextColor::DARK_RED);\r\n+            renderSettings.SetColorAliasIndex(ColorAlias::DefaultBackground, TextColor::BRIGHT_GREEN);\r\n+            _pDispatch->RequestXtermColorResource(10);\r\n+            _pDispatch->RequestXtermColorResource(11);\r\n+            expectedResponse = OSC;\r\n+            expectedResponse += L\"10;rgb:cccc/2424/2424\";\r\n+            expectedResponse += ST;\r\n+            expectedResponse += OSC;\r\n+            expectedResponse += L\"11;rgb:0000/ffff/0000\";\r\n+            expectedResponse += ST;\r\n+            _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+        }\r\n+\r\n+        _pDispatch->RequestXtermColorResource(12);\r\n+        expectedResponse = OSC;\r\n+        expectedResponse += L\"12;rgb:ffff/0000/0000\";\r\n+        expectedResponse += ST;\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Resource set to unrepresentable color\r\n+        _testGetSet->_response.clear(); // manually clear (since we aren't issuing a call that will empty it)\r\n+        renderSettings.SetColorTableEntry(TextColor::CURSOR_COLOR, INVALID_COLOR);\r\n+        _pDispatch->RequestXtermColorResource(12);\r\n+        expectedResponse = L\"\";\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+\r\n+        // Unsupported resource - no mapped color\r\n+        _testGetSet->_response.clear();\r\n+        _pDispatch->RequestXtermColorResource(13);\r\n+        expectedResponse = L\"\";\r\n+        _testGetSet->ValidateInputEvent(expectedResponse.c_str());\r\n+    }\r\n+\r\n     TEST_METHOD(TabulationStopReportTests)\r\n     {\r\n         _testGetSet->PrepData();\r\ndiff --git a/src/terminal/parser/InputStateMachineEngine.cpp b/src/terminal/parser/InputStateMachineEngine.cpp\nindex 645ff33a1dc..d98bfd98de2 100644\n--- a/src/terminal/parser/InputStateMachineEngine.cpp\n+++ b/src/terminal/parser/InputStateMachineEngine.cpp\n@@ -550,8 +550,19 @@ bool InputStateMachineEngine::ActionIgnore() noexcept\n // - string - OSC string we've collected. NOT null terminated.\r\n // Return Value:\r\n // - true if we handled the dispatch.\r\n-bool InputStateMachineEngine::ActionOscDispatch(const size_t /*parameter*/, const std::wstring_view /*string*/) noexcept\r\n+bool InputStateMachineEngine::ActionOscDispatch(const size_t /*parameter*/, const std::wstring_view /*string*/)\r\n {\r\n+    // Unlike ActionCsiDispatch, we are not checking whether the application has requested\r\n+    // VT input.\r\n+    // Our documentation states that VT reports generated by application requests will be\r\n+    // sent regardless of the state of `ENABLE_VIRTUAL_TERMINAL_INPUT`. We can't easily do\r\n+    // that for CSI reports because we may incidentally pass through non-response VT input;\r\n+    // however, there should be no OSC on the input stream *except* for responses.\r\n+    // It should be safe to pass all OSCs from the input stream through to the application.\r\n+    if (_pfnFlushToInputQueue)\r\n+    {\r\n+        return _pfnFlushToInputQueue();\r\n+    }\r\n     return false;\r\n }\r\n \r\ndiff --git a/src/terminal/parser/InputStateMachineEngine.hpp b/src/terminal/parser/InputStateMachineEngine.hpp\nindex 32159f6f947..a572ec41123 100644\n--- a/src/terminal/parser/InputStateMachineEngine.hpp\n+++ b/src/terminal/parser/InputStateMachineEngine.hpp\n@@ -157,7 +157,7 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         bool ActionIgnore() noexcept override;\r\n \r\n-        bool ActionOscDispatch(const size_t parameter, const std::wstring_view string) noexcept override;\r\n+        bool ActionOscDispatch(const size_t parameter, const std::wstring_view string) override;\r\n \r\n         bool ActionSs3Dispatch(const wchar_t wch, const VTParameters parameters) override;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 66c993ac06b..874f382642a 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -14,6 +14,8 @@\n using namespace Microsoft::Console;\r\n using namespace Microsoft::Console::VirtualTerminal;\r\n \r\n+constexpr COLORREF COLOR_INQUIRY_COLOR = 0xfeffffff; // It's like INVALID_COLOR but special\r\n+\r\n // takes ownership of pDispatch\r\n OutputStateMachineEngine::OutputStateMachineEngine(std::unique_ptr<ITermDispatch> pDispatch) :\r\n     _dispatch(std::move(pDispatch)),\r\n@@ -788,7 +790,14 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n         {\r\n             const auto tableIndex = til::at(tableIndexes, i);\r\n             const auto rgb = til::at(colors, i);\r\n-            success = success && _dispatch->SetColorTableEntry(tableIndex, rgb);\r\n+            if (rgb == COLOR_INQUIRY_COLOR)\r\n+            {\r\n+                success = success && _dispatch->RequestColorTableEntry(tableIndex);\r\n+            }\r\n+            else\r\n+            {\r\n+                success = success && _dispatch->SetColorTableEntry(tableIndex, rgb);\r\n+            }\r\n         }\r\n         break;\r\n     }\r\n@@ -800,40 +809,18 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n         success = _GetOscSetColor(string, colors);\r\n         if (success)\r\n         {\r\n-            auto commandIndex = parameter;\r\n-            size_t colorIndex = 0;\r\n-\r\n-            if (commandIndex == OscActionCodes::SetForegroundColor && colors.size() > colorIndex)\r\n+            auto resource = parameter;\r\n+            for (auto&& color : colors)\r\n             {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n+                if (color == COLOR_INQUIRY_COLOR)\r\n                 {\r\n-                    success = success && _dispatch->SetDefaultForeground(color);\r\n+                    success = success && _dispatch->RequestXtermColorResource(resource);\r\n                 }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n-            }\r\n-\r\n-            if (commandIndex == OscActionCodes::SetBackgroundColor && colors.size() > colorIndex)\r\n-            {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n-                {\r\n-                    success = success && _dispatch->SetDefaultBackground(color);\r\n-                }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n-            }\r\n-\r\n-            if (commandIndex == OscActionCodes::SetCursorColor && colors.size() > colorIndex)\r\n-            {\r\n-                const auto color = til::at(colors, colorIndex);\r\n-                if (color != INVALID_COLOR)\r\n+                else if (color != INVALID_COLOR)\r\n                 {\r\n-                    success = success && _dispatch->SetCursorColor(color);\r\n+                    success = success && _dispatch->SetXtermColorResource(resource, color);\r\n                 }\r\n-                commandIndex++;\r\n-                colorIndex++;\r\n+                resource++;\r\n             }\r\n         }\r\n         break;\r\n@@ -851,7 +838,8 @@ bool OutputStateMachineEngine::ActionOscDispatch(const size_t parameter, const s\n     }\r\n     case OscActionCodes::ResetCursorColor:\r\n     {\r\n-        success = _dispatch->SetCursorColor(INVALID_COLOR);\r\n+        /* The reset codes for xterm dynamic resources are the set codes + 100 */\r\n+        success = _dispatch->SetXtermColorResource(parameter - 100u, INVALID_COLOR);\r\n         break;\r\n     }\r\n     case OscActionCodes::Hyperlink:\r\n@@ -938,6 +926,8 @@ bool OutputStateMachineEngine::_GetOscSetColorTable(const std::wstring_view stri\n                                                     std::vector<size_t>& tableIndexes,\r\n                                                     std::vector<DWORD>& rgbs) const\r\n {\r\n+    using namespace std::string_view_literals;\r\n+\r\n     const auto parts = Utils::SplitString(string, L';');\r\n     if (parts.size() < 2)\r\n     {\r\n@@ -949,13 +939,23 @@ bool OutputStateMachineEngine::_GetOscSetColorTable(const std::wstring_view stri\n \r\n     for (size_t i = 0, j = 1; j < parts.size(); i += 2, j += 2)\r\n     {\r\n+        auto&& index = til::at(parts, i);\r\n+        auto&& color = til::at(parts, j);\r\n         unsigned int tableIndex = 0;\r\n-        const auto indexSuccess = Utils::StringToUint(til::at(parts, i), tableIndex);\r\n-        const auto colorOptional = Utils::ColorFromXTermColor(til::at(parts, j));\r\n-        if (indexSuccess && colorOptional.has_value())\r\n+        const auto indexSuccess = Utils::StringToUint(index, tableIndex);\r\n+\r\n+        if (indexSuccess)\r\n         {\r\n-            newTableIndexes.push_back(tableIndex);\r\n-            newRgbs.push_back(colorOptional.value());\r\n+            if (color == L\"?\"sv) [[unlikely]]\r\n+            {\r\n+                newTableIndexes.push_back(tableIndex);\r\n+                newRgbs.push_back(COLOR_INQUIRY_COLOR);\r\n+            }\r\n+            else if (const auto colorOptional = Utils::ColorFromXTermColor(color))\r\n+            {\r\n+                newTableIndexes.push_back(tableIndex);\r\n+                newRgbs.push_back(colorOptional.value());\r\n+            }\r\n         }\r\n     }\r\n \r\n@@ -1032,6 +1032,8 @@ bool OutputStateMachineEngine::_ParseHyperlink(const std::wstring_view string,\n bool OutputStateMachineEngine::_GetOscSetColor(const std::wstring_view string,\r\n                                                std::vector<DWORD>& rgbs) const\r\n {\r\n+    using namespace std::string_view_literals;\r\n+\r\n     const auto parts = Utils::SplitString(string, L';');\r\n     if (parts.size() < 1)\r\n     {\r\n@@ -1039,10 +1041,14 @@ bool OutputStateMachineEngine::_GetOscSetColor(const std::wstring_view string,\n     }\r\n \r\n     std::vector<DWORD> newRgbs;\r\n-    for (size_t i = 0; i < parts.size(); i++)\r\n+    for (auto&& part : parts)\r\n     {\r\n-        const auto colorOptional = Utils::ColorFromXTermColor(til::at(parts, i));\r\n-        if (colorOptional.has_value())\r\n+        if (part == L\"?\"sv) [[unlikely]]\r\n+        {\r\n+            newRgbs.push_back(COLOR_INQUIRY_COLOR);\r\n+            continue;\r\n+        }\r\n+        else if (const auto colorOptional = Utils::ColorFromXTermColor(part))\r\n         {\r\n             newRgbs.push_back(colorOptional.value());\r\n         }\r\ndiff --git a/src/terminal/parser/ut_parser/OutputEngineTest.cpp b/src/terminal/parser/ut_parser/OutputEngineTest.cpp\nindex f19ad423fbc..8a5015e25cb 100644\n--- a/src/terminal/parser/ut_parser/OutputEngineTest.cpp\n+++ b/src/terminal/parser/ut_parser/OutputEngineTest.cpp\n@@ -1158,12 +1158,8 @@ class StatefulDispatch final : public TermDispatch\n         _numTabs{ 0 },\n         _tabClear{ false },\n         _tabClearTypes{},\n-        _setDefaultForeground(false),\n-        _defaultForegroundColor{ RGB(0, 0, 0) },\n-        _setDefaultBackground(false),\n-        _defaultBackgroundColor{ RGB(0, 0, 0) },\n-        _setDefaultCursorColor(false),\n-        _defaultCursorColor{ RGB(0, 0, 0) },\n+        _xtermResourcesChanged{},\n+        _xtermResourceValues{},\n         _hyperlinkMode{ false },\n         _options{ s_cMaxOptions, static_cast<DispatchTypes::GraphicsOptions>(s_uiGraphicsCleared) }, // fill with cleared option\n         _colorTable{},\n@@ -1432,24 +1428,22 @@ class StatefulDispatch final : public TermDispatch\n         return true;\n     }\n \n-    bool SetDefaultForeground(const DWORD color) noexcept override\n+    bool RequestColorTableEntry(const size_t tableIndex) noexcept override\n     {\n-        _setDefaultForeground = true;\n-        _defaultForegroundColor = color;\n+        _colorTableEntriesRequested.push_back(tableIndex);\n         return true;\n     }\n \n-    bool SetDefaultBackground(const DWORD color) noexcept override\n+    bool SetXtermColorResource(const size_t resource, const DWORD color) override\n     {\n-        _setDefaultBackground = true;\n-        _defaultBackgroundColor = color;\n+        _xtermResourcesChanged.push_back(resource);\n+        _xtermResourceValues.push_back(color);\n         return true;\n     }\n \n-    bool SetCursorColor(const DWORD color) noexcept override\n+    bool RequestXtermColorResource(const size_t resource) override\n     {\n-        _setDefaultCursorColor = true;\n-        _defaultCursorColor = color;\n+        _xtermResourcesRequested.push_back(resource);\n         return true;\n     }\n \n@@ -1529,13 +1523,11 @@ class StatefulDispatch final : public TermDispatch\n     size_t _numTabs;\n     bool _tabClear;\n     std::vector<DispatchTypes::TabClearType> _tabClearTypes;\n-    bool _setDefaultForeground;\n-    DWORD _defaultForegroundColor;\n-    bool _setDefaultBackground;\n-    DWORD _defaultBackgroundColor;\n-    bool _setDefaultCursorColor;\n-    DWORD _defaultCursorColor;\n+    std::vector<size_t> _xtermResourcesChanged;\n+    std::vector<DWORD> _xtermResourceValues;\n+    std::vector<size_t> _xtermResourcesRequested;\n     bool _setColorTableEntry;\n+    std::vector<size_t> _colorTableEntriesRequested;\n     bool _hyperlinkMode;\n     std::wstring _copyContent;\n     std::wstring _uri;\n@@ -2822,105 +2814,114 @@ class StateMachineExternalTest final\n \n         // Single param\n         mach.ProcessString(L\"\\033]10;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;rgb:12/34/56\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#123456\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Multiple params\n         mach.ProcessString(L\"\\033]10;#111;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;DarkOrange;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(3u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[2]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[2]);\n \n         pDispatch->ClearState();\n \n         // Partially valid multi-param sequences.\n         mach.ProcessString(L\"\\033]10;#111;\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;rgb:\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#111;#2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultForeground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultForegroundColor);\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#1;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Invalid sequences.\n         mach.ProcessString(L\"\\033]10;rgb:1/1/\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]10;#1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultForeground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n     }\n@@ -2933,100 +2934,115 @@ class StateMachineExternalTest final\n         StateMachine mach(std::move(engine));\n \n         mach.ProcessString(L\"\\033]11;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Single param\n         mach.ProcessString(L\"\\033]11;rgb:12/34/56\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#123456\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x12, 0x34, 0x56), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Multiple params\n         mach.ProcessString(L\"\\033]11;#111;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x22, 0x22, 0x22), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;DarkOrange\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;DarkOrange;rgb:2/2/2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n-        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_defaultCursorColor);\n-        // The third param is out of range.\n+        VERIFY_ARE_EQUAL(3u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[1]);\n+        VERIFY_ARE_EQUAL(13u, pDispatch->_xtermResourcesChanged[2]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(RGB(255, 140, 0), pDispatch->_xtermResourceValues[1]);\n+        // The third param is out of range, but it's technically still in compliance to set it\n \n         pDispatch->ClearState();\n \n         // Partially valid multi-param sequences.\n         mach.ProcessString(L\"\\033]11;#111;\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;rgb:\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#111;#2\\033\\\\\");\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultBackground);\n-        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_defaultBackgroundColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x10, 0x10, 0x10), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#1;rgb:1/1/1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n-        VERIFY_IS_TRUE(pDispatch->_setDefaultCursorColor);\n-        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_defaultCursorColor);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x11, 0x11), pDispatch->_xtermResourceValues[0]);\n \n         pDispatch->ClearState();\n \n         // Invalid sequences.\n         mach.ProcessString(L\"\\033]11;rgb:1/1/\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n \n         mach.ProcessString(L\"\\033]11;#1\\033\\\\\");\n-        VERIFY_IS_FALSE(pDispatch->_setDefaultBackground);\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n \n         pDispatch->ClearState();\n     }\n@@ -3178,6 +3194,88 @@ class StateMachineExternalTest final\n         pDispatch->ClearState();\n     }\n \n+    TEST_METHOD(TestOscGetColorTableEntry)\n+    {\n+        auto dispatch = std::make_unique<StatefulDispatch>();\n+        auto pDispatch = dispatch.get();\n+        auto engine = std::make_unique<OutputStateMachineEngine>(std::move(dispatch));\n+        StateMachine mach(std::move(engine));\n+\n+        mach.ProcessString(L\"\\033]4;0;?;1;?;2;;3;?;4;?\\033\\\\\"); // Inquire about 0-4 skipping 2\n+        VERIFY_ARE_EQUAL((std::vector<size_t>{ 0u, 1u, 3u, 4u }), pDispatch->_colorTableEntriesRequested);\n+        pDispatch->ClearState();\n+\n+        mach.ProcessString(L\"\\033]4;0;rgb:00/00/00;1;rgb:00/00/01;2;?;3;rgb:00/00/03;4;rgb:00/00/04\\033\\\\\"); // Set 0-4, except 2 (inquire)\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 0), pDispatch->_colorTable.at(0));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 1), pDispatch->_colorTable.at(1));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 3), pDispatch->_colorTable.at(3));\n+        VERIFY_ARE_EQUAL(RGB(0, 0, 4), pDispatch->_colorTable.at(4));\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested.size()); // note: (1u, 2u) constructs a 1-length vector containing 2\n+        VERIFY_ARE_EQUAL(2u, pDispatch->_colorTableEntriesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        pDispatch->_colorTable.at(3) = RGB(0xfe, 0xed, 0xfa);\n+        mach.ProcessString(L\"\\033]4;0;rgb:f0/00/00;1;?;3\\033\\\\\"); // Set 0, inquire 1, truncated 3\n+        VERIFY_ARE_EQUAL(RGB(0xf0, 0, 0), pDispatch->_colorTable.at(0));\n+        VERIFY_ARE_EQUAL(RGB(0xfe, 0xed, 0xfa), pDispatch->_colorTable.at(3)); // unchanged from before ProcessString\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested.size()); // note: (1u, 2u) constructs a 1-length vector containing 2\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_colorTableEntriesRequested[0]);\n+        pDispatch->ClearState();\n+    }\n+\n+    TEST_METHOD(TestOscXtermResourceReport)\n+    {\n+        auto dispatch = std::make_unique<StatefulDispatch>();\n+        auto pDispatch = dispatch.get();\n+        auto engine = std::make_unique<OutputStateMachineEngine>(std::move(dispatch));\n+        StateMachine mach(std::move(engine));\n+\n+        mach.ProcessString(L\"\\033]10;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, skip first\n+        mach.ProcessString(L\"\\033]10;;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, set first\n+        mach.ProcessString(L\"\\033]10;rgb:11/22/33;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(10u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x22, 0x33), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Two params, set first, starting at 12\n+        mach.ProcessString(L\"\\033]12;rgb:11/22/33;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(12u, pDispatch->_xtermResourcesChanged[0]);\n+        VERIFY_ARE_EQUAL(RGB(0x11, 0x22, 0x33), pDispatch->_xtermResourceValues[0]);\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(13u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+\n+        // Request all 10\n+        mach.ProcessString(L\"\\033]10;?;?;?;?;?;?;?;?;?;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        std::vector<size_t> expected{ 10u, 11u, 12u, 13u, 14u, 15u, 16u, 17u, 18u, 19u };\n+        VERIFY_ARE_EQUAL(expected, pDispatch->_xtermResourcesRequested);\n+        pDispatch->ClearState();\n+\n+        // Request out of range\n+        mach.ProcessString(L\"\\033]10;;?\\033\\\\\");\n+        VERIFY_ARE_EQUAL(0u, pDispatch->_xtermResourcesChanged.size());\n+        VERIFY_ARE_EQUAL(1u, pDispatch->_xtermResourcesRequested.size());\n+        VERIFY_ARE_EQUAL(11u, pDispatch->_xtermResourcesRequested[0]);\n+        pDispatch->ClearState();\n+    }\n+\n     TEST_METHOD(TestOscSetWindowTitle)\n     {\n         BEGIN_TEST_METHOD_PROPERTIES()\n", "instance_id": "microsoft__terminal-17729", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to support querying colors via OSC (Operating System Command) sequences in a terminal emulator, with examples provided for querying color values. It specifies the expected format of responses (rgb:RRRR/GGGG/BBBB notation) and mentions compatibility with xterm and other terminals. However, there are minor ambiguities and missing details. For instance, it does not explicitly define the full range of OSC commands to be supported beyond the examples (e.g., OSC 4, 10, 11), nor does it clarify the expected behavior for invalid or unsupported queries. Additionally, edge cases such as handling of invalid color indices or malformed input are not addressed. While the goal is understandable, these gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes is significant, spanning multiple files (e.g., adapter, parser, and test files) and requiring modifications to existing interfaces and logic for handling OSC sequences. This involves understanding and updating the terminal's color management system and dispatch mechanisms, which indicates a need for familiarity with the codebase's architecture. Second, the technical concepts involved include parsing OSC sequences, managing color tables, and handling color aliasing, which require a moderate understanding of terminal emulation protocols and C++ programming nuances (e.g., working with COLORREF, string formatting for responses). Third, the changes impact how color queries are processed and returned, necessitating careful handling of edge cases like invalid indices or unrepresentable colors, as seen in the test cases. While not overly complex, the problem requires integrating new functionality into an existing system with attention to detail across multiple components, justifying a score of 0.55. It is not hard enough to warrant a higher score, as it does not involve deep architectural refactoring or advanced algorithms, but it is beyond a simple bug fix or feature addition due to the cross-file impact and conceptual depth.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Cursor invalidation failing when line renditions are used\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a WSL bash shell\r\n2. Execute the following statement:\r\n   ```\r\n   printf \"\\ec\\e[999B\\n\\e[H\\e#6\\n\\e[1 q\"; read\r\n   ```\r\n3. Type some text and note whether the cursor is blinking.\r\n4. Backspace to the start of the line and check the cursor again.\r\n\n\n### Expected Behavior\n\nThe final escape sequence in that `printf` is a `DECSCUSR` command, setting the cursor style to a blinking block, so it should be blinking the whole time (except maybe when it's actually moving).\n\n### Actual Behavior\n\nThe cursor blinks at the start of the line, but doesn't blink in any other column. The issue isn't specifically related to blinking, though. It can also manifest as almost constant cursor \"droppings\", but this test case was the easiest to reproduce.\r\n\r\nAnd note that it also fails on openconsole/conhost if you've configured it to use the Atlas engine, so it's not a conpty issue, but it appears to be Atlas only.\r\n\r\nLine rendition has got something to do with it - the first line is set to double-width in this test - but it's not only the double-width line that is affected. And I think the scroll offset is also a factor, which is why this test case forces a linefeed at the bottom of the page.\r\n\r\nAs far as I can tell from a git bisect, it first broke in commit 20b0bed46df71c596b4fb68edfb6bb4b4ebf1c89 (PR #15500).\r\n\n", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 91e5772006e..c8ed8b28e7b 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -1178,8 +1178,8 @@ void Renderer::_invalidateCurrentCursor() const\n     const auto view = buffer.GetSize();\r\n     const auto coord = _currentCursorOptions.coordCursor;\r\n \r\n-    const auto lineRendition = buffer.GetLineRendition(coord.y);\r\n-    const auto cursorWidth = _pData->IsCursorDoubleWidth() ? 2 : 1;\r\n+    const auto lineRendition = _currentCursorOptions.lineRendition;\r\n+    const auto cursorWidth = _currentCursorOptions.fIsDoubleWidth ? 2 : 1;\r\n \r\n     til::rect rect{ coord.x, coord.y, coord.x + cursorWidth, coord.y + 1 };\r\n     rect = BufferToScreenLine(rect, lineRendition);\r\n", "instance_id": "microsoft__terminal-17234", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue of cursor invalidation failing when line renditions are used in Windows Terminal. It provides specific steps to reproduce the issue, including a test command, and clearly states the expected and actual behavior of the cursor. Additionally, it identifies relevant factors such as line rendition (double-width lines) and scroll offset, and even points to a specific commit where the issue was introduced. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define what \"cursor droppings\" means in a technical context, and it lacks detailed information on the expected behavior across different terminal configurations or edge cases beyond the provided test case. While the issue is tied to the Atlas engine, there is no deeper explanation of why or how line rendition and scroll offset interact to cause the problem, which could be critical for a complete understanding.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively small, as it involves a targeted modification in a single file (`renderer.cpp`) with just a couple of lines changed to use cursor-specific options for line rendition and width instead of buffer data. This suggests a focused fix rather than a broad architectural change. However, understanding the issue requires knowledge of terminal rendering logic, specifically how cursor positioning and line renditions (like double-width lines) interact within the Windows Terminal's rendering engine (Atlas). It also demands familiarity with the codebase's internal data structures (e.g., `_currentCursorOptions`) and how they relate to the buffer state. While the change itself is simple, identifying the root cause likely involved debugging complex interactions between cursor state, line rendition, and screen coordinates, as hinted by the git bisect reference in the problem statement. There are no explicit edge cases mentioned beyond the test case, but the nature of terminal rendering implies potential challenges with different cursor styles, terminal sizes, or line rendition modes that might need consideration. Overall, this problem requires a moderate depth of understanding of the rendering subsystem but does not appear to impact the broader architecture or necessitate advanced domain-specific knowledge beyond terminal emulation, placing it at the lower end of medium difficulty.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Copy with Control Sequences\n# Description of the new feature/enhancement\r\nOption to copy text from the terminal with ANSI sequences. Useful when you need to copy styled output to another file like a markdown codefence with ansi-support (ex. https://github.com/expressive-code/expressive-code/pull/29)\r\n\r\nSee similar option in [iTerm2](https://iterm2.com/documentation-menu-items.html): Edit > Copy with Control Sequences\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nA new \"Copy with Control Sequences\" command that includes escape sequences in the copied text. Either include original ANSI-sequences if possible or recreate (best-effort) like iTerm2.\n", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..478c75129b4 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -879,6 +879,11 @@\n               \"default\": false,\n               \"description\": \"If true, the copied content will be copied as a single line (even if there are hard line breaks present in the text). If false, newlines persist from the selected text.\"\n             },\n+            \"withControlSequences\": {\n+              \"type\": \"boolean\",\n+              \"default\": false,\n+              \"description\": \"If true, copied content will contain ANSI escape code control sequences representing the styling of the content.\"\n+            },\n             \"dismissSelection\": {\n               \"type\": \"boolean\",\n               \"default\": true,\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex 802e48e7c3e..a920854b732 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1917,6 +1917,41 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n     return selectedText;\r\n }\r\n \r\n+// Retrieves the text data from the buffer *with* ANSI escape code control sequences and presents it in\r\n+//      a clipboard-ready format.\r\n+// Arguments:\r\n+// - req - the copy request having the bounds of the selected region and other related configuration flags.\r\n+// Return Value:\r\n+// - The text and control sequence data from the selected region of the text buffer. Empty if the copy request\r\n+//      is invalid.\r\n+std::wstring TextBuffer::GetWithControlSequences(const CopyRequest& req) const\r\n+{\r\n+    if (req.beg > req.end)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n+    std::wstring selectedText;\r\n+    std::optional<TextAttribute> previousTextAttr;\r\n+    bool delayedLineBreak = false;\r\n+\r\n+    const auto firstRow = req.beg.y;\r\n+    const auto lastRow = req.end.y;\r\n+\r\n+    for (til::CoordType currentRow = firstRow; currentRow <= lastRow; currentRow++)\r\n+    {\r\n+        const auto& row = GetRowByOffset(currentRow);\r\n+\r\n+        const auto [startX, endX, reqAddLineBreak] = _RowCopyHelper(req, currentRow, row);\r\n+        const bool isLastRow = currentRow == lastRow;\r\n+        const bool addLineBreak = reqAddLineBreak && !isLastRow;\r\n+\r\n+        _SerializeRow(row, startX, endX, addLineBreak, isLastRow, selectedText, previousTextAttr, delayedLineBreak);\r\n+    }\r\n+\r\n+    return selectedText;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Generates a CF_HTML compliant structure from the selected region of the buffer\r\n // Arguments:\r\n@@ -2348,7 +2383,7 @@ void TextBuffer::_AppendRTFText(std::string& contentBuilder, const std::wstring_\n     }\r\n }\r\n \r\n-void TextBuffer::Serialize(const wchar_t* destination) const\r\n+void TextBuffer::SerializeToPath(const wchar_t* destination) const\r\n {\r\n     const wil::unique_handle file{ CreateFileW(destination, GENERIC_WRITE, FILE_SHARE_READ | FILE_SHARE_DELETE, nullptr, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, nullptr) };\r\n     THROW_LAST_ERROR_IF(!file);\r\n@@ -2358,279 +2393,318 @@ void TextBuffer::Serialize(const wchar_t* destination) const\n     buffer.reserve(writeThreshold + writeThreshold / 2);\r\n     buffer.push_back(L'\\uFEFF');\r\n \r\n-    const til::CoordType lastRowWithText = GetLastNonSpaceCharacter(nullptr).y;\r\n-    CharacterAttributes previousAttr = CharacterAttributes::Unused1;\r\n-    TextColor previousFg;\r\n-    TextColor previousBg;\r\n-    TextColor previousUl;\r\n-    uint16_t previousHyperlinkId = 0;\r\n+    std::optional<TextAttribute> previousTextAttr;\r\n     bool delayedLineBreak = false;\r\n \r\n+    const til::CoordType firstRow = 0;\r\n+    const til::CoordType lastRow = GetLastNonSpaceCharacter(nullptr).y;\r\n+\r\n     // This iterates through each row. The exit condition is at the end\r\n     // of the for() loop so that we can properly handle file flushing.\r\n-    for (til::CoordType currentRow = 0;; currentRow++)\r\n+    for (til::CoordType currentRow = firstRow;; currentRow++)\r\n     {\r\n         const auto& row = GetRowByOffset(currentRow);\r\n \r\n-        if (const auto lr = row.GetLineRendition(); lr != LineRendition::SingleWidth)\r\n+        const auto isLastRow = currentRow == lastRow;\r\n+        const auto startX = 0;\r\n+        const auto endX = row.GetReadableColumnCount();\r\n+        const bool addLineBreak = !row.WasWrapForced() || isLastRow;\r\n+\r\n+        _SerializeRow(row, startX, endX, addLineBreak, isLastRow, buffer, previousTextAttr, delayedLineBreak);\r\n+\r\n+        if (buffer.size() >= writeThreshold || isLastRow)\r\n         {\r\n-            static constexpr std::wstring_view mappings[] = {\r\n-                L\"\\x1b#6\", // LineRendition::DoubleWidth\r\n-                L\"\\x1b#3\", // LineRendition::DoubleHeightTop\r\n-                L\"\\x1b#4\", // LineRendition::DoubleHeightBottom\r\n-            };\r\n-            const auto idx = std::clamp(static_cast<int>(lr) - 1, 0, 2);\r\n-            buffer.append(til::at(mappings, idx));\r\n+            const auto fileSize = gsl::narrow<DWORD>(buffer.size() * sizeof(wchar_t));\r\n+            DWORD bytesWritten = 0;\r\n+            THROW_IF_WIN32_BOOL_FALSE(WriteFile(file.get(), buffer.data(), fileSize, &bytesWritten, nullptr));\r\n+            THROW_WIN32_IF_MSG(ERROR_WRITE_FAULT, bytesWritten != fileSize, \"failed to write\");\r\n+            buffer.clear();\r\n         }\r\n \r\n-        const auto& runs = row.Attributes().runs();\r\n-        const auto beg = runs.begin();\r\n-        const auto end = runs.end();\r\n-        auto it = beg;\r\n-        const auto last = end - 1;\r\n-        const auto lastCharX = row.MeasureRight();\r\n-        til::CoordType oldX = 0;\r\n-\r\n-        for (; it != end; ++it)\r\n+        if (isLastRow)\r\n         {\r\n-            const auto attr = it->value.GetCharacterAttributes();\r\n-            const auto hyperlinkId = it->value.GetHyperlinkId();\r\n-            const auto fg = it->value.GetForeground();\r\n-            const auto bg = it->value.GetBackground();\r\n-            const auto ul = it->value.GetUnderlineColor();\r\n+            break;\r\n+        }\r\n+    }\r\n+}\r\n \r\n-            if (previousAttr != attr)\r\n-            {\r\n-                auto attrDelta = attr ^ previousAttr;\r\n-\r\n-                // There's no escape sequence that only turns off either bold/intense or dim/faint. SGR 22 turns off both.\r\n-                // This results in two issues in our generic \"Mapping\" code below. Assuming, both Intense and Faint were on...\r\n-                // * ...and either turned off, it would emit SGR 22 which turns both attributes off = Wrong.\r\n-                // * ...and both are now off, it would emit SGR 22 twice.\r\n-                //\r\n-                // This extra branch takes care of both issues. If both attributes turned off it'll emit a single \\x1b[22m,\r\n-                // if faint turned off \\x1b[22;1m (intense is still on), and \\x1b[22;2m if intense turned off (vice versa).\r\n-                if (WI_AreAllFlagsSet(previousAttr, CharacterAttributes::Intense | CharacterAttributes::Faint) &&\r\n-                    WI_IsAnyFlagSet(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n-                {\r\n-                    wchar_t buf[8] = L\"\\x1b[22m\";\r\n-                    size_t len = 5;\r\n+// Serializes one row of the text buffer including ANSI escape code control sequences.\r\n+// Arguments:\r\n+// - row - A reference to the row being serialized.\r\n+// - startX - The first column (inclusive) to include in the serialized content.\r\n+// - endX - The last column (exclusive) to include in the serialized content.\r\n+// - addLineBreak - Whether to add a line break at the end of the serialized row.\r\n+// - isLastRow - Whether this is the final row to be serialized.\r\n+// - buffer - A string to write the serialized row into.\r\n+// - previousTextAttr - Used for tracking state across multiple calls to `_SerializeRow` for sequential rows.\r\n+//      The value will be mutated by the call. The initial call should contain `nullopt`, and subsequent calls\r\n+//      should pass the value that was written by the previous call.\r\n+// - delayedLineBreak - Similarly used for tracking state across multiple calls, and similarly will be mutated\r\n+//      by the call. The initial call should pass `false` and subsequent calls should pass the value that was\r\n+//      written by the previous call.\r\n+void TextBuffer::_SerializeRow(const ROW& row, const til::CoordType startX, const til::CoordType endX, const bool addLineBreak, const bool isLastRow, std::wstring& buffer, std::optional<TextAttribute>& previousTextAttr, bool& delayedLineBreak) const\r\n+{\r\n+    if (const auto lr = row.GetLineRendition(); lr != LineRendition::SingleWidth)\r\n+    {\r\n+        static constexpr std::wstring_view mappings[] = {\r\n+            L\"\\x1b#6\", // LineRendition::DoubleWidth\r\n+            L\"\\x1b#3\", // LineRendition::DoubleHeightTop\r\n+            L\"\\x1b#4\", // LineRendition::DoubleHeightBottom\r\n+        };\r\n+        const auto idx = std::clamp(static_cast<int>(lr) - 1, 0, 2);\r\n+        buffer.append(til::at(mappings, idx));\r\n+    }\r\n \r\n-                    if (WI_IsAnyFlagSet(attr, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n-                    {\r\n-                        buf[4] = L';';\r\n-                        buf[5] = WI_IsAnyFlagSet(attr, CharacterAttributes::Intense) ? L'1' : L'2';\r\n-                        buf[6] = L'm';\r\n-                        len = 7;\r\n-                    }\r\n+    const auto startXU16 = gsl::narrow_cast<uint16_t>(startX);\r\n+    const auto endXU16 = gsl::narrow_cast<uint16_t>(endX);\r\n+    const auto runs = row.Attributes().slice(startXU16, endXU16).runs();\r\n \r\n-                    buffer.append(&buf[0], len);\r\n-                    WI_ClearAllFlags(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint);\r\n-                }\r\n+    const auto beg = runs.begin();\r\n+    const auto end = runs.end();\r\n+    auto it = beg;\r\n+    // Don't try to get `end - 1` if it's an empty iterator; in this case we're going to ignore the `last`\r\n+    // value anyway so just use `end`.\r\n+    const auto last = it == end ? end : end - 1;\r\n+    const auto lastCharX = row.MeasureRight();\r\n+    til::CoordType oldX = startX;\r\n+\r\n+    for (; it != end; ++it)\r\n+    {\r\n+        const auto effectivePreviousTextAttr = previousTextAttr.value_or(TextAttribute{ CharacterAttributes::Unused1, TextColor{}, TextColor{}, 0, TextColor{} });\r\n+        const auto previousAttr = effectivePreviousTextAttr.GetCharacterAttributes();\r\n+        const auto previousHyperlinkId = effectivePreviousTextAttr.GetHyperlinkId();\r\n+        const auto previousFg = effectivePreviousTextAttr.GetForeground();\r\n+        const auto previousBg = effectivePreviousTextAttr.GetBackground();\r\n+        const auto previousUl = effectivePreviousTextAttr.GetUnderlineColor();\r\n+\r\n+        const auto attr = it->value.GetCharacterAttributes();\r\n+        const auto hyperlinkId = it->value.GetHyperlinkId();\r\n+        const auto fg = it->value.GetForeground();\r\n+        const auto bg = it->value.GetBackground();\r\n+        const auto ul = it->value.GetUnderlineColor();\r\n+\r\n+        if (previousAttr != attr)\r\n+        {\r\n+            auto attrDelta = attr ^ previousAttr;\r\n \r\n-                {\r\n-                    struct Mapping\r\n-                    {\r\n-                        CharacterAttributes attr;\r\n-                        uint8_t change[2]; // [0] = off, [1] = on\r\n-                    };\r\n-                    static constexpr Mapping mappings[] = {\r\n-                        { CharacterAttributes::Intense, { 22, 1 } },\r\n-                        { CharacterAttributes::Italics, { 23, 3 } },\r\n-                        { CharacterAttributes::Blinking, { 25, 5 } },\r\n-                        { CharacterAttributes::Invisible, { 28, 8 } },\r\n-                        { CharacterAttributes::CrossedOut, { 29, 9 } },\r\n-                        { CharacterAttributes::Faint, { 22, 2 } },\r\n-                        { CharacterAttributes::TopGridline, { 55, 53 } },\r\n-                        { CharacterAttributes::ReverseVideo, { 27, 7 } },\r\n-                    };\r\n-                    for (const auto& mapping : mappings)\r\n-                    {\r\n-                        if (WI_IsAnyFlagSet(attrDelta, mapping.attr))\r\n-                        {\r\n-                            const auto n = til::at(mapping.change, WI_IsAnyFlagSet(attr, mapping.attr));\r\n-                            fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), n);\r\n-                        }\r\n-                    }\r\n-                }\r\n+            // There's no escape sequence that only turns off either bold/intense or dim/faint. SGR 22 turns off both.\r\n+            // This results in two issues in our generic \"Mapping\" code below. Assuming, both Intense and Faint were on...\r\n+            // * ...and either turned off, it would emit SGR 22 which turns both attributes off = Wrong.\r\n+            // * ...and both are now off, it would emit SGR 22 twice.\r\n+            //\r\n+            // This extra branch takes care of both issues. If both attributes turned off it'll emit a single \\x1b[22m,\r\n+            // if faint turned off \\x1b[22;1m (intense is still on), and \\x1b[22;2m if intense turned off (vice versa).\r\n+            if (WI_AreAllFlagsSet(previousAttr, CharacterAttributes::Intense | CharacterAttributes::Faint) &&\r\n+                WI_IsAnyFlagSet(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n+            {\r\n+                wchar_t buf[8] = L\"\\x1b[22m\";\r\n+                size_t len = 5;\r\n \r\n-                if (WI_IsAnyFlagSet(attrDelta, CharacterAttributes::UnderlineStyle))\r\n+                if (WI_IsAnyFlagSet(attr, CharacterAttributes::Intense | CharacterAttributes::Faint))\r\n                 {\r\n-                    static constexpr std::wstring_view mappings[] = {\r\n-                        L\"\\x1b[24m\", // UnderlineStyle::NoUnderline\r\n-                        L\"\\x1b[4m\", // UnderlineStyle::SinglyUnderlined\r\n-                        L\"\\x1b[21m\", // UnderlineStyle::DoublyUnderlined\r\n-                        L\"\\x1b[4:3m\", // UnderlineStyle::CurlyUnderlined\r\n-                        L\"\\x1b[4:4m\", // UnderlineStyle::DottedUnderlined\r\n-                        L\"\\x1b[4:5m\", // UnderlineStyle::DashedUnderlined\r\n-                    };\r\n-\r\n-                    auto idx = WI_EnumValue(it->value.GetUnderlineStyle());\r\n-                    if (idx >= std::size(mappings))\r\n-                    {\r\n-                        idx = 1; // UnderlineStyle::SinglyUnderlined\r\n-                    }\r\n-\r\n-                    buffer.append(til::at(mappings, idx));\r\n+                    buf[4] = L';';\r\n+                    buf[5] = WI_IsAnyFlagSet(attr, CharacterAttributes::Intense) ? L'1' : L'2';\r\n+                    buf[6] = L'm';\r\n+                    len = 7;\r\n                 }\r\n \r\n-                previousAttr = attr;\r\n+                buffer.append(&buf[0], len);\r\n+                WI_ClearAllFlags(attrDelta, CharacterAttributes::Intense | CharacterAttributes::Faint);\r\n             }\r\n \r\n-            if (previousFg != fg)\r\n             {\r\n-                switch (fg.GetType())\r\n+                struct Mapping\r\n                 {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[39m\");\r\n-                    break;\r\n-                case ColorType::IsIndex16:\r\n+                    CharacterAttributes attr;\r\n+                    uint8_t change[2]; // [0] = off, [1] = on\r\n+                };\r\n+                static constexpr Mapping mappings[] = {\r\n+                    { CharacterAttributes::Intense, { 22, 1 } },\r\n+                    { CharacterAttributes::Italics, { 23, 3 } },\r\n+                    { CharacterAttributes::Blinking, { 25, 5 } },\r\n+                    { CharacterAttributes::Invisible, { 28, 8 } },\r\n+                    { CharacterAttributes::CrossedOut, { 29, 9 } },\r\n+                    { CharacterAttributes::Faint, { 22, 2 } },\r\n+                    { CharacterAttributes::TopGridline, { 55, 53 } },\r\n+                    { CharacterAttributes::ReverseVideo, { 27, 7 } },\r\n+                };\r\n+                for (const auto& mapping : mappings)\r\n                 {\r\n-                    uint8_t index = WI_IsFlagSet(fg.GetIndex(), 8) ? 90 : 30;\r\n-                    index += fg.GetIndex() & 7;\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n-                    break;\r\n-                }\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;5;{}m\"), fg.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;2;{};{};{}m\"), fg.GetR(), fg.GetG(), fg.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n+                    if (WI_IsAnyFlagSet(attrDelta, mapping.attr))\r\n+                    {\r\n+                        const auto n = til::at(mapping.change, WI_IsAnyFlagSet(attr, mapping.attr));\r\n+                        fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), n);\r\n+                    }\r\n                 }\r\n-                previousFg = fg;\r\n             }\r\n \r\n-            if (previousBg != bg)\r\n+            if (WI_IsAnyFlagSet(attrDelta, CharacterAttributes::UnderlineStyle))\r\n             {\r\n-                switch (bg.GetType())\r\n-                {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[49m\");\r\n-                    break;\r\n-                case ColorType::IsIndex16:\r\n+                static constexpr std::wstring_view mappings[] = {\r\n+                    L\"\\x1b[24m\", // UnderlineStyle::NoUnderline\r\n+                    L\"\\x1b[4m\", // UnderlineStyle::SinglyUnderlined\r\n+                    L\"\\x1b[21m\", // UnderlineStyle::DoublyUnderlined\r\n+                    L\"\\x1b[4:3m\", // UnderlineStyle::CurlyUnderlined\r\n+                    L\"\\x1b[4:4m\", // UnderlineStyle::DottedUnderlined\r\n+                    L\"\\x1b[4:5m\", // UnderlineStyle::DashedUnderlined\r\n+                };\r\n+\r\n+                auto idx = WI_EnumValue(it->value.GetUnderlineStyle());\r\n+                if (idx >= std::size(mappings))\r\n                 {\r\n-                    uint8_t index = WI_IsFlagSet(bg.GetIndex(), 8) ? 100 : 40;\r\n-                    index += bg.GetIndex() & 7;\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n-                    break;\r\n-                }\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;5;{}m\"), bg.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;2;{};{};{}m\"), bg.GetR(), bg.GetG(), bg.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n+                    idx = 1; // UnderlineStyle::SinglyUnderlined\r\n                 }\r\n-                previousBg = bg;\r\n+\r\n+                buffer.append(til::at(mappings, idx));\r\n             }\r\n+        }\r\n \r\n-            if (previousUl != ul)\r\n+        if (previousFg != fg)\r\n+        {\r\n+            switch (fg.GetType())\r\n             {\r\n-                switch (fg.GetType())\r\n-                {\r\n-                case ColorType::IsDefault:\r\n-                    buffer.append(L\"\\x1b[59m\");\r\n-                    break;\r\n-                case ColorType::IsIndex256:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:5:{}m\"), ul.GetIndex());\r\n-                    break;\r\n-                case ColorType::IsRgb:\r\n-                    fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:2::{}:{}:{}m\"), ul.GetR(), ul.GetG(), ul.GetB());\r\n-                    break;\r\n-                default:\r\n-                    break;\r\n-                }\r\n-                previousUl = ul;\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[39m\");\r\n+                break;\r\n+            case ColorType::IsIndex16:\r\n+            {\r\n+                uint8_t index = WI_IsFlagSet(fg.GetIndex(), 8) ? 90 : 30;\r\n+                index += fg.GetIndex() & 7;\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n+                break;\r\n             }\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;5;{}m\"), fg.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[38;2;{};{};{}m\"), fg.GetR(), fg.GetG(), fg.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n+            }\r\n+        }\r\n \r\n-            if (previousHyperlinkId != hyperlinkId)\r\n+        if (previousBg != bg)\r\n+        {\r\n+            switch (bg.GetType())\r\n             {\r\n-                if (hyperlinkId)\r\n-                {\r\n-                    const auto uri = GetHyperlinkUriFromId(hyperlinkId);\r\n-                    if (!uri.empty())\r\n-                    {\r\n-                        buffer.append(L\"\\x1b]8;;\");\r\n-                        buffer.append(uri);\r\n-                        buffer.append(L\"\\x1b\\\\\");\r\n-                        previousHyperlinkId = hyperlinkId;\r\n-                    }\r\n-                }\r\n-                else\r\n-                {\r\n-                    buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n-                    previousHyperlinkId = 0;\r\n-                }\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[49m\");\r\n+                break;\r\n+            case ColorType::IsIndex16:\r\n+            {\r\n+                uint8_t index = WI_IsFlagSet(bg.GetIndex(), 8) ? 100 : 40;\r\n+                index += bg.GetIndex() & 7;\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[{}m\"), index);\r\n+                break;\r\n             }\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;5;{}m\"), bg.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[48;2;{};{};{}m\"), bg.GetR(), bg.GetG(), bg.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n+            }\r\n+        }\r\n \r\n-            // Initially, the buffer is initialized with the default attributes, but once it begins to scroll,\r\n-            // newly scrolled in rows are initialized with the current attributes. This means we need to set\r\n-            // the current attributes to those of the upcoming row before the row comes up. Or inversely:\r\n-            // We let the row come up, let it set its attributes and only then print the newline.\r\n-            if (delayedLineBreak)\r\n+        if (previousUl != ul)\r\n+        {\r\n+            switch (fg.GetType())\r\n             {\r\n-                buffer.append(L\"\\r\\n\");\r\n-                delayedLineBreak = false;\r\n+            case ColorType::IsDefault:\r\n+                buffer.append(L\"\\x1b[59m\");\r\n+                break;\r\n+            case ColorType::IsIndex256:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:5:{}m\"), ul.GetIndex());\r\n+                break;\r\n+            case ColorType::IsRgb:\r\n+                fmt::format_to(std::back_inserter(buffer), FMT_COMPILE(L\"\\x1b[58:2::{}:{}:{}m\"), ul.GetR(), ul.GetG(), ul.GetB());\r\n+                break;\r\n+            default:\r\n+                break;\r\n             }\r\n+        }\r\n \r\n-            auto newX = oldX + it->length;\r\n-\r\n-            // Since our text buffer doesn't store the original input text, the information over the amount of trailing\r\n-            // whitespaces was lost. If we don't do anything here then a row that just says \"Hello\" would be serialized\r\n-            // to \"Hello                    ...\". If the user restores the buffer dump with a different window size,\r\n-            // this would result in some fairly ugly reflow. This code attempts to at least trim trailing whitespaces.\r\n-            //\r\n-            // As mentioned above for `delayedLineBreak`, rows are initialized with their first attribute, BUT\r\n-            // only if the viewport has begun to scroll. Otherwise, they're initialized with the default attributes.\r\n-            // In other words, we can only skip \\x1b[K = Erase in Line, if both the first/last attribute are the default attribute.\r\n-            static constexpr TextAttribute defaultAttr;\r\n-            const auto trimTrailingWhitespaces = it == last && lastCharX < newX;\r\n-            const auto clearToEndOfLine = trimTrailingWhitespaces && (beg->value != defaultAttr || last->value != defaultAttr);\r\n-\r\n-            if (trimTrailingWhitespaces)\r\n+        if (previousHyperlinkId != hyperlinkId)\r\n+        {\r\n+            if (hyperlinkId)\r\n             {\r\n-                newX = lastCharX;\r\n+                const auto uri = GetHyperlinkUriFromId(hyperlinkId);\r\n+                if (!uri.empty())\r\n+                {\r\n+                    buffer.append(L\"\\x1b]8;;\");\r\n+                    buffer.append(uri);\r\n+                    buffer.append(L\"\\x1b\\\\\");\r\n+                }\r\n             }\r\n-\r\n-            buffer.append(row.GetText(oldX, newX));\r\n-\r\n-            if (clearToEndOfLine)\r\n+            else\r\n             {\r\n-                buffer.append(L\"\\x1b[K\");\r\n+                buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n             }\r\n+        }\r\n \r\n-            oldX = newX;\r\n+        previousTextAttr = it->value;\r\n+\r\n+        // Initially, the buffer is initialized with the default attributes, but once it begins to scroll,\r\n+        // newly scrolled in rows are initialized with the current attributes. This means we need to set\r\n+        // the current attributes to those of the upcoming row before the row comes up. Or inversely:\r\n+        // We let the row come up, let it set its attributes and only then print the newline.\r\n+        if (delayedLineBreak)\r\n+        {\r\n+            buffer.append(L\"\\r\\n\");\r\n+            delayedLineBreak = false;\r\n         }\r\n \r\n-        const auto moreRowsRemaining = currentRow < lastRowWithText;\r\n-        delayedLineBreak = !row.WasWrapForced();\r\n+        auto newX = oldX + it->length;\r\n \r\n-        if (!moreRowsRemaining)\r\n+        // Since our text buffer doesn't store the original input text, the information over the amount of trailing\r\n+        // whitespaces was lost. If we don't do anything here then a row that just says \"Hello\" would be serialized\r\n+        // to \"Hello                    ...\". If the user restores the buffer dump with a different window size,\r\n+        // this would result in some fairly ugly reflow. This code attempts to at least trim trailing whitespaces.\r\n+        //\r\n+        // As mentioned above for `delayedLineBreak`, rows are initialized with their first attribute, BUT\r\n+        // only if the viewport has begun to scroll. Otherwise, they're initialized with the default attributes.\r\n+        // In other words, we can only skip \\x1b[K = Erase in Line, if both the first/last attribute are the default attribute.\r\n+        static constexpr TextAttribute defaultAttr;\r\n+        const auto trimTrailingWhitespaces = it == last && lastCharX < newX;\r\n+        const auto clearToEndOfLine = trimTrailingWhitespaces && (beg->value != defaultAttr || last->value != defaultAttr);\r\n+\r\n+        if (trimTrailingWhitespaces)\r\n         {\r\n-            if (previousHyperlinkId)\r\n-            {\r\n-                buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n-            }\r\n-            buffer.append(L\"\\x1b[m\\r\\n\");\r\n+            newX = lastCharX;\r\n         }\r\n \r\n-        if (buffer.size() >= writeThreshold || !moreRowsRemaining)\r\n+        buffer.append(row.GetText(oldX, newX));\r\n+\r\n+        if (clearToEndOfLine)\r\n         {\r\n-            const auto fileSize = gsl::narrow<DWORD>(buffer.size() * sizeof(wchar_t));\r\n-            DWORD bytesWritten = 0;\r\n-            THROW_IF_WIN32_BOOL_FALSE(WriteFile(file.get(), buffer.data(), fileSize, &bytesWritten, nullptr));\r\n-            THROW_WIN32_IF_MSG(ERROR_WRITE_FAULT, bytesWritten != fileSize, \"failed to write\");\r\n-            buffer.clear();\r\n+            buffer.append(L\"\\x1b[K\");\r\n         }\r\n \r\n-        if (!moreRowsRemaining)\r\n+        oldX = newX;\r\n+    }\r\n+\r\n+    // Handle empty rows (with no runs). See above for more details about `delayedLineBreak`.\r\n+    if (delayedLineBreak)\r\n+    {\r\n+        buffer.append(L\"\\r\\n\");\r\n+        delayedLineBreak = false;\r\n+    }\r\n+\r\n+    delayedLineBreak = !row.WasWrapForced() && addLineBreak;\r\n+\r\n+    if (isLastRow)\r\n+    {\r\n+        if (previousTextAttr.has_value() && previousTextAttr->GetHyperlinkId())\r\n         {\r\n-            break;\r\n+            buffer.append(L\"\\x1b]8;;\\x1b\\\\\");\r\n+        }\r\n+        buffer.append(L\"\\x1b[0m\");\r\n+        if (addLineBreak)\r\n+        {\r\n+            buffer.append(L\"\\r\\n\");\r\n         }\r\n     }\r\n }\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex a39ebd4db40..c97de9e7523 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -266,6 +266,8 @@ class TextBuffer final\n \r\n     std::wstring GetPlainText(const CopyRequest& req) const;\r\n \r\n+    std::wstring GetWithControlSequences(const CopyRequest& req) const;\r\n+\r\n     std::string GenHTML(const CopyRequest& req,\r\n                         const int fontHeightPoints,\r\n                         const std::wstring_view fontFaceName,\r\n@@ -280,7 +282,7 @@ class TextBuffer final\n                        const bool isIntenseBold,\r\n                        std::function<std::tuple<COLORREF, COLORREF, COLORREF>(const TextAttribute&)> GetAttributeColors) const noexcept;\r\n \r\n-    void Serialize(const wchar_t* destination) const;\r\n+    void SerializeToPath(const wchar_t* destination) const;\r\n \r\n     struct PositionInformation\r\n     {\r\n@@ -332,6 +334,8 @@ class TextBuffer final\n \r\n     std::tuple<til::CoordType, til::CoordType, bool> _RowCopyHelper(const CopyRequest& req, const til::CoordType iRow, const ROW& row) const;\r\n \r\n+    void _SerializeRow(const ROW& row, const til::CoordType startX, const til::CoordType endX, const bool addLineBreak, const bool isLastRow, std::wstring& buffer, std::optional<TextAttribute>& previousTextAttr, bool& delayedLineBreak) const;\r\n+\r\n     static void _AppendRTFText(std::string& contentBuilder, const std::wstring_view& text);\r\n \r\n     Microsoft::Console::Render::Renderer* _renderer = nullptr;\r\ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 8675fb98bac..0bfbcff8ad7 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -548,7 +548,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         if (const auto& realArgs = args.ActionArgs().try_as<CopyTextArgs>())\r\n         {\r\n-            const auto handled = _CopyText(realArgs.DismissSelection(), realArgs.SingleLine(), realArgs.CopyFormatting());\r\n+            const auto handled = _CopyText(realArgs.DismissSelection(), realArgs.SingleLine(), realArgs.WithControlSequences(), realArgs.CopyFormatting());\r\n             args.Handled(handled);\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..13391e44f42 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -2971,14 +2971,15 @@ namespace winrt::TerminalApp::implementation\n     // Arguments:\n     // - dismissSelection: if not enabled, copying text doesn't dismiss the selection\n     // - singleLine: if enabled, copy contents as a single line of text\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\n     // - formats: dictate which formats need to be copied\n     // Return Value:\n     // - true iff we we able to copy text (if a selection was active)\n-    bool TerminalPage::_CopyText(const bool dismissSelection, const bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats)\n+    bool TerminalPage::_CopyText(const bool dismissSelection, const bool singleLine, const bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats)\n     {\n         if (const auto& control{ _GetActiveControl() })\n         {\n-            return control.CopySelectionToClipboard(dismissSelection, singleLine, formats);\n+            return control.CopySelectionToClipboard(dismissSelection, singleLine, withControlSequences, formats);\n         }\n         return false;\n     }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..28ccfd8ec8c 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -429,7 +429,7 @@ namespace winrt::TerminalApp::implementation\n         bool _IsUriSupported(const winrt::Windows::Foundation::Uri& parsedUri);\n \n         void _ShowCouldNotOpenDialog(winrt::hstring reason, winrt::hstring uri);\n-        bool _CopyText(const bool dismissSelection, const bool singleLine, const Windows::Foundation::IReference<Microsoft::Terminal::Control::CopyFormat>& formats);\n+        bool _CopyText(const bool dismissSelection, const bool singleLine, const bool withControlSequences, const Windows::Foundation::IReference<Microsoft::Terminal::Control::CopyFormat>& formats);\n \n         safe_void_coroutine _SetTaskbarProgressHandler(const IInspectable sender, const IInspectable eventArgs);\n \ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex 9cc7732f452..d7beb39a504 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -574,7 +574,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             else if (vkey == VK_RETURN && !mods.IsCtrlPressed() && !mods.IsAltPressed())\r\n             {\r\n                 // [Shift +] Enter --> copy text\r\n-                CopySelectionToClipboard(mods.IsShiftPressed(), nullptr);\r\n+                CopySelectionToClipboard(mods.IsShiftPressed(), false, nullptr);\r\n                 _terminal->ClearSelection();\r\n                 _updateSelectionUI();\r\n                 return true;\r\n@@ -1315,9 +1315,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     //     Windows Clipboard (CascadiaWin32:main.cpp).\r\n     // Arguments:\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n     bool ControlCore::CopySelectionToClipboard(bool singleLine,\r\n+                                               bool withControlSequences,\r\n                                                const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         ::Microsoft::Terminal::Core::Terminal::TextCopyData payload;\r\n@@ -1339,7 +1341,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n             // extract text from buffer\r\n             // RetrieveSelectedTextFromBuffer will lock while it's reading\r\n-            payload = _terminal->RetrieveSelectedTextFromBuffer(singleLine, copyHtml, copyRtf);\r\n+            payload = _terminal->RetrieveSelectedTextFromBuffer(singleLine, withControlSequences, copyHtml, copyRtf);\r\n         }\r\n \r\n         copyToClipboard(payload.plainText, payload.html, payload.rtf);\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 1719f34c880..609aed42834 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -123,7 +123,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         void SendInput(std::wstring_view wstr);\r\n         void PasteText(const winrt::hstring& hstr);\r\n-        bool CopySelectionToClipboard(bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n+        bool CopySelectionToClipboard(bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void SelectAll();\r\n         void ClearSelection();\r\n         bool ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex f18851c2fbb..c99d69ae6a4 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -194,9 +194,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     //     Windows Clipboard (CascadiaWin32:main.cpp).\r\n     // Arguments:\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n     bool ControlInteractivity::CopySelectionToClipboard(bool singleLine,\r\n+                                                        bool withControlSequences,\r\n                                                         const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         if (_core)\r\n@@ -213,7 +215,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             // Mark the current selection as copied\r\n             _selectionNeedsToBeCopied = false;\r\n \r\n-            return _core->CopySelectionToClipboard(singleLine, formats);\r\n+            return _core->CopySelectionToClipboard(singleLine, withControlSequences, formats);\r\n         }\r\n \r\n         return false;\r\n@@ -312,7 +314,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             else\r\n             {\r\n                 // Try to copy the text and clear the selection\r\n-                const auto successfulCopy = CopySelectionToClipboard(shiftEnabled, nullptr);\r\n+                const auto successfulCopy = CopySelectionToClipboard(shiftEnabled, false, nullptr);\r\n                 _core->ClearSelection();\r\n                 if (_core->CopyOnSelect() || !successfulCopy)\r\n                 {\r\n@@ -445,7 +447,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             // IMPORTANT!\r\n             // DO NOT clear the selection here!\r\n             // Otherwise, the selection will be cleared immediately after you make it.\r\n-            CopySelectionToClipboard(false, nullptr);\r\n+            CopySelectionToClipboard(false, false, nullptr);\r\n         }\r\n \r\n         _singleClickTouchdownPos = std::nullopt;\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 22eaa95c397..a1b3d7993cf 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -83,6 +83,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n #pragma endregion\r\n \r\n         bool CopySelectionToClipboard(bool singleLine,\r\n+                                      bool withControlSequences,\r\n                                       const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void RequestPasteTextFromClipboard();\r\n         void SetEndSelectionPoint(const Core::Point pixelPosition);\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.idl b/src/cascadia/TerminalControl/ControlInteractivity.idl\nindex 926c1e3b0a9..dcc2b793420 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.idl\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.idl\n@@ -32,7 +32,7 @@ namespace Microsoft.Terminal.Control\n \r\n         InteractivityAutomationPeer OnCreateAutomationPeer();\r\n \r\n-        Boolean CopySelectionToClipboard(Boolean singleLine, Windows.Foundation.IReference<CopyFormat> formats);\r\n+        Boolean CopySelectionToClipboard(Boolean singleLine, Boolean withControlSequences, Windows.Foundation.IReference<CopyFormat> formats);\r\n         void RequestPasteTextFromClipboard();\r\n         void SetEndSelectionPoint(Microsoft.Terminal.Core.Point point);\r\n \r\ndiff --git a/src/cascadia/TerminalControl/HwndTerminal.cpp b/src/cascadia/TerminalControl/HwndTerminal.cpp\nindex 905de2ce988..b3cc4edf688 100644\n--- a/src/cascadia/TerminalControl/HwndTerminal.cpp\n+++ b/src/cascadia/TerminalControl/HwndTerminal.cpp\n@@ -116,7 +116,7 @@ try\n                     const auto lock = publicTerminal->_terminal->LockForWriting();\r\n                     if (publicTerminal->_terminal->IsSelectionActive())\r\n                     {\r\n-                        const auto bufferData = publicTerminal->_terminal->RetrieveSelectedTextFromBuffer(false, true, true);\r\n+                        const auto bufferData = publicTerminal->_terminal->RetrieveSelectedTextFromBuffer(false, false, true, true);\r\n                         LOG_IF_FAILED(publicTerminal->_CopyTextToSystemClipboard(bufferData.plainText, bufferData.html, bufferData.rtf));\r\n                         publicTerminal->_ClearSelection();\r\n                         return 0;\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex f76c8c59403..88857713a1f 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -2543,16 +2543,17 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - dismissSelection: dismiss the text selection after copy\r\n     // - singleLine: collapse all of the text to one line\r\n+    // - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n     // - formats: which formats to copy (defined by action's CopyFormatting arg). nullptr\r\n     //             if we should defer which formats are copied to the global setting\r\n-    bool TermControl::CopySelectionToClipboard(bool dismissSelection, bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats)\r\n+    bool TermControl::CopySelectionToClipboard(bool dismissSelection, bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats)\r\n     {\r\n         if (_IsClosing())\r\n         {\r\n             return false;\r\n         }\r\n \r\n-        const auto successfulCopy = _interactivity.CopySelectionToClipboard(singleLine, formats);\r\n+        const auto successfulCopy = _interactivity.CopySelectionToClipboard(singleLine, withControlSequences, formats);\r\n \r\n         if (dismissSelection)\r\n         {\r\n@@ -4189,7 +4190,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const IInspectable& /*args*/)\r\n     {\r\n         // formats = nullptr -> copy all formats\r\n-        _interactivity.CopySelectionToClipboard(false, nullptr);\r\n+        _interactivity.CopySelectionToClipboard(false, false, nullptr);\r\n         ContextMenu().Hide();\r\n         SelectionContextMenu().Hide();\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.h b/src/cascadia/TerminalControl/TermControl.h\nindex d8a44161dbf..7e35585aa59 100644\n--- a/src/cascadia/TerminalControl/TermControl.h\n+++ b/src/cascadia/TerminalControl/TermControl.h\n@@ -60,7 +60,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         hstring GetProfileName() const;\r\n \r\n-        bool CopySelectionToClipboard(bool dismissSelection, bool singleLine, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n+        bool CopySelectionToClipboard(bool dismissSelection, bool singleLine, bool withControlSequences, const Windows::Foundation::IReference<CopyFormat>& formats);\r\n         void PasteTextFromClipboard();\r\n         void SelectAll();\r\n         bool ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.idl b/src/cascadia/TerminalControl/TermControl.idl\nindex c60b5884540..8ff69f33c5e 100644\n--- a/src/cascadia/TerminalControl/TermControl.idl\n+++ b/src/cascadia/TerminalControl/TermControl.idl\n@@ -87,7 +87,7 @@ namespace Microsoft.Terminal.Control\n         event Windows.Foundation.TypedEventHandler<Object, Object> CloseTerminalRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> RestartTerminalRequested;\r\n \r\n-        Boolean CopySelectionToClipboard(Boolean dismissSelection, Boolean singleLine, Windows.Foundation.IReference<CopyFormat> formats);\r\n+        Boolean CopySelectionToClipboard(Boolean dismissSelection, Boolean singleLine, Boolean withControlSequences, Windows.Foundation.IReference<CopyFormat> formats);\r\n         void PasteTextFromClipboard();\r\n         void SelectAll();\r\n         Boolean ToggleBlockSelection();\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c61c339b79e..c77ab1ab764 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1570,7 +1570,7 @@ std::wstring Terminal::CurrentCommand() const\n \r\n void Terminal::SerializeMainBuffer(const wchar_t* destination) const\r\n {\r\n-    _mainBuffer->Serialize(destination);\r\n+    _mainBuffer->SerializeToPath(destination);\r\n }\r\n \r\n void Terminal::ColorSelection(const TextAttribute& attr, winrt::Microsoft::Terminal::Core::MatchMode matchMode)\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 7fdf0995013..8ac499c97e2 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -320,7 +320,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     til::point SelectionEndForRendering() const;\r\n     const SelectionEndpoint SelectionEndpointTarget() const noexcept;\r\n \r\n-    TextCopyData RetrieveSelectedTextFromBuffer(const bool singleLine, const bool html = false, const bool rtf = false) const;\r\n+    TextCopyData RetrieveSelectedTextFromBuffer(const bool singleLine, const bool withControlSequences = false, const bool html = false, const bool rtf = false) const;\r\n #pragma endregion\r\n \r\n #ifndef NDEBUG\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 2cb3ee08bfd..6a800f329dd 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -844,12 +844,13 @@ void Terminal::ClearSelection()\n // - Optionally, get the highlighted text in HTML and RTF formats\r\n // Arguments:\r\n // - singleLine: collapse all of the text to one line. (Turns off trailing whitespace trimming)\r\n+// - withControlSequences: if enabled, the copied plain text contains color/style ANSI escape codes from the selection\r\n // - html: also get text in HTML format\r\n // - rtf: also get text in RTF format\r\n // Return Value:\r\n // - Plain and formatted selected text from buffer. Empty string represents no data for that format.\r\n // - If extended to multiple lines, each line is separated by \\r\\n\r\n-Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singleLine, const bool html, const bool rtf) const\r\n+Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singleLine, const bool withControlSequences, const bool html, const bool rtf) const\r\n {\r\n     TextCopyData data;\r\n \r\n@@ -867,7 +868,14 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n     const auto& textBuffer = _activeBuffer();\r\n \r\n     const auto req = TextBuffer::CopyRequest::FromConfig(textBuffer, _selection->start, _selection->end, singleLine, _selection->blockSelection, _trimBlockSelection);\r\n-    data.plainText = textBuffer.GetPlainText(req);\r\n+    if (withControlSequences)\r\n+    {\r\n+        data.plainText = textBuffer.GetWithControlSequences(req);\r\n+    }\r\n+    else\r\n+    {\r\n+        data.plainText = textBuffer.GetPlainText(req);\r\n+    }\r\n \r\n     if (html || rtf)\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\nindex 8b3e58a11b5..98411fd9b98 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n@@ -207,6 +207,11 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n             str.append(RS_(L\"CopyTextCommandKey\"));\r\n         }\r\n \r\n+        if (WithControlSequences())\r\n+        {\r\n+            str.append(L\", withControlSequences: true\");\r\n+        }\r\n+\r\n         if (!DismissSelection())\r\n         {\r\n             str.append(L\", dismissSelection: false\");\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.h b/src/cascadia/TerminalSettingsModel/ActionArgs.h\nindex 84c23dd2d7d..cd854b19cf3 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.h\n@@ -103,9 +103,10 @@ protected:                                                                  \\\n // false, if we don't really care if the parameter is required or not.\r\n \r\n ////////////////////////////////////////////////////////////////////////////////\r\n-#define COPY_TEXT_ARGS(X)                                      \\\r\n-    X(bool, DismissSelection, \"dismissSelection\", false, true) \\\r\n-    X(bool, SingleLine, \"singleLine\", false, false)            \\\r\n+#define COPY_TEXT_ARGS(X)                                               \\\r\n+    X(bool, DismissSelection, \"dismissSelection\", false, true)          \\\r\n+    X(bool, SingleLine, \"singleLine\", false, false)                     \\\r\n+    X(bool, WithControlSequences, \"withControlSequences\", false, false) \\\r\n     X(Windows::Foundation::IReference<Control::CopyFormat>, CopyFormatting, \"copyFormatting\", false, nullptr)\r\n \r\n ////////////////////////////////////////////////////////////////////////////////\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.idl b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\nindex 02f0c4d0413..5f6bf22cd5f 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n@@ -180,6 +180,7 @@ namespace Microsoft.Terminal.Settings.Model\n         CopyTextArgs();\r\n         Boolean DismissSelection { get; };\r\n         Boolean SingleLine { get; };\r\n+        Boolean WithControlSequences { get; };\r\n         Windows.Foundation.IReference<Microsoft.Terminal.Control.CopyFormat> CopyFormatting { get; };\r\n     };\r\n \r\n", "instance_id": "microsoft__terminal-17059", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement for \"Copy with Control Sequences\" is mostly clear in its intent to add a feature for copying text from a terminal with ANSI escape sequences included, which is useful for preserving styling in copied output. The goal is well-defined, referencing a similar feature in iTerm2 and providing a use case (e.g., copying styled output to markdown with ANSI support). However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define how the ANSI sequences should be handled (e.g., whether to preserve original sequences or recreate them as a best-effort approach, though it mentions both as options). It also lacks specifics on input/output formats, constraints, or edge cases (e.g., how to handle invalid or unsupported sequences, large selections, or performance implications). Additionally, there are no examples of expected input and output, which would help clarify the feature's behavior. While the proposed technical implementation is optional and provides some direction, it does not fully address these gaps. Therefore, I rate the clarity as \"Mostly Clear\" with a score of 2.\n", "difficulty_explanation": "\nI assess the difficulty of this problem as 0.65, placing it in the \"Hard\" range (0.6-0.8), due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are extensive, spanning multiple files and modules within what appears to be a terminal emulator codebase (likely Windows Terminal, given the context of \"Cascadia\"). Modifications include updates to the text buffer logic (`TextBuffer.cpp`), user interface interactions (`TerminalControl`, `TerminalPage`), settings schema (`profiles.schema.json`), and action handling (`ActionArgs`). The changes involve adding a new method for copying text with ANSI sequences (`GetWithControlSequences`), refactoring existing serialization logic (`SerializeToPath`), and propagating a new parameter (`withControlSequences`) through various layers of the application. While the changes do not appear to impact the core architecture fundamentally, they require a broad understanding of how different components (text buffer, clipboard handling, UI interactions) interact, making the scope moderately complex.\n\n2. **Number of Technical Concepts**: Solving this problem requires familiarity with several technical concepts, including:\n   - **ANSI Escape Sequences**: Understanding how these sequences represent text styling (e.g., colors, bold, underline) and how to serialize them correctly.\n   - **Text Buffer Management**: Deep knowledge of how the terminal's text buffer stores and retrieves text and attributes, as seen in the detailed logic for handling text runs, attributes, and line renditions.\n   - **Clipboard Handling**: Familiarity with how text is copied to the clipboard in different formats (plain text, HTML, RTF) and extending this to include ANSI sequences.\n   - **C++ Programming**: Proficiency in C++ (given the codebase), including string manipulation (`std::wstring`), iterators, and low-level file operations.\n   - **Windows Terminal Architecture**: Understanding the interaction between various components like `TerminalCore`, `TerminalControl`, and settings models.\n   These concepts are moderately advanced, especially the handling of ANSI sequences and text buffer serialization, which require domain-specific knowledge of terminal emulation.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes reveal several that need consideration, such as:\n   - Handling empty selections or invalid copy requests (addressed with a simple check in `GetWithControlSequences`).\n   - Managing attribute transitions between text runs (e.g., turning off/on styles like bold or faint, handled with complex logic in `_SerializeRow`).\n   - Dealing with line breaks and wrapping behavior (addressed with `delayedLineBreak` logic).\n   - Ensuring compatibility with different terminal outputs or clipboard consumers that may or may not support ANSI sequences.\n   The code changes show significant effort in handling these cases, particularly in serializing rows with correct styling and line rendition. However, performance implications for large selections or buffers with many style changes are not addressed, which could be a concern.\n\n4. **Overall Complexity**: The implementation requires a deep understanding of the existing codebase to ensure that the new feature integrates seamlessly without breaking existing functionality (e.g., plain text copying, HTML/RTF formats). The logic in `_SerializeRow` is intricate, involving state tracking across rows (`previousTextAttr`, `delayedLineBreak`) and handling various text attributes and escape sequences. This level of detail, combined with the need to modify multiple parts of the codebase, pushes the difficulty into the \"Hard\" category. However, it does not reach \"Very Hard\" (0.8-1.0) because it does not involve system-level changes, advanced algorithms, or highly specialized domain knowledge beyond terminal emulation.\n\nIn summary, the problem requires significant technical expertise, careful handling of edge cases, and modifications across multiple files, justifying a difficulty score of 0.65.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ability to save selected text as a `sendInput` action\nI write some long command. I need to use this frequently (or infrequently), but I don't want to have to remember all the args. I want to be able to pull it up straight from the command palette. So I want to write the command once, select it, and {perform some action}[^1] that lets me save it as a `sendInput` action.\r\n\r\nThe action should\r\n* immediately save it.\r\n* provide a UI[^2] for immediately editing[^3] the name, contents of this action, because `Send \"git log --graph --abbrev-commit --decorate...\" to the Terminal` is not useful to anyone.\r\n\r\nJust doing the immediate save would be a good enough start on this, to the point I'd consider that an easy starter. The UI - that's **H**ard, for reasons listed below. \r\n\r\n\r\n> **Note**\r\n> ## Walkthrough\r\n\r\nAs an initial version of this, it's more than good enough to just save the selected text as an action without the UI. We can iterate on the UI in follow-ups. \r\n\r\n* Probably start with something like [`dev/migrie/fhl/save-command`](https://github.com/microsoft/terminal/compare/6f5b9fb...1cde67ac466e19394eea1eb3a41405513d160a6f)\r\n* We probably want to skip all the `AppCommandlineArgs` stuff for now. That's spicier.\r\n* in `TerminalPage::_HandleSaveTask`, we will want to try and save the current selection as a `sendInput` action, if there's no `commandline` specified. \r\n* AppActionHandlers.cpp has plenty of examples of getting the active control. Should be easy enough to get the selected text from it. \r\n* We'll probably want to generate the name of this action (without a commandline) as \"Save Task...\"\r\n* Over and above: It would be valuable to `Toast` the user with a message \"Saved selected text as a new action\".  `TerminalPage::IdentifyWindow` has an example of a `Toast`\r\n\r\n[^1]: Obviously, easiest way is via cmdpal or keybinding. Also consider a right-click context menu entry, #3337\r\n\r\n[^2]: This has it's own challenges. It can't be a `ContentDialog` (https://github.com/microsoft/microsoft-ui-xaml/issues/3804). It could be nested in a `Flyout`, maybe. Hopefully the dialog thing is limited just to ContentDialogs and not all Flyouts. It probably shouldn't be a `TeachingTip` (#12798). We _could_ roll our own ContentDialog for this of course (#11308).\r\n\r\n[^3]: Might be tricky - we'd have to hand on to an instance of the actual `Command` itself, so we can edit it... in place? and hopefully writing to the settings would then just refresh all the other name->command maps instantly.\n", "patch": "diff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 724f7dafb70..ac01af8cb3b 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -1264,6 +1264,113 @@ namespace winrt::TerminalApp::implementation\n         }\r\n     }\r\n \r\n+    void TerminalPage::_HandleSaveSnippet(const IInspectable& /*sender*/,\r\n+                                          const ActionEventArgs& args)\r\n+    {\r\n+        if constexpr (!Feature_SaveSnippet::IsEnabled())\r\n+        {\r\n+            return;\r\n+        }\r\n+\r\n+        if (args)\r\n+        {\r\n+            if (const auto& realArgs = args.ActionArgs().try_as<SaveSnippetArgs>())\r\n+            {\r\n+                auto commandLine = realArgs.Commandline();\r\n+                if (commandLine.empty())\r\n+                {\r\n+                    if (const auto termControl{ _GetActiveControl() })\r\n+                    {\r\n+                        if (termControl.HasSelection())\r\n+                        {\r\n+                            const auto selections{ termControl.SelectedText(true) };\r\n+                            const auto selection = std::accumulate(selections.begin(), selections.end(), std::wstring());\r\n+                            commandLine = selection;\r\n+                        }\r\n+                    }\r\n+                }\r\n+\r\n+                if (commandLine.empty())\r\n+                {\r\n+                    ActionSaveFailed(L\"CommandLine is Required\");\r\n+                    return;\r\n+                }\r\n+\r\n+                try\r\n+                {\r\n+                    KeyChord keyChord = nullptr;\r\n+                    if (!realArgs.KeyChord().empty())\r\n+                    {\r\n+                        keyChord = KeyChordSerialization::FromString(winrt::to_hstring(realArgs.KeyChord()));\r\n+                    }\r\n+                    _settings.GlobalSettings().ActionMap().AddSendInputAction(realArgs.Name(), commandLine, keyChord);\r\n+                    _settings.WriteSettingsToDisk();\r\n+                    ActionSaved(commandLine, realArgs.Name(), realArgs.KeyChord());\r\n+                }\r\n+                catch (const winrt::hresult_error& ex)\r\n+                {\r\n+                    auto code = ex.code();\r\n+                    auto message = ex.message();\r\n+                    ActionSaveFailed(message);\r\n+                    args.Handled(true);\r\n+                    return;\r\n+                }\r\n+\r\n+                args.Handled(true);\r\n+            }\r\n+        }\r\n+    }\r\n+\r\n+    void TerminalPage::ActionSaved(winrt::hstring input, winrt::hstring name, winrt::hstring keyChord)\r\n+    {\r\n+        // If we haven't ever loaded the TeachingTip, then do so now and\r\n+        // create the toast for it.\r\n+        if (_actionSavedToast == nullptr)\r\n+        {\r\n+            if (auto tip{ FindName(L\"ActionSavedToast\").try_as<MUX::Controls::TeachingTip>() })\r\n+            {\r\n+                _actionSavedToast = std::make_shared<Toast>(tip);\r\n+                // Make sure to use the weak ref when setting up this\r\n+                // callback.\r\n+                tip.Closed({ get_weak(), &TerminalPage::_FocusActiveControl });\r\n+            }\r\n+        }\r\n+        _UpdateTeachingTipTheme(ActionSavedToast().try_as<winrt::Windows::UI::Xaml::FrameworkElement>());\r\n+\r\n+        SavedActionName(name);\r\n+        SavedActionKeyChord(keyChord);\r\n+        SavedActionCommandLine(input);\r\n+\r\n+        if (_actionSavedToast != nullptr)\r\n+        {\r\n+            _actionSavedToast->Open();\r\n+        }\r\n+    }\r\n+\r\n+    void TerminalPage::ActionSaveFailed(winrt::hstring message)\r\n+    {\r\n+        // If we haven't ever loaded the TeachingTip, then do so now and\r\n+        // create the toast for it.\r\n+        if (_actionSaveFailedToast == nullptr)\r\n+        {\r\n+            if (auto tip{ FindName(L\"ActionSaveFailedToast\").try_as<MUX::Controls::TeachingTip>() })\r\n+            {\r\n+                _actionSaveFailedToast = std::make_shared<Toast>(tip);\r\n+                // Make sure to use the weak ref when setting up this\r\n+                // callback.\r\n+                tip.Closed({ get_weak(), &TerminalPage::_FocusActiveControl });\r\n+            }\r\n+        }\r\n+        _UpdateTeachingTipTheme(ActionSaveFailedToast().try_as<winrt::Windows::UI::Xaml::FrameworkElement>());\r\n+\r\n+        ActionSaveFailedMessage().Text(message);\r\n+\r\n+        if (_actionSaveFailedToast != nullptr)\r\n+        {\r\n+            _actionSaveFailedToast->Open();\r\n+        }\r\n+    }\r\n+\r\n     void TerminalPage::_HandleSelectCommand(const IInspectable& /*sender*/,\r\n                                             const ActionEventArgs& args)\r\n     {\r\ndiff --git a/src/cascadia/TerminalApp/AppCommandlineArgs.cpp b/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\nindex b7a6b581a05..c1154f56728 100644\n--- a/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\n+++ b/src/cascadia/TerminalApp/AppCommandlineArgs.cpp\n@@ -209,6 +209,7 @@ void AppCommandlineArgs::_buildParser()\n     _buildMovePaneParser();\r\n     _buildSwapPaneParser();\r\n     _buildFocusPaneParser();\r\n+    _buildSaveSnippetParser();\r\n }\r\n \r\n // Method Description:\r\n@@ -537,6 +538,72 @@ void AppCommandlineArgs::_buildFocusPaneParser()\n     setupSubcommand(_focusPaneShort);\r\n }\r\n \r\n+void AppCommandlineArgs::_buildSaveSnippetParser()\r\n+{\r\n+    _saveCommand = _app.add_subcommand(\"x-save-snippet\", RS_A(L\"SaveSnippetDesc\"));\r\n+\r\n+    auto setupSubcommand = [this](auto* subcommand) {\r\n+        subcommand->add_option(\"--name,-n\", _saveInputName, RS_A(L\"SaveSnippetArgDesc\"));\r\n+        subcommand->add_option(\"--keychord,-k\", _keyChordOption, RS_A(L\"KeyChordArgDesc\"));\r\n+        subcommand->add_option(\"command,\", _commandline, RS_A(L\"CmdCommandArgDesc\"));\r\n+        subcommand->positionals_at_end(true);\r\n+\r\n+        // When ParseCommand is called, if this subcommand was provided, this\r\n+        // callback function will be triggered on the same thread. We can be sure\r\n+        // that `this` will still be safe - this function just lets us know this\r\n+        // command was parsed.\r\n+        subcommand->callback([&, this]() {\r\n+            // Build the action from the values we've parsed on the commandline.\r\n+            ActionAndArgs saveSnippet{};\r\n+            saveSnippet.Action(ShortcutAction::SaveSnippet);\r\n+            // First, parse out the commandline in the same way that\r\n+            // _getNewTerminalArgs does it\r\n+            SaveSnippetArgs args{};\r\n+\r\n+            if (!_commandline.empty())\r\n+            {\r\n+                std::ostringstream cmdlineBuffer;\r\n+\r\n+                for (const auto& arg : _commandline)\r\n+                {\r\n+                    if (cmdlineBuffer.tellp() != 0)\r\n+                    {\r\n+                        // If there's already something in here, prepend a space\r\n+                        cmdlineBuffer << ' ';\r\n+                    }\r\n+\r\n+                    if (arg.find(\" \") != std::string::npos)\r\n+                    {\r\n+                        cmdlineBuffer << '\"' << arg << '\"';\r\n+                    }\r\n+                    else\r\n+                    {\r\n+                        cmdlineBuffer << arg;\r\n+                    }\r\n+                }\r\n+\r\n+                args.Commandline(winrt::to_hstring(cmdlineBuffer.str()));\r\n+            }\r\n+\r\n+            if (!_keyChordOption.empty())\r\n+            {\r\n+                args.KeyChord(winrt::to_hstring(_keyChordOption));\r\n+            }\r\n+\r\n+            if (!_saveInputName.empty())\r\n+            {\r\n+                winrt::hstring hString = winrt::to_hstring(_saveInputName);\r\n+                args.Name(hString);\r\n+            }\r\n+\r\n+            saveSnippet.Args(args);\r\n+            _startupActions.push_back(saveSnippet);\r\n+        });\r\n+    };\r\n+\r\n+    setupSubcommand(_saveCommand);\r\n+}\r\n+\r\n // Method Description:\r\n // - Add the `NewTerminalArgs` parameters to the given subcommand. This enables\r\n //   that subcommand to support all the properties in a NewTerminalArgs.\r\n@@ -710,7 +777,8 @@ bool AppCommandlineArgs::_noCommandsProvided()\n              *_focusPaneCommand ||\r\n              *_focusPaneShort ||\r\n              *_newPaneShort.subcommand ||\r\n-             *_newPaneCommand.subcommand);\r\n+             *_newPaneCommand.subcommand ||\r\n+             *_saveCommand);\r\n }\r\n \r\n // Method Description:\r\ndiff --git a/src/cascadia/TerminalApp/AppCommandlineArgs.h b/src/cascadia/TerminalApp/AppCommandlineArgs.h\nindex 7eb5a34f93d..7eb2516bb38 100644\n--- a/src/cascadia/TerminalApp/AppCommandlineArgs.h\n+++ b/src/cascadia/TerminalApp/AppCommandlineArgs.h\n@@ -93,6 +93,7 @@ class TerminalApp::AppCommandlineArgs final\n     CLI::App* _swapPaneCommand;\r\n     CLI::App* _focusPaneCommand;\r\n     CLI::App* _focusPaneShort;\r\n+    CLI::App* _saveCommand;\r\n \r\n     // Are you adding a new sub-command? Make sure to update _noCommandsProvided!\r\n \r\n@@ -123,6 +124,8 @@ class TerminalApp::AppCommandlineArgs final\n     bool _focusPrevTab{ false };\r\n \r\n     int _focusPaneTarget{ -1 };\r\n+    std::string _saveInputName;\r\n+    std::string _keyChordOption;\r\n     // Are you adding more args here? Make sure to reset them in _resetStateToDefault\r\n \r\n     const Commandline* _currentCommandline{ nullptr };\r\n@@ -141,6 +144,7 @@ class TerminalApp::AppCommandlineArgs final\n     winrt::Microsoft::Terminal::Settings::Model::NewTerminalArgs _getNewTerminalArgs(NewTerminalSubcommand& subcommand);\r\n     void _addNewTerminalArgs(NewTerminalSubcommand& subcommand);\r\n     void _buildParser();\r\n+    void _buildSaveSnippetParser();\r\n     void _buildNewTabParser();\r\n     void _buildSplitPaneParser();\r\n     void _buildFocusTabParser();\r\ndiff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 15b79c40ffc..efe3e1278e2 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -288,6 +288,15 @@\n   <data name=\"CmdCommandArgDesc\" xml:space=\"preserve\">\r\n     <value>An optional command, with arguments, to be spawned in the new tab or pane</value>\r\n   </data>\r\n+  <data name=\"SaveSnippetDesc\" xml:space=\"preserve\">\r\n+    <value>Save command line as input action</value>\r\n+  </data>\r\n+  <data name=\"SaveSnippetArgDesc\" xml:space=\"preserve\">\r\n+    <value>An optional argument</value>\r\n+  </data>\r\n+  <data name=\"KeyChordArgDesc\" xml:space=\"preserve\">\r\n+    <value>An optional argument</value>\r\n+  </data>\r\n   <data name=\"CmdFocusTabDesc\" xml:space=\"preserve\">\r\n     <value>Move focus to another tab</value>\r\n   </data>\r\n@@ -898,4 +907,10 @@\n   <data name=\"RestartConnectionToolTip\" xml:space=\"preserve\">\r\n     <value>Restart the active pane connection</value>\r\n   </data>\r\n+  <data name=\"ActionSavedToast.Title\" xml:space=\"preserve\">\r\n+    <value>Action saved</value>\r\n+  </data>\r\n+  <data name=\"ActionSaveFailedToast.Title\" xml:space=\"preserve\">\r\n+    <value>Action save failed</value>\r\n+  </data>\r\n </root>\r\ndiff --git a/src/cascadia/TerminalApp/TerminalAppLib.vcxproj b/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\nindex d0629da8036..238fecf9afc 100644\n--- a/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\n+++ b/src/cascadia/TerminalApp/TerminalAppLib.vcxproj\n@@ -357,7 +357,9 @@\n   </ItemGroup>\r\n   <!-- ========================= Misc Files ======================== -->\r\n   <ItemGroup>\r\n-    <PRIResource Include=\"Resources\\en-US\\Resources.resw\" />\r\n+    <PRIResource Include=\"Resources\\en-US\\Resources.resw\">\r\n+      <SubType>Designer</SubType>\r\n+    </PRIResource>\r\n     <PRIResource Include=\"Resources\\en-US\\ContextMenu.resw\" />\r\n     <OCResourceDirectory Include=\"Resources\" />\r\n   </ItemGroup>\r\n@@ -466,10 +468,8 @@\n   </ItemDefinitionGroup>\r\n   <!-- ========================= Globals ======================== -->\r\n   <Import Project=\"$(OpenConsoleDir)src\\cppwinrt.build.post.props\" />\r\n-\r\n   <!-- This -must- go after cppwinrt.build.post.props because that includes many VS-provided props including appcontainer.common.props, which stomps on what cppwinrt.targets did. -->\r\n   <Import Project=\"$(OpenConsoleDir)src\\common.nugetversions.targets\" />\r\n-\r\n   <!--\r\n     By default, the PRI file will contain resource paths beginning with the\r\n     project name. Since we enabled XBF embedding, this *also* includes App.xbf.\r\n@@ -490,4 +490,4 @@\n     </ItemGroup>\r\n   </Target>\r\n   <Import Project=\"$(SolutionDir)build\\rules\\CollectWildcardResources.targets\" />\r\n-</Project>\r\n+</Project>\n\\ No newline at end of file\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 0a6f5d70957..07dbf173242 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -146,6 +146,8 @@ namespace winrt::TerminalApp::implementation\n         winrt::hstring KeyboardServiceDisabledText();\n \n         winrt::fire_and_forget IdentifyWindow();\n+        void ActionSaved(winrt::hstring input, winrt::hstring name, winrt::hstring keyChord);\n+        void ActionSaveFailed(winrt::hstring message);\n         winrt::fire_and_forget RenameFailed();\n         winrt::fire_and_forget ShowTerminalWorkingDirectory();\n \n@@ -199,6 +201,10 @@ namespace winrt::TerminalApp::implementation\n         WINRT_OBSERVABLE_PROPERTY(winrt::Windows::UI::Xaml::Media::Brush, TitlebarBrush, PropertyChanged.raise, nullptr);\n         WINRT_OBSERVABLE_PROPERTY(winrt::Windows::UI::Xaml::Media::Brush, FrameBrush, PropertyChanged.raise, nullptr);\n \n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionName, PropertyChanged.raise, L\"\");\n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionKeyChord, PropertyChanged.raise, L\"\");\n+        WINRT_OBSERVABLE_PROPERTY(winrt::hstring, SavedActionCommandLine, PropertyChanged.raise, L\"\");\n+\n     private:\n         friend struct TerminalPageT<TerminalPage>; // for Xaml to bind events\n         std::optional<HWND> _hostingHwnd;\n@@ -258,6 +264,8 @@ namespace winrt::TerminalApp::implementation\n         bool _isEmbeddingInboundListener{ false };\n \n         std::shared_ptr<Toast> _windowIdToast{ nullptr };\n+        std::shared_ptr<Toast> _actionSavedToast{ nullptr };\n+        std::shared_ptr<Toast> _actionSaveFailedToast{ nullptr };\n         std::shared_ptr<Toast> _windowRenameFailedToast{ nullptr };\n         std::shared_ptr<Toast> _windowCwdToast{ nullptr };\n \ndiff --git a/src/cascadia/TerminalApp/TerminalPage.idl b/src/cascadia/TerminalApp/TerminalPage.idl\nindex 667350056b8..9e272351406 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.idl\n+++ b/src/cascadia/TerminalApp/TerminalPage.idl\n@@ -72,6 +72,10 @@ namespace TerminalApp\n         void IdentifyWindow();\n         void RenameFailed();\n \n+        String SavedActionName { get; };\n+        String SavedActionKeyChord { get; };\n+        String SavedActionCommandLine { get; };\n+\n         // We cannot use the default XAML APIs because we want to make sure\n         // that there's only one application-global dialog visible at a time,\n         // and because of GH#5224.\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.xaml b/src/cascadia/TerminalApp/TerminalPage.xaml\nindex c8aa837bf82..ce6fc576071 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.xaml\n+++ b/src/cascadia/TerminalApp/TerminalPage.xaml\n@@ -8,6 +8,7 @@\n       xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"\r\n       xmlns:local=\"using:TerminalApp\"\r\n       xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\r\n+      xmlns:mtu=\"using:Microsoft.Terminal.UI\"\r\n       xmlns:mux=\"using:Microsoft.UI.Xaml.Controls\"\r\n       Background=\"Transparent\"\r\n       mc:Ignorable=\"d\">\r\n@@ -204,5 +205,43 @@\n                          Title=\"{x:Bind WindowProperties.VirtualWorkingDirectory, Mode=OneWay}\"\r\n                          x:Load=\"False\"\r\n                          IsLightDismissEnabled=\"True\" />\r\n+\r\n+        <mux:TeachingTip x:Name=\"ActionSavedToast\"\r\n+                         x:Uid=\"ActionSavedToast\"\r\n+                         Title=\"Action Saved\"\r\n+                         HorizontalAlignment=\"Stretch\"\r\n+                         x:Load=\"False\"\r\n+                         IsLightDismissEnabled=\"True\">\r\n+            <mux:TeachingTip.Content>\r\n+                <StackPanel HorizontalAlignment=\"Stretch\"\r\n+                            Orientation=\"Vertical\">\r\n+                    <TextBlock x:Name=\"ActionSavedNameText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionName), Mode=OneWay}\">\r\n+                        <Run Text=\"Name: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionName, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                    <TextBlock x:Name=\"ActionSavedKeyChordText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionKeyChord), Mode=OneWay}\">\r\n+                        <Run Text=\"Key Chord: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionKeyChord, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                    <TextBlock x:Name=\"ActionSavedCommandLineText\"\r\n+                               Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(SavedActionCommandLine), Mode=OneWay}\">\r\n+                        <Run Text=\"Input: \" />\r\n+                        <Run Text=\"{x:Bind SavedActionCommandLine, Mode=OneWay}\" />\r\n+                    </TextBlock>\r\n+                </StackPanel>\r\n+            </mux:TeachingTip.Content>\r\n+        </mux:TeachingTip>\r\n+        <mux:TeachingTip x:Name=\"ActionSaveFailedToast\"\r\n+                         x:Uid=\"ActionSaveFailedToast\"\r\n+                         Title=\"Action Save Failed\"\r\n+                         x:Load=\"False\"\r\n+                         IsLightDismissEnabled=\"True\">\r\n+            <mux:TeachingTip.Content>\r\n+                <TextBlock x:Name=\"ActionSaveFailedMessage\"\r\n+                           Text=\"\" />\r\n+            </mux:TeachingTip.Content>\r\n+        </mux:TeachingTip>\r\n     </Grid>\r\n </Page>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\nindex 7bba13bc4cc..9b2ef821f58 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionAndArgs.cpp\n@@ -52,6 +52,7 @@ static constexpr std::string_view SwitchToTabKey{ \"switchToTab\" };\n static constexpr std::string_view TabSearchKey{ \"tabSearch\" };\n static constexpr std::string_view ToggleAlwaysOnTopKey{ \"toggleAlwaysOnTop\" };\n static constexpr std::string_view ToggleCommandPaletteKey{ \"commandPalette\" };\n+static constexpr std::string_view SaveSnippetKey{ \"experimental.saveSnippet\" };\n static constexpr std::string_view SuggestionsKey{ \"showSuggestions\" };\n static constexpr std::string_view ToggleFocusModeKey{ \"toggleFocusMode\" };\n static constexpr std::string_view SetFocusModeKey{ \"setFocusMode\" };\n@@ -389,6 +390,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n                 { ShortcutAction::TabSearch, RS_(L\"TabSearchCommandKey\") },\n                 { ShortcutAction::ToggleAlwaysOnTop, RS_(L\"ToggleAlwaysOnTopCommandKey\") },\n                 { ShortcutAction::ToggleCommandPalette, MustGenerate },\n+                { ShortcutAction::SaveSnippet, MustGenerate },\n                 { ShortcutAction::Suggestions, MustGenerate },\n                 { ShortcutAction::ToggleFocusMode, RS_(L\"ToggleFocusModeCommandKey\") },\n                 { ShortcutAction::SetFocusMode, MustGenerate },\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\nindex 24f4e445953..d018b6019e4 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.cpp\n@@ -33,6 +33,7 @@\n #include \"ScrollToMarkArgs.g.cpp\"\r\n #include \"AddMarkArgs.g.cpp\"\r\n #include \"FindMatchArgs.g.cpp\"\r\n+#include \"SaveSnippetArgs.g.cpp\"\r\n #include \"ToggleCommandPaletteArgs.g.cpp\"\r\n #include \"SuggestionsArgs.g.cpp\"\r\n #include \"NewWindowArgs.g.cpp\"\r\n@@ -947,6 +948,29 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         }\r\n     }\r\n \r\n+    winrt::hstring SaveSnippetArgs::GenerateName() const\r\n+    {\r\n+        if (Feature_SaveSnippet::IsEnabled())\r\n+        {\r\n+            std::wstringstream ss;\r\n+\r\n+            ss << RS_(L\"SaveSnippetNamePrefix\").c_str() << L\" commandline: \" << Commandline().c_str();\r\n+\r\n+            if (!Name().empty())\r\n+            {\r\n+                ss << L\", name: \" << Name().c_str();\r\n+            }\r\n+\r\n+            if (!KeyChord().empty())\r\n+            {\r\n+                ss << L\", keyChord \" << KeyChord().c_str();\r\n+            }\r\n+\r\n+            return winrt::hstring{ ss.str() };\r\n+        }\r\n+        return L\"\";\r\n+    }\r\n+\r\n     static winrt::hstring _FormatColorString(const Control::SelectionColor& selectionColor)\r\n     {\r\n         if (!selectionColor)\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.h b/src/cascadia/TerminalSettingsModel/ActionArgs.h\nindex ae3d7d50029..84c23dd2d7d 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.h\n@@ -34,6 +34,7 @@\n #include \"ScrollToMarkArgs.g.h\"\r\n #include \"AddMarkArgs.g.h\"\r\n #include \"MoveTabArgs.g.h\"\r\n+#include \"SaveSnippetArgs.g.h\"\r\n #include \"ToggleCommandPaletteArgs.g.h\"\r\n #include \"SuggestionsArgs.g.h\"\r\n #include \"FindMatchArgs.g.h\"\r\n@@ -215,6 +216,12 @@ protected:                                                                  \\\n #define TOGGLE_COMMAND_PALETTE_ARGS(X) \\\r\n     X(CommandPaletteLaunchMode, LaunchMode, \"launchMode\", false, CommandPaletteLaunchMode::Action)\r\n \r\n+////////////////////////////////////////////////////////////////////////////////\r\n+#define SAVE_TASK_ARGS(X)                                                           \\\r\n+    X(winrt::hstring, Name, \"name\", false, L\"\")                                     \\\r\n+    X(winrt::hstring, Commandline, \"commandline\", args->Commandline().empty(), L\"\") \\\r\n+    X(winrt::hstring, KeyChord, \"keyChord\", false, L\"\")\r\n+\r\n ////////////////////////////////////////////////////////////////////////////////\r\n #define SUGGESTIONS_ARGS(X)                                                 \\\r\n     X(SuggestionsSource, Source, \"source\", false, SuggestionsSource::Tasks) \\\r\n@@ -819,6 +826,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n     ACTION_ARGS_STRUCT(ToggleCommandPaletteArgs, TOGGLE_COMMAND_PALETTE_ARGS);\r\n \r\n+    ACTION_ARGS_STRUCT(SaveSnippetArgs, SAVE_TASK_ARGS);\r\n+\r\n     ACTION_ARGS_STRUCT(SuggestionsArgs, SUGGESTIONS_ARGS);\r\n \r\n     ACTION_ARGS_STRUCT(FindMatchArgs, FIND_MATCH_ARGS);\r\n@@ -941,6 +950,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::factory_implementation\n     BASIC_FACTORY(CloseTabArgs);\r\n     BASIC_FACTORY(MoveTabArgs);\r\n     BASIC_FACTORY(OpenSettingsArgs);\r\n+    BASIC_FACTORY(SaveSnippetArgs);\r\n     BASIC_FACTORY(FindMatchArgs);\r\n     BASIC_FACTORY(NewWindowArgs);\r\n     BASIC_FACTORY(FocusPaneArgs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionArgs.idl b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\nindex 5992f2d5217..02f0c4d0413 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionArgs.idl\n@@ -357,6 +357,15 @@ namespace Microsoft.Terminal.Settings.Model\n         FindMatchDirection Direction { get; };\r\n     };\r\n \r\n+    [default_interface] runtimeclass SaveSnippetArgs : IActionArgs\r\n+    {\r\n+        SaveSnippetArgs();\r\n+        SaveSnippetArgs(String Name, String Commandline, String KeyChord);\r\n+        String Name;\r\n+        String Commandline;\r\n+        String KeyChord;\r\n+    };\r\n+\r\n     [default_interface] runtimeclass NewWindowArgs : IActionArgs\r\n     {\r\n         NewWindowArgs(INewContentArgs contentArgs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex 4468014c5a8..86a88c36858 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -882,6 +882,22 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         return results;\r\n     }\r\n \r\n+    void ActionMap::AddSendInputAction(winrt::hstring name, winrt::hstring input, const Control::KeyChord keys)\r\n+    {\r\n+        auto newAction = winrt::make<ActionAndArgs>();\r\n+        newAction.Action(ShortcutAction::SendInput);\r\n+        auto sendInputArgs = winrt::make<SendInputArgs>(input);\r\n+        newAction.Args(sendInputArgs);\r\n+        auto cmd{ make_self<Command>() };\r\n+        if (!name.empty())\r\n+        {\r\n+            cmd->Name(name);\r\n+        }\r\n+        cmd->ActionAndArgs(newAction);\r\n+        cmd->GenerateID();\r\n+        AddAction(*cmd, keys);\r\n+    }\r\n+\r\n     IVector<Model::Command> ActionMap::FilterToSendInput(\r\n         winrt::hstring currentCommandline)\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.h b/src/cascadia/TerminalSettingsModel/ActionMap.h\nindex 2b815214dcb..22428ee5eda 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.h\n@@ -78,6 +78,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         bool RebindKeys(const Control::KeyChord& oldKeys, const Control::KeyChord& newKeys);\r\n         void DeleteKeyBinding(const Control::KeyChord& keys);\r\n         void RegisterKeyBinding(Control::KeyChord keys, Model::ActionAndArgs action);\r\n+        void AddSendInputAction(winrt::hstring name, winrt::hstring input, const Control::KeyChord keys);\r\n \r\n         Windows::Foundation::Collections::IVector<Model::Command> ExpandedCommands();\r\n         void ExpandCommands(const Windows::Foundation::Collections::IVectorView<Model::Profile>& profiles,\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.idl b/src/cascadia/TerminalSettingsModel/ActionMap.idl\nindex 594872f6b70..1849e0680a4 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.idl\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.idl\n@@ -31,5 +31,6 @@ namespace Microsoft.Terminal.Settings.Model\n         void DeleteKeyBinding(Microsoft.Terminal.Control.KeyChord keys);\r\n \r\n         void RegisterKeyBinding(Microsoft.Terminal.Control.KeyChord keys, ActionAndArgs action);\r\n+        void AddSendInputAction(String name, String input, Microsoft.Terminal.Control.KeyChord keys);\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AllShortcutActions.h b/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\nindex 28ba4281e69..86ff9d49c9b 100644\n--- a/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\n+++ b/src/cascadia/TerminalSettingsModel/AllShortcutActions.h\n@@ -75,6 +75,7 @@\n     ON_ALL_ACTIONS(CloseTabsAfter)          \\\r\n     ON_ALL_ACTIONS(TabSearch)               \\\r\n     ON_ALL_ACTIONS(MoveTab)                 \\\r\n+    ON_ALL_ACTIONS(SaveSnippet)             \\\r\n     ON_ALL_ACTIONS(BreakIntoDebugger)       \\\r\n     ON_ALL_ACTIONS(TogglePaneReadOnly)      \\\r\n     ON_ALL_ACTIONS(EnablePaneReadOnly)      \\\r\n@@ -148,6 +149,7 @@\n     ON_ALL_ACTIONS_WITH_ARGS(SplitPane)            \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(SwitchToTab)          \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ToggleCommandPalette) \\\r\n+    ON_ALL_ACTIONS_WITH_ARGS(SaveSnippet)          \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(FocusPane)            \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ExportBuffer)         \\\r\n     ON_ALL_ACTIONS_WITH_ARGS(ClearBuffer)          \\\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\nindex 6179099bdf5..b65b7eabcd4 100644\n--- a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n@@ -1,17 +1,17 @@\n <?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n <root>\r\n-  <!-- \r\n-    Microsoft ResX Schema \r\n-    \r\n+  <!--\r\n+    Microsoft ResX Schema\r\n+\r\n     Version 2.0\r\n-    \r\n-    The primary goals of this format is to allow a simple XML format \r\n-    that is mostly human readable. The generation and parsing of the \r\n-    various data types are done through the TypeConverter classes \r\n+\r\n+    The primary goals of this format is to allow a simple XML format\r\n+    that is mostly human readable. The generation and parsing of the\r\n+    various data types are done through the TypeConverter classes\r\n     associated with the data types.\r\n-    \r\n+\r\n     Example:\r\n-    \r\n+\r\n     ... ado.net/XML headers & schema ...\r\n     <resheader name=\"resmimetype\">text/microsoft-resx</resheader>\r\n     <resheader name=\"version\">2.0</resheader>\r\n@@ -26,36 +26,36 @@\n         <value>[base64 mime encoded string representing a byte array form of the .NET Framework object]</value>\r\n         <comment>This is a comment</comment>\r\n     </data>\r\n-                \r\n-    There are any number of \"resheader\" rows that contain simple \r\n+\r\n+    There are any number of \"resheader\" rows that contain simple\r\n     name/value pairs.\r\n-    \r\n-    Each data row contains a name, and value. The row also contains a \r\n-    type or mimetype. Type corresponds to a .NET class that support \r\n-    text/value conversion through the TypeConverter architecture. \r\n-    Classes that don't support this are serialized and stored with the \r\n+\r\n+    Each data row contains a name, and value. The row also contains a\r\n+    type or mimetype. Type corresponds to a .NET class that support\r\n+    text/value conversion through the TypeConverter architecture.\r\n+    Classes that don't support this are serialized and stored with the\r\n     mimetype set.\r\n-    \r\n-    The mimetype is used for serialized objects, and tells the \r\n-    ResXResourceReader how to depersist the object. This is currently not \r\n+\r\n+    The mimetype is used for serialized objects, and tells the\r\n+    ResXResourceReader how to depersist the object. This is currently not\r\n     extensible. For a given mimetype the value must be set accordingly:\r\n-    \r\n-    Note - application/x-microsoft.net.object.binary.base64 is the format \r\n-    that the ResXResourceWriter will generate, however the reader can \r\n+\r\n+    Note - application/x-microsoft.net.object.binary.base64 is the format\r\n+    that the ResXResourceWriter will generate, however the reader can\r\n     read any of the formats listed below.\r\n-    \r\n+\r\n     mimetype: application/x-microsoft.net.object.binary.base64\r\n-    value   : The object must be serialized with \r\n+    value   : The object must be serialized with\r\n             : System.Runtime.Serialization.Formatters.Binary.BinaryFormatter\r\n             : and then encoded with base64 encoding.\r\n-    \r\n+\r\n     mimetype: application/x-microsoft.net.object.soap.base64\r\n-    value   : The object must be serialized with \r\n+    value   : The object must be serialized with\r\n             : System.Runtime.Serialization.Formatters.Soap.SoapFormatter\r\n             : and then encoded with base64 encoding.\r\n \r\n     mimetype: application/x-microsoft.net.object.bytearray.base64\r\n-    value   : The object must be serialized into a byte array \r\n+    value   : The object must be serialized into a byte array\r\n             : using a System.ComponentModel.TypeConverter\r\n             : and then encoded with base64 encoding.\r\n     -->\r\n@@ -727,4 +727,7 @@\n     <value>Open about dialog</value>\r\n     <comment>This will open the \"about\" dialog, to display version info and other documentation</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+  <data name=\"SaveSnippetNamePrefix\" xml:space=\"preserve\">\r\n+    <value>Save Snippet</value>\r\n+  </data>\r\n+</root>\r\ndiff --git a/src/features.xml b/src/features.xml\nindex 47d86790f9d..b87e09bb7c4 100644\n--- a/src/features.xml\n+++ b/src/features.xml\n@@ -155,6 +155,17 @@\n         </alwaysEnabledBrandingTokens>\r\n     </feature>\r\n \r\n+    <feature>\r\n+        <name>Feature_SaveSnippet</name>\r\n+        <description>Save Snippet</description>\r\n+        <id>9971</id>\r\n+        <stage>AlwaysDisabled</stage>\r\n+        <alwaysEnabledBrandingTokens>\r\n+            <brandingToken>Dev</brandingToken>\r\n+            <brandingToken>Canary</brandingToken>\r\n+        </alwaysEnabledBrandingTokens>\r\n+    </feature>\r\n+\r\n     <feature>\r\n         <name>Feature_QuickFix</name>\r\n         <description>Enables the Quick Fix menu</description>\r\n", "instance_id": "microsoft__terminal-16513", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "\nThe problem statement is mostly clear in describing the goal of saving selected text as a `sendInput` action for reuse via a command palette or keybinding. It specifies the initial scope (immediate save of selected text) and mentions a more complex UI component as a follow-up, which is explicitly marked as hard. The statement provides some implementation hints, such as referencing specific files and methods (`TerminalPage::_HandleSaveTask`, `AppActionHandlers.cpp`) and suggesting a basic name generation for the action. However, there are minor ambiguities and missing details. For instance, it does not fully clarify how the saved action should integrate with existing systems (e.g., persistence mechanism details or conflict resolution with existing actions). Edge cases, such as handling empty selections or invalid input, are not explicitly addressed in the problem statement, though the code changes attempt to handle some of these. Additionally, the UI component's challenges are mentioned but not detailed beyond references to GitHub issues, leaving some uncertainty about the full scope of potential follow-ups. Overall, the statement is valid and mostly clear but lacks comprehensive coverage of edge cases and integration specifics.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.55, placing this problem in the medium range, due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files (`AppActionHandlers.cpp`, `AppCommandlineArgs.cpp`, `TerminalPage.h/.xaml/.idl`, and several settings/model files), indicating a moderate impact across the codebase. The modifications involve adding new functionality for saving snippets as actions, integrating with command-line parsing, updating UI elements (toasts), and extending the action map to support new `sendInput` actions. While the changes are not architecturally disruptive, they require understanding and modifying several interconnected components, including settings persistence and UI feedback mechanisms.\n\n2. **Number of Technical Concepts**: Solving this problem requires familiarity with several concepts, including C++ (with WinRT for Windows UI interactions), XAML for UI definitions, and the Microsoft Terminal's internal architecture (e.g., action handling, command palette integration, and settings model). Specific knowledge of the `TeachingTip` UI component for toast notifications, string handling in WinRT (`winrt::hstring`), and key chord serialization is necessary. Additionally, the feature flag system (`Feature_SaveSnippet`) and resource file management (`.resw`) are involved. While these concepts are not extremely advanced, their combination and the need to navigate a large, complex codebase increase the difficulty to a medium level.\n\n3. **Potential Edge Cases and Error Handling**: The code changes address some basic edge cases, such as checking for empty command lines or selections and handling save failures with a toast notification. However, the problem statement does not explicitly discuss edge cases like duplicate action names, invalid key chords, or selection text with special characters. The error handling implemented in the code (e.g., catching `winrt::hresult_error`) is straightforward but requires ensuring robustness across different user inputs and system states. The complexity of edge cases is moderate, as they are not deeply intricate but still require careful consideration.\n\n4. **Overall Complexity**: The initial implementation (saving selected text as an action) is relatively straightforward, as noted in the problem statement, and could be considered an \"easy starter.\" However, the provided code changes go beyond this by including command-line parsing, key chord support, and UI feedback via toasts, which add to the complexity. The problem also hints at future UI challenges (marked as hard), but since the current scope excludes this, I focus on the implemented functionality. The need to integrate with existing systems, modify multiple files, and ensure proper error handling pushes this into the medium difficulty range. It does not reach the hard range (0.6-0.8) because it does not involve deep architectural changes, complex algorithms, or significant performance considerations.\n\nIn summary, this problem requires a moderate level of expertise in C++ and WinRT, an understanding of multiple codebase components, and careful handling of basic edge cases, justifying a difficulty score of 0.55.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Vertex remapping/reindexing with approximate equality\nAs the README states,\r\n> meshopt_generateVertexRemap uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\r\n\r\nSince rolling a custom version of the algorithm for a single-line change also comes with a maintenance cost, would it be possible to provide a variant of the algorithm that allows the specification of custom distance functions?\r\n\r\nFor instance by extending the `meshopt_Stream` struct or by passing a function pointer to the signature, which then gets the stream and element?\n", "patch": "diff --git a/README.md b/README.md\nindex 7cd858e43..d9d0488a9 100644\n--- a/README.md\n+++ b/README.md\n@@ -56,7 +56,8 @@ First, generate a remap table from your existing vertex (and, optionally, index)\n size_t index_count = face_count * 3;\n size_t unindexed_vertex_count = face_count * 3;\n std::vector<unsigned int> remap(unindexed_vertex_count); // temporary remap table\n-size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count, &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n+size_t vertex_count = meshopt_generateVertexRemap(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0], unindexed_vertex_count, sizeof(Vertex));\n ```\n \n Note that in this case we only have an unindexed vertex buffer; when input mesh has an index buffer, it will need to be passed to `meshopt_generateVertexRemap` instead of `NULL`, along with the correct source vertex count. In either case, the remap table is generated based on binary equivalence of the input vertices, so the resulting mesh will render the same way. Binary equivalence considers all input bytes, including padding which should be zero-initialized if the vertex structure has gaps.\n@@ -70,7 +71,18 @@ meshopt_remapVertexBuffer(vertices, &unindexed_vertices[0], unindexed_vertex_cou\n \n You can then further optimize the resulting buffers by calling the other functions on them in-place.\n \n-`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use a custom weld algorithm that supports per-attribute tolerance instead.\n+`meshopt_generateVertexRemap` uses binary equivalence of vertex data, which is generally a reasonable default; however, in some cases some attributes may have floating point drift causing extra vertices to be generated. For such cases, it may be necessary to quantize some attributes (most importantly, normals and tangents) before generating the remap, or use `meshopt_generateVertexRemapCustom` algorithm that allows comparing individual attributes with tolerance by providing a custom comparison function:\n+\n+```c++\n+size_t vertex_count = meshopt_generateVertexRemapCustom(&remap[0], NULL, index_count,\n+    &unindexed_vertices[0].px, unindexed_vertex_count, sizeof(Vertex),\n+    [&](unsigned int lhs, unsigned int rhs) -> bool {\n+        const Vertex& lv = unindexed_vertices[lhs];\n+        const Vertex& rv = unindexed_vertices[rhs];\n+\n+        return fabsf(lv.tx - rv.tx) < 1e-3f && fabsf(lv.ty - rv.ty) < 1e-3f;\n+    });\n+```\n \n ## Vertex cache optimization\n \n@@ -573,6 +585,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_computeSphereBounds`*\n - `meshopt_encodeVertexBufferLevel`*\n - `meshopt_generateProvokingIndexBuffer`*\n+- `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\n - `meshopt_simplifySloppy`\n - `meshopt_spatialSortTriangles`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex 1e3e9ea2e..012a8524d 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -1287,6 +1287,44 @@ void provoking(const Mesh& mesh)\n \t    int(mesh.indices.size() / 3), int(pcount), double(pcount) / double(bestv) * 100.0 - 100.0, (end - start) * 1000);\n }\n \n+static int reindexCompare(void* context, unsigned int lhs, unsigned int rhs)\n+{\n+\tconst Vertex* vertices = static_cast<Vertex*>(context);\n+\tconst Vertex& lv = vertices[lhs];\n+\tconst Vertex& rv = vertices[rhs];\n+\n+\tfloat ln = lv.nx * lv.nx + lv.ny * lv.ny + lv.nz * lv.nz;\n+\tfloat rn = rv.nx * rv.nx + rv.ny * rv.ny + rv.nz * rv.nz;\n+\n+\t// 1/1024px UV tolerance, 3 degree normal tolerance\n+\treturn fabsf(lv.tx - rv.tx) < 1e-3f &&\n+\t       fabsf(lv.ty - rv.ty) < 1e-3f &&\n+\t       (lv.nx * rv.nx + lv.ny * rv.ny + lv.nz * rv.nz >= 0.9986f * sqrtf(ln * rn));\n+}\n+\n+void reindexFuzzy(const Mesh& mesh)\n+{\n+\tstd::vector<PackedVertex> pv(mesh.vertices.size());\n+\tpackMesh(pv, mesh.vertices);\n+\n+\tstd::vector<unsigned int> remap(mesh.vertices.size());\n+\n+\tdouble start = timestamp();\n+\n+\tsize_t up = meshopt_generateVertexRemap(&remap[0], &mesh.indices[0], mesh.indices.size(), &pv[0], mesh.vertices.size(), sizeof(PackedVertex));\n+\n+\tdouble middle = timestamp();\n+\n+\tsize_t uf = meshopt_generateVertexRemapCustom(&remap[0], &mesh.indices[0], mesh.indices.size(), &mesh.vertices[0].px, mesh.vertices.size(), sizeof(Vertex), reindexCompare, const_cast<Vertex*>(&mesh.vertices[0]));\n+\n+\tdouble end = timestamp();\n+\n+\tprintf(\"ReindexQ : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(up), (middle - start) * 1000);\n+\tprintf(\"ReindexF : %d vertices => %d unique vertices in %.2f msec\\n\",\n+\t    int(mesh.vertices.size()), int(uf), (end - middle) * 1000);\n+}\n+\n void nanite(const std::vector<Vertex>& vertices, const std::vector<unsigned int>& indices); // nanite.cpp\n \n bool loadMesh(Mesh& mesh, const char* path)\n@@ -1468,6 +1506,8 @@ void process(const char* path)\n \tspatialSort(mesh);\n \tspatialSortTriangles(mesh);\n \n+\treindexFuzzy(mesh);\n+\n \tif (path)\n \t\tprocessDeinterleaved(path);\n }\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex d5c744a59..bf231e32a 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -66,6 +66,15 @@ static void transformNormal(float* res, const float* ptr, const float* transform\n \tres[2] = z * s;\n }\n \n+static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n+{\n+\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n+\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n+\t\t\treturn &mesh.streams[i];\n+\n+\treturn NULL;\n+}\n+\n // assumes mesh & target are structurally identical\n static void transformMesh(Mesh& target, const Mesh& mesh, const cgltf_node* node)\n {\n@@ -722,15 +731,6 @@ static void filterTriangles(Mesh& mesh)\n \tmesh.indices.resize(write);\n }\n \n-static Stream* getStream(Mesh& mesh, cgltf_attribute_type type, int index = 0)\n-{\n-\tfor (size_t i = 0; i < mesh.streams.size(); ++i)\n-\t\tif (mesh.streams[i].type == type && mesh.streams[i].index == index)\n-\t\t\treturn &mesh.streams[i];\n-\n-\treturn NULL;\n-}\n-\n static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t stride, Mesh& mesh)\n {\n \tassert(stride >= 6); // normal + color\ndiff --git a/src/indexgenerator.cpp b/src/indexgenerator.cpp\nindex 0d53020e3..5f36d2463 100644\n--- a/src/indexgenerator.cpp\n+++ b/src/indexgenerator.cpp\n@@ -5,6 +5,7 @@\n #include <string.h>\n \n // This work is based on:\n+// Matthias Teschner, Bruno Heidelberger, Matthias Mueller, Danat Pomeranets, Markus Gross. Optimized Spatial Hashing for Collision Detection of Deformable Objects. 2003\n // John McDonald, Mark Kilgard. Crack-Free Point-Normal Triangles using Adjacent Edge Normals. 2010\n // John Hable. Variable Rate Shading with Visibility Buffer Rendering. 2024\n namespace meshopt\n@@ -86,6 +87,46 @@ struct VertexStreamHasher\n \t}\n };\n \n+struct VertexCustomHasher\n+{\n+\tconst float* vertex_positions;\n+\tsize_t vertex_stride_float;\n+\n+\tint (*callback)(void*, unsigned int, unsigned int);\n+\tvoid* context;\n+\n+\tsize_t hash(unsigned int index) const\n+\t{\n+\t\tconst unsigned int* key = reinterpret_cast<const unsigned int*>(vertex_positions + index * vertex_stride_float);\n+\n+\t\tunsigned int x = key[0], y = key[1], z = key[2];\n+\n+\t\t// replace negative zero with zero\n+\t\tx = (x == 0x80000000) ? 0 : x;\n+\t\ty = (y == 0x80000000) ? 0 : y;\n+\t\tz = (z == 0x80000000) ? 0 : z;\n+\n+\t\t// scramble bits to make sure that integer coordinates have entropy in lower bits\n+\t\tx ^= x >> 17;\n+\t\ty ^= y >> 17;\n+\t\tz ^= z >> 17;\n+\n+\t\t// Optimized Spatial Hashing for Collision Detection of Deformable Objects\n+\t\treturn (x * 73856093) ^ (y * 19349663) ^ (z * 83492791);\n+\t}\n+\n+\tbool equal(unsigned int lhs, unsigned int rhs) const\n+\t{\n+\t\tconst float* lp = vertex_positions + lhs * vertex_stride_float;\n+\t\tconst float* rp = vertex_positions + rhs * vertex_stride_float;\n+\n+\t\tif (lp[0] != rp[0] || lp[1] != rp[1] || lp[2] != rp[2])\n+\t\t\treturn false;\n+\n+\t\treturn callback ? callback(context, lhs, rhs) : true;\n+\t}\n+};\n+\n struct EdgeHasher\n {\n \tconst unsigned int* remap;\n@@ -183,6 +224,43 @@ static void buildPositionRemap(unsigned int* remap, const float* vertex_position\n \tallocator.deallocate(vertex_table);\n }\n \n+template <typename Hash>\n+static size_t generateVertexRemap(unsigned int* remap, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n+{\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n+\n+\tsize_t table_size = hashBuckets(vertex_count);\n+\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n+\tmemset(table, -1, table_size * sizeof(unsigned int));\n+\n+\tunsigned int next_vertex = 0;\n+\n+\tfor (size_t i = 0; i < index_count; ++i)\n+\t{\n+\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tassert(index < vertex_count);\n+\n+\t\tif (remap[index] != ~0u)\n+\t\t\tcontinue;\n+\n+\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n+\n+\t\tif (*entry == ~0u)\n+\t\t{\n+\t\t\t*entry = index;\n+\t\t\tremap[index] = next_vertex++;\n+\t\t}\n+\t\telse\n+\t\t{\n+\t\t\tassert(remap[*entry] != ~0u);\n+\t\t\tremap[index] = remap[*entry];\n+\t\t}\n+\t}\n+\n+\tassert(next_vertex <= vertex_count);\n+\treturn next_vertex;\n+}\n+\n template <size_t BlockSize>\n static void remapVertices(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n {\n@@ -197,55 +275,49 @@ static void remapVertices(void* destination, const void* vertices, size_t vertex\n \t\t}\n }\n \n-} // namespace meshopt\n-\n-size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+template <typename Hash>\n+static void generateShadowBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const Hash& hash, meshopt_Allocator& allocator)\n {\n-\tusing namespace meshopt;\n-\n-\tassert(indices || index_count == vertex_count);\n-\tassert(!indices || index_count % 3 == 0);\n-\tassert(vertex_size > 0 && vertex_size <= 256);\n-\n-\tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n-\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n+\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n \n \tsize_t table_size = hashBuckets(vertex_count);\n \tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n \tmemset(table, -1, table_size * sizeof(unsigned int));\n \n-\tunsigned int next_vertex = 0;\n-\n \tfor (size_t i = 0; i < index_count; ++i)\n \t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n+\t\tunsigned int index = indices[i];\n \t\tassert(index < vertex_count);\n \n-\t\tif (destination[index] == ~0u)\n+\t\tif (remap[index] == ~0u)\n \t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n+\t\t\tunsigned int* entry = hashLookup(table, table_size, hash, index, ~0u);\n \n \t\t\tif (*entry == ~0u)\n-\t\t\t{\n \t\t\t\t*entry = index;\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n-\n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n+\t\t\tremap[index] = *entry;\n \t\t}\n+\n+\t\tdestination[i] = remap[index];\n \t}\n+}\n \n-\tassert(next_vertex <= vertex_count);\n+} // namespace meshopt\n \n-\treturn next_vertex;\n+size_t meshopt_generateVertexRemap(unsigned int* destination, const unsigned int* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size)\n+{\n+\tusing namespace meshopt;\n+\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_size > 0 && vertex_size <= 256);\n+\n+\tmeshopt_Allocator allocator;\n+\tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_size};\n+\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -263,44 +335,24 @@ size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigne\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tmemset(destination, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tunsigned int next_vertex = 0;\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices ? indices[i] : unsigned(i);\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (destination[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t{\n-\t\t\t\t*entry = index;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n+}\n \n-\t\t\t\tdestination[index] = next_vertex++;\n-\t\t\t}\n-\t\t\telse\n-\t\t\t{\n-\t\t\t\tassert(destination[*entry] != ~0u);\n+size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context)\n+{\n+\tusing namespace meshopt;\n \n-\t\t\t\tdestination[index] = destination[*entry];\n-\t\t\t}\n-\t\t}\n-\t}\n+\tassert(indices || index_count == vertex_count);\n+\tassert(!indices || index_count % 3 == 0);\n+\tassert(vertex_positions_stride >= 12 && vertex_positions_stride <= 256);\n+\tassert(vertex_positions_stride % sizeof(float) == 0);\n \n-\tassert(next_vertex <= vertex_count);\n+\tmeshopt_Allocator allocator;\n+\tVertexCustomHasher hasher = {vertex_positions, vertex_positions_stride / sizeof(float), callback, context};\n \n-\treturn next_vertex;\n+\treturn generateVertexRemap(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_remapVertexBuffer(void* destination, const void* vertices, size_t vertex_count, size_t vertex_size, const unsigned int* remap)\n@@ -362,33 +414,9 @@ void meshopt_generateShadowIndexBuffer(unsigned int* destination, const unsigned\n \tassert(vertex_size <= vertex_stride);\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexHasher hasher = {static_cast<const unsigned char*>(vertices), vertex_size, vertex_stride};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count)\n@@ -406,33 +434,9 @@ void meshopt_generateShadowIndexBufferMulti(unsigned int* destination, const uns\n \t}\n \n \tmeshopt_Allocator allocator;\n-\n-\tunsigned int* remap = allocator.allocate<unsigned int>(vertex_count);\n-\tmemset(remap, -1, vertex_count * sizeof(unsigned int));\n-\n \tVertexStreamHasher hasher = {streams, stream_count};\n \n-\tsize_t table_size = hashBuckets(vertex_count);\n-\tunsigned int* table = allocator.allocate<unsigned int>(table_size);\n-\tmemset(table, -1, table_size * sizeof(unsigned int));\n-\n-\tfor (size_t i = 0; i < index_count; ++i)\n-\t{\n-\t\tunsigned int index = indices[i];\n-\t\tassert(index < vertex_count);\n-\n-\t\tif (remap[index] == ~0u)\n-\t\t{\n-\t\t\tunsigned int* entry = hashLookup(table, table_size, hasher, index, ~0u);\n-\n-\t\t\tif (*entry == ~0u)\n-\t\t\t\t*entry = index;\n-\n-\t\t\tremap[index] = *entry;\n-\t\t}\n-\n-\t\tdestination[i] = remap[index];\n-\t}\n+\tgenerateShadowBuffer(destination, indices, index_count, vertex_count, hasher, allocator);\n }\n \n void meshopt_generateAdjacencyIndexBuffer(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride)\ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 295324c78..54320c178 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -74,6 +74,19 @@ MESHOPTIMIZER_API size_t meshopt_generateVertexRemap(unsigned int* destination,\n  */\n MESHOPTIMIZER_API size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const unsigned int* indices, size_t index_count, size_t vertex_count, const struct meshopt_Stream* streams, size_t stream_count);\n \n+/**\n+ * Experimental: Generates a vertex remap table from the vertex buffer and an optional index buffer and returns number of unique vertices\n+ * As a result, all vertices that are equivalent map to the same (new) location, with no gaps in the resulting sequence.\n+ * Equivalence is checked in two steps: vertex positions are compared for equality, and then the user-specified equality function is called (if provided).\n+ * Resulting remap table maps old vertices to new vertices and can be used in meshopt_remapVertexBuffer/meshopt_remapIndexBuffer.\n+ *\n+ * destination must contain enough space for the resulting remap table (vertex_count elements)\n+ * indices can be NULL if the input is unindexed\n+ * vertex_positions should have float3 position in the first 12 bytes of each vertex\n+ * callback can be NULL if no additional equality check is needed; otherwise, it should return 1 if vertices with specified indices are equivalent and 0 if they are not\n+ */\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const unsigned int* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, int (*callback)(void*, unsigned int, unsigned int), void* context);\n+\n /**\n  * Generates vertex buffer from the source vertex buffer and remap table generated by meshopt_generateVertexRemap\n  *\n@@ -722,6 +735,8 @@ template <typename T>\n inline size_t meshopt_generateVertexRemap(unsigned int* destination, const T* indices, size_t index_count, const void* vertices, size_t vertex_count, size_t vertex_size);\n template <typename T>\n inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const T* indices, size_t index_count, size_t vertex_count, const meshopt_Stream* streams, size_t stream_count);\n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback);\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap);\n template <typename T>\n@@ -930,6 +945,19 @@ inline size_t meshopt_generateVertexRemapMulti(unsigned int* destination, const\n \treturn meshopt_generateVertexRemapMulti(destination, indices ? in.data : NULL, index_count, vertex_count, streams, stream_count);\n }\n \n+template <typename T, typename F>\n+inline size_t meshopt_generateVertexRemapCustom(unsigned int* destination, const T* indices, size_t index_count, const float* vertex_positions, size_t vertex_count, size_t vertex_positions_stride, F callback)\n+{\n+\tstruct Call\n+\t{\n+\t\tstatic int compare(void* context, unsigned int lhs, unsigned int rhs) { return (*static_cast<F*>(context))(lhs, rhs) ? 1 : 0; }\n+\t};\n+\n+\tmeshopt_IndexAdapter<T> in(NULL, indices, indices ? index_count : 0);\n+\n+\treturn meshopt_generateVertexRemapCustom(destination, indices ? in.data : NULL, index_count, vertex_positions, vertex_count, vertex_positions_stride, &Call::compare, &callback);\n+}\n+\n template <typename T>\n inline void meshopt_remapIndexBuffer(T* destination, const T* indices, size_t index_count, const unsigned int* remap)\n {\n", "instance_id": "zeux__meshoptimizer-862", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in its intent to extend the vertex remapping functionality in the `meshopt` library to support custom distance functions for comparing vertex attributes with tolerance, addressing issues like floating-point drift in attributes such as normals and tangents. It provides a specific goal (adding a variant of the algorithm for custom comparisons) and suggests implementation approaches (extending `meshopt_Stream` or passing a function pointer). However, there are minor ambiguities and missing details. For instance, it does not explicitly define the expected input and output formats for the custom comparison function beyond a vague mention of per-attribute tolerance. Additionally, edge cases (e.g., handling of invalid or null function pointers, performance implications of custom comparisons) and constraints (e.g., expected behavior for different vertex data layouts) are not addressed. The provided code changes help clarify the intent with examples, but the problem statement itself lacks comprehensive detail on these aspects, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, involving modifications across multiple files (`README.md`, `demo/main.cpp`, `gltf/mesh.cpp`, `src/indexgenerator.cpp`, `src/meshoptimizer.h`) and introducing a new API (`meshopt_generateVertexRemapCustom`). This requires understanding and modifying core logic in the vertex remapping functionality, which impacts a critical part of the mesh optimization library. Second, the technical concepts involved are moderately complex, including C++ template programming, function pointers/callbacks, hashing algorithms (with references to spatial hashing techniques), and domain-specific knowledge of 3D graphics (vertex attributes like normals and tangents, floating-point precision issues). Third, the changes require careful consideration of edge cases, such as ensuring the custom comparison function behaves correctly with different vertex data layouts, handling null or invalid callbacks, and maintaining performance efficiency in a performance-critical library. While the problem does not reach \"Very Hard\" (0.8-1.0) as it does not involve system-level or highly intricate domain-specific challenges beyond graphics, it still demands a deep understanding of the codebase architecture and careful implementation to avoid introducing bugs or performance regressions. A score of 0.65 reflects the need for advanced C++ skills, familiarity with the library's design, and attention to detail in a moderately complex feature addition.", "clarity_label": 0, "difficulty_label": 1, "human_clarity": 3, "human_difficulty": -1}
{"problem_statement": "Not ignoring comments on \"use database\" statements\nI find that the following works as expected:\r\n\r\n    use db /* COMMENT */\r\n\r\nit will connect to the database `db`.\r\n\r\nHowever, if there is a newline in the comment:\r\n\r\n    use db /*\r\n       COMMENT */\r\n\r\nit will try to switch to the database `db /* COMMENT */`, which obviously not what should happen. \r\n\r\nThe other types of comment aren't ignored either:\r\n\r\n    use db -- COMMENT\r\n    use db # COMMENT\r\n\r\nresult in attempts to switch to database `db -- COMMENT` and `db # COMMENT`.\r\n\r\nI have not seen this issue with other statements than the `use` statement, but I haven't done an exhaustive search.\n", "patch": "diff --git a/include/set_parser.h b/include/set_parser.h\nindex 5421868342..bd89bbab22 100644\n--- a/include/set_parser.h\n+++ b/include/set_parser.h\n@@ -42,6 +42,12 @@ class SetParser {\n \t// First implemenation of the parser for TRANSACTION ISOLATION LEVEL and TRANSACTION READ/WRITE\n \tstd::map<std::string, std::vector<std::string>> parse2();\n \tstd::string parse_character_set();\n+\tstd::string parse_USE_query();\n+\tstd::string remove_comments(const std::string& q);\n+#ifdef DEBUG\n+\t// built-in testing\n+\tvoid test_parse_USE_query();\n+#endif // DEBUG\n \t~SetParser();\n };\n \ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex b40d922539..42930c9b92 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -6138,30 +6138,27 @@ void MySQL_Session::handler___status_WAITING_CLIENT_DATA___STATE_SLEEP___MYSQL_C\n \tif (session_type == PROXYSQL_SESSION_MYSQL) {\n \t\t__sync_fetch_and_add(&MyHGM->status.frontend_use_db, 1);\n \t\tstring nq=string((char *)pkt->ptr+sizeof(mysql_hdr)+1,pkt->size-sizeof(mysql_hdr)-1);\n-\t\tRE2::GlobalReplace(&nq,(char *)\"(?U)/\\\\*.*\\\\*/\",(char *)\" \");\n-\t\tchar *sn_tmp = (char *)nq.c_str();\n-\t\twhile (sn_tmp < ( nq.c_str() + nq.length() - 4 ) && *sn_tmp == ' ')\n-\t\t\tsn_tmp++;\n-\t\t//char *schemaname=strdup(nq.c_str()+4);\n-\t\tchar *schemaname=strdup(sn_tmp+3);\n-\t\tchar *schemanameptr=trim_spaces_and_quotes_in_place(schemaname);\n-\t\t// handle cases like \"USE `schemaname`\n-\t\tif(schemanameptr[0]=='`' && schemanameptr[strlen(schemanameptr)-1]=='`') {\n-\t\t\tschemanameptr[strlen(schemanameptr)-1]='\\0';\n-\t\t\tschemanameptr++;\n-\t\t}\n-\t\tclient_myds->myconn->userinfo->set_schemaname(schemanameptr,strlen(schemanameptr));\n-\t\tfree(schemaname);\n-\t\tif (mirror==false) {\n+\t\tSetParser parser(nq);\n+\t\tstring schemaname = parser.parse_USE_query();\n+\t\tif (schemaname != \"\") {\n+\t\t\tclient_myds->myconn->userinfo->set_schemaname((char *)schemaname.c_str(),schemaname.length());\n+\t\t\tif (mirror==false) {\n+\t\t\t\tRequestEnd(NULL);\n+\t\t\t}\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tunsigned int nTrx=NumActiveTransactions();\n+\t\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n+\t\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n+\t\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n+\t\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n+\t\t} else {\n+\t\t\tl_free(pkt->size,pkt->ptr);\n+\t\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n+\t\t\tstd::string msg = \"Unable to parse: \" + nq;\n+\t\t\tclient_myds->myprot.generate_pkt_ERR(true,NULL,NULL,client_myds->pkt_sid+1,1148,(char *)\"42000\", msg.c_str());\n \t\t\tRequestEnd(NULL);\n \t\t}\n-\t\tl_free(pkt->size,pkt->ptr);\n-\t\tclient_myds->setDSS_STATE_QUERY_SENT_NET();\n-\t\tunsigned int nTrx=NumActiveTransactions();\n-\t\tuint16_t setStatus = (nTrx ? SERVER_STATUS_IN_TRANS : 0 );\n-\t\tif (autocommit) setStatus |= SERVER_STATUS_AUTOCOMMIT;\n-\t\tclient_myds->myprot.generate_pkt_OK(true,NULL,NULL,1,0,0,setStatus,0,NULL);\n-\t\tGloMyLogger->log_audit_entry(PROXYSQL_MYSQL_INITDB, this, NULL);\n \t\tclient_myds->DSS=STATE_SLEEP;\n \t} else {\n \t\tl_free(pkt->size,pkt->ptr);\ndiff --git a/lib/set_parser.cpp b/lib/set_parser.cpp\nindex 521808d642..7abef9adf1 100644\n--- a/lib/set_parser.cpp\n+++ b/lib/set_parser.cpp\n@@ -3,9 +3,11 @@\n #include <string>\n #include <vector>\n #include <map>\n-#ifdef PARSERDEBUG\n+#include <cassert>\n+#include <utility> // for std::pair\n+//#ifdef PARSERDEBUG\n #include <iostream>\n-#endif\n+//#endif\n \n using namespace std;\n \n@@ -506,3 +508,148 @@ std::string SetParser::parse_character_set() {\n \treturn value4;\n }\n \n+std::string SetParser::parse_USE_query() {\n+#ifdef DEBUG\n+\tproxy_debug(PROXY_DEBUG_MYSQL_QUERY_PROCESSOR, 4, \"Parsing query %s\\n\", query.c_str());\n+#endif // DEBUG\n+\n+\tre2::RE2::Options opt2(RE2::Quiet);\n+\topt2.set_case_sensitive(false);\n+\topt2.set_longest_match(false);\n+\n+\tstd::string dbname = remove_comments(query);\n+\tre2::RE2 re0(\"^\\\\s*\", opt2);\n+\tre2::RE2::Replace(&dbname, re0, \"\");\n+\tif (dbname.size() >= 4) {\n+\t\tif (\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE \",4) == 0\n+\t\t\t||\n+\t\t\tstrncasecmp(dbname.c_str(), \"USE`\",4) == 0\n+\t\t) {\n+\t\t\tre2::RE2 re1(\"^USE\\\\s*\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re1, \"\");\n+\t\t\tre2::RE2 re2(\"\\\\s*$\", opt2);\n+\t\t\tre2::RE2::Replace(&dbname, re2, \"\");\n+\t\t\tif (dbname[0] == '`') {\n+\t\t\t\tif (dbname.length() > 2) {\n+\t\t\t\t\tif (dbname[dbname.length()-1] == '`') {\n+\t\t\t\t\t\t// Remove the first character\n+\t\t\t\t\t\tdbname.erase(0, 1);\n+\t\t\t\t\t\t// Remove the last character\n+\t\t\t\t\t\tdbname.erase(dbname.length() - 1);\n+\t\t\t\t\t\treturn dbname;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\treturn dbname;\n+\t\t\t}\n+\t\t}\n+\t} else {\n+\t\treturn \"\";\n+\t}\n+\n+\treturn \"\";\n+}\n+\n+\n+std::string SetParser::remove_comments(const std::string& q) {\n+    std::string result = \"\";\n+    bool in_multiline_comment = false;\n+\n+    for (size_t i = 0; i < query.size(); ++i) {\n+        char current_char = query[i];\n+\n+        // Check for multiline comment start\n+        if (current_char == '/' && i + 1 < query.size() && query[i + 1] == '*') {\n+            in_multiline_comment = true;\n+            i++; // Skip the '*'\n+            continue;\n+        }   \n+\n+        // Check for multiline comment end\n+        if (in_multiline_comment && current_char == '*' && i + 1 < query.size() && query[i + 1] == '/') {\n+            in_multiline_comment = false;\n+            i++; // Skip the '/'\n+            continue;\n+        }   \n+\n+        // Skip characters inside multiline comment\n+        if (in_multiline_comment) {\n+            continue;\n+        }\n+\n+        // Check for single-line comments\n+        if (current_char == '#' || (current_char == '-' && i + 1 < query.size() && query[i + 1] == '-')) {\n+            // Skip until the end of the line\n+            while (i < query.size() && query[i] != '\\n') {\n+                i++;\n+            }\n+            continue;\n+        }\n+\n+        // Append the character to the result if it's not a comment\n+        result += current_char;\n+    }\n+\n+    return result;\n+}\n+\n+\n+#ifdef DEBUG\n+void SetParser::test_parse_USE_query() {\n+\n+\t// Define vector of pairs (query, expected dbname)\n+\tstd::vector<std::pair<std::string, std::string>> testCases = {\n+\t\t{\"USE my_database\",    \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database\",  \"my_database\"},                   // Basic Case\n+\t\t{\"USE   my_database \", \"my_database\"},                   // Basic Case\n+\t\t{\"/* comment */USE dbname /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */   USE   dbname\",            \"dbname\"}, // With Comments\n+\t\t{\"USE    dbname           /* comment */\",   \"dbname\"}, // With Comments\n+\t\t{\"/* comment */USE `dbname` /* comment */\", \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE`dbname` /* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment */USE `dbname`/* comment */\",  \"dbname\"}, // With backtick\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment */\", \"dbname\"}, // Multiline Comment\n+\t\t{\"/* comment */USE dbname # comment\",       \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname -- comment\",      \"dbname\"}, // Double Dash Comment\n+\t\t{\"/* comment */USE dbname   # comment\",     \"dbname\"}, // Hash Comment\n+\t\t{\"/* comment */USE dbname    -- comment\",   \"dbname\"}, // Double Dash Comment\n+\t\t{\"USE dbname   # comment\",                  \"dbname\"}, // Hash Comment\n+\t\t{\"USE dbname    -- comment\",                \"dbname\"}, // Double Dash Comment\n+\t\t{\"SELECT * FROM my_table\", \"\"}, // No match\n+\t\t{\"/*+ placeholder_comment */ USE test_use_comment\", \"test_use_comment\"},\n+\n+\t\t{\"USE /*+ placeholder_comment */ `test_use_comment-a1`\",  \"test_use_comment-a1\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment_1`\", \"test_use_comment_1\"},\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment_2`\",    \"test_use_comment_2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment_3`\",    \"test_use_comment_3\"},\n+\t\t{\"USE /*+ placeholder_comment */   test_use_comment_4\",   \"test_use_comment_4\"},\n+\t\t{\"USE/*+ placeholder_comment */ test_use_comment_5\",      \"test_use_comment_5\"},\n+\t\t{\"USE /*+ placeholder_comment */test_use_comment_6\",      \"test_use_comment_6\"},\n+\t\t{\"USE /*+ placeholder_comment */   `test_use_comment-1`\", \"test_use_comment-1\"},\n+\t\t{\"use my_database\", \"my_database\"},\n+\t\t{\"/* comment */  use dbname -- comment\",        \"dbname\"},\n+\t\t{\"/* comment\\nmultiline comment */USE dbname /* comment\\nmultiline comment */\", \"dbname\"}, // Multiline Comment\n+\n+\t\t{\"USE/*+ placeholder_comment */ `test_use_comment-2`\",      \"test_use_comment-2\"},\n+\t\t{\"USE /*+ placeholder_comment */`test_use_comment-3`\",      \"test_use_comment-3\"},\n+\t\t{\"/*+ placeholder_comment */USE      `test_use_comment-4`\", \"test_use_comment-4\"},\n+\t\t{\"USE/*+ placeholder_comment */`test_use_comment-5`\",       \"test_use_comment-5\"},\n+\t\t{\"/* comment */USE`test_use_comment-6`\",                    \"test_use_comment-6\"},\n+\t\t{\"USE`test_use_comment-7`\",                                 \"test_use_comment-7\"},\n+\t};\n+\n+\t// Run tests for each pair\n+\tfor (const auto& p : testCases) {\n+\t\tset_query(p.first);\n+\t\tstd::string dbname = parse_USE_query();\n+\t\tif (dbname != p.second) {\n+\t\t\t// we call parse_USE_query() again just to make it easier to create a breakpoint\n+\t\t\tstd::string s = parse_USE_query();\n+\t\t\tassert(s == p.second);\n+\t\t}\n+\t}\n+\n+}\n+#endif // DEBUG\ndiff --git a/src/main.cpp b/src/main.cpp\nindex c30a6bd999..d98743a604 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1976,6 +1976,13 @@ int main(int argc, const char * argv[]) {\n //\t\tstd::cerr << \"Main init phase0 completed in \";\n #endif\n \t}\n+#ifdef DEBUG\n+\t{\n+\t\t// Automated testing\n+\t\tSetParser parser(\"\");\n+\t\tparser.test_parse_USE_query();\n+\t}\n+#endif // DEBUG\n \t{\n \t\tcpu_timer t;\n \t\tProxySQL_Main_process_global_variables(argc, argv);\n", "instance_id": "sysown__proxysql-4605", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: comments in \"use database\" statements are not being ignored, leading to incorrect database name parsing when comments contain newlines or use different comment styles (e.g., --, #). The goal is evident—to ensure comments are properly stripped out before processing the database name. The statement provides specific examples of problematic inputs, which helps in understanding the issue. However, it lacks comprehensive details on edge cases beyond the provided examples (e.g., nested comments, malformed queries) and does not explicitly define the expected behavior for all comment types or positions. Additionally, there is no mention of performance constraints or compatibility requirements with other parts of the system. While the problem is valid and mostly clear, these minor omissions prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes involves multiple files (set_parser.h, set_parser.cpp, MySQL_Session.cpp, main.cpp), requiring modifications to both the parsing logic and integration into the existing codebase. The changes include adding new methods to handle comment removal and query parsing, which indicates a moderate level of complexity. Second, the technical concepts involved include string manipulation, regular expressions (via RE2), and understanding of SQL query syntax and comment styles, which are not overly complex but require careful implementation to avoid introducing bugs. Third, the problem necessitates handling various edge cases related to comment formats (multiline, single-line with # and --), whitespace, and quoted database names, as evidenced by the extensive test cases added in the code. However, the changes do not significantly impact the system's architecture, nor do they require advanced domain-specific knowledge or complex algorithms. The implementation is mostly straightforward once the logic for comment stripping is understood, though it requires attention to detail to ensure robustness. Therefore, a score of 0.45 reflects a medium difficulty level, involving moderate complexity across a few files with some edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[FirebaseDatabase] Databases are disconnected temporarily on app goes inactive state.\n### Description\n\nSince v10.27.0, `FirebaseDatabase` now temporarily goes offline when the app is in the inactive state (e.g., when control center is opened, when returning to the home screen, etc.) and comes back online after a while.\r\n\r\nIn v10.26.0, the behavior was below:\r\n<video width=300, src=\"https://github.com/user-attachments/assets/5008221a-169a-4c17-9266-84e0901ab503\" />\r\n\r\nbut is in v10.27.0 or later:\r\n<video width=300, src=\"https://github.com/user-attachments/assets/247d3c43-f295-4e9c-96c9-a3d8b9bf9a1a\" />\r\n\n\n### Reproducing the issue\n\n1. Create iOS App project\r\n2. Integrate Firebase project and add `FirebaseDatabase` package\r\n3. Replace App code with like this:\r\n\r\n```swift\r\nimport SwiftUI\r\nimport UIKit\r\nimport FirebaseCore\r\nimport FirebaseDatabase\r\n\r\n@main\r\nstruct RtdbReproIOSApp: App {\r\n    \r\n    @UIApplicationDelegateAdaptor (AppDelegate.self) var appDelegate\r\n    \r\n    var body: some Scene {\r\n        WindowGroup {\r\n            ContentView()\r\n        }\r\n    }\r\n}\r\n\r\nclass AppDelegate: NSObject, UIApplicationDelegate {\r\n    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil) -> Bool {\r\n        FirebaseApp.configure()\r\n        \r\n        let connectedRef = Database.database().reference(withPath: \".info/connected\")\r\n        connectedRef.observe(.value, with: { snapshot in\r\n          if snapshot.value as? Bool ?? false {\r\n            print(\"Connected\")\r\n          } else {\r\n            print(\"Not connected\")\r\n          }\r\n        })\r\n        \r\n        return true\r\n    }\r\n}\r\n\r\n```\n\n### Firebase SDK Version\n\n10.27.0\n\n### Xcode Version\n\n15.3\n\n### Installation Method\n\nSwift Package Manager\n\n### Firebase Product(s)\n\nDatabase\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n_No response_\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n{\r\n  \"originHash\" : \"c63c63846d9c539229e96de38d6af51417e28c0ee9a0bc48bd0f0f19d923c329\",\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-binary\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/abseil-cpp-binary.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"194a6706acbd25e4ef639bcaddea16e8758a3e27\",\r\n        \"version\" : \"1.2024011602.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"app-check\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/app-check.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"3b62f154d00019ae29a71e9738800bb6f18b236d\",\r\n        \"version\" : \"10.19.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"8bcaf973b1d84e119b7c7c119abad72ed460979f\",\r\n        \"version\" : \"10.27.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"70df02431e216bed98dd461e0c4665889245ba70\",\r\n        \"version\" : \"10.27.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a637d318ae7ae246b02d7305121275bc75ed5565\",\r\n        \"version\" : \"9.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"57a1d307f42df690fdef2637f3e5b776da02aad6\",\r\n        \"version\" : \"7.13.3\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-binary\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/grpc-binary.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"e9fad491d0673bdda7063a0341fb6b47a30c5359\",\r\n        \"version\" : \"1.62.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a2ab612cb980066ee56d90d60d8462992c07f24b\",\r\n        \"version\" : \"3.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"interop-ios-for-google-sdks\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/interop-ios-for-google-sdks.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"2d12673670417654f08f5f90fdd62926dc3a2648\",\r\n        \"version\" : \"100.0.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"a0bc79961d7be727d258d33d5a6b2f1023270ba1\",\r\n        \"version\" : \"1.22.5\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"b7e1104502eca3a213b46303391ca4d3bc8ddec1\",\r\n        \"version\" : \"2.30910.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"540318ecedd63d883069ae7f1ed811a2df00b6ac\",\r\n        \"version\" : \"2.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"e17d61f26df0f0e06f58f6977ba05a097a720106\",\r\n        \"version\" : \"1.27.1\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 3\r\n}\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseDatabase/CHANGELOG.md b/FirebaseDatabase/CHANGELOG.md\nindex 7ee5692d4f0..7df20ba497e 100644\n--- a/FirebaseDatabase/CHANGELOG.md\n+++ b/FirebaseDatabase/CHANGELOG.md\n@@ -1,3 +1,7 @@\n+# Unreleased\n+- [fixed] Fix temporary disconnects when the app goes inactive. The issue was\n+  introduced in 10.27.0. (#13529)\n+\n # 11.0.0\n - [removed] **Breaking change**: The deprecated `FirebaseDatabaseSwift`\n   module has been removed. See\ndiff --git a/FirebaseDatabase/Sources/Core/FPersistentConnection.m b/FirebaseDatabase/Sources/Core/FPersistentConnection.m\nindex 8c22814df00..f07ee977246 100644\n--- a/FirebaseDatabase/Sources/Core/FPersistentConnection.m\n+++ b/FirebaseDatabase/Sources/Core/FPersistentConnection.m\n@@ -34,11 +34,9 @@\n #import \"FirebaseDatabase/Sources/Utilities/FUtilities.h\"\n #import \"FirebaseDatabase/Sources/Utilities/Tuples/FTupleCallbackStatus.h\"\n #import \"FirebaseDatabase/Sources/Utilities/Tuples/FTupleOnDisconnect.h\"\n-#if TARGET_OS_WATCH\n-#import <WatchKit/WatchKit.h>\n-#else\n+#if !TARGET_OS_WATCH\n #import <SystemConfiguration/SystemConfiguration.h>\n-#endif // TARGET_OS_WATCH\n+#endif // !TARGET_OS_WATCH\n #import <dlfcn.h>\n #import <netinet/in.h>\n \n@@ -168,7 +166,6 @@ - (id)initWithRepoInfo:(FRepoInfo *)repoInfo\n                         retryExponent:kPersistentConnReconnectMultiplier\n                          jitterFactor:0.7];\n \n-        [self setupNotifications];\n         // Make sure we don't actually connect until open is called\n         [self interruptForReason:kFInterruptReasonWaitingForOpen];\n     }\n@@ -553,29 +550,6 @@ - (void)openNetworkConnectionWithContext:\n     [self.realtime open];\n }\n \n-- (void)enteringForeground {\n-    dispatch_async(self.dispatchQueue, ^{\n-      // Reset reconnect delay\n-      [self.retryHelper signalSuccess];\n-      if (self->connectionState == ConnectionStateDisconnected) {\n-          [self tryScheduleReconnect];\n-      }\n-    });\n-}\n-\n-- (void)setupNotifications {\n-#if TARGET_OS_WATCH\n-    __weak FPersistentConnection *weakSelf = self;\n-    NSNotificationCenter *center = [NSNotificationCenter defaultCenter];\n-    [center addObserverForName:WKApplicationWillEnterForegroundNotification\n-                        object:nil\n-                         queue:nil\n-                    usingBlock:^(NSNotification *_Nonnull note) {\n-                      [weakSelf enteringForeground];\n-                    }];\n-#endif // TARGET_OS_WATCH\n-}\n-\n - (void)sendAuthAndRestoreStateAfterComplete:(BOOL)restoreStateAfterComplete {\n     NSAssert([self connected], @\"Must be connected to send auth\");\n     NSAssert(self.authToken != nil,\ndiff --git a/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m b/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\nindex 6aa9d7365e5..078fbb06ef6 100644\n--- a/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\n+++ b/FirebaseDatabase/Sources/Realtime/FWebSocketConnection.m\n@@ -110,27 +110,6 @@ - (instancetype)initWith:(FRepoInfo *)repoInfo\n             NSURLSessionWebSocketTask *task =\n                 [session webSocketTaskWithRequest:req];\n             self.webSocketTask = task;\n-\n-#if TARGET_OS_IOS || TARGET_OS_TV || TARGET_OS_VISION || TARGET_OS_MACCATALYST\n-            NSString *resignName = UIApplicationWillResignActiveNotification;\n-#elif TARGET_OS_OSX\n-            NSString *resignName = NSApplicationWillResignActiveNotification;\n-#elif TARGET_OS_WATCH\n-            NSString *resignName = WKApplicationWillResignActiveNotification;\n-#elif\n-#error(\"missing platform\")\n-#endif\n-            [[NSNotificationCenter defaultCenter]\n-                addObserverForName:resignName\n-                            object:nil\n-                             queue:opQueue\n-                        usingBlock:^(NSNotification *_Nonnull note) {\n-                          FFLog(@\"I-RDB083015\",\n-                                @\"Received notification that application \"\n-                                @\"will resign, \"\n-                                @\"closing web socket.\");\n-                          [self onClosed];\n-                        }];\n         }\n     }\n     return self;\n", "instance_id": "firebase__firebase-ios-sdk-13564", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: FirebaseDatabase temporarily disconnects when the app goes into an inactive state starting from version 10.27.0, which was not the behavior in version 10.26.0. The description includes steps to reproduce the issue, relevant version information, and even video evidence of the behavior change, which aids in understanding the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"inactive state\" entails beyond examples (e.g., opening the control center or returning to the home screen). Additionally, it lacks specifics on expected behavior (e.g., should the connection remain active indefinitely in inactive states, or is there a specific timeout?). Edge cases, such as behavior during prolonged inactivity or network interruptions during state transitions, are not mentioned. Overall, while the core issue is clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting two files (`FPersistentConnection.m` and `FWebSocketConnection.m`) within the FirebaseDatabase module. The changes involve removing notification listeners for app state transitions (e.g., resigning active state) and associated logic for handling foreground/background transitions, which suggests a targeted fix to prevent unnecessary disconnections. However, understanding the impact requires knowledge of iOS app lifecycle events, Objective-C notification mechanisms, and the Firebase SDK's internal connection management logic, which adds moderate complexity. The technical concepts involved include familiarity with platform-specific notifications (e.g., `UIApplicationWillResignActiveNotification`), WebSocket connection handling, and the FirebaseDatabase's persistent connection architecture. While the changes do not appear to impact the broader system architecture significantly, they do require careful consideration of connection state management and potential side effects on reconnection logic. Edge cases, such as app behavior during rapid state transitions or network instability, are not explicitly addressed in the problem statement but may need to be considered during implementation or testing, adding a layer of complexity. Overall, this problem requires a moderate depth of understanding and careful modification across a couple of files, justifying a difficulty score of 0.55, which sits in the medium range (0.4-0.6) due to the need for specific domain knowledge and attention to potential unintended consequences.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "FIRRemoteConfigValue.stringValue is not nullable\n### Description\r\n\r\nFIRRemoteConfigValue.stringValue is marked `nullable` in the header file but will never return `null` as the implement.\r\nhttps://github.com/firebase/firebase-ios-sdk/blob/60f9a33e7084482df67b48e16f315f4f7a6f5da9/FirebaseRemoteConfig/Sources/FIRConfigValue.m#L43-L46\r\nIt would be thankful to implement it as `nullable`, before that marking it `nonnull` would be enough.\r\n\r\n### Firebase SDK Version\r\n\r\n9.6.0\r\n\r\n### Xcode Version\r\n\r\n14.1\r\n\r\n### Installation Method\r\n\r\nCocoaPods\r\n\r\n### Firebase Product(s)\r\n\r\nRemote Config\r\n\r\n### Targeted Platforms\r\n\r\niOS\n", "patch": "diff --git a/FirebaseRemoteConfig/CHANGELOG.md b/FirebaseRemoteConfig/CHANGELOG.md\nindex 2a3024918c8..ff8a8a72050 100644\n--- a/FirebaseRemoteConfig/CHANGELOG.md\n+++ b/FirebaseRemoteConfig/CHANGELOG.md\n@@ -1,4 +1,7 @@\n-# 10.25.0\n+# 11.0.0\n+- [fixed] RemoteConfigValue stringValue is now `nonnull`. This may break some builds. (#10870)\n+\n+  # 10.25.0\n - [fixed] Fixed bug preventing Remote Config from working with a custom sqlite3\n   dependency (#10884).\n \ndiff --git a/FirebaseRemoteConfig/Sources/FIRConfigValue.m b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\nindex 8ab2d30d77a..e68d9c1312d 100644\n--- a/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n+++ b/FirebaseRemoteConfig/Sources/FIRConfigValue.m\n@@ -41,8 +41,8 @@ - (instancetype)init {\n }\n \n /// The string is a UTF-8 representation of NSData.\n-- (NSString *)stringValue {\n-  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding];\n+- (nonnull NSString *)stringValue {\n+  return [[NSString alloc] initWithData:_data encoding:NSUTF8StringEncoding] ?: @\"\";\n }\n \n /// Number representation of a UTF-8 string.\ndiff --git a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\nindex 29cd12a5143..0a45617545f 100644\n--- a/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n+++ b/FirebaseRemoteConfig/Sources/Public/FirebaseRemoteConfig/FIRRemoteConfig.h\n@@ -138,7 +138,7 @@ typedef void (^FIRRemoteConfigFetchAndActivateCompletion)(\n NS_SWIFT_NAME(RemoteConfigValue)\n @interface FIRRemoteConfigValue : NSObject <NSCopying>\n /// Gets the value as a string.\n-@property(nonatomic, readonly, nullable) NSString *stringValue;\n+@property(nonatomic, readonly, nonnull) NSString *stringValue;\n /// Gets the value as a number value.\n @property(nonatomic, readonly, nonnull) NSNumber *numberValue;\n /// Gets the value as a NSData object.\ndiff --git a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\nindex d0cea378995..f2d56542760 100644\n--- a/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n+++ b/FirebaseRemoteConfig/Swift/FirebaseRemoteConfigValueDecoderHelper.swift\n@@ -35,7 +35,7 @@ struct FirebaseRemoteConfigValueDecoderHelper: FirebaseRemoteConfigValueDecoding\n   }\n \n   func stringValue() -> String {\n-    return value.stringValue ?? \"\"\n+    return value.stringValue\n   }\n \n   func dataValue() -> Data {\ndiff --git a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\nindex 7bf81c97a37..6665dd91258 100644\n--- a/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n+++ b/FirebaseRemoteConfigSwift/Tests/SwiftAPI/APITests.swift\n@@ -188,12 +188,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n@@ -204,13 +199,7 @@ class APITests: APITestBase {\n     let expectation2 = self.expectation(description: #function + \"2\")\n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.yoda)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n-\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.yoda)\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -239,13 +228,10 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.sith).stringValue {\n-        XCTAssertEqual(configValue, Constants.darthSidious)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.sith)\")\n-      }\n-\n+      XCTAssertEqual(\n+        self.config.configValue(forKey: Constants.sith).stringValue,\n+        Constants.darthSidious\n+      )\n       expectation2.fulfill()\n     }\n     waitForExpectations()\n@@ -258,12 +244,7 @@ class APITests: APITestBase {\n \n     config.fetchAndActivate { status, error in\n       XCTAssertNil(error, \"Fetch & Activate Error \\(error!)\")\n-\n-      if let configValue = self.config.configValue(forKey: Constants.jedi).stringValue {\n-        XCTAssertEqual(configValue, Constants.obiwan)\n-      } else {\n-        XCTFail(\"Could not unwrap config value for key: \\(Constants.jedi)\")\n-      }\n+      XCTAssertEqual(self.config.configValue(forKey: Constants.jedi).stringValue, Constants.obiwan)\n       expectation.fulfill()\n     }\n     waitForExpectations()\n", "instance_id": "firebase__firebase-ios-sdk-13065", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the `FIRRemoteConfigValue.stringValue` property is marked as `nullable` in the header file but does not return `null` in the implementation, and the request is to update the annotation to `nonnull` as a temporary fix. The goal (changing the nullability annotation) and the context (Firebase Remote Config for iOS) are specified, along with relevant links to the codebase. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the potential impact on users or downstream code that might rely on the `nullable` behavior, nor does it mention any specific edge cases or constraints to consider when making this change. Additionally, while the desired outcome (marking as `nonnull`) is clear, there is no discussion of why the implementation cannot return `null` or whether a future change to make it truly `nullable` is planned. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The changes are localized to a few files, primarily involving updating the nullability annotation in the header file (`FIRRemoteConfig.h`), modifying the implementation to ensure a non-null return value (`FIRConfigValue.m`), and updating related Swift code and tests to reflect this change. The diff shows modifications across five files, but the changes are straightforward—mostly annotation updates and removing null checks in Swift code. There is no significant impact on the system's architecture, as this is a semantic adjustment rather than a functional overhaul. The amount of code change is minimal.\n\n2. **Number of Technical Concepts**: The problem requires basic understanding of Objective-C nullability annotations (`nullable` vs `nonnull`), Swift interoperability with Objective-C, and how these annotations affect API usage. No advanced algorithms, design patterns, or domain-specific knowledge beyond iOS development basics are needed. Familiarity with the Firebase SDK structure is helpful but not critical, as the changes are well-contained.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes address a potential issue where `stringValue` could return `nil` if the data-to-string conversion fails. The updated implementation returns an empty string (`@\"\"`) as a fallback, which is a simple but effective way to ensure non-null behavior. No complex error handling or additional edge case logic is required beyond this.\n\n4. **Overall Complexity**: The task involves understanding a small part of the codebase and making targeted, low-risk changes. While it requires attention to detail to ensure consistency across Objective-C and Swift interfaces, it does not demand deep architectural knowledge or complex refactoring. The primary challenge is ensuring that downstream consumers of the API are not broken by this change, as noted in the changelog (\"This may break some builds\"), but the code modifications themselves are simple.\n\nGiven these factors, a difficulty score of 0.25 reflects an \"Easy\" problem that requires minimal effort beyond basic code modifications and a surface-level understanding of nullability in Objective-C/Swift interoperability.", "clarity_label": 0, "difficulty_label": 1, "human_clarity": 1, "human_difficulty": -1}
{"problem_statement": "[Bug]: SIGSEGV crash when maximizing window\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n30.0.0-alpha7\r\n\r\n### What operating system are you using?\r\n\r\nUbuntu\r\n\r\n### Operating System Version\r\n\r\n20.04, running on x11\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n30.0.0-alpha6\r\n\r\n### Expected Behavior\r\n\r\nMaximizing/fullscreening the app does not sigfault.\r\n\r\n### Actual Behavior\r\n\r\nMaximizing/fullscreening the window crashes the app.\r\n\r\n### Testcase Gist URL\r\n\r\nThis is visible in the default Fiddle template that opens with the app\r\n\r\n### Additional Information\r\n\r\nThere is no `render-process-gone` or `child-process-gone` event called when it crashes.\r\n\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex cd97a83b93a3b..8ab128530c726 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -129,3 +129,4 @@ fix_add_support_for_skipping_first_2_no-op_refreshes_in_thumb_cap.patch\n refactor_expose_file_system_access_blocklist.patch\n revert_power_update_trace_counter_in_power_monitor.patch\n feat_add_support_for_missing_dialog_features_to_shell_dialogs.patch\n+fix_partially_revert_invalidate_focusring.patch\ndiff --git a/patches/chromium/fix_partially_revert_invalidate_focusring.patch b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\nnew file mode 100644\nindex 0000000000000..614f42b4acd3d\n--- /dev/null\n+++ b/patches/chromium/fix_partially_revert_invalidate_focusring.patch\n@@ -0,0 +1,58 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: VerteDinde <keeleymhammond@gmail.com>\n+Date: Mon, 6 May 2024 11:03:08 -0700\n+Subject: fix: partially revert views invalidate FocusRing when its host is\n+ invalidated\n+\n+This reverts commit f425c438dfb11fb714655c999ba8c74b58393425. This\n+commit seems to be causing a sporadic crash on Ubuntu and other Linux\n+distros. This patch can be reverted when the issue is fixed upstream, or\n+when the crash is addressed.\n+\n+diff --git a/ui/views/view.cc b/ui/views/view.cc\n+index 94b026cda4738e489f1d7201c996f6db70d018ed..32ec794f4683be5ded78dcf310d3623b8748c236 100644\n+--- a/ui/views/view.cc\n++++ b/ui/views/view.cc\n+@@ -911,16 +911,6 @@ void View::Layout(PassKey) {\n+ }\n+ \n+ void View::InvalidateLayout() {\n+-  if (invalidating_) {\n+-    return;\n+-  }\n+-\n+-  // There is no need to `InvalidateLayout()` when `Widget::IsClosed()`.\n+-  if (Widget* widget = GetWidget(); widget && widget->IsClosed()) {\n+-    return;\n+-  }\n+-\n+-  base::AutoReset<bool> invalidating(&invalidating_, true);\n+   // We should never need to invalidate during a layout call; this tracks\n+   // how many times that is happening.\n+   ++invalidates_during_layout_;\n+@@ -928,11 +918,6 @@ void View::InvalidateLayout() {\n+   // Always invalidate up. This is needed to handle the case of us already being\n+   // valid, but not our parent.\n+   needs_layout_ = true;\n+-\n+-  for (ViewObserver& observer : observers_) {\n+-    observer.OnViewLayoutInvalidated(this);\n+-  }\n+-\n+   if (HasLayoutManager()) {\n+     GetLayoutManager()->InvalidateLayout();\n+   }\n+diff --git a/ui/views/view.h b/ui/views/view.h\n+index ea7d5441dbbfb713a6ffb57bcc07fb55fa574016..54b4c0a2871f214a4806fd863f32b8d010c09058 100644\n+--- a/ui/views/view.h\n++++ b/ui/views/view.h\n+@@ -2343,9 +2343,6 @@ class VIEWS_EXPORT View : public ui::LayerDelegate,\n+   // it is happening.\n+   int invalidates_during_layout_ = 0;\n+ \n+-  // Whether this view is in the middle of InvalidateLayout().\n+-  bool invalidating_ = false;\n+-\n+   // The View's LayoutManager defines the sizing heuristics applied to child\n+   // Views. The default is absolute positioning according to bounds_.\n+   std::unique_ptr<LayoutManager> layout_manager_;\n", "instance_id": "electron__electron-42126", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a SIGSEGV crash occurs when maximizing or fullscreening a window in Electron version 30.0.0-alpha7 on Ubuntu 20.04 with X11. It provides context about the environment, the expected behavior (no crash), and the actual behavior (crash). Additionally, it mentions the lack of specific events (`render-process-gone` or `child-process-gone`) during the crash, which is useful for debugging. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify under what exact conditions the crash occurs (e.g., specific window states or user actions beyond maximizing/fullscreening), nor does it provide detailed reproduction steps beyond referencing the default Fiddle template. Edge cases or specific configurations that might trigger the crash are also not mentioned. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is rated as Hard (0.75) based on several factors. First, the scope of the code changes involves modifying a patch to Chromium's codebase, specifically reverting a previous commit related to focus ring invalidation in the `ui/views` module. While the change itself is localized to a single file (`ui/views/view.cc` and `ui/views/view.h`), it requires understanding the broader implications of reverting this logic, as it impacts how view layouts are invalidated—a core part of the UI rendering system in Chromium. This suggests a need to understand interactions between different components of the UI system, even if the actual code change is relatively small (removing a few lines and a variable).\n\nSecond, the technical concepts involved are moderately complex. The developer must be familiar with Chromium's UI framework, specifically the `views` module, and understand the implications of layout invalidation and focus ring behavior. Additionally, knowledge of how these changes affect window management on Linux (X11) is necessary, as the crash is platform-specific. Debugging a SIGSEGV crash also implies familiarity with low-level debugging tools and potentially memory management issues, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the nature of a crash on window maximization suggests potential edge cases related to window states, display configurations, or specific X11 interactions. The code change (reverting a commit) is a temporary workaround rather than a root cause fix, which implies that a full solution might require deeper investigation into why the original commit causes a crash, further increasing the difficulty.\n\nFinally, the impact of this change is significant because it affects a core UI behavior in a widely-used framework (Electron/Chromium). While the patch itself does not alter the system's architecture directly, any change to UI rendering logic can have downstream effects on application stability and user experience, requiring careful consideration and testing. Given the need for deep understanding of Chromium's internals, platform-specific behavior, and the potential for subtle bugs or regressions, I rate this problem as Hard with a difficulty score of 0.75. It falls short of Very Hard (0.8-1.0) because the provided solution is a straightforward revert rather than a novel implementation or system-level redesign, but it still demands significant expertise and caution.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Unexpected image buffer size when creating PortableCompressedTexture2D from Image\n### Tested versions\n\n- Reproducible in v4.5.dev [1f56d96cf], 4.4.1.stable [96579d139]\n\n### System information\n\nWindows 11 Vulkan (Forward+)\n\n### Issue description\n\nWhen trying to create a PortableCompressedTexture2D from an Image, the following error shows when using compressed formats.\n```\n  ERROR: Expected Image data size of 512x512x3 (RGB8 without mipmaps) = 786432 bytes, got 131072 bytes instead.\n  ERROR: Width must be equal or greater than 1 for all textures\n```\nIf `COMPRESSION_MODE_LOSSLESS `is used, there's no error displayed. Most probably, what's happening is that the Image data buffer is compressed here:\nhttps://github.com/godotengine/godot/blob/1f56d96cf2c768c3844c68ccb504dfeee841ae15/scene/resources/portable_compressed_texture.cpp#L182-L204\nSo the buffer is no longer of the expected size, since it is compressed.\n\n### Steps to reproduce\n\n- Open the MRP.\n- Open the script `test.gd`\n- Then run the script with File > Run\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/19578958/test.zip)\n", "patch": "diff --git a/scene/resources/portable_compressed_texture.cpp b/scene/resources/portable_compressed_texture.cpp\nindex 99317af5a113..32c7a0965e6a 100644\n--- a/scene/resources/portable_compressed_texture.cpp\n+++ b/scene/resources/portable_compressed_texture.cpp\n@@ -171,6 +171,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t}\n \t\t} break;\n \t\tcase COMPRESSION_MODE_BASIS_UNIVERSAL: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_BASIS_UNIVERSAL, buffer.ptrw() + 2);\n \t\t\tImage::UsedChannels uc = p_image->detect_used_channels(p_normal_map ? Image::COMPRESS_SOURCE_NORMAL : Image::COMPRESS_SOURCE_GENERIC);\n \t\t\tVector<uint8_t> budata = Image::basis_universal_packer(p_image, uc);\n@@ -180,6 +181,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\tcase COMPRESSION_MODE_S3TC:\n \t\tcase COMPRESSION_MODE_ETC2:\n \t\tcase COMPRESSION_MODE_BPTC: {\n+\t\t\tERR_FAIL_COND(p_image->is_compressed());\n \t\t\tencode_uint16(DATA_FORMAT_IMAGE, buffer.ptrw() + 2);\n \t\t\tRef<Image> copy = p_image->duplicate();\n \t\t\tswitch (p_compression_mode) {\n@@ -195,7 +197,7 @@ void PortableCompressedTexture2D::create_from_image(const Ref<Image> &p_image, C\n \t\t\t\tdefault: {\n \t\t\t\t};\n \t\t\t}\n-\n+\t\t\tencode_uint32(copy->get_format(), buffer.ptrw() + 4);\n \t\t\tbuffer.append_array(copy->get_data());\n \n \t\t} break;\n", "instance_id": "godotengine__godot-104962", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an unexpected image buffer size error occurs when creating a `PortableCompressedTexture2D` from an `Image` using compressed formats in the Godot engine. It provides specific error messages, the context of the issue (compressed formats vs. lossless compression), and steps to reproduce the problem with a minimal reproduction project (MRP). Additionally, it points to a specific part of the codebase where the issue likely originates. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or desired outcome (e.g., should the buffer size check be adjusted, or should compression be handled differently?). It also lacks mention of specific edge cases or constraints beyond the general issue with compressed formats. While the issue is reproducible and the description is actionable, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`portable_compressed_texture.cpp`) and involve a small number of lines (adding error checks and encoding format data). The modifications do not impact the broader system architecture or require changes across multiple modules. The changes are straightforward, focusing on adding validation to prevent processing already compressed images and storing additional format information.\n\n2. **Technical Concepts Involved**: Solving this issue requires a basic understanding of image compression formats and how they are handled in the Godot engine. Familiarity with the `Image` class and its methods (e.g., `is_compressed()`, `get_format()`) is necessary, but these are not particularly advanced concepts. No complex algorithms, design patterns, or domain-specific knowledge beyond general graphics programming are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the general issue with compressed formats. The code changes introduce basic error handling (`ERR_FAIL_COND`) to prevent processing already compressed images, which is a simple and standard approach in this context. There are no indications of complex edge cases or performance considerations that need to be addressed.\n\n4. **Overall Complexity**: The issue requires understanding a specific part of the codebase and making targeted modifications to fix a bug. It does not involve deep architectural changes or intricate logic. The solution is relatively mechanical—adding checks and encoding additional data—making it accessible to developers with moderate experience in C++ and graphics programming.\n\nGiven these points, a difficulty score of 0.35 reflects the need for some code logic understanding and simple modifications, but the problem remains on the easier side of the spectrum due to its localized scope and limited complexity.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": ".import / .uid file is not removed when original file is not in root directory and gets removed outside editor\n### Tested versions\n\n4.4 dev4\nLikely earlier too.\n\n### System information\n\nWindows 10.0.19045 - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1060 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 threads)\n\n### Issue description\n\nWhen you delete a file outside editor, Godot tries to delete corresponding .import/.uid file. However this only happens if the file is in the project's root directory. If it's in any subdirectory, the other file just stays there and you have to delete it manually.\n\n### Steps to reproduce\n\n1. Open project's root directory in OS' file manager\n2. Delete icon.svg\n3. Focus the editor\n4. The engine will process FileSystem and automatically delete icon.svg.import.\n5. Try again with icon.svg in a subfolder\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 42cd8632941d..6e76f06a3095 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -933,15 +933,16 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n+\t\t\t\tconst String file_path = ia.dir->get_file_path(idx);\n+\t\t\t\tconst String class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n+\t\t\t\t\t_queue_update_script_class(file_path, ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n-\t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n+\t\t\t\t\t_queue_update_scene_groups(file_path);\n \t\t\t\t}\n \n-\t\t\t\t_delete_internal_files(ia.dir->files[idx]->file);\n+\t\t\t\t_delete_internal_files(file_path);\n \t\t\t\tmemdelete(ia.dir->files[idx]);\n \t\t\t\tia.dir->files.remove_at(idx);\n \n", "instance_id": "godotengine__godot-104669", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when a file is deleted outside the Godot editor, the corresponding .import/.uid file is only removed if the original file is in the project's root directory, but not if it's in a subdirectory. The steps to reproduce are provided, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior (though it can be inferred that .import/.uid files should be deleted regardless of the directory). Additionally, there are no mentions of potential edge cases, such as what happens if the .import/.uid file is missing or if there are permission issues. The lack of a minimal reproduction project (MRP) also slightly hinders clarity for someone unfamiliar with the Godot engine's file system handling. Overall, the description is valid and mostly clear but lacks some minor details for a fully comprehensive understanding.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`editor_file_system.cpp`) and involve a small modification (a few lines of code). The change primarily involves updating a variable (`file_path`) to ensure the correct path is used when deleting internal files. It does not impact the broader system architecture or require changes across multiple modules. The amount of code change is minimal.\n\n2. **Technical Concepts Involved**: Solving this issue requires a basic understanding of file path handling in C++ and familiarity with the Godot engine's internal file system logic. The concepts involved are relatively straightforward—string manipulation for file paths and invoking a deletion function. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic file system operations are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or modify error handling logic. However, a developer might need to consider scenarios like invalid paths or missing .import/.uid files, though these are not complex to handle in this context. The simplicity of the fix suggests that edge case handling is not a significant factor in the difficulty.\n\n4. **Overall Complexity**: The task requires understanding a small part of the codebase (specifically, how file deletion is triggered in the editor's file system) and making a simple adjustment to use the full file path instead of just the file name. While it involves some logic understanding, it does not require deep knowledge of the entire codebase or complex refactoring.\n\nGiven these points, I assign a difficulty score of 0.35, as the problem is slightly more involved than a trivial fix (e.g., changing a constant) but still falls within the \"Easy\" category due to its limited scope and straightforward solution.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor SceneTree inspects nodes while scrolling with drag & drop\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThere are 2 overlapping actions. If you drag & drop hover over a node in the SceneTree dock, it will inspect the node. Also, if you drag & drop hover near the top / bottom edge of the tree, it will scroll up and down. But currently they conflict, so dragging near the edge will still trigger the \"inspect node\" action, causing stutter during the scroll\n\nRelated to https://github.com/godotengine/godot/pull/103943#issuecomment-2734859037. I have the same fix ready, but just documenting it here\n\n### Steps to reproduce\n\n- Add a bunch of nodes to the scene tree, enough so that there is plenty to scroll.\n- Click and drag a node from the top / bottom, to the other edge to trigger a scroll, and keep cursor in place while it scrolls.\n- After about half a second, some random node in between will be inspected during the scroll.\n\nhttps://github.com/user-attachments/assets/a49f12e1-6362-42b9-a3bc-67354dc54b41\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex 163501dd37c2..41efb74db0bc 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -4764,6 +4764,7 @@ SceneTreeDock::SceneTreeDock(Node *p_scene_root, EditorSelection *p_editor_selec\n \tscene_tree->connect(\"files_dropped\", callable_mp(this, &SceneTreeDock::_files_dropped));\n \tscene_tree->connect(\"script_dropped\", callable_mp(this, &SceneTreeDock::_script_dropped));\n \tscene_tree->connect(\"nodes_dragged\", callable_mp(this, &SceneTreeDock::_nodes_drag_begin));\n+\tscene_tree->get_scene_tree()->get_vscroll_bar()->connect(\"value_changed\", callable_mp(this, &SceneTreeDock::_reset_hovering_timer).unbind(1));\n \n \tscene_tree->get_scene_tree()->connect(SceneStringName(gui_input), callable_mp(this, &SceneTreeDock::_scene_tree_gui_input));\n \tscene_tree->get_scene_tree()->connect(\"item_icon_double_clicked\", callable_mp(this, &SceneTreeDock::_focus_node));\n", "instance_id": "godotengine__godot-104346", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a conflict between the \"inspect node\" action and the scrolling behavior during drag-and-drop operations in the SceneTree dock of the Godot editor. The goal is implied (to resolve the conflict so scrolling does not trigger node inspection), and steps to reproduce the issue are provided along with a visual asset for reference. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior after the fix (e.g., should node inspection be completely disabled during scrolling, or should there be a delay or threshold?). Additionally, while it references a related pull request, it lacks specifics on the broader context or potential side effects of the fix. Constraints or edge cases (e.g., behavior with different input devices or tree sizes) are not mentioned. Overall, the statement is valid and clear enough to understand the issue, but it leaves some room for interpretation.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving a single line addition in `scene_tree_dock.cpp` to connect a signal (`value_changed` from the vertical scrollbar) to a method (`_reset_hovering_timer`). This suggests the fix is localized to a specific part of the codebase and does not impact multiple modules or the overall architecture. The change appears to be a small tweak to existing logic, likely resetting a timer that controls node inspection during scrolling.\n\n2. **Number of Technical Concepts**: Solving this requires understanding basic event handling in the Godot engine, specifically signal connections and how the SceneTree dock manages user interactions like drag-and-drop and scrolling. Familiarity with Godot's API and C++ (used in the engine's codebase) is necessary, but the concepts involved are not particularly complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond typical UI event handling are required.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code change does not appear to introduce new error handling logic. However, a developer would need to consider whether resetting the hovering timer could cause unintended side effects (e.g., delayed or missed node inspections in other scenarios). These considerations are minor and do not significantly increase the difficulty.\n\n4. **Overall Complexity**: The fix is straightforward, requiring only a small modification to address a specific bug. It does not demand deep knowledge of the entire codebase or complex refactoring. The primary challenge lies in verifying that the fix resolves the issue without introducing new problems, which is a standard debugging task.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the code change and the limited scope of understanding required. This task is suitable for a developer with basic to intermediate experience in C++ and familiarity with Godot's editor codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[BUG] sample_baked_with_rotation return wrong rotation when offset=0\n### Godot version\n\nv4.1.stable.official [970459615]\n\n### System information\n\nGodot v4.1.stable - Windows 10.0.19045 - Vulkan (Mobile) - integrated AMD Radeon(TM) Vega 8 Graphics  () - AMD Ryzen 5 3550H with Radeon Vega Mobile Gfx (8 Threads)\n\n### Issue description\n\n![image](https://github.com/godotengine/godot/assets/50233205/c180f8f9-5f7c-4ef2-9410-0ce3d1e0aad6)\r\n\r\nAs shown in the picture above, when the curve offset is 0, the rotation angle seems to be incorrect. I just get the rotation of the offset (contained in the transform) and then copy the sprite2d to this position.\r\nThe other offset are correct, And I've also looked at existing questions and there doesn't seem to be the exact same problem as mine.\r\n\r\ncode as below.\r\n![image](https://github.com/godotengine/godot/assets/50233205/f317529f-a82b-4340-8fda-58adb211fea6)\r\n\r\nThanks for any help.\r\n\n\n### Steps to reproduce\n\n1, create a Node Path2D\r\n2, invoke path2d's curve with sample_baked_with_rotation(0) # only offset=0 seemd not correct\r\n3, display path in debug and run\n\n### Minimal reproduction project\n\n[Curve2DSampleTest.zip](https://github.com/godotengine/godot/files/12779488/Curve2DSampleTest.zip)\r\n\n", "patch": "diff --git a/scene/resources/curve.cpp b/scene/resources/curve.cpp\nindex de68737b8c93..ca9b247f2719 100644\n--- a/scene/resources/curve.cpp\n+++ b/scene/resources/curve.cpp\n@@ -881,12 +881,22 @@ void Curve2D::_bake_segment2d_even_length(RBMap<real_t, Vector2> &r_bake, real_t\n \n Vector2 Curve2D::_calculate_tangent(const Vector2 &p_begin, const Vector2 &p_control_1, const Vector2 &p_control_2, const Vector2 &p_end, const real_t p_t) {\n \t// Handle corner cases.\n-\tif (Math::is_zero_approx(p_t - 0.0f) && p_control_1.is_equal_approx(p_begin)) {\n-\t\treturn (p_end - p_begin).normalized();\n-\t}\n-\n-\tif (Math::is_zero_approx(p_t - 1.0f) && p_control_2.is_equal_approx(p_end)) {\n-\t\treturn (p_end - p_begin).normalized();\n+\tif (Math::is_zero_approx(p_t - 0.0f)) {\n+\t\tif (p_control_1.is_equal_approx(p_begin)) {\n+\t\t\tif (p_control_1.is_equal_approx(p_control_2)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_control_2 - p_begin).normalized();\n+\t\t\t}\n+\t\t}\n+\t} else if (Math::is_zero_approx(p_t - 1.0f)) {\n+\t\tif (p_control_2.is_equal_approx(p_end)) {\n+\t\t\tif (p_control_2.is_equal_approx(p_control_1)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_end - p_control_1).normalized();\n+\t\t\t}\n+\t\t}\n \t}\n \n \treturn p_begin.bezier_derivative(p_control_1, p_control_2, p_end, p_t).normalized();\n@@ -1620,12 +1630,22 @@ void Curve3D::_bake_segment3d_even_length(RBMap<real_t, Vector3> &r_bake, real_t\n \n Vector3 Curve3D::_calculate_tangent(const Vector3 &p_begin, const Vector3 &p_control_1, const Vector3 &p_control_2, const Vector3 &p_end, const real_t p_t) {\n \t// Handle corner cases.\n-\tif (Math::is_zero_approx(p_t - 0.0f) && p_control_1.is_equal_approx(p_begin)) {\n-\t\treturn (p_end - p_begin).normalized();\n-\t}\n-\n-\tif (Math::is_zero_approx(p_t - 1.0f) && p_control_2.is_equal_approx(p_end)) {\n-\t\treturn (p_end - p_begin).normalized();\n+\tif (Math::is_zero_approx(p_t - 0.0f)) {\n+\t\tif (p_control_1.is_equal_approx(p_begin)) {\n+\t\t\tif (p_control_1.is_equal_approx(p_control_2)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_control_2 - p_begin).normalized();\n+\t\t\t}\n+\t\t}\n+\t} else if (Math::is_zero_approx(p_t - 1.0f)) {\n+\t\tif (p_control_2.is_equal_approx(p_end)) {\n+\t\t\tif (p_control_2.is_equal_approx(p_control_1)) {\n+\t\t\t\treturn (p_end - p_begin).normalized();\n+\t\t\t} else {\n+\t\t\t\treturn (p_end - p_control_1).normalized();\n+\t\t\t}\n+\t\t}\n \t}\n \n \treturn p_begin.bezier_derivative(p_control_1, p_control_2, p_end, p_t).normalized();\n", "instance_id": "godotengine__godot-104221", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a bug in the `sample_baked_with_rotation` method of a `Path2D` curve in Godot 4.1 where the rotation angle is incorrect specifically when the offset is 0. The user provides a visual representation of the issue, steps to reproduce, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior or correct rotation angle for offset=0 is not explicitly defined, leaving room for interpretation. Additionally, the problem statement does not mention specific edge cases beyond offset=0 or constraints that might affect the solution. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, affecting specific logic in the `Curve2D` and `Curve3D` classes within a single file (`curve.cpp`). The modifications involve updating the tangent calculation logic for corner cases (when the parameter `p_t` is approximately 0 or 1), which requires understanding Bezier curve mathematics and the existing implementation of derivative calculations. The amount of code change is moderate, with nested conditional checks added to handle different control point configurations, but it does not impact the broader system architecture. \n\nSecond, the technical concepts involved include familiarity with vector mathematics, Bezier curve tangents, and floating-point comparisons (e.g., `Math::is_zero_approx`), which are moderately complex but not overly advanced. Domain-specific knowledge of Godot's curve sampling and rendering pipeline is also necessary to ensure the fix aligns with the engine's expectations for rotation behavior.\n\nThird, the problem inherently involves edge cases (specifically when `p_t` is 0 or 1 and control points overlap with endpoints), and the code changes directly address these by refining the logic for tangent calculation. However, no additional error handling or performance considerations are evident in the problem statement or code changes, and the complexity of these edge cases is moderate.\n\nOverall, this problem requires understanding multiple concepts (Bezier curves, vector math, and Godot's internals) and making targeted but non-trivial modifications. It does not require deep architectural changes or advanced domain knowledge beyond what a mid-level engineer familiar with graphics programming might possess, hence a score of 0.45 in the medium range.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "MetalFX Temporal upscaling fallback on non-supported rendering drivers does not disable TAA jitter (or fallback to FSR2)\n### Tested versions\n\n- Reproducible in: 4.4.stable\n- MetalFX is not available before 4.4.\n\n### System information\n\nGodot v4.4.stable (4c311cbee) - Fedora Linux 41 (KDE Plasma) on X11 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4090 (nvidia; 570.86.16) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nWhen attempting to use MetalFX Temporal upscaling on an unsupported rendering driver, the TAA jitter is still active despite not being needed with bilinear scaling. MetalFX Spatial upscaling doesn't have this issue, as it doesn't engage TAA jitter in the first place due to its purely spatial nature.\n\nAlternatively (and this is the solution I prefer), we should fallback to FSR2 when MetalFX Temporal upscaling is not available (and FSR1 when MetalFX Spatial upscaling is not available). This will look better than falling back to bilinear scaling and means we won't have to disable TAA jitter, as it's still needed with FSR2.\n\ncc @stuartcarnie \n\nhttps://github.com/user-attachments/assets/bde8cd82-63ba-4f82-ba59-0be8e46ea63c\n\n### Steps to reproduce\n\n- Create a project using the Forward+ rendering method.\n- Set the root viewport's 3D scaling mode to MetalFX Temporal using a script on a platform/renderer that doesn't support MetalFX upscaling (Windows, Linux, or macOS when using MoltenVK):\n```gdscript\nfunc _ready() -> void:\n    get_window().scaling_3d_mode = Viewport.SCALING_3D_MODE_METALFX_TEMPORAL\n```\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/godotengine/tps-demo/pull/196\n*Change the check in the demo's code from `== \"metal\"` to `!= \"metal` to test this on unsupported drivers. I suggest using the Ultra Performance scaling mode so the issue is more noticeable.*\n", "patch": "diff --git a/servers/rendering/renderer_viewport.cpp b/servers/rendering/renderer_viewport.cpp\nindex 3a8f445c4be1..45a4ebe1b8a8 100644\n--- a/servers/rendering/renderer_viewport.cpp\n+++ b/servers/rendering/renderer_viewport.cpp\n@@ -145,12 +145,22 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_OFF;\n \t\t\t}\n \n-\t\t\t// Verify MetalFX upscaling support.\n-\t\t\tif (\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) ||\n-\t\t\t\t\t(scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL))) {\n-\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported in the current renderer. Falling back to bilinear 3D resolution scaling.\");\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_TEMPORAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_TEMPORAL)) {\n+\t\t\t\tif (RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\t\t// Prefer MetalFX spatial if it is supported, which will be much more efficient than FSR2,\n+\t\t\t\t\t// as the hardware already will struggle with FSR2.\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling is not supported by the current renderer or hardware. Falling back to MetalFX Spatial scaling.\");\n+\t\t\t\t} else {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX upscaling is not supported by the current renderer or hardware. Falling back to FSR 2 scaling.\");\n+\t\t\t\t}\n+\t\t\t\tscaling_type = RS::scaling_3d_mode_type(scaling_3d_mode);\n+\t\t\t}\n+\n+\t\t\tif (scaling_3d_mode == RS::VIEWPORT_SCALING_3D_MODE_METALFX_SPATIAL && !RD::get_singleton()->has_feature(RD::SUPPORTS_METALFX_SPATIAL)) {\n+\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR;\n+\t\t\t\tWARN_PRINT_ONCE(\"MetalFX spatial upscaling is not supported by the current renderer or hardware. Falling back to FSR scaling.\");\n \t\t\t}\n \n \t\t\tRS::ViewportMSAA msaa_3d = p_viewport->msaa_3d;\n@@ -160,11 +170,9 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t\tdouble min_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MIN_SCALE) / 1000'000.0;\n \t\t\t\tdouble max_scale = (double)RD::get_singleton()->limit_get(RD::LIMIT_METALFX_TEMPORAL_SCALER_MAX_SCALE) / 1000'000.0;\n \t\t\t\tif ((double)scaling_3d_scale < min_scale || (double)scaling_3d_scale > max_scale) {\n-\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n-\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to bilinear 3D resolution scaling.\", min_scale, max_scale));\n-\t\t\t\t}\n-\n-\t\t\t\tif (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n+\t\t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_FSR2;\n+\t\t\t\t\tWARN_PRINT_ONCE(vformat(\"MetalFX temporal upscaling scale is outside limits; scale must be between %f and %f. Falling back to FSR 2 3D resolution scaling.\", min_scale, max_scale));\n+\t\t\t\t} else if (msaa_3d != RS::VIEWPORT_MSAA_DISABLED) {\n \t\t\t\t\tWARN_PRINT_ONCE(\"MetalFX temporal upscaling does not support 3D MSAA. Disabling 3D MSAA internally.\");\n \t\t\t\t\tmsaa_3d = RS::VIEWPORT_MSAA_DISABLED;\n \t\t\t\t}\n@@ -174,7 +182,7 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\tbool use_taa = p_viewport->use_taa;\n \n \t\t\tif (scaling_3d_is_not_bilinear && (scaling_3d_scale >= (1.0 + EPSILON))) {\n-\t\t\t\t// FSR is not designed for downsampling.\n+\t\t\t\t// FSR and MetalFX is not designed for downsampling.\n \t\t\t\t// Fall back to bilinear scaling.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 3D resolution scaling is not designed for downsampling. Falling back to bilinear 3D resolution scaling.\");\n \t\t\t\tscaling_3d_mode = RS::VIEWPORT_SCALING_3D_MODE_BILINEAR;\n@@ -188,8 +196,8 @@ void RendererViewport::_configure_3d_render_buffers(Viewport *p_viewport) {\n \t\t\t}\n \n \t\t\tif (use_taa && (scaling_type == RS::VIEWPORT_SCALING_3D_TYPE_TEMPORAL)) {\n-\t\t\t\t// FSR2 can't be used with TAA.\n-\t\t\t\t// Turn it off and prefer using FSR2.\n+\t\t\t\t// Temporal upscalers can't be used with TAA.\n+\t\t\t\t// Turn it off and prefer using the temporal upscaler.\n \t\t\t\tWARN_PRINT_ONCE(\"FSR 2 or MetalFX Temporal is not compatible with TAA. Disabling TAA internally.\");\n \t\t\t\tuse_taa = false;\n \t\t\t}\n", "instance_id": "godotengine__godot-103792", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with MetalFX Temporal upscaling fallback behavior on unsupported rendering drivers. It specifies the problem (TAA jitter remains active unnecessarily with bilinear scaling fallback) and provides a preferred solution (falling back to FSR2/FSR1 instead of bilinear scaling). The steps to reproduce are well-documented, including a minimal reproduction project and specific system information. However, there are minor ambiguities: the problem statement does not explicitly define all edge cases (e.g., behavior on specific hardware configurations beyond the tested setup) or constraints for fallback mechanisms. Additionally, while the preferred solution is mentioned, it lacks detailed requirements or trade-offs for implementing FSR2/FSR1 fallbacks versus disabling TAA jitter. Overall, the description is valid and clear but misses some minor details that could aid in a fully comprehensive understanding.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as medium (0.55) based on the following analysis of the factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the minor ambiguities around edge cases and fallback constraints add a slight layer of complexity to fully understanding the requirements. The logic of handling rendering fallbacks is moderately complex due to the need to balance visual quality and performance.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are confined to a single file (`renderer_viewport.cpp`) and focus on modifying the logic for 3D scaling mode fallbacks. The changes involve updating conditional checks and fallback paths (e.g., preferring MetalFX Spatial or FSR2 over bilinear scaling). The amount of code change is relatively small (around 30-40 lines), and it does not appear to impact the broader system architecture significantly. However, it requires understanding the interaction between different rendering modes and hardware support checks within the Godot engine's rendering pipeline.\n\n3. **Number of Technical Concepts**: Solving this problem requires familiarity with several concepts, including rendering techniques (MetalFX Temporal/Spatial, FSR2/FSR1, TAA jitter, bilinear scaling), hardware feature detection (via `RD::get_singleton()->has_feature`), and the Godot engine's viewport and rendering system. While these concepts are not extremely advanced, they do require domain-specific knowledge of graphics programming and the Godot engine's internals, which adds to the difficulty for someone unfamiliar with this area.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention many edge cases, but the code changes imply handling scenarios like unsupported hardware, invalid scaling ranges, and compatibility issues between rendering techniques (e.g., disabling TAA when using temporal upscalers). The modifications include updating warning messages and fallback logic, which indirectly addresses error handling. These edge cases are moderately complex as they involve ensuring visual quality and performance are not degraded unexpectedly on different hardware configurations.\n\nOverall, this problem falls into the medium difficulty range because it requires understanding multiple graphics-related concepts and making targeted but non-trivial changes to the rendering logic. It does not involve extensive refactoring or deep architectural changes, nor does it require extremely advanced technical knowledge, but it is beyond a simple bug fix due to the need for domain expertise and careful handling of fallback behaviors.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "LineEdit - Caret hides when focus is lost, even though Caret Force Displayed option is checked (Regression)\n### Tested versions\n\nReproducible in v4.4.rc3.official\n\n**Update:**\nI've tested this on versions from 4.3stable on and the version where this stops working is in 4.4 dev3.  In 4.4 dev2 backwards, it works as intended.\n\n### System information\n\nGodot v4.4.rc3 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.7242) - Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz (12 threads)\n\n### Issue description\n\nI'm using line input to edit text, and I'm moving away from the line with my controller to interact with other UI elements.  \nI expect the blinking caret in the line Input to remain, since I have the caret_force_displayed property checked.\n\nBut it doesn't seem like this makes a different, and the caret goes away.\n\n### Steps to reproduce\n\nOpen attached project and play it.\n\n1) Type some text in the LineEdit node.\n2) Click away or move away from the text with an attached controller.\n3) Notce the caret goes away even though the caret_force_displayed property is checked.\n\n### Minimal reproduction project (MRP)\n\n[line_edit_caret_issue.zip](https://github.com/user-attachments/files/19038896/line_edit_caret_issue.zip)\n", "patch": "diff --git a/doc/classes/LineEdit.xml b/doc/classes/LineEdit.xml\nindex c6cdacb6ec25..879b179dbfef 100644\n--- a/doc/classes/LineEdit.xml\n+++ b/doc/classes/LineEdit.xml\n@@ -252,7 +252,7 @@\n \t\t\tThe caret's column position inside the [LineEdit]. When set, the text may scroll to accommodate it.\n \t\t</member>\n \t\t<member name=\"caret_force_displayed\" type=\"bool\" setter=\"set_caret_force_displayed\" getter=\"is_caret_force_displayed\" default=\"false\">\n-\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if focus is lost.\n+\t\t\tIf [code]true[/code], the [LineEdit] will always show the caret, even if not editing or focus is lost.\n \t\t</member>\n \t\t<member name=\"caret_mid_grapheme\" type=\"bool\" setter=\"set_caret_mid_grapheme_enabled\" getter=\"is_caret_mid_grapheme_enabled\" default=\"false\">\n \t\t\tAllow moving caret, selecting and removing the individual composite character components.\ndiff --git a/scene/gui/line_edit.cpp b/scene/gui/line_edit.cpp\nindex 969e2fd3a35c..f4d66d5a281d 100644\n--- a/scene/gui/line_edit.cpp\n+++ b/scene/gui/line_edit.cpp\n@@ -1733,7 +1733,7 @@ void LineEdit::_validate_caret_can_draw() {\n \t\tdraw_caret = true;\n \t\tcaret_blink_timer = 0.0;\n \t}\n-\tcaret_can_draw = editing && (window_has_focus || (menu && menu->has_focus())) && (has_focus() || caret_force_displayed);\n+\tcaret_can_draw = (caret_force_displayed && !is_part_of_edited_scene()) || (editing && (window_has_focus || (menu && menu->has_focus())) && has_focus());\n }\n \n void LineEdit::delete_char() {\n", "instance_id": "godotengine__godot-103508", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the expected behavior (caret should remain visible when focus is lost if `caret_force_displayed` is enabled) and the actual behavior (caret disappears). It includes steps to reproduce, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities: the problem statement does not explicitly discuss potential edge cases or constraints (e.g., behavior in specific UI configurations or interactions with other properties). Additionally, it lacks clarity on whether this issue affects other platforms or rendering backends beyond the specified Windows setup with Vulkan. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are minimal and localized to a single file (`line_edit.cpp`) with a small modification to the logic for determining when the caret can be drawn. Additionally, there is a minor documentation update in `LineEdit.xml`. The change does not impact the broader system architecture or require modifications across multiple modules. The diff shows a straightforward adjustment to a conditional statement, indicating a low amount of code change.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of GUI logic in the Godot engine, specifically how focus and caret visibility are managed in the `LineEdit` class. The change involves modifying a boolean condition to account for the `caret_force_displayed` property and a new check (`is_part_of_edited_scene()`), which suggests minimal complexity. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI handling are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change introduces a new condition (`is_part_of_edited_scene()`), which might be intended to handle specific scenarios (e.g., preventing caret display in certain editor contexts). However, the complexity of handling such edge cases appears low, as the change is a simple logical adjustment without extensive error handling or validation logic.\n\n4. **Overall Complexity**: The issue is a regression bug fix, and the solution involves a small tweak to existing logic rather than implementing new functionality or refactoring. It requires understanding the intent of `caret_force_displayed` and how focus management works in Godot, but this is relatively straightforward for someone familiar with GUI components or the Godot codebase.\n\nA score of 0.30 reflects that this is an easy problem requiring minimal code changes and a basic understanding of the relevant logic, with no significant architectural impact or complex edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Headless import always emits errors about `!tasks.has(p_task)`\n### Tested versions\n\n- Reproducible in: 4.4.rc2\n- Reproducible in: 4.4.dev2\n- Not reproducible in: 4.4.dev1\n\n### System information\n\nGodot v4.4.rc2 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\n(This is a formal issue for what's mentioned [here](https://github.com/godotengine/godot/issues/100900#issuecomment-2567712127), and potentially a duplicate of #100900 itself, but since that one mentions errors at startup I figured it's possibly a different issue.)\n\nWhen running Godot with `--headless --import` on any project, you're currently met with the following output:\n\n```\nERROR: Do not use progress dialog (task) while flushing the message queue or using call_deferred()!\n   at: add_task (editor/progress_dialog.cpp:183)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true. Returning: canceled\n   at: task_step (editor/progress_dialog.cpp:217)\nERROR: Condition \"!tasks.has(p_task)\" is true.\n   at: end_task (editor/progress_dialog.cpp:240)\n```\n\nThe import seems to complete successfully despite that, I think.\n\nWhen bisecting it seems that this is a regression stemming from #93064.\n\n### Steps to reproduce\n\n- Create a new project.\n- Run `/path/to/godot --headless --import` in the project folder.\n- Note the errors.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex f1d13123d659..de52afa91cda 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -1207,7 +1207,7 @@ void EditorNode::_sources_changed(bool p_exist) {\n \t\t}\n \n \t\t// Start preview thread now that it's safe.\n-\t\tif (!singleton->cmdline_export_mode) {\n+\t\tif (!singleton->cmdline_mode) {\n \t\t\tEditorResourcePreview::get_singleton()->start();\n \t\t}\n \n@@ -1807,7 +1807,7 @@ void EditorNode::_save_scene_with_preview(String p_file, int p_idx) {\n \tsave_scene_progress->step(TTR(\"Saving Scene\"), 4);\n \t_save_scene(p_file, p_idx);\n \n-\tif (!singleton->cmdline_export_mode) {\n+\tif (!singleton->cmdline_mode) {\n \t\tEditorResourcePreview::get_singleton()->check_for_invalidation(p_file);\n \t}\n \n@@ -4944,7 +4944,7 @@ bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringNa\n void EditorNode::progress_add_task(const String &p_task, const String &p_label, int p_steps, bool p_can_cancel) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": begin: \" + p_label + \" steps: \" + itos(p_steps));\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->add_task(p_task, p_label, p_steps, p_can_cancel);\n@@ -4954,7 +4954,7 @@ void EditorNode::progress_add_task(const String &p_task, const String &p_label,\n bool EditorNode::progress_task_step(const String &p_task, const String &p_state, int p_step, bool p_force_refresh) {\n \tif (!singleton) {\n \t\treturn false;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(\"\\t\" + p_task + \": step \" + itos(p_step) + \": \" + p_state);\n \t\treturn false;\n \t} else if (singleton->progress_dialog) {\n@@ -4967,7 +4967,7 @@ bool EditorNode::progress_task_step(const String &p_task, const String &p_state,\n void EditorNode::progress_end_task(const String &p_task) {\n \tif (!singleton) {\n \t\treturn;\n-\t} else if (singleton->cmdline_export_mode) {\n+\t} else if (singleton->cmdline_mode) {\n \t\tprint_line(p_task + \": end\");\n \t} else if (singleton->progress_dialog) {\n \t\tsingleton->progress_dialog->end_task(p_task);\n@@ -5220,7 +5220,7 @@ Error EditorNode::export_preset(const String &p_preset, const String &p_path, bo\n \texport_defer.android_build_template = p_android_build_template;\n \texport_defer.patch = p_patch;\n \texport_defer.patches = p_patches;\n-\tcmdline_export_mode = true;\n+\tcmdline_mode = true;\n \treturn OK;\n }\n \n@@ -6848,6 +6848,11 @@ EditorNode::EditorNode() {\n \tDEV_ASSERT(!singleton);\n \tsingleton = this;\n \n+\t// Detecting headless mode, that means the editor is running in command line.\n+\tif (!DisplayServer::get_singleton()->window_can_draw()) {\n+\t\tcmdline_mode = true;\n+\t}\n+\n \tResource::_get_local_scene_func = _resource_get_edited_scene;\n \n \t{\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex de3af997473a..63788e645f30 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -419,7 +419,7 @@ class EditorNode : public Node {\n \tbool script_distraction_free = false;\n \n \tbool changing_scene = false;\n-\tbool cmdline_export_mode = false;\n+\tbool cmdline_mode = false;\n \tbool convert_old = false;\n \tbool immediate_dialog_confirmed = false;\n \tbool opening_prev = false;\n", "instance_id": "godotengine__godot-103403", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: running Godot in headless mode with the `--headless --import` command results in repeated error messages related to a progress dialog task check (`!tasks.has(p_task)`). The goal is implicitly to eliminate these errors during headless operation. The statement includes relevant details such as the affected versions, system information, steps to reproduce, and a reference to a related issue or regression. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., should the progress dialog be entirely disabled in headless mode, or should the errors be suppressed?), and it lacks details on potential edge cases or constraints (e.g., does this affect other command-line modes?). Additionally, while the issue is reproducible, there is no minimal reproduction project provided, which could hinder deeper investigation. Overall, the description is valid and mostly clear but misses some finer points that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, primarily within `editor_node.cpp` and `editor_node.h`. The modifications involve replacing a specific flag (`cmdline_export_mode`) with a broader one (`cmdline_mode`) and adding logic to detect headless mode using `DisplayServer::get_singleton()->window_can_draw()`. The changes affect a single class (`EditorNode`) and focus on conditional checks for command-line or headless operation. The amount of code change is small (a few lines across multiple functions), and there is no significant impact on the system's architecture, as it’s mostly a behavioral adjustment for headless mode.\n\n2. **Number of Technical Concepts**: Solving this requires understanding basic C++ concepts (class member variables, conditional logic) and familiarity with the Godot engine's internals, specifically how the editor handles command-line modes and progress dialogs. The concept of headless mode detection using `DisplayServer` is straightforward but requires some domain-specific knowledge of Godot's API. No advanced algorithms, design patterns, or complex libraries are involved, keeping the technical depth low.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest a focus on ensuring proper behavior in headless mode. There might be implicit edge cases, such as ensuring that other command-line operations (beyond `--import`) are correctly handled with the new `cmdline_mode` flag, or verifying that the headless detection logic works across different platforms. However, the error handling in the code changes is minimal, focusing on bypassing progress dialog operations in command-line mode rather than adding new error checks. The complexity of edge cases appears low.\n\n4. **Overall Assessment**: The problem requires understanding a specific part of the Godot editor codebase and making targeted modifications to handle headless mode correctly. It does not involve deep architectural changes or complex logic, and the impact is limited to command-line behavior. The difficulty is slightly above the \"Very Easy\" range due to the need for domain-specific knowledge of Godot and potential minor edge cases, but it remains straightforward for someone familiar with the codebase or C++ in general.\n\nThus, a score of 0.35 reflects an \"Easy\" problem that involves simple modifications with moderate context understanding.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`change_scene_to_*` needs to await for two `process_frame`s\n### Tested versions\r\n\r\nGodot 4.2+\r\n\r\n### System information\r\n\r\nArch Linux\r\n\r\n### Issue description\r\n\r\n`change_scene_to_*()` methods always change scene in a deferred way.\r\n\r\nThe documentation says scene change happens at the end of the frame. But I have to await `SceneTree.process_frame` twice instead of once since #78988.\r\n\r\nhttps://github.com/godotengine/godot/blob/2d0ee20ff30461b6b10f6fdfba87511a0ebc6642/doc/classes/SceneTree.xml#L55-L56\r\n\r\n```gdscript\r\nvar tree := get_tree()\r\n\r\ntree.change_scene_to_file(path)\r\n\r\nawait tree.process_frame\r\n# expected & old behavior: new scene available here\r\n# actual: still not available\r\n\r\nawait tree.process_frame\r\n# actual: new scene available here\r\n```\r\n\r\n### Steps to reproduce\r\n\r\nSee above, or use the MRP.\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[test-change-scene.zip](https://github.com/godotengine/godot/files/13700325/test-change-scene.zip)\r\n\n", "patch": "diff --git a/doc/classes/SceneTree.xml b/doc/classes/SceneTree.xml\nindex 77baef9d0898..9a31492d2018 100644\n--- a/doc/classes/SceneTree.xml\n+++ b/doc/classes/SceneTree.xml\n@@ -58,6 +58,7 @@\n \t\t\t\t1. The current scene node is immediately removed from the tree. From that point, [method Node.get_tree] called on the current (outgoing) scene will return [code]null[/code]. [member current_scene] will be [code]null[/code], too, because the new scene is not available yet.\n \t\t\t\t2. At the end of the frame, the formerly current scene, already removed from the tree, will be deleted (freed from memory) and then the new scene will be instantiated and added to the tree. [method Node.get_tree] and [member current_scene] will be back to working as usual.\n \t\t\t\tThis ensures that both scenes aren't running at the same time, while still freeing the previous scene in a safe way similar to [method Node.queue_free].\n+\t\t\t\tIf you want to reliably access the new scene, await the [signal scene_changed] signal.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"create_timer\">\n@@ -312,6 +313,17 @@\n \t\t\t\tEmitted immediately before [method Node._process] is called on every node in this tree.\n \t\t\t</description>\n \t\t</signal>\n+\t\t<signal name=\"scene_changed\">\n+\t\t\t<description>\n+\t\t\t\tEmitted after the new scene is added to scene tree and initialized. Can be used to reliably access [member current_scene] when changing scenes.\n+\t\t\t\t[codeblock]\n+\t\t\t\t# This code should be inside an autoload.\n+\t\t\t\tget_tree().change_scene_to_file(other_scene_path)\n+\t\t\t\tawait get_tree().scene_changed\n+\t\t\t\tprint(get_tree().current_scene) # Prints the new scene.\n+\t\t\t\t[/codeblock]\n+\t\t\t</description>\n+\t\t</signal>\n \t\t<signal name=\"tree_changed\">\n \t\t\t<description>\n \t\t\t\tEmitted any time the tree's hierarchy changes (nodes being moved, renamed, etc.).\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 4043eb55ac96..557fced85ed1 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -1517,6 +1517,8 @@ void SceneTree::_flush_scene_change() {\n \tpending_new_scene = nullptr;\n \t// Update display for cursor instantly.\n \troot->update_mouse_cursor_state();\n+\n+\temit_signal(SNAME(\"scene_changed\"));\n }\n \n Error SceneTree::change_scene_to_file(const String &p_path) {\n@@ -1784,6 +1786,7 @@ void SceneTree::_bind_methods() {\n \tADD_PROPERTY(PropertyInfo(Variant::BOOL, \"physics_interpolation\"), \"set_physics_interpolation_enabled\", \"is_physics_interpolation_enabled\");\n \n \tADD_SIGNAL(MethodInfo(\"tree_changed\"));\n+\tADD_SIGNAL(MethodInfo(\"scene_changed\"));\n \tADD_SIGNAL(MethodInfo(\"tree_process_mode_changed\")); //editor only signal, but due to API hash it can't be removed in run-time\n \tADD_SIGNAL(MethodInfo(\"node_added\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n \tADD_SIGNAL(MethodInfo(\"node_removed\", PropertyInfo(Variant::OBJECT, \"node\", PROPERTY_HINT_RESOURCE_TYPE, \"Node\")));\n", "instance_id": "godotengine__godot-102986", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `change_scene_to_*` methods in Godot 4.2+, where the scene change does not occur as expected after a single `process_frame` await, requiring two awaits instead. It provides a code snippet to illustrate the issue and references the documentation for context. Additionally, a minimal reproduction project (MRP) is provided, which aids in understanding the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior beyond referencing \"old behavior\" and lacks detailed discussion of potential edge cases or constraints (e.g., specific conditions under which this issue occurs or interactions with other systems). While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, affecting two files (`SceneTree.xml` for documentation and `scene_tree.cpp` for implementation). The modifications involve adding a new signal (`scene_changed`) to notify when the scene change is complete and updating the documentation to reflect this. The changes are straightforward, involving minimal lines of code (adding a signal emission and binding it), and do not impact the broader system architecture significantly.\n\n2. **Technical Concepts Required**: Solving this requires a basic understanding of Godot's scene management system, specifically how scene changes are deferred and processed at the end of frames. It also involves familiarity with Godot's signal system to emit and bind a new signal. These concepts are not overly complex for someone with moderate experience in game engine development or C++ (used in Godot's core). No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's API are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or modify error handling logic. The addition of the `scene_changed` signal is a simple notification mechanism without apparent complexity in handling edge cases. However, a developer might need to consider scenarios like rapid scene changes or signal handling in concurrent contexts, though these are not addressed in the provided changes or problem statement.\n\n4. **Overall Complexity**: The task involves understanding a specific behavior in Godot's scene tree processing and making a small, targeted fix by introducing a signal. It requires some code logic comprehension but does not demand deep architectural changes or extensive debugging of complex interactions. The impact is limited to users of the `change_scene_to_*` methods who need reliable scene change notifications.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires moderate understanding of the codebase and simple modifications, with minimal impact on the overall system.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4 beta 1] TLS Handshake Error with Godot HTTPRequest\n### Tested versions\n\n4.4 beta 1 \n\n\n### System information\n\nWindows 11 - Godot 4.4 beta 1 - Vulkan (Mobile)\n\n### Issue description\n\nI’m encountering a TLS handshake error when trying to make a request to https://graph.oculus.com/ using Godot's HTTPRequest.\n\n* Requests to https://www.google.com/ work without any issues.\n* Python's requests library can access the URL without any problems.\n* The same https://graph.oculus.com/ URL works correctly in Postman.\n* I attempted to create a certificate bundle as well, but it was unsuccessful.\n* This issue appears to be specific to Godot.\n\nCPP ERROR:\n\nE 0:00:01:0639   StreamPeerMbedTLS::_do_handshake: TLS handshake error: -28800\n  <C++ Source>   modules\\mbedtls\\stream_peer_mbedtls.cpp:88 @ StreamPeerMbedTLS::_do_handshake()\n\n### Steps to reproduce\n\n* Create simple project\n* Add a HTTPRequest node\n* Add script:\n```\nextends Node3D\n\n@onready var http: HTTPRequest = $HTTPRequest\n\nfunc _ready() -> void:\n\thttp.request(\"https://graph.oculus.com/\")\n\tprint(await http.request_completed)\n```\n* Run\n\n\n### Minimal reproduction project (MRP)\n\n[teste-vr.zip](https://github.com/user-attachments/files/18505403/teste-vr.zip)\n", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex b27665548f4b..79bf8975411b 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2204,6 +2204,10 @@\n \t\t\tThe CA certificates bundle to use for TLS connections. If this is set to a non-empty value, this will [i]override[/i] Godot's default [url=https://github.com/godotengine/godot/blob/master/thirdparty/certs/ca-certificates.crt]Mozilla certificate bundle[/url]. If left empty, the default certificate bundle will be used.\n \t\t\tIf in doubt, leave this setting empty.\n \t\t</member>\n+\t\t<member name=\"network/tls/enable_tls_v1.3\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n+\t\t\tIf [code]true[/code], enable TLSv1.3 negotiation.\n+\t\t\t[b]Note:[/b] This is experimental, and may cause connections to fail in some cases (notably, if the remote server uses TLS handshake fragmentation).\n+\t\t</member>\n \t\t<member name=\"physics/2d/default_angular_damp\" type=\"float\" setter=\"\" getter=\"\" default=\"1.0\">\n \t\t\tThe default rotational motion damping in 2D. Damping is used to gradually slow down physical objects over time. RigidBodies will fall back to this value when combining their own damping values and no area damping value is present.\n \t\t\tSuggested values are in the range [code]0[/code] to [code]30[/code]. At value [code]0[/code] objects will keep moving with the same velocity. Greater values will stop the object faster. A value equal to or greater than the physics tick rate ([member physics/common/physics_ticks_per_second]) will bring the object to a stop in one iteration.\ndiff --git a/modules/mbedtls/register_types.cpp b/modules/mbedtls/register_types.cpp\nindex bf65dfb0b76a..c0eca6ee18e0 100644\n--- a/modules/mbedtls/register_types.cpp\n+++ b/modules/mbedtls/register_types.cpp\n@@ -35,6 +35,8 @@\n #include \"packet_peer_mbed_dtls.h\"\n #include \"stream_peer_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n #include <psa/crypto.h>\n #endif\n@@ -50,6 +52,8 @@ void initialize_mbedtls_module(ModuleInitializationLevel p_level) {\n \t\treturn;\n \t}\n \n+\tGLOBAL_DEF(\"network/tls/enable_tls_v1.3\", false);\n+\n #if MBEDTLS_VERSION_MAJOR >= 3\n \tint status = psa_crypto_init();\n \tERR_FAIL_COND_MSG(status != PSA_SUCCESS, \"Failed to initialize psa crypto. The mbedTLS modules will not work.\");\ndiff --git a/modules/mbedtls/tls_context_mbedtls.cpp b/modules/mbedtls/tls_context_mbedtls.cpp\nindex f5c196596eb2..33c4cfd5450e 100644\n--- a/modules/mbedtls/tls_context_mbedtls.cpp\n+++ b/modules/mbedtls/tls_context_mbedtls.cpp\n@@ -30,6 +30,8 @@\n \n #include \"tls_context_mbedtls.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n static void my_debug(void *ctx, int level,\n \t\tconst char *file, int line,\n \t\tconst char *str) {\n@@ -144,6 +146,11 @@ Error TLSContextMbedTLS::init_server(int p_transport, Ref<TLSOptions> p_options,\n \t\tcookies = p_cookies;\n \t\tmbedtls_ssl_conf_dtls_cookies(&conf, mbedtls_ssl_cookie_write, mbedtls_ssl_cookie_check, &(cookies->cookie_ctx));\n \t}\n+\n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \tmbedtls_ssl_setup(&tls, &conf);\n \treturn OK;\n }\n@@ -187,6 +194,10 @@ Error TLSContextMbedTLS::init_client(int p_transport, const String &p_hostname,\n \t\t}\n \t}\n \n+\tif (Engine::get_singleton()->is_editor_hint() || !(bool)GLOBAL_GET(\"network/tls/enable_tls_v1.3\")) {\n+\t\tmbedtls_ssl_conf_max_tls_version(&conf, MBEDTLS_SSL_VERSION_TLS1_2);\n+\t}\n+\n \t// Set valid CAs\n \tmbedtls_ssl_conf_ca_chain(&conf, &(cas->cert), nullptr);\n \tmbedtls_ssl_setup(&tls, &conf);\n", "instance_id": "godotengine__godot-102774", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a TLS handshake error occurs when making HTTP requests to a specific URL (https://graph.oculus.com/) using Godot's HTTPRequest in version 4.4 beta 1. It provides relevant context, such as the fact that the issue does not occur with other URLs or tools (e.g., Python's requests library, Postman), and includes steps to reproduce the issue along with a minimal reproduction project. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or desired outcome (e.g., whether the goal is to support TLSv1.3 or simply bypass the handshake error). Additionally, it lacks specifics about potential causes of the TLS handshake error (e.g., cipher suite mismatches or server-specific configurations) and does not mention edge cases or constraints related to the environment or TLS versions. While the issue is valid and reproducible, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes involves multiple files (ProjectSettings.xml, register_types.cpp, and tls_context_mbedtls.cpp) within the Godot engine's codebase, specifically in the mbedTLS module, which is a critical component for handling secure connections. The changes introduce a new configuration option to toggle TLSv1.3 support, requiring an understanding of how TLS versions are negotiated and configured in mbedTLS. This involves moderately complex interactions between project settings and the TLS context initialization logic. Second, the technical concepts required include knowledge of TLS protocols (specifically TLSv1.3 limitations and handshake fragmentation issues), familiarity with the mbedTLS library's API (e.g., mbedtls_ssl_conf_max_tls_version), and understanding of Godot's project settings system. Third, while the problem statement does not explicitly mention edge cases, the code changes and accompanying note about potential connection failures due to handshake fragmentation suggest that edge cases related to server compatibility and TLS configurations need to be considered. Finally, the impact of the change is significant as it affects the core networking functionality of the engine, though it is mitigated by making TLSv1.3 optional and disabled by default. Overall, solving this requires a deep understanding of TLS internals and the Godot codebase, along with careful consideration of compatibility issues, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In tileset editor, attempting to paint terrain over alternative tile instead creates a new alternative tile\n### Tested versions\n\n- Reproducible for v4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - GLES3 (Compatibility) - AMD Radeon RX 6600M (Advanced Micro Devices, Inc.; 30.0.13024.5001) - AMD Ryzen 7 5800H with Radeon Graphics (16 Threads)\n\n### Issue description\n\nAttempting to paint terrain over an alternative tile instead results with the terrain editor creating a new alternative tile. Which shouldn't happen, as the alternative tile creation is done via \"Select\" tab of the tileset editor.\n\n### Steps to reproduce\n\n1. Load attached project\n2. Open `player.tscn`\n3. Open `TileMapLayer` node\n4. Switch to tileset editing, `Paint` mode\n5. Select property `Terrains` -> `Terrain Set 0` -> `Dots Biome`\n6. Attempt to paint this point:\n![Image](https://github.com/user-attachments/assets/814c2333-8a5a-4d8e-a20a-06daee32f4ef)\n7. Be greeted with this sight:\n![Image](https://github.com/user-attachments/assets/c6be7659-d9d3-43e8-8fd7-25ec609d998b)\n\n\n\n\n### Minimal reproduction project (MRP)\n\n[TerrainPainterBug.zip](https://github.com/user-attachments/files/17937477/TerrainPainterBug.zip)\n", "patch": "diff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\nindex ffb5bb5009db..80958b2043fb 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.cpp\n@@ -971,40 +971,44 @@ void TileSetAtlasSourceEditor::_update_atlas_view() {\n \t\ttile_create_help->set_visible(tools_button_group->get_pressed_button() == tool_setup_atlas_source_button);\n \t}\n \n-\tVector2i pos;\n-\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n-\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n-\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n-\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n-\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n-\t\tif (alternative_count > 1) {\n-\t\t\t// Compute the right extremity of alternative.\n-\t\t\tint y_increment = 0;\n-\t\t\tpos.x = 0;\n-\t\t\tfor (int j = 1; j < alternative_count; j++) {\n-\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n-\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n-\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n-\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n-\t\t\t}\n-\n-\t\t\t// Create and position the button.\n-\t\t\tButton *button = memnew(Button);\n-\t\t\tbutton->set_flat(true);\n-\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n-\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n-\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n-\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(tile_set_atlas_source, &TileSetAtlasSource::create_alternative_tile).bind(tile_id, TileSetSource::INVALID_TILE_ALTERNATIVE));\n-\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n-\t\t\tbutton->set_expand_icon(true);\n-\t\t\talternative_tiles_control->add_child(button);\n-\n-\t\t\tpos.y += y_increment;\n-\t\t}\n-\t}\n-\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\tif (tools_button_group->get_pressed_button() != tool_paint_button) {\n+\t\tVector2i pos;\n+\t\tVector2 texture_region_base_size = tile_set_atlas_source->get_texture_region_size();\n+\t\tint texture_region_base_size_min = MIN(texture_region_base_size.x, texture_region_base_size.y);\n+\t\tfor (int i = 0; i < tile_set_atlas_source->get_tiles_count(); i++) {\n+\t\t\tVector2i tile_id = tile_set_atlas_source->get_tile_id(i);\n+\t\t\tint alternative_count = tile_set_atlas_source->get_alternative_tiles_count(tile_id);\n+\t\t\tif (alternative_count > 1) {\n+\t\t\t\t// Compute the right extremity of alternative.\n+\t\t\t\tint y_increment = 0;\n+\t\t\t\tpos.x = 0;\n+\t\t\t\tfor (int j = 1; j < alternative_count; j++) {\n+\t\t\t\t\tint alternative_id = tile_set_atlas_source->get_alternative_tile_id(tile_id, j);\n+\t\t\t\t\tRect2i rect = tile_atlas_view->get_alternative_tile_rect(tile_id, alternative_id);\n+\t\t\t\t\tpos.x = MAX(pos.x, rect.get_end().x);\n+\t\t\t\t\ty_increment = MAX(y_increment, rect.size.y);\n+\t\t\t\t}\n+\n+\t\t\t\t// Create and position the button.\n+\t\t\t\tButton *button = memnew(Button);\n+\t\t\t\tbutton->set_flat(true);\n+\t\t\t\tbutton->set_button_icon(get_editor_theme_icon(SNAME(\"Add\")));\n+\t\t\t\tbutton->add_theme_style_override(CoreStringName(normal), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(hover), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(\"focus\", memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_style_override(SceneStringName(pressed), memnew(StyleBoxEmpty));\n+\t\t\t\tbutton->add_theme_constant_override(\"align_to_largest_stylebox\", false);\n+\t\t\t\tbutton->set_mouse_filter(Control::MOUSE_FILTER_PASS);\n+\t\t\t\tbutton->connect(SceneStringName(pressed), callable_mp(this, &TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed).bind(tile_id));\n+\t\t\t\tbutton->set_rect(Rect2(Vector2(pos.x, pos.y + (y_increment - texture_region_base_size.y) / 2.0), Vector2(texture_region_base_size_min, texture_region_base_size_min)));\n+\t\t\t\tbutton->set_expand_icon(true);\n+\t\t\t\talternative_tiles_control->add_child(button);\n+\n+\t\t\t\tpos.y += y_increment;\n+\t\t\t}\n+\t\t}\n+\t\ttile_atlas_view->set_padding(Side::SIDE_RIGHT, texture_region_base_size_min);\n+\t}\n \n \t// Redraw everything.\n \ttile_atlas_control->queue_redraw();\n@@ -2009,6 +2013,17 @@ void TileSetAtlasSourceEditor::_tile_alternatives_control_mouse_exited() {\n \talternative_tiles_control_unscaled->queue_redraw();\n }\n \n+void TileSetAtlasSourceEditor::_tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords) {\n+\tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n+\n+\t// FIXME: Doesn't undo changes to `next_alternative_id` counter.\n+\tundo_redo->create_action(TTR(\"Create tile alternatives\"));\n+\tint next_id = tile_set_atlas_source->get_next_alternative_tile_id(p_atlas_coords);\n+\tundo_redo->add_do_method(tile_set_atlas_source, \"create_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->add_undo_method(tile_set_atlas_source, \"remove_alternative_tile\", p_atlas_coords, next_id);\n+\tundo_redo->commit_action();\n+}\n+\n void TileSetAtlasSourceEditor::_tile_alternatives_control_draw() {\n \t// Update the hovered alternative tile.\n \tif (tools_button_group->get_pressed_button() == tool_select_button) {\ndiff --git a/editor/plugins/tiles/tile_set_atlas_source_editor.h b/editor/plugins/tiles/tile_set_atlas_source_editor.h\nindex 12a02e6a3980..b729364d1559 100644\n--- a/editor/plugins/tiles/tile_set_atlas_source_editor.h\n+++ b/editor/plugins/tiles/tile_set_atlas_source_editor.h\n@@ -253,6 +253,7 @@ class TileSetAtlasSourceEditor : public HSplitContainer {\n \tPopupMenu *alternative_tile_popup_menu = nullptr;\n \tControl *alternative_tiles_control = nullptr;\n \tControl *alternative_tiles_control_unscaled = nullptr;\n+\tvoid _tile_alternatives_create_button_pressed(const Vector2i &p_atlas_coords);\n \tvoid _tile_alternatives_control_draw();\n \tvoid _tile_alternatives_control_unscaled_draw();\n \tvoid _tile_alternatives_control_mouse_exited();\n", "instance_id": "godotengine__godot-102640", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: attempting to paint terrain over an alternative tile in the Godot tileset editor results in creating a new alternative tile, which is unintended behavior. The steps to reproduce are detailed, including specific actions and visual references (screenshots), and a minimal reproduction project is provided, which aids in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should painting terrain simply overwrite the alternative tile or ignore it?). Additionally, there are no mentions of specific edge cases or constraints that might affect the solution, such as how the system should behave with different types of tiles or under specific editor configurations. While the issue is reproducible and the goal is implied (prevent creating new alternative tiles in Paint mode), these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`tile_set_atlas_source_editor.cpp`) with modifications to the logic for creating alternative tiles. The changes involve conditional logic to restrict alternative tile creation based on the active tool (e.g., not in Paint mode) and adding undo/redo functionality, which requires understanding the editor's tool system and Godot's undo/redo framework. Second, the technical concepts involved include familiarity with Godot's editor plugin architecture, GUI control manipulation (e.g., buttons and mouse events), and the specific `TileSetAtlasSource` class behavior, which adds moderate complexity. Third, the changes do not significantly impact the broader system architecture but do require careful integration with existing functionality to avoid introducing new bugs. Finally, while the problem statement does not explicitly mention edge cases, the code changes suggest potential considerations, such as ensuring undo/redo works correctly for all tile configurations and preventing unintended interactions in different editor modes. Overall, this problem requires a solid understanding of a specific part of the Godot codebase and careful implementation, placing it slightly above medium difficulty at 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\"The default value is using \"$\" which won't return nodes...\" warning despite using Unique Name (\"%\")\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe error message for attempting to access a unique-named node in a class body without the `@onready` annotation is slightly incorrect - it claims the user is using \"$\", when in reality the user is using \"%\".\n\n![Image](https://github.com/user-attachments/assets/9ba9b6f5-1bf6-40f2-a5a8-1ab799010175)\n\n \n\n### Steps to reproduce\n\nIn a new GDScript file, on the class level, type the following:\n```gdscript\nvar something = %Hello\n```\n\nYou will get an error like\n```\nThe default value is using \"$\" which won't return nodes in the scene tree before \"_ready()\" is called. Use the \"@onready\" annotation to solve this. (Warning treated as error.)gdscript(-1)\n```\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/modules/gdscript/gdscript_analyzer.cpp b/modules/gdscript/gdscript_analyzer.cpp\nindex 60109efc4d5b..99fab724e8da 100644\n--- a/modules/gdscript/gdscript_analyzer.cpp\n+++ b/modules/gdscript/gdscript_analyzer.cpp\n@@ -1093,7 +1093,12 @@ void GDScriptAnalyzer::resolve_class_member(GDScriptParser::ClassNode *p_class,\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t\tif (is_get_node) {\n-\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, is_using_shorthand ? \"$\" : \"get_node()\");\n+\t\t\t\t\t\t\tString offending_syntax = \"get_node()\";\n+\t\t\t\t\t\t\tif (is_using_shorthand) {\n+\t\t\t\t\t\t\t\tGDScriptParser::GetNodeNode *get_node_node = static_cast<GDScriptParser::GetNodeNode *>(expr);\n+\t\t\t\t\t\t\t\toffending_syntax = get_node_node->use_dollar ? \"$\" : \"%\";\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\tparser->push_warning(member.variable, GDScriptWarning::GET_NODE_DEFAULT_WITHOUT_ONREADY, offending_syntax);\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n", "instance_id": "godotengine__godot-102389", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an error message in the Godot engine's GDScript analyzer incorrectly reports the use of \"$\" when the user is actually using \"%\" for accessing a unique-named node. The goal is evident (fix the error message to reflect the correct syntax), and the steps to reproduce the issue are provided with a minimal code snippet. Additionally, system information and a screenshot are included to contextualize the problem. However, there are minor ambiguities: the problem statement does not explicitly discuss the expected behavior or output after the fix (though it can be inferred), and it lacks mention of potential edge cases or constraints related to the error message handling. Overall, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The issue is a straightforward bug fix in the GDScript analyzer component of the Godot engine, specifically in the error message generation logic. The code change is localized to a single file (`gdscript_analyzer.cpp`) and involves a small modification (a few lines) to dynamically determine the offending syntax (\"$\" or \"%\") based on the parsed node data. The technical concepts required are minimal: basic C++ knowledge, familiarity with the Godot engine's GDScript parser structure, and understanding of conditional logic for string selection. There is no significant impact on the broader codebase or system architecture, and the change does not require handling complex edge cases beyond identifying the correct syntax used. Error handling is already in place via the warning system, and no additional logic for edge cases is needed based on the provided diff. This makes the task approachable for someone with basic to intermediate experience in C++ and a cursory understanding of the Godot engine's internals.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[3.x] Autocomplete fails when typing the key before the value in a dictionary\n**Godot version:**\r\nGodot 3.2.stable.official\r\n\r\n**OS/device including version:**\r\nWindows 10 home\r\n\r\n**Issue description:**\r\nWhen adding a key to the dictionary, the autocomplete does not work until I enter the value. The workaround is to start by entering `:any_value` then moving the cursor back and entering the key for the autocomplete to work.\r\n\r\n**Steps to reproduce:**\r\nCreate the following script and try to add a key value pair to `data`, the enum does not autocomplete until a value is added :\r\n```\r\nextends Reference\r\n\r\nvar\tdata = {InnerClass.INNER_ENUM_VALUE_1:1}\r\n\r\nclass InnerClass:\r\n\tenum {INNER_ENUM_VALUE_1}\r\n\r\n```\r\n**Minimal reproduction project:**\r\nDon't need a project, just the above script.\n", "patch": "diff --git a/modules/gdscript/gdscript_parser.cpp b/modules/gdscript/gdscript_parser.cpp\nindex 077ab6f04667..4b95f5a83613 100644\n--- a/modules/gdscript/gdscript_parser.cpp\n+++ b/modules/gdscript/gdscript_parser.cpp\n@@ -3123,13 +3123,9 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\t\tcase DictionaryNode::LUA_TABLE:\n \t\t\t\t\tif (key != nullptr && key->type != Node::IDENTIFIER && key->type != Node::LITERAL) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (key != nullptr && key->type == Node::LITERAL && static_cast<LiteralNode *>(key)->value.get_type() != Variant::STRING) {\n \t\t\t\t\t\tpush_error(R\"(Expected identifier or string as Lua-style dictionary key (e.g \"{ key = value }\").)\");\n-\t\t\t\t\t\tadvance();\n-\t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t\tif (!match(GDScriptTokenizer::Token::EQUAL)) {\n \t\t\t\t\t\tif (match(GDScriptTokenizer::Token::COLON)) {\n@@ -3169,6 +3165,21 @@ GDScriptParser::ExpressionNode *GDScriptParser::parse_dictionary(ExpressionNode\n \t\t\tif (key != nullptr && value != nullptr) {\n \t\t\t\tdictionary->elements.push_back({ key, value });\n \t\t\t}\n+\n+\t\t\t// Do phrase level recovery by inserting an imaginary expression for missing keys or values.\n+\t\t\t// This ensures the successfully parsed expression is part of the AST and can be analyzed.\n+\t\t\tif (key != nullptr && value == nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ key, dummy });\n+\t\t\t} else if (key == nullptr && value != nullptr) {\n+\t\t\t\tLiteralNode *dummy = alloc_recovery_node<LiteralNode>();\n+\t\t\t\tdummy->value = Variant();\n+\n+\t\t\t\tdictionary->elements.push_back({ dummy, value });\n+\t\t\t}\n+\n \t\t} while (match(GDScriptTokenizer::Token::COMMA) && !is_at_end());\n \t}\n \tpop_multiline();\ndiff --git a/modules/gdscript/gdscript_parser.h b/modules/gdscript/gdscript_parser.h\nindex 5da2bc80207f..8afc6b5f05a6 100644\n--- a/modules/gdscript/gdscript_parser.h\n+++ b/modules/gdscript/gdscript_parser.h\n@@ -1453,6 +1453,18 @@ class GDScriptParser {\n \n \t\treturn node;\n \t}\n+\n+\t// Allocates a node for patching up the parse tree when an error occurred.\n+\t// Such nodes don't track their extents as they don't relate to actual tokens.\n+\ttemplate <typename T>\n+\tT *alloc_recovery_node() {\n+\t\tT *node = memnew(T);\n+\t\tnode->next = list;\n+\t\tlist = node;\n+\n+\t\treturn node;\n+\t}\n+\n \tvoid clear();\n \tvoid push_error(const String &p_message, const Node *p_origin = nullptr);\n #ifdef DEBUG_ENABLED\n", "instance_id": "godotengine__godot-102218", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: autocomplete in the Godot engine's GDScript editor fails when typing a dictionary key before its value. It provides a specific scenario (adding a key-value pair to a dictionary), steps to reproduce the issue, and a minimal code snippet to demonstrate the problem. However, there are minor ambiguities and missing details. For instance, the expected behavior of autocomplete is not explicitly defined (e.g., should it suggest enum values or other identifiers?), and there is no mention of specific edge cases or constraints that might affect the solution. Additionally, the problem statement does not clarify the desired outcome beyond \"autocomplete should work,\" leaving some room for interpretation. Overall, while the issue is understandable, it lacks comprehensive details about the expected fix or potential complexities in the editor's parsing logic.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the code changes are made in the GDScript parser (a core component of the Godot engine), which requires a deep understanding of the engine's internals, specifically how the parser constructs the Abstract Syntax Tree (AST) and handles incomplete or erroneous input for features like autocomplete. The modifications involve adding recovery logic to handle missing keys or values in dictionary literals by inserting dummy nodes, which is a non-trivial change to the parsing strategy. This impacts not just a single function but the overall behavior of the parser, potentially affecting autocomplete and error reporting across the system. \n\nFrom a technical concepts perspective, the solution requires knowledge of compiler design (parsing and AST construction), memory management in C++ (e.g., `memnew` for node allocation), and familiarity with Godot's custom data structures and parsing rules. The code changes span two files (`gdscript_parser.cpp` and `gdscript_parser.h`), indicating a moderate scope, though the actual lines of code added are relatively small. \n\nRegarding edge cases and error handling, the problem statement does not explicitly mention specific scenarios, but the code changes introduce recovery mechanisms for incomplete dictionary expressions (missing keys or values), which inherently addresses potential edge cases in user input during editing. Crafting this recovery logic without breaking existing parser behavior or introducing performance overhead adds to the complexity. \n\nOverall, this problem requires a solid grasp of the codebase's architecture and careful consideration of the parser's behavior, justifying a difficulty score of 0.65. It is not at the highest end of difficulty (e.g., a complete parser rewrite or system-level change), but it is challenging enough to demand specialized knowledge and careful implementation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "SpotLight3D shadow has significant peter-panning with default settings (4.4-dev7 and 4.4-beta1)\n### Tested versions\n\nReproducible in: 4.4-dev7 and 4.4-beta1\nNot reproducible in: 4.4-dev6 and before\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 threads)\n\n### Issue description\n\nShadow casting SpotLight3D has noticeable peter-panning effect with default bias value. Example below:\n\n![Image](https://github.com/user-attachments/assets/501f57ff-6c38-477d-aa8e-0e2e695ab5ba)\n\n### Steps to reproduce\n\nCreate a new 3D scene\nAdd floor into the scene and add mesh on the floor\nAdd SpotLight3D and enable shadows\nPoint the spotlight towards mesh and observe shadow it casts\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\nindex 8e393c07bdb2..6fb8fe6ca339 100644\n--- a/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n+++ b/servers/rendering/renderer_rd/shaders/scene_forward_lights_inc.glsl\n@@ -733,7 +733,7 @@ void light_process_spot(uint idx, vec3 vertex, vec3 eye_vec, vec3 normal, vec3 v\n \t\tvec4 v = vec4(vertex + normal_bias, 1.0);\n \n \t\tvec4 splane = (spot_lights.data[idx].shadow_matrix * v);\n-\t\tsplane.z += spot_lights.data[idx].shadow_bias / (light_length * spot_lights.data[idx].inv_radius);\n+\t\tsplane.z += spot_lights.data[idx].shadow_bias;\n \t\tsplane /= splane.w;\n \n \t\tif (sc_use_light_soft_shadows() && spot_lights.data[idx].soft_shadow_size > 0.0) {\ndiff --git a/servers/rendering/renderer_scene_cull.cpp b/servers/rendering/renderer_scene_cull.cpp\nindex 0b98fc6769e7..ef79ef8cda7a 100644\n--- a/servers/rendering/renderer_scene_cull.cpp\n+++ b/servers/rendering/renderer_scene_cull.cpp\n@@ -2510,7 +2510,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \t\t\t\t}\n \n \t\t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n-\t\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\t\treal_t z_near = MIN(0.025f, radius);\n \t\t\t\tProjection cm;\n \t\t\t\tcm.set_perspective(90, 1, z_near, radius);\n \n@@ -2600,7 +2600,7 @@ bool RendererSceneCull::_light_instance_update_shadow(Instance *p_instance, cons\n \n \t\t\treal_t radius = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_RANGE);\n \t\t\treal_t angle = RSG::light_storage->light_get_param(p_instance->base, RS::LIGHT_PARAM_SPOT_ANGLE);\n-\t\t\treal_t z_near = MIN(0.005f, radius);\n+\t\t\treal_t z_near = MIN(0.025f, radius);\n \n \t\t\tProjection cm;\n \t\t\tcm.set_perspective(angle * 2.0, 1.0, z_near, radius);\n", "instance_id": "godotengine__godot-101952", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue of \"peter-panning\" (a visual artifact in shadow rendering) with SpotLight3D in specific versions of the Godot engine (4.4-dev7 and 4.4-beta1). It provides steps to reproduce the issue, system information, and a visual example, which helps in understanding the problem. However, there are minor ambiguities and missing details. For instance, the term \"peter-panning\" is not explicitly defined in the context of shadow rendering, which might require domain-specific knowledge to interpret correctly (it typically refers to shadows detaching from objects). Additionally, the problem statement does not specify the expected behavior or desired outcome after the fix, nor does it mention specific edge cases or constraints that should be considered in the solution. While the reproduction steps are clear, the lack of a minimal reproduction project (MRP) could make it slightly harder to test and validate the issue. Overall, the statement is valid and mostly clear but lacks some minor details for full comprehensiveness.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves modifications in two files: a GLSL shader file (`scene_forward_lights_inc.glsl`) and a C++ file (`renderer_scene_cull.cpp`). The changes are relatively small and localized, focusing on adjusting shadow bias calculations and near-plane values for perspective projection in shadow rendering. However, understanding and implementing these changes requires knowledge of multiple technical concepts, including 3D graphics rendering, shadow mapping techniques, GLSL shader programming, and the Godot engine's rendering pipeline. Specifically, the developer needs to understand how shadow bias and near-plane settings affect shadow artifacts like peter-panning, which involves some domain-specific knowledge of computer graphics. The changes also impact a critical part of the rendering system, potentially affecting visual quality across various scenes, which adds a layer of complexity in terms of testing and validation. While the problem does not explicitly mention edge cases or error handling, the nature of shadow rendering implies potential challenges with different light configurations, object geometries, or hardware setups, which the developer must consider. Overall, this problem requires a moderate level of expertise in graphics programming and familiarity with the Godot engine's internals, placing it in the medium difficulty range (0.4-0.6), slightly above the midpoint due to the specialized knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Jolt Physics and sync_to_physics prevents any AnimatableBody3D transforms\n### Tested versions\n\n- Reproducible: 4.4.beta1\n- Not reproducible: 4.4.dev7\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nUsing the Jolt physics engine and enabling `AnimatableBody3D.sync_to_physics` stops the object from moving at all when setting a transform, position or similar.\n\nDisabling `sync_to_physics`, or switching to the Godot physics engine fixes the problem.\n\n \n\n### Steps to reproduce\n\nCreate an `AnimatableBody3D` Node. Set `sync_to_physics` to true. Use the Jolt physics engine.\n\n### Minimal reproduction project (MRP)\n\n[jolt-transform-bug.zip](https://github.com/user-attachments/files/18464415/jolt-transform-bug.zip)\n\n", "patch": "diff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex d1a40e7b105c..ac2b37470ef1 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -210,20 +210,6 @@ void JoltBody3D::_move_kinematic(float p_step, JPH::Body &p_jolt_body) {\n \tp_jolt_body.MoveKinematic(new_position, new_rotation, p_step);\n }\n \n-void JoltBody3D::_pre_step_rigid(float p_step, JPH::Body &p_jolt_body) {\n-\t_integrate_forces(p_step, p_jolt_body);\n-\t_enqueue_call_queries();\n-}\n-\n-void JoltBody3D::_pre_step_kinematic(float p_step, JPH::Body &p_jolt_body) {\n-\t_update_gravity(p_jolt_body);\n-\t_move_kinematic(p_step, p_jolt_body);\n-\n-\tif (reports_contacts()) {\n-\t\t_enqueue_call_queries();\n-\t}\n-}\n-\n JPH::EAllowedDOFs JoltBody3D::_calculate_allowed_dofs() const {\n \tif (is_static()) {\n \t\treturn JPH::EAllowedDOFs::All;\n@@ -1237,13 +1223,18 @@ void JoltBody3D::pre_step(float p_step, JPH::Body &p_jolt_body) {\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID:\n \t\tcase PhysicsServer3D::BODY_MODE_RIGID_LINEAR: {\n-\t\t\t_pre_step_rigid(p_step, p_jolt_body);\n+\t\t\t_integrate_forces(p_step, p_jolt_body);\n \t\t} break;\n \t\tcase PhysicsServer3D::BODY_MODE_KINEMATIC: {\n-\t\t\t_pre_step_kinematic(p_step, p_jolt_body);\n+\t\t\t_update_gravity(p_jolt_body);\n+\t\t\t_move_kinematic(p_step, p_jolt_body);\n \t\t} break;\n \t}\n \n+\tif (_should_call_queries()) {\n+\t\t_enqueue_call_queries();\n+\t}\n+\n \tcontact_count = 0;\n }\n \ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.h b/modules/jolt_physics/objects/jolt_body_3d.h\nindex 4f5d4006edcf..9b9472e73ae8 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_body_3d.h\n@@ -110,6 +110,7 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvirtual void _add_to_space() override;\n \n+\tbool _should_call_queries() const { return state_sync_callback.is_valid() || custom_integration_callback.is_valid(); }\n \tvoid _enqueue_call_queries();\n \tvoid _dequeue_call_queries();\n \n@@ -117,9 +118,6 @@ class JoltBody3D final : public JoltShapedObject3D {\n \n \tvoid _move_kinematic(float p_step, JPH::Body &p_jolt_body);\n \n-\tvoid _pre_step_rigid(float p_step, JPH::Body &p_jolt_body);\n-\tvoid _pre_step_kinematic(float p_step, JPH::Body &p_jolt_body);\n-\n \tJPH::EAllowedDOFs _calculate_allowed_dofs() const;\n \n \tJPH::MassProperties _calculate_mass_properties(const JPH::Shape &p_shape) const;\n", "instance_id": "godotengine__godot-101803", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: using the Jolt physics engine with `AnimatableBody3D.sync_to_physics` enabled prevents the object from moving when transforms or positions are set. It provides specific conditions under which the issue occurs (Jolt physics engine, `sync_to_physics` enabled) and contrasts this with scenarios where the issue does not occur (disabling `sync_to_physics` or using Godot physics). Additionally, it includes system information, tested versions, and steps to reproduce, which are helpful for context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., how the transform should behave with `sync_to_physics` enabled) or provide detailed examples of the failure beyond \"stops the object from moving.\" Edge cases, constraints, or specific failure modes are not mentioned, which could leave room for interpretation when implementing a fix. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`jolt_body_3d.cpp`) with modifications to the logic of pre-step handling for rigid and kinematic bodies. The changes involve refactoring by removing dedicated pre-step methods and inlining their logic into the main `pre_step` method, along with introducing a new helper method `_should_call_queries()`. This indicates a moderate level of complexity as it requires understanding the interaction between different body modes and the physics simulation loop in the Jolt physics engine. Second, the technical concepts involved include familiarity with physics engine internals (e.g., kinematic movement, force integration, gravity updates) and the specific behavior of `AnimatableBody3D` in Godot, which adds a layer of domain-specific knowledge. However, the changes do not appear to impact the broader system architecture or require extensive cross-module modifications. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest potential considerations around contact reporting and query callbacks, though the handling remains straightforward. Overall, this problem requires a moderate understanding of the codebase and physics simulation logic, placing it in the 0.4-0.6 range, with a specific score of 0.45 reflecting that it leans toward the lower end of medium difficulty due to the focused scope of changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Duplicating a script triggers modified outside Godot dialog\n### Tested versions\n\nGodot v4.4.dev7\n\nTried v4.4.dev2 too and it did not happen there\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - Wayland display driver, Single-window\n\n### Issue description\n\nIf you duplicate a script in FileSystem with the script open and then either save the open file or focus another window and then back to Godot it triggers the modified outside Godot dialog for the open script.\n\nhttps://github.com/user-attachments/assets/ddfba1e6-8ac9-4812-a46a-3fa22d1bbd4a\n\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\n[doc.zip](https://github.com/user-attachments/files/18423743/doc.zip)\n", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex f626891bd8ea..caf877f40789 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1486,6 +1486,11 @@ void FileSystemDock::_try_move_item(const FileOrFolder &p_item, const String &p_\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tRef<Resource> res = ResourceCache::get_ref(old_path);\n+\t\t\t\tif (res.is_valid()) {\n+\t\t\t\t\tres->set_path_cache(new_path);\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \ndiff --git a/editor/plugins/script_editor_plugin.cpp b/editor/plugins/script_editor_plugin.cpp\nindex 77dd61b26346..1a1e5697c2d2 100644\n--- a/editor/plugins/script_editor_plugin.cpp\n+++ b/editor/plugins/script_editor_plugin.cpp\n@@ -1170,11 +1170,10 @@ void ScriptEditor::_live_auto_reload_running_scripts() {\n bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \tdisk_changed_list->clear();\n \tTreeItem *r = disk_changed_list->create_item();\n-\tdisk_changed_list->set_hide_root(true);\n \n \tbool need_ask = false;\n \tbool need_reload = false;\n-\tbool use_autoreload = bool(EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\"));\n+\tbool use_autoreload = EDITOR_GET(\"text_editor/behavior/files/auto_reload_scripts_on_external_change\");\n \n \tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n \t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n@@ -1188,12 +1187,12 @@ bool ScriptEditor::_test_script_times_on_disk(Ref<Resource> p_for_script) {\n \t\t\t\tcontinue; //internal script, who cares\n \t\t\t}\n \n-\t\t\tuint64_t last_date = edited_res->get_last_modified_time();\n-\t\t\tuint64_t date = FileAccess::get_modified_time(edited_res->get_path());\n+\t\t\tuint64_t last_date = se->edited_file_data.last_modified_time;\n+\t\t\tuint64_t date = FileAccess::get_modified_time(se->edited_file_data.path);\n \n \t\t\tif (last_date != date) {\n \t\t\t\tTreeItem *ti = disk_changed_list->create_item(r);\n-\t\t\t\tti->set_text(0, edited_res->get_path().get_file());\n+\t\t\t\tti->set_text(0, se->edited_file_data.path.get_file());\n \n \t\t\t\tif (!use_autoreload || se->is_unsaved()) {\n \t\t\t\t\tneed_ask = true;\n@@ -2231,11 +2230,6 @@ void ScriptEditor::_update_script_names() {\n \t\t\tRef<Texture2D> icon = se->get_theme_icon();\n \t\t\tString path = se->get_edited_resource()->get_path();\n \t\t\tbool saved = !path.is_empty();\n-\t\t\tif (saved) {\n-\t\t\t\t// The script might be deleted, moved, or renamed, so make sure\n-\t\t\t\t// to update original path to previously edited resource.\n-\t\t\t\tse->set_meta(\"_edit_res_path\", path);\n-\t\t\t}\n \t\t\tString name = se->get_name();\n \t\t\tRef<Script> scr = se->get_edited_resource();\n \n@@ -2633,7 +2627,8 @@ bool ScriptEditor::edit(const Ref<Resource> &p_resource, int p_line, int p_col,\n \n \t// If we delete a script within the filesystem, the original resource path\n \t// is lost, so keep it as metadata to figure out the exact tab to delete.\n-\tse->set_meta(\"_edit_res_path\", p_resource->get_path());\n+\tse->edited_file_data.path = p_resource->get_path();\n+\tse->edited_file_data.last_modified_time = FileAccess::get_modified_time(p_resource->get_path());\n \tif (se->get_edit_menu()) {\n \t\tse->get_edit_menu()->hide();\n \t\tmenu_hb->add_child(se->get_edit_menu());\n@@ -3042,6 +3037,15 @@ void ScriptEditor::_files_moved(const String &p_old_file, const String &p_new_fi\n \tif (!script_editor_cache->has_section(p_old_file)) {\n \t\treturn;\n \t}\n+\n+\tfor (int i = 0; i < tab_container->get_tab_count(); i++) {\n+\t\tScriptEditorBase *se = Object::cast_to<ScriptEditorBase>(tab_container->get_tab_control(i));\n+\t\tif (se && se->edited_file_data.path == p_old_file) {\n+\t\t\tse->edited_file_data.path = p_new_file;\n+\t\t\tbreak;\n+\t\t}\n+\t}\n+\n \tVariant state = script_editor_cache->get_value(p_old_file, \"state\");\n \tscript_editor_cache->erase_section(p_old_file);\n \tscript_editor_cache->set_value(p_new_file, \"state\", state);\n@@ -3064,7 +3068,7 @@ void ScriptEditor::_file_removed(const String &p_removed_file) {\n \t\tif (!se) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (se->get_meta(\"_edit_res_path\") == p_removed_file) {\n+\t\tif (se->edited_file_data.path == p_removed_file) {\n \t\t\t// The script is deleted with no undo, so just close the tab.\n \t\t\t_close_tab(i, false, false);\n \t\t}\n@@ -4414,9 +4418,10 @@ ScriptEditor::ScriptEditor(WindowWrapper *p_wrapper) {\n \t\tvbc->add_child(files_are_newer_label);\n \n \t\tdisk_changed_list = memnew(Tree);\n-\t\tvbc->add_child(disk_changed_list);\n+\t\tdisk_changed_list->set_hide_root(true);\n \t\tdisk_changed_list->set_auto_translate_mode(AUTO_TRANSLATE_MODE_DISABLED);\n \t\tdisk_changed_list->set_v_size_flags(SIZE_EXPAND_FILL);\n+\t\tvbc->add_child(disk_changed_list);\n \n \t\tLabel *what_action_label = memnew(Label);\n \t\twhat_action_label->set_text(TTR(\"What action should be taken?\"));\ndiff --git a/editor/plugins/script_editor_plugin.h b/editor/plugins/script_editor_plugin.h\nindex 892a6155d5b7..50e6cfd91cd6 100644\n--- a/editor/plugins/script_editor_plugin.h\n+++ b/editor/plugins/script_editor_plugin.h\n@@ -173,6 +173,11 @@ class ScriptEditorBase : public VBoxContainer {\n \tstatic void _bind_methods();\n \n public:\n+\tstruct EditedFileData {\n+\t\tString path;\n+\t\tuint64_t last_modified_time = -1;\n+\t} edited_file_data;\n+\n \tvirtual void add_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \tvirtual void set_syntax_highlighter(Ref<EditorSyntaxHighlighter> p_highlighter) = 0;\n \ndiff --git a/editor/plugins/script_text_editor.cpp b/editor/plugins/script_text_editor.cpp\nindex ece9616b69b2..79de2e4cebb5 100644\n--- a/editor/plugins/script_text_editor.cpp\n+++ b/editor/plugins/script_text_editor.cpp\n@@ -456,6 +456,7 @@ void ScriptTextEditor::convert_indent() {\n \n void ScriptTextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void ScriptTextEditor::goto_line(int p_line, int p_column) {\ndiff --git a/editor/plugins/text_editor.cpp b/editor/plugins/text_editor.cpp\nindex ee2d592ed3fd..6af3befe1c41 100644\n--- a/editor/plugins/text_editor.cpp\n+++ b/editor/plugins/text_editor.cpp\n@@ -302,6 +302,7 @@ void TextEditor::convert_indent() {\n \n void TextEditor::tag_saved_version() {\n \tcode_editor->get_text_editor()->tag_saved_version();\n+\tedited_file_data.last_modified_time = FileAccess::get_modified_time(edited_file_data.path);\n }\n \n void TextEditor::goto_line(int p_line, int p_column) {\n", "instance_id": "godotengine__godot-101616", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: duplicating a script in the Godot editor's FileSystem triggers an erroneous \"modified outside Godot\" dialog under specific conditions (e.g., saving the file or switching focus). It includes the tested versions of Godot, system information, and a reference to a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (i.e., what should happen when a script is duplicated) or clarify whether the dialog should be suppressed entirely or handled differently. Additionally, edge cases or specific constraints (e.g., behavior with different file types or under different editor configurations) are not mentioned. While the issue is reproducible based on the description and assets provided, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (`filesystem_dock.cpp`, `script_editor_plugin.cpp`, `script_editor_plugin.h`, `script_text_editor.cpp`, and `text_editor.cpp`) within the Godot editor, indicating a need to understand interactions between the filesystem and script editor components. The changes involve updating resource paths, tracking file modification times, and handling file movement/deletion events, which requires a moderate understanding of Godot's internal architecture, particularly its resource management and editor plugin systems. \n\nSecond, the technical concepts involved include file system operations (e.g., `FileAccess::get_modified_time`), resource caching (`ResourceCache::get_ref`), and editor-specific logic for tracking file states and triggering dialogs. While these are not overly complex for someone familiar with Godot or C++ development, they do require domain-specific knowledge of the engine's internals and careful handling to avoid introducing new bugs.\n\nThird, the problem touches on edge cases, such as ensuring that file path updates and modification time tracking work correctly during duplication, movement, or deletion of scripts. The code changes also modify error handling logic to prevent false positives in the \"modified outside Godot\" dialog, which adds some complexity. However, the changes do not appear to impact the broader system architecture or require advanced algorithms, performance optimizations, or deep system-level knowledge.\n\nOverall, I rate this as 0.55 (medium difficulty) because it requires understanding multiple components of the Godot editor, making non-trivial modifications across several files, and handling specific edge cases related to file operations. It is not a simple bug fix but also not a highly complex refactoring or feature implementation that would warrant a higher difficulty score.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Debugging embedded game does not refocus on continue\n### Tested versions\n\nGodot v4.4.dev (99a8ab795)\n\n### System information\n\nGodot v4.4.dev (99a8ab795) - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Laptop GPU (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 5800H with Radeon Graphics (16 threads)\n\n### Issue description\n\nWhen the game is embedded without the floating window, after hitting a breakpoint in the script editor, when I pressed Continue, the game tab is not refocused and Godot enters a wierd state where the editor is not focused, the game is probably focused but not visible.\n\n### Steps to reproduce\n\n- In the Game Workspace, enabled Embed and disable Floating Window\n- Attach a script and add a breakpoint anywhere\n- Start the game\n- Hit the breakpoint\n- Press Continue\n\nhttps://github.com/user-attachments/assets/fe304f67-773d-4948-9ec7-790e06b28db6\n\n\n### Minimal reproduction project (MRP)\n\n[test-godot-focus-debugging.zip](https://github.com/user-attachments/files/18269775/test-godot-focus-debugging.zip)\n\n", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 9d14e702be41..03c2f2067e9c 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -296,6 +296,7 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n+\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n \t\t\tif (has_focus()) {\n \t\t\t\t// Redraw to updated the focus style.\n \t\t\t\tqueue_redraw();\n@@ -312,6 +313,7 @@ void EmbeddedProcess::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"embedding_completed\"));\n \tADD_SIGNAL(MethodInfo(\"embedding_failed\"));\n \tADD_SIGNAL(MethodInfo(\"embedded_process_updated\"));\n+\tADD_SIGNAL(MethodInfo(\"embedded_process_focused\"));\n }\n \n EmbeddedProcess::EmbeddedProcess() {\ndiff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex f7e58258d425..d611f0a773cf 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -260,6 +260,12 @@ void GameView::_embedded_process_updated() {\n \tgame_size_label->set_text(vformat(\"%dx%d\", game_rect.size.x, game_rect.size.y));\n }\n \n+void GameView::_embedded_process_focused() {\n+\tif (embed_on_play && !window_wrapper->get_window_enabled()) {\n+\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_GAME);\n+\t}\n+}\n+\n void GameView::_project_settings_changed() {\n \t// Update the window size and aspect ratio.\n \t_update_embed_window_size();\n@@ -730,6 +736,7 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tembedded_process->connect(\"embedding_failed\", callable_mp(this, &GameView::_embedding_failed));\n \tembedded_process->connect(\"embedding_completed\", callable_mp(this, &GameView::_embedding_completed));\n \tembedded_process->connect(\"embedded_process_updated\", callable_mp(this, &GameView::_embedded_process_updated));\n+\tembedded_process->connect(\"embedded_process_focused\", callable_mp(this, &GameView::_embedded_process_focused));\n \tembedded_process->set_custom_minimum_size(Size2i(100, 100));\n \n \tstate_label = memnew(Label());\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6568f07b746c..64d679657c33 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -143,6 +143,7 @@ class GameView : public VBoxContainer {\n \tvoid _embedding_completed();\n \tvoid _embedding_failed();\n \tvoid _embedded_process_updated();\n+\tvoid _embedded_process_focused();\n \tvoid _project_settings_changed();\n \n \tvoid _update_ui();\n", "instance_id": "godotengine__godot-100916", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when debugging an embedded game in Godot without a floating window, pressing \"Continue\" after hitting a breakpoint does not refocus the game tab, leading to a weird state where neither the editor nor the game appears focused. The steps to reproduce are provided, along with system information and a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the game tab always refocus on \"Continue\"?), nor does it mention potential edge cases or constraints (e.g., behavior with multiple embedded processes or different editor configurations). Additionally, the \"weird state\" is not well-defined, leaving room for interpretation. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively limited, affecting only three files (`embedded_process.cpp`, `game_view_plugin.cpp`, and `game_view_plugin.h`) with a small number of lines changed (adding a signal and handling focus logic). The changes are localized to the embedded process and game view components, without impacting the broader system architecture. Second, the technical concepts involved include understanding Godot's signal system, editor UI interactions, and focus management, which require moderate familiarity with the Godot engine's internals but are not overly complex for someone with experience in game engine development or C++ GUI programming. Third, the problem does not explicitly mention edge cases, but the code changes suggest a straightforward fix without extensive error handling or performance considerations. However, implementing this fix requires understanding the interaction between the embedded process and the editor's main screen, which adds a layer of complexity beyond a simple bug fix. Overall, this problem is of medium difficulty (0.45), as it involves moderate codebase understanding and targeted modifications across a few files, but does not demand deep architectural changes or advanced technical expertise.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Resources saved to file from an imported scene do not save with consistent UIDs\n### Godot version\r\n\r\nv4.0.beta.custom_build [98e0d5995]\r\n\r\n### System information\r\n\r\nFedora 36\r\n\r\n### Issue description\r\n\r\nIf \"save to file\" is enabled for meshes or animations in an imported scene, the saved resources are given a random UID if the file doesn't already exist.\r\nThis is annoying if you've `.gitignore`d these files, which makes sense to do since they're auto-generated from glTF files. For example, I did so for the vehicle meshes in the [Truck Town](https://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town) demo. If you clone this repo right now, opening any of the vehicle scenes gives multiple invalid UID errors because when the mesh `.res` files are generated they don't get the same UIDs.\r\n\r\nI don't know how UIDs work, but I assume the way to fix this would be to remember what UID the resources are saved to in the glTF's `.import` file? That way it would be generated with the same UID every time.\r\n\r\n### Steps to reproduce\r\n\r\n1. Save a mesh or animation resource from a scene to a file using the advanced import options\r\n2. Reference that resource in a scene and save it\r\n3. Delete the resource and reimport the scene to regenerate it\r\n4. Open the scene referencing the resource, notice the invalid UID error\r\n\r\n### Minimal reproduction project\r\n\r\nhttps://github.com/godotengine/godot-demo-projects/tree/4.0-dev/3d/truck_town\n", "patch": "diff --git a/editor/import/3d/resource_importer_scene.cpp b/editor/import/3d/resource_importer_scene.cpp\nindex 81af2e0543aa..211ee77ca197 100644\n--- a/editor/import/3d/resource_importer_scene.cpp\n+++ b/editor/import/3d/resource_importer_scene.cpp\n@@ -1303,9 +1303,9 @@ Node *ResourceImporterScene::_post_fix_animations(Node *p_node, Node *p_root, co\n \t\t\t\tDictionary anim_settings = p_animation_data[name];\n \n \t\t\t\t{\n-\t\t\t\t\tint slices_count = anim_settings[\"slices/amount\"];\n+\t\t\t\t\tint slice_count = anim_settings[\"slices/amount\"];\n \n-\t\t\t\t\tfor (int i = 0; i < slices_count; i++) {\n+\t\t\t\t\tfor (int i = 0; i < slice_count; i++) {\n \t\t\t\t\t\tString slice_name = anim_settings[\"slice_\" + itos(i + 1) + \"/name\"];\n \t\t\t\t\t\tint from_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/start_frame\"];\n \t\t\t\t\t\tint end_frame = anim_settings[\"slice_\" + itos(i + 1) + \"/end_frame\"];\n@@ -1531,8 +1531,26 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n \t\t\t\t\t\t\tif (matdata.has(\"use_external/enabled\") && bool(matdata[\"use_external/enabled\"]) && matdata.has(\"use_external/path\")) {\n \t\t\t\t\t\t\t\tString path = matdata[\"use_external/path\"];\n \t\t\t\t\t\t\t\tRef<Material> external_mat = ResourceLoader::load(path);\n+\t\t\t\t\t\t\t\tif (external_mat.is_null()) {\n+\t\t\t\t\t\t\t\t\tif (matdata.has(\"use_external/fallback_path\")) {\n+\t\t\t\t\t\t\t\t\t\tString fallback_save_path = matdata[\"use_external/fallback_path\"];\n+\t\t\t\t\t\t\t\t\t\tif (!fallback_save_path.is_empty()) {\n+\t\t\t\t\t\t\t\t\t\t\texternal_mat = ResourceLoader::load(fallback_save_path);\n+\t\t\t\t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n+\t\t\t\t\t\t\t\t\t\t\t\tpath = fallback_save_path;\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\tif (external_mat.is_valid()) {\n \t\t\t\t\t\t\t\t\tm->set_surface_material(i, external_mat);\n+\t\t\t\t\t\t\t\t\tif (!path.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t\t\t\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(path);\n+\t\t\t\t\t\t\t\t\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\t\t\t\t\t\t\t\t\tmatdata[\"use_external/path\"] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\tmatdata[\"use_external/fallback_path\"] = external_mat->get_path();\n \t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n@@ -1784,13 +1802,14 @@ Node *ResourceImporterScene::_post_fix_node(Node *p_node, Node *p_root, HashMap<\n }\n \n Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> anim, bool p_save_to_file, const String &p_save_to_path, bool p_keep_custom_tracks) {\n-\tif (!p_save_to_file || !p_save_to_path.is_resource_file()) {\n+\tString res_path = ResourceUID::ensure_path(p_save_to_path);\n+\tif (!p_save_to_file || !res_path.is_resource_file()) {\n \t\treturn anim;\n \t}\n \n-\tif (FileAccess::exists(p_save_to_path) && p_keep_custom_tracks) {\n+\tif (FileAccess::exists(res_path) && p_keep_custom_tracks) {\n \t\t// Copy custom animation tracks from previously imported files.\n-\t\tRef<Animation> old_anim = ResourceLoader::load(p_save_to_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\tRef<Animation> old_anim = ResourceLoader::load(res_path, \"Animation\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n \t\tif (old_anim.is_valid()) {\n \t\t\tfor (int i = 0; i < old_anim->get_track_count(); i++) {\n \t\t\t\tif (!old_anim->track_is_imported(i)) {\n@@ -1801,16 +1820,21 @@ Ref<Animation> ResourceImporterScene::_save_animation_to_file(Ref<Animation> ani\n \t\t}\n \t}\n \n-\tif (ResourceCache::has(p_save_to_path)) {\n-\t\tRef<Animation> old_anim = ResourceCache::get_ref(p_save_to_path);\n+\tif (ResourceCache::has(res_path)) {\n+\t\tRef<Animation> old_anim = ResourceCache::get_ref(res_path);\n \t\tif (old_anim.is_valid()) {\n \t\t\told_anim->copy_from(anim);\n \t\t\tanim = old_anim;\n \t\t}\n \t}\n-\tanim->set_path(p_save_to_path, true); // Set path to save externally.\n-\tError err = ResourceSaver::save(anim, p_save_to_path, ResourceSaver::FLAG_CHANGE_PATH);\n-\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + p_save_to_path);\n+\tanim->set_path(res_path, true); // Set path to save externally.\n+\tError err = ResourceSaver::save(anim, res_path, ResourceSaver::FLAG_CHANGE_PATH);\n+\n+\tERR_FAIL_COND_V_MSG(err != OK, anim, \"Saving of animation failed: \" + res_path);\n+\tif (p_save_to_path.begins_with(\"uid://\")) {\n+\t\t// slow\n+\t\tResourceSaver::set_uid(res_path, ResourceUID::get_singleton()->text_to_id(p_save_to_path));\n+\t}\n \treturn anim;\n }\n \n@@ -2041,6 +2065,7 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MESH: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/shadow_meshes\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lightmap_uv\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"generate/lods\", PROPERTY_HINT_ENUM, \"Default,Enable,Disable\"), 0));\n@@ -2049,11 +2074,13 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\tcase INTERNAL_IMPORT_CATEGORY_MATERIAL: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"use_external/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/path\", PROPERTY_HINT_FILE, \"*.material,*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"use_external/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t} break;\n \t\tcase INTERNAL_IMPORT_CATEGORY_ANIMATION: {\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"settings/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"save_to_file/keep_custom_tracks\"), \"\"));\n \t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slices/amount\", PROPERTY_HINT_RANGE, \"0,256,1\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), 0));\n \n@@ -2063,7 +2090,8 @@ void ResourceImporterScene::get_internal_import_options(InternalImportCategory p\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/end_frame\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::INT, \"slice_\" + itos(i + 1) + \"/loop_mode\", PROPERTY_HINT_ENUM, \"None,Linear,Pingpong\"), 0));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/enabled\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_DEFAULT | PROPERTY_USAGE_UPDATE_ALL_IF_MODIFIED), false));\n-\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \".res,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/path\", PROPERTY_HINT_SAVE_FILE, \"*.res,*.anim,*.tres\"), \"\"));\n+\t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::STRING, \"slice_\" + itos(i + 1) + \"/save_to_file/fallback_path\", PROPERTY_HINT_NONE, \"\", PROPERTY_USAGE_NO_EDITOR), \"\"));\n \t\t\t\tr_options->push_back(ImportOption(PropertyInfo(Variant::BOOL, \"slice_\" + itos(i + 1) + \"/save_to_file/keep_custom_tracks\"), false));\n \t\t\t}\n \t\t} break;\n@@ -2527,7 +2555,7 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \n \t\t\t\t\tif (bool(mesh_settings.get(\"save_to_file/enabled\", false))) {\n \t\t\t\t\t\tsave_to_file = mesh_settings.get(\"save_to_file/path\", String());\n-\t\t\t\t\t\tif (!save_to_file.is_resource_file()) {\n+\t\t\t\t\t\tif (!ResourceUID::ensure_path(save_to_file).is_resource_file()) {\n \t\t\t\t\t\t\tsave_to_file = \"\";\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n@@ -2581,16 +2609,24 @@ Node *ResourceImporterScene::_generate_meshes(Node *p_node, const Dictionary &p_\n \t\t\t\tsrc_mesh_node->get_mesh()->optimize_indices();\n \n \t\t\t\tif (!save_to_file.is_empty()) {\n-\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_to_file);\n+\t\t\t\t\tString save_res_path = ResourceUID::ensure_path(save_to_file);\n+\t\t\t\t\tRef<Mesh> existing = ResourceCache::get_ref(save_res_path);\n \t\t\t\t\tif (existing.is_valid()) {\n \t\t\t\t\t\t//if somehow an existing one is useful, create\n \t\t\t\t\t\texisting->reset_state();\n \t\t\t\t\t}\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh(existing);\n \n-\t\t\t\t\tResourceSaver::save(mesh, save_to_file); //override\n+\t\t\t\t\tError err = ResourceSaver::save(mesh, save_res_path); //override\n+\t\t\t\t\tif (err != OK) {\n+\t\t\t\t\t\tWARN_PRINT(vformat(\"Failed to save mesh %s to '%s'.\", mesh->get_name(), save_res_path));\n+\t\t\t\t\t}\n+\t\t\t\t\tif (err == OK && save_to_file.begins_with(\"uid://\")) {\n+\t\t\t\t\t\t// slow\n+\t\t\t\t\t\tResourceSaver::set_uid(save_res_path, ResourceUID::get_singleton()->text_to_id(save_to_file));\n+\t\t\t\t\t}\n \n-\t\t\t\t\tmesh->set_path(save_to_file, true); //takeover existing, if needed\n+\t\t\t\t\tmesh->set_path(save_res_path, true); //takeover existing, if needed\n \n \t\t\t\t} else {\n \t\t\t\t\tmesh = src_mesh_node->get_mesh()->get_mesh();\n@@ -2868,14 +2904,66 @@ Node *ResourceImporterScene::pre_import(const String &p_source_file, const HashM\n \treturn scene;\n }\n \n-Error ResourceImporterScene::_check_resource_save_paths(const Dictionary &p_data) {\n+static Error convert_path_to_uid(ResourceUID::ID p_source_id, const String &p_hash_str, Dictionary &p_settings, const String &p_path_key, const String &p_fallback_path_key) {\n+\tconst String &raw_save_path = p_settings[p_path_key];\n+\tString save_path = ResourceUID::ensure_path(raw_save_path);\n+\tif (raw_save_path.begins_with(\"uid://\")) {\n+\t\tif (save_path.is_empty() || !DirAccess::exists(save_path.get_base_dir())) {\n+\t\t\tif (p_settings.has(p_fallback_path_key)) {\n+\t\t\t\tString fallback_save_path = p_settings[p_fallback_path_key];\n+\t\t\t\tif (!fallback_save_path.is_empty() && DirAccess::exists(fallback_save_path.get_base_dir())) {\n+\t\t\t\t\tsave_path = fallback_save_path;\n+\t\t\t\t\tResourceUID::get_singleton()->add_id(ResourceUID::get_singleton()->text_to_id(raw_save_path), save_path);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tp_settings[p_fallback_path_key] = save_path;\n+\t\t}\n+\t}\n+\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\tif (!save_path.is_empty() && !raw_save_path.begins_with(\"uid://\")) {\n+\t\tconst ResourceUID::ID id = ResourceLoader::get_resource_uid(save_path);\n+\t\tif (id != ResourceUID::INVALID_ID) {\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(id);\n+\t\t} else {\n+\t\t\tResourceUID::ID save_id = hash64_murmur3_64(p_hash_str.hash64(), p_source_id) & 0x7FFFFFFFFFFFFFFF;\n+\t\t\tif (ResourceUID::get_singleton()->has_id(save_id)) {\n+\t\t\t\tif (save_path != ResourceUID::get_singleton()->get_id_path(save_id)) {\n+\t\t\t\t\t// The user has specified a path which does not match the default UID.\n+\t\t\t\t\tsave_id = ResourceUID::get_singleton()->create_id();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tp_settings[p_path_key] = ResourceUID::get_singleton()->id_to_text(save_id);\n+\t\t\tResourceUID::get_singleton()->add_id(save_id, save_path);\n+\t\t}\n+\t\tp_settings[p_fallback_path_key] = save_path;\n+\t}\n+\treturn OK;\n+}\n+\n+Error ResourceImporterScene::_check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data) {\n \tArray keys = p_data.keys();\n-\tfor (int i = 0; i < keys.size(); i++) {\n-\t\tconst Dictionary &settings = p_data[keys[i]];\n+\tfor (int di = 0; di < keys.size(); di++) {\n+\t\tDictionary settings = p_data[keys[di]];\n \n \t\tif (bool(settings.get(\"save_to_file/enabled\", false)) && settings.has(\"save_to_file/path\")) {\n-\t\t\tconst String save_path = ResourceUID::ensure_path(settings[\"save_to_file/path\"]);\n-\t\t\tERR_FAIL_COND_V(!save_path.is_empty() && !DirAccess::exists(save_path.get_base_dir()), ERR_FILE_BAD_PATH);\n+\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix;\n+\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings, \"save_to_file/path\", \"save_to_file/fallback_path\");\n+\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Resource save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t}\n+\n+\t\tif (settings.has(\"slices/amount\")) {\n+\t\t\tint slice_count = settings[\"slices/amount\"];\n+\t\t\tfor (int si = 0; si < slice_count; si++) {\n+\t\t\t\tif (bool(settings.get(\"slice_\" + itos(si + 1) + \"/save_to_file/enabled\", false)) &&\n+\t\t\t\t\t\tsettings.has(\"slice_\" + itos(si + 1) + \"/save_to_file/path\")) {\n+\t\t\t\t\tString to_hash = keys[di].operator String() + p_hash_suffix + itos(si + 1);\n+\t\t\t\t\tError ret = convert_path_to_uid(p_source_id, to_hash, settings,\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/path\",\n+\t\t\t\t\t\t\t\"slice_\" + itos(si + 1) + \"/save_to_file/fallback_path\");\n+\t\t\t\t\tERR_FAIL_COND_V_MSG(ret != OK, ret, vformat(\"Slice save path %s not valid. Ensure parent directory has been created.\", settings.has(\"save_to_file/path\")));\n+\t\t\t\t}\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -2940,14 +3028,14 @@ Error ResourceImporterScene::import(ResourceUID::ID p_source_id, const String &p\n \t// Check whether any of the meshes or animations have nonexistent save paths\n \t// and if they do, fail the import immediately.\n \tif (subresources.has(\"meshes\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"meshes\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"m\", subresources[\"meshes\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\n \t}\n \n \tif (subresources.has(\"animations\")) {\n-\t\terr = _check_resource_save_paths(subresources[\"animations\"]);\n+\t\terr = _check_resource_save_paths(p_source_id, \"a\", subresources[\"animations\"]);\n \t\tif (err != OK) {\n \t\t\treturn err;\n \t\t}\ndiff --git a/editor/import/3d/resource_importer_scene.h b/editor/import/3d/resource_importer_scene.h\nindex af79746a4c34..68c06efbabbc 100644\n--- a/editor/import/3d/resource_importer_scene.h\n+++ b/editor/import/3d/resource_importer_scene.h\n@@ -210,7 +210,7 @@ class ResourceImporterScene : public ResourceImporter {\n \t\tSHAPE_TYPE_AUTOMATIC,\n \t};\n \n-\tstatic Error _check_resource_save_paths(const Dictionary &p_data);\n+\tstatic Error _check_resource_save_paths(ResourceUID::ID p_source_id, const String &p_hash_suffix, const Dictionary &p_data);\n \tArray _get_skinned_pose_transforms(ImporterMeshInstance3D *p_src_mesh_node);\n \tvoid _replace_owner(Node *p_node, Node *p_scene, Node *p_new_owner);\n \tNode *_generate_meshes(Node *p_node, const Dictionary &p_mesh_data, bool p_generate_lods, bool p_create_shadow_meshes, LightBakeMode p_light_bake_mode, float p_lightmap_texel_size, const Vector<uint8_t> &p_src_lightmap_cache, Vector<Vector<uint8_t>> &r_lightmap_caches);\ndiff --git a/editor/import/3d/scene_import_settings.cpp b/editor/import/3d/scene_import_settings.cpp\nindex 71b010a97026..609835385b1e 100644\n--- a/editor/import/3d/scene_import_settings.cpp\n+++ b/editor/import/3d/scene_import_settings.cpp\n@@ -1585,6 +1585,10 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\tcontinue; //ignore\n \t\t}\n \t\tString path = item->get_text(1);\n+\t\tString uid_path = path;\n+\t\tif (path.begins_with(\"uid://\")) {\n+\t\t\tpath = ResourceUID::uid_to_path(uid_path);\n+\t\t}\n \t\tif (!path.is_resource_file()) {\n \t\t\tcontinue;\n \t\t}\n@@ -1601,9 +1605,11 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\t\tEditorNode::get_singleton()->add_io_error(TTR(\"Can't make material external to file, write error:\") + \"\\n\\t\" + path);\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n+\t\t\t\tuid_path = ResourceUID::path_to_uid(path);\n \n \t\t\t\tmd.settings[\"use_external/enabled\"] = true;\n-\t\t\t\tmd.settings[\"use_external/path\"] = path;\n+\t\t\t\tmd.settings[\"use_external/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"use_external/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_MESH_SAVE_PATHS: {\n@@ -1611,14 +1617,16 @@ void SceneImportSettingsDialog::_save_dir_confirm() {\n \t\t\t\tMeshData &md = mesh_map[id];\n \n \t\t\t\tmd.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tmd.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tmd.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tmd.settings[\"save_to_file/fallback_path\"] = path;\n \t\t\t} break;\n \t\t\tcase ACTION_CHOOSE_ANIMATION_SAVE_PATHS: {\n \t\t\t\tERR_CONTINUE(!animation_map.has(id));\n \t\t\t\tAnimationData &ad = animation_map[id];\n \n \t\t\t\tad.settings[\"save_to_file/enabled\"] = true;\n-\t\t\t\tad.settings[\"save_to_file/path\"] = path;\n+\t\t\t\tad.settings[\"save_to_file/path\"] = uid_path;\n+\t\t\t\tad.settings[\"save_to_file/fallback_path\"] = path;\n \n \t\t\t} break;\n \t\t}\n", "instance_id": "godotengine__godot-100786", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: resources saved from an imported scene in Godot (specifically meshes and animations) are assigned random UIDs when regenerated, leading to invalid UID errors in scenes that reference them. The goal is to ensure consistent UIDs for these resources. The statement includes steps to reproduce the issue and references a minimal reproduction project, which aids in understanding the problem. However, there are minor ambiguities and missing details. For instance, it lacks a clear explanation of how UIDs should be consistently assigned or stored (though a suggestion about using the `.import` file is provided). Additionally, edge cases, such as what happens if the UID system itself fails or if there are conflicts, are not addressed. Constraints or expected behavior in complex scenarios (e.g., multiple imports or manual UID overrides) are also missing. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple functions and files within the Godot engine's resource importer system (`resource_importer_scene.cpp`, `resource_importer_scene.h`, and `scene_import_settings.cpp`). The modifications involve intricate logic for handling UIDs, including generating, converting, and saving them consistently, which requires a deep understanding of Godot's resource management and UID system. Second, the number of technical concepts involved is substantial: familiarity with Godot's internal APIs (e.g., `ResourceUID`, `ResourceSaver`, `ResourceLoader`), file system interactions (`DirAccess`), and dictionary-based settings management is necessary. Additionally, the changes touch on domain-specific knowledge related to 3D asset importing (e.g., meshes, animations, materials) and their serialization. Third, the problem requires handling complex edge cases, such as fallback paths for resources, directory existence checks, and UID conflicts, which are evident in the code changes (e.g., `convert_path_to_uid` function). While the changes do not appear to fundamentally alter the system's architecture, they impact critical functionality in the import pipeline, necessitating careful consideration of side effects. Overall, solving this requires a deep understanding of the codebase and complex modifications, justifying a score of 0.75. It does not reach the \"Very Hard\" range (0.8-1.0) as it does not involve system-level redesign or highly advanced algorithmic challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5da053f74e4a6..fa3d8ec3f1e07 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -41,9 +41,6 @@\n #ifdef HAVE_SYSCTL_ARND\n #include <sys/sysctl.h>\n #endif\n-#if defined(HAVE_STRONG_GETAUXVAL) && defined(__aarch64__)\n-#include <sys/auxv.h>\n-#endif\n \n namespace {\n \n@@ -189,62 +186,6 @@ uint64_t GetRdSeed() noexcept\n #endif\n }\n \n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-\n-bool g_rndr_supported = false;\n-\n-void InitHardwareRand()\n-{\n-    if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n-        g_rndr_supported = true;\n-    }\n-}\n-\n-void ReportHardwareRand()\n-{\n-    // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n-    // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n-        LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n-    }\n-}\n-\n-/** Read 64 bits of entropy using rndr.\n- *\n- * Must only be called when RNDR is supported.\n- */\n-uint64_t GetRNDR() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDR--Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_0; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n-/** Read 64 bits of entropy using rndrrs.\n- *\n- * Must only be called when RNDRRS is supported.\n- */\n-uint64_t GetRNDRRS() noexcept\n-{\n-    uint8_t ok = 0;\n-    uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n-        __asm__ volatile(\"yield\");\n-    } while (true);\n-    return r1;\n-}\n-\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -263,12 +204,6 @@ void SeedHardwareFast(CSHA512& hasher) noexcept {\n         hasher.Write((const unsigned char*)&out, sizeof(out));\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        uint64_t out = GetRNDR();\n-        hasher.Write((const unsigned char*)&out, sizeof(out));\n-        return;\n-    }\n #endif\n }\n \n@@ -294,14 +229,6 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         }\n         return;\n     }\n-#elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n-        for (int i = 0; i < 4; ++i) {\n-            uint64_t out = GetRNDRRS();\n-            hasher.Write((const unsigned char*)&out, sizeof(out));\n-        }\n-        return;\n-    }\n #endif\n }\n \n", "instance_id": "bitcoin__bitcoin-32248", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: `GetRandBytes()` hangs on specific Android devices (Samsung Galaxy S25 and OnePlus 13) due to an infinite loop in `GetRNDRRS()`. The goal is evident—ensure `GetRandBytes()` returns entropy without hanging. The steps to reproduce are provided, along with relevant hardware and software details (Android 15, specific processors, and Bitcoin Core commit). However, there are minor ambiguities: the problem statement does not explicitly discuss expected fallback mechanisms or alternative entropy sources if hardware RNG fails, nor does it mention specific constraints or requirements for the fix (e.g., performance expectations or compatibility with other platforms). Additionally, edge cases or broader implications of disabling hardware RNG (as seen in the code changes) are not addressed. Despite these minor gaps, the statement is actionable and provides sufficient context for an experienced developer to understand the issue.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is moderate but impactful: the provided diff removes hardware RNG support for AArch64 (specifically RNDR and RNDRRS) from `random.cpp`, which is a core component of the Bitcoin Core codebase dealing with cryptographic randomness. While the change is localized to a single file, it affects a critical system function (entropy generation), requiring a deep understanding of the implications on security and randomness quality. Second, the technical concepts involved are complex, including low-level hardware interactions (ARM-specific RNG instructions), inline assembly, and cryptographic randomness requirements. Understanding why the hardware RNG fails on specific devices and deciding to disable it entirely demands domain-specific knowledge of Android's hardware abstraction layer and ARM architecture. Third, while the code change itself is a removal rather than an addition, it implicitly requires evaluating fallback mechanisms (e.g., software-based entropy sources) and ensuring they are sufficient for security-critical operations. Finally, potential edge cases and error handling are significant: disabling hardware RNG might introduce performance or security risks on affected devices, and the developer must consider whether other devices or future Android versions might exhibit similar issues. This problem requires a solid grasp of system-level programming and cryptographic principles, justifying a difficulty score of 0.65, leaning toward the higher end of the \"Hard\" range due to the critical nature of randomness in a cryptocurrency context.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Implement synchronized update control sequences\n<!-- \r\n🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\nhttps://gitlab.com/gnachman/iterm2/-/wikis/synchronized-updates-spec\r\n\r\nThe goal of synchronized updates is to avoid showing a half-drawn screen, such as while paging through a document in an editor.\r\n\r\nA new control sequence is proposed that indicates the beginning and end of a update. No new content should be rendered by the terminal emulator until the update ends, at which point any changes made during the update should be applied atomically.\r\n\r\nThe purpose of this sequence is to provide a hint to the terminal emulator about how to draw atomically. If it turns out to be too difficult to do under some particular input, the hint can be safely ignored\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n\n```[tasklist]\n### Tasks\n```\n\n", "patch": "diff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex 90f6d5936f5..5824bcb2f2a 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -4,8 +4,6 @@\n #include \"precomp.h\"\r\n #include \"renderer.hpp\"\r\n \r\n-#pragma hdrstop\r\n-\r\n using namespace Microsoft::Console::Render;\r\n using namespace Microsoft::Console::Types;\r\n \r\n@@ -90,6 +88,11 @@ IRenderData* Renderer::GetRenderData() const noexcept\n             _pData->UnlockConsole();\r\n         });\r\n \r\n+        if (_isSynchronizingOutput)\r\n+        {\r\n+            _synchronizeWithOutput();\r\n+        }\r\n+\r\n         // Last chance check if anything scrolled without an explicit invalidate notification since the last frame.\r\n         _CheckViewportAndScroll();\r\n \r\n@@ -183,6 +186,71 @@ void Renderer::NotifyPaintFrame() noexcept\n     _thread.NotifyPaint();\r\n }\r\n \r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputBegin() noexcept\r\n+{\r\n+    // Kick the render thread into calling `_synchronizeWithOutput()`.\r\n+    _isSynchronizingOutput = true;\r\n+}\r\n+\r\n+// NOTE: You must be holding the console lock when calling this function.\r\n+void Renderer::SynchronizedOutputEnd() noexcept\r\n+{\r\n+    // Unblock `_synchronizeWithOutput()` from the `WaitOnAddress` call.\r\n+    _isSynchronizingOutput = false;\r\n+    WakeByAddressSingle(&_isSynchronizingOutput);\r\n+\r\n+    // It's crucial to give the render thread at least a chance to gain the lock.\r\n+    // Otherwise, a VT application could continuously spam DECSET 2026 (Synchronized Output) and\r\n+    // essentially drop our renderer to 10 FPS, because `_isSynchronizingOutput` is always true.\r\n+    //\r\n+    // Obviously calling LockConsole/UnlockConsole here is an awful, ugly hack,\r\n+    // since there's no guarantee that this is the same lock as the one the VT parser uses.\r\n+    // But the alternative is Denial-Of-Service of the render thread.\r\n+    //\r\n+    // Note that this causes raw throughput of DECSET 2026 to be comparatively low, but that's fine.\r\n+    // Apps that use DECSET 2026 don't produce that sequence continuously, but rather at a fixed rate.\r\n+    _pData->UnlockConsole();\r\n+    _pData->LockConsole();\r\n+}\r\n+\r\n+void Renderer::_synchronizeWithOutput() noexcept\r\n+{\r\n+    constexpr DWORD timeout = 100;\r\n+\r\n+    UINT64 start = 0;\r\n+    DWORD elapsed = 0;\r\n+    bool wrong = false;\r\n+\r\n+    QueryUnbiasedInterruptTime(&start);\r\n+\r\n+    // Wait for `_isSynchronizingOutput` to be set to false or for a timeout to occur.\r\n+    while (true)\r\n+    {\r\n+        // We can't call a blocking function while holding the console lock, so release it temporarily.\r\n+        _pData->UnlockConsole();\r\n+        const auto ok = WaitOnAddress(&_isSynchronizingOutput, &wrong, sizeof(_isSynchronizingOutput), timeout - elapsed);\r\n+        _pData->LockConsole();\r\n+\r\n+        if (!ok || !_isSynchronizingOutput)\r\n+        {\r\n+            break;\r\n+        }\r\n+\r\n+        UINT64 now;\r\n+        QueryUnbiasedInterruptTime(&now);\r\n+        elapsed = static_cast<DWORD>((now - start) / 10000);\r\n+        if (elapsed >= timeout)\r\n+        {\r\n+            break;\r\n+        }\r\n+    }\r\n+\r\n+    // If a timeout occurred, `_isSynchronizingOutput` may still be true.\r\n+    // Set it to false now to skip calling `_synchronizeWithOutput()` on the next frame.\r\n+    _isSynchronizingOutput = false;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Called when the system has requested we redraw a portion of the console.\r\n // Arguments:\r\ndiff --git a/src/renderer/base/renderer.hpp b/src/renderer/base/renderer.hpp\nindex d5f6be56d18..c8c30457604 100644\n--- a/src/renderer/base/renderer.hpp\n+++ b/src/renderer/base/renderer.hpp\n@@ -35,6 +35,8 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT PaintFrame();\r\n \r\n         void NotifyPaintFrame() noexcept;\r\n+        void SynchronizedOutputBegin() noexcept;\r\n+        void SynchronizedOutputEnd() noexcept;\r\n         void TriggerSystemRedraw(const til::rect* const prcDirtyClient);\r\n         void TriggerRedraw(const Microsoft::Console::Types::Viewport& region);\r\n         void TriggerRedraw(const til::point* const pcoord);\r\n@@ -91,6 +93,7 @@ namespace Microsoft::Console::Render\n \r\n         [[nodiscard]] HRESULT _PaintFrame() noexcept;\r\n         [[nodiscard]] HRESULT _PaintFrameForEngine(_In_ IRenderEngine* const pEngine) noexcept;\r\n+        void _synchronizeWithOutput() noexcept;\r\n         bool _CheckViewportAndScroll();\r\n         [[nodiscard]] HRESULT _PaintBackground(_In_ IRenderEngine* const pEngine);\r\n         void _PaintBufferOutput(_In_ IRenderEngine* const pEngine);\r\n@@ -124,6 +127,7 @@ namespace Microsoft::Console::Render\n         std::function<void()> _pfnBackgroundColorChanged;\r\n         std::function<void()> _pfnFrameColorChanged;\r\n         std::function<void()> _pfnRendererEnteredErrorState;\r\n+        bool _isSynchronizingOutput = false;\r\n         bool _forceUpdateViewport = false;\r\n \r\n         til::point_span _lastSelectionPaintSpan{};\r\ndiff --git a/src/renderer/base/thread.cpp b/src/renderer/base/thread.cpp\nindex 467bef73585..39b7ec60783 100644\n--- a/src/renderer/base/thread.cpp\n+++ b/src/renderer/base/thread.cpp\n@@ -34,7 +34,7 @@ DWORD WINAPI RenderThread::_ThreadProc()\n \r\n         // Between waiting on _hEvent and calling PaintFrame() there should be a minimal delay,\r\n         // so that a key press progresses to a drawing operation as quickly as possible.\r\n-        // As such, we wait for the renderer to complete _before_ waiting on _hEvent.\r\n+        // As such, we wait for the renderer to complete _before_ waiting on `_redraw`.\r\n         renderer->WaitUntilCanRender();\r\n \r\n         _redraw.wait();\r\n@@ -78,6 +78,8 @@ void RenderThread::EnablePainting() noexcept\n     }\r\n }\r\n \r\n+// This function is meant to only be called by `Renderer`. You should use `TriggerTeardown()` instead,\r\n+// even if you plan to call `EnablePainting()` later, because that ensures proper synchronization.\r\n void RenderThread::DisablePainting() noexcept\r\n {\r\n     _enable.ResetEvent();\r\ndiff --git a/src/terminal/adapter/DispatchTypes.hpp b/src/terminal/adapter/DispatchTypes.hpp\nindex f1adb1457c8..b99dd997dde 100644\n--- a/src/terminal/adapter/DispatchTypes.hpp\n+++ b/src/terminal/adapter/DispatchTypes.hpp\n@@ -544,6 +544,7 @@ namespace Microsoft::Console::VirtualTerminal::DispatchTypes\n         ALTERNATE_SCROLL = DECPrivateMode(1007),\r\n         ASB_AlternateScreenBuffer = DECPrivateMode(1049),\r\n         XTERM_BracketedPasteMode = DECPrivateMode(2004),\r\n+        SO_SynchronizedOutput = DECPrivateMode(2026),\r\n         GCM_GraphemeClusterMode = DECPrivateMode(2027),\r\n         W32IM_Win32InputMode = DECPrivateMode(9001),\r\n     };\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 9158b962ab3..c8f4c5eb85e 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1914,6 +1914,19 @@ void AdaptDispatch::_ModeParamsHelper(const DispatchTypes::ModeParams param, con\n     case DispatchTypes::ModeParams::XTERM_BracketedPasteMode:\n         _api.SetSystemMode(ITerminalApi::Mode::BracketedPaste, enable);\n         break;\n+    case DispatchTypes::ModeParams::SO_SynchronizedOutput:\n+        if (_renderer)\n+        {\n+            if (enable)\n+            {\n+                _renderer->SynchronizedOutputBegin();\n+            }\n+            else\n+            {\n+                _renderer->SynchronizedOutputEnd();\n+            }\n+        }\n+        break;\n     case DispatchTypes::ModeParams::GCM_GraphemeClusterMode:\n         break;\n     case DispatchTypes::ModeParams::W32IM_Win32InputMode:\n", "instance_id": "microsoft__terminal-18826", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the goal of implementing synchronized update control sequences to avoid half-drawn screens in a terminal emulator. It provides a reference to a specification (via a GitLab wiki link) and explains the purpose of the control sequence as a hint for atomic rendering. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected input and output formats for the control sequences, nor does it mention specific constraints or edge cases that might arise during implementation (e.g., what happens if the update sequence is interrupted or malformed). Additionally, the statement lacks examples of usage or expected behavior in different scenarios, which would help in fully understanding the requirements. Despite these gaps, the intent and high-level goal are clear, and the provided code changes offer context for the implementation, justifying a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" range (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files (`renderer.cpp`, `renderer.hpp`, `thread.cpp`, `DispatchTypes.hpp`, and `adaptDispatch.cpp`), indicating a need to understand and modify interactions across different components of the terminal emulator codebase, particularly the rendering and VT parsing logic. The changes are not trivial, as they introduce new synchronization mechanisms (e.g., `SynchronizedOutputBegin` and `SynchronizedOutputEnd`) and require handling threading and locking concerns to prevent performance issues like denial-of-service in the render thread, as noted in the code comments. \n\nSecond, the technical concepts involved are moderately complex, including multi-threading (e.g., `WaitOnAddress`, lock management), renderer synchronization, and integration with VT control sequences (e.g., DECSET 2026). Understanding and correctly implementing these concepts requires a solid grasp of C++ threading primitives, terminal emulator architecture, and the specific behavior of control sequences.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes reveal implicit handling of scenarios like timeouts (a 100ms timeout in `_synchronizeWithOutput`) and potential performance bottlenecks (e.g., preventing continuous DECSET 2026 spam from degrading renderer performance). These considerations add to the complexity of ensuring robust error handling and system stability.\n\nFinally, the impact on the system's architecture is moderate but significant, as the synchronization logic directly affects the rendering pipeline, a critical component of the terminal emulator. While not a complete overhaul, the changes require careful integration to avoid introducing bugs or performance regressions. Given these factors, a difficulty score of 0.65 is appropriate, reflecting a challenging task that demands a deep understanding of the codebase and careful handling of concurrency and rendering logic, but not reaching the extreme complexity of system-level or highly domain-specific problems.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In newTabMenu allow assignment/override of the icon property for the action items\n### Description of the new feature\n\nHi.\n\nOne small cosmetic suggestion. \n\nCurrently, I can define actions->command which I can then select as the action in newTabMenu.\nIf I would like to have an icon (or glyph) for that item displayed in the newTabMenu, icon needs to be defined at the level of actions->command. That will result in icon being visible in the command palette as well, which I'd like to avoid (I don't like it visually to have only one or a few items with the icon in a long list of commands).\n\nWould it be possible to have a possibility to define \"icon\" for newTabMenu action items (\"type\": \"action\"). That would allow assignment of desired icons/glyphs to desired commands only in newTabMenu and not in command palette.\n\nOther option would be to have a property on the actions->command item level that would allow for the icon not to be displayed in the command palette (e.g. iconVisibility to have one of the following values: \"newtabmenu\", \"commandpalette\", \"both\", \"none\").\n\nOne more thing that could work is to allow the whole custom command to be excluded from the command palette.\n\nThank you in advance!\n\n### Proposed technical implementation details\n\n_No response_\n", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex ec903dc5b80..9774c51844c 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -733,6 +733,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The name or GUID of the profile to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\n@@ -804,6 +807,9 @@\n               \"type\": \"string\",\n               \"default\": \"\",\n               \"description\": \"The ID of the action to show in this entry\"\n+            },\n+            \"icon\": {\n+              \"$ref\": \"#/$defs/Icon\"\n             }\n           }\n         }\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex b3111e9b639..99064fef8bb 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,7 +989,7 @@ namespace winrt::TerminalApp::implementation\n \n                 for (auto&& [profileIndex, remainingProfile] : remainingProfilesEntry.Profiles())\n                 {\n-                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex));\n+                    items.push_back(_CreateNewTabFlyoutProfile(remainingProfile, profileIndex, {}));\n                 }\n \n                 break;\n@@ -1003,7 +1003,7 @@ namespace winrt::TerminalApp::implementation\n                     break;\n                 }\n \n-                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex());\n+                auto profileItem = _CreateNewTabFlyoutProfile(profileEntry.Profile(), profileEntry.ProfileIndex(), profileEntry.Icon());\n                 items.push_back(profileItem);\n                 break;\n             }\n@@ -1013,7 +1013,7 @@ namespace winrt::TerminalApp::implementation\n                 const auto actionId = actionEntry.ActionId();\n                 if (_settings.ActionMap().GetActionByID(actionId))\n                 {\n-                    auto actionItem = _CreateNewTabFlyoutAction(actionId);\n+                    auto actionItem = _CreateNewTabFlyoutAction(actionId, actionEntry.Icon());\n                     items.push_back(actionItem);\n                 }\n \n@@ -1028,7 +1028,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given profile with the given index.\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutProfile(const Profile profile, int profileIndex, const winrt::hstring& iconPathOverride)\n     {\n         auto profileMenuItem = WUX::Controls::MenuFlyoutItem{};\n \n@@ -1049,9 +1049,10 @@ namespace winrt::TerminalApp::implementation\n         auto profileName = profile.Name();\n         profileMenuItem.Text(profileName);\n \n-        // If there's an icon set for this profile, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = profile.EvaluatedIcon();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this profile, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? profile.EvaluatedIcon() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\n@@ -1112,7 +1113,7 @@ namespace winrt::TerminalApp::implementation\n     // Method Description:\n     // - This method creates a flyout menu item for a given action\n     //   It makes sure to set the correct icon, keybinding, and click-action.\n-    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId)\n+    WUX::Controls::MenuFlyoutItem TerminalPage::_CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride)\n     {\n         auto actionMenuItem = WUX::Controls::MenuFlyoutItem{};\n         const auto action{ _settings.ActionMap().GetActionByID(actionId) };\n@@ -1125,9 +1126,10 @@ namespace winrt::TerminalApp::implementation\n \n         actionMenuItem.Text(action.Name());\n \n-        // If there's an icon set for this action, set it as the icon for\n-        // this flyout item\n-        const auto& iconPath = action.IconPath();\n+        // If a custom icon path has been specified, set it as the icon for\n+        // this flyout item. Otherwise, if an icon is set for this action, set that icon\n+        // for this flyout item.\n+        const auto& iconPath = iconPathOverride.empty() ? action.IconPath() : iconPathOverride;\n         if (!iconPath.empty())\n         {\n             const auto icon = _CreateNewTabFlyoutIcon(iconPath);\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 9e5d3029c7f..30627d5b7ee 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -316,8 +316,8 @@ namespace winrt::TerminalApp::implementation\n         void _CreateNewTabFlyout();\n         std::vector<winrt::Windows::UI::Xaml::Controls::MenuFlyoutItemBase> _CreateNewTabFlyoutItems(winrt::Windows::Foundation::Collections::IVector<Microsoft::Terminal::Settings::Model::NewTabMenuEntry> entries);\n         winrt::Windows::UI::Xaml::Controls::IconElement _CreateNewTabFlyoutIcon(const winrt::hstring& icon);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex);\n-        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutProfile(const Microsoft::Terminal::Settings::Model::Profile profile, int profileIndex, const winrt::hstring& iconPathOverride);\n+        winrt::Windows::UI::Xaml::Controls::MenuFlyoutItem _CreateNewTabFlyoutAction(const winrt::hstring& actionId, const winrt::hstring& iconPathOverride);\n \n         void _OpenNewTabDropdown();\n         HRESULT _OpenNewTab(const Microsoft::Terminal::Settings::Model::INewContentArgs& newContentArgs);\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\nindex b48207e74e9..6f7773e715c 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ActionIdKey{ \"id\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ActionEntry::ActionEntry() noexcept :\r\n     ActionEntryT<ActionEntry, NewTabMenuEntry>(NewTabMenuEntryType::Action)\r\n@@ -22,6 +23,7 @@ Json::Value ActionEntry::ToJson() const\n     auto json = NewTabMenuEntry::ToJson();\r\n \r\n     JsonUtils::SetValueForKey(json, ActionIdKey, _ActionId);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     return json;\r\n }\r\n@@ -31,6 +33,7 @@ winrt::com_ptr<NewTabMenuEntry> ActionEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ActionEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ActionIdKey, entry->_ActionId);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionEntry.h b/src/cascadia/TerminalSettingsModel/ActionEntry.h\nindex 9c89077828c..711cec13bfc 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ActionEntry.h\n@@ -28,6 +28,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         static com_ptr<NewTabMenuEntry> FromJson(const Json::Value& json);\r\n \r\n         WINRT_PROPERTY(winrt::hstring, ActionId);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n     };\r\n }\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\nindex 84bc3777695..acf1f33f6f4 100644\n--- a/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n+++ b/src/cascadia/TerminalSettingsModel/NewTabMenuEntry.idl\n@@ -33,6 +33,7 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         Profile Profile;\r\n         Int32 ProfileIndex;\r\n+        String Icon;\r\n     }\r\n \r\n     [default_interface] runtimeclass ActionEntry : NewTabMenuEntry\r\n@@ -40,6 +41,7 @@ namespace Microsoft.Terminal.Settings.Model\n         ActionEntry();\r\n \r\n         String ActionId;\r\n+        String Icon;\r\n     }\r\n \r\n     enum FolderEntryInlining\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\nindex c857eea8678..5f01a293beb 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.cpp\n@@ -11,6 +11,7 @@ using namespace Microsoft::Terminal::Settings::Model;\n using namespace winrt::Microsoft::Terminal::Settings::Model::implementation;\r\n \r\n static constexpr std::string_view ProfileKey{ \"profile\" };\r\n+static constexpr std::string_view IconKey{ \"icon\" };\r\n \r\n ProfileEntry::ProfileEntry() noexcept :\r\n     ProfileEntry{ winrt::hstring{} }\r\n@@ -46,6 +47,8 @@ Json::Value ProfileEntry::ToJson() const\n         JsonUtils::SetValueForKey(json, ProfileKey, _Profile.Guid());\r\n     }\r\n \r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n+\r\n     return json;\r\n }\r\n \r\n@@ -54,6 +57,7 @@ winrt::com_ptr<NewTabMenuEntry> ProfileEntry::FromJson(const Json::Value& json)\n     auto entry = winrt::make_self<ProfileEntry>();\r\n \r\n     JsonUtils::GetValueForKey(json, ProfileKey, entry->_ProfileName);\r\n+    JsonUtils::GetValueForKey(json, IconKey, entry->_Icon);\r\n \r\n     return entry;\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ProfileEntry.h b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\nindex fe0f4573d29..9ea78497f1f 100644\n--- a/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n+++ b/src/cascadia/TerminalSettingsModel/ProfileEntry.h\n@@ -41,6 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n \r\n         WINRT_PROPERTY(Model::Profile, Profile);\r\n         WINRT_PROPERTY(int, ProfileIndex);\r\n+        WINRT_PROPERTY(winrt::hstring, Icon);\r\n \r\n     private:\r\n         winrt::hstring _ProfileName;\r\n", "instance_id": "microsoft__terminal-18116", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the desired feature: allowing the assignment or override of icons for action items in the `newTabMenu` without affecting their visibility in the command palette. The goal is well-defined, and the user provides multiple potential solutions (e.g., defining icons at the `newTabMenu` level, controlling icon visibility, or excluding commands from the command palette). However, there are minor ambiguities and missing details. For instance, the statement does not explicitly address how the icon override should behave if no custom icon is provided (though the code changes imply a fallback to the default icon). Additionally, there are no examples of input configurations or expected output UI changes, which could help clarify the exact behavior. Edge cases, such as invalid icon paths or conflicts between icon settings, are not mentioned. Despite these minor gaps, the intent and scope of the feature are understandable, especially when paired with the provided code changes.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The changes are relatively localized, affecting a few specific files (`profiles.schema.json`, `TerminalPage.cpp`, `TerminalPage.h`, `ActionEntry.cpp`, `ActionEntry.h`, `ProfileEntry.cpp`, `ProfileEntry.h`, and related IDL files). The modifications involve adding a new `icon` property to the schema and updating the logic in `TerminalPage.cpp` to handle icon overrides for menu items. The changes do not impact the broader system architecture and are mostly additive, requiring updates to data structures and UI rendering logic. The amount of code change is moderate, with clear diffs provided.\n\n2. **Number of Technical Concepts**: Solving this requires understanding C++ (specifically in the context of WinRT and XAML for UI components), JSON schema definitions, and the internal data models of the application (e.g., `ProfileEntry`, `ActionEntry`). The concepts involved are not overly complex for a developer familiar with the codebase—primarily, it involves extending existing structures with a new field and updating rendering logic to prioritize an override value. No advanced algorithms, design patterns, or domain-specific knowledge beyond terminal UI customization are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes handle a basic fallback mechanism (using the default icon if no override is provided). Potential edge cases, such as invalid icon paths or missing icon data, are not addressed in the problem statement or code changes, but they do not appear to significantly increase complexity at this stage. Error handling requirements seem minimal based on the provided diffs.\n\n4. **Overall Complexity**: The task requires understanding the interaction between configuration schemas and UI rendering logic, but it does not involve deep architectural changes or complex debugging. It is a straightforward feature addition that builds on existing patterns in the codebase (e.g., icon rendering for profiles and actions). The primary challenge might be ensuring consistency across different menu entry types, but this is manageable with the provided changes.\n\nGiven these considerations, a score of 0.35 reflects an \"Easy\" task that requires moderate understanding of the codebase and simple modifications across a few files, with minimal complexity in edge case handling or architectural impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Add support for the S8C1T/S7C1T escape sequences\n# Description of the new feature/enhancement\r\n\r\nThe `S8C1T` and `S7C1T` commands enable an application to choose whether the terminal should use C1 controls when sending key sequences and query responses. For example, instead of encoding a `CSI` prefix as `ESC` `[`, the terminal would use a single `CSI` codepoint (i.e. `U+009B`).\r\n\r\nBack in the days of the 8-bit hardware terminals, this had the advantage of being slightly more efficient (your sequence introducers would take 1 byte rather than 2). And another bonus was that it made it easy to distinguish an <kbd>Esc</kbd> key (assuming your keyboard had one) from other key sequences that merely started with the `ESC` character.\r\n\r\nHowever, these days you're more likely to be using a UTF-8 encoding, in which case a C1 control character is still going to occupy two bytes, so there is no advantage in terms of sequence length. And the ability to distinguish an <kbd>Esc</kbd> key from other key sequences is somewhat diminished by the modern usage of `ESC` as a prefix for <kbd>Alt</kbd> key combinations.\r\n\r\nIn short, there's probably not much demand for this functionality outside of people wanting to connect to legacy systems, but it would be nice to have just for completeness sake (it's a requirement for VT level 2 conformance).\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nSome of the framework for the key sequence encoding was already added in PR #16511, so that just needs to be hooked up to a new input mode which can be toggled by the `S8C1T` and `S7C1T` escape sequences. We need to do something similar in `AdaptDispatch` for all the query responses, but that's also fairly straightforward.\r\n\r\nHowever, if we want to support 8-bit C1 sequences, as used in legacy systems, we also need a way to switch the input code page from UTF-8 to something that can cleanly pass through 8-bit bytes (like ISO-8859-1). Fortunately we already have a `DOCS` escape sequence which sets the *output* code page to ISO-8859-1, and I think it's reasonable to extend that to set the input code page at the same time.\r\n\r\nThe catch is that this won't work in a WSL shell, because WSL doesn't pay any attention to the input code page. And while it is potentially usable from a Windows shell, the typical use case will involve connecting to a remote system, which means you're going to ned a ssh or telnet client that is 8-bit capable (and I think that rules out the Windows inbox clients).\r\n\r\nThe bottom line is there are a few hoops you need to jump through to get this to work. Given these limitations, is it still worth adding?\n", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..94d2a938a81 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -140,8 +140,10 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetWindowTitle(const std::wstring_view title) override;\r\n     CursorType GetUserDefaultCursorStyle() const noexcept override;\r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n-    void SetConsoleOutputCP(const unsigned int codepage) noexcept override;\r\n-    unsigned int GetConsoleOutputCP() const noexcept override;\r\n+    void SetCodePage(const unsigned int codepage) noexcept override;\r\n+    void ResetCodePage() noexcept override;\r\n+    unsigned int GetOutputCodePage() const noexcept override;\r\n+    unsigned int GetInputCodePage() const noexcept override;\r\n     void CopyToClipboard(wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\n     void SetWorkingDirectory(std::wstring_view uri) override;\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 40ff599e115..e6edec3ee92 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -116,14 +116,25 @@ bool Terminal::ResizeWindow(const til::CoordType width, const til::CoordType hei\n     return false;\r\n }\r\n \r\n-void Terminal::SetConsoleOutputCP(const unsigned int /*codepage*/) noexcept\r\n+void Terminal::SetCodePage(const unsigned int /*codepage*/) noexcept\r\n {\r\n-    // TODO: This will be needed to support 8-bit charsets and DOCS sequences.\r\n+    // Code pages are dealt with in ConHost, so this isn't needed.\r\n }\r\n \r\n-unsigned int Terminal::GetConsoleOutputCP() const noexcept\r\n+void Terminal::ResetCodePage() noexcept\r\n {\r\n-    // TODO: See SetConsoleOutputCP above.\r\n+    // There is nothing to reset, since the code page never changes.\r\n+}\r\n+\r\n+unsigned int Terminal::GetOutputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n+    return CP_UTF8;\r\n+}\r\n+\r\n+unsigned int Terminal::GetInputCodePage() const noexcept\r\n+{\r\n+    // See above. The code page is always UTF-8.\r\n     return CP_UTF8;\r\n }\r\n \r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex f199362f7af..b8109bca718 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -1140,7 +1140,6 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n     {\r\n         // Set new code page\r\n         gci.OutputCP = codepage;\r\n-\r\n         SetConsoleCPInfo(TRUE);\r\n     }\r\n \r\n@@ -1157,13 +1156,36 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n {\r\n     try\r\n     {\r\n+        auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-        return DoSrvSetConsoleOutputCodePage(codepage);\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultOutputCP = codepage;\r\n+        return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\n }\r\n \r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage)\r\n+{\r\n+    auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+\r\n+    // Return if it's not known as a valid codepage ID.\r\n+    RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n+\r\n+    // Do nothing if no change.\r\n+    if (gci.CP != codepage)\r\n+    {\r\n+        // Set new code page\r\n+        gci.CP = codepage;\r\n+        SetConsoleCPInfo(FALSE);\r\n+    }\r\n+\r\n+    return S_OK;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Sets the codepage used for translating text when calling A versions of functions affecting the input buffer.\r\n // Arguments:\r\n@@ -1177,19 +1199,10 @@ void ApiRoutines::GetLargestConsoleWindowSizeImpl(const SCREEN_INFORMATION& cont\n         auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n         LockConsole();\r\n         auto Unlock = wil::scope_exit([&] { UnlockConsole(); });\r\n-\r\n-        // Return if it's not known as a valid codepage ID.\r\n-        RETURN_HR_IF(E_INVALIDARG, !(IsValidCodePage(codepage)));\r\n-\r\n-        // Do nothing if no change.\r\n-        if (gci.CP != codepage)\r\n-        {\r\n-            // Set new code page\r\n-            gci.CP = codepage;\r\n-\r\n-            SetConsoleCPInfo(FALSE);\r\n-        }\r\n-\r\n+        RETURN_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n+        // Setting the code page via the API also updates the default value.\r\n+        // This is how the initial code page is set to UTF-8 in a WSL shell.\r\n+        gci.DefaultCP = codepage;\r\n         return S_OK;\r\n     }\r\n     CATCH_RETURN();\r\ndiff --git a/src/host/getset.h b/src/host/getset.h\nindex 4c042813c27..f3030eb6050 100644\n--- a/src/host/getset.h\n+++ b/src/host/getset.h\n@@ -19,3 +19,4 @@ Revision History:\n class SCREEN_INFORMATION;\r\n \r\n [[nodiscard]] HRESULT DoSrvSetConsoleOutputCodePage(const unsigned int codepage);\r\n+[[nodiscard]] HRESULT DoSrvSetConsoleInputCodePage(const unsigned int codepage);\r\ndiff --git a/src/host/output.cpp b/src/host/output.cpp\nindex e57412f5310..729821c841a 100644\n--- a/src/host/output.cpp\n+++ b/src/host/output.cpp\n@@ -35,6 +35,8 @@ using namespace Microsoft::Console::Interactivity;\n     // codepage by console.cpl or shell32. The default codepage is OEMCP.\r\n     gci.CP = gci.GetCodePage();\r\n     gci.OutputCP = gci.GetCodePage();\r\n+    gci.DefaultCP = gci.GetCodePage();\r\n+    gci.DefaultOutputCP = gci.GetCodePage();\r\n \r\n     gci.Flags |= CONSOLE_USE_PRIVATE_FLAGS;\r\n \r\ndiff --git a/src/host/outputStream.cpp b/src/host/outputStream.cpp\nindex d88be99ef33..3fbeb3cafaf 100644\n--- a/src/host/outputStream.cpp\n+++ b/src/host/outputStream.cpp\n@@ -221,27 +221,52 @@ void ConhostInternalGetSet::ShowWindow(bool showOrHide)\n }\r\n \r\n // Routine Description:\r\n-// - Connects the SetConsoleOutputCP API call directly into our Driver Message servicing call inside Conhost.exe\r\n+// - Set the code page used for translating text when calling A versions of I/O functions.\r\n // Arguments:\r\n-// - codepage - the new output codepage of the console.\r\n+// - codepage - the new code page of the console.\r\n // Return Value:\r\n // - <none>\r\n-void ConhostInternalGetSet::SetConsoleOutputCP(const unsigned int codepage)\r\n+void ConhostInternalGetSet::SetCodePage(const unsigned int codepage)\r\n {\r\n-    THROW_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(codepage));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(codepage));\r\n }\r\n \r\n // Routine Description:\r\n-// - Gets the codepage used for translating text when calling A versions of functions affecting the output buffer.\r\n+// - Reset the code pages to their default values.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n-// - the outputCP of the console.\r\n-unsigned int ConhostInternalGetSet::GetConsoleOutputCP() const\r\n+// - <none>\r\n+void ConhostInternalGetSet::ResetCodePage()\r\n+{\r\n+    const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+    LOG_IF_FAILED(DoSrvSetConsoleOutputCodePage(gci.DefaultOutputCP));\r\n+    LOG_IF_FAILED(DoSrvSetConsoleInputCodePage(gci.DefaultCP));\r\n+}\r\n+\r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of output functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the output code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetOutputCodePage() const\r\n {\r\n     return ServiceLocator::LocateGlobals().getConsoleInformation().OutputCP;\r\n }\r\n \r\n+// Routine Description:\r\n+// - Gets the code page used for translating text when calling A versions of input functions.\r\n+// Arguments:\r\n+// - <none>\r\n+// Return Value:\r\n+// - the input code page of the console.\r\n+unsigned int ConhostInternalGetSet::GetInputCodePage() const\r\n+{\r\n+    return ServiceLocator::LocateGlobals().getConsoleInformation().CP;\r\n+}\r\n+\r\n // Routine Description:\r\n // - Copies the given content to the clipboard.\r\n // Arguments:\r\ndiff --git a/src/host/outputStream.hpp b/src/host/outputStream.hpp\nindex 6b564abbf8d..7b76e5f3d0a 100644\n--- a/src/host/outputStream.hpp\n+++ b/src/host/outputStream.hpp\n@@ -53,8 +53,10 @@ class ConhostInternalGetSet final : public Microsoft::Console::VirtualTerminal::\n \r\n     bool ResizeWindow(const til::CoordType width, const til::CoordType height) override;\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override;\r\n-    unsigned int GetConsoleOutputCP() const override;\r\n+    void SetCodePage(const unsigned int codepage) override;\r\n+    void ResetCodePage() override;\r\n+    unsigned int GetOutputCodePage() const override;\r\n+    unsigned int GetInputCodePage() const override;\r\n \r\n     void CopyToClipboard(const wil::zwstring_view content) override;\r\n     void SetTaskbarProgress(const ::Microsoft::Console::VirtualTerminal::DispatchTypes::TaskbarState state, const size_t progress) override;\r\ndiff --git a/src/host/server.h b/src/host/server.h\nindex 1e14a94b731..0a0f905777b 100644\n--- a/src/host/server.h\n+++ b/src/host/server.h\n@@ -90,6 +90,9 @@ class CONSOLE_INFORMATION :\n     // the following fields are used for ansi-unicode translation\r\n     UINT CP = 0;\r\n     UINT OutputCP = 0;\r\n+    // the VT RIS sequence uses these default values to reset the code pages\r\n+    UINT DefaultCP = 0;\r\n+    UINT DefaultOutputCP = 0;\r\n \r\n     ULONG CtrlFlags = 0; // indicates outstanding ctrl requests\r\n     ULONG LimitingProcessId = 0;\r\ndiff --git a/src/terminal/adapter/ITermDispatch.hpp b/src/terminal/adapter/ITermDispatch.hpp\nindex 3df5ef30178..8ec9e33bdc0 100644\n--- a/src/terminal/adapter/ITermDispatch.hpp\n+++ b/src/terminal/adapter/ITermDispatch.hpp\n@@ -122,6 +122,7 @@ class Microsoft::Console::VirtualTerminal::ITermDispatch\n     virtual void LockingShiftRight(const VTInt gsetNumber) = 0; // LS1R, LS2R, LS3R\r\n     virtual void SingleShift(const VTInt gsetNumber) = 0; // SS2, SS3\r\n     virtual void AcceptC1Controls(const bool enabled) = 0; // DECAC1\r\n+    virtual void SendC1Controls(const bool enabled) = 0; // S8C1T, S7C1T\r\n     virtual void AnnounceCodeStructure(const VTInt ansiLevel) = 0; // ACS\r\n \r\n     virtual void SoftReset() = 0; // DECSTR\r\ndiff --git a/src/terminal/adapter/ITerminalApi.hpp b/src/terminal/adapter/ITerminalApi.hpp\nindex b874bfb8cd4..532133f9a84 100644\n--- a/src/terminal/adapter/ITerminalApi.hpp\n+++ b/src/terminal/adapter/ITerminalApi.hpp\n@@ -72,8 +72,10 @@ namespace Microsoft::Console::VirtualTerminal\n \r\n         virtual void ShowWindow(bool showOrHide) = 0;\r\n \r\n-        virtual void SetConsoleOutputCP(const unsigned int codepage) = 0;\r\n-        virtual unsigned int GetConsoleOutputCP() const = 0;\r\n+        virtual void SetCodePage(const unsigned int codepage) = 0;\r\n+        virtual void ResetCodePage() = 0;\r\n+        virtual unsigned int GetOutputCodePage() const = 0;\r\n+        virtual unsigned int GetInputCodePage() const = 0;\r\n \r\n         virtual void CopyToClipboard(const wil::zwstring_view content) = 0;\r\n         virtual void SetTaskbarProgress(const DispatchTypes::TaskbarState state, const size_t progress) = 0;\r\ndiff --git a/src/terminal/adapter/InteractDispatch.cpp b/src/terminal/adapter/InteractDispatch.cpp\nindex fa1a0826047..a8fc483aee6 100644\n--- a/src/terminal/adapter/InteractDispatch.cpp\n+++ b/src/terminal/adapter/InteractDispatch.cpp\n@@ -62,7 +62,7 @@ void InteractDispatch::WriteString(const std::wstring_view string)\n {\r\n     if (!string.empty())\r\n     {\r\n-        const auto codepage = _api.GetConsoleOutputCP();\r\n+        const auto codepage = _api.GetOutputCodePage();\r\n         InputEventQueue keyEvents;\r\n \r\n         for (const auto& wch : string)\r\ndiff --git a/src/terminal/adapter/adaptDispatch.cpp b/src/terminal/adapter/adaptDispatch.cpp\nindex 3899c7cd84d..9ee93ede8b8 100644\n--- a/src/terminal/adapter/adaptDispatch.cpp\n+++ b/src/terminal/adapter/adaptDispatch.cpp\n@@ -1243,7 +1243,7 @@ void AdaptDispatch::FillRectangularArea(const VTParameter ch, const VTInt top, c\n     const auto charValue = ch.value_or(0) == 0 ? 32 : ch.value();\n     const auto glChar = (charValue >= 32 && charValue <= 126);\n     const auto grChar = (charValue >= 160 && charValue <= 255);\n-    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetConsoleOutputCP() == CP_UTF8);\n+    const auto unicodeChar = (charValue >= 256 && charValue <= 65535 && _api.GetOutputCodePage() == CP_UTF8);\n     if (glChar || grChar || unicodeChar)\n     {\n         const auto fillChar = _termOutput.TranslateKey(gsl::narrow_cast<wchar_t>(charValue));\n@@ -1377,8 +1377,7 @@ void AdaptDispatch::RequestChecksumRectangularArea(const VTInt id, const VTInt p\n             }\n         }\n     }\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", id, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", id, checksum));\n }\n \n // Routine Description:\n@@ -1484,7 +1483,7 @@ void AdaptDispatch::DeviceAttributes()\n     // 32 = Text macros\n     // 42 = ISO Latin-2 character set\n \n-    _api.ReturnResponse(L\"\\x1b[?61;4;6;7;14;21;22;23;24;28;32;42c\");\n+    _ReturnCsiResponse(L\"?61;4;6;7;14;21;22;23;24;28;32;42c\");\n }\n \n // Routine Description:\n@@ -1496,7 +1495,7 @@ void AdaptDispatch::DeviceAttributes()\n // - <none>\n void AdaptDispatch::SecondaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1b[>0;10;1c\");\n+    _ReturnCsiResponse(L\">0;10;1c\");\n }\n \n // Routine Description:\n@@ -1506,7 +1505,7 @@ void AdaptDispatch::SecondaryDeviceAttributes()\n // - <none>\n void AdaptDispatch::TertiaryDeviceAttributes()\n {\n-    _api.ReturnResponse(L\"\\x1bP!|00000000\\x1b\\\\\");\n+    _ReturnDcsResponse(L\"!|00000000\");\n }\n \n // Routine Description:\n@@ -1544,10 +1543,10 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n     switch (permission)\n     {\n     case DispatchTypes::ReportingPermission::Unsolicited:\n-        _api.ReturnResponse(L\"\\x1b[2;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"2;1;1;128;128;1;0x\");\n         break;\n     case DispatchTypes::ReportingPermission::Solicited:\n-        _api.ReturnResponse(L\"\\x1b[3;1;1;128;128;1;0x\");\n+        _ReturnCsiResponse(L\"3;1;1;128;128;1;0x\");\n         break;\n     default:\n         break;\n@@ -1562,7 +1561,7 @@ void AdaptDispatch::RequestTerminalParameters(const DispatchTypes::ReportingPerm\n // - <none>\n void AdaptDispatch::_DeviceStatusReport(const wchar_t* parameters) const\n {\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{}n\"), parameters));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}n\"), parameters));\n }\n \n // Routine Description:\n@@ -1598,14 +1597,12 @@ void AdaptDispatch::_CursorPositionReport(const bool extendedReport)\n     {\n         // An extended report also includes the page number.\n         const auto pageNumber = page.Number();\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"?%d;%d;%dR\", cursorPosition.y, cursorPosition.x, pageNumber));\n     }\n     else\n     {\n         // The standard report only returns the cursor position.\n-        const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%d;%dR\", cursorPosition.y, cursorPosition.x);\n-        _api.ReturnResponse(response);\n+        _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%d;%dR\", cursorPosition.y, cursorPosition.x));\n     }\n }\n \n@@ -1619,8 +1616,7 @@ void AdaptDispatch::_MacroSpaceReport() const\n {\n     const auto spaceInBytes = _macroBuffer ? _macroBuffer->GetSpaceAvailable() : MacroBuffer::MAX_SPACE;\n     // The available space is measured in blocks of 16 bytes, so we need to divide by 16.\n-    const auto response = wil::str_printf<std::wstring>(L\"\\x1b[%zu*{\", spaceInBytes / 16);\n-    _api.ReturnResponse(response);\n+    _ReturnCsiResponse(wil::str_printf<std::wstring>(L\"%zu*{\", spaceInBytes / 16));\n }\n \n // Routine Description:\n@@ -1633,8 +1629,7 @@ void AdaptDispatch::_MacroChecksumReport(const VTParameter id) const\n {\n     const auto requestId = id.value_or(0);\n     const auto checksum = _macroBuffer ? _macroBuffer->CalculateChecksum() : 0;\n-    const auto response = wil::str_printf<std::wstring>(L\"\\033P%d!~%04X\\033\\\\\", requestId, checksum);\n-    _api.ReturnResponse(response);\n+    _ReturnDcsResponse(wil::str_printf<std::wstring>(L\"%d!~%04X\", requestId, checksum));\n }\n \n // Routine Description:\n@@ -1732,7 +1727,7 @@ void AdaptDispatch::RequestDisplayedExtent()\n     const auto height = page.Viewport().height();\n     const auto left = page.XPanOffset() + 1;\n     const auto top = page.YPanOffset() + 1;\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{};{};{}\\\"w\"), height, width, left, top, page.Number()));\n }\n \n // Routine Description:\n@@ -2068,7 +2063,7 @@ void AdaptDispatch::RequestMode(const DispatchTypes::ModeParams param)\n         prefix = L\"?\";\n     }\n \n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\x1b[{}{};{}$y\"), prefix, mode, state));\n+    _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{}{};{}$y\"), prefix, mode, state));\n }\n \n // - DECKPAM, DECKPNM - Sets the keypad input mode to either Application mode or Numeric mode (true, false respectively)\n@@ -2785,22 +2780,15 @@ void AdaptDispatch::_InitTabStopsForWidth(const VTInt width)\n // - codingSystem - The coding system that will be selected.\n void AdaptDispatch::DesignateCodingSystem(const VTID codingSystem)\n {\n-    // If we haven't previously saved the initial code page, do so now.\n-    // This will be used to restore the code page in response to a reset.\n-    if (!_initialCodePage.has_value())\n-    {\n-        _initialCodePage = _api.GetConsoleOutputCP();\n-    }\n-\n     switch (codingSystem)\n     {\n     case DispatchTypes::CodingSystem::ISO2022:\n-        _api.SetConsoleOutputCP(28591);\n+        _api.SetCodePage(28591);\n         AcceptC1Controls(true);\n         _termOutput.EnableGrTranslation(true);\n         break;\n     case DispatchTypes::CodingSystem::UTF8:\n-        _api.SetConsoleOutputCP(CP_UTF8);\n+        _api.SetCodePage(CP_UTF8);\n         AcceptC1Controls(false);\n         _termOutput.EnableGrTranslation(false);\n         break;\n@@ -2871,6 +2859,24 @@ void AdaptDispatch::AcceptC1Controls(const bool enabled)\n     _api.GetStateMachine().SetParserMode(StateMachine::Mode::AcceptC1, enabled);\n }\n \n+//Routine Description:\n+// S8C1T/S7C1T - Enable or disable the sending of C1 controls in key sequences\n+//   and query responses. When this is enabled, C1 controls are sent as a single\n+//   codepoint. When disabled, they're sent as a two character escape sequence.\n+//Arguments:\n+// - enabled - true to send C1 controls, false to send escape sequences.\n+void AdaptDispatch::SendC1Controls(const bool enabled)\n+{\n+    // If this is an attempt to enable C1 controls, the input code page must be\n+    // one of the DOCS choices (UTF-8 or ISO-8859-1), otherwise there's a risk\n+    // that those controls won't have a valid encoding.\n+    const auto codepage = _api.GetInputCodePage();\n+    if (enabled == false || codepage == CP_UTF8 || codepage == 28591)\n+    {\n+        _terminalInput.SetInputMode(TerminalInput::Mode::SendC1, enabled);\n+    }\n+}\n+\n //Routine Description:\n // ACS - Announces the ANSI conformance level for subsequent data exchange.\n //  This requires certain character sets to be mapped into the terminal's\n@@ -3003,13 +3009,11 @@ void AdaptDispatch::HardReset()\n \n     // Completely reset the TerminalOutput state.\n     _termOutput = {};\n-    if (_initialCodePage.has_value())\n-    {\n-        // Restore initial code page if previously changed by a DOCS sequence.\n-        _api.SetConsoleOutputCP(_initialCodePage.value());\n-    }\n-    // Disable parsing of C1 control codes.\n+    // Reset the code page to the default value.\n+    _api.ResetCodePage();\n+    // Disable parsing and sending of C1 control codes.\n     AcceptC1Controls(false);\n+    SendC1Controls(false);\n \n     // Sets the SGR state to normal - this must be done before EraseInDisplay\n     //      to ensure that it clears with the default background color.\n@@ -3276,7 +3280,7 @@ void AdaptDispatch::RequestColorTableEntry(const size_t tableIndex)\n     {\n         const til::color c{ color };\n         // Scale values up to match xterm's 16-bit color report format.\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]4;{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+        _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"4;{};rgb:{:04x}/{:04x}/{:04x}\"), tableIndex, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n     }\n }\n \n@@ -3321,7 +3325,7 @@ void AdaptDispatch::RequestXtermColorResource(const size_t resource)\n         {\n             const til::color c{ color };\n             // Scale values up to match xterm's 16-bit color report format.\n-            _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033]{};rgb:{:04x}/{:04x}/{:04x}\\033\\\\\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n+            _ReturnOscResponse(fmt::format(FMT_COMPILE(L\"{};rgb:{:04x}/{:04x}/{:04x}\"), resource, c.r * 0x0101, c.g * 0x0101, c.b * 0x0101));\n         }\n     }\n }\n@@ -3377,7 +3381,7 @@ void AdaptDispatch::WindowManipulation(const DispatchTypes::WindowManipulationTy\n \n     const auto reportSize = [&](const auto size) {\n         const auto reportType = function - 10;\n-        _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033[{};{};{}t\"), reportType, size.height, size.width));\n+        _ReturnCsiResponse(fmt::format(FMT_COMPILE(L\"{};{};{}t\"), reportType, size.height, size.width));\n     };\n \n     switch (function)\n@@ -3844,7 +3848,7 @@ void AdaptDispatch::RequestUserPreferenceCharset()\n {\n     const auto size = _termOutput.GetUserPreferenceCharsetSize();\n     const auto id = _termOutput.GetUserPreferenceCharsetId();\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P{}!u{}\\033\\\\\"), (size == 96 ? 1 : 0), id));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"{}!u{}\"), (size == 96 ? 1 : 0), id));\n }\n \n // Method Description:\n@@ -3976,9 +3980,9 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ s.\n+    // A valid response always starts with 2 $ s.\n     fmt::basic_memory_buffer<wchar_t, TextColor::TABLE_SIZE * 18> response;\n-    response.append(L\"\\033P2$s\"sv);\n+    response.append(L\"2$s\"sv);\n \n     const auto modelNumber = static_cast<int>(colorModel);\n     for (size_t colorNumber = 0; colorNumber < TextColor::TABLE_SIZE; colorNumber++)\n@@ -4003,9 +4007,7 @@ void AdaptDispatch::_ReportColorTable(const DispatchTypes::ColorModel colorModel\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4108,7 +4110,7 @@ ITermDispatch::StringHandler AdaptDispatch::RequestSetting()\n                 _ReportDECACSetting(VTParameter{ parameter });\n                 break;\n             default:\n-                _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+                _ReturnDcsResponse(L\"0$r\");\n                 break;\n             }\n             return false;\n@@ -4147,10 +4149,10 @@ void AdaptDispatch::_ReportSGRSetting() const\n {\n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 1 $ r.\n+    // A valid response always starts with 1 $ r.\n     // Then the '0' parameter is to reset the SGR attributes to the defaults.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P1$r0\"sv);\n+    response.append(L\"1$r0\"sv);\n \n     const auto& attr = _pages.ActivePage().Attributes();\n     const auto ulStyle = attr.GetUnderlineStyle();\n@@ -4202,9 +4204,9 @@ void AdaptDispatch::_ReportSGRSetting() const\n     addColor(40, attr.GetBackground());\n     addColor(50, attr.GetUnderlineColor());\n \n-    // The 'm' indicates this is an SGR response, and ST ends the sequence.\n-    response.append(L\"m\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    // The 'm' indicates this is an SGR response.\n+    response.append(L\"m\"sv);\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4217,10 +4219,9 @@ void AdaptDispatch::_ReportDECSTBMSetting()\n {\n     const auto page = _pages.ActivePage();\n     const auto [marginTop, marginBottom] = _GetVerticalMargins(page, false);\n-    // A valid response always starts with DCS 1 $ r, the 'r' indicates this\n-    // is a DECSTBM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the final 'r' indicates this is a DECSTBM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}r\\033\\\\\"), marginTop + 1, marginBottom + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}r\"), marginTop + 1, marginBottom + 1));\n }\n \n // Method Description:\n@@ -4233,10 +4234,9 @@ void AdaptDispatch::_ReportDECSLRMSetting()\n {\n     const auto pageWidth = _pages.ActivePage().Width();\n     const auto [marginLeft, marginRight] = _GetHorizontalMargins(pageWidth);\n-    // A valid response always starts with DCS 1 $ r, the 's' indicates this\n-    // is a DECSLRM response, and ST ends the sequence.\n+    // A valid response always starts with 1 $ r and the 's' indicates this is a DECSLRM response.\n     // VT origin is at 1,1 so we need to add 1 to these margins.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{}s\\033\\\\\"), marginLeft + 1, marginRight + 1));\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{}s\"), marginLeft + 1, marginRight + 1));\n }\n \n // Method Description:\n@@ -4249,26 +4249,26 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n {\n     const auto& cursor = _pages.ActivePage().Cursor();\n     const auto blinking = cursor.IsBlinkingAllowed();\n-    // A valid response always starts with DCS 1 $ r. This is followed by a\n+    // A valid response always starts with 1 $ r. This is followed by a\n     // number from 1 to 6 representing the cursor style. The ' q' indicates\n-    // this is a DECSCUSR response, and ST ends the sequence.\n+    // this is a DECSCUSR response.\n     switch (cursor.GetType())\n     {\n     case CursorType::FullBox:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r1 q\\033\\\\\" : L\"\\033P1$r2 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r1 q\" : L\"1$r2 q\");\n         break;\n     case CursorType::Underscore:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r3 q\\033\\\\\" : L\"\\033P1$r4 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r3 q\" : L\"1$r4 q\");\n         break;\n     case CursorType::VerticalBar:\n-        _api.ReturnResponse(blinking ? L\"\\033P1$r5 q\\033\\\\\" : L\"\\033P1$r6 q\\033\\\\\");\n+        _ReturnDcsResponse(blinking ? L\"1$r5 q\" : L\"1$r6 q\");\n         break;\n     default:\n         // If we have a non-standard style, this is likely because it's the\n         // user's chosen default style, so we report a default value of 0.\n         // That way, if an application later tries to restore the cursor with\n         // the returned value, it should be reset to its original state.\n-        _api.ReturnResponse(L\"\\033P1$r0 q\\033\\\\\");\n+        _ReturnDcsResponse(L\"1$r0 q\");\n         break;\n     }\n }\n@@ -4282,10 +4282,10 @@ void AdaptDispatch::_ReportDECSCUSRSetting() const\n void AdaptDispatch::_ReportDECSCASetting() const\n {\n     const auto isProtected = _pages.ActivePage().Attributes().IsProtected();\n-    // A valid response always starts with DCS 1 $ r. This is followed by '1' if\n-    // the protected attribute is set, or '0' if not. The '\"q' indicates this is\n-    // a DECSCA response, and ST ends the sequence.\n-    _api.ReturnResponse(isProtected ? L\"\\033P1$r1\\\"q\\033\\\\\" : L\"\\033P1$r0\\\"q\\033\\\\\");\n+    // A valid response always starts with 1 $ r. This is followed by '1' if the\n+    // protected attribute is set, or '0' if not. The '\"q' indicates this is a\n+    // DECSCA response.\n+    _ReturnDcsResponse(isProtected ? L\"1$r1\\\"q\" : L\"1$r0\\\"q\");\n }\n \n // Method Description:\n@@ -4297,10 +4297,10 @@ void AdaptDispatch::_ReportDECSCASetting() const\n void AdaptDispatch::_ReportDECSACESetting() const\n {\n     const auto rectangularExtent = _modes.test(Mode::RectangularChangeExtent);\n-    // A valid response always starts with DCS 1 $ r. This is followed by '2' if\n+    // A valid response always starts with 1 $ r. This is followed by '2' if\n     // the extent is rectangular, or '1' if it's a stream. The '*x' indicates\n-    // this is a DECSACE response, and ST ends the sequence.\n-    _api.ReturnResponse(rectangularExtent ? L\"\\033P1$r2*x\\033\\\\\" : L\"\\033P1$r1*x\\033\\\\\");\n+    // this is a DECSACE response.\n+    _ReturnDcsResponse(rectangularExtent ? L\"1$r2*x\" : L\"1$r1*x\");\n }\n \n // Method Description:\n@@ -4324,12 +4324,11 @@ void AdaptDispatch::_ReportDECACSetting(const VTInt itemNumber) const\n         bgIndex = _renderSettings.GetColorAliasIndex(ColorAlias::FrameBackground);\n         break;\n     default:\n-        _api.ReturnResponse(L\"\\033P0$r\\033\\\\\");\n+        _ReturnDcsResponse(L\"0$r\");\n         return;\n     }\n-    // A valid response always starts with DCS 1 $ r, the ',|' indicates this\n-    // is a DECAC response, and ST ends the sequence.\n-    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"\\033P1$r{};{};{},|\\033\\\\\"), itemNumber, fgIndex, bgIndex));\n+    // A valid response always starts with 1 $ r and the ',|' indicates this is a DECAC response.\n+    _ReturnDcsResponse(fmt::format(FMT_COMPILE(L\"1$r{};{};{},|\"), itemNumber, fgIndex, bgIndex));\n }\n \n // Routine Description:\n@@ -4442,9 +4441,9 @@ void AdaptDispatch::_ReportCursorInformation()\n     const auto charset2 = _termOutput.GetCharsetId(2);\n     const auto charset3 = _termOutput.GetCharsetId(3);\n \n-    // A valid response always starts with DCS 1 $ u and ends with ST.\n+    // A valid response always starts with 1 $ u.\n     const auto response = fmt::format(\n-        FMT_COMPILE(L\"\\033P1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\\033\\\\\"),\n+        FMT_COMPILE(L\"1$u{};{};{};{};{};{};{};{};{};{}{}{}{}\"),\n         cursorPosition.y,\n         cursorPosition.x,\n         page.Number(),\n@@ -4458,7 +4457,7 @@ void AdaptDispatch::_ReportCursorInformation()\n         charset1,\n         charset2,\n         charset3);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4623,9 +4622,9 @@ void AdaptDispatch::_ReportTabStops()\n \n     using namespace std::string_view_literals;\n \n-    // A valid response always starts with DCS 2 $ u.\n+    // A valid response always starts with 2 $ u.\n     fmt::basic_memory_buffer<wchar_t, 64> response;\n-    response.append(L\"\\033P2$u\"sv);\n+    response.append(L\"2$u\"sv);\n \n     auto need_separator = false;\n     for (auto column = 0; column < width; column++)\n@@ -4638,9 +4637,7 @@ void AdaptDispatch::_ReportTabStops()\n         }\n     }\n \n-    // An ST ends the sequence.\n-    response.append(L\"\\033\\\\\"sv);\n-    _api.ReturnResponse({ response.data(), response.size() });\n+    _ReturnDcsResponse({ response.data(), response.size() });\n }\n \n // Method Description:\n@@ -4685,6 +4682,26 @@ ITermDispatch::StringHandler AdaptDispatch::_RestoreTabStops()\n     };\n }\n \n+void AdaptDispatch::_ReturnCsiResponse(const std::wstring_view response) const\n+{\n+    const auto csi = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9B\" : L\"\\x1B[\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}\"), csi, response));\n+}\n+\n+void AdaptDispatch::_ReturnDcsResponse(const std::wstring_view response) const\n+{\n+    const auto dcs = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x90\" : L\"\\x1BP\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), dcs, response, st));\n+}\n+\n+void AdaptDispatch::_ReturnOscResponse(const std::wstring_view response) const\n+{\n+    const auto osc = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9D\" : L\"\\x1B]\";\n+    const auto st = _terminalInput.GetInputMode(TerminalInput::Mode::SendC1) ? L\"\\x9C\" : L\"\\x1B\\\\\";\n+    _api.ReturnResponse(fmt::format(FMT_COMPILE(L\"{}{}{}\"), osc, response, st));\n+}\n+\n // Routine Description:\n // - DECPS - Plays a sequence of musical notes.\n // Arguments:\ndiff --git a/src/terminal/adapter/adaptDispatch.hpp b/src/terminal/adapter/adaptDispatch.hpp\nindex 4fc85ebc92a..161e21d358d 100644\n--- a/src/terminal/adapter/adaptDispatch.hpp\n+++ b/src/terminal/adapter/adaptDispatch.hpp\n@@ -121,6 +121,7 @@ namespace Microsoft::Console::VirtualTerminal\n         void LockingShiftRight(const VTInt gsetNumber) override; // LS1R, LS2R, LS3R\n         void SingleShift(const VTInt gsetNumber) noexcept override; // SS2, SS3\n         void AcceptC1Controls(const bool enabled) override; // DECAC1\n+        void SendC1Controls(const bool enabled) override; // S8C1T, S7C1T\n         void AnnounceCodeStructure(const VTInt ansiLevel) override; // ACS\n         void SoftReset() override; // DECSTR\n         void HardReset() override; // RIS\n@@ -289,6 +290,10 @@ namespace Microsoft::Console::VirtualTerminal\n         void _ReportTabStops();\n         StringHandler _RestoreTabStops();\n \n+        void _ReturnCsiResponse(const std::wstring_view response) const;\n+        void _ReturnDcsResponse(const std::wstring_view response) const;\n+        void _ReturnOscResponse(const std::wstring_view response) const;\n+\n         std::vector<uint8_t> _tabStopColumns;\n         bool _initDefaultTabStops = true;\n \n@@ -302,7 +307,6 @@ namespace Microsoft::Console::VirtualTerminal\n         std::shared_ptr<SixelParser> _sixelParser;\n         std::unique_ptr<FontBuffer> _fontBuffer;\n         std::shared_ptr<MacroBuffer> _macroBuffer;\n-        std::optional<unsigned int> _initialCodePage;\n \n         // We have two instances of the saved cursor state, because we need\n         // one for the main buffer (at index 0), and another for the alt buffer\ndiff --git a/src/terminal/adapter/termDispatch.hpp b/src/terminal/adapter/termDispatch.hpp\nindex bb12dc32880..bd91d38d7e9 100644\n--- a/src/terminal/adapter/termDispatch.hpp\n+++ b/src/terminal/adapter/termDispatch.hpp\n@@ -115,6 +115,7 @@ class Microsoft::Console::VirtualTerminal::TermDispatch : public Microsoft::Cons\n     void LockingShiftRight(const VTInt /*gsetNumber*/) override {} // LS1R, LS2R, LS3R\r\n     void SingleShift(const VTInt /*gsetNumber*/) override {} // SS2, SS3\r\n     void AcceptC1Controls(const bool /*enabled*/) override {} // DECAC1\r\n+    void SendC1Controls(const bool /*enabled*/) override {} // S8C1T, S7C1T\r\n     void AnnounceCodeStructure(const VTInt /*ansiLevel*/) override {} // ACS\r\n \r\n     void SoftReset() override {} // DECSTR\r\ndiff --git a/src/terminal/adapter/ut_adapter/adapterTest.cpp b/src/terminal/adapter/ut_adapter/adapterTest.cpp\nindex ab2e08d3b85..5fab90f3d39 100644\n--- a/src/terminal/adapter/ut_adapter/adapterTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/adapterTest.cpp\n@@ -158,17 +158,28 @@ class TestGetSet final : public ITerminalApi\n         return true;\r\n     }\r\n \r\n-    void SetConsoleOutputCP(const unsigned int codepage) override\r\n+    void SetCodePage(const unsigned int codepage) override\r\n     {\r\n-        Log::Comment(L\"SetConsoleOutputCP MOCK called...\");\r\n-        THROW_HR_IF(E_FAIL, !_setConsoleOutputCPResult);\r\n-        VERIFY_ARE_EQUAL(_expectedOutputCP, codepage);\r\n+        Log::Comment(L\"SetCodePage MOCK called...\");\r\n+        THROW_HR_IF(E_FAIL, !_setCodePageResult);\r\n+        VERIFY_ARE_EQUAL(_expectedCodePage, codepage);\r\n     }\r\n \r\n-    unsigned int GetConsoleOutputCP() const override\r\n+    void ResetCodePage() override\r\n     {\r\n-        Log::Comment(L\"GetConsoleOutputCP MOCK called...\");\r\n-        return _expectedOutputCP;\r\n+        Log::Comment(L\"ResetCodePage MOCK called...\");\r\n+    }\r\n+\r\n+    unsigned int GetOutputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetOutputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n+    }\r\n+\r\n+    unsigned int GetInputCodePage() const override\r\n+    {\r\n+        Log::Comment(L\"GetInputCodePage MOCK called...\");\r\n+        return _expectedCodePage;\r\n     }\r\n \r\n     void CopyToClipboard(const wil::zwstring_view /*content*/)\r\n@@ -367,7 +378,7 @@ class TestGetSet final : public ITerminalApi\n     til::point _expectedCursorPos;\r\n \r\n     TextAttribute _expectedAttribute = {};\r\n-    unsigned int _expectedOutputCP = 0;\r\n+    unsigned int _expectedCodePage = 0;\r\n     bool _isPty = false;\r\n \r\n     bool _returnResponseResult = false;\r\n@@ -376,8 +387,7 @@ class TestGetSet final : public ITerminalApi\n \r\n     bool _setWindowTitleResult = false;\r\n     std::wstring_view _expectedWindowTitle{};\r\n-    bool _setConsoleOutputCPResult = false;\r\n-    bool _getConsoleOutputCPResult = false;\r\n+    bool _setCodePageResult = false;\r\n     bool _expectedShowWindow = false;\r\n \r\n     std::wstring _expectedMenuJson{};\r\n@@ -3529,15 +3539,15 @@ class AdapterTest\n \r\n         Log::Comment(L\"3. Designate ISO-2022 coding system\");\r\n         // Code page should be set to ISO-8859-1 and C1 parsing enabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = 28591;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = 28591;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::ISO2022);\r\n         VERIFY_IS_TRUE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n \r\n         Log::Comment(L\"4. Designate UTF-8 coding system\");\r\n         // Code page should be set to UTF-8 and C1 parsing disabled\r\n-        _testGetSet->_setConsoleOutputCPResult = true;\r\n-        _testGetSet->_expectedOutputCP = CP_UTF8;\r\n+        _testGetSet->_setCodePageResult = true;\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n         _pDispatch->DesignateCodingSystem(DispatchTypes::CodingSystem::UTF8);\r\n         VERIFY_IS_FALSE(_stateMachine->GetParserMode(StateMachine::Mode::AcceptC1));\r\n     }\r\n@@ -3962,6 +3972,39 @@ class AdapterTest\n         _pDispatch->PagePositionAbsolute(1);\r\n     }\r\n \r\n+    TEST_METHOD(SendC1ControlTest)\r\n+    {\r\n+        const auto S7C1T = L\"\\033 F\";\r\n+        const auto S8C1T = L\"\\033 G\";\r\n+\r\n+        _testGetSet->PrepData();\r\n+        _testGetSet->_expectedCodePage = CP_UTF8;\r\n+\r\n+        Log::Comment(L\"Generating reports with C1 control sequences\");\r\n+        _stateMachine->ProcessString(S8C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9b>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x90!|00000000\\x9c\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x9d\\x34;0;rgb:0c0c/0c0c/0c0c\\x9c\");\r\n+\r\n+        Log::Comment(L\"Generating reports with 7-bit escape sequence\");\r\n+        _stateMachine->ProcessString(S7C1T);\r\n+\r\n+        _pDispatch->SecondaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b[>0;10;1c\");\r\n+\r\n+        _pDispatch->TertiaryDeviceAttributes();\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1bP!|00000000\\x1b\\\\\");\r\n+\r\n+        _pDispatch->RequestColorTableEntry(0);\r\n+        _testGetSet->ValidateInputEvent(L\"\\x1b]4;0;rgb:0c0c/0c0c/0c0c\\x1b\\\\\");\r\n+    }\r\n+\r\n private:\r\n     TerminalInput _terminalInput;\r\n     std::unique_ptr<TestGetSet> _testGetSet;\r\ndiff --git a/src/terminal/adapter/ut_adapter/inputTest.cpp b/src/terminal/adapter/ut_adapter/inputTest.cpp\nindex d3c4c3d0d06..ab893be7724 100644\n--- a/src/terminal/adapter/ut_adapter/inputTest.cpp\n+++ b/src/terminal/adapter/ut_adapter/inputTest.cpp\n@@ -36,6 +36,7 @@ class Microsoft::Console::VirtualTerminal::InputTest\n     TEST_METHOD(CtrlNumTest);\r\n     TEST_METHOD(BackarrowKeyModeTest);\r\n     TEST_METHOD(AutoRepeatModeTest);\r\n+    TEST_METHOD(SendC1ControlTest);\r\n \r\n     wchar_t GetModifierChar(const bool fShift, const bool fAlt, const bool fCtrl)\r\n     {\r\n@@ -790,3 +791,20 @@ void InputTest::AutoRepeatModeTest()\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput(L\"A\"), input.HandleKey(down));\r\n     VERIFY_ARE_EQUAL(TerminalInput::MakeOutput({}), input.HandleKey(up));\r\n }\r\n+\r\n+void InputTest::SendC1ControlTest()\r\n+{\r\n+    TerminalInput input;\r\n+\r\n+    Log::Comment(L\"Sending keys with C1 control sequences\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, true);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x9bH\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x8fP\"), input, 0, VK_F1);\r\n+\r\n+    Log::Comment(L\"Sending keys with 7-bit escape sequence\");\r\n+    input.SetInputMode(TerminalInput::Mode::SendC1, false);\r\n+\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1b[H\"), input, 0, VK_HOME);\r\n+    TestKey(TerminalInput::MakeOutput(L\"\\x1bOP\"), input, 0, VK_F1);\r\n+}\r\ndiff --git a/src/terminal/input/terminalInput.cpp b/src/terminal/input/terminalInput.cpp\nindex 7c09ef46155..ac0795bdc41 100644\n--- a/src/terminal/input/terminalInput.cpp\n+++ b/src/terminal/input/terminalInput.cpp\n@@ -53,7 +53,7 @@ void TerminalInput::SetInputMode(const Mode mode, const bool enabled) noexcept\n \r\n     // If we've changed one of the modes that alter the VT input sequences,\r\n     // we'll need to regenerate our keyboard map.\r\n-    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey };\r\n+    static constexpr auto keyMapModes = til::enumset<Mode>{ Mode::LineFeed, Mode::Ansi, Mode::Keypad, Mode::CursorKey, Mode::BackarrowKey, Mode::SendC1 };\r\n     if (keyMapModes.test(mode))\r\n     {\r\n         _initKeyboardMap();\r\n@@ -353,6 +353,19 @@ try\n \r\n     _keyMap.clear();\r\n \r\n+    // The CSI and SS3 introducers are C1 control codes, which can either be\r\n+    // sent as a single codepoint, or as a two character escape sequence.\r\n+    if (_inputMode.test(Mode::SendC1))\r\n+    {\r\n+        _csi = L\"\\x9B\";\r\n+        _ss3 = L\"\\x8F\";\r\n+    }\r\n+    else\r\n+    {\r\n+        _csi = L\"\\x1B[\";\r\n+        _ss3 = L\"\\x1BO\";\r\n+    }\r\n+\r\n     // PAUSE doesn't have a VT mapping, but traditionally we've mapped it to ^Z,\r\n     // regardless of modifiers.\r\n     defineKeyWithUnusedModifiers(VK_PAUSE, L\"\\x1A\"s);\r\ndiff --git a/src/terminal/input/terminalInput.hpp b/src/terminal/input/terminalInput.hpp\nindex e8ae53267e2..40488269569 100644\n--- a/src/terminal/input/terminalInput.hpp\n+++ b/src/terminal/input/terminalInput.hpp\n@@ -33,6 +33,7 @@ namespace Microsoft::Console::VirtualTerminal\n             CursorKey,\r\n             BackarrowKey,\r\n             Win32,\r\n+            SendC1,\r\n \r\n             Utf8MouseEncoding,\r\n             SgrMouseEncoding,\r\n@@ -80,10 +81,8 @@ namespace Microsoft::Console::VirtualTerminal\n         til::enumset<Mode> _inputMode{ Mode::Ansi, Mode::AutoRepeat, Mode::AlternateScroll };\r\n         bool _forceDisableWin32InputMode{ false };\r\n \r\n-        // In the future, if we add support for \"8-bit\" input mode, these prefixes\r\n-        // will sometimes be replaced with equivalent C1 control characters.\r\n-        static constexpr auto _csi = L\"\\x1B[\";\r\n-        static constexpr auto _ss3 = L\"\\x1BO\";\r\n+        const wchar_t* _csi = L\"\\x1B[\";\r\n+        const wchar_t* _ss3 = L\"\\x1BO\";\r\n \r\n         void _initKeyboardMap() noexcept;\r\n         DWORD _trackControlKeyState(const KEY_EVENT_RECORD& key);\r\n@@ -108,9 +107,9 @@ namespace Microsoft::Console::VirtualTerminal\n #pragma endregion\r\n \r\n #pragma region MouseInput\r\n-        [[nodiscard]] static OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n-        [[nodiscard]] static OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateDefaultSequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateUtf8Sequence(til::point position, unsigned int button, bool isHover, short modifierKeyState, short delta);\r\n+        [[nodiscard]] OutputType _GenerateSGRSequence(til::point position, unsigned int button, bool isDown, bool isHover, short modifierKeyState, short delta);\r\n \r\n         [[nodiscard]] OutputType _makeAlternateScrollOutput(short delta) const;\r\n \r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.cpp b/src/terminal/parser/OutputStateMachineEngine.cpp\nindex 5339c29bdf9..edb53e100d0 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.cpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.cpp\n@@ -256,6 +256,12 @@ bool OutputStateMachineEngine::ActionEscDispatch(const VTID id)\n     case EscActionCodes::DECAC1_AcceptC1Controls:\r\n         _dispatch->AcceptC1Controls(true);\r\n         break;\r\n+    case EscActionCodes::S7C1T_Send7bitC1Controls:\r\n+        _dispatch->SendC1Controls(false);\r\n+        break;\r\n+    case EscActionCodes::S8C1T_Send8bitC1Controls:\r\n+        _dispatch->SendC1Controls(true);\r\n+        break;\r\n     case EscActionCodes::ACS_AnsiLevel1:\r\n         _dispatch->AnnounceCodeStructure(1);\r\n         break;\r\ndiff --git a/src/terminal/parser/OutputStateMachineEngine.hpp b/src/terminal/parser/OutputStateMachineEngine.hpp\nindex ad594c269cd..ab41e066cfa 100644\n--- a/src/terminal/parser/OutputStateMachineEngine.hpp\n+++ b/src/terminal/parser/OutputStateMachineEngine.hpp\n@@ -77,6 +77,8 @@ namespace Microsoft::Console::VirtualTerminal\n             LS2R_LockingShift = VTID(\"}\"),\r\n             LS3R_LockingShift = VTID(\"|\"),\r\n             DECAC1_AcceptC1Controls = VTID(\" 7\"),\r\n+            S7C1T_Send7bitC1Controls = VTID(\" F\"),\r\n+            S8C1T_Send8bitC1Controls = VTID(\" G\"),\r\n             ACS_AnsiLevel1 = VTID(\" L\"),\r\n             ACS_AnsiLevel2 = VTID(\" M\"),\r\n             ACS_AnsiLevel3 = VTID(\" N\"),\r\ndiff --git a/src/terminal/parser/stateMachine.cpp b/src/terminal/parser/stateMachine.cpp\nindex 65e7460e9b8..12954512bdb 100644\n--- a/src/terminal/parser/stateMachine.cpp\n+++ b/src/terminal/parser/stateMachine.cpp\n@@ -25,6 +25,9 @@ StateMachine::StateMachine(std::unique_ptr<IStateMachineEngine> engine, const bo\n     _oscString{},\r\n     _cachedSequence{ std::nullopt }\r\n {\r\n+    // The state machine must always accept C1 controls for the input engine,\r\n+    // otherwise it won't work when the ConPTY terminal has S8C1T enabled.\r\n+    _parserMode.set(Mode::AcceptC1, _isEngineForInput);\r\n     _ActionClear();\r\n }\r\n \r\n", "instance_id": "microsoft__terminal-17945", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the goal of adding support for S8C1T and S7C1T escape sequences to enable the terminal to use C1 controls for key sequences and query responses. It provides context about the historical significance and modern relevance of these sequences, as well as some technical implementation details, such as hooking up to existing frameworks and handling input/output code pages. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior for all edge cases (e.g., behavior in unsupported environments like WSL) or provide concrete examples of input/output for the escape sequences. Additionally, while it mentions limitations and potential challenges (e.g., WSL and SSH client compatibility), it leaves the decision of whether to proceed somewhat open-ended, which could lead to uncertainty in prioritization or scope. Overall, the description is valid and clear but lacks comprehensive details on edge cases and specific test scenarios.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., Terminal.hpp, TerminalApi.cpp, adaptDispatch.cpp, input handling, and state machine logic), requiring a deep understanding of the terminal emulator's architecture, particularly how escape sequences, input/output code pages, and C1 control handling interact. The changes impact critical components like input processing and response generation, necessitating careful integration with existing systems. Second, the number of technical concepts involved is substantial, including knowledge of VT escape sequences, C1 control codes, code page management (UTF-8, ISO-8859-1), terminal input/output handling, and state machine parsing. Additionally, the problem requires handling edge cases, such as ensuring compatibility with different environments (WSL, Windows shell) and managing the encoding of control sequences (single-byte vs. two-byte representations). While the problem does not involve advanced algorithms or system-level redesign, the need to modify and test across multiple layers of the codebase, combined with the domain-specific knowledge of terminal emulation standards (e.g., VT level 2 conformance), makes this a challenging task. A score of 0.65 reflects the complexity of understanding and modifying the existing framework while ensuring correctness in a niche area of terminal functionality.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": 0.85, "human_difficulty": -1}
{"problem_statement": "Escape sequences in unit test log comments are being interpreted\n### Windows Terminal version\n\nCommit 9b21b78feea9ff0a0b9ff2c8fa4b4aa5602d3889\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Get the latest source (I suspect it needs to be 4c018efd641dd71502e4019078bb6325c68b7f9a or later)\r\n2. Build the project\r\n3. From a cmd shell[^1], run the `VtResize` unit test.\r\n    \r\n    ```\r\n    runut /name:ScreenBufferTests::VtResize\r\n    ````\r\n\r\n[^1]: I'm not sure it _has_ to be a cmd shell, but that's all I ever use.\r\n\n\n### Expected Behavior\n\nYou should see the test log output as usual.\n\n### Actual Behavior\n\nThe output appears to be clamped to a corner of the screen.\r\n\r\n![image](https://github.com/user-attachments/assets/bdcedc1b-98c5-431c-a563-21b7e3458ef3)\r\n\r\nIf you have a look at the source for that test, you'll notice there are escape sequences in several of the log comments. For example, see here:\r\nhttps://github.com/microsoft/terminal/blob/main/src/host/ut_host/ScreenBufferTests.cpp#L1173-L1176\r\n\r\nI'm guessing what's happening is that those escape sequences are now being interpreted, which causes the conhost buffer to be resized, and that ends up screwing up the output.\r\n\r\nThis only started happening very recently, and that test has been around for ages, so I'm assuming it's got something to do with the TAEF upgrade in PR #16595.\r\n\r\n\n", "patch": "diff --git a/src/host/ut_host/ScreenBufferTests.cpp b/src/host/ut_host/ScreenBufferTests.cpp\nindex d1fe5a31962..beaab2c3047 100644\n--- a/src/host/ut_host/ScreenBufferTests.cpp\n+++ b/src/host/ut_host/ScreenBufferTests.cpp\n@@ -1105,7 +1105,7 @@ void ScreenBufferTests::VtResize()\n     auto initialViewWidth = si.GetViewport().Width();\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;30;80t'\"\r\n+        L\"Write '\\\\x1b[8;30;80t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 80 columns\"\r\n         L\" The viewport should be w,h=80,30\"));\r\n \r\n@@ -1127,7 +1127,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;40;80t'\"\r\n+        L\"Write '\\\\x1b[8;40;80t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 80 columns\"\r\n         L\" The viewport should be w,h=80,40\"));\r\n \r\n@@ -1149,7 +1149,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;40;90t'\"\r\n+        L\"Write '\\\\x1b[8;40;90t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 90 columns\"\r\n         L\" The viewport should be w,h=90,40\"));\r\n \r\n@@ -1171,7 +1171,7 @@ void ScreenBufferTests::VtResize()\n     initialViewWidth = newViewWidth;\r\n \r\n     Log::Comment(NoThrowString().Format(\r\n-        L\"Write '\\x1b[8;12;12t'\"\r\n+        L\"Write '\\\\x1b[8;12;12t'\"\r\n         L\" The Screen buffer height should remain unchanged, but the width should be 12 columns\"\r\n         L\" The viewport should be w,h=12,12\"));\r\n \r\n", "instance_id": "microsoft__terminal-17790", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: escape sequences in unit test log comments are being interpreted, leading to unintended resizing of the console host buffer and distorted output in the Windows Terminal. The steps to reproduce are provided, along with expected and actual behavior, which helps in understanding the problem context. Additionally, a specific commit and PR are referenced as potential causes of the issue, which adds useful context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the desired fix or constraints (e.g., whether escape sequences should be disabled entirely or handled differently). It also lacks mention of specific edge cases or environments beyond a cmd shell. While the issue is tied to a specific test (`VtResize`), the broader impact on other tests or components is not discussed. Overall, the statement is valid and clear but misses some finer details that would make it comprehensive.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as very easy (0.15) based on the provided factors. Let's break it down:\n\n1. **Scope and Depth of Code Changes**: The code changes are minimal and localized to a single file (`ScreenBufferTests.cpp`). The diff shows a straightforward modification—adding a backslash to escape the escape sequences in log comments (e.g., changing `\\x1b` to `\\\\x1b`) to prevent their interpretation. This involves only a few lines of code and does not impact the broader architecture or require understanding complex interactions within the codebase. The change is purely cosmetic and does not alter the logic of the test itself.\n\n2. **Number of Technical Concepts**: The solution requires only basic knowledge of string handling in C++ and an understanding of escape sequences in terminal output. No advanced language features, libraries, algorithms, or design patterns are involved. The concept of escaping characters in strings is fundamental and does not pose a significant learning curve, even for junior developers.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not mention specific edge cases beyond the observed behavior in the `VtResize` test. The code change itself does not introduce or modify error handling logic; it simply prevents the unintended interpretation of escape sequences in log output. There are no complex edge cases to consider in the provided solution, as the fix is a direct response to the reported issue.\n\n4. **Overall Complexity**: The task is a simple bug fix that addresses a specific, well-defined issue with a minimal and obvious code change. It does not require deep understanding of the Windows Terminal codebase or its architecture, nor does it involve performance considerations or system-level changes. The reference to a TAEF upgrade as a potential cause might suggest a need for deeper investigation, but the provided fix does not engage with that complexity.\n\nGiven these points, the problem falls into the \"very easy\" category. It requires only basic code modification to fix a display issue in log comments, with no significant technical challenges or broader impact on the system.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Quickly invoking PowerShell menu completion multiple times crashes Terminal\n### Windows Terminal version\n\n49e4eea60f737b46b8aeda505f4693df8a9d44a6\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enable experimental shell completion menu (`\"experimental.enableShellCompletionMenu\": true`)\r\n2. Quickly invoke shell completion multiple times, so that Terminal tries to parse JSON with completion data at the same time from multiple threads in one of the following ways:\r\n   - Terminal versions from 432dfcc4902d1a8393217a5f529d07e65182a3f8 to 6d0342f0bb31bf245843411c6781d6d5399ff651:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938 \r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times\r\n     4. Press any character key - because of #17204 this will send the completions generated in _c._ at the same time\r\n   - Terminal versions 0b76c51ba10c81ba4213ba98cf88f2abdf91b15e and newer or older than 432dfcc4902d1a8393217a5f529d07e65182a3f8:\r\n     1. Set up shell completion as described in _How do I test this?_ section of #14938, but instead of\r\n        ```ps\r\n        $result += $completions.CompletionMatches | ConvertTo-Json -Compress\r\n        ```\r\n        append a large JSON string to `$result`. It doesn't have to be a valid shell completion data, but it should be a valid JSON. 7.6M characters is large enough to reproduce the bug on my computer and probably every other PC without trying to be fast.\r\n     2. Type something e.g. `l`\r\n     3. Press `Ctrl+Space` multiple times. Depending on your CPU and the JSON size it may or may not have to be done quickly.\n\n### Expected Behavior\n\nCompletion menu is shown or nothing happens\n\n### Actual Behavior\n\nTerminal crashes or throws an exception or some kind of invalid memory access error, because `JSON::CharReader` in `Command::ParsePowerShellMenuComplete` is `static` and shared between threads:\r\n\r\nhttps://github.com/microsoft/terminal/blob/49e4eea60f737b46b8aeda505f4693df8a9d44a6/src/cascadia/TerminalSettingsModel/Command.cpp#L693\r\n\r\nReproduction in one of the versions affected by #17204:\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/693c214e-dbb2-47af-bb73-3b2a3f3efac9\r\n\r\nReproduction in other Terminal versions and demonstration of a possible fix (no menu is shown, because of the huge JSON, but the Terminal doesn't crash):\r\n\r\nhttps://github.com/microsoft/terminal/assets/12915102/72dc5cb2-dd77-4f1f-a4dc-722f419a53e5\r\n\r\n\n", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/Command.cpp b/src/cascadia/TerminalSettingsModel/Command.cpp\nindex a32ed4efa79..70f63091a1f 100644\n--- a/src/cascadia/TerminalSettingsModel/Command.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Command.cpp\n@@ -690,7 +690,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         auto data = winrt::to_string(json);\r\n \r\n         std::string errs;\r\n-        static std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n+        std::unique_ptr<Json::CharReader> reader{ Json::CharReaderBuilder{}.newCharReader() };\r\n         Json::Value root;\r\n         if (!reader->parse(data.data(), data.data() + data.size(), &root, &errs))\r\n         {\r\n", "instance_id": "microsoft__terminal-17221", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash in Windows Terminal caused by concurrent access to a static JSON parser when invoking PowerShell menu completion multiple times. It provides detailed steps to reproduce the issue across different versions of the Terminal, specifies the expected and actual behavior, and even includes visual reproductions and a reference to the problematic code. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the expected behavior in edge cases (e.g., very large JSON inputs beyond the mentioned 7.6M characters) or constraints on the solution (e.g., performance requirements or thread safety guarantees). Additionally, while the root cause is identified (static `JSON::CharReader`), the statement lacks clarity on whether the fix should prevent concurrent access entirely or handle it gracefully. These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving a single line modification in one file (`Command.cpp`). The fix removes the `static` qualifier from the `JSON::CharReader` instance, ensuring each thread gets its own parser instance, thus avoiding concurrent access issues. This change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is trivial, limited to a single variable declaration adjustment.\n\n2. **Number of Technical Concepts**: Solving this requires a basic understanding of thread safety and the implications of `static` variables in a multi-threaded environment, which are fundamental concepts in C++ programming. Familiarity with the JSON parsing library used (`Json::CharReader`) is helpful but not critical, as the fix does not involve deep interaction with the library's internals. No advanced algorithms, design patterns, or domain-specific knowledge are needed.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement mentions large JSON inputs as a factor in reproducing the crash, but the provided fix (removing `static`) inherently addresses this by avoiding shared state. No additional error handling logic is introduced or required in the code change. While there could be edge cases related to performance (e.g., memory overhead of creating multiple parser instances) or very high concurrency, these are not explicitly mentioned in the problem statement or addressed in the fix, keeping the complexity low.\n\n4. **Overall Complexity**: The root cause (static variable in a multi-threaded context) is a common concurrency bug, and the solution is straightforward for anyone with basic experience in multi-threaded programming. The fix does not require deep understanding of the Terminal's codebase or its architecture beyond the specific function in question. There are no significant performance or system-level considerations evident in the problem or solution.\n\nGiven the minimal code change, limited scope, basic technical concepts involved, and lack of complex edge case handling, I assign a difficulty score of 0.30. This reflects an easy problem that requires understanding some code logic (thread safety) and making a simple modification, but does not demand advanced expertise or extensive codebase knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Simplification should recognize and handle UV mirroring seams\nRare case but on some models, simplification lead to UV artefacts : UVs are getting fully streched (same value on both vertices) when many other triangles could have been optimized instead, I suggest to give a lower priority to simplify/remove vertices/faces of the mesh leading to these results.\r\n\r\nIt might also be a bug in the way the uvs get re-assigned.\r\n\r\nThe model used to illustrate this example : \r\nhttps://www.dropbox.com/scl/fi/po761ykdiqdmtbzd9fitf/rhino.glb?rlkey=s6jp06vtr4id0opnv76wwys1p&dl=0\r\n\r\nBefore simplify : \r\n<img width=\"527\" alt=\"Screenshot 2024-07-08 at 16 25 05\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/080e3431-bef9-4f61-811d-c5dbe638cf40\">\r\n\r\nAfter simplify :\r\n<img width=\"536\" alt=\"Screenshot 2024-07-08 at 16 14 54\" src=\"https://github.com/zeux/meshoptimizer/assets/213351/2da68c85-190d-441b-a59b-3789170bed2b\">\n", "patch": "diff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex a3ec5a60a..a61f057c9 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -409,6 +409,9 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t{\n \t\tconst Mesh& mesh = meshes[i];\n \n+\t\tif (mesh.type != cgltf_primitive_type_triangles)\n+\t\t\tcontinue;\n+\n \t\tif (settings.simplify_debug > 0)\n \t\t{\n \t\t\tMesh kinds = {};\ndiff --git a/gltf/mesh.cpp b/gltf/mesh.cpp\nindex ae44322f3..c691b48b7 100644\n--- a/gltf/mesh.cpp\n+++ b/gltf/mesh.cpp\n@@ -762,6 +762,78 @@ static void simplifyAttributes(std::vector<float>& attrs, float* attrw, size_t s\n \t}\n }\n \n+static void simplifyUvSplit(Mesh& mesh, std::vector<unsigned int>& remap)\n+{\n+\tassert(mesh.type == cgltf_primitive_type_triangles);\n+\tassert(!mesh.indices.empty());\n+\n+\tconst Stream* uv = getStream(mesh, cgltf_attribute_type_texcoord);\n+\tif (!uv)\n+\t\treturn;\n+\n+\tsize_t vertex_count = uv->data.size();\n+\n+\tstd::vector<unsigned char> uvsign(mesh.indices.size() / 3);\n+\tstd::vector<unsigned char> flipseam(vertex_count);\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tconst Attr& va = uv->data[a];\n+\t\tconst Attr& vb = uv->data[b];\n+\t\tconst Attr& vc = uv->data[c];\n+\n+\t\tfloat uvarea = (vb.f[0] - va.f[0]) * (vc.f[1] - va.f[1]) - (vc.f[0] - va.f[0]) * (vb.f[1] - va.f[1]);\n+\t\tunsigned char flag = uvarea > 0 ? 1 : (uvarea < 0 ? 2 : 0);\n+\n+\t\tuvsign[i / 3] = flag;\n+\t\tflipseam[a] |= flag;\n+\t\tflipseam[b] |= flag;\n+\t\tflipseam[c] |= flag;\n+\t}\n+\n+\tstd::vector<unsigned int> split(vertex_count);\n+\tsize_t splits = 0;\n+\n+\tremap.resize(vertex_count);\n+\n+\tfor (size_t i = 0; i < vertex_count; ++i)\n+\t{\n+\t\tremap[i] = unsigned(i);\n+\n+\t\tif (flipseam[i] == 3)\n+\t\t{\n+\t\t\tassert(remap.size() == vertex_count + splits);\n+\t\t\tremap.push_back(unsigned(i));\n+\n+\t\t\tsplit[i] = unsigned(vertex_count + splits);\n+\t\t\tsplits++;\n+\n+\t\t\tfor (size_t k = 0; k < mesh.streams.size(); ++k)\n+\t\t\t\tmesh.streams[k].data.push_back(mesh.streams[k].data[i]);\n+\t\t}\n+\t}\n+\n+\tfor (size_t i = 0; i < mesh.indices.size(); i += 3)\n+\t{\n+\t\tunsigned int a = mesh.indices[i + 0];\n+\t\tunsigned int b = mesh.indices[i + 1];\n+\t\tunsigned int c = mesh.indices[i + 2];\n+\n+\t\tunsigned char sign = uvsign[i / 3];\n+\n+\t\tif (flipseam[a] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 0] = split[a];\n+\t\tif (flipseam[b] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 1] = split[b];\n+\t\tif (flipseam[c] == 3 && sign == 2)\n+\t\t\tmesh.indices[i + 2] = split[c];\n+\t}\n+}\n+\n static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attributes, bool aggressive, bool lock_borders, bool debug = false)\n {\n \tenum\n@@ -778,6 +850,10 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \tif (!positions)\n \t\treturn;\n \n+\tstd::vector<unsigned int> uvremap;\n+\tif (attributes)\n+\t\tsimplifyUvSplit(mesh, uvremap);\n+\n \tsize_t vertex_count = mesh.streams[0].data.size();\n \n \tsize_t target_index_count = size_t(double(size_t(mesh.indices.size() / 3)) * threshold) * 3;\n@@ -819,6 +895,9 @@ static void simplifyMesh(Mesh& mesh, float threshold, float error, bool attribut\n \t\tindices.resize(meshopt_simplifySloppy(&indices[0], &mesh.indices[0], mesh.indices.size(), positions->data[0].f, vertex_count, sizeof(Attr), target_index_count, target_error_aggressive));\n \t\tmesh.indices.swap(indices);\n \t}\n+\n+\tif (uvremap.size() && mesh.indices.size() && !debug)\n+\t\tmeshopt_remapIndexBuffer(&mesh.indices[0], &mesh.indices[0], mesh.indices.size(), &uvremap[0]);\n }\n \n static void optimizeMesh(Mesh& mesh, bool compressmore)\n@@ -1048,8 +1127,6 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \treindexMesh(mesh, quantize_tbn);\n \tfilterTriangles(mesh);\n \n-\tsize_t vertex_count = mesh.streams[0].data.size();\n-\n \tsimplifyMesh(mesh, ratio, error, attributes, /* aggressive= */ false, /* lock_borders= */ false, /* debug= */ true);\n \n \t// color palette for display\n@@ -1079,6 +1156,8 @@ void debugSimplify(const Mesh& source, Mesh& kinds, Mesh& loops, float ratio, fl\n \t\t}\n \t}\n \n+\tsize_t vertex_count = mesh.streams[0].data.size();\n+\n \t// transform kind/loop data into lines & points\n \tStream colors = {cgltf_attribute_type_color};\n \tcolors.data.resize(vertex_count, kPalette[0]);\n", "instance_id": "zeux__meshoptimizer-807", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: UV mirroring seams causing artifacts during mesh simplification in a 3D model processing tool. It provides a specific example with a model file link and before/after images to illustrate the problem, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the statement does not explicitly define the expected behavior or constraints for handling UV seams (e.g., what constitutes a \"lower priority\" for simplification). Additionally, it vaguely suggests a potential bug in UV reassignment without providing specific hypotheses or test cases to narrow down the root cause. Edge cases beyond the provided model are not mentioned, leaving room for interpretation on how general the solution should be. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes involves multiple files (`gltfpack.cpp` and `mesh.cpp`) and introduces a non-trivial amount of new logic (e.g., the `simplifyUvSplit` function with ~70 lines of code). The changes impact the mesh simplification process, a core component of the system, requiring an understanding of how UV coordinates interact with mesh topology during simplification. Second, the technical concepts involved are moderately complex, including 3D graphics fundamentals (UV mapping, mesh simplification), specific library usage (`meshopt` for optimization), and custom data structures (`Mesh`, `Stream`, `Attr`). Implementing the solution requires calculating UV areas to detect mirroring seams and splitting vertices accordingly, which involves geometric reasoning and careful index remapping. Third, while the problem statement does not explicitly mention edge cases beyond the provided model, the code changes implicitly handle scenarios like triangles with zero UV area and vertices shared across flipped UV orientations, adding moderate complexity to error handling. Finally, the need to integrate with existing optimization routines (`meshopt_simplifySloppy`, `meshopt_remapIndexBuffer`) and ensure compatibility with debug modes suggests a deep understanding of the codebase is necessary. While not at the extreme end of difficulty (e.g., no system-level or distributed challenges), this problem requires significant domain knowledge and careful implementation, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "The HTTP server should starts at the end of ProxySQL Admin\nUp to version 2.6.2 , in `ProxySQL_Admin::init()` the HTTP server is started at the very beginning:\r\n\r\nhttps://github.com/sysown/proxysql/blob/v2.6.2/lib/ProxySQL_Admin.cpp#L6384\r\n\r\nIf the Prometheus exporter is immediately accessible, it can attempt to access objects yet not initialized, possibly leading to a crash if the exporter is accessed within a few milliseconds from ProxySQL start.\r\n\r\nWe should probably move the initialization of `AdminHTTPServer` outside of `ProxySQL_Admin::init()` , and only initialize after all the other modules are initialized (therefore should be initialized from `main()`.\n", "patch": "diff --git a/include/proxysql_admin.h b/include/proxysql_admin.h\nindex 6906091cc7..d46933a331 100644\n--- a/include/proxysql_admin.h\n+++ b/include/proxysql_admin.h\n@@ -394,6 +394,8 @@ class ProxySQL_Admin {\n \tvoid public_add_active_users(enum cred_username_type usertype, char *user=NULL) {\n \t\t__add_active_users(usertype, user);\n \t}\n+\t// @brief True if all ProxySQL modules have been already started. End of 'phase3'.\n+\tbool all_modules_started;\n \tProxySQL_Admin();\n \t~ProxySQL_Admin();\n \tSQLite3DB *admindb;\t// in memory\n@@ -416,6 +418,18 @@ class ProxySQL_Admin {\n \t */\n \tbool init(const bootstrap_info_t& bootstrap_info);\n \tvoid init_ldap();\n+\t/** @brief Initializes the HTTP server. For safety should be called after 'phase3'. */\n+\tvoid init_http_server();\n+\t/**\n+\t * @brief Loads the HTTP server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_http_server();\n+\t/**\n+\t * @brief Loads the RESTAPI server config to runtime if all modules are ready, no-op otherwise.\n+\t * @details Modules ready when 'all_modules_started=true'. See 'all_modules_started'.\n+\t */\n+\tvoid load_restapi_server();\n \tbool get_read_only() { return variables.admin_read_only; }\n \tbool set_read_only(bool ro) { variables.admin_read_only=ro; return variables.admin_read_only; }\n \tbool has_variable(const char *name);\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex 17ac811b0c..ae9b3e4502 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -6115,6 +6115,12 @@ void ProxySQL_Admin::init_ldap() {\n \t}\n }\n \n+void ProxySQL_Admin::init_http_server() {\n+\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n+\tAdminHTTPServer->init();\n+\tAdminHTTPServer->print_version();\n+}\n+\n struct boot_srv_info_t {\n \tstring member_id;\n \tstring member_host;\n@@ -6381,10 +6387,6 @@ bool ProxySQL_Admin::init(const bootstrap_info_t& bootstrap_info) {\n \tcpu_timer cpt;\n \n \tAdmin_HTTP_Server = NULL;\n-\tAdminHTTPServer = new ProxySQL_HTTP_Server();\n-\tAdminHTTPServer->init();\n-\tAdminHTTPServer->print_version();\n-\n \tAdminRestApiServer = NULL;\n /*\n \tAdminRestApiServer = new ProxySQL_RESTAPI_Server();\n@@ -7220,6 +7222,167 @@ void ProxySQL_Admin::load_or_update_global_settings(SQLite3DB *db) {\n \t}\n }\n \n+void ProxySQL_Admin::load_restapi_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n+\t\t[this](const httpserver::http_request& request) {\n+\t\t\tauto headers = request_headers(request);\n+\t\t\tauto serial_response = this->serial_exposer(headers);\n+\t\t\tauto http_response = make_response(serial_response);\n+\n+\t\t\treturn http_response;\n+\t\t}\n+\t};\n+\n+\tbool free_restapi_port = false;\n+\n+\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n+\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n+\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n+\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n+\n+\t\tif (restapi_port_free == false) {\n+\t\t\tif (e_port_check == -1) {\n+\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n+\t\t\t} else {\n+\t\t\t\tproxy_error(\n+\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n+\t\t\t\t\tvariables.restapi_port\n+\t\t\t\t);\n+\t\t\t}\n+\t\t}\n+\t};\n+\n+\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n+\t\tif (variables.restapi_enabled) {\n+\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t}\n+\n+\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t);\n+\t\t} else {\n+\t\t\tdelete AdminRestApiServer;\n+\t\t\tAdminRestApiServer = NULL;\n+\t\t}\n+\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n+\t} else {\n+\t\tif (variables.restapi_port != variables.restapi_port_old) {\n+\t\t\tif (AdminRestApiServer) {\n+\t\t\t\tdelete AdminRestApiServer;\n+\t\t\t\tAdminRestApiServer = NULL;\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled) {\n+\t\t\t\tcheck_restapi_port(free_restapi_port);\n+\t\t\t}\n+\n+\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n+\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n+\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n+\t\t\t\t);\n+\t\t\t}\n+\t\t\tvariables.restapi_port_old = variables.restapi_port;\n+\t\t}\n+\t}\n+}\n+\n+void ProxySQL_Admin::load_http_server() {\n+\tif (!all_modules_started) { return; }\n+\n+\tif (variables.web_enabled != variables.web_enabled_old) {\n+\t\tif (variables.web_enabled) {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tchar *key_pem;\n+\t\t\t\tchar *cert_pem;\n+\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tint sfd = 0;\n+\t\t\t\t\tint reuseaddr = 1;\n+\t\t\t\t\tstruct sockaddr_in tmp_addr;\n+\n+\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n+\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n+\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n+\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n+\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n+\n+\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n+\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n+\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t);\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tproxy_error(\n+\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n+\t\t\t\t\t\t\t\tvariables.web_port\n+\t\t\t\t\t\t\t);\n+\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\tclose(sfd);\n+\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t} else {\n+\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\tGloWebInterface->stop();\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\t\tvariables.web_enabled_old = variables.web_enabled;\n+\t} else {\n+\t\tif (variables.web_port != variables.web_port_old) {\n+\t\t\tif (variables.web_enabled) {\n+\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n+\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n+\t\t\t\t\tAdmin_HTTP_Server = NULL;\n+\t\t\t\t\tchar *key_pem;\n+\t\t\t\t\tchar *cert_pem;\n+\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n+\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n+\t\t\t\t\t\tvariables.web_port,\n+\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n+\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n+\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n+\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n+\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n+\t\t\t\t\t\tMHD_OPTION_END);\n+\t\t\t\t\tfree(key_pem);\n+\t\t\t\t\tfree(cert_pem);\n+\t\t\t\t} else {\n+\t\t\t\t\tif (GloWebInterface) {\n+\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\tvariables.web_port_old = variables.web_port;\n+\t\t}\n+\t}\n+}\n+\n void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \tSQLite3DB *db, bool replace, const string& checksum, const time_t epoch, bool lock\n ) {\n@@ -7308,157 +7471,8 @@ void ProxySQL_Admin::flush_admin_variables___database_to_runtime(\n \t\t}\n \t\twrunlock();\n \t\t{\n-\t\t\tstd::function<std::shared_ptr<httpserver::http_response>(const httpserver::http_request&)> prometheus_callback {\n-\t\t\t\t[this](const httpserver::http_request& request) {\n-\t\t\t\t\tauto headers = request_headers(request);\n-\t\t\t\t\tauto serial_response = this->serial_exposer(headers);\n-\t\t\t\t\tauto http_response = make_response(serial_response);\n-\n-\t\t\t\t\treturn http_response;\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tbool free_restapi_port = false;\n-\n-\t\t\t// Helper lambda taking a boolean reference as a parameter to check if 'restapi_port' is available.\n-\t\t\t// In case of port not being free or error, logs an error 'ProxySQL_RestAPI_Server' isn't able to be started.\n-\t\t\tconst auto check_restapi_port = [&](bool& restapi_port_free) -> void {\n-\t\t\t\tint e_port_check = check_port_availability(variables.restapi_port, &restapi_port_free);\n-\n-\t\t\t\tif (restapi_port_free == false) {\n-\t\t\t\t\tif (e_port_check == -1) {\n-\t\t\t\t\t\tproxy_error(\"Unable to start 'ProxySQL_RestAPI_Server', failed to set 'SO_REUSEADDR' to check port availability.\\n\");\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\"Unable to start 'ProxySQL_RestAPI_Server', port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\tvariables.restapi_port\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t};\n-\n-\t\t\tif (variables.restapi_enabled != variables.restapi_enabled_old) {\n-\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t}\n-\n-\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t);\n-\t\t\t\t} else {\n-\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t}\n-\t\t\t\tvariables.restapi_enabled_old = variables.restapi_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.restapi_port != variables.restapi_port_old) {\n-\t\t\t\t\tif (AdminRestApiServer) {\n-\t\t\t\t\t\tdelete AdminRestApiServer;\n-\t\t\t\t\t\tAdminRestApiServer = NULL;\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled) {\n-\t\t\t\t\t\tcheck_restapi_port(free_restapi_port);\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tif (variables.restapi_enabled && free_restapi_port) {\n-\t\t\t\t\t\tAdminRestApiServer = new ProxySQL_RESTAPI_Server(\n-\t\t\t\t\t\t\tvariables.restapi_port, {{\"/metrics\", prometheus_callback}}\n-\t\t\t\t\t\t);\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.restapi_port_old = variables.restapi_port;\n-\t\t\t\t}\n-\t\t\t}\n-\t\t\tif (variables.web_enabled != variables.web_enabled_old) {\n-\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tint sfd = 0;\n-\t\t\t\t\t\t\tint reuseaddr = 1;\n-\t\t\t\t\t\t\tstruct sockaddr_in tmp_addr;\n-\n-\t\t\t\t\t\t\tsfd = socket(AF_INET, SOCK_STREAM, 0);\n-\t\t\t\t\t\t\tmemset(&tmp_addr, 0, sizeof(tmp_addr));\n-\t\t\t\t\t\t\ttmp_addr.sin_family = AF_INET;\n-\t\t\t\t\t\t\ttmp_addr.sin_port = htons(variables.web_port);\n-\t\t\t\t\t\t\ttmp_addr.sin_addr.s_addr = INADDR_ANY;\n-\n-\t\t\t\t\t\t\tif (setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, (char *)&reuseaddr, sizeof(reuseaddr)) == -1) {\n-\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, failed to set 'SO_REUSEADDR' to check port '%d' availability.\\n\",\n-\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\tif (::bind(sfd, (struct sockaddr*)&tmp_addr, (socklen_t)sizeof(tmp_addr)) == -1) {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tproxy_error(\n-\t\t\t\t\t\t\t\t\t\t\"Unable to start WebInterfacePlugin, port '%d' already in use.\\n\",\n-\t\t\t\t\t\t\t\t\t\tvariables.web_port\n-\t\t\t\t\t\t\t\t\t);\n-\t\t\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\t\t\tclose(sfd);\n-\t\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t} else {\n-\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t} else {\n-\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\tGloWebInterface->stop();\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t}\n-\t\t\t\tvariables.web_enabled_old = variables.web_enabled;\n-\t\t\t} else {\n-\t\t\t\tif (variables.web_port != variables.web_port_old) {\n-\t\t\t\t\tif (variables.web_enabled) {\n-\t\t\t\t\t\tif (GloVars.web_interface_plugin == NULL) {\n-\t\t\t\t\t\t\tMHD_stop_daemon(Admin_HTTP_Server);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = NULL;\n-\t\t\t\t\t\t\tchar *key_pem;\n-\t\t\t\t\t\t\tchar *cert_pem;\n-\t\t\t\t\t\t\tGloVars.get_SSL_pem_mem(&key_pem, &cert_pem);\n-\t\t\t\t\t\t\tAdmin_HTTP_Server = MHD_start_daemon(MHD_USE_AUTO | MHD_USE_INTERNAL_POLLING_THREAD | MHD_USE_ERROR_LOG | MHD_USE_SSL,\n-\t\t\t\t\t\t\t\tvariables.web_port,\n-\t\t\t\t\t\t\t\tNULL, NULL, http_handler, NULL,\n-\t\t\t\t\t\t\t\tMHD_OPTION_CONNECTION_TIMEOUT, (unsigned int) 120, MHD_OPTION_STRICT_FOR_CLIENT, (int) 1,\n-\t\t\t\t\t\t\t\tMHD_OPTION_THREAD_POOL_SIZE, (unsigned int) 4,\n-\t\t\t\t\t\t\t\tMHD_OPTION_NONCE_NC_SIZE, (unsigned int) 300,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_KEY, key_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_HTTPS_MEM_CERT, cert_pem,\n-\t\t\t\t\t\t\t\tMHD_OPTION_END);\n-\t\t\t\t\t\t\tfree(key_pem);\n-\t\t\t\t\t\t\tfree(cert_pem);\n-\t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tif (GloWebInterface) {\n-\t\t\t\t\t\t\t\tGloWebInterface->start(variables.web_port);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t}\n-\t\t\t\t\tvariables.web_port_old = variables.web_port;\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tload_http_server();\n+\t\t\tload_restapi_server();\n \t\t\t// Update the admin variable for 'web_verbosity'\n \t\t\tadmin___web_verbosity = variables.web_verbosity;\n \t\t}\ndiff --git a/lib/ProxySQL_HTTP_Server.cpp b/lib/ProxySQL_HTTP_Server.cpp\nindex ff38885582..d8affaf396 100644\n--- a/lib/ProxySQL_HTTP_Server.cpp\n+++ b/lib/ProxySQL_HTTP_Server.cpp\n@@ -586,7 +586,7 @@ int ProxySQL_HTTP_Server::handler(void *cls, struct MHD_Connection *connection,\n \t\t\tdelete cpu_sqlite;\n \t\t\t\n \t\t\ts.append(\"</body></html>\");\n-\t \t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_PERSISTENT); \n+\t\t\tresponse = MHD_create_response_from_buffer(s.length(), (void *) s.c_str(), MHD_RESPMEM_MUST_COPY);\n   \t\t\tret = MHD_queue_response (connection, MHD_HTTP_OK, response);\n   \t\t\tMHD_destroy_response (response);\n \t\t\treturn ret;\ndiff --git a/src/main.cpp b/src/main.cpp\nindex aaac09822c..cfe5f4ff93 100644\n--- a/src/main.cpp\n+++ b/src/main.cpp\n@@ -1145,7 +1145,6 @@ void ProxySQL_Main_init_phase3___start_all() {\n \t\tGloAdmin->init_mysql_servers();\n \t\tGloAdmin->init_proxysql_servers();\n \t\tGloAdmin->load_scheduler_to_runtime();\n-\t\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n #ifdef DEBUG\n \t\tstd::cerr << \"Main phase3 : GloAdmin initialized in \";\n #endif\n@@ -1217,6 +1216,17 @@ void ProxySQL_Main_init_phase3___start_all() {\n \tif (GloMyLdapAuth) {\n \t\tGloAdmin->init_ldap_variables();\n \t}\n+\n+\t// HTTP Server should be initialized after other modules. See #4510\n+\tGloAdmin->init_http_server();\n+\tGloAdmin->proxysql_restapi().load_restapi_to_runtime();\n+\n+\t// Signal ProxySQL_Admin that all modules have been started\n+\tGloAdmin->all_modules_started = true;\n+\n+\t// Load the config not previously loaded for these modules\n+\tGloAdmin->load_http_server();\n+\tGloAdmin->load_restapi_server();\n }\n \n \n", "instance_id": "sysown__proxysql-4518", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the HTTP server in ProxySQL starts too early in the initialization process, potentially leading to crashes if accessed before other modules are ready. The goal of moving the HTTP server initialization outside of `ProxySQL_Admin::init()` to a later stage in `main()` is explicitly stated, along with a reference to the specific line of code in the GitHub repository. However, there are minor ambiguities and missing details. For instance, the statement does not specify the exact conditions under which the crash occurs (e.g., what specific objects are uninitialized) or provide examples of scenarios where this issue manifests. Additionally, there is no mention of potential edge cases or constraints that might arise from delaying the HTTP server initialization. Despite these minor gaps, the intent and high-level solution are understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes is moderate, involving multiple files (`proxysql_admin.h`, `ProxySQL_Admin.cpp`, `ProxySQL_HTTP_Server.cpp`, and `main.cpp`) and requiring a restructuring of initialization logic. The changes include adding new methods (`init_http_server`, `load_http_server`, `load_restapi_server`), introducing a control flag (`all_modules_started`), and relocating significant blocks of code related to HTTP and RESTAPI server initialization. This indicates a need to understand interactions between different parts of the codebase, particularly the initialization phases and dependencies between modules. Second, the technical concepts involved include C++ class design, server initialization (using libraries like MHD for HTTP handling), socket programming for port availability checks, and lifecycle management of server components, which are moderately complex. Third, while the problem statement does not explicitly mention edge cases, the code changes introduce error handling for port availability and conditional logic based on module readiness, suggesting some complexity in ensuring robust behavior. However, the changes do not appear to impact the core architecture significantly or require advanced domain-specific knowledge beyond typical server initialization patterns. Therefore, a score of 0.55 reflects a medium difficulty level, requiring a solid understanding of the codebase and careful implementation across multiple components, but not posing an exceptionally challenging or system-wide refactoring task.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "FirebaseCrashlytics deployment target inconsistency iOS 12 or 13\n### Description\n\nOur iOS application has iOS 12 as minimum deployment target (platform :ios, '12.0' in Podfile).\r\n\r\nIn our Podfile we have:\r\n\r\n`pod 'Firebase/Crashlytics', '~> 11.0'`\r\n\r\nIt fails as in Firebase.podspec Crashlytics subspec has iOS 13\r\n```\r\n  s.subspec 'Crashlytics' do |ss|\r\n    ss.ios.deployment_target = '13.0'\r\n  end\r\n```\r\n\r\nBut if we add to Podfile\r\n`pod 'FirebaseCrashlytics', '~> 11.0'`\r\n\r\nIt works, because in FirebaseCrashlytics.podspec iOS 12 is specified\r\n`ios_deployment_target = '12.0'`\r\n\r\nProbably iOS 12 can be specified in both places?\r\n\r\nThanks\r\n\n\n### Reproducing the issue\n\n_No response_\n\n### Firebase SDK Version\n\n11.1\n\n### Xcode Version\n\n15.4\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\n[!] CocoaPods could not find compatible versions for pod \"Firebase/Crashlytics\":\r\n  In Podfile:\r\n    Firebase/Crashlytics (~> 11.0)\r\n\r\nSpecs satisfying the `Firebase/Crashlytics (~> 11.0)` dependency were found, but they required a higher minimum deployment target.\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n_No response_\n\n### If using CocoaPods, the project's Podfile.lock\n\n_No response_\n", "patch": "diff --git a/Firebase.podspec b/Firebase.podspec\nindex 78a0093eef2..75dd6212b16 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -122,7 +122,7 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.2.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '13.0'\n+    ss.ios.deployment_target = '12.0'\n     ss.osx.deployment_target = '10.15'\n     ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n", "instance_id": "firebase__firebase-ios-sdk-13580", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: there is a discrepancy in the minimum iOS deployment target for Firebase Crashlytics between two pod specifications (`Firebase.podspec` and `FirebaseCrashlytics.podspec`), causing installation failures via CocoaPods when using `Firebase/Crashlytics`. The goal is to resolve this inconsistency by adjusting the deployment target. The statement includes relevant details such as the Podfile configuration, error logs, SDK version, and the specific lines in the podspec causing the issue. However, it lacks clarity on whether changing the deployment target to iOS 12 in `Firebase.podspec` is officially supported by Firebase or if there are potential compatibility issues or side effects to consider. Additionally, there are no explicit instructions or examples for testing the change, and edge cases or alternative solutions (e.g., using a different pod name or version) are not discussed. Thus, while the problem is valid and mostly clear, minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward modification to a single line in a configuration file (`Firebase.podspec`) to change the iOS deployment target from 13.0 to 12.0. The scope of the code change is minimal, affecting only one file and requiring no deep understanding of the broader codebase or system architecture. The technical concepts involved are basic—familiarity with CocoaPods and podspec files, which are standard tools in iOS development. There is no need for complex algorithms, design patterns, or domain-specific knowledge beyond basic iOS dependency management. Edge cases and error handling are not a significant concern here, as the change is a simple configuration adjustment, though one might need to verify compatibility with Firebase's official support for iOS 12. Overall, this task falls into the \"Very Easy\" category (0.0-0.2), as it requires only a basic code modification with minimal risk or complexity. I assign a difficulty score of 0.15 to reflect the simplicity of the task while acknowledging the need for minimal verification after the change.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Firebase 11 Minimum Supported version updates\n### Description\r\n\r\nIn order to address Xcode warnings for no longer supported build targets and increase the ability of Firebase to use modern Swift features, update most of Firebase to a minimum iOS version of 13 and comparable versions for other platforms.\r\n\r\nExceptions to consider:\r\n- Analytics and Crashlytics have historically needed to support older versions longer - proposing bumping to iOS 12, etc.\r\n- AppCheck may have a GoogleSignIn dependency in the future - proposing bumping to iOS 12, etc.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\n11.0\r\n\r\n### Xcode Version\r\n\r\n15.2+\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAll\r\n\r\n### Targeted Platforms\r\n\r\nAll\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/CoreOnly/Tests/FirebasePodTest/Podfile b/CoreOnly/Tests/FirebasePodTest/Podfile\nindex d5c3822537b..5724b18b03a 100644\n--- a/CoreOnly/Tests/FirebasePodTest/Podfile\n+++ b/CoreOnly/Tests/FirebasePodTest/Podfile\n@@ -18,7 +18,6 @@ target 'FirebasePodTest' do\n   pod 'FirebaseDatabase', :path => '../../../'\n   pod 'FirebaseDynamicLinks', :path => '../../../'\n   pod 'FirebaseFirestore', :path => '../../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../../'\n   pod 'FirebaseFunctions', :path => '../../../'\n   pod 'FirebaseInAppMessaging', :path => '../../../'\n   pod 'FirebaseInstallations', :path => '../../../'\ndiff --git a/Firebase.podspec b/Firebase.podspec\nindex bb29fb049db..d464a2205ea 100644\n--- a/Firebase.podspec\n+++ b/Firebase.podspec\n@@ -22,20 +22,20 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     \"CoreOnly/README.md\"\n   ]\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.cocoapods_version = '>= 1.12.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.default_subspec = 'Core'\n \n   s.subspec 'Core' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.ios.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.osx.dependency 'FirebaseAnalytics', '~> 11.0.0'\n     ss.tvos.dependency 'FirebaseAnalytics', '~> 11.0.0'\n@@ -55,30 +55,30 @@ Simplify your app development, grow your user base, and monetize more effectivel\n         'HEADER_SEARCH_PATHS' => \"$(inherited) ${PODS_ROOT}/Firebase/CoreOnly/Sources\"\n       }\n     end\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Analytics' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'Firebase/Core'\n   end\n \n   s.subspec 'AnalyticsWithoutAdIdSupport' do |ss|\n-    ss.ios.deployment_target = '10.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '12.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.dependency 'FirebaseAnalytics/WithoutAdIdSupport', '~> 11.0.0'\n     ss.dependency 'Firebase/CoreOnly'\n   end\n@@ -87,87 +87,87 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseABTesting', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'AppDistribution' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseAppDistribution', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'AppCheck' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAppCheck', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Auth' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseAuth', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Crashlytics' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseCrashlytics', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Database' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseDatabase', '~> 11.0.0'\n     # Standard platforms PLUS watchOS 7.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n     ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'DynamicLinks' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseDynamicLinks', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n+    ss.ios.deployment_target = '13.0'\n   end\n \n   s.subspec 'Firestore' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFirestore', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Functions' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseFunctions', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'InAppMessaging' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n     ss.tvos.dependency 'FirebaseInAppMessaging', '~> 11.0.0-beta'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'Installations' do |ss|\n@@ -179,48 +179,48 @@ Simplify your app development, grow your user base, and monetize more effectivel\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMessaging', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'MLModelDownloader' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseMLModelDownloader', '~> 11.0.0-beta'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Performance' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.ios.dependency 'FirebasePerformance', '~> 11.0.0'\n     ss.tvos.dependency 'FirebasePerformance', '~> 11.0.0'\n-    ss.ios.deployment_target = '11.0'\n-    ss.tvos.deployment_target = '12.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.tvos.deployment_target = '13.0'\n   end\n \n   s.subspec 'RemoteConfig' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseRemoteConfig', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n   s.subspec 'Storage' do |ss|\n     ss.dependency 'Firebase/CoreOnly'\n     ss.dependency 'FirebaseStorage', '~> 11.0.0'\n     # Standard platforms PLUS watchOS.\n-    ss.ios.deployment_target = '11.0'\n-    ss.osx.deployment_target = '10.13'\n-    ss.tvos.deployment_target = '12.0'\n-    ss.watchos.deployment_target = '6.0'\n+    ss.ios.deployment_target = '13.0'\n+    ss.osx.deployment_target = '10.15'\n+    ss.tvos.deployment_target = '13.0'\n+    ss.watchos.deployment_target = '7.0'\n   end\n \n end\ndiff --git a/FirebaseABTesting.podspec b/FirebaseABTesting.podspec\nindex e8fe7414e45..6392dae0dc7 100644\n--- a/FirebaseABTesting.podspec\n+++ b/FirebaseABTesting.podspec\n@@ -22,10 +22,10 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -35,7 +35,7 @@ Firebase Cloud Messaging and Firebase Remote Config in your app.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   base_dir = \"FirebaseABTesting/Sources/\"\n   s.source_files = [\ndiff --git a/FirebaseAnalytics.podspec b/FirebaseAnalytics.podspec\nindex 6467a9ef914..822a18a3b5a 100644\n--- a/FirebaseAnalytics.podspec\n+++ b/FirebaseAnalytics.podspec\n@@ -17,11 +17,11 @@ Pod::Spec.new do |s|\n     }\n \n     s.cocoapods_version = '>= 1.12.0'\n-    s.swift_version     = '5.3'\n+    s.swift_version     = '5.9'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/FirebaseAnalyticsOnDeviceConversion.podspec b/FirebaseAnalyticsOnDeviceConversion.podspec\nindex 2decdc2cac8..c8ccfe444c1 100644\n--- a/FirebaseAnalyticsOnDeviceConversion.podspec\n+++ b/FirebaseAnalyticsOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.static_framework = true\n \n-    s.ios.deployment_target = '10.0'\n+    s.ios.deployment_target = '12.0'\n \n     s.source_files = 'FirebaseAnalyticsOnDeviceConversionWrapper/*'\n end\ndiff --git a/FirebaseAppCheck.podspec b/FirebaseAppCheck.podspec\nindex b698de23452..e04fdfd976b 100644\n--- a/FirebaseAppCheck.podspec\n+++ b/FirebaseAppCheck.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAppCheckInterop.podspec b/FirebaseAppCheckInterop.podspec\nindex d8d372b4206..318feae1b1f 100644\n--- a/FirebaseAppCheckInterop.podspec\n+++ b/FirebaseAppCheckInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '10.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAppCheck/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAppCheck/Interop/Public/FirebaseAppCheckInterop/*.h'\ndiff --git a/FirebaseAppDistribution.podspec b/FirebaseAppDistribution.podspec\nindex 50135707816..fdfbd788c3c 100644\n--- a/FirebaseAppDistribution.podspec\n+++ b/FirebaseAppDistribution.podspec\n@@ -15,9 +15,9 @@ iOS SDK for App Distribution for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\nindex 2dc8abf4945..43b93570106 100644\n--- a/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n+++ b/FirebaseAppDistribution/Sources/FIRAppDistributionUIService.m\n@@ -23,12 +23,8 @@\n \n @implementation FIRAppDistributionUIService\n \n-API_AVAILABLE(ios(12.0))\n ASWebAuthenticationSession *_webAuthenticationVC;\n \n-// TODO: Remove this when the deployment target becomes iOS 12+\n-SFAuthenticationSession *_safariAuthenticationVC;\n-\n - (instancetype)init {\n   self = [super init];\n \n@@ -66,15 +62,8 @@ + (NSError *_Nullable)mapErrorToAppDistributionError:(NSError *_Nullable)error {\n   if (!error) {\n     return nil;\n   }\n-\n-  if (@available(iOS 12.0, *)) {\n-    if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n-  } else {\n-    if ([error code] == SFAuthenticationErrorCanceledLogin) {\n-      return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n-    }\n+  if ([error code] == ASWebAuthenticationSessionErrorCodeCanceledLogin) {\n+    return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationCancelled];\n   }\n \n   return [self getAppDistributionError:FIRAppDistributionErrorAuthenticationFailure];\n@@ -88,39 +77,24 @@ - (void)appDistributionRegistrationFlow:(NSURL *)URL\n   FIRFADInfoLog(@\"Registration URL: %@\", URL);\n   FIRFADInfoLog(@\"Callback URL: %@\", callbackURL);\n \n-  if (@available(iOS 12.0, *)) {\n-    ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    if (@available(iOS 13.0, *)) {\n-      authenticationVC.presentationContextProvider = self;\n-    }\n-\n-    _webAuthenticationVC = authenticationVC;\n+  ASWebAuthenticationSession *authenticationVC = [[ASWebAuthenticationSession alloc]\n+            initWithURL:URL\n+      callbackURLScheme:callbackURL\n+      completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n+        [self resetUIState];\n+        [self logRegistrationCompletion:error authType:[ASWebAuthenticationSession description]];\n+        NSError *_Nullable appDistributionError =\n+            [[self class] mapErrorToAppDistributionError:error];\n+        completion(appDistributionError);\n+      }];\n \n-    [authenticationVC start];\n-  } else {\n-    _safariAuthenticationVC = [[SFAuthenticationSession alloc]\n-              initWithURL:URL\n-        callbackURLScheme:callbackURL\n-        completionHandler:^(NSURL *_Nullable callbackURL, NSError *_Nullable error) {\n-          [self resetUIState];\n-          [self logRegistrationCompletion:error authType:[SFAuthenticationSession description]];\n-          NSError *_Nullable appDistributionError =\n-              [[self class] mapErrorToAppDistributionError:error];\n-          completion(appDistributionError);\n-        }];\n-\n-    [_safariAuthenticationVC start];\n+  if (@available(iOS 13.0, *)) {\n+    authenticationVC.presentationContextProvider = self;\n   }\n+\n+  _webAuthenticationVC = authenticationVC;\n+\n+  [authenticationVC start];\n }\n \n - (void)showUIAlert:(UIAlertController *)alertController {\n@@ -234,13 +208,7 @@ - (void)resetUIState {\n \n   self.registrationFlowCompletion = nil;\n \n-  if (@available(iOS 12.0, *)) {\n-    _webAuthenticationVC = nil;\n-  }\n-  // TODO: Remove this when the deployment target becomes iOS 12+\n-  // `_safariAuthenticationVC` is cleared unconditionally just in case;\n-  // It’s supposed to be assigned only when run on iOS 11.\n-  _safariAuthenticationVC = nil;\n+  _webAuthenticationVC = nil;\n }\n \n - (void)safariViewControllerDidFinish:(SFSafariViewController *)controller {\ndiff --git a/FirebaseAuth.podspec b/FirebaseAuth.podspec\nindex 773fa9e5a21..2ce91b86c03 100644\n--- a/FirebaseAuth.podspec\n+++ b/FirebaseAuth.podspec\n@@ -24,7 +24,7 @@ supports email and password accounts, as well as several 3rd party authenticatio\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseAuthInterop.podspec b/FirebaseAuthInterop.podspec\nindex f60eb9aa0be..2765250ac45 100644\n--- a/FirebaseAuthInterop.podspec\n+++ b/FirebaseAuthInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseAuth/Interop/**/*.[hm]'\n   s.public_header_files = 'FirebaseAuth/Interop/Public/FirebaseAuthInterop/*.h'\ndiff --git a/FirebaseAuthTestingSupport.podspec b/FirebaseAuthTestingSupport.podspec\nindex f581d15d40e..3cf9b5128b5 100644\n--- a/FirebaseAuthTestingSupport.podspec\n+++ b/FirebaseAuthTestingSupport.podspec\n@@ -18,11 +18,11 @@ Pod::Spec.new do |s|\n   }\n \n   ios_deployment_target = '13.0'\n-  osx_deployment_target = '10.13'\n+  osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -39,7 +39,7 @@ Pod::Spec.new do |s|\n     base_dir + 'Sources/**/*.swift',\n   ]\n \n-  s.dependency 'FirebaseAuth', '~> 10.22'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n \n   s.test_spec 'unit' do |unit_tests|\n     unit_tests.scheme = { :code_coverage => true }\ndiff --git a/FirebaseCombineSwift.podspec b/FirebaseCombineSwift.podspec\nindex 6f5ad6bcfc9..1670e68b9d4 100644\n--- a/FirebaseCombineSwift.podspec\n+++ b/FirebaseCombineSwift.podspec\n@@ -1,6 +1,6 @@\n Pod::Spec.new do |s|\n   s.name             = 'FirebaseCombineSwift'\n-  s.version          = '10.0.0'\n+  s.version          = '11.0.0'\n   s.summary          = 'Swift extensions with Combine support for Firebase'\n \n   s.description      = <<-DESC\n@@ -19,12 +19,12 @@ for internal testing only. It should not be published.\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  s.swift_version         = '5.3'\n+  s.swift_version       = '5.9'\n \n   ios_deployment_target = '13.0'\n   osx_deployment_target = '10.15'\n   tvos_deployment_target = '13.0'\n-  watchos_deployment_target = '6.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -51,11 +51,11 @@ for internal testing only. It should not be published.\n   s.osx.framework = 'AppKit'\n   s.tvos.framework = 'UIKit'\n \n-  s.dependency 'FirebaseCore', '~> 10.0'\n-  s.dependency 'FirebaseAuth', '~> 10.0'\n-  s.dependency 'FirebaseFunctions', '~> 10.0'\n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n-  s.dependency 'FirebaseStorage', '~> 10.0'\n+  s.dependency 'FirebaseCore', '~> 11.0'\n+  s.dependency 'FirebaseAuth', '~> 11.0'\n+  s.dependency 'FirebaseFunctions', '~> 11.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n+  s.dependency 'FirebaseStorage', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'HEADER_SEARCH_PATHS' => '\"${PODS_TARGET_SRCROOT}\"',\n@@ -104,6 +104,6 @@ for internal testing only. It should not be published.\n     int_tests.resources = 'FirebaseStorage/Tests/Integration/Resources/1mb.dat',\n                           'FirebaseStorage/Tests/Integration/Resources/GoogleService-Info.plist',\n                           'FirebaseStorage/Tests/Integration/Resources/HomeImprovement.numbers'\n-    int_tests.dependency 'FirebaseAuth', '~> 10.0'\n+    int_tests.dependency 'FirebaseAuth', '~> 11.0'\n   end\n end\ndiff --git a/FirebaseCore.podspec b/FirebaseCore.podspec\nindex 9364d54bc8d..c740a159fa9 100644\n--- a/FirebaseCore.podspec\n+++ b/FirebaseCore.podspec\n@@ -18,10 +18,10 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -40,7 +40,7 @@ Firebase Core includes FIRApp and FIROptions which provide central configuration\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.public_header_files = 'FirebaseCore/Sources/Public/FirebaseCore/*.h'\n \ndiff --git a/FirebaseCore/CHANGELOG.md b/FirebaseCore/CHANGELOG.md\nindex 33f31986a49..be7014d50b1 100644\n--- a/FirebaseCore/CHANGELOG.md\n+++ b/FirebaseCore/CHANGELOG.md\n@@ -1,3 +1,14 @@\n+# Firebase 11.0.0\n+- [changed] **Breaking change**: Firebase's minimum supported versions have\n+  updated for the following platforms:\n+    - | Platform  | Firebase 11 |\n+      | ------------- | ------------- |\n+      | iOS  | **13.0**  |\n+      | tvOS  | **13.0**  |\n+      | macOS  | **10.15**  |\n+      | watchOS  | 7.0  |\n+  - FirebaseAnalytics and FirebaseCrashlytics also continue to support iOS 12.0.\n+\n # Firebase 10.25.0\n - [changed] Firebase now requires at least Xcode 15.2. See\n   https://developer.apple.com/news/?id=fxu2qp7b for more info.\ndiff --git a/FirebaseCoreExtension.podspec b/FirebaseCoreExtension.podspec\nindex 833ef4e5522..dfeecc3b2b4 100644\n--- a/FirebaseCoreExtension.podspec\n+++ b/FirebaseCoreExtension.podspec\n@@ -20,12 +20,12 @@ Pod::Spec.new do |s|\n     }\n     s.social_media_url = 'https://twitter.com/Firebase'\n \n-    s.swift_version = '5.3'\n+    s.swift_version = '5.9'\n \n-    s.ios.deployment_target = '10.0'\n-    s.osx.deployment_target = '10.13'\n-    s.tvos.deployment_target = '12.0'\n-    s.watchos.deployment_target = '6.0'\n+    s.ios.deployment_target = '12.0'\n+    s.osx.deployment_target = '10.15'\n+    s.tvos.deployment_target = '13.0'\n+    s.watchos.deployment_target = '7.0'\n \n     s.source_files = 'FirebaseCore/Extension/*.[hm]'\n     s.public_header_files = 'FirebaseCore/Extension/*.h'\ndiff --git a/FirebaseCoreInternal.podspec b/FirebaseCoreInternal.podspec\nindex a2dd33a0458..bd2ce688b2d 100644\n--- a/FirebaseCoreInternal.podspec\n+++ b/FirebaseCoreInternal.podspec\n@@ -18,10 +18,10 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -36,7 +36,7 @@ Pod::Spec.new do |s|\n     \"#{s.module_name}_Privacy\" => 'FirebaseCore/Internal/Sources/Resources/PrivacyInfo.xcprivacy'\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.dependency 'GoogleUtilities/NSData+zlib', '~> 8.0'\n \ndiff --git a/FirebaseCrashlytics.podspec b/FirebaseCrashlytics.podspec\nindex 365376a02ee..be080d77522 100644\n--- a/FirebaseCrashlytics.podspec\n+++ b/FirebaseCrashlytics.podspec\n@@ -11,12 +11,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabase.podspec b/FirebaseDatabase.podspec\nindex 71360409d13..6884a7a5539 100644\n--- a/FirebaseDatabase.podspec\n+++ b/FirebaseDatabase.podspec\n@@ -17,12 +17,12 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n   watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseDatabaseSwift.podspec b/FirebaseDatabaseSwift.podspec\nindex 3e066ab7a0f..1701905ec67 100644\n--- a/FirebaseDatabaseSwift.podspec\n+++ b/FirebaseDatabaseSwift.podspec\n@@ -16,10 +16,10 @@ Simplify your iOS development, grow your user base, and monetize more effectivel\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseDynamicLinks.podspec b/FirebaseDynamicLinks.podspec\nindex 08d3bcb940d..ad9606e0b76 100644\n--- a/FirebaseDynamicLinks.podspec\n+++ b/FirebaseDynamicLinks.podspec\n@@ -16,9 +16,9 @@ Firebase Dynamic Links are deep links that enhance user experience and increase\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n+  s.ios.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestore.podspec b/FirebaseFirestore.podspec\nindex bd33677cd4a..8334d81e7e7 100644\n--- a/FirebaseFirestore.podspec\n+++ b/FirebaseFirestore.podspec\n@@ -13,11 +13,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.weak_framework = 'FirebaseFirestoreInternal'\n \ndiff --git a/FirebaseFirestoreInternal.podspec b/FirebaseFirestoreInternal.podspec\nindex bd3694dfda3..5e9288ad6c9 100644\n--- a/FirebaseFirestoreInternal.podspec\n+++ b/FirebaseFirestoreInternal.podspec\n@@ -16,11 +16,11 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseFirestoreSwift.podspec b/FirebaseFirestoreSwift.podspec\nindex 4582f9f240f..511c8d1bff3 100644\n--- a/FirebaseFirestoreSwift.podspec\n+++ b/FirebaseFirestoreSwift.podspec\n@@ -21,10 +21,10 @@ Google Cloud Firestore is a NoSQL document database built for automatic scaling,\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n-  s.ios.deployment_target   = '11.0'\n-  s.osx.deployment_target   = '10.13'\n-  s.tvos.deployment_target  = '12.0'\n+  s.swift_version           = '5.9'\n+  s.ios.deployment_target   = '13.0'\n+  s.osx.deployment_target   = '10.15'\n+  s.tvos.deployment_target  = '13.0'\n \n   s.cocoapods_version       = '>= 1.12.0'\n   s.prefix_header_file      = false\ndiff --git a/FirebaseFirestoreTestingSupport.podspec b/FirebaseFirestoreTestingSupport.podspec\nindex c2c13ccb23e..a28ab450c3f 100644\n--- a/FirebaseFirestoreTestingSupport.podspec\n+++ b/FirebaseFirestoreTestingSupport.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -42,7 +42,7 @@ Pod::Spec.new do |s|\n \n   s.public_header_files = base_dir + '**/*.h'\n \n-  s.dependency 'FirebaseFirestore', '~> 10.0'\n+  s.dependency 'FirebaseFirestore', '~> 11.0'\n \n   s.pod_target_xcconfig = {\n     'GCC_C_LANGUAGE_STANDARD' => 'c99',\ndiff --git a/FirebaseFunctions.podspec b/FirebaseFunctions.podspec\nindex 4383ae29317..2d069da346b 100644\n--- a/FirebaseFunctions.podspec\n+++ b/FirebaseFunctions.podspec\n@@ -16,12 +16,12 @@ Cloud Functions for Firebase.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version    = '5.3'\n+  s.swift_version    = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\n@@ -31,8 +31,6 @@ Cloud Functions for Firebase.\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n-  s.swift_version = '5.3'\n-\n   s.source_files = [\n     'FirebaseFunctions/Sources/**/*.swift',\n   ]\ndiff --git a/FirebaseInAppMessaging.podspec b/FirebaseInAppMessaging.podspec\nindex 557b84d94ca..42eaf9ecb84 100644\n--- a/FirebaseInAppMessaging.podspec\n+++ b/FirebaseInAppMessaging.podspec\n@@ -17,10 +17,10 @@ See more product details at https://firebase.google.com/products/in-app-messagin\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.tvos.deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\nindex ad7a95252aa..0e5b1ca8483 100644\n--- a/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n+++ b/FirebaseInAppMessaging/Sources/DefaultUI/Banner/FIRIAMBannerViewController.m\n@@ -160,15 +160,13 @@ - (void)viewDidLoad {\n   self.view.layer.shadowOpacity = 0.4;\n \n   // Calculate status bar height.\n-  CGFloat statusBarHeight = 0;\n-  if (@available(iOS 13.0, tvOS 13.0, *)) {\n-    UIStatusBarManager *manager =\n-        [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n-\n-    statusBarHeight = manager.statusBarFrame.size.height;\n-  } else {\n-    statusBarHeight = [[UIApplication sharedApplication] statusBarFrame].size.height;\n-  }\n+  // TODO(#13068) : Fix keyWindow deprecation.\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n+  UIStatusBarManager *manager =\n+      [UIApplication sharedApplication].keyWindow.windowScene.statusBarManager;\n+#pragma clang diagnostic pop\n+  CGFloat statusBarHeight = manager.statusBarFrame.size.height;\n \n   // Pin title label below status bar with cushion.\n   [[self.titleLabel.topAnchor constraintEqualToAnchor:self.view.topAnchor\ndiff --git a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\nindex ff1c70c111b..d7eac8d3b1e 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/DefaultUITestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'FiamDisplaySwiftExample' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n end\n \ndiff --git a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\nindex 7597b44e9fc..50db2923845 100644\n--- a/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n+++ b/FirebaseInAppMessaging/Tests/Integration/FunctionalTestApp/Podfile\n@@ -10,7 +10,7 @@ pod 'FirebaseInstallations', :path => '../../../..'\n pod 'FirebaseABTesting', :path => '../../../..'\n \n target 'InAppMessaging_Example_iOS' do\n-  platform :ios, '11.0'\n+  platform :ios, '13.0'\n \n   pod 'FirebaseInAppMessaging', :path => '../../../..'\n   pod 'FirebaseDynamicLinks',  :path => '../../../..'\ndiff --git a/FirebaseInstallations.podspec b/FirebaseInstallations.podspec\nindex 458e1654936..990dd505411 100644\n--- a/FirebaseInstallations.podspec\n+++ b/FirebaseInstallations.podspec\n@@ -17,12 +17,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '10.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader.podspec b/FirebaseMLModelDownloader.podspec\nindex 1118c479d1c..a45f5b93216 100644\n--- a/FirebaseMLModelDownloader.podspec\n+++ b/FirebaseMLModelDownloader.podspec\n@@ -16,12 +16,12 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMLModelDownloader/Apps/Sample/Podfile b/FirebaseMLModelDownloader/Apps/Sample/Podfile\nindex 24d21a9d4de..cb632e9d85f 100644\n--- a/FirebaseMLModelDownloader/Apps/Sample/Podfile\n+++ b/FirebaseMLModelDownloader/Apps/Sample/Podfile\n@@ -1,4 +1,4 @@\n-platform :ios, '11.0'\n+platform :ios, '13.0'\n use_frameworks!\n \n source 'https://github.com/firebase/SpecsDev.git'\ndiff --git a/FirebaseMessaging.podspec b/FirebaseMessaging.podspec\nindex bbabbcdc201..0e056c8a17a 100644\n--- a/FirebaseMessaging.podspec\n+++ b/FirebaseMessaging.podspec\n@@ -20,12 +20,12 @@ device, and it is completely free.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseMessagingInterop.podspec b/FirebaseMessagingInterop.podspec\nindex 31d03220e3c..3e7e1b6d8cb 100644\n--- a/FirebaseMessagingInterop.podspec\n+++ b/FirebaseMessagingInterop.podspec\n@@ -20,10 +20,10 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseMessaging/Interop/*.[hm]'\n   s.public_header_files = 'FirebaseMessaging/Interop/*.h'\ndiff --git a/FirebasePerformance.podspec b/FirebasePerformance.podspec\nindex 9a0f48d3acf..6bcf58249df 100644\n--- a/FirebasePerformance.podspec\n+++ b/FirebasePerformance.podspec\n@@ -17,10 +17,10 @@ Firebase Performance library to measure performance of Mobile and Web Apps.\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  tvos_deployment_target = '12.0'\n+  ios_deployment_target = '13.0'\n+  tvos_deployment_target = '13.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.tvos.deployment_target = tvos_deployment_target\ndiff --git a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\nindex c5e04efc947..147b53c516a 100644\n--- a/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n+++ b/FirebasePerformance/Sources/Instrumentation/UIKit/FPRUIViewControllerInstrument.m\n@@ -69,9 +69,12 @@ void InstrumentViewDidAppear(FPRUIViewControllerInstrument *instrument,\n \n     // This has to be called on the main thread and so it's done here instead of in\n     // FPRScreenTraceTracker.\n-    // TODO: Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n+    // TODO(#13067): Replace keyWindow usage (deprecated in iOS and unavailable in visionOS).\n #if !defined(TARGET_OS_VISION) || !TARGET_OS_VISION\n+#pragma clang diagnostic push\n+#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     if ([((UIViewController *)_self).view isDescendantOfView:FPRSharedApplication().keyWindow]) {\n+#pragma clang diagnostic pop\n       [[FPRScreenTraceTracker sharedInstance] viewControllerDidAppear:_self];\n     }\n #endif\ndiff --git a/FirebaseRemoteConfig.podspec b/FirebaseRemoteConfig.podspec\nindex 6c81684decb..a69cdbed484 100644\n--- a/FirebaseRemoteConfig.podspec\n+++ b/FirebaseRemoteConfig.podspec\n@@ -18,12 +18,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseRemoteConfig/Tests/Sample/Podfile b/FirebaseRemoteConfig/Tests/Sample/Podfile\nindex bfff53e6fea..bdce061ec49 100644\n--- a/FirebaseRemoteConfig/Tests/Sample/Podfile\n+++ b/FirebaseRemoteConfig/Tests/Sample/Podfile\n@@ -1,5 +1,4 @@\n-# Uncomment the next line to define a global platform for your project\n-# platform :ios, '9.0'\n+platform :ios, '13.0'\n \n source 'https://github.com/firebase/SpecsDev.git'\n source 'https://github.com/firebase/SpecsStaging.git'\ndiff --git a/FirebaseRemoteConfigInterop.podspec b/FirebaseRemoteConfigInterop.podspec\nindex c9d9a9c30d8..6f9ea69cba2 100644\n--- a/FirebaseRemoteConfigInterop.podspec\n+++ b/FirebaseRemoteConfigInterop.podspec\n@@ -20,15 +20,17 @@ Pod::Spec.new do |s|\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\n \n   s.social_media_url = 'https://twitter.com/Firebase'\n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n-  s.watchos.deployment_target = '6.0'\n+\n+  # The ios deployment target must support Crashlytics.\n+  s.ios.deployment_target = '12.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n+  s.watchos.deployment_target = '7.0'\n \n   s.source_files = 'FirebaseRemoteConfig/Interop/*.swift'\n end\ndiff --git a/FirebaseRemoteConfigSwift.podspec b/FirebaseRemoteConfigSwift.podspec\nindex 3f0b3b3174e..7474d09616f 100644\n--- a/FirebaseRemoteConfigSwift.podspec\n+++ b/FirebaseRemoteConfigSwift.podspec\n@@ -19,12 +19,12 @@ app update.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSessions.podspec b/FirebaseSessions.podspec\nindex 6c282296e9a..8685d6c61af 100644\n--- a/FirebaseSessions.podspec\n+++ b/FirebaseSessions.podspec\n@@ -18,12 +18,12 @@ Pod::Spec.new do |s|\n   }\n   s.social_media_url = 'https://twitter.com/Firebase'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '12.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseSharedSwift.podspec b/FirebaseSharedSwift.podspec\nindex 0b2ab17a71d..e0e8f4fec9c 100644\n--- a/FirebaseSharedSwift.podspec\n+++ b/FirebaseSharedSwift.podspec\n@@ -18,12 +18,12 @@ Firebase products. FirebaseSharedSwift is not supported for non-Firebase usage.\n     :tag => 'CocoaPods-' + s.version.to_s\n   }\n \n-  s.swift_version           = '5.3'\n+  s.swift_version           = '5.9'\n \n-  ios_deployment_target = '11.0'\n-  osx_deployment_target = '10.13'\n-  tvos_deployment_target = '12.0'\n-  watchos_deployment_target = '6.0'\n+  ios_deployment_target = '13.0'\n+  osx_deployment_target = '10.15'\n+  tvos_deployment_target = '13.0'\n+  watchos_deployment_target = '7.0'\n \n   s.ios.deployment_target = ios_deployment_target\n   s.osx.deployment_target = osx_deployment_target\ndiff --git a/FirebaseStorage.podspec b/FirebaseStorage.podspec\nindex 5322597a81c..17729ae3d28 100644\n--- a/FirebaseStorage.podspec\n+++ b/FirebaseStorage.podspec\n@@ -27,7 +27,7 @@ Firebase Storage provides robust, secure file uploads and downloads from Firebas\n   s.tvos.deployment_target = tvos_deployment_target\n   s.watchos.deployment_target = watchos_deployment_target\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.cocoapods_version = '>= 1.12.0'\n   s.prefix_header_file = false\ndiff --git a/FirebaseVertexAI-Docs.not_podspec b/FirebaseVertexAI-Docs.not_podspec\nindex 7967cc616c4..4c447335f65 100644\n--- a/FirebaseVertexAI-Docs.not_podspec\n+++ b/FirebaseVertexAI-Docs.not_podspec\n@@ -34,7 +34,7 @@ Pod::Spec.new do |s|\n     'FirebaseVertexAI/Sources/**/*.swift',\n   ]\n \n-  s.swift_version = '5.3'\n+  s.swift_version = '5.9'\n \n   s.framework = 'Foundation'\n   s.ios.framework = 'UIKit'\ndiff --git a/Firestore/Example/GoogleBenchmark.podspec b/Firestore/Example/GoogleBenchmark.podspec\nindex ae7fc81cd98..c0024acced3 100644\n--- a/Firestore/Example/GoogleBenchmark.podspec\n+++ b/Firestore/Example/GoogleBenchmark.podspec\n@@ -33,9 +33,9 @@ Google's C++ benchmark framework.\n       :tag => 'v' + s.version.to_s\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/GoogleTest.podspec b/Firestore/Example/GoogleTest.podspec\nindex 87788e99d8b..f7dd32cde06 100644\n--- a/Firestore/Example/GoogleTest.podspec\n+++ b/Firestore/Example/GoogleTest.podspec\n@@ -33,9 +33,9 @@ Google's C++ test framework.\n     :commit => 'bf66935e07825318ae519675d73d0f3e313b3ec6'\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.requires_arc = false\n \ndiff --git a/Firestore/Example/LibFuzzer.podspec b/Firestore/Example/LibFuzzer.podspec\nindex ea654f48fcc..c4b7b5f34a8 100644\n--- a/Firestore/Example/LibFuzzer.podspec\n+++ b/Firestore/Example/LibFuzzer.podspec\n@@ -28,9 +28,9 @@ Pod::Spec.new do |s|\n   s.license             = { :type => 'BSD-Like' }\n   s.authors             = 'LLVM Team'\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source              = {\n     :git => 'https://github.com/llvm/llvm-project.git'\ndiff --git a/Firestore/Example/Podfile b/Firestore/Example/Podfile\nindex 99bb2815390..c5417d9068d 100644\n--- a/Firestore/Example/Podfile\n+++ b/Firestore/Example/Podfile\n@@ -95,7 +95,7 @@ end\n \n if is_platform(:ios)\n   target 'Firestore_Example_iOS' do\n-    platform :ios, '11.0'\n+    platform :ios, '13.0'\n \n     configure_local_pods()\n \n@@ -120,7 +120,6 @@ if is_platform(:ios)\n     target 'Firestore_IntegrationTests_iOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -130,7 +129,7 @@ if is_platform(:ios)\n \n     target 'Firestore_FuzzTests_iOS' do\n       inherit! :search_paths\n-      platform :ios, '11.0'\n+      platform :ios, '13.0'\n \n       pod 'LibFuzzer', :podspec => 'LibFuzzer.podspec', :inhibit_warnings => true\n     end\n@@ -139,7 +138,7 @@ end\n \n if is_platform(:osx)\n   target 'Firestore_Example_macOS' do\n-    platform :osx, '10.13'\n+    platform :osx, '10.15'\n \n     configure_local_pods()\n \n@@ -158,7 +157,6 @@ if is_platform(:osx)\n     target 'Firestore_IntegrationTests_macOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\n@@ -170,7 +168,7 @@ end\n \n if is_platform(:tvos)\n   target 'Firestore_Example_tvOS' do\n-    platform :tvos, '12.0'\n+    platform :tvos, '13.0'\n \n     configure_local_pods()\n \n@@ -189,7 +187,6 @@ if is_platform(:tvos)\n     target 'Firestore_IntegrationTests_tvOS' do\n       inherit! :search_paths\n \n-      pod 'FirebaseFirestoreSwift', :path => '../../'\n       pod 'GoogleBenchmark', :podspec => 'GoogleBenchmark.podspec'\n       pod 'GoogleTest', :podspec => 'GoogleTest.podspec'\n       pod 'ProtobufCpp', :podspec => 'ProtobufCpp.podspec'\ndiff --git a/Firestore/Example/ProtobufCpp.podspec b/Firestore/Example/ProtobufCpp.podspec\nindex 956f9d3186c..7012de8d076 100644\n--- a/Firestore/Example/ProtobufCpp.podspec\n+++ b/Firestore/Example/ProtobufCpp.podspec\n@@ -29,9 +29,9 @@ Pod::Spec.new do |s|\n     :tag => \"v#{s.version}\"\n   }\n \n-  s.ios.deployment_target = '11.0'\n-  s.osx.deployment_target = '10.13'\n-  s.tvos.deployment_target = '12.0'\n+  s.ios.deployment_target = '13.0'\n+  s.osx.deployment_target = '10.15'\n+  s.tvos.deployment_target = '13.0'\n \n   s.source_files = 'src/**/*.{h,cc,inc}',\n                    # utf8_range is needed too, to avoid build errors.\ndiff --git a/GoogleAppMeasurement.podspec b/GoogleAppMeasurement.podspec\nindex f893a310310..b69681f1520 100644\n--- a/GoogleAppMeasurement.podspec\n+++ b/GoogleAppMeasurement.podspec\n@@ -21,9 +21,9 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n-    s.osx.deployment_target  = '10.13'\n-    s.tvos.deployment_target = '12.0'\n+    s.ios.deployment_target  = '12.0'\n+    s.osx.deployment_target  = '10.15'\n+    s.tvos.deployment_target = '13.0'\n \n     s.libraries  = 'c++', 'sqlite3', 'z'\n     s.frameworks = 'StoreKit'\ndiff --git a/GoogleAppMeasurementOnDeviceConversion.podspec b/GoogleAppMeasurementOnDeviceConversion.podspec\nindex a1810fb012c..0c816c4f9c4 100644\n--- a/GoogleAppMeasurementOnDeviceConversion.podspec\n+++ b/GoogleAppMeasurementOnDeviceConversion.podspec\n@@ -22,7 +22,7 @@ Pod::Spec.new do |s|\n \n     s.cocoapods_version = '>= 1.12.0'\n \n-    s.ios.deployment_target  = '10.0'\n+    s.ios.deployment_target  = '12.0'\n \n     s.libraries  = 'c++'\n \ndiff --git a/IntegrationTesting/ClientApp/Podfile b/IntegrationTesting/ClientApp/Podfile\nindex e2abd6876dd..29810fab6ad 100644\n--- a/IntegrationTesting/ClientApp/Podfile\n+++ b/IntegrationTesting/ClientApp/Podfile\n@@ -3,7 +3,7 @@ source 'https://github.com/firebase/SpecsStaging.git'\n source 'https://cdn.cocoapods.org/'\n \n target 'ClientApp-CocoaPods' do\n-  platform :ios, '12.0'\n+  platform :ios, '13.0'\n \n   use_frameworks!\n \n@@ -24,7 +24,6 @@ target 'ClientApp-CocoaPods' do\n   pod 'FirebaseDatabaseSwift', :path => '../../'\n   pod 'FirebaseDynamicLinks', :path => '../../'\n   pod 'FirebaseFirestore', :path => '../../'\n-  pod 'FirebaseFirestoreSwift', :path => '../../'\n   pod 'FirebaseFunctions', :path => '../../'\n   pod 'FirebaseInAppMessaging', :path => '../../'\n   pod 'FirebaseMessaging', :path => '../../'\ndiff --git a/Package.swift b/Package.swift\nindex 3da098725da..87174d0fb70 100644\n--- a/Package.swift\n+++ b/Package.swift\n@@ -23,7 +23,7 @@ let firebaseVersion = \"11.0.0\"\n \n let package = Package(\n   name: \"Firebase\",\n-  platforms: [.iOS(.v12), .macCatalyst(.v13), .macOS(.v10_13), .tvOS(.v12), .watchOS(.v7)],\n+  platforms: [.iOS(.v12), .macCatalyst(.v15), .macOS(.v10_15), .tvOS(.v13), .watchOS(.v7)],\n   products: [\n     .library(\n       name: \"FirebaseAnalytics\",\n", "instance_id": "firebase__firebase-ios-sdk-13066", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent to update the minimum supported versions for Firebase across various platforms (iOS, macOS, tvOS, watchOS) to address Xcode warnings and enable modern Swift features. It specifies the target versions (e.g., iOS 13 for most components, iOS 12 for exceptions like Analytics and Crashlytics) and mentions the affected platforms and products (\"All\"). However, there are minor ambiguities and missing details. For instance, it lacks specific guidance on how to handle dependencies or potential compatibility issues with older versions of dependent libraries or apps using Firebase. Additionally, there are no explicit examples or test cases provided to validate the changes, and edge cases (e.g., apps still targeting older iOS versions) are not addressed. The lack of detailed reproduction steps or relevant log output also slightly diminishes clarity. Overall, the goal is understandable, but some minor details could be fleshed out for a more comprehensive description.", "difficulty_explanation": "The difficulty of this task falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The changes involve updating deployment targets and Swift versions across numerous `.podspec` files and related configuration files (e.g., `Podfile`, `Package.swift`). While the changes span multiple files, they are largely repetitive and involve straightforward modifications (e.g., changing version numbers from '11.0' to '13.0' or Swift version from '5.3' to '5.9'). There is also a small code change in `FIRAppDistributionUIService.m` to remove deprecated iOS version checks, which is simple. The impact on the system's architecture is minimal as this is primarily a configuration update rather than a functional or structural change. However, the sheer number of files affected requires careful attention to ensure consistency across the codebase.\n\n2. **Number of Technical Concepts:** The task requires basic familiarity with iOS development concepts such as deployment targets, Swift versions, and CocoaPods configuration. It also involves understanding platform-specific version constraints and how they affect app compatibility. While these concepts are not overly complex for a developer familiar with iOS and Firebase, they do require some domain knowledge of Apple's ecosystem and dependency management tools. No advanced algorithms, design patterns, or deep system-level knowledge are needed.\n\n3. **Edge Cases and Error Handling:** The problem statement mentions exceptions for certain Firebase products (e.g., Analytics and Crashlytics supporting iOS 12), which introduces a minor need to handle variations in deployment targets. However, no specific edge cases or error handling requirements are detailed beyond these exceptions. The code changes do not introduce new error handling logic, though developers must ensure that the updated targets do not break existing integrations or apps relying on older versions—a potential implicit edge case not explicitly addressed in the problem.\n\n4. **Overall Complexity:** The task is relatively straightforward but requires attention to detail due to the breadth of files affected and the need to maintain consistency (e.g., ensuring all relevant Firebase components align with the new minimum versions unless explicitly excepted). It does not involve deep architectural changes or complex logic, but it does require a basic understanding of the Firebase ecosystem and iOS platform versioning.\n\nGiven these considerations, a score of 0.35 reflects an \"Easy\" task that involves simple, repetitive changes across multiple files with minimal complexity in logic or architecture, but with a slight increase in effort due to the scope of files and the need to account for platform-specific exceptions.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Empty dictionarySuggestions on Windows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\nv35.0.0-nightly.20250113\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nv35.0.0-nightly.20250109\n\n### Expected Behavior\n\nContext menu contains `dictionarySuggestions`\n\n### Actual Behavior\n\nContext menu contains `dictionarySuggestions` without any suggestions\n\n### Testcase Gist URL\n\nhttps://gist.github.com/samuelmaddock/e66dde2361de95f3c48f443a8abdd099\n\n### Additional Information\n\nRegressed by https://chromium-review.googlesource.com/c/chromium/src/+/6109477 in https://github.com/electron/electron/pull/45055\n\nRelated:\n* https://github.com/electron/electron/pull/29690\n* https://github.com/electron/electron/issues/29685\n", "patch": "diff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex fec7148a7ec5a..cea4da74f5f7f 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -140,3 +140,4 @@ revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n feat_add_signals_when_embedder_cleanup_callbacks_run_for.patch\n feat_separate_content_settings_callback_for_sync_and_async_clipboard.patch\n+fix_win32_synchronous_spellcheck.patch\ndiff --git a/patches/chromium/fix_win32_synchronous_spellcheck.patch b/patches/chromium/fix_win32_synchronous_spellcheck.patch\nnew file mode 100644\nindex 0000000000000..355c8f8e9a6ae\n--- /dev/null\n+++ b/patches/chromium/fix_win32_synchronous_spellcheck.patch\n@@ -0,0 +1,29 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Keeley Hammond <khammond@slack-corp.com>\n+Date: Wed, 19 Feb 2025 11:18:44 -0800\n+Subject: fix: re-enable synchronous spellcheck on Windows\n+\n+This fix partially reverts 6109477: Code Health:\n+Clean up stale base::Feature \"WinRetrieveSuggestionsOnlyOnDemand\"\n+https://chromium-review.googlesource.com/c/chromium/src/+/6109477\n+by re-adding a synchronous call to FillSuggestionList.\n+\n+This patch can be removed when an asynchronous spellcheck API\n+option is added to Electron.\n+\n+diff --git a/components/spellcheck/browser/windows_spell_checker.cc b/components/spellcheck/browser/windows_spell_checker.cc\n+index f5a7411037758427eddc088b5426554b4a500d33..04b3edd4d8c58d38e260cc54beb0dab86368fc25 100644\n+--- a/components/spellcheck/browser/windows_spell_checker.cc\n++++ b/components/spellcheck/browser/windows_spell_checker.cc\n+@@ -239,6 +239,11 @@ std::vector<SpellCheckResult> BackgroundHelper::RequestTextCheckForAllLanguages(\n+             (action == CORRECTIVE_ACTION_GET_SUGGESTIONS ||\n+              action == CORRECTIVE_ACTION_REPLACE)) {\n+           std::vector<std::u16string> suggestions;\n++          // TODO (vertedinde): Perform the synchronous operation of retrieving\n++          // suggestions for all misspelled words while performing a text check.\n++          FillSuggestionList(it->first,\n++            text.substr(start_index, error_length),\n++            &suggestions);\n+           result_map[std::tuple<ULONG, ULONG>(start_index, error_length)]\n+               .push_back(suggestions);\n+         }\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex f6265505f8803..a18f580f92bba 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -194,14 +194,6 @@\n #include \"content/public/browser/plugin_service.h\"\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"chrome/browser/spellchecker/spellcheck_factory.h\"\n-#include \"chrome/browser/spellchecker/spellcheck_service.h\"\n-#include \"components/spellcheck/browser/spellcheck_platform.h\"\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#include \"components/spellcheck/common/spellcheck_features.h\"\n-#endif\n-\n #if !IS_MAS_BUILD()\n #include \"chrome/browser/hang_monitor/hang_crash_dump.h\"  // nogncheck\n #endif\n@@ -1521,44 +1513,11 @@ void WebContents::RendererResponsive(\n \n bool WebContents::HandleContextMenu(content::RenderFrameHost& render_frame_host,\n                                     const content::ContextMenuParams& params) {\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (!params.misspelled_word.empty() && spellcheck::UseBrowserSpellChecker()) {\n-    SpellcheckService* spellcheck_service =\n-        SpellcheckServiceFactory::GetForContext(\n-            render_frame_host.GetBrowserContext());\n-    if (spellcheck_service) {\n-      spellcheck_platform::GetPerLanguageSuggestions(\n-          spellcheck_service->platform_spell_checker(), params.misspelled_word,\n-          base::BindOnce(&WebContents::OnGetPlatformSuggestionsComplete,\n-                         GetWeakPtr(), std::ref(render_frame_host), params));\n-    }\n-  } else {\n-#endif\n-    Emit(\"context-menu\",\n-         std::make_tuple(params, &render_frame_host,\n-                         std::optional<std::vector<std::u16string>>{}));\n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  }\n-#endif\n+  Emit(\"context-menu\", std::make_pair(params, &render_frame_host));\n \n   return true;\n }\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-void WebContents::OnGetPlatformSuggestionsComplete(\n-    content::RenderFrameHost& render_frame_host,\n-    const content::ContextMenuParams& params,\n-    const spellcheck::PerLanguageSuggestions&\n-        platform_per_language_suggestions) {\n-  std::vector<std::u16string> combined_suggestions;\n-  spellcheck::FillSuggestions(platform_per_language_suggestions,\n-                              &combined_suggestions);\n-  Emit(\"context-menu\",\n-       std::make_tuple(params, &render_frame_host,\n-                       std::make_optional(combined_suggestions)));\n-}\n-#endif\n-\n void WebContents::FindReply(content::WebContents* web_contents,\n                             int request_id,\n                             int number_of_matches,\ndiff --git a/shell/browser/api/electron_api_web_contents.h b/shell/browser/api/electron_api_web_contents.h\nindex 58a6de68d24e5..40a0502b66924 100644\n--- a/shell/browser/api/electron_api_web_contents.h\n+++ b/shell/browser/api/electron_api_web_contents.h\n@@ -57,10 +57,6 @@ class ScriptExecutor;\n }\n #endif\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-#include \"components/spellcheck/common/spellcheck_common.h\"\n-#endif\n-\n namespace blink {\n struct DeviceEmulationParams;\n // enum class PermissionType;\n@@ -761,14 +757,6 @@ class WebContents final : public ExclusiveAccessContext,\n   // Update the html fullscreen flag in both browser and renderer.\n   void UpdateHtmlApiFullscreen(bool fullscreen);\n \n-#if BUILDFLAG(IS_WIN) && BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  void OnGetPlatformSuggestionsComplete(\n-      content::RenderFrameHost& render_frame_host,\n-      const content::ContextMenuParams& params,\n-      const spellcheck::PerLanguageSuggestions&\n-          platform_per_language_suggestions);\n-#endif\n-\n   v8::Global<v8::Value> session_;\n   v8::Global<v8::Value> devtools_web_contents_;\n   v8::Global<v8::Value> debugger_;\ndiff --git a/shell/common/gin_converters/content_converter.cc b/shell/common/gin_converters/content_converter.cc\nindex 7e593c324a0dd..d5a257b8f24ac 100644\n--- a/shell/common/gin_converters/content_converter.cc\n+++ b/shell/common/gin_converters/content_converter.cc\n@@ -88,7 +88,8 @@ v8::Local<v8::Value> Converter<blink::mojom::MenuItem::Type>::ToV8(\n v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n     v8::Isolate* isolate,\n     const ContextMenuParamsWithRenderFrameHost& val) {\n-  auto [params, render_frame_host, optional_suggestions] = val;\n+  const auto& params = val.first;\n+  content::RenderFrameHost* render_frame_host = val.second;\n   auto dict = gin_helper::Dictionary::CreateEmpty(isolate);\n   dict.SetGetter(\"frame\", render_frame_host, v8::DontEnum);\n   dict.Set(\"x\", params.x);\n@@ -113,11 +114,7 @@ v8::Local<v8::Value> Converter<ContextMenuParamsWithRenderFrameHost>::ToV8(\n   dict.Set(\"misspelledWord\", params.misspelled_word);\n   dict.Set(\"selectionRect\", params.selection_rect);\n #if BUILDFLAG(ENABLE_BUILTIN_SPELLCHECKER)\n-  if (optional_suggestions) {\n-    dict.Set(\"dictionarySuggestions\", optional_suggestions.value());\n-  } else {\n-    dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n-  }\n+  dict.Set(\"dictionarySuggestions\", params.dictionary_suggestions);\n   dict.Set(\"spellcheckEnabled\", params.spellcheck_enabled);\n #else\n   dict.Set(\"spellcheckEnabled\", false);\ndiff --git a/shell/common/gin_converters/content_converter.h b/shell/common/gin_converters/content_converter.h\nindex 1e1f26012f874..2fa5f7f118df9 100644\n--- a/shell/common/gin_converters/content_converter.h\n+++ b/shell/common/gin_converters/content_converter.h\n@@ -26,9 +26,7 @@ struct NativeWebKeyboardEvent;\n }\n \n using ContextMenuParamsWithRenderFrameHost =\n-    std::tuple<content::ContextMenuParams,\n-               content::RenderFrameHost*,\n-               std::optional<std::vector<std::u16string>>>;\n+    std::pair<content::ContextMenuParams, content::RenderFrameHost*>;\n \n namespace gin {\n \n", "instance_id": "electron__electron-45712", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the context menu on Windows in Electron does not show dictionary suggestions for misspelled words after a specific Chromium update. It provides relevant details such as the Electron version, operating system, and links to related issues and changes in Chromium that caused the regression. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected format or source of the dictionary suggestions, nor does it mention specific edge cases or constraints (e.g., language support, performance expectations). Additionally, while the test case gist and related issues provide context, the statement lacks a detailed description of the desired behavior beyond \"context menu contains dictionarySuggestions.\" Overall, it is clear enough to understand the goal but leaves some minor aspects open to interpretation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files and components, including a patch to Chromium's spellcheck module and modifications to Electron's web contents handling. This requires understanding the interaction between Electron and Chromium's codebase, which is non-trivial. Second, the technical concepts involved include familiarity with Chromium's spellcheck architecture, Windows-specific spellchecking APIs, and Electron's event emission system for context menus. Additionally, the changes involve reverting a specific Chromium update and reintroducing synchronous spellcheck behavior, which demands careful consideration of potential performance impacts and compatibility issues. Third, while edge cases are not explicitly mentioned in the problem statement, the nature of spellchecking (e.g., handling different languages, empty or invalid input, or large text blocks) implies the need for robust error handling, though the provided code changes do not extensively address this. Finally, the impact on the system is moderate, as it affects a user-facing feature (context menu suggestions) and requires ensuring that the synchronous call does not degrade performance. Overall, solving this requires a deep understanding of the codebase and careful implementation, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "segfault when moving WebContentsView between BrowserWindows\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33, 34\n\n### What operating system(s) are you using?\n\nUbuntu\n\n### Operating System Version\n\n23.04\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nWhen moving WebContentsViews between different browser windows, the app doesn't crash\n\n### Actual Behavior\n\nWhen moving WebContentsViews from BrowserWindow A to BrowserWindow B and back to BrowserWindow A, the app crashes. Going just from A BrowserWindow A to BrowserWindow B works, but then back to A segfaults.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/Kilian/8014d47a193a8f66b05f490def934166\n\n### Additional Information\n\n_No response_\n", "patch": "diff --git a/shell/browser/api/electron_api_view.cc b/shell/browser/api/electron_api_view.cc\nindex b01a08be88cb7..c65f80b164fec 100644\n--- a/shell/browser/api/electron_api_view.cc\n+++ b/shell/browser/api/electron_api_view.cc\n@@ -124,6 +124,15 @@ struct Converter<views::FlexAllocationOrder> {\n   }\n };\n \n+template <>\n+struct Converter<electron::api::View> {\n+  static bool FromV8(v8::Isolate* isolate,\n+                     v8::Local<v8::Value> val,\n+                     electron::api::View* out) {\n+    return gin::ConvertFromV8(isolate, val, &out);\n+  }\n+};\n+\n template <>\n struct Converter<views::SizeBound> {\n   static v8::Local<v8::Value> ToV8(v8::Isolate* isolate,\n@@ -257,11 +266,13 @@ void View::RemoveChildView(gin::Handle<View> child) {\n #if BUILDFLAG(IS_MAC)\n     ScopedCAActionDisabler disable_animations;\n #endif\n+    // Remove from child_views first so that OnChildViewRemoved doesn't try to\n+    // remove it again\n+    child_views_.erase(it);\n     // It's possible for the child's view to be invalid here\n     // if the child's webContents was closed or destroyed.\n     if (child->view())\n       view_->RemoveChildView(child->view());\n-    child_views_.erase(it);\n   }\n }\n \n@@ -388,6 +399,19 @@ void View::OnViewIsDeleting(views::View* observed_view) {\n   view_ = nullptr;\n }\n \n+void View::OnChildViewRemoved(views::View* observed_view, views::View* child) {\n+  v8::Isolate* isolate = JavascriptEnvironment::GetIsolate();\n+  auto it = std::ranges::find_if(\n+      child_views_, [&](const v8::Global<v8::Object>& child_view) {\n+        View current_view;\n+        gin::ConvertFromV8(isolate, child_view.Get(isolate), &current_view);\n+        return current_view.view()->GetID() == child->GetID();\n+      });\n+  if (it != child_views_.end()) {\n+    child_views_.erase(it);\n+  }\n+}\n+\n // static\n gin_helper::WrappableBase* View::New(gin::Arguments* args) {\n   View* view = new View();\ndiff --git a/shell/browser/api/electron_api_view.h b/shell/browser/api/electron_api_view.h\nindex 6eeb16521906f..1b0a3f815a6f9 100644\n--- a/shell/browser/api/electron_api_view.h\n+++ b/shell/browser/api/electron_api_view.h\n@@ -47,6 +47,8 @@ class View : public gin_helper::EventEmitter<View>,\n   // views::ViewObserver\n   void OnViewBoundsChanged(views::View* observed_view) override;\n   void OnViewIsDeleting(views::View* observed_view) override;\n+  void OnChildViewRemoved(views::View* observed_view,\n+                          views::View* child) override;\n \n   views::View* view() const { return view_; }\n   std::optional<int> border_radius() const { return border_radius_; }\ndiff --git a/spec/fixtures/crash-cases/webview-move-between-windows/index.js b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\nnew file mode 100644\nindex 0000000000000..de9053ec65ca9\n--- /dev/null\n+++ b/spec/fixtures/crash-cases/webview-move-between-windows/index.js\n@@ -0,0 +1,31 @@\n+const { app, BrowserWindow, WebContentsView } = require('electron');\n+\n+function createWindow () {\n+  // Create the browser window.\n+  const mainWindow = new BrowserWindow();\n+  const secondaryWindow = new BrowserWindow();\n+\n+  const contentsView = new WebContentsView();\n+  mainWindow.contentView.addChildView(contentsView);\n+  mainWindow.webContents.setDevToolsWebContents(contentsView.webContents);\n+  mainWindow.openDevTools();\n+\n+  contentsView.setBounds({\n+    x: 400,\n+    y: 0,\n+    width: 400,\n+    height: 600\n+  });\n+\n+  setTimeout(() => {\n+    secondaryWindow.contentView.addChildView(contentsView);\n+    setTimeout(() => {\n+      mainWindow.contentView.addChildView(contentsView);\n+      app.quit();\n+    }, 1000);\n+  }, 1000);\n+}\n+\n+app.whenReady().then(() => {\n+  createWindow();\n+});\n", "instance_id": "electron__electron-44599", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a segmentation fault occurs when moving WebContentsView between BrowserWindows, specifically when moving it back to the original window. The expected behavior (no crash) and actual behavior (crash on moving back) are explicitly stated, and a test case gist is provided, which adds to the clarity. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify the exact conditions or configurations that might trigger the crash beyond the basic scenario (e.g., specific WebContentsView states, window configurations, or system-specific behaviors). Additionally, there are no explicit mentions of constraints or edge cases to consider, which could be critical for a complete understanding of the issue. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes, while localized to a few files (electron_api_view.cc and electron_api_view.h), involves critical modifications to the view management logic in a complex codebase like Electron, which integrates with Chromium's rendering and windowing systems. Understanding the interaction between WebContentsView, BrowserWindow, and the underlying views::View hierarchy requires a deep knowledge of Electron's architecture and Chromium's view system. Second, the number of technical concepts involved is significant: familiarity with C++ (including templates and smart pointers), V8 JavaScript engine bindings (gin library), Electron's API design, and event handling for view changes are all necessary. Third, the changes impact how child views are managed and removed, which could introduce subtle bugs or performance issues if not handled correctly. While the provided code changes address the issue by adjusting the order of operations in RemoveChildView and adding a new observer method (OnChildViewRemoved), ensuring correctness across various scenarios (e.g., invalid views, concurrent modifications) adds complexity. Finally, edge cases such as closed or destroyed WebContents, multiple view movements, or platform-specific behaviors (noted with macOS-specific code) must be considered, though not fully detailed in the problem statement. Overall, this problem requires a solid understanding of the codebase and careful handling of view lifecycle events, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "instance_id": "electron__electron-41707", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: Electron crashes when closing a notification in a portal environment with libnotify 0.8.3. It provides detailed context, including the affected Electron versions, operating system details, and a step-by-step analysis of the crash's root cause. The expected behavior (no crash on `notification.close()`) and actual behavior (crash in portal environments) are explicitly stated. Additionally, links to relevant code in the Electron repository and an external minimal reproducible example (MRE) are provided, which aids in understanding the issue. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly mention specific constraints or edge cases beyond the portal environment (e.g., are there other environmental factors or configurations that could influence the crash?). Furthermore, while the analysis is detailed, it assumes some familiarity with the Electron notification system and libnotify internals, which might not be immediately clear to someone unfamiliar with these components. Overall, the statement is valid and clear but lacks exhaustive detail on edge cases or broader implications.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves intricate interactions between Electron's notification system and libnotify's behavior in portal environments (e.g., Flatpak/Snap). Understanding the crash requires tracing the signal handling and object lifecycle management in a C++ codebase, which adds to the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, affecting only two files (`libnotify_notification.cc` and `libnotify_notification.h`). The modification introduces a boolean flag (`on_dismissing_`) to track whether the dismissal is in progress, preventing premature destruction of the notification object. However, this change requires a deep understanding of the notification lifecycle and signal handling in the Electron codebase. While the change itself is small (a few lines), it impacts a critical part of the system (notification handling), and a mistake here could introduce new bugs or crashes. The change does not significantly alter the system's architecture but does require careful consideration of object ownership and callback behavior.\n\n3. **Number of Technical Concepts to Understand**: Solving this problem requires familiarity with several advanced concepts:\n   - C++ memory management and object lifecycle (e.g., avoiding use-after-free issues when `delete` is called on `this`).\n   - GLib signal handling (e.g., understanding how `g_signal_emit` triggers callbacks like `OnNotificationClosed`).\n   - Electron's notification system and its interaction with native libraries like libnotify.\n   - Portal environments (Flatpak/Snap) and their impact on notification behavior, which is a domain-specific nuance.\n   These concepts are moderately to highly complex, especially for developers without prior experience in Electron or GLib-based systems.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement highlights a specific edge case (closing notifications in a portal environment with libnotify 0.8.3), and the code change addresses this by preventing premature destruction during dismissal. However, additional edge cases might exist, such as concurrent notification operations, different libnotify versions, or other environmental factors not mentioned in the statement. The code change modifies error handling logic indirectly by avoiding a crash, but it does not introduce extensive new error handling. The complexity of edge cases is moderate, as the primary issue is well-defined, but ensuring robustness across all scenarios could require further investigation.\n\nOverall, this problem is hard (0.65) because it demands a deep understanding of Electron's internals, C++ memory management, and GLib signal handling, along with domain-specific knowledge of portal environments. The code change, while small, addresses a critical bug with potential for subtle side effects if not handled correctly. It is not in the \"Very Hard\" range (0.8-1.0) because the scope of changes is limited, and the problem does not involve system-level redesign or highly intricate algorithms.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Animation Node Blend Tree Slider drag handle not aligning when zoomed\n### Tested versions\n\nReproducible in: \nv4.4.1.stable.mono.official [49a5bc7b6]\nv4.4.stable.mono.official [4c311cbee] \n\nWorking correctly in:\nv4.3.stable.mono.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 Threads)\n\n### Issue description\n\nWhen using an AnimationNodeBlendTree and zooming in on sliders like the blend slider, the handle for grabbing is offset from the view when it should remain on the line \n\n4.3 Working correctly:\n![Image](https://github.com/user-attachments/assets/e1fb6ded-e1e6-458e-8797-c552f6d2c23a)\n\n4.4.1 being offset:\n![Image](https://github.com/user-attachments/assets/4eec11e9-6e98-4e7d-9685-58f7a04d6cbc)\n\n### Steps to reproduce\n\n* Open a new project\n* Add an AnimationTree node\n* Add an AnimationNodeBlendTree to it\n* In the AnimationTree window right click and add a blend2 \n* Hover the blend slider and zoom in to see that the offset of the handle is not on the slider\n\n\n### Minimal reproduction project (MRP)\n\nTo ensure it was not my theme settings I reset all my theme settings in both 4.4 and 4.4.1\n\nI then downloaded 4.3 and set up the project again and it was not the case. \n\nHere's my a copy of a project with a scene set up in 4.4.1, but it's pretty easy to set up\n\n[BlendTreeIssue_4.4.1.zip](https://github.com/user-attachments/files/19600739/BlendTreeIssue_4.4.1.zip)\n\n", "patch": "diff --git a/editor/gui/editor_spin_slider.cpp b/editor/gui/editor_spin_slider.cpp\nindex e68e3dcc9f42..99acf4e171dd 100644\n--- a/editor/gui/editor_spin_slider.cpp\n+++ b/editor/gui/editor_spin_slider.cpp\n@@ -435,10 +435,8 @@ void EditorSpinSlider::_draw_spin_slider() {\n \t\t\t\t\tgrabber->set_texture(grabber_tex);\n \t\t\t\t}\n \n-\t\t\t\tVector2 scale = get_global_transform_with_canvas().get_scale();\n-\t\t\t\tgrabber->set_scale(scale);\n \t\t\t\tgrabber->reset_size();\n-\t\t\t\tgrabber->set_position((grabber_rect.get_center() - grabber->get_size() * 0.5) * scale);\n+\t\t\t\tgrabber->set_position(grabber_rect.get_center() - grabber->get_size() * 0.5);\n \n \t\t\t\tif (mousewheel_over_grabber) {\n \t\t\t\t\tInput::get_singleton()->warp_mouse(grabber->get_position() + grabber_rect.size);\n", "instance_id": "godotengine__godot-105039", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of the software where the bug is reproducible, steps to reproduce, and visual evidence through images. It also includes system information and a minimal reproduction project, which aids in understanding the context. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior beyond \"the handle should remain on the line,\" and it lacks discussion on potential edge cases or constraints (e.g., different zoom levels, themes, or screen resolutions). Additionally, there is no mention of performance or compatibility requirements for the fix. Despite these minor omissions, the issue is well-documented and actionable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The issue involves a UI rendering bug in the Godot engine's editor interface, specifically with the positioning of a slider handle when zoomed. The provided code change is minimal, confined to a single file (`editor_spin_slider.cpp`), and involves removing a scaling factor from the position calculation of the grabber handle. This suggests the root cause is a straightforward misapplication of scaling in the rendering logic, and the fix requires only a basic understanding of GUI rendering and coordinate transformations in the context of the Godot engine.\n\nAnalyzing the factors:\n1. **Scope and Depth of Code Changes**: The change is localized to a few lines in a single file, with no apparent impact on other modules or the broader architecture of the system. The modification is small and focused.\n2. **Technical Concepts**: Solving this requires a basic understanding of GUI rendering, specifically how transformations (like scaling) affect object positioning in a canvas or viewport. Familiarity with Godot's internal rendering pipeline or editor GUI components is helpful but not deeply complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic graphics rendering are needed.\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code change does not introduce or modify error handling. However, potential edge cases (e.g., extreme zoom levels, different screen resolutions, or custom themes) might need consideration during testing, though they do not appear to complicate the fix itself.\n4. **Overall Complexity**: The fix is a simple adjustment to a position calculation, likely requiring minimal debugging or testing beyond verifying the visual alignment of the slider handle at different zoom levels.\n\nGiven the simplicity of the change, the localized scope, and the lack of complex technical concepts or significant edge case handling, I assign a difficulty score of 0.25. This reflects an easy problem that a developer with basic to intermediate experience in GUI programming or the Godot engine could resolve with minimal effort.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Sensitivity settings don't work in embedded game window\n### Tested versions\n\nv4.4.stable.official [4c311cbee]\n\n### System information\n\nGodot v4.4.stable - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 960 (nvidia; 550.120) - AMD FX(tm)-6300 Six-Core Processor (6 threads)\n\n### Issue description\n\nThe embedded game window doesn't listen to the sensitivity settings in Editor Settings > Editors > 3D. I think it just uses the default value for every option.\n\nhttps://github.com/user-attachments/assets/b76f5570-d0c7-45b1-8d50-14649f853cf1\n\n### Steps to reproduce\n\n1. Change one of the sensitivity settings in Editor Settings > Editors > 3D such as \"Orbit Sensitivity\" or \"Freelook Sensitivity\".\n2. Play the game, in embedded game window click the camera icon and 3D. The sensitivity hasn't changed.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex bc3b4ceeb2b7..fa9dd87bc491 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -65,7 +65,18 @@ void GameViewDebugger::_session_started(Ref<EditorDebuggerSession> p_session) {\n \tsettings[\"editors/panning/warped_mouse_panning\"] = EDITOR_GET(\"editors/panning/warped_mouse_panning\");\n \tsettings[\"editors/panning/2d_editor_pan_speed\"] = EDITOR_GET(\"editors/panning/2d_editor_pan_speed\");\n \tsettings[\"canvas_item_editor/pan_view\"] = DebuggerMarshalls::serialize_key_shortcut(ED_GET_SHORTCUT(\"canvas_item_editor/pan_view\"));\n+#ifndef _3D_DISABLED\n+\tsettings[\"editors/3d/default_fov\"] = EDITOR_GET(\"editors/3d/default_fov\");\n+\tsettings[\"editors/3d/default_z_near\"] = EDITOR_GET(\"editors/3d/default_z_near\");\n+\tsettings[\"editors/3d/default_z_far\"] = EDITOR_GET(\"editors/3d/default_z_far\");\n+\tsettings[\"editors/3d/navigation/invert_x_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_x_axis\");\n+\tsettings[\"editors/3d/navigation/invert_y_axis\"] = EDITOR_GET(\"editors/3d/navigation/invert_y_axis\");\n+\tsettings[\"editors/3d/navigation/warped_mouse_panning\"] = EDITOR_GET(\"editors/3d/navigation/warped_mouse_panning\");\n \tsettings[\"editors/3d/freelook/freelook_base_speed\"] = EDITOR_GET(\"editors/3d/freelook/freelook_base_speed\");\n+\tsettings[\"editors/3d/freelook/freelook_sensitivity\"] = EDITOR_GET(\"editors/3d/freelook/freelook_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/orbit_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/orbit_sensitivity\");\n+\tsettings[\"editors/3d/navigation_feel/translation_sensitivity\"] = EDITOR_GET(\"editors/3d/navigation_feel/translation_sensitivity\");\n+#endif // _3D_DISABLED\n \tsetup_data.append(settings);\n \tp_session->send_message(\"scene:runtime_node_select_setup\", setup_data);\n \ndiff --git a/scene/debugger/scene_debugger.cpp b/scene/debugger/scene_debugger.cpp\nindex c620c5fd5c80..5661268f04c3 100644\n--- a/scene/debugger/scene_debugger.cpp\n+++ b/scene/debugger/scene_debugger.cpp\n@@ -1261,7 +1261,18 @@ void RuntimeNodeSelect::_setup(const Dictionary &p_settings) {\n #ifndef _3D_DISABLED\n \tcursor = Cursor();\n \n-\tfreelook_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", FREELOOK_BASE_SPEED);\n+\tcamera_fov = p_settings.get(\"editors/3d/default_fov\", 70);\n+\tcamera_znear = p_settings.get(\"editors/3d/default_z_near\", 0.05);\n+\tcamera_zfar = p_settings.get(\"editors/3d/default_z_far\", 4'000);\n+\n+\tinvert_x_axis = p_settings.get(\"editors/3d/navigation/invert_x_axis\", false);\n+\tinvert_y_axis = p_settings.get(\"editors/3d/navigation/invert_y_axis\", false);\n+\twarped_mouse_panning_3d = p_settings.get(\"editors/3d/navigation/warped_mouse_panning\", true);\n+\n+\tfreelook_base_speed = p_settings.get(\"editors/3d/freelook/freelook_base_speed\", 5);\n+\tfreelook_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/freelook/freelook_sensitivity\", 0.25));\n+\torbit_sensitivity = Math::deg_to_rad((real_t)p_settings.get(\"editors/3d/navigation_feel/orbit_sensitivity\", 0.004));\n+\ttranslation_sensitivity = p_settings.get(\"editors/3d/navigation_feel/translation_sensitivity\", 1);\n \n \t/// 3D Selection Box Generation\n \t// Copied from the Node3DEditor implementation.\n@@ -1342,7 +1353,7 @@ void RuntimeNodeSelect::_set_camera_override_enabled(bool p_enabled) {\n \t\t_update_view_2d();\n \n \t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \t}\n #endif // _3D_DISABLED\n }\n@@ -1445,7 +1456,7 @@ void RuntimeNodeSelect::_process_frame() {\n \t\t\tdirection -= up;\n \t\t}\n \n-\t\treal_t speed = freelook_speed;\n+\t\treal_t speed = freelook_base_speed;\n \t\tif (input->is_physical_key_pressed(Key::SHIFT)) {\n \t\t\tspeed *= 3.0;\n \t\t}\n@@ -2011,19 +2022,19 @@ bool RuntimeNodeSelect::_handle_3d_input(const Ref<InputEvent> &p_event) {\n \t\t\tswitch (k->get_physical_keycode()) {\n \t\t\t\tcase Key::EQUAL: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale - 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::MINUS: {\n \t\t\t\t\tcursor.fov_scale = CLAMP(cursor.fov_scale + 0.05, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n \t\t\t\tcase Key::KEY_0: {\n \t\t\t\t\tcursor.fov_scale = 1;\n-\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\t\t\t\t\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov, camera_znear, camera_zfar);\n \n \t\t\t\t\treturn true;\n \t\t\t\t} break;\n@@ -2063,33 +2074,37 @@ void RuntimeNodeSelect::_set_camera_freelook_enabled(bool p_enabled) {\n }\n \n void RuntimeNodeSelect::_cursor_scale_distance(real_t p_scale) {\n-\treal_t min_distance = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_distance = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_distance = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_distance = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tcursor.distance = CLAMP(cursor.distance * p_scale, min_distance, max_distance);\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n void RuntimeNodeSelect::_scale_freelook_speed(real_t p_scale) {\n-\treal_t min_speed = MAX(CAMERA_ZNEAR * 4, VIEW_3D_MIN_ZOOM);\n-\treal_t max_speed = MIN(CAMERA_ZFAR / 4, VIEW_3D_MAX_ZOOM);\n+\treal_t min_speed = MAX(camera_znear * 4, VIEW_3D_MIN_ZOOM);\n+\treal_t max_speed = MIN(camera_zfar / 4, VIEW_3D_MAX_ZOOM);\n \tif (unlikely(min_speed > max_speed)) {\n-\t\tfreelook_speed = (min_speed + max_speed) / 2;\n+\t\tfreelook_base_speed = (min_speed + max_speed) / 2;\n \t} else {\n-\t\tfreelook_speed = CLAMP(freelook_speed * p_scale, min_speed, max_speed);\n+\t\tfreelook_base_speed = CLAMP(freelook_base_speed * p_scale, min_speed, max_speed);\n \t}\n }\n \n void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(), root->get_size()));\n \tconst Transform3D prev_camera_transform = _get_cursor_transform();\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * freelook_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * freelook_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tcursor.y_rot += relative.x * freelook_sensitivity;\n \n \t// Look is like the opposite of Orbit: the focus point rotates around the camera.\n \tTransform3D camera_transform = _get_cursor_transform();\n@@ -2104,8 +2119,8 @@ void RuntimeNodeSelect::_cursor_look(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n-\tconst real_t pan_speed = 1 / 150.0;\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst real_t pan_speed = translation_sensitivity / 150.0;\n \n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2123,17 +2138,35 @@ void RuntimeNodeSelect::_cursor_pan(Ref<InputEventWithModifiers> p_event) {\n void RuntimeNodeSelect::_cursor_orbit(Ref<InputEventWithModifiers> p_event) {\n \tWindow *root = SceneTree::get_singleton()->get_root();\n \t// Reduce all sides of the area by 1, so warping works when windows are maximized/fullscreen.\n-\tconst Vector2 relative = Input::get_singleton()->warp_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n+\tconst Vector2 relative = _get_warped_mouse_motion(p_event, Rect2(Vector2(1, 1), root->get_size() - Vector2(2, 2)));\n \n-\tcursor.x_rot += relative.y * RADS_PER_PIXEL;\n+\tif (invert_y_axis) {\n+\t\tcursor.x_rot -= relative.y * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.x_rot += relative.y * orbit_sensitivity;\n+\t}\n \t// Clamp the Y rotation to roughly -90..90 degrees so the user can't look upside-down and end up disoriented.\n \tcursor.x_rot = CLAMP(cursor.x_rot, -1.57, 1.57);\n \n-\tcursor.y_rot += relative.x * RADS_PER_PIXEL;\n+\tif (invert_x_axis) {\n+\t\tcursor.y_rot -= relative.x * orbit_sensitivity;\n+\t} else {\n+\t\tcursor.y_rot += relative.x * orbit_sensitivity;\n+\t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n }\n \n+Point2 RuntimeNodeSelect::_get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_area) const {\n+\tERR_FAIL_COND_V(p_event.is_null(), Point2());\n+\n+\tif (warped_mouse_panning_3d) {\n+\t\treturn Input::get_singleton()->warp_mouse_motion(p_event, p_area);\n+\t}\n+\n+\treturn p_event->get_relative();\n+}\n+\n Transform3D RuntimeNodeSelect::_get_cursor_transform() {\n \tTransform3D camera_transform;\n \tcamera_transform.translate_local(cursor.pos);\n@@ -2158,13 +2191,13 @@ void RuntimeNodeSelect::_reset_camera_3d() {\n \t\tcursor.x_rot = -camera->get_global_rotation().x;\n \t\tcursor.y_rot = -camera->get_global_rotation().y;\n \n-\t\tcursor.fov_scale = CLAMP(camera->get_fov() / CAMERA_BASE_FOV, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n+\t\tcursor.fov_scale = CLAMP(camera->get_fov() / camera_fov, CAMERA_MIN_FOV_SCALE, CAMERA_MAX_FOV_SCALE);\n \t} else {\n \t\tcursor.fov_scale = 1.0;\n \t}\n \n \tSceneTree::get_singleton()->get_root()->set_camera_3d_override_transform(_get_cursor_transform());\n-\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(CAMERA_BASE_FOV * cursor.fov_scale, CAMERA_ZNEAR, CAMERA_ZFAR);\n+\tSceneTree::get_singleton()->get_root()->set_camera_3d_override_perspective(camera_fov * cursor.fov_scale, camera_znear, camera_zfar);\n }\n #endif // _3D_DISABLED\n #endif\ndiff --git a/scene/debugger/scene_debugger.h b/scene/debugger/scene_debugger.h\nindex 5a56ea9d99b7..b0a365fddfcb 100644\n--- a/scene/debugger/scene_debugger.h\n+++ b/scene/debugger/scene_debugger.h\n@@ -242,20 +242,26 @@ class RuntimeNodeSelect : public Object {\n \tconst double VIEW_3D_MAX_ZOOM = 1'000'000'000'000;\n #else\n \tconst float VIEW_3D_MAX_ZOOM = 10'000;\n-#endif\n-\tconst float CAMERA_ZNEAR = 0.05;\n-\tconst float CAMERA_ZFAR = 4'000;\n+#endif // REAL_T_IS_DOUBLE\n \n-\tconst float CAMERA_BASE_FOV = 75;\n \tconst float CAMERA_MIN_FOV_SCALE = 0.1;\n \tconst float CAMERA_MAX_FOV_SCALE = 2.5;\n \n-\tconst float FREELOOK_BASE_SPEED = 4;\n-\tconst float RADS_PER_PIXEL = 0.004;\n-\n \tbool camera_first_override = true;\n \tbool camera_freelook = false;\n-\treal_t freelook_speed = FREELOOK_BASE_SPEED;\n+\n+\treal_t camera_fov = 0;\n+\treal_t camera_znear = 0;\n+\treal_t camera_zfar = 0;\n+\n+\tbool invert_x_axis = false;\n+\tbool invert_y_axis = false;\n+\tbool warped_mouse_panning_3d = false;\n+\n+\treal_t freelook_base_speed = 0;\n+\treal_t freelook_sensitivity = 0;\n+\treal_t orbit_sensitivity = 0;\n+\treal_t translation_sensitivity = 0;\n \n \tVector2 previous_mouse_position;\n \n@@ -267,7 +273,7 @@ class RuntimeNodeSelect : public Object {\n \tRID sbox_3d_instance_xray_ofs;\n \tTransform3D sbox_3d_xform;\n \tAABB sbox_3d_bounds;\n-#endif\n+#endif // _3D_DISABLED\n \n \tPoint2 selection_position = Point2(INFINITY, INFINITY);\n \tbool list_shortcut_pressed = false;\n@@ -314,6 +320,7 @@ class RuntimeNodeSelect : public Object {\n \tvoid _cursor_look(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_pan(Ref<InputEventWithModifiers> p_event);\n \tvoid _cursor_orbit(Ref<InputEventWithModifiers> p_event);\n+\tPoint2 _get_warped_mouse_motion(const Ref<InputEventMouseMotion> &p_event, Rect2 p_border) const;\n \tTransform3D _get_cursor_transform();\n \tvoid _reset_camera_3d();\n #endif\n", "instance_id": "godotengine__godot-103758", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the embedded game window in Godot v4.4 does not respect the sensitivity settings configured in the Editor Settings for 3D navigation (e.g., Orbit Sensitivity, Freelook Sensitivity). It provides specific steps to reproduce the issue, system information, and a reference to the affected version. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied but not explicitly stated (e.g., how should the sensitivity settings affect the embedded window?). Additionally, there is no mention of edge cases, potential constraints, or specific requirements for the fix (e.g., performance considerations or compatibility with other features). The lack of a minimal reproduction project (MRP) also slightly hinders clarity, as it would help in quickly verifying the issue. Overall, the problem is understandable, but minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes involves multiple files (`game_view_plugin.cpp`, `scene_debugger.cpp`, and `scene_debugger.h`) within the Godot engine, requiring an understanding of how settings are passed from the editor to the runtime environment. The changes are not trivial; they involve adding new settings for 3D navigation and sensitivity, updating how these settings are applied to camera controls, and handling mouse input modifications (e.g., warping and sensitivity adjustments). Second, the technical concepts required include familiarity with Godot's internal architecture (editor-runtime communication, camera systems), C++ programming (including memory management and type handling), and 3D graphics concepts (e.g., field of view, camera transformations, and sensitivity scaling). Third, while the problem statement does not explicitly mention edge cases, the code changes introduce logic for handling mouse input inversion, warped panning, and camera bounds, which suggests some complexity in ensuring robust behavior across different user configurations. However, the changes do not appear to impact the broader system architecture or require advanced domain-specific knowledge beyond typical game engine development. The amount of code change is moderate, with significant logic updates but not a complete overhaul. Therefore, a difficulty score of 0.55 reflects the need for a solid understanding of multiple concepts and careful implementation across several files, placing it in the medium difficulty category.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Persistent window state does not work for linux X11 gnome-shell 'tiled/docked/snapped' editor windows\n### Tested versions\n\n- Reproducible on Godot 4.4-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\n[Persistent window state](https://godotengine.org/releases/4.4/#persistent-window-state) doesn't work if your window is 'tiled' in X11 gnome.\n\nTested on X11 GNOME Shell 42.9  Xorg: 1:7.7+23ubuntu2\n\n\nIt looks like `_NET_WM_STATE` is `..._MAXIMIZED_VERT` which isn't the same as maximized..\n\nThe window geometry is `0,65+2558x1375`\n\nBut when I re-open it becomes `..._MAXIMIZED_VERT | ..._MAXIMIZED_HORIZ`\nand the window geometry is  `0,64+5120x1376`\n\nBEFORE closing\n```\n_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 89\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 65\n                program specified size: 2558 by 1375\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4045156\n```\n\nAFTER re-opening\n```_NET_WM_STATE(ATOM) = _NET_WM_STATE_MAXIMIZED_HORZ, _NET_WM_STATE_MAXIMIZED_VERT\nWM_STATE(WM_STATE):\n                window state: Normal\n                icon window: 0x0\n_NET_WM_DESKTOP(CARDINAL) = 1\n_GTK_EDGE_CONSTRAINTS(CARDINAL) = 85\n_NET_FRAME_EXTENTS(CARDINAL) = 0, 0, 37, 0\n_NET_WM_ALLOWED_ACTIONS(ATOM) = _NET_WM_ACTION_MOVE, _NET_WM_ACTION_RESIZE, _NET_WM_ACTION_FULLSCREEN, _NET_WM_ACTION_MINIMIZE, _NET_WM_ACTION_SHADE, _NET_WM_ACTION_MAXIMIZE_HORZ, _NET_WM_ACTION_MAXIMIZE_VERT, _NET_WM_ACTION_CHANGE_DESKTOP, _NET_WM_ACTION_CLOSE, _NET_WM_ACTION_ABOVE, _NET_WM_ACTION_BELOW\nWM_NORMAL_HINTS(WM_SIZE_HINTS):\n                program specified location: 0, 64\n                program specified size: 5120 by 1376\n                program specified minimum size: 1024 by 600\n                program specified maximum size: 32768 by 32768\n_NET_WM_WINDOW_TYPE(ATOM) = _NET_WM_WINDOW_TYPE_NORMAL\nWM_CLASS(STRING) = \"Godot_Editor\", \"Godot\"\nXdndAware(ATOM) = BITMAP\nWM_PROTOCOLS(ATOM): protocols  WM_DELETE_WINDOW\nWM_NAME(STRING) = \"(*) main.tscn - Ultimate Fabric Challenge - Godot Engine\"\n_NET_WM_PID(CARDINAL) = 4048202\n```\n\n### Steps to reproduce\n\nRe-open the window in gnome window manager after snapping to the left or right\n\n### Minimal reproduction project (MRP)\n\nno MRP possible?\n", "patch": "diff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex 26c94bf25cf1..ead01551939f 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -2563,7 +2563,8 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\tAtom *atoms = (Atom *)data;\n \t\tAtom wm_act_max_horz;\n \t\tAtom wm_act_max_vert;\n-\t\tif (strcmp(p_atom_name, \"_NET_WM_STATE\") == 0) {\n+\t\tbool checking_state = strcmp(p_atom_name, \"_NET_WM_STATE\") == 0;\n+\t\tif (checking_state) {\n \t\t\twm_act_max_horz = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_HORZ\", False);\n \t\t\twm_act_max_vert = XInternAtom(x11_display, \"_NET_WM_STATE_MAXIMIZED_VERT\", False);\n \t\t} else {\n@@ -2581,9 +2582,16 @@ bool DisplayServerX11::_window_maximize_check(WindowID p_window, const char *p_a\n \t\t\t\tfound_wm_act_max_vert = true;\n \t\t\t}\n \n-\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n-\t\t\t\tretval = true;\n-\t\t\t\tbreak;\n+\t\t\tif (checking_state) {\n+\t\t\t\tif (found_wm_act_max_horz && found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\tif (found_wm_act_max_horz || found_wm_act_max_vert) {\n+\t\t\t\t\tretval = true;\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \t\t\t}\n \t\t}\n \n", "instance_id": "godotengine__godot-103526", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the persistent window state feature in Godot 4.4-stable does not work correctly for tiled/docked/snapped windows under the X11 GNOME Shell environment on Linux. It provides detailed system information, specific versions tested, and logs showing the difference in window state before and after reopening (e.g., changes in `_NET_WM_STATE` from `_MAXIMIZED_VERT` to both `_MAXIMIZED_HORZ` and `_MAXIMIZED_VERT`). Steps to reproduce are provided, though they are minimal. However, there are minor ambiguities and missing details. For instance, the expected behavior is not explicitly defined—should the window retain its exact tiled state, or is there a specific desired outcome? Additionally, edge cases or other window manager behaviors are not mentioned, and there is no minimal reproduction project (MRP), which could hinder debugging. Overall, the problem is valid and mostly clear, but these minor gaps prevent a perfect score.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively small, confined to a single file (`display_server_x11.cpp`) and a specific function (`_window_maximize_check`). The modification involves adjusting the logic for detecting maximized states under X11, specifically changing the condition to require both `_MAXIMIZED_HORZ` and `_MAXIMIZED_VERT` to consider a window as maximized when checking `_NET_WM_STATE`. This indicates a targeted bug fix rather than a broad architectural change. Second, the technical concepts involved include familiarity with X11 window management protocols (e.g., `_NET_WM_STATE` atoms) and the Godot engine's display server implementation, which requires moderate domain-specific knowledge of Linux windowing systems. Third, the problem does not explicitly mention complex edge cases beyond the tiled/snapped state, though the developer must consider potential side effects on other window states or window managers. Finally, the change does not appear to impact the broader system architecture or require extensive refactoring. Given these factors—a focused change, moderate technical depth, and limited scope—I assign a difficulty score of 0.45, placing it in the medium category as it requires understanding specific X11 concepts and careful logic modification but is not overly complex or system-wide in impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crash on startup caused by loading VRAM compressed texture with specific range of dimensions\n### Tested versions\n\n- Reproduced in 4.4 dev6, all betas, and rc1\n- Not reproduced in 4.4 dev1 through dev5\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.19045 - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated Radeon RX 580 Series (Advanced Micro Devices, Inc.; 31.0.21921.1000) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nThe editor crashes after initialization. When running my big project with -v, the last lines displayed are these:\n```\nLoading resource: res://.godot/imported/some_texture.png-1c25004a89b329a9613253a73f2f1983.s3tc.ctex\n\tCompressed image's dimensions are not multiples of 4 (1024x1023), aligning to (1028x1024)\n```\nThe presence of `some_texture.png` actually causes the crash. I copied that texture to an empty project and found out that its dimensions, as well as it having alpha, cause a crash. Note that in the MRP, the above log message doesn't appear, although the same crash happens.\n\nI compiled with debug symbols and debugged in VS code, and the exception message is this:\n`Exception 0xc0000005 encountered at address 0x7ff6f73f5535: Access violation reading location 0x1589ca2d008`\nIt happens in `thirdparty/misc/bcdec.h`\n```\nstatic void bcdec__color_block(const void* compressedBlock, void* decompressedBlock, int destinationPitch, int onlyOpaqueMode) {\n    unsigned short c0, c1;\n    unsigned int refColors[4]; /* 0xAABBGGRR */\n    unsigned char* dstColors;\n    unsigned int colorIndices;\n    int i, j, idx;\n    unsigned int r0, g0, b0, r1, g1, b1, r, g, b;\n\n    c0 = ((unsigned short*)compressedBlock)[0]; <--------- exception here on line 119\n    c1 = ((unsigned short*)compressedBlock)[1];\n```\nAnd here's the call stack in case it helps:\n```\nstatic void bcdec__color_block(const void *, void *, int, int) (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:119)\nbcdec_bc3 (c:\\tools\\Godot\\src\\godot\\thirdparty\\misc\\bcdec.h:287)\nstatic void decompress_image(BCdecFormat, const void *, void *, const unsigned __int64, const unsigned __int64) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:129)\nvoid __cdecl image_decompress_bcdec(class Image *) (c:\\tools\\Godot\\src\\godot\\modules\\bcdec\\image_decompress_bcdec.cpp:239)\npublic: enum Error __cdecl Image::decompress(void) (c:\\tools\\Godot\\src\\godot\\core\\io\\image.cpp:2670)\npublic: virtual class Ref<class Texture2D> __cdecl EditorTexturePreviewPlugin::generate(class Ref<class Resource> const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\plugins\\editor_preview_plugins.cpp:164)\npublic: virtual class Ref<class Texture2D> __cdecl EditorResourcePreviewGenerator::generate_from_path(class String const &,struct Vector2 const &,class Dictionary &)const  (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:73)\nprivate: void __cdecl EditorResourcePreview::_generate_preview(class Ref<class ImageTexture> &,class Ref<class ImageTexture> &,struct EditorResourcePreview::QueueItem const &,class String const &,class Dictionary &) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:205)\nprivate: void __cdecl EditorResourcePreview::_iterate(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:379)\nprivate: void __cdecl EditorResourcePreview::_thread(void) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:407)\nprivate: static void __cdecl EditorResourcePreview::_thread_func(void *) (c:\\tools\\Godot\\src\\godot\\editor\\editor_resource_preview.cpp:139)\nprivate: static void __cdecl Thread::callback(unsigned __int64,struct Thread::Settings const &,void (__cdecl*)(void *),void *) (c:\\tools\\Godot\\src\\godot\\core\\os\\thread.cpp:64)\nvoid std::invoke<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>( * *, unsigned __int64 *, struct Thread::Settings *,  * *, void * *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\type_traits:1741)\nunsigned int std::thread::_Invoke<std::tuple<void (__cdecl*)(unsigned __int64,Thread::Settings const &,void (__cdecl*)(void *),void *),unsigned __int64,Thread::Settings,void (__cdecl*)(void *),void *>,0,1,2,3,4>(void *) (c:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.38.33130\\include\\thread:60)\nstatic unsigned long thread_start<unsigned int (__cdecl*)(void *),1>(void *) (@NoHotPatch:29828)\nBaseThreadInitThunk (@BaseThreadInitThunk:9)\nRtlUserThreadStart (@RtlUserThreadStart:12)\n```\n\n### Steps to reproduce\n\n1. Add a PNG texture to a project with dimensions of 1024x1023, and some alpha on at least one pixel. The MRP's `crash_texture.png` meets these criteria.\n2. Select the PNG in filesystem dock to reveal its import settings, and change the compress mode to \"VRAM compressed\"\n3. Reimport the texture and the editor crashes. It will also crash on each subsequent startup.\n\nOther resolutions that cause crash: 1024x1022, 1024x1021\nNo crash: 1024x1020, 1025x1023, 512x511\n\n### Minimal reproduction project (MRP)\n\n[texture_crash_mrp.zip](https://github.com/user-attachments/files/18947915/texture_crash_mrp.zip)\n", "patch": "diff --git a/modules/bcdec/image_decompress_bcdec.cpp b/modules/bcdec/image_decompress_bcdec.cpp\nindex 6d97ca38abef..ad0c1729d64c 100644\n--- a/modules/bcdec/image_decompress_bcdec.cpp\n+++ b/modules/bcdec/image_decompress_bcdec.cpp\n@@ -158,9 +158,12 @@ void image_decompress_bcdec(Image *p_image) {\n \n \t// Compressed images' dimensions should be padded to the upper multiple of 4.\n \t// If they aren't, they need to be realigned (the actual data is correctly padded though).\n-\tif (width % 4 != 0 || height % 4 != 0) {\n-\t\tint new_width = width + (4 - (width % 4));\n-\t\tint new_height = height + (4 - (height % 4));\n+\tconst bool need_width_realign = width % 4 != 0;\n+\tconst bool need_height_realign = height % 4 != 0;\n+\n+\tif (need_width_realign || need_height_realign) {\n+\t\tint new_width = need_width_realign ? width + (4 - (width % 4)) : width;\n+\t\tint new_height = need_height_realign ? height + (4 - (height % 4)) : height;\n \n \t\tprint_verbose(vformat(\"Compressed image's dimensions are not multiples of 4 (%dx%d), aligning to (%dx%d)\", width, height, new_width, new_height));\n \n", "instance_id": "godotengine__godot-103259", "clarity": 3, "difficulty": 0.3, "clarity_explanation": "The problem statement is comprehensive and well-documented. It clearly describes the issue (editor crash on startup due to loading VRAM compressed textures with specific dimensions), provides detailed system information, specifies the affected versions, and includes precise steps to reproduce the issue. Additionally, it offers a minimal reproduction project (MRP), debug information with a call stack, and specific error messages. The input conditions (texture dimensions and alpha presence) and the expected outcome (crash) are explicitly defined. There are no significant ambiguities, and the problem is supported by concrete examples and logs. The only minor omission is a lack of explicit mention of desired behavior post-fix, but the intent to prevent the crash is implied and clear from the context and code changes.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" category (0.2-0.4) due to the following reasons based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is localized to a single file (`image_decompress_bcdec.cpp`) and involves a small modification to the logic for realigning image dimensions. The change corrects a bug in how padding is applied to dimensions that are not multiples of 4, ensuring that only the necessary dimensions (width or height) are adjusted. This does not impact the broader system architecture or require changes across multiple modules. The amount of code change is minimal, involving just a few lines.\n\n2. **Clarity and Complexity of the Problem Description**: As noted in the clarity score, the problem is well-defined, which reduces the difficulty of understanding the issue. The crash is tied to specific texture dimensions and compression settings, and the call stack points directly to the problematic area in the code (`bcdec.h`), making it easier to pinpoint the root cause.\n\n3. **Number of Technical Concepts**: Solving this requires a basic understanding of image compression (specifically VRAM compressed textures and block compression formats like BC3), memory alignment constraints (dimensions as multiples of 4), and C++ pointer operations. These concepts are not overly complex for someone with moderate experience in graphics programming or low-level C++ development. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic graphics processing are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement highlights specific edge cases (e.g., dimensions like 1024x1023, 1024x1022 causing crashes, while others like 1024x1020 do not). However, the provided code change does not introduce new error handling logic; it simply fixes the dimension alignment logic to prevent the crash. The edge cases are already well-documented, and no additional complex error handling is required in the fix.\n\nOverall, while the problem involves a crash in a third-party library and requires some understanding of image compression, the fix itself is straightforward and localized. It does not demand deep architectural changes or advanced technical expertise beyond basic debugging and C++ skills. A score of 0.30 reflects an \"Easy\" problem that requires understanding some code logic and making a simple modification to fix the bug.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "VideoStreamPlayer causes game to crash upon playing video\n### Tested versions\n\n- Reproducible in v4.4.beta4.official [93d270693]\n- Not reproducible in v4.4.beta3.official [06acfccf8]\n\nThe only VideoStreamPlayer-related commit I saw in beta4 was #101958, so I think it is a likely cause of this issue.\n\n### System information\n\nWindows 11 - both Forward+ and Compatibility - both with and without dedicated GPU\n\n### Issue description\n\nGame closes without displaying any in-editor error messages upon playing a VideoStreamPlayer in 4.4 beta4.\n\n### Steps to reproduce\n\nPlay an Ogg Theora stream through a VideoStreamPlayer, either with `autoplay=true` or `play()`. Seems to affect both Forward+ and Compatibility renderers (haven't tested Mobile).\n\n### Minimal reproduction project (MRP)\n\n[videoplayerbug.zip](https://github.com/user-attachments/files/18838902/videoplayerbug.zip)\nThe main scene can be played to reproduce the issue. In beta3, this works as expected and a blue box moves across the screen. In beta4, the game exits immediately.\nMinGW GCC LTO internal compiler error when linking: cannot read 'LTO_section_decls'\n### Tested versions\n\n- Reproducible in d497631de0c67f22564e1efeb467cf9f061adc80 (commit before merge of workaround #102506) \n- Reproducible in 4.3.beta3 and latest `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) **with #102506 reverted**\n- Not reproducible in 4.3.stable or 4.4.beta2\n\n### System information\n\nFedora 41, mingw64-gcc-14.2.1-3.fc41, mingw64-headers-12.0.0-3.fc41, mingw64-binutils-2.42-2.fc41\n\n### Issue description\n\nThis is the bug report I promised in #102506, describing the actual bug that #102506 just hacks around, but that PR should be reverted and the bug fixed properly. This is very likely to be a GCC or binutils bug, and not a Godot bug.\n\nReproducible this bug requires (for now) to revert #102506 locally, as it seems like reintroducing this unnecessary code prevents the LTO internal compiler error. It's all fairly brittle though and I'm not confident it won't come back as we add/change other code, hence why this is a release blocker.\n\nWhen compiling current `master` (b607110ad211778a6426a00ca9c8cd99c0eb383c) with #102506 reverted and the following command, using MinGW-GCC:\n```\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n(mono module and LTO are important)\n\nThe linking steps fails with:\n```\nlto1: internal compiler error: cannot read 'LTO_section_decls' from /tmp/ccf5RNMk.ltrans115.o\nPlease submit a full bug report, with preprocessed source (by using -freport-bug).\nSee <http://bugzilla.redhat.com/bugzilla> for instructions.\nmake: *** [/tmp/cct9c3iK.mk:347: /tmp/ccf5RNMk.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nOr this:\n```\nlto1: error: two or more sections for .gnu.lto__ZZL39_register_variant_builtin_methods_arrayvEN17Method_Array_back17get_argument_typeEi.lto_priv.0.37928630.b9f437417adc9a80\n(null):0: confused by earlier errors, bailing out\nmake: *** [/tmp/cc3CZrbQ.mk:347: /tmp/ccmO0Wsr.ltrans115.ltrans.o] Error 1\nmake: *** Waiting for unfinished jobs....\nlto-wrapper: fatal error: make returned 2 exit status\ncompilation terminated.\n/usr/lib/gcc/x86_64-w64-mingw32/14.2.1/../../../../x86_64-w64-mingw32/bin/ld: error: lto-wrapper failed\ncollect2: error: ld returned 1 exit status\n```\n\nI debugged a bit with @bruvzg, who could also reproduce this with mingw-gcc on macOS with GCC 14.2.0. He tried with `-freport-bug` as advised by the error but that seems to prevent the bug.\n\n@Repiteo noted that the second error is similar to the one in #92585 (note: `x86_32` there, while here it's on `x86_64`), which we just worked around at the time by updating the base Fedora version to get newer mingw/gcc/binutils.\n\nBut here we're using the latest version provided on Fedora 41. mingw-headers and mingw-gcc on Fedora 42 aren't newer, but mingw-binutils is at 2.43.1, might be worth testing against.\n\nSince the error popped up between 4.4.beta2 and 4.4.beta3, I bisected it and landed on #102179. There's evidently nothing egregious in that patch that should trigger a LTO crash. Through trial and error, I manage to find a workaround in #102506 by doing a minimal partial revert of #102179. Reintroducing some of that code, even in a path that will never be executed (but could be, as it's checked by an undocumented project setting), seems to prevent the crash.\n\nWe also noticed that the presence of LTO objects from a previous build can also be a cause for the issue. But with a `git clean -fxd` this issue is still reproducible when reverting #102179.\n\nObviously, the problem is deeper so we need to dig. That's where I page @hpvb as the resident expert in debugging GCC bugs :D\n\n### Steps to reproduce\n\nSet up latest mingw with GCC 14.2.\n```\ngit revert e12a424bc569ac5ae9ff2944a8df7fc11b157d71\ngit clean -fxd\nscons p=windows target=editor arch=x86_64 production=yes module_mono_enabled=yes\n```\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 6f57b880441f..bbdcb9e79aa1 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -732,7 +732,7 @@ def configure_mingw(env: \"SConsEnvironment\"):\n         if env[\"use_static_cpp\"]:\n             env.Append(LINKFLAGS=[\"-static\"])\n \n-    if env[\"arch\"] in [\"x86_32\", \"x86_64\"]:\n+    if env[\"arch\"] == \"x86_32\":\n         env[\"x86_libtheora_opt_gcc\"] = True\n \n     env.Append(CCFLAGS=[\"-ffp-contract=off\"])\n", "instance_id": "godotengine__godot-103176", "clarity": 2, "difficulty": 0.85, "clarity_explanation": "\nThe problem statement is mostly clear in describing two distinct issues: a crash in the VideoStreamPlayer in version 4.4.beta4 and a MinGW GCC LTO internal compiler error during linking. For the VideoStreamPlayer issue, the goal (fixing the crash), steps to reproduce, and system information are provided, along with a minimal reproduction project (MRP). However, critical details such as specific error logs, expected behavior beyond \"game exits,\" or constraints on the fix are missing. For the LTO compiler error, the description is detailed with system information, tested versions, steps to reproduce, and even a workaround reference (#102506). It also includes insights from debugging and bisection, pointing to a specific commit (#102179). However, there are minor ambiguities, such as the lack of clarity on whether this is purely a GCC/binutils bug or if Godot's codebase contributes to triggering it, and the exact nature of the \"deeper problem\" is not fully defined. Overall, while the issues are valid and mostly clear, minor details and potential edge cases are not fully specified, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.85 (Very Hard) due to the following factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem statement is mostly clear, the dual nature of the issues (VideoStreamPlayer crash and LTO compiler error) adds complexity. The VideoStreamPlayer crash requires debugging a specific component in a game engine, potentially involving rendering pipelines (Forward+ and Compatibility) and video decoding (Ogg Theora). The LTO error is even more complex as it involves low-level compiler and linker behavior, which is outside the typical scope of application-level programming.\n\n2. **Scope and Depth of Code Changes**: The provided code change in `detect.py` is minimal, altering a single condition to disable an optimization (`x86_libtheora_opt_gcc`) for x86_64 architecture. However, this change is likely a workaround or partial fix for the VideoStreamPlayer issue or related to #102179. The actual resolution for both issues may require significant changes or debugging across multiple files or modules. For the VideoStreamPlayer crash, it could involve modifications in video decoding or rendering logic, potentially impacting core engine components. For the LTO error, the fix might not even be in the Godot codebase but in how the build system interacts with GCC/binutils, or it may require intricate workarounds in the codebase to avoid triggering the compiler bug. This suggests a deep impact on the system architecture or build process.\n\n3. **Number of Technical Concepts**: Solving these issues requires understanding multiple advanced concepts. For the VideoStreamPlayer crash, one needs knowledge of game engine architecture, video streaming/decoding libraries (e.g., Theora), rendering pipelines, and possibly platform-specific behavior (Windows). For the LTO error, expertise in compiler internals (GCC LTO), linker behavior (binutils), cross-compilation (MinGW for Windows on Linux/macOS), build systems (SCons), and low-level debugging is essential. Additionally, familiarity with Godot's build configuration and optimization flags is necessary. These are highly specialized and complex concepts, even for experienced engineers.\n\n4. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases for the VideoStreamPlayer crash beyond autoplay and manual play scenarios, but video streaming inherently involves numerous edge cases (e.g., corrupted streams, unsupported formats, resource constraints). The LTO error discussion hints at brittle behavior influenced by previous build artifacts or specific code paths, indicating complex error conditions that are hard to predict or reproduce consistently. Resolving these issues likely requires robust error handling and extensive testing, adding to the difficulty.\n\nOverall, the combination of debugging a game engine crash in a specific component and tackling a compiler/linker bug with minimal direct control over the root cause makes this a very hard problem. It demands advanced technical knowledge, deep familiarity with both the Godot codebase and low-level tools, and the ability to navigate intricate system-level issues. A score of 0.85 reflects the significant challenge posed by these issues, placing it in the upper range of difficulty.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "(4.4.beta1) Android app crashes when exported with .NET 9\n### Tested versions\n\n**Reproducible:**\n4.4.beta1\n4.4.dev7\n\n**Not Reproducible:**\n4.4.dev3\n\n### System information\n\nGodot v4.4.beta1.mono - Windows 10 (build 19045) - OpenGL 3 (Compatibility)\n\n### Issue description\n\nWhen exporting to Android with .NET 9 using Gradle Build via the Remote Deploy, the app crashes immediately at startup.\n\nNote:  .NET 8 works fine, but .NET 9 causes the app to crash\n\nusing the command at runtime:\n**adb logcat|grep godot**\n\n> 01-22 19:27:18.818  1895  3450 I ActivityTaskManager: START u0 {act=android.intent.action.MAIN flg=0x10000000 cmp=com.example.test_android/com.godot.game.GodotApp} from uid 2000\n01-22 19:27:18.857  1895  2224 I ActivityManager: Start proc 1876:com.example.test_android/u0a411 for next-top-activity {com.example.test_android/com.godot.game.GodotApp}\n01-22 19:27:19.885  1895  2006 W ActivityTaskManager:   Force finishing activity com.example.test_android/com.godot.game.GodotApp\n01-22 19:27:19.987  1895  2220 I GameServiceProviderInstance: Failed to remove task overlay. This is expected if the task is already destroyed: GameSessionRecord{mTaskId=306, mState=GAME_SESSION_ATTACHED, mRootComponentName=ComponentInfo{com.example.test_android/com.godot.game.GodotApp}, mIGameSession=android.service.games.IGameSession$Stub$Proxy@3a45eaa, mSurfacePackage=android.view.SurfaceControlViewHost$SurfacePackage@3504a9b}\n01-22 19:27:20.386  1895  2200 W ActivityTaskManager: Activity top resumed state loss timeout for ActivityRecord{691de90 u0 com.example.test_android/com.godot.game.GodotApp} t-1 f}}\n\n\n\n\n\n\n\n### Steps to reproduce\n\n1. Godot 4.4.beta1\n2. Create a new project\n3. Create C# script and attach to a node in the main scene\n4. Update the visual studio project to target .NET 9: \n` <TargetFramework>net9.0</TargetFramework>`\n4. Remote Deploy to Android with Gradle Build\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/platform/android/export/export_plugin.cpp b/platform/android/export/export_plugin.cpp\nindex 578f723e700f..0f50f725258c 100644\n--- a/platform/android/export/export_plugin.cpp\n+++ b/platform/android/export/export_plugin.cpp\n@@ -55,6 +55,10 @@\n #include \"modules/modules_enabled.gen.h\" // For mono.\n #include \"modules/svg/image_loader_svg.h\"\n \n+#ifdef MODULE_MONO_ENABLED\n+#include \"modules/mono/utils/path_utils.h\"\n+#endif\n+\n #ifdef ANDROID_ENABLED\n #include \"../os_android.h\"\n #endif\n@@ -2526,6 +2530,43 @@ bool EditorExportPlatformAndroid::has_valid_username_and_password(const Ref<Edit\n \treturn valid;\n }\n \n+#ifdef MODULE_MONO_ENABLED\n+bool _validate_dotnet_tfm(const String &required_tfm, String &r_error) {\n+\tString assembly_name = path::get_csharp_project_name();\n+\tString project_path = ProjectSettings::get_singleton()->globalize_path(\"res://\" + assembly_name + \".csproj\");\n+\n+\tif (!FileAccess::exists(project_path)) {\n+\t\treturn true;\n+\t}\n+\n+\tString pipe;\n+\tList<String> args;\n+\targs.push_back(\"build\");\n+\targs.push_back(project_path);\n+\targs.push_back(\"--getProperty:TargetFramework\");\n+\n+\tint exitcode;\n+\tError err = OS::get_singleton()->execute(\"dotnet\", args, &pipe, &exitcode, true);\n+\tif (err != OK || exitcode != 0) {\n+\t\tif (err != OK) {\n+\t\t\tWARN_PRINT(\"Failed to execute dotnet command. Error \" + String(error_names[err]));\n+\t\t} else if (exitcode != 0) {\n+\t\t\tprint_line(pipe);\n+\t\t\tWARN_PRINT(\"dotnet command exited with code \" + itos(exitcode) + \". See output above for more details.\");\n+\t\t}\n+\t\tr_error += vformat(TTR(\"Unable to determine the C# project's TFM, it may be incompatible. The export template only supports '%s'. Make sure the project targets '%s' or consider using gradle builds instead.\"), required_tfm, required_tfm) + \"\\n\";\n+\t} else {\n+\t\tString tfm = pipe.strip_edges();\n+\t\tif (tfm != required_tfm) {\n+\t\t\tr_error += vformat(TTR(\"C# project targets '%s' but the export template only supports '%s'. Consider using gradle builds instead.\"), tfm, required_tfm) + \"\\n\";\n+\t\t\treturn false;\n+\t\t}\n+\t}\n+\n+\treturn true;\n+}\n+#endif\n+\n bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<EditorExportPreset> &p_preset, String &r_error, bool &r_missing_templates, bool p_debug) const {\n \tString err;\n \tbool valid = false;\n@@ -2534,6 +2575,15 @@ bool EditorExportPlatformAndroid::has_valid_export_configuration(const Ref<Edito\n #ifdef MODULE_MONO_ENABLED\n \t// Android export is still a work in progress, keep a message as a warning.\n \terr += TTR(\"Exporting to Android when using C#/.NET is experimental.\") + \"\\n\";\n+\n+\tif (!gradle_build_enabled) {\n+\t\t// For template exports we only support .NET 8 because the template\n+\t\t// includes .jar dependencies that may only be compatible with .NET 8.\n+\t\tif (!_validate_dotnet_tfm(\"net8.0\", err)) {\n+\t\t\tr_error = err;\n+\t\t\treturn false;\n+\t\t}\n+\t}\n #endif\n \n \t// Look for export templates (first official, and if defined custom templates).\n", "instance_id": "godotengine__godot-102627", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an Android app built with Godot 4.4.beta1 crashes at startup when exported with .NET 9, while it works fine with .NET 8. The description includes tested versions, system information, steps to reproduce, and relevant log output, which helps in understanding the context and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify the exact cause of the crash (e.g., a specific error message or stack trace beyond the log provided), nor does it mention potential edge cases or constraints related to the Android environment or .NET 9 compatibility. Additionally, the lack of a minimal reproduction project (MRP) makes it slightly harder to pinpoint the issue without further investigation. Overall, the statement is valid and clear but lacks some finer details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes is relatively focused, primarily affecting a single file (`export_plugin.cpp`) in the Godot engine's Android export module. However, the changes introduce a new validation function (`_validate_dotnet_tfm`) to check the .NET Target Framework Moniker (TFM) compatibility, which requires understanding the interaction between Godot's build system, .NET versions, and Android export templates. This involves moderate complexity in terms of codebase architecture, as it touches on the integration of C#/.NET with Android builds.\n\nSecond, the technical concepts involved include familiarity with Godot's export system, .NET framework versioning, command-line execution of `dotnet` commands via the OS interface, and string parsing for validation. Additionally, the developer must understand the implications of using Gradle builds versus template exports and why .NET 9 compatibility fails with the current setup. These concepts are not trivial and require a solid grasp of both Godot's internals and .NET ecosystems.\n\nThird, the code changes, while not extensive in terms of lines of code, have a significant impact by enforcing a specific .NET version (net8.0) for template exports and providing detailed error messaging. This indicates a need for careful error handling and user feedback, though specific edge cases (e.g., missing `dotnet` CLI, malformed project files) are not explicitly handled in the provided diff and may need further consideration.\n\nFinally, solving this issue requires debugging a crash in a specific environment (Android with .NET 9), which often involves deep knowledge of platform-specific behaviors, build configurations, and potentially native debugging tools. While the provided code change addresses a specific compatibility check, the underlying crash issue might require further investigation beyond this diff, adding to the difficulty. A score of 0.65 reflects the need for a deep understanding of the codebase and moderate-to-complex modifications, placing it in the lower end of the \"Hard\" range.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex cccfff6a8449..062d522b6818 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3956,10 +3956,14 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t} else {\n \t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n+\t\t\t\t\t\t\t\tError err = OK;\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n-\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = GDScriptCache::get_shallow_script(base_type.script_path, err);\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n \t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n \t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n \t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n@@ -3972,8 +3976,19 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t} else if (base_type.script_type.is_valid()) {\n+\t\t\t\t\t\t\t\t\t// For script enums the value isn't accessible as class constant so we need the full enum name.\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name;\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\t\tr_result.script = base_type.script_type;\n+\t\t\t\t\t\t\t\t\tr_result.script_path = base_type.script_path;\n+\t\t\t\t\t\t\t\t\t// TODO: Find a way to obtain enum value location for a script\n+\t\t\t\t\t\t\t\t\tr_result.location = base_type.script_type->get_member_line(doc_enum_name.substr(dot_pos + 1));\n+\t\t\t\t\t\t\t\t} else {\n+\t\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t\t\treturn OK;\n+\t\t\t\t\t\t\t\treturn err;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n \t\t\t\t\t} else if (Variant::has_builtin_method(Variant::DICTIONARY, p_symbol)) {\n", "instance_id": "godotengine__godot-102401", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: CTRL-clicking on an enum value in the Godot engine's GDScript editor does not navigate to the correct definition of the enum member. It provides specific versions where the issue is reproducible, system information, a clear description of the expected behavior versus the actual behavior, steps to reproduce, and a minimal reproduction project (MRP). However, there are minor ambiguities, such as the lack of explicit mention of edge cases (e.g., nested enums, inherited enums, or enums in different scopes) and no detailed specification of the desired navigation behavior for all possible enum usage scenarios. Additionally, the problem statement does not clarify whether this issue affects only specific types of enums or all enum declarations. Despite these minor gaps, the overall intent and context of the issue are well-articulated, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is relatively narrow, confined to a single file (`gdscript_editor.cpp`) and a specific function related to symbol lookup. However, the changes require a deep understanding of the Godot engine's internals, particularly the GDScript parser and how symbol resolution works for enums in different contexts (e.g., script-based enums versus class-based enums). The code modifications involve handling different data types (`base_type.class_type` and `base_type.script_type`) and ensuring correct navigation to the enum member's definition, which adds complexity. \n\nSecond, the number of technical concepts involved is significant: familiarity with C++ (used in Godot's core), the Godot engine's scripting system, symbol lookup mechanisms, and potentially the editor's UI integration for navigation. The developer must also understand how scripts and class members are cached and accessed within the engine, as seen in the use of `GDScriptCache` and script paths.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest the need to handle different enum declaration contexts (e.g., within a class or a script) and potentially incomplete or invalid symbol lookups. Error handling logic is also modified (e.g., returning an `Error` type), indicating some attention to robustness, though the complexity of these edge cases appears moderate.\n\nFinally, the impact on the system's architecture is minimal since the change is localized, but the risk of introducing bugs in symbol resolution—a critical feature for editor usability—is non-trivial. A score of 0.65 reflects the need for a solid understanding of the codebase, careful handling of enum-specific logic, and moderate complexity in ensuring the fix works across various scenarios without breaking existing functionality.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Horrible Flickering when closing docks while embedded game is paused\n### Tested versions\n\n- Reproducible in Godot 4.4 beta1\n\n### System information\n\n🪟 Windows 11 - 🤖 Godot 4.4 beta1\n\n### Issue description\n\nClosing a dock while the game is paused and embedded causes the screen to flicker pretty badly.\n\n⚠️ Photosensitivity warning ⚠️\n🎥 See screen recording:\n\nhttps://github.com/user-attachments/assets/4cb0c17c-bc7b-4723-9e30-91b3ea54bf1f\n\n### Steps to reproduce\n\nEnable 'Embed Game on Next Play' in the Game tab.\n\n1. Run a game.\n2. Open a dock.\n3. Pause the game. \n4. Close the dock.\n5. Survive the flickering ⚠️🔦📸💥😵‍💫😵‍💫😵‍💫\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 723c762a72a5..ad501e77a6d8 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -301,6 +301,7 @@ void GameView::_stop_pressed() {\n \t}\n \n \t_detach_script_debugger();\n+\tpaused = false;\n \n \tEditorNode::get_singleton()->set_unfocused_low_processor_usage_mode_enabled(true);\n \tembedded_process->reset();\n@@ -515,15 +516,26 @@ void GameView::_update_embed_menu_options() {\n }\n \n void GameView::_update_embed_window_size() {\n-\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n-\t\t//The embedded process control will need the desired window size.\n-\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n-\t\tembedded_process->set_window_size(placement.size);\n+\tif (paused) {\n+\t\t// When paused, Godot does not re-render. As a result, resizing the game window to a larger size\n+\t\t// causes artifacts and flickering. However, resizing to a smaller size seems fine.\n+\t\t// To prevent artifacts and flickering, we will force the game window to maintain its size.\n+\t\t// Using the same technique as SIZE_MODE_FIXED, the embedded process control will\n+\t\t// prevent resizing the game to a larger size while maintaining the aspect ratio.\n+\t\tembedded_process->set_window_size(size_paused);\n+\t\tembedded_process->set_keep_aspect(false);\n+\n \t} else {\n-\t\t//Stretch... No need for the window size.\n-\t\tembedded_process->set_window_size(Size2i());\n+\t\tif (embed_size_mode == SIZE_MODE_FIXED || embed_size_mode == SIZE_MODE_KEEP_ASPECT) {\n+\t\t\t// The embedded process control will need the desired window size.\n+\t\t\tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n+\t\t\tembedded_process->set_window_size(placement.size);\n+\t\t} else {\n+\t\t\t// Stretch... No need for the window size.\n+\t\t\tembedded_process->set_window_size(Size2i());\n+\t\t}\n+\t\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n \t}\n-\tembedded_process->set_keep_aspect(embed_size_mode == SIZE_MODE_KEEP_ASPECT);\n }\n \n void GameView::_hide_selection_toggled(bool p_pressed) {\n@@ -787,7 +799,8 @@ void GameView::_window_close_request() {\n \t\tembedded_process->reset();\n \n \t\t// When the embedding is not complete, we need to kill the process.\n-\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t// If the game is paused, the close request will not be processed by the game, so it's better to kill the process.\n+\t\tif (paused || embedded_process->is_embedding_in_progress()) {\n \t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n \t\t\t// actually closes.\n \t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n@@ -795,6 +808,20 @@ void GameView::_window_close_request() {\n \t}\n }\n \n+void GameView::_debugger_breaked(bool p_breaked, bool p_can_debug) {\n+\tif (p_breaked == paused) {\n+\t\treturn;\n+\t}\n+\n+\tpaused = p_breaked;\n+\n+\tif (paused) {\n+\t\tsize_paused = embedded_process->get_screen_embedded_window_rect().size;\n+\t}\n+\n+\t_update_embed_window_size();\n+}\n+\n GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tsingleton = this;\n \n@@ -984,6 +1011,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_wrapper->set_override_close_request(true);\n \tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n+\n+\tEditorDebuggerNode::get_singleton()->connect(\"breaked\", callable_mp(this, &GameView::_debugger_breaked));\n }\n \n ///////\n@@ -1053,15 +1082,18 @@ void GameViewPlugin::_window_visibility_changed(bool p_visible) {\n }\n \n void GameViewPlugin::_save_last_editor(const String &p_editor) {\n-\tif (p_editor != get_name()) {\n+\tif (p_editor != get_plugin_name()) {\n \t\tlast_editor = p_editor;\n \t}\n }\n \n void GameViewPlugin::_focus_another_editor() {\n \tif (window_wrapper->get_window_enabled()) {\n-\t\tERR_FAIL_COND(last_editor.is_empty());\n-\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\tif (last_editor.is_empty()) {\n+\t\t\tEditorNode::get_singleton()->get_editor_main_screen()->select(EditorMainScreen::EDITOR_2D);\n+\t\t} else {\n+\t\t\tEditorInterface::get_singleton()->set_main_screen_editor(last_editor);\n+\t\t}\n \t}\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 7402b270e3c0..dd384280b5fb 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -122,6 +122,8 @@ class GameView : public VBoxContainer {\n \tbool embed_on_play = true;\n \tbool make_floating_on_play = true;\n \tEmbedSizeMode embed_size_mode = SIZE_MODE_FIXED;\n+\tbool paused = false;\n+\tSize2 size_paused;\n \n \tRect2i floating_window_rect;\n \tint floating_window_screen = -1;\n@@ -186,6 +188,8 @@ class GameView : public VBoxContainer {\n \tvoid _detach_script_debugger();\n \tvoid _remote_window_title_changed(String title);\n \n+\tvoid _debugger_breaked(bool p_breaked, bool p_can_debug);\n+\n protected:\n \tvoid _notification(int p_what);\n \n", "instance_id": "godotengine__godot-102006", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue of flickering when closing docks while an embedded game is paused in Godot 4.4 beta1. It provides a clear context (Godot editor, embedded game mode), steps to reproduce the issue, and even a visual reference via a screen recording. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define the expected behavior (e.g., no flickering at all, or a specific way to handle resizing), nor does it mention specific edge cases beyond the general scenario of pausing and closing docks. Additionally, there are no details about performance expectations or constraints for the fix. While the issue is reproducible and the goal is implied (eliminate flickering), these missing specifics slightly reduce the clarity.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is moderate, primarily confined to a single file (`game_view_plugin.cpp`) with modifications to multiple functions, but it does not appear to impact the broader system architecture significantly. However, the changes require a deep understanding of the Godot engine's internals, specifically how embedded game windows, pausing mechanisms, and rendering interact within the editor. The technical concepts involved include handling window resizing, maintaining aspect ratios, and managing state transitions (paused vs. unpaused), which are non-trivial in a game engine context. Additionally, the solution introduces new logic to prevent resizing to larger sizes while paused to avoid flickering, which requires careful handling of state (`paused` and `size_paused`) and integration with existing systems like the debugger (`_debugger_breaked`). Edge cases, such as different embed size modes and window close requests during paused states, are addressed in the code changes, adding to the complexity. While not at the extreme end of difficulty (e.g., no system-level redesign or advanced algorithms), this problem demands a solid grasp of the codebase and thoughtful handling of rendering artifacts, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4.dev5] Websockets stuck in STATE_CLOSING\n### Tested versions\n\nStarting with 4.4.dev5\nConfirmed to work with 4.4.dev4\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 6700 XT (Advanced Micro Devices, Inc.; 32.0.12033.1030) - Intel(R) Core(TM) i5-9600K CPU @ 3.70GHz (6 threads)\n\n### Issue description\n\nClient WebSocketPeers get stuck on STATE_CLOSING when close() is called.\n\n### Steps to reproduce\n\n- Download MRP with any Godot version >= 4.4.dev5\n- Click on \"Client disconnect\"\n- Check output\n\n### Minimal reproduction project (MRP)\n\n[100948.zip](https://github.com/user-attachments/files/18277136/100948.zip)\n\n", "patch": "diff --git a/modules/websocket/wsl_peer.cpp b/modules/websocket/wsl_peer.cpp\nindex 9ffc343571e8..f50b4c480652 100644\n--- a/modules/websocket/wsl_peer.cpp\n+++ b/modules/websocket/wsl_peer.cpp\n@@ -860,10 +860,12 @@ void WSLPeer::close(int p_code, String p_reason) {\n \t\t}\n \t}\n \n-\theartbeat_waiting = false;\n-\tin_buffer.clear();\n-\tpacket_buffer.resize(0);\n-\tpending_message.clear();\n+\tif (ready_state == STATE_CLOSED) {\n+\t\theartbeat_waiting = false;\n+\t\tin_buffer.clear();\n+\t\tpacket_buffer.resize(0);\n+\t\tpending_message.clear();\n+\t}\n }\n \n IPAddress WSLPeer::get_connected_host() const {\n", "instance_id": "godotengine__godot-101760", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: WebSocketPeers get stuck in the STATE_CLOSING state when the close() method is called in Godot versions starting from 4.4.dev5. It provides specific version information, system details, steps to reproduce, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior after calling close() (e.g., should the state transition to STATE_CLOSED immediately?), nor does it mention specific edge cases or conditions under which the issue occurs (e.g., specific network conditions or timing issues). Additionally, the impact of being \"stuck\" in STATE_CLOSING (e.g., resource leaks, inability to reconnect) is not detailed. These gaps prevent the statement from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (wsl_peer.cpp) and involves a small modification within the close() method. The diff shows a conditional check to ensure cleanup (clearing buffers and resetting state variables) only occurs if the ready_state is STATE_CLOSED. This suggests a straightforward bug fix with minimal impact on the broader codebase or system architecture. The change does not require understanding complex interactions between modules, as it is confined to the WebSocket peer's state management logic.\n\n2. **Number of Technical Concepts:** Solving this issue requires a basic understanding of WebSocket protocols (specifically state transitions like STATE_CLOSING to STATE_CLOSED), familiarity with C++ (as the codebase is in C++), and knowledge of the Godot engine's WebSocket implementation. These concepts are not overly complex for a developer with moderate experience in networking and C++. No advanced algorithms, design patterns, or domain-specific knowledge beyond WebSocket state handling are needed.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the nature of WebSocket state transitions implies potential issues like race conditions (e.g., close() called during an ongoing operation) or network interruptions. The code change itself does not introduce new error handling logic; it merely adjusts when cleanup occurs. The complexity of edge cases appears minimal, as the fix focuses on ensuring proper state cleanup rather than handling diverse failure modes.\n\n4. **Overall Assessment:** The problem is a relatively simple bug fix involving a small, targeted code change. It requires understanding the WebSocket state machine in Godot but does not demand deep architectural knowledge or extensive modifications. The difficulty is slightly above \"Very Easy\" due to the need to understand the specific state transition logic and verify that the fix does not introduce side effects, but it remains within the \"Easy\" category. Hence, a score of 0.30 is appropriate.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector loads slowly when there's many Color properties\n### Tested versions\n\nReproducible in 4.4.dev7, and probably many versions earlier.\n\n### System information\n\nWindows 11\n\n### Issue description\n\nInspectors (or project/editor settings) that contain many Color properties will load slowly. Additionally, they can be slow to switch away from.\n\n### Steps to reproduce\n\nFor example, check out:\n```\nEditor Settings > Text Editor > Theme     (the worst example)\nEditor Settings > Editors > 3D Gizmos\nEditor Settings > Editors > Visual Editors\nProject Settings > Debug > Shapes\n```\n\n\n\n### Minimal reproduction project (MRP)\n\nAlso, I made an MPR that has a Node with an exported `Array[Color]`, and some extra Color properties. Try repeatedly switching between the `Colorful` and `Colorless` nodes (make sure the Array is expanded).\n\n[color_picker.zip](https://github.com/user-attachments/files/18418402/color_picker.zip)\n", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 69b44a3e8f88..b1a4bb76f325 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -2599,6 +2599,17 @@ void EditorPropertyColor::_color_changed(const Color &p_color) {\n \tget_edited_object()->set(get_edited_property(), p_color);\n }\n \n+void EditorPropertyColor::_picker_created() {\n+\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_popup_opening));\n+\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n+}\n+\n+void EditorPropertyColor::_popup_opening() {\n+\tEditorNode::get_singleton()->setup_color_picker(picker->get_picker());\n+\tlast_color = picker->get_pick_color();\n+\twas_checked = !is_checkable() || is_checked();\n+}\n+\n void EditorPropertyColor::_popup_closed() {\n \tget_edited_object()->set(get_edited_property(), was_checked ? Variant(last_color) : Variant());\n \tif (!picker->get_pick_color().is_equal_approx(last_color)) {\n@@ -2606,11 +2617,6 @@ void EditorPropertyColor::_popup_closed() {\n \t}\n }\n \n-void EditorPropertyColor::_picker_opening() {\n-\tlast_color = picker->get_pick_color();\n-\twas_checked = !is_checkable() || is_checked();\n-}\n-\n void EditorPropertyColor::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE:\n@@ -2654,9 +2660,7 @@ EditorPropertyColor::EditorPropertyColor() {\n \tadd_child(picker);\n \tpicker->set_flat(true);\n \tpicker->connect(\"color_changed\", callable_mp(this, &EditorPropertyColor::_color_changed));\n-\tpicker->connect(\"popup_closed\", callable_mp(this, &EditorPropertyColor::_popup_closed), CONNECT_DEFERRED);\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(EditorNode::get_singleton(), &EditorNode::setup_color_picker).bind(picker->get_picker()));\n-\tpicker->get_popup()->connect(\"about_to_popup\", callable_mp(this, &EditorPropertyColor::_picker_opening));\n+\tpicker->connect(\"picker_created\", callable_mp(this, &EditorPropertyColor::_picker_created), CONNECT_ONE_SHOT);\n }\n \n ////////////// NODE PATH //////////////////////\ndiff --git a/editor/editor_properties.h b/editor/editor_properties.h\nindex bcdae5342d28..6fe8cc3c3f38 100644\n--- a/editor/editor_properties.h\n+++ b/editor/editor_properties.h\n@@ -593,8 +593,9 @@ class EditorPropertyColor : public EditorProperty {\n \tGDCLASS(EditorPropertyColor, EditorProperty);\n \tColorPickerButton *picker = nullptr;\n \tvoid _color_changed(const Color &p_color);\n+\tvoid _picker_created();\n+\tvoid _popup_opening();\n \tvoid _popup_closed();\n-\tvoid _picker_opening();\n \n \tColor last_color;\n \tbool live_changes_enabled = true;\n", "instance_id": "godotengine__godot-101570", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: inspectors and settings with many Color properties load slowly, and switching between them is also slow. It provides specific examples of affected areas in the editor settings and includes a minimal reproduction project (MRP) to demonstrate the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected performance improvement or success criteria (e.g., target load time or acceptable delay). Additionally, it lacks mention of specific edge cases or constraints that might affect the solution, such as memory usage or compatibility with different platforms beyond Windows 11. While the issue is reproducible and the context is provided, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively localized, primarily affecting the `EditorPropertyColor` class in `editor_properties.cpp` and its header file. The changes involve modifying event handling for the color picker (e.g., connecting signals for popup events and managing state like `last_color` and `was_checked`). This requires understanding the editor's UI event system and the specific behavior of the `ColorPickerButton` widget, which adds moderate complexity. Second, the number of technical concepts involved includes familiarity with C++ class inheritance, signal-slot mechanisms (likely part of a framework like Godot's), and UI component lifecycle management. These are not overly advanced but do require a solid grasp of the codebase's design patterns. Third, the problem does not explicitly mention edge cases, but the code changes suggest potential considerations around state consistency (e.g., ensuring the color value is correctly updated or reverted when the picker popup closes) and performance (e.g., avoiding redundant operations during popup events). However, these are not overly complex to handle. Finally, the impact on the system's architecture appears minimal, as the changes are confined to a specific component without broader refactoring. Overall, this problem requires understanding multiple concepts and making targeted modifications, fitting a medium difficulty score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`invalidateblock` during background validation\nIf you call `invalidateblock` (on the tip) during background validation, the node will currently do the following:\r\n#### bitcoin-cli invalidateblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:01:15Z [background validation] UpdateTip: new best=0000000000000000008dd2857255b2e5fc0c3955740c74dac6bafd0de09c344e height=482000 version=0x20000000 log2_work=86.991735 tx=249395394 date='2017-08-25T19:52:51Z' progress=0.230269 cache=238.7MiB(1748399txo)\r\n2024-09-24T13:02:42Z Saw new header hash=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671\r\n2024-09-24T13:02:45Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81087txo)\r\n2024-09-24T13:02:52Z [background validation] UpdateTip: new best=000000000000000000b7738efb4c4acbc841c032294d2e6ab09295f4117c7b3a height=484000 version=0x20000002 log2_work=87.061771 tx=252628356 date='2017-09-07T11:50:44Z' progress=0.233253 cache=688.5MiB(5222117txo)\r\n2024-09-24T13:02:58Z UpdateTip: new best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec height=862670 version=0x3fff0000 log2_work=95.172216 tx=1085323202 date='2024-09-24T13:00:39Z' progress=0.999999 cache=11.8MiB(77967txo)\r\n2024-09-24T13:02:58Z InvalidChainFound: invalid block=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe  height=862671  log2_work=95.172229  date=2024-09-24T13:02:21Z\r\n2024-09-24T13:02:58Z InvalidChainFound:  current best=000000000000000000029f913a20c71e01321ec8b320418b6fe7c38e708a0eec  height=862670  log2_work=95.172216  date=2024-09-24T13:00:39Z\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:02:58Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\n<repeat for every new block processed in the background validation>\r\n```\r\n#### bitcoin-cli reconsiderblock 00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe\r\n```bash\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z CheckForkWarningConditions: Warning: Found invalid chain at least ~6 blocks longer than our best chain.\r\nChain state database corruption likely.\r\n2024-09-24T13:03:10Z UpdateTip: new best=00000000000000000000f5752e9599f03a7b3a3e2356af91faaf74e41fdf58fe height=862671 version=0x2be3a000 log2_work=95.172229 tx=1085328468 date='2024-09-24T13:02:21Z' progress=1.000000 cache=11.6MiB(81332txo)\r\n2024-09-24T13:03:16Z New outbound-full-relay v2 peer connected: version: 70016, blocks=862671, peer=69\r\n2024-09-24T13:04:44Z [background validation] UpdateTip: new best=000000000000000000a2a8104d61651f76c666b70754d6e9346176385f7afa24 height=486000 version=0x20000000 log2_work=87.131847 tx=255540060 date='2017-09-19T09:09:00Z' progress=0.235942 cache=1014.2MiB(7475508txo)\r\n2024-09-24T13:06:42Z [background validation] UpdateTip: new best=000000000000000000f980eebec0616501eead146975f1df5ca9a1db40309547 height=488000 version=0x20000000 log2_work=87.210415 tx=258791302 date='2017-10-02T21:02:34Z' progress=0.238943 cache=1284.3MiB(9681780txo)\r\n2024-09-24T13:08:01Z [background validation] UpdateTip: new best=000000000000000000de069137b17b8d5a3dfbd5b145b2dcfb203f15d0c4de90 height=490000 version=0x20000000 log2_work=87.286453 tx=262368718 date='2017-10-15T17:57:17Z' progress=0.242246 cache=1521.0MiB(11621530txo)\r\n```\r\n\r\nPrinting these warning messages does not seem useful, or even the correct thing to do during a background sync; as the chain being warned about, is still our best, active chain?\n", "patch": "diff --git a/src/validation.cpp b/src/validation.cpp\nindex b47b1d09ae1e9..5da3387ad296f 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2020,7 +2020,8 @@ void Chainstate::CheckForkWarningConditions()\n \n     // Before we get past initial download, we cannot reliably alert about forks\n     // (we assume we don't get stuck on a fork before finishing our initial sync)\n-    if (m_chainman.IsInitialBlockDownload()) {\n+    // Also not applicable to the background chainstate\n+    if (m_chainman.IsInitialBlockDownload() || this->GetRole() == ChainstateRole::BACKGROUND) {\n         return;\n     }\n \n", "instance_id": "bitcoin__bitcoin-30962", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: calling `invalidateblock` during background validation in a Bitcoin node results in repeated warning messages about an invalid chain, which the author questions as being unnecessary or incorrect since the chain remains the best active chain. The logs provided offer context about the behavior, showing the sequence of events with `invalidateblock` and `reconsiderblock` commands. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"background validation\" entails or how it interacts with the main chainstate, which could be critical for someone unfamiliar with the Bitcoin codebase. Additionally, the expected behavior or desired outcome after the fix is not fully articulated—while it implies that warnings should not be printed, it does not specify under what conditions or if there are alternative behaviors to consider. Constraints or potential side effects of suppressing these warnings are also not mentioned. Despite these minor gaps, the issue is valid and understandable with the provided logs and context, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal, involving a single line modification in `validation.cpp` to add a condition check for the background chainstate role. It affects only one function (`CheckForkWarningConditions`) and does not require understanding complex interactions across multiple modules or altering the system's architecture. The change is localized and straightforward, simply extending an existing condition to skip warning checks during background validation.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with the Bitcoin Core codebase, specifically understanding the concept of chainstate roles (foreground vs. background) and the `IsInitialBlockDownload` mechanism. No advanced language features, algorithms, or design patterns are involved. The change leverages existing logic and does not introduce new technical complexity.\n\n3. **Edge Cases and Error Handling:** The problem statement and code change do not explicitly address specific edge cases or error handling requirements. The modification appears to be a simple conditional check to suppress warnings, and there’s no indication of complex edge cases (e.g., what happens if background validation state changes mid-process). While there might be implicit considerations about ensuring warnings are still appropriately triggered in other contexts, the provided diff does not suggest significant complexity in handling such cases.\n\n4. **Overall Complexity:** The task is a minor bug fix or behavioral adjustment rather than a feature addition or architectural change. It requires understanding a small part of the codebase and making a simple logical modification. The impact is limited to logging behavior during background validation, with no apparent performance or systemic implications.\n\nGiven these factors, a difficulty score of 0.25 reflects the ease of the task. It requires minimal effort beyond identifying the correct place to add the condition and understanding the basic context of background validation in Bitcoin Core. This is well within the capabilities of a junior to mid-level developer with some familiarity with the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Shutdown during reindex-chainstate can block forever\nDuring `Shutdown`, we stop the scheduler before waiting on the load-block thread. But the load-block thread can call `LimitValidationInterfaceQueue` via `ActivateBestChain`. `LimitValidationInterfaceQueue` then schedules a dummy call and waits for it. But since the scheduler has stopped, it never gets there, and blocks forever. Shutdown remains joined to the thread, and also never exits.\r\n\r\nCan we just wait for the load-block thread before killing the scheduler?\n", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e4b65fbfa94f6..03969b00bb661 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -296,10 +296,11 @@ void Shutdown(NodeContext& node)\n \n     StopTorControl();\n \n+    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n     // After everything has been shut down, but before things get flushed, stop the\n-    // scheduler and load block thread.\n+    // the scheduler. After this point, SyncWithValidationInterfaceQueue() should not be called anymore\n+    // as this would prevent the shutdown from completing.\n     if (node.scheduler) node.scheduler->stop();\n-    if (node.chainman && node.chainman->m_thread_load.joinable()) node.chainman->m_thread_load.join();\n \n     // After the threads that potentially access these pointers have been stopped,\n     // destruct and reset all to nullptr.\n", "instance_id": "bitcoin__bitcoin-30435", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a deadlock during shutdown caused by the order of stopping the scheduler and waiting for the load-block thread. It identifies the root cause (the scheduler being stopped before the thread can complete its work) and poses a reasonable question about reordering the shutdown sequence. However, it lacks critical details such as the broader context of the shutdown process, specific constraints or risks associated with changing the order of operations, and any potential side effects or edge cases that might arise from the proposed solution. Additionally, there are no examples or detailed scenarios to illustrate the problem, which could make it harder for someone unfamiliar with the codebase to fully grasp the issue. Hence, it is rated as \"Mostly Clear\" with minor details missing.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, involving only a reordering of two operations in a single file (`init.cpp`). It does not impact multiple modules or require significant architectural changes. The modification is straightforward—moving the `join()` call for the load-block thread before stopping the scheduler.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of multithreading and synchronization in C++ (specifically, thread joining and scheduler management). It does not involve complex algorithms, design patterns, or advanced language features. However, it does require some familiarity with the codebase's shutdown sequence and the interaction between the scheduler and threads, which adds a slight layer of complexity.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases or error conditions to handle, and the code change does not introduce new error handling logic. However, there is an implicit risk of unintended consequences (e.g., other dependencies on the scheduler being stopped later), which requires careful consideration but is not overly complex.\n\n4. **Overall Complexity**: While the fix itself is simple, understanding the root cause (deadlock due to scheduling and thread interactions) requires a moderate level of debugging and reasoning about concurrent systems. This pushes the difficulty slightly above the \"Very Easy\" range but keeps it within \"Easy\" as the actual implementation is minimal and localized.\n\nThus, a score of 0.35 reflects a problem that is relatively easy to solve with basic knowledge of threading and a cursory understanding of the codebase's shutdown logic, without requiring deep architectural changes or handling complex edge cases.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\"Color selection\" off-by-one regression: it colors 1 cell past the end\n### Windows Terminal version\n\n1.23.10732.0\n\n### Windows build number\n\n10.0.26388.1001\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nI use the \"Color Selection\" feature a lot, and often the \"all matches\" variant, which lets you select some text, and then change the fg/bg color for all occurrences of the selected text.\n\nRecently it started coloring one cell past the end of the selection. In the screenshot below, I selected \"abcd\", but the colorization applies to \"abcde\" (as well as \"abcdeX\", demonstrating that the search is not similarly afected):\n\n![Image](https://github.com/user-attachments/assets/6258a18f-d941-443d-9f3e-c7fd6750dbe3)\n\n### Expected Behavior\n\nJust the \"abcd\" should have been colorized.\n\n### Actual Behavior\n\nColorization included one character past the end.\n", "patch": "diff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex df30a3ffb23..7cd232ad539 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -2061,14 +2061,6 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n     }\r\n }\r\n \r\n-size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coordEnd) const\r\n-{\r\n-    const auto bufferSize = GetSize();\r\n-    // The coords are inclusive, so to get the (inclusive) length we add 1.\r\n-    const auto length = bufferSize.CompareInBounds(coordEnd, coordStart) + 1;\r\n-    return gsl::narrow<size_t>(length);\r\n-}\r\n-\r\n // Routine Description:\r\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex 775417caab0..fca973f50de 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -199,8 +199,6 @@ class TextBuffer final\n     std::wstring GetCustomIdFromId(uint16_t id) const;\r\n     void CopyHyperlinkMaps(const TextBuffer& OtherBuffer);\r\n \r\n-    size_t SpanLength(const til::point coordStart, const til::point coordEnd) const;\r\n-\r\n     std::wstring GetPlainText(til::point start, til::point end) const;\r\n \r\n     struct CopyRequest\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex 0a94352e724..4bd41d58d01 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -2868,6 +2868,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // coloring other matches, then we need to make sure those get redrawn,\r\n                 // too.\r\n                 _renderer->TriggerRedrawAll();\r\n+                _updateSelectionUI();\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 9e6350df044..91def441079 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1571,10 +1571,10 @@ void Terminal::SerializeMainBuffer(const wchar_t* destination) const\n \r\n void Terminal::ColorSelection(const TextAttribute& attr, winrt::Microsoft::Terminal::Core::MatchMode matchMode)\r\n {\r\n-    const auto colorSelection = [this](const til::point coordStart, const til::point coordEnd, const TextAttribute& attr) {\r\n+    const auto colorSelection = [this](const til::point coordStartInclusive, const til::point coordEndExclusive, const TextAttribute& attr) {\r\n         auto& textBuffer = _activeBuffer();\r\n-        const auto spanLength = textBuffer.SpanLength(coordStart, coordEnd);\r\n-        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStart);\r\n+        const auto spanLength = textBuffer.GetSize().CompareInBounds(coordEndExclusive, coordStartInclusive, true);\r\n+        textBuffer.Write(OutputCellIterator(attr, spanLength), coordStartInclusive);\r\n     };\r\n \r\n     for (const auto [start, end] : _GetSelectionSpans())\r\n", "instance_id": "microsoft__terminal-18798", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear, as it describes a specific issue with the \"Color Selection\" feature in Windows Terminal, where the colorization extends one character beyond the intended selection. It provides a version number, a screenshot for visual reference, and clearly states the expected versus actual behavior. However, there are minor ambiguities: the problem statement does not explicitly mention whether this issue occurs under specific conditions (e.g., certain text encodings, buffer sizes, or selection modes beyond \"all matches\"). Additionally, edge cases or constraints (e.g., behavior with empty selections, selections at buffer boundaries) are not addressed. These missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis across the evaluation factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the logic behind the off-by-one error is straightforward—an inclusive range calculation likely needs adjustment. This is a common type of bug in text buffer handling, reducing the conceptual complexity.\n\n2. **Scope and Depth of Code Changes**: The provided diff shows modifications across four files (`textBuffer.cpp`, `textBuffer.hpp`, `ControlCore.cpp`, and `Terminal.cpp`). However, the core fix is localized to replacing the `SpanLength` method with a direct calculation in `Terminal.cpp`, adjusting for inclusive/exclusive bounds. Additional changes, like triggering a UI update in `ControlCore.cpp`, are minor. The changes do not impact the broader system architecture and involve a small amount of code, mostly removing or tweaking existing logic rather than adding significant new functionality.\n\n3. **Number of Technical Concepts**: Solving this requires understanding basic C++ concepts (e.g., method calls, parameter passing), familiarity with the project's custom types (e.g., `til::point`, `TextAttribute`), and a grasp of text buffer manipulation. The off-by-one error fix involves understanding coordinate range calculations, which is a fundamental concept in text rendering or buffer management. No advanced algorithms, design patterns, or domain-specific knowledge beyond terminal rendering basics are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest the issue is related to boundary calculations (inclusive vs. exclusive ranges). The fix appears to handle the general case, but there’s no indication of additional error handling or edge case considerations (e.g., selections at the start/end of a buffer, empty selections). The complexity of edge cases seems minimal based on the provided diff.\n\nOverall, this problem requires understanding a specific part of the codebase (text buffer and selection logic) and making a targeted fix for an off-by-one error, which is a common and relatively simple bug to resolve. The changes span multiple files but are not extensive or architecturally significant. Therefore, a difficulty score of 0.35 is appropriate, reflecting an \"Easy\" problem that requires moderate code logic understanding and simple modifications.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Alt and F7 don't work in 1.23.3481.0\n### Windows Terminal version\n\n1.23.3481.0\n\n### Windows build number\n\n10.0.19045.5247\n\n### Other Software\n\nFAR Manager 3.0.6401.0 x64\n\nwhen migrate from canary build terminal-1.23.3461.0 to next canary build terminal-1.23.3481.0\ni have trouble with keys: Alt/RAlt and F7\n\n### Steps to reproduce\n\nrun utility KeyEvents.exe and press Alt and F7\n\n\n\n### Expected Behavior\n\nresult when press Alt:\n\nterminal-1.23.3461.0 - good behavior\n02:56:37 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n02:56:37 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\nresult when press f7:\n\nterminal-1.23.3461.0 - good behavior\n\n03:08:36 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:08:36 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n### Actual Behavior\n\nresult when press Alt:\n\nterminal-1.23.3481.0 - bad behavior\n02:54:44 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_MENU\" [18/0x0012], Scan=0x0038 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n\n\nresult when press f7:\n\nterminal-1.23.3481.0 - bad behavior\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n03:02:27 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_F7\" [118/0x0076], Scan=0x0041 uChar=[U=' ' (0x0000): A=' ' (0x00)]\n         Ctrl=0x00000000 (casac - ecns) (Windowed)\n\n", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..91e1a9bdb92 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -387,6 +387,9 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     MSG msg{};\r\n     while (GetMessageW(&msg, nullptr, 0, 0))\r\n     {\r\n+        // This is `if (WM_KEYDOWN || WM_KEYUP || WM_SYSKEYDOWN || WM_SYSKEYUP)`.\r\n+        // It really doesn't need to be written that obtuse, but it at\r\n+        // least nicely mirrors our `keyDown = msg.message & 1` logic.\r\n         // FYI: For the key-down/up messages the lowest bit indicates if it's up.\r\n         if ((msg.message & ~1) == WM_KEYDOWN || (msg.message & ~1) == WM_SYSKEYDOWN)\r\n         {\r\n@@ -401,7 +404,7 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 loggedInteraction = true;\r\n             }\r\n \r\n-            const bool keyDown = msg.message & 1;\r\n+            const bool keyDown = (msg.message & 1) == 0;\r\n             if (\r\n                 // GH#638: The Xaml input stack doesn't allow an application to suppress the \"caret browsing\"\r\n                 // dialog experience triggered when you press F7. Official recommendation from the Xaml\r\n@@ -438,15 +441,13 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n     __assume(false);\r\n }\r\n \r\n-void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\r\n+void WindowEmperor::_dispatchSpecialKey(const MSG& msg) const\r\n {\r\n-    const auto hwnd = msg.hwnd;\r\n+    // Each CoreInput window is a child of our IslandWindow.\r\n+    // We can figure out the IslandWindow HWND via GetAncestor().\r\n+    const auto hwnd = GetAncestor(msg.hwnd, GA_ROOT);\r\n     AppHost* window = nullptr;\r\n \r\n-    // Just in case someone has targed a specific HWND,\r\n-    // we'll try to dispatch it to the corresponding class.\r\n-    // Usually this will not find anything because under WinUI the hidden CoreInput\r\n-    // window is responsible for all input handling (for whatever reason).\r\n     for (const auto& h : _windows)\r\n     {\r\n         const auto w = h->GetWindow();\r\n@@ -457,6 +458,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n         }\r\n     }\r\n \r\n+    // Fallback.\r\n     if (!window)\r\n     {\r\n         window = _mostRecentWindow();\r\n@@ -468,7 +470,7 @@ void WindowEmperor::_dispatchSpecialKey(MSG& msg) const\n \r\n     const auto vkey = gsl::narrow_cast<uint32_t>(msg.wParam);\r\n     const auto scanCode = gsl::narrow_cast<uint8_t>(msg.lParam >> 16);\r\n-    const bool keyDown = msg.message & 1;\r\n+    const bool keyDown = (msg.message & 1) == 0;\r\n     window->OnDirectKeyEvent(vkey, scanCode, keyDown);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex 6b9b101507f..ca30159ac2d 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -50,7 +50,7 @@ class WindowEmperor\n     AppHost* _mostRecentWindow() const noexcept;\r\n     bool _summonWindow(const SummonWindowSelectionArgs& args) const;\r\n     void _summonAllWindows() const;\r\n-    void _dispatchSpecialKey(MSG& msg) const;\r\n+    void _dispatchSpecialKey(const MSG& msg) const;\r\n     void _dispatchCommandline(winrt::TerminalApp::CommandlineArgs args);\r\n     safe_void_coroutine _dispatchCommandlineCurrentDesktop(winrt::TerminalApp::CommandlineArgs args);\r\n     LRESULT _messageHandler(HWND window, UINT message, WPARAM wParam, LPARAM lParam) noexcept;\r\n", "instance_id": "microsoft__terminal-18444", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the behavior of Alt and F7 keys has regressed in a specific version of Windows Terminal (1.23.3481.0) compared to a previous version (1.23.3461.0). It provides detailed logs of expected and actual behavior for key events, which helps in understanding the problem. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the desired fix or the root cause of the issue (though the code changes imply it). Additionally, there is no mention of specific edge cases or constraints beyond the key events shown in the logs. While the steps to reproduce are provided, they rely on an external utility (KeyEvents.exe) without details on how to obtain or use it. Overall, the problem is valid and mostly clear but lacks some minor contextual details and explicit requirements for the solution.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of code changes is relatively small and localized to a single file (`WindowEmperor.cpp`) with minor updates to a header file (`WindowEmperor.h`). The changes primarily involve fixing the logic for detecting key down/up events by correcting a bitwise operation and improving the handling of window hierarchy for key event dispatching. This requires a basic understanding of Windows API message handling (e.g., `WM_KEYDOWN`, `WM_KEYUP`, `GetAncestor`) and bitwise operations, which are not overly complex for an experienced developer. The problem does not appear to impact the broader system architecture significantly, nor does it require extensive modifications across multiple modules. However, it does demand some domain-specific knowledge of Windows Terminal's input handling and the nuances of key event processing in the Windows API, which adds a slight layer of complexity. Edge cases and error handling are not explicitly mentioned in the problem statement, and the code changes do not introduce significant new error handling logic, keeping the difficulty moderate. Overall, this is a straightforward bug fix that requires understanding a specific part of the codebase and making targeted modifications, justifying a score of 0.35.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal - Command Palette]: 'Shortcut keys' in 'Command Palette' are not visible in high contrast themes for focused or hovered rows.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Pre-requisite:**\r\nSettings>Accessibility>Contrast themes>Aquatic/Desert theme>Reopen the application.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Follow the above-mentioned pre-requisite step.\r\n3. Now open any application like 'Windows Terminal'.\r\n4. Open command Palette by pressing 'Ctrl + Shift + P' keys.\r\n5. 'Command Palette' will open.\r\n6.  Now navigate to any row by up/down arrow keys or hover with mouse.\r\n7. Observe the issue.\r\n\r\n**User experience:**\r\nUsers relying on high contrast themes, especially those with visual impairments, may find it challenging to see the shortcut keys in the Command Palette. This issue impacts navigation efficiency, as users cannot easily identify or use the shortcuts for commands.\r\n\r\n**MAS Reference Link:**\r\n[MAS 4.3.1 – No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)\r\n\r\n**Attachment:**\r\n[Shortcut keys is not visible in high contrast themes.zip](https://github.com/user-attachments/files/16973765/Shortcut.keys.is.not.visible.in.high.contrast.themes.zip)\n\n### Expected Behavior\n\nThe shortcut keys for commands in the Command Palette should be clearly visible in high contrast themes when rows are focused or hovered. Proper contrast between the text and background should ensure that users can easily see the shortcut keys.\n\n### Actual Behavior\n\nThe shortcut keys associated with the commands in the Command Palette are not visible or are poorly visible when focused or hovered in high contrast themes. The lack of proper contrast makes it difficult to see the shortcut keys, impairing navigation.\n", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.xaml b/src/cascadia/TerminalApp/CommandPalette.xaml\nindex eb47534f9c5..2ed0c136e5f 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.xaml\n+++ b/src/cascadia/TerminalApp/CommandPalette.xaml\n@@ -23,6 +23,27 @@\n \r\n     <UserControl.Resources>\r\n         <ResourceDictionary>\r\n+            <!--  KeyChordText styles  -->\r\n+            <Style x:Key=\"KeyChordBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n+                <Setter Property=\"Background\" Value=\"Transparent\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <Style x:Key=\"KeyChordTextBlockStyle\"\r\n+                   TargetType=\"TextBlock\">\r\n+                <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n+            </Style>\r\n+            <!--  ParsedCommandLineText styles  -->\r\n+            <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n+                   TargetType=\"Border\">\r\n+                <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n+                <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n+                <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n+                <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n+            </Style>\r\n+\r\n             <DataTemplate x:Key=\"ListItemTemplate\"\r\n                           x:DataType=\"local:FilteredCommand\">\r\n                 <ListViewItem HorizontalContentAlignment=\"Stretch\"\r\n@@ -69,12 +90,12 @@\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n                             Background=\"{ThemeResource FlyoutPresenterBackground}\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n                 </Grid>\r\n@@ -118,12 +139,12 @@\n                             HorizontalAlignment=\"Right\"\r\n                             VerticalAlignment=\"Center\"\r\n                             AutomationProperties.AccessibilityView=\"Raw\"\r\n-                            Style=\"{ThemeResource KeyChordBorderStyle}\"\r\n+                            Style=\"{StaticResource KeyChordBorderStyle}\"\r\n                             Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(Item.KeyChordText), Mode=OneWay}\">\r\n \r\n                         <TextBlock AutomationProperties.AccessibilityView=\"Raw\"\r\n                                    FontSize=\"12\"\r\n-                                   Style=\"{ThemeResource KeyChordTextBlockStyle}\"\r\n+                                   Style=\"{StaticResource KeyChordTextBlockStyle}\"\r\n                                    Text=\"{x:Bind Item.KeyChordText, Mode=OneWay}\" />\r\n                     </Border>\r\n \r\n@@ -219,79 +240,6 @@\n                                                GeneralItemTemplate=\"{StaticResource GeneralItemTemplate}\"\r\n                                                NestedItemTemplate=\"{StaticResource NestedItemTemplate}\"\r\n                                                TabItemTemplate=\"{StaticResource TabItemTemplate}\" />\r\n-\r\n-            <ResourceDictionary.ThemeDictionaries>\r\n-                <ResourceDictionary x:Key=\"Dark\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"Light\">\r\n-\r\n-                    <!--  KeyChordText styles  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"2\" />\r\n-                        <Setter Property=\"Background\" Value=\"Transparent\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-\r\n-                    <!--  ParsedCommandLineText styles  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\">\r\n-                        <Setter Property=\"BorderThickness\" Value=\"1\" />\r\n-                        <Setter Property=\"CornerRadius\" Value=\"{ThemeResource ControlCornerRadius}\" />\r\n-                        <Setter Property=\"Background\" Value=\"{ThemeResource CardBackgroundFillColorDefaultBrush}\" />\r\n-                        <Setter Property=\"BorderBrush\" Value=\"{ThemeResource CardStrokeColorDefaultBrush}\" />\r\n-                    </Style>\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\">\r\n-                        <Setter Property=\"Foreground\" Value=\"{ThemeResource SystemControlForegroundBaseMediumBrush}\" />\r\n-                    </Style>\r\n-                </ResourceDictionary>\r\n-                <ResourceDictionary x:Key=\"HighContrast\">\r\n-\r\n-                    <!--  KeyChordText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"KeyChordBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"KeyChordTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-\r\n-                    <!--  ParsedCommandLineText styles (use XAML defaults for High Contrast theme)  -->\r\n-                    <Style x:Key=\"ParsedCommandLineBorderStyle\"\r\n-                           TargetType=\"Border\" />\r\n-                    <Style x:Key=\"ParsedCommandLineTextBlockStyle\"\r\n-                           TargetType=\"TextBlock\" />\r\n-                </ResourceDictionary>\r\n-            </ResourceDictionary.ThemeDictionaries>\r\n         </ResourceDictionary>\r\n     </UserControl.Resources>\r\n \r\n@@ -375,7 +323,7 @@\n                     Padding=\"16,12\"\r\n                     HorizontalAlignment=\"Stretch\"\r\n                     VerticalAlignment=\"Center\"\r\n-                    Style=\"{ThemeResource ParsedCommandLineBorderStyle}\"\r\n+                    Style=\"{StaticResource ParsedCommandLineBorderStyle}\"\r\n                     Visibility=\"{x:Bind mtu:Converters.StringNotEmptyToVisibility(ParsedCommandLineText), Mode=OneWay}\">\r\n \r\n                 <ScrollViewer MaxHeight=\"200\"\r\n", "instance_id": "microsoft__terminal-18132", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: shortcut keys in the Command Palette of Windows Terminal are not visible in high contrast themes when rows are focused or hovered. It provides detailed steps to reproduce the issue, specifies the expected and actual behavior, and highlights the user impact, particularly for those with visual impairments. Additionally, it includes relevant context such as the Windows Terminal version, build number, and test environment. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly mention whether the issue affects all high contrast themes or only specific ones (though \"Aquatic/Desert\" themes are referenced in the steps). It also lacks detailed guidance on the desired contrast ratio or specific visual requirements for compliance with accessibility standards (beyond referencing a MAS document). These missing details could lead to slight uncertainty during implementation, but overall, the goal and scope of the problem are well-defined.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are confined to a single file (`CommandPalette.xaml`), focusing on the styling of UI elements (specifically, borders and text blocks for shortcut keys). The changes involve moving style definitions from theme-specific dictionaries (Dark, Light, HighContrast) to a general resource dictionary and updating references from `ThemeResource` to `StaticResource`. This is a relatively small and localized modification, with no apparent impact on the broader system architecture or interactions with other modules. The amount of code changed is moderate, primarily involving the deletion of redundant theme-specific styles and the addition of generalized styles.\n\n2. **Number of Technical Concepts**: Solving this problem requires a basic understanding of XAML (Extensible Application Markup Language) for UI design in Windows applications, specifically how styles and resources are defined and applied in different themes (including high contrast themes). Familiarity with Windows Terminal's theming system and accessibility considerations (e.g., contrast ratios) is necessary but not overly complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond UI styling are required.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the general issue of visibility in high contrast themes. The code changes do not introduce or modify error handling logic, as they are purely stylistic. However, the developer must ensure that the new styles do not inadvertently break visibility or accessibility in other themes or contexts, which adds a minor layer of caution but not significant complexity.\n\n4. **Overall Complexity**: The task is straightforward—adjusting UI styles to ensure visibility in high contrast themes. It requires understanding the intent behind the style changes (e.g., leveraging system default brushes for better contrast) and verifying the result across different themes. However, it does not demand deep knowledge of the Windows Terminal codebase or complex refactoring. The primary challenge lies in ensuring compliance with accessibility standards, but the provided changes already address the core issue.\n\nGiven these considerations, a difficulty score of 0.30 reflects an \"Easy\" problem that requires some understanding of XAML and theming but involves minimal risk, scope, and technical depth. It is slightly above the \"Very Easy\" range due to the need to validate the changes across multiple themes and ensure accessibility compliance, but it remains a relatively simple fix.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Knobs do not align with text labels\nIn my panel SVG generator [make_sapphire_svg.py](https://github.com/cosinekitty/sapphire/blob/main/util/make_sapphire_svg.py), I have a development command line option \"preview\". When present, the export panels get generated with a thin black outline circle where I think each knob should be.\n\nWhen I use this option, then build sapphire-plugins, then run Bitwig, I can see the knobs are not where I want them. The text labels appear to be exactly where I want them. The result is visual misalignment. The knobs should be horizontally centered directly beneath the center of their respective labels. Here is a screenshot that shows real knobs + my fake circles showing where they should be.\n\n![Image](https://github.com/user-attachments/assets/105d58d7-7078-43d0-837c-549145b91666)\n\nHere is a screenshot of the raw preview svg by itself, with no knobs rendered on top:\n\n![Image](https://github.com/user-attachments/assets/64e4a4ab-d818-4059-93d0-47a7a87e8c7b)\n", "patch": "diff --git a/src/shared/editor_interactions.h b/src/shared/editor_interactions.h\nindex ee26d0e..8667d96 100644\n--- a/src/shared/editor_interactions.h\n+++ b/src/shared/editor_interactions.h\n@@ -281,14 +281,15 @@ inline void set_control_position(juce::Component &control, float cx, float cy, f\n }\n template <typename Editor>\n std::unique_ptr<juce::Slider> makeLargeKnob(Editor *editor, const std::string &prefix,\n-                                            const std::string pos)\n+                                            const std::string pos,\n+                                            float extraDx = 0.f) // see #33\n {\n     auto r = Sapphire::FindComponent(prefix, pos);\n     auto cx = r.cx;\n     auto cy = r.cy;\n \n-    static constexpr float dx = 1.5;\n-    static constexpr float dy = 0.0;\n+    float dx = 1.5 - extraDx;\n+    float dy = 0.5;\n     auto kn = std::make_unique<juce::Slider>();\n     kn->setSliderStyle(juce::Slider::RotaryHorizontalVerticalDrag);\n     kn->setTextBoxStyle(juce::Slider::NoTextBox, true, 0, 0);\ndiff --git a/src/tube_unit/editor.cpp b/src/tube_unit/editor.cpp\nindex 9c6226f..9c4ffd5 100644\n--- a/src/tube_unit/editor.cpp\n+++ b/src/tube_unit/editor.cpp\n@@ -50,31 +50,32 @@ TubeUnitEditor::TubeUnitEditor(shared::audioToUIQueue_t &atou, shared::uiToAudio\n \n     const std::string modcode(\"tubeunit_export\");\n \n-    airflow = shared::makeLargeKnob(this, modcode, \"airflow_knob\");\n+    // see #33 for this 1.0\n+    airflow = shared::makeLargeKnob(this, modcode, \"airflow_knob\", 1.0);\n     shared::bindSlider(this, airflow, patchCopy.airflow);\n \n-    vortex = shared::makeLargeKnob(this, modcode, \"vortex_knob\");\n+    vortex = shared::makeLargeKnob(this, modcode, \"vortex_knob\", 1.0);\n     shared::bindSlider(this, vortex, patchCopy.vortex);\n \n-    width = shared::makeLargeKnob(this, modcode, \"width_knob\");\n+    width = shared::makeLargeKnob(this, modcode, \"width_knob\", 1.0);\n     shared::bindSlider(this, width, patchCopy.width);\n \n-    center = shared::makeLargeKnob(this, modcode, \"center_knob\");\n+    center = shared::makeLargeKnob(this, modcode, \"center_knob\", 1.0);\n     shared::bindSlider(this, center, patchCopy.center);\n \n-    decay = shared::makeLargeKnob(this, modcode, \"decay_knob\");\n+    decay = shared::makeLargeKnob(this, modcode, \"decay_knob\", 1.0);\n     shared::bindSlider(this, decay, patchCopy.decay);\n \n-    angle = shared::makeLargeKnob(this, modcode, \"angle_knob\");\n+    angle = shared::makeLargeKnob(this, modcode, \"angle_knob\", 1.0);\n     shared::bindSlider(this, angle, patchCopy.angle);\n \n-    root = shared::makeLargeKnob(this, modcode, \"root_knob\");\n+    root = shared::makeLargeKnob(this, modcode, \"root_knob\", 1.0);\n     shared::bindSlider(this, root, patchCopy.root);\n \n-    spring = shared::makeLargeKnob(this, modcode, \"spring_knob\");\n+    spring = shared::makeLargeKnob(this, modcode, \"spring_knob\", 1.0);\n     shared::bindSlider(this, spring, patchCopy.spring);\n \n-    mix = shared::makeLargeKnob(this, modcode, \"mix_knob\");\n+    mix = shared::makeLargeKnob(this, modcode, \"mix_knob\", 1.0);\n     shared::bindSlider(this, mix, patchCopy.mix);\n \n     auto dim = shared::getPanelDimensions(modcode, 2);\n", "instance_id": "baconpaul__sapphire-plugins-34", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the knobs in a generated SVG panel for a plugin are misaligned with their text labels, and the goal is to adjust their positions to be horizontally centered beneath the labels. The inclusion of screenshots and references to specific files (e.g., make_sapphire_svg.py) and command-line options (\"preview\") helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the exact coordinate system or scaling factors used in the SVG or the plugin rendering environment (e.g., Bitwig), which could affect the interpretation of \"centered beneath.\" Additionally, while the issue is visually demonstrated, there are no specific numerical values or constraints provided for the desired offset or alignment logic. Edge cases, such as varying label sizes or panel dimensions, are not mentioned. Thus, while the goal is clear, some minor details that could impact the solution are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis across the specified factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively localized, primarily affecting two files: `editor_interactions.h` and `editor.cpp`. The modifications involve adding a parameter (`extraDx`) to the `makeLargeKnob` function and adjusting the positioning logic with hardcoded offset values (`dx` and `dy`). The changes are applied consistently across multiple knob instances in the editor file, but they do not impact the broader system architecture or require extensive refactoring. The overall amount of code change is small, focusing on tweaking numerical offsets.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of GUI component positioning in the JUCE framework (used for audio plugin development), specifically how coordinates (`cx`, `cy`, `dx`, `dy`) are applied to place UI elements like sliders/knobs. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI layout logic are needed. Familiarity with C++ (function parameters, templates) is sufficient, and the concepts involved are straightforward for a developer with moderate experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, such as varying panel sizes, label widths, or rendering differences across environments (e.g., different DAWs beyond Bitwig). The code changes also do not introduce or modify error handling logic. While there might be implicit edge cases (e.g., ensuring the hardcoded offsets work across different resolutions or SVG scales), addressing them does not appear to be a primary concern in the provided diff, keeping the complexity low.\n\n4. **Overall Assessment:** The task involves understanding a small part of the codebase related to UI positioning and making simple modifications to adjust knob placement. It does not require deep architectural changes, complex logic, or advanced technical knowledge. The hardcoded nature of the solution (adjusting `dx` and `dy`) suggests a trial-and-error approach rather than a sophisticated algorithmic fix, further reducing the difficulty. A score of 0.30 reflects an \"Easy\" problem that requires minimal effort beyond tweaking values and understanding basic UI placement logic in JUCE.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "shell.showItemInFolder won't open Explorer if forward slashes are present in path\n* Electron version: 1.7.10\r\n* Operating system: Windows 10, build 1709\r\n\r\nIf a path contains forward slash(es) on Windows (e.g. `C:\\some\\app/index.html`), ~~showItemInFolder will open the containing directory but will not select the file.~~ In Electron 8.x and newer, showItemInFolder will not open an Explorer window at all if forward slashes are present in path.\r\n\r\n### How to reproduce\r\n\r\nhttps://github.com/YellowAfterlife/abug-electron-showItemInFolder-forward-slashes\r\n```js\r\nconst electron = require('electron')\r\nconst app = electron.app\r\nconst path = require('path')\r\napp.on('ready', () => {\r\n\tlet test = path.join(__dirname, 'index.html')\r\n\ttest = test.replace(/^(.+)\\\\(.+)$/, \"$1/$2\") // simulate a forward slash in path\r\n\tconsole.log(test)\r\n\tconsole.log(electron.shell.showItemInFolder(test))\r\n\tapp.quit()\r\n})\r\n```\r\n\r\nFrom what I've seen, no other shell functions show this kind of \"partial success\" behaviour while returning `true`.\n", "patch": "diff --git a/shell/common/platform_util_win.cc b/shell/common/platform_util_win.cc\nindex a2deae69bf112..43684fc9e0efa 100644\n--- a/shell/common/platform_util_win.cc\n+++ b/shell/common/platform_util_win.cc\n@@ -336,7 +336,8 @@ void ShowItemInFolder(const base::FilePath& full_path) {\n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n       ->PostTask(FROM_HERE,\n-                 base::BindOnce(&ShowItemInFolderOnWorkerThread, full_path));\n+                 base::BindOnce(&ShowItemInFolderOnWorkerThread,\n+                                full_path.NormalizePathSeparators()));\n }\n \n void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n@@ -344,9 +345,11 @@ void OpenPath(const base::FilePath& full_path, OpenCallback callback) {\n \n   base::ThreadPool::CreateCOMSTATaskRunner(\n       {base::MayBlock(), base::TaskPriority::USER_BLOCKING})\n-      ->PostTaskAndReplyWithResult(FROM_HERE,\n-                                   base::BindOnce(&OpenPathOnThread, full_path),\n-                                   std::move(callback));\n+      ->PostTaskAndReplyWithResult(\n+          FROM_HERE,\n+          base::BindOnce(&OpenPathOnThread,\n+                         full_path.NormalizePathSeparators()),\n+          std::move(callback));\n }\n \n void OpenExternal(const GURL& url,\n", "instance_id": "electron__electron-41642", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `shell.showItemInFolder` function in Electron fails to open an Explorer window on Windows when the provided path contains forward slashes. It provides specific details such as the Electron version (1.7.10 and 8.x+), the operating system (Windows 10, build 1709), and a reproducible code snippet to demonstrate the issue. The goal of fixing this behavior is implied, and the provided code changes align with addressing the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., should the function normalize the path or reject invalid paths?) beyond implying it should work with forward slashes. Additionally, edge cases (e.g., mixed slashes, invalid paths, or non-existent files) are not mentioned, which could impact the solution's completeness. Overall, the statement is valid and clear but lacks some minor details for a fully comprehensive description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to a single file (`platform_util_win.cc`). The modification involves adding a call to `NormalizePathSeparators()` on the `full_path` before passing it to the worker thread functions `ShowItemInFolderOnWorkerThread` and `OpenPathOnThread`. This change does not impact the broader system architecture and requires only a small amount of code modification (a few lines).\n\n2. **Technical Concepts Involved**: Solving this issue requires basic familiarity with C++ (the language used in the codebase), specifically understanding file path handling in Windows and the use of the `base::FilePath` class from the Chromium base library. The concept of normalizing path separators (converting forward slashes to backslashes on Windows) is straightforward and does not involve complex algorithms, design patterns, or domain-specific knowledge beyond basic OS-specific file handling.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change implies a simple solution of normalizing separators, which may not fully address scenarios like mixed slashes, invalid paths, or non-existent files. However, the provided fix does not introduce new error handling logic, and the complexity of potential edge cases appears minimal at this stage.\n\n4. **Overall Complexity**: The task requires understanding a small part of the Electron/Chromium codebase related to file path utilities and making a simple modification. It does not demand deep knowledge of the overall architecture or interactions between multiple modules. The fix is essentially a one-line addition per affected function, making it a relatively simple bug fix.\n\nGiven these points, a difficulty score of 0.30 reflects the ease of the task, requiring only basic code modification and minimal conceptual depth, though with some consideration for potential unaddressed edge cases.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector Section doesn't always update hover state\n### Tested versions\n\n4.5 master\n\n### System information\n\nWindows 10\n\n### Issue description\n\nThe hover state on inspector section headers doesn't update when cursor moves in or out of the header rect. It only updates when leaving or entering the entire Control\n\n### Steps to reproduce\n\nCreate any node. Expand an inspector section. Move the cursor in and out of the header rect.\n\nhttps://github.com/user-attachments/assets/b4e0a0fb-9cb2-4e40-8069-f1975cb71dd7\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex dd0030d134f6..0a03583b4bf9 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -1888,6 +1888,15 @@ void EditorInspectorSection::gui_input(const Ref<InputEvent> &p_event) {\n \t} else if (mb.is_valid() && !mb->is_pressed()) {\n \t\tqueue_redraw();\n \t}\n+\n+\tRef<InputEventMouseMotion> mm = p_event;\n+\tif (mm.is_valid()) {\n+\t\tint header_height = _get_header_height();\n+\t\tVector2 previous = mm->get_position() - mm->get_relative();\n+\t\tif ((mm->get_position().y >= header_height) != (previous.y >= header_height)) {\n+\t\t\tqueue_redraw();\n+\t\t}\n+\t}\n }\n \n String EditorInspectorSection::get_section() const {\n", "instance_id": "godotengine__godot-103670", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the hover state of inspector section headers in a GUI does not update correctly when the cursor moves in or out of the header area, only updating when entering or leaving the entire control. The steps to reproduce are provided, along with a reference to a visual asset for context, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what the expected behavior should be (e.g., should the hover state update immediately on cursor movement within the header rect?). Additionally, there are no mentions of specific edge cases or constraints, such as performance considerations for frequent redraws or behavior on different platforms. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is limited to a single file (`editor_inspector.cpp`) and a specific function (`gui_input`), involving a small addition of logic to handle mouse motion events and trigger a redraw when the cursor crosses the header boundary. The change does not impact the broader system architecture or require modifications across multiple modules. Second, the technical concepts involved are relatively straightforward: basic GUI event handling (mouse motion events), coordinate comparison, and triggering a redraw operation, all of which are standard in GUI programming and do not require advanced language features or complex algorithms. Third, while the problem statement does not explicitly mention edge cases, the code change suggests a simple boundary check for the header height, with no complex error handling or performance optimization required. Overall, solving this issue requires understanding some code logic and making a simple modification, aligning with an easy difficulty level. I assign a score of 0.30 to reflect that it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to handle mouse motion events and calculate relative positions, but it remains a straightforward task for a developer familiar with GUI programming.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Negative scaling is broken when using Jolt Physics\n### Tested versions\n\n\nv4.4.rc2.mono.official [01545c995]\n\nThis error appeared after upgrading to 4.4rc2 from 4.3.  I was previously using the jolt physics add on.  \n\nThis error goes away if i switch to the godot physics engine instead.  It reappears if using jolt.  \n\n### System information\n\nGodot v4.4.rc2.mono - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 (NVIDIA; 32.0.15.6603) - AMD Ryzen 7 3700X 8-Core Processor (16 threads)\n\n### Issue description\n\nWith Jolt Physics enabled, when adding a static body as a child of a VehicleWheel3D I get a flood of quaternion errors:\n\n```\nE 0:00:01:120   get_quaternion: Basis [X: (1.0, 0.0, 0.0), Y: (0.0, 1.0, 0.0), Z: (0.0, 0.0, -1.0)] must be \nnormalized in order to be casted to a Quaternion. Use get_rotation_quaternion() or call orthonormalized() \nif the Basis contains linearly independent vectors.\n  <C++ Error>   Condition \"!is_rotation()\" is true. Returning: Quaternion()\n  <C++ Source>  core/math/basis.cpp:730 @ get_quaternion()\n```\n\nI can get rid of the errors if I move the StaticBody3D outside of the VehicleWheel3D.  I do expect it to work as before.  I prefer adding a staticBody3D as a child of VehicleWheel3D for organizations sake. \n\n### Steps to reproduce\n\n1. Enable Jolt Physics under Project -> Project Settings -> Physics -> 3D -> Physics Engine\n2. Add a VehicleBody3D node with a collision mesh\n3. Add a VehicleWheel3D node\n4. Add a StaticBody3D node as a child of the VehicleWheel3D\n5. Launch the scene and a flood of quaternion errors should appear\n\nIncluding project as well.  Open the project and run.  \n\nThank you.\n\n### Minimal reproduction project (MRP)\n\n[mrpWheelStaticBodyChild.zip](https://github.com/user-attachments/files/19031403/mrpWheelStaticBodyChild.zip)\n", "patch": "diff --git a/modules/jolt_physics/misc/jolt_math_funcs.cpp b/modules/jolt_physics/misc/jolt_math_funcs.cpp\nnew file mode 100644\nindex 000000000000..b0ef5f45747d\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.cpp\n@@ -0,0 +1,70 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.cpp                                                   */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+/*\n+Adapted to Godot from the Jolt Physics library.\n+*/\n+\n+/*\n+Copyright 2021 Jorrit Rouwe\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the \"Software\"), to deal in\n+the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of\n+the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR\n+A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN\n+ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.\n+*/\n+\n+#include \"jolt_math_funcs.h\"\n+\n+void JoltMath::decompose(Basis &p_basis, Vector3 &r_scale) {\n+\tVector3 x = p_basis.get_column(Vector3::AXIS_X);\n+\tVector3 y = p_basis.get_column(Vector3::AXIS_Y);\n+\tVector3 z = p_basis.get_column(Vector3::AXIS_Z);\n+\n+\tconst real_t x_dot_x = x.dot(x);\n+\ty -= x * (y.dot(x) / x_dot_x);\n+\tz -= x * (z.dot(x) / x_dot_x);\n+\tconst real_t y_dot_y = y.dot(y);\n+\tz -= y * (z.dot(y) / y_dot_y);\n+\tconst real_t z_dot_z = z.dot(z);\n+\n+\tconst real_t det = x.cross(y).dot(z);\n+\n+\tr_scale = SIGN(det) * Vector3(Math::sqrt(x_dot_x), Math::sqrt(y_dot_y), Math::sqrt(z_dot_z));\n+\n+\tp_basis.set_column(Vector3::AXIS_X, x / r_scale.x);\n+\tp_basis.set_column(Vector3::AXIS_Y, y / r_scale.y);\n+\tp_basis.set_column(Vector3::AXIS_Z, z / r_scale.z);\n+}\ndiff --git a/modules/jolt_physics/misc/jolt_math_funcs.h b/modules/jolt_physics/misc/jolt_math_funcs.h\nnew file mode 100644\nindex 000000000000..ba2d290ac77c\n--- /dev/null\n+++ b/modules/jolt_physics/misc/jolt_math_funcs.h\n@@ -0,0 +1,59 @@\n+/**************************************************************************/\n+/*  jolt_math_funcs.h                                                     */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef JOLT_MATH_FUNCS_H\n+#define JOLT_MATH_FUNCS_H\n+\n+#include \"core/math/transform_3d.h\"\n+\n+class JoltMath {\n+public:\n+\t// Note that `p_basis` is mutated to be right-handed orthonormal.\n+\tstatic void decompose(Basis &p_basis, Vector3 &r_scale);\n+\n+\t// Note that `p_transform` is mutated to be right-handed orthonormal.\n+\tstatic _FORCE_INLINE_ void decompose(Transform3D &p_transform, Vector3 &r_scale) {\n+\t\tdecompose(p_transform.basis, r_scale);\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Basis &p_basis, Basis &r_new_basis, Vector3 &r_scale) {\n+\t\tBasis new_basis = p_basis;\n+\t\tdecompose(new_basis, r_scale);\n+\t\tr_new_basis = new_basis;\n+\t}\n+\n+\tstatic _FORCE_INLINE_ void decomposed(const Transform3D &p_transform, Transform3D &r_new_transform, Vector3 &r_scale) {\n+\t\tTransform3D new_transform;\n+\t\tdecompose(new_transform, r_scale);\n+\t\tr_new_transform = new_transform;\n+\t}\n+};\n+\n+#endif // JOLT_MATH_FUNCS_H\ndiff --git a/modules/jolt_physics/objects/jolt_area_3d.cpp b/modules/jolt_physics/objects/jolt_area_3d.cpp\nindex b0a9ffd62225..0a2693ddb634 100644\n--- a/modules/jolt_physics/objects/jolt_area_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_area_3d.cpp\n@@ -31,6 +31,7 @@\n #include \"jolt_area_3d.h\"\n \n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -370,7 +371,8 @@ void JoltArea3D::set_default_area(bool p_value) {\n void JoltArea3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to area '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -378,8 +380,6 @@ void JoltArea3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_body_3d.cpp b/modules/jolt_physics/objects/jolt_body_3d.cpp\nindex ac2b37470ef1..5bc3aee1bce7 100644\n--- a/modules/jolt_physics/objects/jolt_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_body_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../joints/jolt_joint_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n #include \"../spaces/jolt_broad_phase_layer.h\"\n@@ -543,7 +544,8 @@ JoltBody3D::~JoltBody3D() {\n void JoltBody3D::set_transform(Transform3D p_transform) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed to physics body '%s'.\", to_string()));\n \n-\tconst Vector3 new_scale = p_transform.basis.get_scale();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \t// Ideally we would do an exact comparison here, but due to floating-point precision this would be invalidated very often.\n \tif (!scale.is_equal_approx(new_scale)) {\n@@ -551,8 +553,6 @@ void JoltBody3D::set_transform(Transform3D p_transform) {\n \t\t_shapes_changed();\n \t}\n \n-\tp_transform.basis.orthonormalize();\n-\n \tif (!in_space()) {\n \t\tjolt_settings->mPosition = to_jolt_r(p_transform.origin);\n \t\tjolt_settings->mRotation = to_jolt(p_transform.basis);\ndiff --git a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\nindex bfe77e008d59..f32ddad0d469 100644\n--- a/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_shaped_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_shaped_object_3d.h\"\n \n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../shapes/jolt_custom_double_sided_shape.h\"\n #include \"../shapes/jolt_shape_3d.h\"\n@@ -347,7 +348,10 @@ void JoltShapedObject3D::commit_shapes(bool p_optimize_compound) {\n void JoltShapedObject3D::add_shape(JoltShape3D *p_shape, Transform3D p_transform, bool p_disabled) {\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, vformat(\"An invalid transform was passed when adding shape at index %d to physics body '%s'.\", shapes.size(), to_string()));\n \n-\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform.orthonormalized(), p_transform.basis.get_scale(), p_disabled));\n+\tVector3 shape_scale;\n+\tJoltMath::decompose(p_transform, shape_scale);\n+\n+\tshapes.push_back(JoltShapeInstance3D(this, p_shape, p_transform, shape_scale, p_disabled));\n \n \t_shapes_changed();\n }\n@@ -430,8 +434,8 @@ void JoltShapedObject3D::set_shape_transform(int p_index, Transform3D p_transfor\n \tERR_FAIL_INDEX(p_index, (int)shapes.size());\n \tJOLT_ENSURE_SCALE_NOT_ZERO(p_transform, \"Failed to correctly set transform for shape at index %d in body '%s'.\");\n \n-\tVector3 new_scale = p_transform.basis.get_scale();\n-\tp_transform.basis.orthonormalize();\n+\tVector3 new_scale;\n+\tJoltMath::decompose(p_transform, new_scale);\n \n \tJoltShapeInstance3D &shape = shapes[p_index];\n \ndiff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex 3852e42d51f2..d7a4afec57ba 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -32,6 +32,7 @@\n \n #include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n+#include \"../misc/jolt_math_funcs.h\"\n #include \"../misc/jolt_type_conversions.h\"\n #include \"../objects/jolt_area_3d.h\"\n #include \"../objects/jolt_body_3d.h\"\n@@ -288,11 +289,10 @@ bool JoltPhysicsDirectSpaceState3D::_body_motion_cast(const JoltBody3D &p_body,\n \t\tconst Transform3D transform_com_local = transform_local.translated_local(com_scaled);\n \t\tTransform3D transform_com = body_transform * transform_com_local;\n \n-\t\tVector3 scale = transform_com.basis.get_scale();\n+\t\tVector3 scale;\n+\t\tJoltMath::decompose(transform_com, scale);\n \t\tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"body_test_motion was passed an invalid transform along with body '%s'. This results in invalid scaling for shape at index %d.\");\n \n-\t\ttransform_com.basis.orthonormalize();\n-\n \t\treal_t shape_safe_fraction = 1.0;\n \t\treal_t shape_unsafe_fraction = 1.0;\n \n@@ -590,11 +590,10 @@ int JoltPhysicsDirectSpaceState3D::intersect_shape(const ShapeParameters &p_para\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"intersect_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"intersect_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -647,11 +646,10 @@ bool JoltPhysicsDirectSpaceState3D::cast_motion(const ShapeParameters &p_paramet\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"cast_motion (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tTransform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -684,11 +682,10 @@ bool JoltPhysicsDirectSpaceState3D::collide_shape(const ShapeParameters &p_param\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"collide_shape was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"collide_shape was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -754,11 +751,10 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tTransform3D transform = p_parameters.transform;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\tVector3 scale = transform.basis.get_scale();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \tJOLT_ENSURE_SCALE_VALID(jolt_shape, scale, \"get_rest_info (maybe from ShapeCast3D?) was passed an invalid transform.\");\n \n-\ttransform.basis.orthonormalize();\n-\n \tconst Vector3 com_scaled = to_godot(jolt_shape->GetCenterOfMass());\n \tconst Transform3D transform_com = transform.translated_local(com_scaled);\n \n@@ -890,8 +886,8 @@ bool JoltPhysicsDirectSpaceState3D::body_test_motion(const JoltBody3D &p_body, c\n \tTransform3D transform = p_parameters.from;\n \tJOLT_ENSURE_SCALE_NOT_ZERO(transform, vformat(\"body_test_motion (maybe from move_and_slide?) was passed an invalid transform along with body '%s'.\", p_body.to_string()));\n \n-\tVector3 scale = transform.basis.get_scale();\n-\ttransform.basis.orthonormalize();\n+\tVector3 scale;\n+\tJoltMath::decompose(transform, scale);\n \n \tspace->try_optimize();\n \n", "instance_id": "godotengine__godot-103440", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with Jolt Physics in Godot when a StaticBody3D is added as a child of a VehicleWheel3D, resulting in quaternion errors. It provides specific steps to reproduce the issue, system information, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"it should work as before,\" nor does it clarify the specific constraints or edge cases (e.g., whether this issue occurs only with specific configurations or node hierarchies). Additionally, while the error message is provided, there is no deeper explanation of why the quaternion error occurs or what specific part of the Jolt Physics integration might be at fault. These minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files within the Jolt Physics module of the Godot engine, including the addition of new utility functions for matrix decomposition (`JoltMath::decompose`) and modifications to several existing classes (`JoltArea3D`, `JoltBody3D`, `JoltShapedObject3D`, `JoltPhysicsDirectSpaceState3D`). This indicates a moderate-to-high impact on the codebase, requiring an understanding of how transforms and scaling are handled across different physics objects. Second, the technical concepts involved include 3D mathematics (specifically, basis decomposition and handling of orthonormalization for transforms), integration with a third-party physics engine (Jolt Physics), and familiarity with Godot's internal architecture for physics and scene graph management. These concepts are moderately complex and require a solid grasp of linear algebra and physics engine internals. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest a need to handle invalid transforms and scaling issues (e.g., ensuring non-zero scale), which introduces some error-handling complexity. Finally, the solution impacts a critical part of the physics system, where incorrect handling of transforms could lead to broader issues in simulation accuracy or stability. Given these factors, a difficulty score of 0.65 is appropriate, reflecting a challenging problem that requires deep understanding and careful implementation but does not reach the extreme complexity of system-level or highly domain-specific issues.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Deserializing custom resource created through inspector results in parser error\n### Tested versions\n\n- Reproducible in: 4.4.beta3\n- Not reproducible in: 4.3.stable\n\n### System information\n\nGodot v4.4.beta3 - Windows 11 (build 26100) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 9 7940HS w/ Radeon 780M Graphics (16 threads)\n\n### Issue description\n\nWhen doing `bytes_to_var_with_objects(var_to_bytes_with_objects(some_custom_resource))` where `some_custom_resource` was specifically created through the editor inspector, and not through something like `MyResource.new()`, you end up with a debugger break saying:\n\n```\nParser Error: Class \"MyResource\" hides a global script class.\n```\n\nThe exact same setup seemingly worked in 4.3-stable.\n\n### Steps to reproduce\n\n1. Open the MRP.\n2. Run the main scene.\n3. Note error.\n\n### Minimal reproduction project (MRP)\n\n[resource-serialization-error.zip](https://github.com/user-attachments/files/18710656/resource-serialization-error.zip)\n", "patch": "diff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 8135a9b96644..aec082791ef5 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -39,6 +39,7 @@\n #include \"editor/multi_node_edit.h\"\n #include \"editor/plugins/editor_context_menu_plugin.h\"\n #include \"editor/plugins/editor_plugin.h\"\n+#include \"scene/property_utils.h\"\n #include \"scene/resources/packed_scene.h\"\n \n void EditorSelectionHistory::cleanup_history() {\n@@ -536,15 +537,18 @@ Variant EditorData::instantiate_custom_type(const String &p_type, const String &\n \t\t\tif (get_custom_types()[p_inherits][i].name == p_type) {\n \t\t\t\tRef<Script> script = get_custom_types()[p_inherits][i].script;\n \n-\t\t\t\tVariant ob = ClassDB::instantiate(p_inherits);\n-\t\t\t\tERR_FAIL_COND_V(!ob, Variant());\n+\t\t\t\t// Store in a variant to initialize the refcount if needed.\n+\t\t\t\tVariant v = ClassDB::instantiate(p_inherits);\n+\t\t\t\tERR_FAIL_COND_V(!v, Variant());\n+\t\t\t\tObject *ob = v;\n+\n \t\t\t\tNode *n = Object::cast_to<Node>(ob);\n \t\t\t\tif (n) {\n \t\t\t\t\tn->set_name(p_type);\n \t\t\t\t}\n-\t\t\t\tn->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\t((Object *)ob)->set_script(script);\n-\t\t\t\treturn ob;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(ob, script);\n+\t\t\t\tob->set_script(script);\n+\t\t\t\treturn v;\n \t\t\t}\n \t\t}\n \t}\n@@ -988,12 +992,13 @@ Variant EditorData::script_class_instance(const String &p_class) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n \t\tif (script.is_valid()) {\n \t\t\t// Store in a variant to initialize the refcount if needed.\n-\t\t\tVariant obj = ClassDB::instantiate(script->get_instance_base_type());\n-\t\t\tif (obj) {\n-\t\t\t\tObject::cast_to<Object>(obj)->set_meta(SceneStringName(_custom_type_script), script);\n-\t\t\t\tobj.operator Object *()->set_script(script);\n+\t\t\tVariant v = ClassDB::instantiate(script->get_instance_base_type());\n+\t\t\tif (v) {\n+\t\t\t\tObject *obj = v;\n+\t\t\t\tPropertyUtils::assign_custom_type_script(obj, script);\n+\t\t\t\tobj->set_script(script);\n \t\t\t}\n-\t\t\treturn obj;\n+\t\t\treturn v;\n \t\t}\n \t}\n \treturn Variant();\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 38839a8bbc61..a733e1ce4e1d 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4751,7 +4751,7 @@ Ref<Script> EditorNode::get_object_custom_type_base(const Object *p_object) cons\n \n \tconst Node *node = Object::cast_to<const Node>(p_object);\n \tif (node && node->has_meta(SceneStringName(_custom_type_script))) {\n-\t\treturn node->get_meta(SceneStringName(_custom_type_script));\n+\t\treturn PropertyUtils::get_custom_type_script(node);\n \t}\n \n \tRef<Script> scr = p_object->get_script();\ndiff --git a/editor/scene_tree_dock.cpp b/editor/scene_tree_dock.cpp\nindex b46cda63c70b..2bc022f1d1cb 100644\n--- a/editor/scene_tree_dock.cpp\n+++ b/editor/scene_tree_dock.cpp\n@@ -2834,7 +2834,7 @@ void SceneTreeDock::_update_script_button() {\n \t\t\tRef<Script> cts;\n \n \t\t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\t\tcts = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\t\tcts = PropertyUtils::get_custom_type_script(n);\n \t\t\t}\n \n \t\t\tif (selection.size() == 1) {\n@@ -3114,7 +3114,7 @@ void SceneTreeDock::_replace_node(Node *p_node, Node *p_by_node, bool p_keep_pro\n \n \t\t// If we're dealing with a custom node type, we need to create a default instance of the custom type instead of the native type for property comparison.\n \t\tif (oldnode->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> cts = oldnode->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> cts = PropertyUtils::get_custom_type_script(oldnode);\n \t\t\tdefault_oldnode = Object::cast_to<Node>(get_editor_data()->script_class_instance(cts->get_global_name()));\n \t\t\tif (default_oldnode) {\n \t\t\t\tdefault_oldnode->set_name(cts->get_global_name());\n@@ -3618,7 +3618,7 @@ void SceneTreeDock::_script_dropped(const String &p_file, NodePath p_to) {\n \t} else {\n \t\t// Check if dropped script is compatible.\n \t\tif (n->has_meta(SceneStringName(_custom_type_script))) {\n-\t\t\tRef<Script> ct_scr = n->get_meta(SceneStringName(_custom_type_script));\n+\t\t\tRef<Script> ct_scr = PropertyUtils::get_custom_type_script(n);\n \t\t\tif (!scr->inherits_script(ct_scr)) {\n \t\t\t\tString custom_type_name = ct_scr->get_global_name();\n \ndiff --git a/scene/property_utils.cpp b/scene/property_utils.cpp\nindex 9cae7d2a3a8a..dc9a56a294a9 100644\n--- a/scene/property_utils.cpp\n+++ b/scene/property_utils.cpp\n@@ -92,7 +92,7 @@ Variant PropertyUtils::get_property_default_value(const Object *p_object, const\n \t// Handle special case \"script\" property, where the default value is either null or the custom type script.\n \t// Do this only if there's no states stack cache to trace for default values.\n \tif (!p_states_stack_cache && p_property == CoreStringName(script) && p_object->has_meta(SceneStringName(_custom_type_script))) {\n-\t\tRef<Script> ct_scr = p_object->get_meta(SceneStringName(_custom_type_script));\n+\t\tRef<Script> ct_scr = get_custom_type_script(p_object);\n \t\tif (r_is_valid) {\n \t\t\t*r_is_valid = true;\n \t\t}\n@@ -282,3 +282,29 @@ Vector<SceneState::PackState> PropertyUtils::get_node_states_stack(const Node *p\n \t}\n \treturn states_stack_ret;\n }\n+\n+void PropertyUtils::assign_custom_type_script(Object *p_object, const Ref<Script> &p_script) {\n+\tERR_FAIL_NULL(p_object);\n+\tERR_FAIL_COND(p_script.is_null());\n+\n+\tconst String &path = p_script->get_path();\n+\tERR_FAIL_COND(!path.is_resource_file());\n+\n+\tResourceUID::ID script_uid = ResourceLoader::get_resource_uid(path);\n+\tif (script_uid != ResourceUID::INVALID_ID) {\n+\t\tp_object->set_meta(SceneStringName(_custom_type_script), ResourceUID::get_singleton()->id_to_text(script_uid));\n+\t}\n+}\n+\n+Ref<Script> PropertyUtils::get_custom_type_script(const Object *p_object) {\n+\tVariant custom_script = p_object->get_meta(SceneStringName(_custom_type_script));\n+#ifndef DISABLE_DEPRECATED\n+\tif (custom_script.get_type() == Variant::OBJECT) {\n+\t\t// Convert old script meta.\n+\t\tRef<Script> script_object(custom_script);\n+\t\tassign_custom_type_script(const_cast<Object *>(p_object), script_object);\n+\t\treturn script_object;\n+\t}\n+#endif\n+\treturn ResourceLoader::load(custom_script);\n+}\ndiff --git a/scene/property_utils.h b/scene/property_utils.h\nindex 0bf040ad267a..0fa532440413 100644\n--- a/scene/property_utils.h\n+++ b/scene/property_utils.h\n@@ -46,6 +46,9 @@ class PropertyUtils {\n \t// in the tree, since every owner found while traversing towards the root gets a chance\n \t// to override property values.)\n \tstatic Vector<SceneState::PackState> get_node_states_stack(const Node *p_node, const Node *p_owner = nullptr, bool *r_instantiated_by_owner = nullptr);\n+\n+\tstatic void assign_custom_type_script(Object *p_object, const Ref<Script> &p_script);\n+\tstatic Ref<Script> get_custom_type_script(const Object *p_object);\n };\n \n #endif // PROPERTY_UTILS_H\n", "instance_id": "godotengine__godot-102737", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: deserializing a custom resource created through the editor inspector in Godot v4.4.beta3 results in a parser error (\"Class 'MyResource' hides a global script class\"). It provides specific version information, system details, steps to reproduce, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior or the root cause of the regression between versions 4.3.stable and 4.4.beta3. Additionally, while the steps to reproduce are provided, they are quite brief (\"Run the main scene. Note error.\"), lacking detailed context about the setup or expected output. Edge cases or specific constraints related to the custom resource creation are also not mentioned. Overall, the statement is valid and mostly clear but could benefit from additional details about the intended functionality and potential edge cases.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. \n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files (`editor_data.cpp`, `editor_node.cpp`, `scene_tree_dock.cpp`, `property_utils.cpp`, and `property_utils.h`) within the Godot engine, a large and complex codebase. The modifications involve replacing direct metadata access with utility functions (`PropertyUtils::get_custom_type_script` and `PropertyUtils::assign_custom_type_script`) to handle custom type scripts, indicating a need to understand interactions between editor components and resource serialization logic. While the actual lines of code changed are relatively small, the impact is significant as it touches core editor functionality and resource handling.\n\n2. **Number of Technical Concepts**: Solving this issue requires a deep understanding of several concepts, including Godot's resource serialization mechanism, custom type handling in the editor, metadata management, and script instantiation. Familiarity with Godot's internal architecture (e.g., how `ClassDB::instantiate` and `Object::set_script` interact with custom scripts) is crucial. Additionally, the changes involve handling resource UIDs and backward compatibility (as seen in the `#ifndef DISABLE_DEPRECATED` block), which adds complexity. Knowledge of C++ (Godot's primary language) and its memory management (e.g., handling `Ref<Script>` and `Variant`) is also necessary.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest several considerations, such as handling invalid or missing script paths, ensuring proper resource UID conversion, and maintaining compatibility with older metadata formats (as seen in the deprecated code path). The introduction of utility functions in `PropertyUtils` indicates a need for robust error handling (e.g., `ERR_FAIL_COND` checks) to prevent crashes or unexpected behavior during resource loading or script assignment.\n\n4. **Overall Complexity**: The issue requires a deep dive into Godot's editor and resource systems, which are non-trivial to understand without prior experience in the engine's internals. The regression between versions suggests a subtle change in behavior that might not be immediately obvious, increasing the difficulty of debugging and fixing. While the solution provided in the diff is relatively focused, implementing or verifying it without prior context would be challenging for someone unfamiliar with the codebase.\n\nGiven these factors, a difficulty score of 0.65 reflects the need for a solid understanding of the Godot engine's architecture, careful handling of cross-module interactions, and attention to potential edge cases in resource serialization. It is not at the highest end of difficulty (0.8-1.0) because the provided diff offers a clear path to resolution, and the problem does not appear to involve system-level or highly domain-specific challenges beyond the engine's scope.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Exported array in inspector has slider for array size\n### Tested versions\n\n- Reproducible in v4.4.beta.custom_build [eee39f004]\n\n### System information\n\nGodot v4.4.beta (eee39f004) - macOS Sequoia (15.3.0) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - AMD Radeon Pro 5500 XT OpenGL Engine - Intel(R) Core(TM) i7-10700K CPU @ 3.80GHz (16 threads)\n\n### Issue description\n\nThe array size field in the editor inspector includes a slider, which is effectively useless because it has such a large range:\n\nhttps://github.com/user-attachments/assets/99cebd43-0dd0-4e40-9eba-456725123e22\n\n[In `editor/editor_properties_array_dict.cpp` at line 449, we can see that its maximum value is indeed `INT32_MAX`](https://github.com/godotengine/godot/blob/eee39f004b42a4948af90cdebedf65c34a4a4970/editor/editor_properties_array_dict.cpp#L449):\n```cpp\nsize_slider->set_max(INT32_MAX);\n```\n\nThis number is so large that even with the slider just *barely* moved off to the right, the array is being given over 5,000,000 elements. There is also noticeable lag in the editor as this is done.\n\n### Steps to reproduce\n\nCreate an exported array in a GDScript class:\n```gdscript\n@export var my_array: Array[int] = []\n```\n\nThen, attach it to a node in the editor. Select the node and expand the array, and observe the slider on the \"Size:\" field. Try to drag it, and notice that the array size becomes *very* large.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_properties_array_dict.cpp b/editor/editor_properties_array_dict.cpp\nindex 9663157ff990..93c5a70cf907 100644\n--- a/editor/editor_properties_array_dict.cpp\n+++ b/editor/editor_properties_array_dict.cpp\n@@ -447,6 +447,7 @@ void EditorPropertyArray::update_property() {\n \t\t\tsize_slider = memnew(EditorSpinSlider);\n \t\t\tsize_slider->set_step(1);\n \t\t\tsize_slider->set_max(INT32_MAX);\n+\t\t\tsize_slider->set_editing_integer(true);\n \t\t\tsize_slider->set_h_size_flags(SIZE_EXPAND_FILL);\n \t\t\tsize_slider->set_read_only(is_read_only());\n \t\t\tsize_slider->connect(SceneStringName(value_changed), callable_mp(this, &EditorPropertyArray::_length_changed));\n", "instance_id": "godotengine__godot-102392", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an exported array in the Godot editor inspector has a slider for array size with an impractically large range (up to INT32_MAX), causing usability issues and editor lag. The goal is implied—to improve the usability of the slider by addressing the range issue. The input (an exported array in GDScript) and the problematic output (a slider with an enormous range) are described, along with steps to reproduce the issue. However, there are minor ambiguities: the problem statement does not explicitly specify the desired solution or constraints (e.g., what should the new maximum size be? Should there be a configurable limit?). Additionally, edge cases or performance considerations for very large arrays are not mentioned. While a code reference is provided, the expected behavior after the fix is not fully detailed. Thus, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem is very low, falling into the 0.0-0.2 range. The issue is straightforward: the slider for array size in the Godot editor has an excessively large maximum value, and the provided code change suggests a minimal modification to improve usability by enabling integer editing on the slider (via `set_editing_integer(true)`). Let's break this down by the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code change is extremely localized, affecting a single line in a single file (`editor/editor_properties_array_dict.cpp`). It does not impact the broader architecture or require understanding complex interactions between modules. The change is trivial in terms of the amount of code modified.\n\n2. **Technical Concepts Required**: The solution requires basic knowledge of C++ and familiarity with the Godot engine's editor UI components (specifically `EditorSpinSlider`). The concept of setting properties on a UI widget is fundamental and does not involve advanced language features, algorithms, or design patterns. No domain-specific knowledge beyond basic editor UI customization is needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases, and the provided code change does not address error handling or edge cases (e.g., what happens if the user inputs a very large value manually?). However, given the simplicity of the change, it is unlikely to introduce significant edge case complexity. The lag issue mentioned in the problem statement is not directly addressed by the code change, which might indicate an incomplete solution, but this does not increase the difficulty of the provided modification.\n\n4. **Overall Complexity**: The problem and solution are very easy to understand and implement. The code change is a simple tweak to an existing UI component property. Even if the provided solution (enabling integer editing) is not the final or complete fix for the usability issue, the effort required to make this change or to propose a slightly better solution (e.g., setting a reasonable maximum value for the slider) remains minimal.\n\nGiven these factors, a difficulty score of 0.15 reflects the very easy nature of the task, requiring only a basic code modification with minimal impact and no significant technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't Preload GDScript UIDs on Export Builds\n### Tested versions\n\nTested in 4.4dev5 and 4.4dev7 -- I don't think .gd files had UIDs in prior versions.\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated NVIDIA RTX A2000 8GB Laptop GPU (NVIDIA; 32.0.15.6103) - 12th Gen Intel(R) Core(TM) i7-12800H (20 threads)\n\n### Issue description\n\nPreloading a GDScript by UID works in editor builds, but does not work in exported builds.\n\nI'd expect preloading by UID to work both in-editor and post-export, or as a worst case fail in both contexts.\n\n### Steps to reproduce\n\nCreate some GDScript that does something. In a different script, preload it using its UID.\n\nThis will work in-editor but fail on export builds with `SCRIPT ERROR: Parse Error: Could not preload resource script \"uid://dn6jx08erf1cw\".`\n\n### Minimal reproduction project (MRP)\n\n[uid.zip](https://github.com/user-attachments/files/18276683/uid.zip)\nRun the MRP and you'll see some console output.\n\nExport it to EXE (with debug) and it will instead produce errors.\n", "patch": "diff --git a/modules/gdscript/gdscript_analyzer.cpp b/modules/gdscript/gdscript_analyzer.cpp\nindex 50b487059bf3..60109efc4d5b 100644\n--- a/modules/gdscript/gdscript_analyzer.cpp\n+++ b/modules/gdscript/gdscript_analyzer.cpp\n@@ -3952,8 +3952,9 @@ Ref<GDScriptParserRef> GDScriptAnalyzer::find_cached_external_parser_for_class(c\n \n Ref<GDScript> GDScriptAnalyzer::get_depended_shallow_script(const String &p_path, Error &r_error) {\n \t// To keep a local cache of the parser for resolving external nodes later.\n-\tparser->get_depended_parser_for(p_path);\n-\tRef<GDScript> scr = GDScriptCache::get_shallow_script(p_path, r_error, parser->script_path);\n+\tconst String path = ResourceUID::ensure_path(p_path);\n+\tparser->get_depended_parser_for(path);\n+\tRef<GDScript> scr = GDScriptCache::get_shallow_script(path, r_error, parser->script_path);\n \treturn scr;\n }\n \n", "instance_id": "godotengine__godot-101442", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: preloading GDScript by UID works in-editor but fails in exported builds, which is an inconsistency in behavior. The description includes the tested versions, system information, steps to reproduce, and a minimal reproduction project (MRP), which are helpful for understanding and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss the expected behavior in exported builds beyond \"it should work or fail consistently,\" nor does it mention potential edge cases or constraints related to UID handling in different build contexts. Additionally, there is no discussion of the underlying cause or hints about whether this is a parsing, caching, or resource resolution issue, which could help in assessing the scope of the fix. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of the code change is relatively small, as it involves a single modification in the `gdscript_analyzer.cpp` file, specifically in the `get_depended_shallow_script` function. The change itself is straightforward—converting a path to a UID-compatible format using `ResourceUID::ensure_path` before passing it to the parser and cache. This suggests a focused bug fix rather than a broad architectural change. However, the problem requires understanding specific technical concepts, such as how GDScript UIDs are handled, the difference in behavior between editor and exported builds, and the role of `ResourceUID` in path resolution. Additionally, it involves familiarity with the Godot engine's internals, particularly the GDScript parser and caching mechanisms, which adds a layer of complexity beyond basic language features. While the code change does not appear to impact multiple modules or the broader system architecture, it does require careful consideration of potential edge cases, such as invalid or malformed UIDs, differences in path formats across platforms, or unexpected behavior in other build configurations, though these are not explicitly mentioned in the problem statement. Overall, this problem is of medium difficulty (0.45) as it requires moderate technical understanding and targeted modifications, but it does not involve extensive refactoring or deep architectural changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\nRichTextLabel `get_visible_line_count()` does not work with `visible_characters` anymore\n### Godot version\n\n4.0.2\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\n`get_visible_line_count()` used to take `visible_characters` into account, but now the value seems ignored. Visible line count returns the value as if all characters were visible (although it returns 0 for 0).\n\n### Steps to reproduce\n\n1. Add RichTextLabel\r\n2. Put multiline text\r\n3. Set `visible_characters` to 1\r\n4. Attach this script\r\n```GDScript\r\nextends RichTextLabel\r\n\r\nfunc _process(delta: float) -> void:\r\n\tprint(get_visible_line_count())\r\n```\r\n5. Notice it doesn't print 1\n\n### Minimal reproduction project\n\nN/A\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex ad850b574c38..8f0add25eacd 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -820,6 +820,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t}\n \n \tint line_count = 0;\n+\tbool has_visible_chars = false;\n \t// Bottom margin for text clipping.\n \tfloat v_limit = theme_cache.normal_style->get_margin(SIDE_BOTTOM);\n \tSize2 ctrl_size = get_size();\n@@ -843,8 +844,6 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\tfloat length = l.text_buf->get_line_size(line).x;\n \n \t\t// Draw line.\n-\t\tline_count++;\n-\n \t\tif (rtl) {\n \t\t\toff.x = p_width - l.offset.x - width;\n \t\t\tif (!lrtl && p_frame == main) { // Skip Scrollbar.\n@@ -1290,6 +1289,7 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t\t\tbool skip = (trim_chars && l.char_offset + glyphs[i].end > visible_characters) || (trim_glyphs_ltr && (processed_glyphs_step >= visible_glyphs)) || (trim_glyphs_rtl && (processed_glyphs_step < total_glyphs - visible_glyphs));\n \t\t\t\t\t\tif (!skip) {\n \t\t\t\t\t\t\tif (txt_visible) {\n+\t\t\t\t\t\t\t\thas_visible_chars = true;\n \t\t\t\t\t\t\t\tif (step == DRAW_STEP_TEXT) {\n \t\t\t\t\t\t\t\t\tif (frid != RID()) {\n \t\t\t\t\t\t\t\t\t\tTS->font_draw_glyph(frid, ci, glyphs[i].font_size, fx_offset + char_off, gl, font_color);\n@@ -1410,6 +1410,10 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \n \t\tr_processed_glyphs = processed_glyphs_step;\n \t\toff.y += TS->shaped_text_get_descent(rid);\n+\t\tif (has_visible_chars) {\n+\t\t\tline_count++;\n+\t\t\thas_visible_chars = false;\n+\t\t}\n \t}\n \n \treturn line_count;\n", "instance_id": "godotengine__godot-101205", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `get_visible_line_count()` method in the `RichTextLabel` class of Godot 4.0.2 no longer considers the `visible_characters` property when calculating the number of visible lines, which is a regression from previous behavior. The steps to reproduce are provided, along with a simple script to demonstrate the issue. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (it should return a line count based on visible characters) but not explicitly stated. Additionally, edge cases such as empty text, special characters, or interactions with other properties (e.g., text wrapping, font sizes) are not mentioned. While a minimal reproduction project is marked as \"N/A,\" it would have been helpful to have a concrete example or further clarification on the desired output for various inputs. Overall, the problem is understandable, but it lacks comprehensive details on edge cases and explicit expected behavior.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively focused, primarily affecting a single method (`_draw_line`) in one file (`rich_text_label.cpp`) within the Godot engine's codebase. The modification involves tracking visible characters during rendering and incrementing the line count only when visible characters are present, which requires understanding the rendering logic and glyph processing in the `RichTextLabel` class. This introduces a moderate level of complexity as it necessitates familiarity with Godot's text rendering system, including concepts like glyph processing, text shaping, and visibility constraints. The code change itself is not extensive (a few lines added/modified), but it requires careful integration into the existing rendering loop to avoid unintended side effects. Additionally, while the problem statement does not explicitly mention edge cases, the nature of text rendering implies potential challenges such as handling empty lines, partial visibility, right-to-left text, and interactions with other properties like `visible_glyphs`. These require a moderate level of attention to detail and testing. The technical concepts involved include C++ (Godot's primary language), text rendering logic, and possibly familiarity with Godot's internal APIs for text shaping (`TS` in the code). However, the problem does not appear to impact the broader system architecture or require advanced domain-specific knowledge beyond the rendering subsystem. Therefore, I assign a difficulty score of 0.45, reflecting a medium-level challenge that requires understanding specific codebase logic and handling potential edge cases, but not a deep architectural overhaul or highly complex concepts.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Icon and splash screen raw files are not included in exported project\n### Tested versions\n\n- Reproducible in 4.4.dev5\n- Not reproducible in 4.4.dev4\nRegression from #97912\n\n### System information\n\nGodot v4.4.dev7 - Arch Linux #1 SMP PREEMPT_DYNAMIC Thu, 19 Dec 2024 21:29:01 +0000 on Wayland - X11 display driver, Single-window, 1 monitor - OpenGL 3 (Compatibility) - Mesa Intel(R) Graphics (ADL GT2) - 12th Gen Intel(R) Core(TM) i5-1235U (12 threads)\n\n### Issue description\n\nIcon and splash screen files are not included in export project due to saved as UIDs in ProjectSettings. Instead, file at path uid:/<someUIDhere> is exported, but it is ignored by engine, so icon and splash screen doesn't work.\n\n### Steps to reproduce\n\n1. Set custom icon and splash screen. They will be saved in ProjectSettings as UIDs.\n2. Export project.\n3. Run project. Notice default splash screen and icon.\n\n### Minimal reproduction project (MRP)\n\n[mrp.zip](https://github.com/user-attachments/files/18272161/mrp.zip)\n1. Run in editor. Everything works.\n2. Export and run. Icon and splash don't work.\n\n", "patch": "diff --git a/editor/export/editor_export_platform.cpp b/editor/export/editor_export_platform.cpp\nindex cb496fc9f09e..1cf47f348659 100644\n--- a/editor/export/editor_export_platform.cpp\n+++ b/editor/export/editor_export_platform.cpp\n@@ -35,6 +35,7 @@\n #include \"core/extension/gdextension.h\"\n #include \"core/io/file_access_encrypted.h\"\n #include \"core/io/file_access_pack.h\" // PACK_HEADER_MAGIC, PACK_FORMAT_VERSION\n+#include \"core/io/resource_uid.h\"\n #include \"core/io/zip_io.h\"\n #include \"core/version.h\"\n #include \"editor/editor_file_system.h\"\n@@ -925,8 +926,8 @@ Vector<String> EditorExportPlatform::get_forced_export_files() {\n \n \tfiles.push_back(ProjectSettings::get_singleton()->get_global_class_list_path());\n \n-\tString icon = GLOBAL_GET(\"application/config/icon\");\n-\tString splash = GLOBAL_GET(\"application/boot_splash/image\");\n+\tString icon = ResourceUID::ensure_path(GLOBAL_GET(\"application/config/icon\"));\n+\tString splash = ResourceUID::ensure_path(GLOBAL_GET(\"application/boot_splash/image\"));\n \tif (!icon.is_empty() && FileAccess::exists(icon)) {\n \t\tfiles.push_back(icon);\n \t}\n", "instance_id": "godotengine__godot-100920", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear and provides a good overview of the issue. It describes the problem (icon and splash screen files not being included in the exported project due to being saved as UIDs), specifies the affected versions, provides system information, and includes steps to reproduce the issue along with a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior (e.g., should the engine resolve UIDs to file paths during export?) or potential edge cases (e.g., what happens if the UID does not map to a valid file?). Additionally, there is no discussion of constraints or specific requirements for the fix. While the issue is understandable, these missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (`editor_export_platform.cpp`) and involves a small modification (changing two lines to use `ResourceUID::ensure_path` to resolve UIDs to file paths). The change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is minimal, making this a straightforward fix.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of the Godot engine's resource management system, specifically how UIDs are used to reference resources and how they can be resolved to file paths. The code change uses `ResourceUID::ensure_path`, which suggests familiarity with Godot's resource handling API. However, this is not a particularly complex concept for someone familiar with the engine or resource management in general. No advanced algorithms, design patterns, or domain-specific knowledge beyond the Godot framework are required.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, such as invalid UIDs or missing files. The code change includes a check (`FileAccess::exists(icon)`) to ensure the file exists before adding it to the export list, which handles one basic edge case. However, there is no indication of additional error handling or complex edge case considerations required beyond this. The simplicity of the error handling aligns with an easy difficulty level.\n\n4. **Overall Complexity:** The issue is a regression (introduced in a specific version), and the fix is a targeted adjustment to how resource paths are retrieved. It does not require deep architectural changes or extensive debugging of complex interactions within the codebase. The problem can be resolved with a clear understanding of the specific feature (exporting resources) and a small, focused code change.\n\nGiven these factors, I assign a difficulty score of 0.30, reflecting an easy problem that requires understanding some code logic and making a simple modification. It is slightly above the \"very easy\" range due to the need for familiarity with Godot's resource UID system, but it remains a relatively straightforward bug fix for a developer with moderate experience in the domain.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Adding custom camera feeds to `CameraServer` leads to crash on Linux\n### Tested versions\n\nv4.4.dev.custom_build [4364ed6cc]\n\n### System information\n\nGodot v4.4.dev (4364ed6cc) - Freedesktop SDK 24.08 (Flatpak runtime) on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - dedicated AMD Radeon RX 6650 XT (RADV NAVI23) - 12th Gen Intel(R) Core(TM) i5-12500 (12 threads)\n\n### Issue description\n\nWhen a custom `CameraFeed` is added to `CameraServer` through either GDScript or GDExtension, the scene will crash with error about caller thread, then crash with signal 11:\n\n```\nERROR: Caller thread can't call this function in this node (/root). Use call_deferred() or call_thread_group() instead.\n   at: propagate_notification (scene/main/node.cpp:2523)\n```\n\n### Steps to reproduce\n\n```gdscript\nvar feed := CameraFeed.new()\n\nfunc _ready() -> void:\n\tCameraServer.add_feed(feed)\n```\n\n### Minimal reproduction project (MRP)\n\nNone\n", "patch": "diff --git a/modules/camera/camera_linux.cpp b/modules/camera/camera_linux.cpp\nindex 60217709af8c..b774d1be3554 100644\n--- a/modules/camera/camera_linux.cpp\n+++ b/modules/camera/camera_linux.cpp\n@@ -52,6 +52,9 @@ void CameraLinux::_update_devices() {\n \n \t\t\tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\t\t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\t\t\tif (feed.is_null()) {\n+\t\t\t\t\tcontinue;\n+\t\t\t\t}\n \t\t\t\tString device_name = feed->get_device_name();\n \t\t\t\tif (!_is_active(device_name)) {\n \t\t\t\t\tremove_feed(feed);\n@@ -84,6 +87,9 @@ void CameraLinux::_update_devices() {\n bool CameraLinux::_has_device(const String &p_device_name) {\n \tfor (int i = 0; i < feeds.size(); i++) {\n \t\tRef<CameraFeedLinux> feed = (Ref<CameraFeedLinux>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \t\tif (feed->get_device_name() == p_device_name) {\n \t\t\treturn true;\n \t\t}\ndiff --git a/modules/camera/camera_macos.mm b/modules/camera/camera_macos.mm\nindex bd718a0cb6c8..d242444b0b5a 100644\n--- a/modules/camera/camera_macos.mm\n+++ b/modules/camera/camera_macos.mm\n@@ -323,6 +323,9 @@ - (void)dealloc {\n \t// remove devices that are gone..\n \tfor (int i = feeds.size() - 1; i >= 0; i--) {\n \t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\tif (feed.is_null()) {\n+\t\t\tcontinue;\n+\t\t}\n \n \t\tif (![devices containsObject:feed->get_device()]) {\n \t\t\t// remove it from our array, this will also destroy it ;)\n@@ -334,6 +337,9 @@ - (void)dealloc {\n \t\tbool found = false;\n \t\tfor (int i = 0; i < feeds.size() && !found; i++) {\n \t\t\tRef<CameraFeedMacOS> feed = (Ref<CameraFeedMacOS>)feeds[i];\n+\t\t\tif (feed.is_null()) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n \t\t\tif (feed->get_device() == device) {\n \t\t\t\tfound = true;\n \t\t\t};\n", "instance_id": "godotengine__godot-100540", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: adding a custom `CameraFeed` to `CameraServer` causes a crash on Linux with a specific error message related to thread safety. It provides the tested version, system information, and steps to reproduce the issue using a minimal GDScript snippet. However, there are minor ambiguities and missing details. For instance, it does not specify whether the crash occurs under specific conditions (e.g., certain camera feed configurations or hardware setups) or if it affects other platforms beyond Linux. Additionally, there is no mention of expected behavior after the fix or potential edge cases to consider. The lack of a minimal reproduction project (MRP) also slightly hinders clarity, as it would help in fully understanding the context of the issue. Overall, the statement is valid and clear but lacks some minor details that could make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are relatively small and localized to specific files (`camera_linux.cpp` and `camera_macos.mm`) within the camera module of what appears to be the Godot engine codebase. The modifications involve adding null checks (`feed.is_null()`) before accessing camera feed objects in loops, which suggests a straightforward fix for a potential null pointer dereference issue. The changes do not impact the broader system architecture or require extensive refactoring, and they are limited to a few lines of code across two files.\n\n2. **Clarity and Complexity of Problem Logic:** The problem's logic is not inherently complex. The crash is likely caused by attempting to access invalid or null camera feed objects, and the solution involves basic defensive programming (null checks). Understanding the issue requires some knowledge of thread safety (as hinted by the error message about caller threads), but the fix itself does not directly address threading issues.\n\n3. **Technical Concepts Involved:** The solution requires basic C++ knowledge, specifically understanding reference counting and null checks in the context of Godot's `Ref` smart pointer system. Familiarity with the Godot engine's camera module and its internal data structures (e.g., `CameraFeedLinux`, `CameraFeedMacOS`) is helpful but not overly complex for someone with moderate experience in C++ or game engine development. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic camera handling are needed.\n\n4. **Edge Cases and Error Handling:** The problem statement does not explicitly mention specific edge cases beyond the general crash scenario. The code changes introduce null checks, which are a form of error handling, but they do not address complex edge cases or require intricate logic. The fix appears to be a preventative measure against null dereferences, which is a common and straightforward error handling pattern.\n\nOverall, this problem is easy to solve for a developer with basic to intermediate C++ skills and some familiarity with the Godot engine. The changes are minimal, the concepts are not advanced, and the impact is localized. I assign a difficulty score of 0.35, slightly above the lower end of the \"Easy\" range, to account for the need to understand the specific context of Godot's camera system and the potential threading issue hinted at in the error message, which might require minor additional investigation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "In a RichTextLabel, you can't see highlighted text when a background color wraps lines\n### Tested versions\n\n- Reproducible in v4.4.dev5.official [9e6098432] \n- Reproducible in 4.3-stable \n\n\n### System information\n\nGodot v4.4.dev5 - Windows 10.0.26100 - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4090 (NVIDIA; 32.0.15.6614) - 13th Gen Intel(R) Core(TM) i9-13900K (32 threads)\n\n### Issue description\n\nIf you have a `RichTextLabel` which uses BBCode and has a `[bgcolor]` tag, you cannot always see your text selection.\n\nIn particular, if the `[bgcolor]` spans over a line break, you cannot see your selection at all.\n\nFor example with this control:\n\n![Image](https://github.com/user-attachments/assets/4c41249b-2e40-4c78-a79d-79cbe9bb19d9)\n\nIf I highlight from before the end of the line the red text is not highlighted. (The additional red on the second like does get highlighted, though.)\n\n![Image](https://github.com/user-attachments/assets/7555d8bf-1579-4a99-813d-11ad08a0d383)\n\nHere is an example where the `[bgcolor]` is mid sentence and it works fine:\n\n![Image](https://github.com/user-attachments/assets/45d56f26-dab6-44f8-9e0f-d740c88347b6)\n\n\n### Steps to reproduce\n\nI have included a MRP that demonstrates the issue. Simply start it and try to select text in the second line that goes beyond the wrap.\n\n\n\n### Minimal reproduction project (MRP)\n\n[highlight-bg-mrp.zip](https://github.com/user-attachments/files/18030106/highlight-bg-mrp.zip)\n\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex ea0b8cd80864..be54ef7c94ed 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -1370,6 +1370,13 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t}\n \t\t\t}\n \t\t\t// Finish lines and boxes.\n+\t\t\tif (step == DRAW_STEP_BACKGROUND || step == DRAW_STEP_FOREGROUND) {\n+\t\t\t\tif (last_color.a > 0.0) {\n+\t\t\t\t\tVector2 rect_off = p_ofs + Vector2(box_start - theme_cache.text_highlight_h_padding, off_step.y - l_ascent - theme_cache.text_highlight_v_padding);\n+\t\t\t\t\tVector2 rect_size = Vector2(off_step.x - box_start + 2 * theme_cache.text_highlight_h_padding, l_size.y + 2 * theme_cache.text_highlight_v_padding);\n+\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_rect(ci, Rect2(rect_off, rect_size), last_color);\n+\t\t\t\t}\n+\t\t\t}\n \t\t\tif (step == DRAW_STEP_BACKGROUND) {\n \t\t\t\tif (sel_start != -1) {\n \t\t\t\t\tColor selection_bg = theme_cache.selection_color;\n@@ -1380,13 +1387,6 @@ int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_o\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n-\t\t\tif (step == DRAW_STEP_BACKGROUND || step == DRAW_STEP_FOREGROUND) {\n-\t\t\t\tif (last_color.a > 0.0) {\n-\t\t\t\t\tVector2 rect_off = p_ofs + Vector2(box_start - theme_cache.text_highlight_h_padding, off_step.y - l_ascent - theme_cache.text_highlight_v_padding);\n-\t\t\t\t\tVector2 rect_size = Vector2(off_step.x - box_start + 2 * theme_cache.text_highlight_h_padding, l_size.y + 2 * theme_cache.text_highlight_v_padding);\n-\t\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_rect(ci, Rect2(rect_off, rect_size), last_color);\n-\t\t\t\t}\n-\t\t\t}\n \t\t\tif (step == DRAW_STEP_TEXT) {\n \t\t\t\tif (ul_started) {\n \t\t\t\t\tul_started = false;\n", "instance_id": "godotengine__godot-100208", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `RichTextLabel` in Godot, specifically regarding the visibility of text selection when a `[bgcolor]` tag spans over a line break. It provides context with version information, system details, and visual examples (screenshots) to illustrate the problem. Additionally, a minimal reproduction project (MRP) is included, which helps in understanding and replicating the issue. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., how the selection should appear when spanning line breaks with background color) or mention specific edge cases beyond the line break scenario. Constraints or limitations of the rendering system that might affect the solution are also not discussed. While the issue is valid and mostly clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`rich_text_label.cpp`) and involve a small modification (reordering a block of code related to drawing background/foreground rectangles). The change does not impact the broader architecture of the system or require modifications across multiple modules. The amount of code changed is minimal, focusing on adjusting the rendering logic for background colors and selections.\n\n2. **Technical Concepts Involved**: Solving this issue requires understanding of the Godot engine's rendering pipeline, specifically how `RichTextLabel` handles drawing steps (background, foreground, text, etc.) and text selection rendering. Familiarity with C++ and the Godot API (e.g., `RenderingServer`, `canvas_item_add_rect`) is necessary, but these are relatively straightforward concepts for someone with experience in game engine development or GUI rendering. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic rendering are required.\n\n3. **Edge Cases and Error Handling**: The problem statement highlights a specific edge case (background color spanning line breaks affecting text selection visibility), and the code change addresses this by ensuring the background color rectangle is drawn in both background and foreground steps. However, no additional error handling or complex edge case logic is introduced in the provided diff. The complexity of edge cases appears limited to rendering order, which is handled by the small code adjustment.\n\n4. **Overall Complexity**: The problem requires understanding some code logic within the `RichTextLabel` class and making a simple modification to the drawing order. It does not involve deep architectural changes, performance optimizations, or intricate interactions with other parts of the codebase. The fix is essentially a reordering of existing logic to ensure proper rendering, which aligns with an \"Easy\" difficulty level.\n\nA score of 0.35 reflects that while the problem is not trivial (it requires specific knowledge of rendering in Godot), it is still a relatively straightforward bug fix for a developer familiar with the codebase or GUI rendering concepts. It does not demand advanced technical expertise or extensive modifications.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "CANARY: ALT+NUMPAD ADD is Broken\n### Windows Terminal version\n\n1.22.2334.0\n\n### Windows build number\n\n10.0.19045.4780\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nAlt+NumpadAdd pressing combination is broken since Canary build terminal-1.22.2201.0\r\nterminal-1.22.2191.0 - latest good\r\nterminal-1.22.2201.0 - broken\r\n...\r\nterminal-1.22.2334.0 - broken\r\n\r\nrun utilities for getting codes DOWN/UP VK_CODES etc\r\npress Alt key after press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd, press NumpadAdd and release NumpadAdd\n\n### Expected Behavior\n\nterminal-1.22.2191.0 - latest good:\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:56 KEY_EVENT_RECORD: Dn, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:42:57 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n\n\n### Actual Behavior\n\nsince terminal-1.22.2201.0  to latest canary build terminal-1.22.2334.0  is broken:\r\n\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\r\n21:44:18 KEY_EVENT_RECORD: Up, 1, Vk=\"VK_ADD\" [107/0x006B], Scan=0x004E uChar=[U='+' (0x002B): A='+' (0x2B)]\r\n         Ctrl=0x00000002 (cAsac - ecns) (Windowed)\n", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..e259d9ea05d 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1539,11 +1539,24 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             auto encoding = s.encoding;\r\n             wchar_t buf[4]{};\r\n             size_t buf_len = 0;\r\n+            bool handled = true;\r\n \r\n             if (encoding == AltNumpadEncoding::Unicode)\r\n             {\r\n                 // UTF-32 -> UTF-16\r\n-                if (s.accumulator <= 0xffff)\r\n+                if (s.accumulator == 0)\r\n+                {\r\n+                    // If the user pressed Alt + VK_ADD, then released Alt, they probably didn't intend to insert a numpad character at all.\r\n+                    // Send any accumulated key events instead.\r\n+                    for (auto&& e : _altNumpadState.cachedKeyEvents)\r\n+                    {\r\n+                        handled = handled && _TrySendKeyEvent(e.vkey, e.scanCode, e.modifiers, e.keyDown);\r\n+                    }\r\n+                    // Send the alt keyup we are currently processing\r\n+                    handled = handled && _TrySendKeyEvent(vkey, scanCode, modifiers, keyDown);\r\n+                    // do not accumulate into the buffer\r\n+                }\r\n+                else if (s.accumulator <= 0xffff)\r\n                 {\r\n                     buf[buf_len++] = static_cast<uint16_t>(s.accumulator);\r\n                 }\r\n@@ -1587,7 +1600,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             }\r\n \r\n             s = {};\r\n-            return true;\r\n+            return handled;\r\n         }\r\n         // As a continuation of the above, this handles the key-down case.\r\n         if (modifiers.IsAltPressed())\r\n@@ -1601,46 +1614,49 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 SCROLLLOCK_ON |\r\n                 CAPSLOCK_ON;\r\n \r\n-            if (keyDown && (modifiers.Value() & ~permittedModifiers) == 0)\r\n+            if ((modifiers.Value() & ~permittedModifiers) == 0)\r\n             {\r\n                 auto& s = _altNumpadState;\r\n \r\n-                if (vkey == VK_ADD)\r\n-                {\r\n-                    // Alt '+' <number> is used to input Unicode code points.\r\n-                    // Every time you press + it resets the entire state\r\n-                    // in the original OS implementation as well.\r\n-                    s.encoding = AltNumpadEncoding::Unicode;\r\n-                    s.accumulator = 0;\r\n-                    s.active = true;\r\n-                }\r\n-                else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n-                {\r\n-                    // Alt '0' <number> is used to input ANSI code points.\r\n-                    // Otherwise, they're OEM codepoints.\r\n-                    s.encoding = AltNumpadEncoding::ANSI;\r\n-                    s.active = true;\r\n-                }\r\n-                else\r\n+                if (keyDown)\r\n                 {\r\n-                    // Otherwise, append the pressed key to the accumulator.\r\n-                    const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n-                    uint32_t add = 0xffffff;\r\n-\r\n-                    if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                    if (vkey == VK_ADD)\r\n                     {\r\n-                        add = vkey - VK_NUMPAD0;\r\n+                        // Alt '+' <number> is used to input Unicode code points.\r\n+                        // Every time you press + it resets the entire state\r\n+                        // in the original OS implementation as well.\r\n+                        s.encoding = AltNumpadEncoding::Unicode;\r\n+                        s.accumulator = 0;\r\n+                        s.active = true;\r\n                     }\r\n-                    else if (vkey >= 'A' && vkey <= 'F')\r\n+                    else if (vkey == VK_NUMPAD0 && s.encoding == AltNumpadEncoding::OEM && s.accumulator == 0)\r\n                     {\r\n-                        add = vkey - 'A' + 10;\r\n+                        // Alt '0' <number> is used to input ANSI code points.\r\n+                        // Otherwise, they're OEM codepoints.\r\n+                        s.encoding = AltNumpadEncoding::ANSI;\r\n+                        s.active = true;\r\n                     }\r\n-\r\n-                    // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n-                    if (add < base)\r\n+                    else\r\n                     {\r\n-                        s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n-                        s.active = true;\r\n+                        // Otherwise, append the pressed key to the accumulator.\r\n+                        const uint32_t base = s.encoding == AltNumpadEncoding::Unicode ? 16 : 10;\r\n+                        uint32_t add = 0xffffff;\r\n+\r\n+                        if (vkey >= VK_NUMPAD0 && vkey <= VK_NUMPAD9)\r\n+                        {\r\n+                            add = vkey - VK_NUMPAD0;\r\n+                        }\r\n+                        else if (vkey >= 'A' && vkey <= 'F')\r\n+                        {\r\n+                            add = vkey - 'A' + 10;\r\n+                        }\r\n+\r\n+                        // Pressing Alt + <not a number> should not activate the Alt+Numpad input, however.\r\n+                        if (add < base)\r\n+                        {\r\n+                            s.accumulator = std::min(s.accumulator * base + add, 0x10FFFFu);\r\n+                            s.active = true;\r\n+                        }\r\n                     }\r\n                 }\r\n \r\n@@ -1648,6 +1664,8 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 // return and send the Alt key combination as per usual.\r\n                 if (s.active)\r\n                 {\r\n+                    // Cache it in case we have to emit it after alt is released\r\n+                    _altNumpadState.cachedKeyEvents.emplace_back(vkey, scanCode, modifiers, keyDown);\r\n                     return true;\r\n                 }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/TermControl.h b/src/cascadia/TerminalControl/TermControl.h\nindex f60a72ea792..ab5b0a1ae78 100644\n--- a/src/cascadia/TerminalControl/TermControl.h\n+++ b/src/cascadia/TerminalControl/TermControl.h\n@@ -256,12 +256,20 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         };\r\n         struct AltNumpadState\r\n         {\r\n+            struct CachedKey\r\n+            {\r\n+                WORD vkey;\r\n+                WORD scanCode;\r\n+                ::Microsoft::Terminal::Core::ControlKeyStates modifiers;\r\n+                bool keyDown;\r\n+            };\r\n             AltNumpadEncoding encoding = AltNumpadEncoding::OEM;\r\n             uint32_t accumulator = 0;\r\n             // Checking for accumulator != 0 to see if we have an ongoing Alt+Numpad composition is insufficient.\r\n             // The state can be active, while the accumulator is 0, if the user pressed Alt+Numpad0 which enabled\r\n             // the OEM encoding mode (= active), and then pressed Numpad0 again (= accumulator is still 0).\r\n             bool active = false;\r\n+            til::small_vector<CachedKey, 4> cachedKeyEvents;\r\n         };\r\n         AltNumpadState _altNumpadState;\r\n \r\n", "instance_id": "microsoft__terminal-17774", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Alt+NumpadAdd key combination is broken in specific versions of the Windows Terminal (from 1.22.2201.0 to 1.22.2334.0). It provides detailed steps to reproduce the issue, expected behavior, and actual behavior with logs showing key event records. This helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"broken\" means in terms of user impact or expected functionality beyond the logs (e.g., does it fail to input a character, or is it a different issue?). Additionally, edge cases or specific conditions under which the issue occurs (e.g., different keyboard layouts or system settings) are not mentioned. While the logs are helpful, a clearer explanation of the desired outcome or impact would make the statement more comprehensive. Hence, I rate it as \"Mostly Clear\" with a score of 2.", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`TermControl.cpp`) with modifications to the logic handling Alt+Numpad key combinations, and a minor structural update in `TermControl.h` to support caching key events. The changes involve around 50-60 lines of code, which is moderate in size. Second, the technical concepts required include understanding Windows-specific key event handling (e.g., `KEY_EVENT_RECORD`, virtual key codes like `VK_ADD`), state management for key combinations, and character encoding (Unicode and OEM). These concepts are not overly complex for someone familiar with Windows API and input handling, but they do require specific domain knowledge. Third, the problem involves handling edge cases, such as detecting when the user releases Alt without intending to input a numpad character, which the code addresses by caching and replaying key events. This adds some complexity to the logic. Finally, the changes do not appear to impact the broader system architecture significantly, as they are confined to input processing logic. However, a deep understanding of the existing state machine for Alt+Numpad input in the Windows Terminal codebase is necessary to ensure correctness. Given these factors—a moderate scope of changes, specific but not overly advanced technical concepts, and some edge case handling—I assign a difficulty score of 0.55, placing it in the medium category with a slight lean towards the higher end due to the domain-specific knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "DCS sequences split across multiple \"packets\" can be corrupted by conpty\n### Windows Terminal version\n\n1.20.10822.0\n\n### Windows build number\n\n10.0.19045.4291\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nRun the following python script:\r\n\r\n```py\r\nimport sys\r\nimport time\r\n\r\nsys.stdout.write('\\033[37;40m\\033[2J')\r\nsys.stdout.write('\\033P2$p0;2;50;0;0/')\r\nsys.stdout.flush()\r\ntime.sleep(0.1)\r\nsys.stdout.write('0;2;0;0;0\\033\\\\')\r\n```\r\n\n\n### Expected Behavior\n\nIt should clear the screen and briefly make the background color red. It works as expected in OpenConsole.\n\n### Actual Behavior\n\nIn Windows Terminal, the background is left permanently red, and you can see the second half of the DCS sequence output on the screen: `0;2;0;0;0`.\r\n\r\nLooking at the debug tap, it appears that conpty is inserting an SGR reset sequence in the middle of the DCS stream (where the script sleeps for a bit). This seems similar to issue #16079, but that test case is now working correctly on the main branch, while this is still broken.\r\n\r\nI haven't had a chance to git bisect it, so I'm not sure if it's a regression, but I wouldn't be surprised if it was always broken in some way (although possibly not obviously so). There may also be an element of timing involved, but I can reproduce the problem consistently with the script above. \n", "patch": "diff --git a/src/renderer/vt/XtermEngine.cpp b/src/renderer/vt/XtermEngine.cpp\nindex 75fc3510fa6..b6d0c58a862 100644\n--- a/src/renderer/vt/XtermEngine.cpp\n+++ b/src/renderer/vt/XtermEngine.cpp\n@@ -37,7 +37,16 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n //      the pipe.\r\n [[nodiscard]] HRESULT XtermEngine::StartPaint() noexcept\r\n {\r\n-    RETURN_IF_FAILED(VtEngine::StartPaint());\r\n+    const auto hr = VtEngine::StartPaint();\r\n+    if (hr != S_OK)\r\n+    {\r\n+        // If _noFlushOnEnd was set, and we didn't return early, it would usually\r\n+        // have been reset in the EndPaint call. But since that's not going to\r\n+        // happen now, we need to reset it here, otherwise we may mistakenly skip\r\n+        // the flush on the next frame.\r\n+        _noFlushOnEnd = false;\r\n+        return hr;\r\n+    }\r\n \r\n     _trace.TraceLastText(_lastText);\r\n \r\n@@ -83,15 +92,6 @@ XtermEngine::XtermEngine(_In_ wil::unique_hfile hPipe,\n         }\r\n     }\r\n \r\n-    if (!_quickReturn)\r\n-    {\r\n-        if (_WillWriteSingleChar())\r\n-        {\r\n-            // Don't re-enable the cursor.\r\n-            _quickReturn = true;\r\n-        }\r\n-    }\r\n-\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/invalidate.cpp b/src/renderer/vt/invalidate.cpp\nindex 489a6b50bc1..942ba58df26 100644\n--- a/src/renderer/vt/invalidate.cpp\n+++ b/src/renderer/vt/invalidate.cpp\n@@ -75,7 +75,7 @@ CATCH_RETURN();\n     }\r\n     _skipCursor = false;\r\n \r\n-    _cursorMoved = true;\r\n+    _cursorMoved = psrRegion->origin() != _lastText;\r\n     return S_OK;\r\n }\r\n \r\ndiff --git a/src/renderer/vt/math.cpp b/src/renderer/vt/math.cpp\nindex d86e4644ca5..354ca0e9925 100644\n--- a/src/renderer/vt/math.cpp\n+++ b/src/renderer/vt/math.cpp\n@@ -52,38 +52,3 @@ void VtEngine::_OrRect(_Inout_ til::inclusive_rect* const pRectExisting, const t\n     pRectExisting->right = std::max(pRectExisting->right, pRectToOr->right);\r\n     pRectExisting->bottom = std::max(pRectExisting->bottom, pRectToOr->bottom);\r\n }\r\n-\r\n-// Method Description:\r\n-// - Returns true if the invalidated region indicates that we only need to\r\n-//      simply print text from the current cursor position. This will prevent us\r\n-//      from sending extra VT set-up/tear down sequences (?12h/l) when all we\r\n-//      need to do is print more text at the current cursor position.\r\n-// Arguments:\r\n-// - <none>\r\n-// Return Value:\r\n-// - true iff only the next character is invalid\r\n-bool VtEngine::_WillWriteSingleChar() const\r\n-{\r\n-    // If there is no scroll delta, return false.\r\n-    if (til::point{ 0, 0 } != _scrollDelta)\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // If there is more than one invalid char, return false.\r\n-    if (!_invalidMap.one())\r\n-    {\r\n-        return false;\r\n-    }\r\n-\r\n-    // Get the single point at which things are invalid.\r\n-    const auto invalidPoint = _invalidMap.runs().front().origin();\r\n-\r\n-    // Either the next character to the right or the immediately previous\r\n-    //      character should follow this code path\r\n-    //      (The immediate previous character would suggest a backspace)\r\n-    auto invalidIsNext = invalidPoint == _lastText;\r\n-    auto invalidIsLast = invalidPoint == til::point{ _lastText.x - 1, _lastText.y };\r\n-\r\n-    return invalidIsNext || invalidIsLast;\r\n-}\r\ndiff --git a/src/renderer/vt/paint.cpp b/src/renderer/vt/paint.cpp\nindex af08cdd5b58..1fcb5335887 100644\n--- a/src/renderer/vt/paint.cpp\n+++ b/src/renderer/vt/paint.cpp\n@@ -20,30 +20,30 @@ using namespace Microsoft::Console::Types;\n //      HRESULT error code if painting didn't start successfully.\r\n [[nodiscard]] HRESULT VtEngine::StartPaint() noexcept\r\n {\r\n+    // When unit testing, there may be no pipe, but we still need to paint.\r\n     if (!_hFile)\r\n     {\r\n-        return S_FALSE;\r\n+        return S_OK;\r\n     }\r\n \r\n     // If we're using line renditions, and this is a full screen paint, we can\r\n     // potentially stop using them at the end of this frame.\r\n     _stopUsingLineRenditions = _usingLineRenditions && _AllIsInvalid();\r\n \r\n-    // If there's nothing to do, quick return\r\n+    // If there's nothing to do, we won't need to paint.\r\n     auto somethingToDo = _invalidMap.any() ||\r\n                          _scrollDelta != til::point{ 0, 0 } ||\r\n                          _cursorMoved ||\r\n                          _titleChanged;\r\n \r\n-    _quickReturn = !somethingToDo;\r\n-    _trace.TraceStartPaint(_quickReturn,\r\n+    _trace.TraceStartPaint(!somethingToDo,\r\n                            _invalidMap,\r\n                            _lastViewport.ToExclusive(),\r\n                            _scrollDelta,\r\n                            _cursorMoved,\r\n                            _wrappedRow);\r\n \r\n-    return _quickReturn ? S_FALSE : S_OK;\r\n+    return somethingToDo ? S_OK : S_FALSE;\r\n }\r\n \r\n // Routine Description:\r\n@@ -142,9 +142,9 @@ using namespace Microsoft::Console::Types;\n         _usingLineRenditions = true;\r\n     }\r\n     // One simple optimization is that we can skip sending the line attributes\r\n-    // when _quickReturn is true. That indicates that we're writing out a single\r\n-    // character, which should preclude there being a rendition switch.\r\n-    if (_usingLineRenditions && !_quickReturn)\r\n+    // when we're writing out a single character, which should preclude there\r\n+    // being a rendition switch.\r\n+    if (_usingLineRenditions && !_invalidMap.one())\r\n     {\r\n         RETURN_IF_FAILED(_MoveCursor({ _lastText.x, targetRow }));\r\n         switch (lineRendition)\r\ndiff --git a/src/renderer/vt/state.cpp b/src/renderer/vt/state.cpp\nindex 881fb0c2cce..f192536e3e6 100644\n--- a/src/renderer/vt/state.cpp\n+++ b/src/renderer/vt/state.cpp\n@@ -37,7 +37,6 @@ VtEngine::VtEngine(_In_ wil::unique_hfile pipe,\n     _pool(til::pmr::get_default_resource()),\r\n     _invalidMap(initialViewport.Dimensions(), false, &_pool),\r\n     _scrollDelta(0, 0),\r\n-    _quickReturn(false),\r\n     _clearedAllThisFrame(false),\r\n     _cursorMoved(false),\r\n     _resized(false),\r\ndiff --git a/src/renderer/vt/vtrenderer.hpp b/src/renderer/vt/vtrenderer.hpp\nindex 0125fe17369..b5c487fc1c0 100644\n--- a/src/renderer/vt/vtrenderer.hpp\n+++ b/src/renderer/vt/vtrenderer.hpp\n@@ -113,7 +113,6 @@ namespace Microsoft::Console::Render\n         til::point _lastText;\r\n         til::point _scrollDelta;\r\n \r\n-        bool _quickReturn;\r\n         bool _clearedAllThisFrame;\r\n         bool _cursorMoved;\r\n         bool _resized;\r\n@@ -214,8 +213,6 @@ namespace Microsoft::Console::Render\n         [[nodiscard]] HRESULT _RgbUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n         [[nodiscard]] HRESULT _16ColorUpdateDrawingBrushes(const TextAttribute& textAttributes) noexcept;\r\n \r\n-        bool _WillWriteSingleChar() const;\r\n-\r\n         // buffer space for these two functions to build their lines\r\n         // so they don't have to alloc/free in a tight loop\r\n         std::wstring _bufferLine;\r\n", "instance_id": "microsoft__terminal-17194", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a bug in Windows Terminal where a DCS (Device Control String) sequence split across multiple packets gets corrupted by conpty, resulting in incorrect rendering behavior (permanent red background and visible sequence text). It provides a reproducible Python script, expected behavior, actual behavior, and a reference to a related issue. However, there are minor ambiguities and missing details. For instance, it does not explicitly define the root cause beyond a suspicion of conpty inserting an SGR reset sequence, nor does it clarify the exact timing or conditions under which the issue occurs beyond the provided script. Additionally, constraints or specific requirements for the fix (e.g., performance considerations or compatibility with other terminal behaviors) are not mentioned. While the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files in the Windows Terminal's VT renderer (e.g., XtermEngine.cpp, invalidate.cpp, paint.cpp, state.cpp, math.cpp, vtrenderer.hpp), indicating a need to understand and modify interactions across different components of the rendering engine. The changes involve removing or altering logic related to quick returns and single-character invalidation optimizations, which suggests a deep understanding of the rendering pipeline and cursor management is required. Second, the technical concepts involved include VT sequence handling, terminal rendering logic, and state management, which are moderately complex and specific to terminal emulation—a niche domain. Third, while the problem statement does not explicitly mention edge cases, the nature of terminal emulation implies potential challenges with timing (as hinted in the description), sequence parsing, and ensuring compatibility with various input scenarios, which adds to the complexity of testing and validation. Finally, the impact of these changes appears to be significant as they affect core rendering behavior, though not necessarily the overall architecture. Given the need for a deep understanding of the codebase, the multi-file modifications, and the domain-specific knowledge required, I rate this as 0.65, leaning towards the higher end of the \"Hard\" range but not quite reaching \"Very Hard\" due to the absence of system-level or highly intricate algorithmic challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Using == on std::string causes undefined symbol: __library_export_libcalls_memcmp\nWhen I use `==` or `compare` between objects of type `std::string` the linker complains as follows:\r\n```\r\nerror: ld.lld: error: undefined symbol: __library_export_libcalls_memcmp\r\n>>> referenced by hello.cc\r\n>>>               build/cheriot/cheriot/debug/hello.compartment:()\r\n```\r\n\r\nI get this error with the following minimal example.\r\nhello.cc:\r\n```\r\n#include <compartment.h>\r\n#include <debug.hh>\r\n#include <string>\r\n\r\nusing Debug = ConditionalDebug<true, \"Hello world compartment\">;\r\n\r\n/// Thread entry point.\r\nvoid __cheri_compartment(\"hello\") say_hello()\r\n{\r\n\tstd::string first = \"first\";\r\n\tstd::string second = \"second\";\r\n\tif (first == second) {\r\n\t\tDebug::log(\"Equal!\");\r\n\t}\r\n}\r\n```\r\nxmake.lua:\r\n```\r\nset_project(\"CHERIoT Hello World\")\r\nsdkdir = \"../../sdk\"\r\nincludes(sdkdir)\r\nset_toolchains(\"cheriot-clang\")\r\n\r\noption(\"board\")\r\n    set_default(\"sail\")\r\n\r\ncompartment(\"hello\")\r\n    add_deps(\"freestanding\", \"debug\", \"string\")\r\n    add_files(\"hello.cc\")\r\n\r\nfirmware(\"hello_world\")\r\n    add_deps(\"hello\")\r\n    on_load(function(target)\r\n        target:values_set(\"board\", \"$(board)\")\r\n        target:values_set(\"threads\", {\r\n            {\r\n                compartment = \"hello\",\r\n                priority = 1,\r\n                entry_point = \"say_hello\",\r\n                stack_size = 0x300,\r\n                trusted_stack_frames = 3\r\n            }\r\n        }, {expand = false})\r\n    end)\r\n```\r\n\n", "patch": "diff --git a/sdk/include/string.h b/sdk/include/string.h\nindex 965a02b6a..2dd75f1b7 100644\n--- a/sdk/include/string.h\n+++ b/sdk/include/string.h\n@@ -6,21 +6,27 @@\n #include <stddef.h>\n #include <stdint.h>\n \n-int __cheri_libcall   memcmp(const void *str1, const void *str2, size_t count);\n-void *__cheri_libcall memcpy(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memset(void *, int, size_t);\n-void *__cheri_libcall memmove(void *dest, const void *src, size_t n);\n-void *__cheri_libcall memchr(const void *, int, size_t);\n-void *__cheri_libcall memrchr(const void *, int, size_t);\n-size_t __cheri_libcall      strlen(const char *str);\n-int __cheri_libcall         strncmp(const char *s1, const char *s2, size_t n);\n-char *__cheri_libcall       strncpy(char *dest, const char *src, size_t n);\n-int __cheri_libcall         strcmp(const char *s1, const char *s2);\n-char *__cheri_libcall       strnstr(const char *haystack,\n-                                    const char *needle,\n-                                    size_t      haystackLength);\n-char *__cheri_libcall       strchr(const char *s, int c);\n-size_t __cheri_libcall      strlcpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    memcmp(const void *str1,\n+                              const void *str2,\n+                              size_t      count) __asm__(\"memcmp\");\n+void *__cheri_libcall  memcpy(void       *dest,\n+                              const void *src,\n+                              size_t      n) __asm__(\"memcpy\");\n+void *__cheri_libcall  memset(void *, int, size_t) __asm__(\"memset\");\n+void *__cheri_libcall  memmove(void       *dest,\n+                               const void *src,\n+                               size_t      n) __asm__(\"memmove\");\n+void *__cheri_libcall  memchr(const void *, int, size_t);\n+void *__cheri_libcall  memrchr(const void *, int, size_t);\n+size_t __cheri_libcall strlen(const char *str);\n+int __cheri_libcall    strncmp(const char *s1, const char *s2, size_t n);\n+char *__cheri_libcall  strncpy(char *dest, const char *src, size_t n);\n+int __cheri_libcall    strcmp(const char *s1, const char *s2);\n+char *__cheri_libcall  strnstr(const char *haystack,\n+                               const char *needle,\n+                               size_t      haystackLength);\n+char *__cheri_libcall  strchr(const char *s, int c);\n+size_t __cheri_libcall strlcpy(char *dest, const char *src, size_t n);\n \n /**\n  * Explicit bzero is a memset variant that the compiler is not permitted to\ndiff --git a/sdk/lib/freestanding/compat.S b/sdk/lib/freestanding/compat.S\nnew file mode 100644\nindex 000000000..b6b90c7b5\n--- /dev/null\n+++ b/sdk/lib/freestanding/compat.S\n@@ -0,0 +1,31 @@\n+// Copyright CHERIoT Contributors.\n+// SPDX-License-Identifier: MIT\n+\n+/**\n+ * This file contains compatibility aliases for exporting the freestanding\n+ * library functions as both mangled and unmangled symbols.\n+ */\n+\n+/**\n+ * Given a function named `function_name`, export it as a library function\n+ * named `export_function_name`.\n+ */\n+.macro EXPORT_COMPATIBILITY_ALIAS export_function_name, function_name, flags\n+\t.section .compartment_exports,\"aR\",@progbits\n+\t.type    __library_export_libcalls_\\export_function_name\\(),@object\n+\t.global  __library_export_libcalls_\\export_function_name\\()\n+    .p2align 2\n+  __library_export_libcalls_\\export_function_name\\():\n+\t.half \\function_name - __compartment_pcc_start\n+\t// Stack usage: Ignored for library exports\n+\t.byte 0\n+\t// Flags, only interrupt state is used for library exports, 0 is inherited\n+\t.byte \\flags\n+\t.size __library_export_libcalls_\\export_function_name, 40\n+\t.previous\n+.endm\n+\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcmpPKvS0_j, memcmp, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memcpyPvPKvj, memcpy, 3\n+EXPORT_COMPATIBILITY_ALIAS _Z6memsetPvij, memset, 2\n+EXPORT_COMPATIBILITY_ALIAS _Z7memmovePvPKvj, memmove, 3\ndiff --git a/sdk/lib/freestanding/memcmp.c b/sdk/lib/freestanding/memcmp.c\nindex 8f3eef9d6..9a3a5185e 100644\n--- a/sdk/lib/freestanding/memcmp.c\n+++ b/sdk/lib/freestanding/memcmp.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n /*\n  * Compare memory regions.\n  */\n-int __cheri_libcall\n+int\n memcmp(const void *s1, const void *s2, size_t n)\n {\n \tif (n != 0) {\ndiff --git a/sdk/lib/freestanding/memcpy.c b/sdk/lib/freestanding/memcpy.c\nindex 5b7c7915a..80e880a05 100644\n--- a/sdk/lib/freestanding/memcpy.c\n+++ b/sdk/lib/freestanding/memcpy.c\n@@ -45,6 +45,7 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n typedef void *word;\n \n@@ -54,7 +55,7 @@ _Static_assert((wsize & (wsize - 1)) == 0);\n \n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n+void *memcpy(void *dst0, const void *src0, size_t length)\n {\n \tchar *      dst = dst0;\n \tconst char *src = src0;\n@@ -119,7 +120,7 @@ void *__cheri_libcall memcpy(void *dst0, const void *src0, size_t length)\n \treturn (dst0);\n }\n \n-void *__cheri_libcall memmove(void *dst0, const void *src0, size_t length)\n+void *memmove(void *dst0, const void *src0, size_t length)\n {\n \treturn memcpy(dst0, src0, length);\n }\ndiff --git a/sdk/lib/freestanding/memset.c b/sdk/lib/freestanding/memset.c\nindex c9e4c0a31..8945d5c10 100644\n--- a/sdk/lib/freestanding/memset.c\n+++ b/sdk/lib/freestanding/memset.c\n@@ -34,11 +34,12 @@\n \n #include <cdefs.h>\n #include <stddef.h>\n+#include <string.h>\n \n #define wsize sizeof(unsigned int)\n #define wmask (wsize - 1)\n \n-void *__cheri_libcall memset(void *dst0, int c0, size_t length)\n+void *memset(void *dst0, int c0, size_t length)\n {\n \tsize_t         t;\n \tunsigned int   c;\ndiff --git a/sdk/lib/freestanding/xmake.lua b/sdk/lib/freestanding/xmake.lua\nindex 62f10fb8f..6daf6c5ce 100644\n--- a/sdk/lib/freestanding/xmake.lua\n+++ b/sdk/lib/freestanding/xmake.lua\n@@ -1,2 +1,2 @@\n library(\"freestanding\")\n-  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\")\n+  add_files(\"memcmp.c\", \"memcpy.c\", \"memset.c\", \"compat.S\")\n", "instance_id": "CHERIoT-Platform__cheriot-rtos-370", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: using `==` or `compare` on `std::string` results in a linker error due to an undefined symbol `__library_export_libcalls_memcmp`. The minimal example provided in `hello.cc` helps illustrate the problem context, and the error message is included, which adds clarity. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the target environment or constraints specific to the CHERIoT platform beyond the provided code snippets. Additionally, it lacks details on expected behavior or edge cases for the fix (e.g., compatibility requirements or performance considerations). While the issue is understandable, these missing pieces prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`string.h`, `memcmp.c`, `memcpy.c`, `memset.c`, `compat.S`, and `xmake.lua`), requiring modifications to both C source files and assembly code, as well as build configuration. This indicates a need to understand interactions between different parts of the codebase, including the freestanding library and the CHERIoT-specific build system. Second, the technical concepts involved are moderately advanced, including understanding C++ name mangling, linker behavior, CHERIoT-specific library export mechanisms (`__cheri_libcall` and custom assembly for compatibility aliases), and the integration of low-level memory operations with higher-level `std::string` functionality. Third, while the problem statement does not explicitly mention edge cases, the nature of the fix (removing `__cheri_libcall` annotations and adding compatibility aliases) suggests potential challenges in ensuring correctness across different calling conventions or environments, as well as maintaining compatibility with existing code. Finally, the changes impact a core part of the system (string and memory operations), which could have broader implications for the codebase, requiring careful consideration of side effects. Overall, solving this requires a deep understanding of low-level programming, platform-specific details, and cross-file modifications, justifying a difficulty score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Firestore for Mac doesn't build in CocoaPods for Xcode 15\n### Description\n\n    - NOTE  | [OSX] xcodebuild:  clang: error: SDK does not contain 'libarclite' at the path '/Applications/Xcode_15.0.1.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/arc/libarclite_macosx.a'; try increasing the minimum deployment target\r\n\r\nhttps://github.com/grpc/grpc/pull/36340 needs to be merged and published.\r\n\r\nThen update TODO's in firestore.yml, archive.yml, release.yml, and prerelease.yml\n\n### Reproducing the issue\n\nBuild Firestore example for macos or run pod lib lint ...\n\n### Firebase SDK Version\n\n10.24.0\n\n### Xcode Version\n\n15.3\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nFirestore\n\n### Targeted Platforms\n\nmacOS\n\n### Relevant Log Output\n\n_No response_\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/.github/workflows/archiving.yml b/.github/workflows/archiving.yml\nindex 0d8a7eeddcf..8d60f6785b4 100644\n--- a/.github/workflows/archiving.yml\n+++ b/.github/workflows/archiving.yml\n@@ -46,29 +46,7 @@ jobs:\n       matrix:\n         target: [ios, tvos, macos]\n         # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n-    steps:\n-    - uses: actions/checkout@v4\n-    - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\n-      with:\n-        cache_key: pods-${{ matrix.os }}\n-    - uses: ruby/setup-ruby@v1\n-    - name: Setup Bundler\n-      run: scripts/setup_bundler.sh\n-    - name: Setup project and archive\n-      run: scripts/test_archiving.sh ${{ matrix.pod }} ${{ matrix.target }} ArchiveOutputs/${{ matrix.target }}.xcarchive\n-\n-  # TODO(#12780: Merge Firestore back into above job after https://github.com/grpc/grpc/pull/36340\n-  pods-ios-tvos-macos-cron-macos12:\n-    # Don't run on private repo.\n-    if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule')\n-\n-    runs-on: macos-12\n-    strategy:\n-      matrix:\n-        target: [ios, tvos, macos]\n-        # These need to be on a single line or else the formatting won't validate.\n-        pod: [\"FirebaseFirestore\"]\n+        pod: [\"FirebaseABTesting\", \"FirebaseAuth\", \"FirebaseCore\", \"FirebaseCrashlytics\", \"FirebaseDatabase\", \"FirebaseFirestore\", \"FirebaseFunctions\", \"FirebaseMessaging\", \"FirebaseRemoteConfig\", \"FirebaseStorage\"]\n     steps:\n     - uses: actions/checkout@v4\n     - uses: mikehardy/buildcache-action@c87cea0ccd718971d6cc39e672c4f26815b6c126\ndiff --git a/.github/workflows/firestore.yml b/.github/workflows/firestore.yml\nindex f4641697a1b..ccf74fc36cb 100644\n--- a/.github/workflows/firestore.yml\n+++ b/.github/workflows/firestore.yml\n@@ -326,8 +326,7 @@ jobs:\n     if: |\n       (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') ||\n       (github.event_name == 'pull_request' && needs.changes.outputs.changed == 'true')\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     needs: check\n \n     strategy:\ndiff --git a/.github/workflows/prerelease.yml b/.github/workflows/prerelease.yml\nindex 296fd1c554f..6453cc4960a 100644\n--- a/.github/workflows/prerelease.yml\n+++ b/.github/workflows/prerelease.yml\n@@ -17,8 +17,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -112,8 +111,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\ndiff --git a/.github/workflows/release.yml b/.github/workflows/release.yml\nindex 500cc2e82eb..0604a1de1d9 100644\n--- a/.github/workflows/release.yml\n+++ b/.github/workflows/release.yml\n@@ -19,8 +19,7 @@ jobs:\n   specs_checking:\n     # Don't run on private repo unless it is a PR.\n     if: (github.repository == 'Firebase/firebase-ios-sdk' && github.event_name == 'schedule') || github.event_name == 'workflow_dispatch'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     env:\n       bot_token_secret: ${{ secrets.GHASecretsGPGPassphrase1 }}\n       # The SDK repo will be cloned to this dir and podspecs from\n@@ -114,8 +113,7 @@ jobs:\n     needs: [buildup_SpecsTesting_repo_FirebaseCore, specs_checking]\n     # Don't run on private repo unless it is a PR.\n     if: github.repository == 'Firebase/firebase-ios-sdk'\n-    # TODO(#12780): macOS 14 blocked on https://github.com/grpc/grpc/pull/36340\n-    runs-on: macos-12\n+    runs-on: macos-14\n     strategy:\n       fail-fast: false\n       matrix: ${{fromJson(needs.specs_checking.outputs.matrix)}}\n", "instance_id": "firebase__firebase-ios-sdk-12790", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: Firestore for Mac does not build in CocoaPods with Xcode 15 due to a missing 'libarclite' in the SDK. It references a specific upstream fix in a gRPC pull request (https://github.com/grpc/grpc/pull/36340) that needs to be merged and published, and mentions updating TODOs in several workflow files. However, there are minor ambiguities and missing details. For instance, it does not explicitly describe the expected outcome after the gRPC fix is applied (e.g., will it fully resolve the build issue, or are additional steps required?). Additionally, the problem statement lacks specifics on how to verify the fix beyond updating the workflow files, and it does not mention potential edge cases or risks associated with the macOS version upgrade. Despite these minor gaps, the goal and general steps are understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4). The code changes provided are straightforward, primarily involving updates to GitHub Actions workflow files (firestore.yml, archive.yml, release.yml, and prerelease.yml) to remove TODO comments, update the macOS runner version from 12 to 14, and merge Firestore back into the main pod list for testing and archiving. The scope of changes is limited to configuration files and does not involve complex logic, deep architectural modifications, or extensive codebase understanding beyond familiarity with GitHub Actions syntax and the context of the build issue. The technical concepts required are minimal—basic knowledge of CI/CD workflows and macOS versioning. There are no significant edge cases or error handling requirements mentioned in the problem statement or evident in the code changes, as the updates are mostly mechanical. The primary challenge lies in ensuring the upstream gRPC fix is merged and published, but this is outside the scope of the code changes provided and does not directly impact the difficulty of the modifications themselves. Therefore, a score of 0.30 reflects the simplicity of the task while acknowledging the need for some contextual understanding of the build environment.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "TextEdit Scroll Repeats Last Line and Text Pops In\n### Tested versions\n\n- Reproducible in 4.4 Stable, 4.3 Stable, 4.2.2 Stable, 4.2 Stable\n- Not Reproducible in 4.1.4 Stable\n\n### System information\n\nGodot v4.2.stable - macOS 14.5.0 - Vulkan (Forward+) - integrated Apple M1 Pro - Apple M1 Pro (10 Threads)\n\n### Issue description\n\nFor certain heights, the `TextEdit` displays text only displays when the line is fully visible, like a popping into existence effect. This also causes the last line to appear to repeat twice when scrolling down.\n\nFor one line; the following heights have issues: 15-21, 23-24, 26-29, 31-32, 34 px\n\nhttps://github.com/user-attachments/assets/82f8544a-3491-44d5-9da7-ca0a70ed694b\n\n### Steps to reproduce\n\n1. Create a scene with a TextEdit Node\n2. Set the text to \"0\"\n3. Set the size to (100, 32)\n4. Run the scene, and scroll down on the TextEdit\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/19400545/MRP.zip)\n", "patch": "diff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex f6f700de2a6a..8c891d08ce97 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -852,7 +852,7 @@ void TextEdit::_notification(int p_what) {\n \t\t\t}\n \n \t\t\tint first_vis_line = get_first_visible_line() - 1;\n-\t\t\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\t\t\tint draw_amount = visible_rows + 1;\n \t\t\tdraw_amount += draw_placeholder ? placeholder_wrapped_rows.size() - 1 : get_line_wrap_count(first_vis_line + 1);\n \n \t\t\t// Draw minimap.\n@@ -4639,7 +4639,7 @@ int TextEdit::get_minimap_line_at_pos(const Point2i &p_pos) const {\n \tint minimap_visible_lines = get_minimap_visible_lines();\n \tint visible_rows = get_visible_line_count() + 1;\n \tint first_vis_line = get_first_visible_line() - 1;\n-\tint draw_amount = visible_rows + (smooth_scroll_enabled ? 1 : 0);\n+\tint draw_amount = visible_rows + 1;\n \tdraw_amount += get_line_wrap_count(first_vis_line + 1);\n \tint minimap_line_height = (minimap_char_size.y + minimap_line_spacing);\n \n@@ -8053,7 +8053,7 @@ void TextEdit::_update_scrollbars() {\n \n \tint visible_rows = get_visible_line_count();\n \tint total_rows = draw_placeholder ? placeholder_wrapped_rows.size() : get_total_visible_line_count();\n-\tif (scroll_past_end_of_file_enabled && !fit_content_height) {\n+\tif ((scroll_past_end_of_file_enabled && !fit_content_height) || visible_rows == 0) {\n \t\ttotal_rows += visible_rows - 1;\n \t}\n \n@@ -8076,7 +8076,6 @@ void TextEdit::_update_scrollbars() {\n \t\tv_scroll->set_max(total_rows + _get_visible_lines_offset());\n \t\tv_scroll->set_page(visible_rows + _get_visible_lines_offset());\n \t\tset_v_scroll(get_v_scroll());\n-\n \t} else {\n \t\tfirst_visible_line = 0;\n \t\tfirst_visible_line_wrap_ofs = 0;\n", "instance_id": "godotengine__godot-104776", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear, providing a detailed description of the issue with the `TextEdit` component in the Godot engine, including specific versions affected, system information, and steps to reproduce the issue. It also includes a minimal reproduction project (MRP) and a visual reference (GitHub attachment) to demonstrate the problem. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or desired output after the fix (e.g., how the text should appear when scrolling or what \"popping into existence\" should be replaced with). Additionally, edge cases beyond specific heights are not mentioned, which could be critical for a complete solution. Thus, while the issue is well-documented, it lacks some precision in defining the success criteria for the fix.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively small, confined to a single file (`text_edit.cpp`) with modifications to a few specific lines related to scrolling and visibility logic in the `TextEdit` class. The changes involve adjusting calculations for visible lines and scroll behavior, which suggests a focused bug fix rather than a broad architectural change. However, understanding the codebase requires familiarity with Godot's GUI rendering logic, particularly how `TextEdit` handles line drawing, scrolling, and minimap rendering, which involves non-trivial concepts like smooth scrolling and line wrapping. The technical concepts required include knowledge of GUI rendering, scroll mechanics, and potentially floating-point precision issues in pixel calculations (given the specific heights mentioned). Edge cases are partially addressed in the problem statement (specific heights causing issues), but the code changes do not explicitly handle new error conditions, though they adjust logic to prevent visual glitches. Overall, this problem requires a moderate understanding of the codebase and targeted modifications, placing it in the 0.4-0.6 range, with a score of 0.45 reflecting a slightly above-average challenge within the \"medium\" category due to the need for domain-specific GUI knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Tween] PropertyTweener with a custom interpolator always stops at the 'to' value.\n### Tested versions\n\n- Tested in 4.4 stable (probably a long standing issue)\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 3 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3050 (NVIDIA; 32.0.15.7283) - AMD Ryzen 5 4500 6-Core Processor (12 threads)\n\n### Issue description\n\nWhen tweening a property with a custom interpolator, it always set's the property to the final position after the tween finishes, rather than the value it should be at based from the custom interpolator function.\n\nExample:\n\n`func _ready() -> void:\n\ttween = create_tween()\n\ttween.tween_property(self, \"position:x, 500.0, 2.0).set_custom_interpolator(_interpolator)\n\nfunc _interpolator(time: float) -> float:\n\treturn 0.25\n`\nshould be aways at 25% of the way, but after the tween finishes, the x-position goes to 500.\n\n### Steps to reproduce\n\n- Create a function that does not return 1.0 when the input parameter is 1.0.\n- Set that function as the custom interpolator for the PropertyTweener.\n\n### Minimal reproduction project (MRP)\n\n[tween_test_2025-03-24_07-49-49.zip](https://github.com/user-attachments/files/19437132/tween_test_2025-03-24_07-49-49.zip)\n\nThis uses almost the same example given in the docs (https://docs.godotengine.org/en/stable/classes/class_propertytweener.html#class-propertytweener-method-set-custom-interpolator).\n", "patch": "diff --git a/scene/animation/tween.cpp b/scene/animation/tween.cpp\nindex 230f55de8427..db0f0e2684ba 100644\n--- a/scene/animation/tween.cpp\n+++ b/scene/animation/tween.cpp\n@@ -542,6 +542,20 @@ Tween::Tween(SceneTree *p_parent_tree) {\n \tvalid = true;\n }\n \n+double PropertyTweener::_get_custom_interpolated_value(const Variant &p_value) {\n+\tconst Variant *argptr = &p_value;\n+\n+\tVariant result;\n+\tCallable::CallError ce;\n+\tcustom_method.callp(&argptr, 1, result, ce);\n+\tif (ce.error != Callable::CallError::CALL_OK) {\n+\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n+\t} else if (result.get_type() != Variant::FLOAT) {\n+\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n+\t}\n+\treturn result;\n+}\n+\n Ref<PropertyTweener> PropertyTweener::from(const Variant &p_value) {\n \tRef<Tween> tween = _get_tween();\n \tERR_FAIL_COND_V(tween.is_null(), nullptr);\n@@ -638,17 +652,7 @@ bool PropertyTweener::step(double &r_delta) {\n \tif (time < duration) {\n \t\tif (custom_method.is_valid()) {\n \t\t\tconst Variant t = tween->interpolate_variant(0.0, 1.0, time, duration, trans_type, ease_type);\n-\t\t\tconst Variant *argptr = &t;\n-\n-\t\t\tVariant result;\n-\t\t\tCallable::CallError ce;\n-\t\t\tcustom_method.callp(&argptr, 1, result, ce);\n-\t\t\tif (ce.error != Callable::CallError::CALL_OK) {\n-\t\t\t\tERR_FAIL_V_MSG(false, \"Error calling custom method from PropertyTweener: \" + Variant::get_callable_error_text(custom_method, &argptr, 1, ce) + \".\");\n-\t\t\t} else if (result.get_type() != Variant::FLOAT) {\n-\t\t\t\tERR_FAIL_V_MSG(false, vformat(\"Wrong return type in PropertyTweener custom method. Expected float, got %s.\", Variant::get_type_name(result.get_type())));\n-\t\t\t}\n-\n+\t\t\tdouble result = _get_custom_interpolated_value(t);\n \t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, result));\n \t\t} else {\n \t\t\ttarget_instance->set_indexed(property, tween->interpolate_variant(initial_val, delta_val, time, duration, trans_type, ease_type));\n@@ -656,7 +660,12 @@ bool PropertyTweener::step(double &r_delta) {\n \t\tr_delta = 0;\n \t\treturn true;\n \t} else {\n-\t\ttarget_instance->set_indexed(property, final_val);\n+\t\tif (custom_method.is_valid()) {\n+\t\t\tdouble final_t = _get_custom_interpolated_value(1.0);\n+\t\t\ttarget_instance->set_indexed(property, Animation::interpolate_variant(initial_val, final_val, final_t));\n+\t\t} else {\n+\t\t\ttarget_instance->set_indexed(property, final_val);\n+\t\t}\n \t\tr_delta = elapsed_time - delay - duration;\n \t\t_finish();\n \t\treturn false;\ndiff --git a/scene/animation/tween.h b/scene/animation/tween.h\nindex 8d4b9eae6b48..d987b6e9a867 100644\n--- a/scene/animation/tween.h\n+++ b/scene/animation/tween.h\n@@ -200,6 +200,8 @@ VARIANT_ENUM_CAST(Tween::EaseType);\n class PropertyTweener : public Tweener {\n \tGDCLASS(PropertyTweener, Tweener);\n \n+\tdouble _get_custom_interpolated_value(const Variant &p_value);\n+\n public:\n \tRef<PropertyTweener> from(const Variant &p_value);\n \tRef<PropertyTweener> from_current();\n", "instance_id": "godotengine__godot-104578", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the PropertyTweener in the Godot engine when using a custom interpolator. It provides a specific example of the problem (the interpolator returning a constant 0.25 but the property jumping to the final value of 500), steps to reproduce, and references to the documentation. Additionally, a minimal reproduction project (MRP) is provided, which aids in understanding the issue. However, there are minor ambiguities: the problem statement does not explicitly discuss expected behavior in edge cases (e.g., what should happen if the custom interpolator returns invalid values like negative numbers or values outside the expected range). It also lacks detail on whether this issue affects other types of tweening or properties beyond position. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single class (PropertyTweener) in the tween.cpp file, with minor updates to the header file. The changes involve refactoring the logic for applying the custom interpolator's final value and extracting a helper method for clarity, which is not architecturally significant but does require understanding the tweening system's internal logic. Second, the technical concepts involved include familiarity with Godot's animation system, C++ (specifically how Variants and Callables are handled), and the behavior of custom interpolators, which are moderately complex but not overly advanced. Third, the problem does not explicitly mention edge cases beyond the core issue, but the code changes do account for error handling (e.g., checking return types and callable errors), which adds a small layer of complexity. Overall, this requires understanding a specific part of the codebase and making targeted modifications, but it does not demand deep architectural changes or advanced domain knowledge, justifying a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Occlusion Culling on OpenXR is unstable (meshes flickering) in Godot4.4-stable\n### Tested versions\n\n- Reproducible in Godot v4.4-stable, Godot v4.4.1-rc1\n   - Meta Quest 3\n   - X11+SteamVR/OpenXR Vulkan (mobile and forward+)\n       - OpenXR: Running on OpenXR runtime:  SteamVR/OpenXR   2.9.6\n       - OpenXR: XrGraphicsRequirementsVulkan2KHR:\n         - minApiVersionSupported:  1.0.0\n         - maxApiVersionSupported:  1.2.0\n\n- Not Reproducible in Godot v4.3-stable\n\n### System information\n\nGodot v4.4.stable - Ubuntu 22.04.5 LTS 22.04 on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Mobile) - dedicated NVIDIA GeForce RTX 3050 Laptop GPU - 12th Gen Intel(R) Core(TM) i7-12700H (14 threads)\n\n### Issue description\n\nhttps://github.com/user-attachments/assets/b1f55edf-e9d9-4691-80e5-fc0363f7f0fc\n\nWhen Occlusion Culling is enabled in Godot 4.4-stable some meshes are mysteriously culled. Only Reproducible when using OpenXR and `root.use_xr == true`\n\n### Steps to reproduce\n\n* Extract minimal reproduction in OpenXR\n* install [Godot Openxr vendors addon](https://github.com/GodotVR/godot_openxr_vendors/releases/) in 4_4/addons and 4_3/addons\n* Run 4_4/project.godot or 4_3/project.godot\n\n### Minimal reproduction project (MRP)\n\n[xr-ocull-broken.zip](https://github.com/user-attachments/files/19265466/xr-ocull-broken.zip)\n", "patch": "diff --git a/modules/raycast/raycast_occlusion_cull.cpp b/modules/raycast/raycast_occlusion_cull.cpp\nindex 9f95307cf1c5..88691be8a382 100644\n--- a/modules/raycast/raycast_occlusion_cull.cpp\n+++ b/modules/raycast/raycast_occlusion_cull.cpp\n@@ -525,14 +525,14 @@ void RaycastOcclusionCull::buffer_set_size(RID p_buffer, const Vector2i &p_size)\n \tbuffers[p_buffer].resize(p_size);\n }\n \n-Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents, const Size2i &p_viewport_size) {\n+Vector2 RaycastOcclusionCull::_get_jitter(const Rect2 &p_viewport_rect, const Size2i &p_buffer_size) {\n \tif (!_jitter_enabled) {\n-\t\treturn p_half_extents;\n+\t\treturn Vector2();\n \t}\n \n \t// Prevent divide by zero when using NULL viewport.\n-\tif ((p_viewport_size.x <= 0) || (p_viewport_size.y <= 0)) {\n-\t\treturn p_half_extents;\n+\tif ((p_buffer_size.x <= 0) || (p_buffer_size.y <= 0)) {\n+\t\treturn Vector2();\n \t}\n \n \tint32_t frame = Engine::get_singleton()->get_frames_drawn();\n@@ -568,8 +568,8 @@ Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents\n \t\t\tjitter = Vector2(0.5f, 0.5f);\n \t\t} break;\n \t}\n-\n-\tjitter *= Vector2(p_half_extents.x / (float)p_viewport_size.x, p_half_extents.y / (float)p_viewport_size.y);\n+\tVector2 half_extents = p_viewport_rect.get_size() * 0.5;\n+\tjitter *= Vector2(half_extents.x / (float)p_buffer_size.x, half_extents.y / (float)p_buffer_size.y);\n \n \t// The multiplier here determines the jitter magnitude in pixels.\n \t// It seems like a value of 0.66 matches well the above jittering pattern as it generates subpixel samples at 0, 1/3 and 2/3\n@@ -578,7 +578,16 @@ Vector2 RaycastOcclusionCull::_jitter_half_extents(const Vector2 &p_half_extents\n \t// False shown can lower percentage that are occluded, and therefore performance.\n \tjitter *= 0.66f;\n \n-\treturn p_half_extents + jitter;\n+\treturn jitter;\n+}\n+\n+Rect2 _get_viewport_rect(const Projection &p_cam_projection) {\n+\t// NOTE: This assumes a rectangular projection plane, i.e. that:\n+\t// - the matrix is a projection across z-axis (i.e. is invertible and columns[0][1], [0][3], [1][0] and [1][3] == 0)\n+\t// - the projection plane is rectangular (i.e. columns[0][2] and [1][2] == 0 if columns[2][3] != 0)\n+\tSize2 half_extents = p_cam_projection.get_viewport_half_extents();\n+\tPoint2 bottom_left = -half_extents * Vector2(p_cam_projection.columns[3][0] * p_cam_projection.columns[3][3] + p_cam_projection.columns[2][0] * p_cam_projection.columns[2][3] + 1, p_cam_projection.columns[3][1] * p_cam_projection.columns[3][3] + p_cam_projection.columns[2][1] * p_cam_projection.columns[2][3] + 1);\n+\treturn Rect2(bottom_left, 2 * half_extents);\n }\n \n void RaycastOcclusionCull::buffer_update(RID p_buffer, const Transform3D &p_cam_transform, const Projection &p_cam_projection, bool p_cam_orthogonal) {\n@@ -595,11 +604,12 @@ void RaycastOcclusionCull::buffer_update(RID p_buffer, const Transform3D &p_cam_\n \tScenario &scenario = scenarios[buffer.scenario_rid];\n \tscenario.update();\n \n-\tVector2 viewport_half = p_cam_projection.get_viewport_half_extents();\n-\tVector2 jitter_viewport_half = _jitter_half_extents(viewport_half, buffer.get_occlusion_buffer_size());\n-\tVector3 near_bottom_left = Vector3(-jitter_viewport_half.x, -jitter_viewport_half.y, -p_cam_projection.get_z_near());\n+\tRect2 vp_rect = _get_viewport_rect(p_cam_projection);\n+\tVector2 bottom_left = vp_rect.position;\n+\tbottom_left += _get_jitter(vp_rect, buffer.get_occlusion_buffer_size());\n+\tVector3 near_bottom_left = Vector3(bottom_left.x, bottom_left.y, -p_cam_projection.get_z_near());\n \n-\tbuffer.update_camera_rays(p_cam_transform, near_bottom_left, 2 * viewport_half, p_cam_projection.get_z_far(), p_cam_orthogonal);\n+\tbuffer.update_camera_rays(p_cam_transform, near_bottom_left, vp_rect.get_size(), p_cam_projection.get_z_far(), p_cam_orthogonal);\n \n \tscenario.raycast(buffer.camera_rays, buffer.camera_ray_masks.ptr(), buffer.camera_rays_tile_count);\n \tbuffer.sort_rays(-p_cam_transform.basis.get_column(2), p_cam_orthogonal);\ndiff --git a/modules/raycast/raycast_occlusion_cull.h b/modules/raycast/raycast_occlusion_cull.h\nindex a831336df53a..51c1a196eaf0 100644\n--- a/modules/raycast/raycast_occlusion_cull.h\n+++ b/modules/raycast/raycast_occlusion_cull.h\n@@ -161,7 +161,7 @@ class RaycastOcclusionCull : public RendererSceneOcclusionCull {\n \tbool _jitter_enabled = false;\n \n \tvoid _init_embree();\n-\tVector2 _jitter_half_extents(const Vector2 &p_half_extents, const Size2i &p_viewport_size);\n+\tVector2 _get_jitter(const Rect2 &p_viewport_rect, const Size2i &p_buffer_size);\n \n public:\n \tvirtual bool is_occluder(RID p_rid) override;\n", "instance_id": "godotengine__godot-104249", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue of occlusion culling instability (meshes flickering) in Godot 4.4-stable when using OpenXR. It provides specific details about the versions tested, system information, hardware used, and steps to reproduce the issue, along with a minimal reproduction project (MRP). The issue is tied to a specific feature (occlusion culling with OpenXR) and includes visual evidence via an attachment. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or desired outcome of the fix (e.g., what \"stable\" occlusion culling should look like), nor does it mention specific edge cases or constraints that might be critical to solving the issue. Additionally, the root cause of the flickering is not hypothesized or detailed, leaving some uncertainty for the developer. Overall, while the problem is reproducible and well-documented, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes, while localized to a single file (`raycast_occlusion_cull.cpp`) and its header, involves intricate modifications to the occlusion culling logic, specifically around viewport calculations and jitter handling. This suggests a deep understanding of the rendering pipeline in Godot, particularly how occlusion culling interacts with OpenXR and projection matrices. Second, the technical concepts required are advanced, including knowledge of 3D graphics (viewport projections, camera transforms, raycasting), jittering techniques for anti-aliasing or subpixel sampling, and potentially domain-specific knowledge of OpenXR and Vulkan rendering. Third, the problem likely involves subtle edge cases, such as specific projection matrix configurations or viewport sizes that could cause flickering, though these are not explicitly mentioned in the problem statement. The code changes show a refactoring of how viewport rectangles and jitter are calculated, which could have broader implications on rendering accuracy and performance, requiring careful validation. Finally, solving this issue demands familiarity with Godot's internal architecture and debugging rendering issues in a VR context, which is inherently complex. A score of 0.75 reflects the need for deep expertise in graphics programming and the codebase, combined with the potential for non-trivial debugging and testing to ensure stability across different hardware and OpenXR configurations.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't cycle Buttons in \"Attach Node Script'' panel with Tab/Shift+Tab\n### Tested versions\n\n- Reproduceable in Godot v4.3.stable (77dcf97d8)\n\n### System information\n\nGodot v4.3.stable (77dcf97d8) - Windows 10.0.26100 - Vulkan (Mobile) - dedicated NVIDIA GeForce GTX 1080 Ti (NVIDIA; 32.0.15.6109) - AMD Ryzen 5 3600 6-Core Processor (12 Threads)\n\n### Issue description\n\nWhen creating a new script on the \"Attach Node Script\" panel if we press tab we can select all other widgets except for \"Create\" and \"Cancel\" buttons. \n\n![Image](https://github.com/user-attachments/assets/12217652-8021-493f-99c8-cfd36789f45f)\n\n### Steps to reproduce\n\n1- Create a node (any kind)\n2- Add a New Script\n3- Notice we can't use Tab to select any of the buttons, only the rest of the properties.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/scene/gui/dialogs.cpp b/scene/gui/dialogs.cpp\nindex d09ce9d72207..a79ba285e9ad 100644\n--- a/scene/gui/dialogs.cpp\n+++ b/scene/gui/dialogs.cpp\n@@ -467,7 +467,7 @@ AcceptDialog::AcceptDialog() {\n \tmessage_label->set_anchor(SIDE_BOTTOM, Control::ANCHOR_END);\n \tadd_child(message_label, false, INTERNAL_MODE_FRONT);\n \n-\tadd_child(buttons_hbox, false, INTERNAL_MODE_FRONT);\n+\tadd_child(buttons_hbox, false, INTERNAL_MODE_BACK);\n \n \tbuttons_hbox->add_spacer();\n \tok_button = memnew(Button);\n", "instance_id": "godotengine__godot-103967", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to cycle through buttons in the \"Attach Node Script\" panel using Tab/Shift+Tab in Godot v4.3.stable. It provides specific steps to reproduce the issue, a relevant screenshot, and system information, which helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (i.e., the buttons should be selectable via Tab/Shift+Tab) but not explicitly stated. Additionally, there is no mention of potential edge cases or specific requirements for how the fix should behave in different scenarios (e.g., different UI configurations or accessibility settings). Overall, while the problem is understandable, it lacks some precision in defining the desired outcome and constraints, which prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem is very low, as it falls into the 0.0-0.2 range. The code change provided is minimal, involving a single line modification in `dialogs.cpp` to change the internal mode of `buttons_hbox` from `INTERNAL_MODE_FRONT` to `INTERNAL_MODE_BACK`. This suggests the fix is related to the rendering or focus order of UI elements, likely a simple adjustment to ensure the buttons are included in the tab navigation cycle. The scope of the change is limited to a single file and does not appear to impact other parts of the codebase or require deep architectural understanding. The technical concepts involved are basic—understanding UI layout and focus handling in Godot's GUI system, which is not particularly complex for someone familiar with GUI programming. There are no explicit edge cases or error handling requirements mentioned in the problem statement, and the code change does not introduce or modify any error handling logic. Overall, this is a straightforward bug fix that requires minimal effort and expertise to implement and verify.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Shader Materials broken when created in C# (Regression from `4.4-beta2` -> `4.4-beta3`)\n### Tested versions\n\n- The regression occurs in `4.4-beta3`, `4.4-beta4`, `4.4-rc1`.\n- The last working version is `4.4-beta2`.\n\n### System information\n\nGodot v4.4.rc1.mono - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1050 Ti (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i3-9100F CPU @ 3.60GHz (4 threads)\n\n### Issue description\n\n`ShaderMaterial` is completely bugged when created with `new` in C# starting with Godot `4.4-beta3`.\n\nHere is the code that works in `4.4-beta2` but not in `4.4-beta3` and beyond:\n\n```cs\n[Export] Shader EyesShader;\n\n// ...\n\nShaderMaterial EyesMaterial = new() {\n    Shader = EyesShader,\n};\nFaceMesh.SetSurfaceOverrideMaterial(0, EyesMaterial);\n```\n\nHere is the fix:\n\n```cs\n[Export] ShaderMaterial EyesMaterial;\n\n// ...\n\n// Create eyes material\nShaderMaterial Material = (ShaderMaterial)EyesMaterial.Duplicate();\nFaceMesh.SetSurfaceOverrideMaterial(0, Material);\n```\n\nThis is what it looks like in `4.4-beta2`:\n\n![Image](https://github.com/user-attachments/assets/209d6015-e635-46e8-831e-7e78849d994e)\n\nThis is what it looks like in `4.4-rc1` (same as `4.4-beta3` and `4.4-beta4`):\n\n![Image](https://github.com/user-attachments/assets/70b04f25-70f3-4357-8460-debbb8910b72)\n\nThe big orange eyes are created in the editor so the `ShaderMaterial` is not instantiated in C#. The blue eyes on the character are subject to the given C# code.\n\n### Steps to reproduce\n\n```cs\nShader ExampleShader;\nMeshInstance3D ExampleMeshInstance3D;\n\nExampleMeshInstance3D.SetSurfaceOverrideMaterial(0, new ShaderMaterial() {\n    Shader = ExampleShader,\n});\n```\n\n### Minimal reproduction project (MRP)\n\n[shader-material-regression.zip](https://github.com/user-attachments/files/18925757/shader-material-regression.zip)\n\nGodot `4.4-beta2`:\n\n![Image](https://github.com/user-attachments/assets/0fc78bb6-2b7b-4974-b97a-ffe80a39ebb2)\n\nGodot `4.4-rc1`:\n\n![Image](https://github.com/user-attachments/assets/bda579d8-2055-4223-81a5-e8f90854a6ed)\n", "patch": "diff --git a/servers/rendering/renderer_rd/storage_rd/material_storage.cpp b/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\nindex 6008a4d38f24..34ddb2871d55 100644\n--- a/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/material_storage.cpp\n@@ -799,7 +799,7 @@ void MaterialStorage::MaterialData::update_uniform_buffer(const HashMap<StringNa\n \n \t\t} else if (E.value.default_value.size()) {\n \t\t\t//default value\n-\t\t\t_fill_std140_ubo_value(E.value.type, E.value.default_value, data, p_use_linear_color);\n+\t\t\t_fill_std140_ubo_value(E.value.type, E.value.default_value, data, E.value.hint == ShaderLanguage::ShaderNode::Uniform::HINT_SOURCE_COLOR && p_use_linear_color);\n \t\t\t//value=E.value.default_value;\n \t\t} else {\n \t\t\t//zero because it was not provided\n", "instance_id": "godotengine__godot-103201", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of Godot where the regression occurs, the system information, and visual evidence of the bug through images. It also includes a minimal reproduction code snippet and a reference to a reproduction project, which aids in understanding the problem. The goal is evident: to fix a regression in `ShaderMaterial` behavior when instantiated in C# starting from Godot version `4.4-beta3`. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly describe the expected behavior of `ShaderMaterial` beyond visual differences in the images, nor does it detail the root cause of the regression beyond pointing to version changes. Additionally, while a workaround is provided, the statement lacks clarity on whether the fix in the code changes is the intended solution or just a temporary patch. Constraints or edge cases (e.g., specific shader types or rendering pipelines affected) are not explicitly mentioned, which could be critical for a complete understanding.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is localized to a single line in `material_storage.cpp`, specifically modifying a condition in the `_fill_std140_ubo_value` function related to color handling (`p_use_linear_color`). While the change itself is small, it appears to be in a critical part of the rendering pipeline of the Godot engine, which suggests that understanding the impact requires deep knowledge of the rendering subsystem and material storage logic. The change likely affects how uniform buffer objects (UBOs) are populated for shaders, which could have broader implications across the codebase, even if the diff is minimal.\n\n2. **Technical Concepts Involved**: Solving this issue requires understanding several advanced concepts, including shader material handling in Godot, the rendering pipeline (specifically Vulkan and Forward+ rendering), uniform buffer object management, and color space handling (linear vs. non-linear color). Additionally, familiarity with Godot's internal architecture and how C# interop works with native components is necessary to fully grasp why the regression occurs when materials are instantiated in C#. The fix also hints at domain-specific knowledge of graphics programming, particularly around color hints in shaders.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of the bug (related to rendering and color handling) implies potential complexities in edge cases such as different shader configurations, rendering backends, or hardware-specific behaviors. The code change itself does not introduce new error handling but modifies existing logic, which could have subtle downstream effects that need to be tested across various scenarios (e.g., different GPUs or shader types). Understanding and validating the fix likely requires comprehensive testing beyond the provided minimal reproduction project.\n\n4. **Overall Complexity**: While the code change is small, the difficulty lies in diagnosing the root cause of the regression and ensuring the fix does not introduce new issues in the rendering pipeline. This requires a deep understanding of Godot's internals, graphics programming, and potentially debugging across C# and C++ layers of the engine. The problem's impact on a core feature (shader materials) and its regression nature across multiple versions further elevate the difficulty, as it may involve bisecting commits or analyzing changelog differences between `4.4-beta2` and `4.4-beta3`.\n\nIn summary, this problem is challenging due to the need for specialized knowledge in graphics and engine internals, even though the code change itself is minimal. It falls short of \"Very Hard\" (0.8-1.0) because it does not appear to require extensive refactoring or system-level redesign, but it is still a complex issue that demands significant expertise.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Playing many audio samples causes ever increasing cpu usage in web export\n### Tested versions\n\nv4.4.beta2.official [a013481b0]\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nIn web export of my game after playing for a while, the audio starts to crackle. I think I narrowed it down to playing lots of audio samples over time. Even thought the audio samples are short and finish quickly, the cpu usage goes up over time and does not come back down. \n\n\n### Steps to reproduce\n\nI've attached a simple project that plays 100 audio samples each time the 'play' button is pressed.\n\nExport MRP as a no-thread web app. Open in Chrome or Firefox and open the browser's task manager. \nFind WebAudioTest task and note CPU usage (starts low - a few % on my computer)\nClick the play button a bunch of times. CPU starts increasing and doesn't drop again.\nEventually CPU usage becomes so high that audio starts to crackle as well.\n\nMRP also includes a short python script to start a local server:\nD:\\...\\webaudiotest>python server.py \n\n### Minimal reproduction project (MRP)\n\n[webaudiotest.zip](https://github.com/user-attachments/files/18698995/webaudiotest.zip)\n", "patch": "diff --git a/platform/web/js/libs/audio.position.worklet.js b/platform/web/js/libs/audio.position.worklet.js\nindex 7dbeb8a0adde..155d4e6e8765 100644\n--- a/platform/web/js/libs/audio.position.worklet.js\n+++ b/platform/web/js/libs/audio.position.worklet.js\n@@ -35,16 +35,20 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\tsuper(...args);\n \t\tthis.lastPostTime = currentTime;\n \t\tthis.position = 0;\n+\t\tthis.ended = false;\n \n \t\tthis.port.onmessage = (event) => {\n-\t\t\tif (event?.data?.type === 'clear') {\n-\t\t\t\tthis.lastPostTime = currentTime;\n-\t\t\t\tthis.position = 0;\n+\t\t\tif (event?.data?.type === 'ended') {\n+\t\t\t\tthis.ended = true;\n \t\t\t}\n \t\t};\n \t}\n \n \tprocess(inputs, _outputs, _parameters) {\n+\t\tif (this.ended) {\n+\t\t\treturn false;\n+\t\t}\n+\n \t\tif (inputs.length > 0) {\n \t\t\tconst input = inputs[0];\n \t\t\tif (input.length > 0) {\n@@ -55,7 +59,7 @@ class GodotPositionReportingProcessor extends AudioWorkletProcessor {\n \t\t// Posting messages is expensive. Let's limit the number of posts.\n \t\tif (currentTime - this.lastPostTime > POST_THRESHOLD_S) {\n \t\t\tthis.lastPostTime = currentTime;\n-\t\t\tthis.port.postMessage({ 'type': 'position', 'data': this.position });\n+\t\t\tthis.port.postMessage({ type: 'position', data: this.position });\n \t\t}\n \n \t\treturn true;\ndiff --git a/platform/web/js/libs/library_godot_audio.js b/platform/web/js/libs/library_godot_audio.js\nindex c5fa7d5f0fad..d04862795308 100644\n--- a/platform/web/js/libs/library_godot_audio.js\n+++ b/platform/web/js/libs/library_godot_audio.js\n@@ -621,28 +621,24 @@ class SampleNode {\n \t\tif (this.isCanceled) {\n \t\t\treturn;\n \t\t}\n-\t\tthis.getPositionWorklet();\n-\t\tthis._source.connect(this._positionWorklet);\n+\t\tthis._source.connect(this.getPositionWorklet());\n \t\tif (start) {\n \t\t\tthis.start();\n \t\t}\n \t}\n \n \t/**\n-\t * Get a AudioWorkletProcessor from the pool, or create one if no processor is available.\n+\t * Get a AudioWorkletProcessor\n+\t * @returns {AudioWorkletNode}\n \t */\n \tgetPositionWorklet() {\n \t\tif (this._positionWorklet != null) {\n-\t\t\treturn;\n-\t\t}\n-\t\tif (GodotAudio.audioPositionWorkletPool.length == 0) {\n-\t\t\tthis._positionWorklet = new AudioWorkletNode(\n-\t\t\t\tGodotAudio.ctx,\n-\t\t\t\t'godot-position-reporting-processor'\n-\t\t\t);\n-\t\t} else {\n-\t\t\tthis._positionWorklet = GodotAudio.audioPositionWorkletPool.pop();\n+\t\t\treturn this._positionWorklet;\n \t\t}\n+\t\tthis._positionWorklet = new AudioWorkletNode(\n+\t\t\tGodotAudio.ctx,\n+\t\t\t'godot-position-reporting-processor'\n+\t\t);\n \t\tthis._positionWorklet.port.onmessage = (event) => {\n \t\t\tswitch (event.data['type']) {\n \t\t\tcase 'position':\n@@ -652,6 +648,7 @@ class SampleNode {\n \t\t\t\t// Do nothing.\n \t\t\t}\n \t\t};\n+\t\treturn this._positionWorklet;\n \t}\n \n \t/**\n@@ -681,8 +678,7 @@ class SampleNode {\n \t\tif (this._positionWorklet) {\n \t\t\tthis._positionWorklet.disconnect();\n \t\t\tthis._positionWorklet.port.onmessage = null;\n-\t\t\tthis._positionWorklet.port.postMessage({ type: 'clear' });\n-\t\t\tGodotAudio.audioPositionWorkletPool.push(this._positionWorklet);\n+\t\t\tthis._positionWorklet.port.postMessage({ type: 'ended' });\n \t\t\tthis._positionWorklet = null;\n \t\t}\n \n@@ -1199,7 +1195,6 @@ const _GodotAudio = {\n \n \t\t/** @type {Promise} */\n \t\taudioPositionWorkletPromise: null,\n-\t\taudioPositionWorkletPool: [],\n \n \t\t/**\n \t\t * Converts linear volume to Db.\n", "instance_id": "godotengine__godot-102715", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: increasing CPU usage over time in a web export of a game when playing multiple audio samples, leading to audio crackling. It provides specific details such as the tested version of Godot, system information, steps to reproduce, and even a minimal reproduction project (MRP). This makes the issue reproducible and understandable. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should CPU usage return to baseline after audio samples finish playing?) or constraints (e.g., acceptable CPU usage thresholds). Additionally, edge cases or specific conditions under which the issue is more pronounced (e.g., specific audio formats, sample lengths, or browser configurations beyond Chrome/Firefox) are not mentioned. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes involves modifications across two files in the Godot engine's web platform audio subsystem (`audio.position.worklet.js` and `library_godot_audio.js`), indicating a need to understand interactions between audio processing components. The changes, while not extensive in terms of lines of code, impact critical functionality related to audio worklet management and resource cleanup, which can affect the system's performance and stability. Second, the technical concepts required include familiarity with Web Audio API, AudioWorkletProcessor, and JavaScript's event messaging system, as well as an understanding of resource pooling (which is being removed in the changes) and its implications on performance. These are moderately advanced concepts, especially in the context of real-time audio processing in a browser environment. Third, the problem inherently deals with performance optimization (CPU usage over time), which often involves subtle bugs and requires careful consideration of resource lifecycle management (e.g., properly terminating audio worklets to prevent leaks). While the code changes provided address the issue by removing a pooling mechanism and adding an explicit \"ended\" state to stop processing, understanding why this fixes the issue and ensuring it doesn't introduce regressions requires a deep dive into the audio processing pipeline. Edge cases, such as handling multiple simultaneous audio samples or browser-specific behaviors, are not explicitly mentioned but are implied given the nature of the issue, adding to the complexity. Overall, this problem requires a solid understanding of the codebase and careful handling of performance-critical components, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "'@icon' not inheriting\n### Tested versions\n\nv4.4.beta3.official [06acfccf8] - issue is present\nv4.4.beta2.official [a013481b0] - issue is NOT present. This is a recent issue.\n\n### System information\n\nGodot v4.4.beta3 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.11027.2001) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nA script of mine uses `@icon(\"res://editor/icons/base_scene.svg\")` to give it a custom icon in the editor. There are other scripts which `extend` this script, which, previously, also showed this icon, without needing to specify it themselves in every script file.\n\nThis is no longer the case, with the child scripts now using the default icon.\n\n![Image](https://github.com/user-attachments/assets/db535219-b27a-47db-9b84-0ccf7acdcd9a)\n(`base_scene` is a `BaseScene` script, showing the icon correctly. `factory_spawn` is a `BaseFactoryScene` script, which `extends BaseScene`, yet it does NOT show the icon correctly)\n\n### Steps to reproduce\n\n1. Set a custom `@icon` on a class.\n2. Extend that class.\n3. Note that the extended class ignores the icon.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex f31e6aba4169..8135a9b96644 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -1023,7 +1023,7 @@ String EditorData::script_class_get_icon_path(const String &p_class, bool *r_val\n \t\t\treturn String();\n \t\t}\n \t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n-\t\tif ((bool)E) {\n+\t\tif ((bool)E && !E->value.is_empty()) {\n \t\t\tif (r_valid) {\n \t\t\t\t*r_valid = true;\n \t\t\t}\n", "instance_id": "godotengine__godot-102572", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a custom icon set via `@icon` in a base script is not being inherited by child scripts that extend it, which is a regression from a previous version. The description includes the affected and unaffected versions, system information, steps to reproduce, and a visual example to illustrate the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether this behavior is expected or a bug (though it implies a bug due to the regression). Additionally, there are no details about potential edge cases (e.g., specific script structures or icon file formats that might affect the behavior) or constraints on the solution. While a minimal reproduction project (MRP) is marked as \"N/A,\" providing one could have further clarified the issue. Overall, the statement is valid and clear but lacks some minor details for full comprehensiveness.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). The code change provided is minimal, involving a single line modification in `editor_data.cpp` to add a condition (`!E->value.is_empty()`) to ensure that an icon path is only considered valid if it is non-empty. This suggests the issue is a simple bug fix related to how icon paths are handled in the editor data. The scope of the change is limited to a single file and a specific function, with no apparent impact on the broader system architecture or interactions between modules. The technical concepts involved are straightforward, requiring only basic understanding of C++ (specifically, conditional logic and string handling) and familiarity with the Godot engine's editor data structure. There are no complex algorithms, design patterns, or domain-specific knowledge required beyond what a typical contributor to the Godot engine would already know. Edge cases and error handling do not appear to be significant concerns based on the problem statement or the code change, as the fix is narrowly focused on a specific condition check. Overall, this is a simple bug fix that requires minimal effort and understanding to implement and verify.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Inspector size wrong after switching between scenes\n### Tested versions\n\nGodot 4.4.beta2\n\nNot happening in 4.4.dev4\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\nIf you scroll down in the inspector and then switch to another scene and back the inspector will not have correct size and scrollbar anymore. \n\nhttps://github.com/user-attachments/assets/07da0f72-224b-4f67-a022-2e9f4b4ee85b\n\nyou can also see in the video that the scrollbar is wrongly shown in the inspector of the other scene.\n\n### Steps to reproduce\n\n^\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex b79d1243ba6c..97335821374e 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4138,7 +4138,8 @@ void EditorInspector::expand_revertable() {\n }\n \n void EditorInspector::set_scroll_offset(int p_offset) {\n-\tset_v_scroll(p_offset);\n+\t// This can be called before the container finishes sorting its children, so defer it.\n+\tcallable_mp((ScrollContainer *)this, &ScrollContainer::set_v_scroll).call_deferred(p_offset);\n }\n \n int EditorInspector::get_scroll_offset() const {\n", "instance_id": "godotengine__godot-102379", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inspector's size and scrollbar behave incorrectly after switching between scenes in Godot 4.4.beta2. It provides context about the tested versions, system information, and a visual reference (video attachment) to illustrate the bug. However, there are minor ambiguities and missing details. For instance, the \"Steps to reproduce\" section is not explicitly detailed (it just references the video with a caret symbol \"^\"), which could make it harder for someone without access to the video to replicate the issue. Additionally, there are no explicit mentions of expected behavior or specific constraints (e.g., does this happen only under certain conditions or UI configurations?). While the issue is understandable, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, confined to a single line in a single file (`editor_inspector.cpp`). It replaces a direct call to `set_v_scroll()` with a deferred call using `callable_mp` and `call_deferred`. This suggests the fix is localized and does not impact the broader architecture or multiple modules. The change does not require extensive understanding of the entire codebase, only the specific behavior of the `EditorInspector` class and its scroll handling.\n\n2. **Technical Concepts Involved**: The solution requires understanding of Godot's internal API, specifically the `call_deferred` mechanism, which is used to delay execution of a method until a safe time (likely after the container finishes sorting its children, as noted in the comment). This is a moderately advanced concept in Godot but not overly complex for someone familiar with event-driven or deferred execution patterns. No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's editor UI system are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases or error conditions beyond the general issue of incorrect inspector sizing and scrollbar behavior. The code change itself does not introduce new error handling logic; it simply adjusts the timing of an existing operation to prevent a UI glitch. The complexity of edge cases appears minimal based on the provided information.\n\n4. **Overall Complexity**: The fix is straightforward, addressing a timing issue in the UI rendering or update cycle. It does not require deep architectural changes, performance optimizations, or extensive debugging of complex interactions. The comment in the code change (\"This can be called before the container finishes sorting its children, so defer it\") indicates a clear understanding of the root cause, further reducing the difficulty of implementing or verifying the solution.\n\nGiven these points, a difficulty score of 0.30 reflects an easy problem that requires some understanding of Godot's internals and a simple, targeted code modification. It is not a trivial typo fix (which would be closer to 0.0-0.2), but it also does not approach the complexity of medium or hard problems involving multiple files or intricate logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Potential problem in look_at()\n### Godot version\n\n3.3.2.stable.official\n\n### System information\n\nmacOS 11.3.1 GLES3\n\n### Issue description\n\nWhen using the `look_at()` function in a script attached to a camera, there seems to be some sort of discretization effect occurring in my tests; for a camera positioned at e.g. `(0,90,0)` looking towards `(0,0,0)`, I see rendering artifacts. These artifacts persist for a small region around `(0,0,0)` on the `x,z` plane (approx. +/- 0.1 units).\r\n\r\nThis effect is particularly jarring when it manifests as part of an animated movement, producing an effect almost like a magnet snapping the camera view direction onto the target location at `(0,0,0)`.\r\n\r\nI've attached an example project to demonstrate this effect; a camera is located at `(0,90,0)` above a simple plane, and the `look_at()` method is invoked in the camera's `_process()` method. The target position is slowly moved left and right via a `sin()` function, and the effect is visible when the camera looks in the vicinity of `(0,0,0)`.\r\n\r\nAm I missing something important, here?\n\n### Steps to reproduce\n\nSee issue description, and attached project file.\n\n### Minimal reproduction project\n\n[Weird.zip](https://github.com/godotengine/godot/files/6697007/Weird.zip)\r\n\n", "patch": "diff --git a/core/math/basis.cpp b/core/math/basis.cpp\nindex e5f3431eef84..18959f3c0162 100644\n--- a/core/math/basis.cpp\n+++ b/core/math/basis.cpp\n@@ -455,6 +455,11 @@ void Basis::get_rotation_axis_angle_local(Vector3 &p_axis, real_t &p_angle) cons\n }\n \n Vector3 Basis::get_euler(EulerOrder p_order) const {\n+\t// This epsilon value results in angles within a +/- 0.04 degree range being simplified/truncated.\n+\t// Based on testing, this is the largest the epsilon can be without the angle truncation becoming\n+\t// visually noticeable.\n+\tconst real_t epsilon = 0.00000025;\n+\n \tswitch (p_order) {\n \t\tcase EulerOrder::XYZ: {\n \t\t\t// Euler angles in XYZ convention.\n@@ -466,8 +471,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[0][2];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\t// is this a pure Y rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[1][2] == 0 && rows[2][1] == 0 && rows[1][1] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -501,8 +506,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[0][1];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(rows[0][2], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(-sz);\n@@ -532,8 +537,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\treal_t m12 = rows[1][2];\n \n-\t\t\tif (m12 < (1 - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (m12 > -(1 - (real_t)CMP_EPSILON)) {\n+\t\t\tif (m12 < (1 - epsilon)) {\n+\t\t\t\tif (m12 > -(1 - epsilon)) {\n \t\t\t\t\t// is this a pure X rotation?\n \t\t\t\t\tif (rows[1][0] == 0 && rows[0][1] == 0 && rows[0][2] == 0 && rows[2][0] == 0 && rows[0][0] == 1) {\n \t\t\t\t\t\t// return the simplest form (human friendlier in editor and scripts)\n@@ -568,8 +573,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \n \t\t\tVector3 euler;\n \t\t\treal_t sz = rows[1][0];\n-\t\t\tif (sz < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sz > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sz < (1.0f - epsilon)) {\n+\t\t\t\tif (sz > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(-rows[1][2], rows[1][1]);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[0][0]);\n \t\t\t\t\teuler.z = Math::asin(sz);\n@@ -596,8 +601,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -cx*sy            sx                    cx*cy\n \t\t\tVector3 euler;\n \t\t\treal_t sx = rows[2][1];\n-\t\t\tif (sx < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sx > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sx < (1.0f - epsilon)) {\n+\t\t\t\tif (sx > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::asin(sx);\n \t\t\t\t\teuler.y = Math::atan2(-rows[2][0], rows[2][2]);\n \t\t\t\t\teuler.z = Math::atan2(-rows[0][1], rows[1][1]);\n@@ -624,8 +629,8 @@ Vector3 Basis::get_euler(EulerOrder p_order) const {\n \t\t\t//        -sy               cy*sx                 cy*cx\n \t\t\tVector3 euler;\n \t\t\treal_t sy = rows[2][0];\n-\t\t\tif (sy < (1.0f - (real_t)CMP_EPSILON)) {\n-\t\t\t\tif (sy > -(1.0f - (real_t)CMP_EPSILON)) {\n+\t\t\tif (sy < (1.0f - epsilon)) {\n+\t\t\t\tif (sy > -(1.0f - epsilon)) {\n \t\t\t\t\teuler.x = Math::atan2(rows[2][1], rows[2][2]);\n \t\t\t\t\teuler.y = Math::asin(-sy);\n \t\t\t\t\teuler.z = Math::atan2(rows[1][0], rows[0][0]);\n", "instance_id": "godotengine__godot-102144", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the `look_at()` function in the Godot engine, specifically highlighting a discretization effect causing rendering artifacts when a camera looks towards certain positions (e.g., near (0,0,0)). The description includes the context of the issue (camera positioning and movement), the environment (Godot version, macOS, GLES3), and steps to reproduce with an attached minimal reproduction project. However, there are minor ambiguities: the exact nature of the \"discretization effect\" and \"rendering artifacts\" is not fully detailed (e.g., visual description or expected vs. actual behavior), and the problem statement does not explicitly define the desired outcome or constraints for a fix. Additionally, edge cases or specific conditions under which the issue occurs are only vaguely mentioned (e.g., \"small region around (0,0,0)\"). Thus, while the issue is valid and mostly clear, it lacks some precision and detail that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is relatively focused, primarily affecting the `get_euler()` method in `basis.cpp`, which is a core math component of the Godot engine. However, the change involves adjusting a critical constant (`epsilon`) that impacts how Euler angles are computed across multiple rotation orders, potentially affecting camera behavior globally. This requires a deep understanding of the codebase's math library and its implications on rendering and camera systems. Second, the technical concepts involved are moderately complex, including 3D mathematics (rotation matrices, Euler angles), floating-point precision issues, and their visual impact on rendering. Third, while the code change itself is small (replacing a constant and updating condition checks), determining the appropriate `epsilon` value (0.00000025) required empirical testing and a nuanced understanding of trade-offs between precision and visual smoothness, as noted in the code comments. Finally, edge cases are implicitly critical here—small deviations near specific points like (0,0,0) cause noticeable artifacts, and the fix must balance avoiding truncation while maintaining stability across various camera positions and movements. This problem does not reach \"Very Hard\" as it does not involve system-wide refactoring or advanced domain-specific knowledge beyond 3D math, but it still demands significant expertise in the Godot engine's internals and careful tuning, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4beta1] Script modification of CanvasTexture doesn't update\n### Tested versions\n\nv4.4.beta1.official [d33da79d3]\n\n### System information\n\nGodot v4.4.beta1 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Mobile) - dedicated AMD Radeon RX 6600 (Advanced Micro Devices, Inc.; 32.0.11027.1003) - AMD Ryzen 5 3600 6-Core Processor (12 threads)\n\n### Issue description\n\nAltering the `.diffuse_texture` of a CanvasTexture at runtime via script causes no visual update. This causes my player character to no longer turn around.\n\n### Steps to reproduce\n\nModify the `.diffuse_texture` of a CanvasTexture via script. It doesn't change visually.\n\n### Minimal reproduction project (MRP)\n\nhttps://github.com/EmilyV99/godot-bug-examples/tree/texture-diffuse-mrp\n\nPressing left/right changes the diffuse texture to face the pressed direction. Nothing happens at all visually.\n", "patch": "diff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\nindex 02e2486fb9c9..de376599de4c 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.cpp\n@@ -2971,8 +2971,23 @@ void RendererCanvasRenderRD::_uniform_set_invalidation_callback(void *p_userdata\n \tstatic_cast<RendererCanvasRenderRD *>(singleton)->rid_set_to_uniform_set.erase(*key);\n }\n \n+void RendererCanvasRenderRD::_canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata) {\n+\tKeyValue<RID, TightLocalVector<RID>> *kv = static_cast<KeyValue<RID, TightLocalVector<RID>> *>(p_userdata);\n+\tRD *rd = RD::get_singleton();\n+\tfor (RID rid : kv->value) {\n+\t\t// the invalidation callback will take care of clearing rid_set_to_uniform_set cache also\n+\t\trd->free(rid);\n+\t}\n+\tkv->value.clear();\n+\tif (p_deleted) {\n+\t\tstatic_cast<RendererCanvasRenderRD *>(singleton)->canvas_texture_to_uniform_set.erase(kv->key);\n+\t}\n+}\n+\n void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasShaderData *p_shader_data, RenderingDevice::FramebufferFormatID p_framebuffer_format, Light *p_lights, Batch const *p_batch, RenderingMethod::RenderInfo *r_render_info) {\n \t{\n+\t\tRendererRD::TextureStorage *ts = RendererRD::TextureStorage::get_singleton();\n+\n \t\tRIDSetKey key(\n \t\t\t\tp_batch->tex_info->state,\n \t\t\t\tstate.canvas_instance_data_buffers[state.current_data_buffer_index].instance_buffers[p_batch->instance_buffer_index]);\n@@ -2992,6 +3007,19 @@ void RendererCanvasRenderRD::_render_batch(RD::DrawListID p_draw_list, CanvasSha\n \t\t\tconst RIDCache::Pair *iter = rid_set_to_uniform_set.insert(key, rid);\n \t\t\tuniform_set = &iter->data;\n \t\t\tRD::get_singleton()->uniform_set_set_invalidation_callback(rid, RendererCanvasRenderRD::_uniform_set_invalidation_callback, (void *)&iter->key);\n+\n+\t\t\t// If this is a CanvasTexture, it must be tracked so that any changes to the diffuse, normal\n+\t\t\t// or specular channels invalidate all associated uniform sets.\n+\t\t\tif (ts->owns_canvas_texture(p_batch->tex_info->state.texture)) {\n+\t\t\t\tKeyValue<RID, TightLocalVector<RID>> *kv = nullptr;\n+\t\t\t\tif (HashMap<RID, TightLocalVector<RID>>::Iterator i = canvas_texture_to_uniform_set.find(p_batch->tex_info->state.texture); i == canvas_texture_to_uniform_set.end()) {\n+\t\t\t\t\tkv = &*canvas_texture_to_uniform_set.insert(p_batch->tex_info->state.texture, { *uniform_set });\n+\t\t\t\t} else {\n+\t\t\t\t\ti->value.push_back(rid);\n+\t\t\t\t\tkv = &*i;\n+\t\t\t\t}\n+\t\t\t\tts->canvas_texture_set_invalidation_callback(p_batch->tex_info->state.texture, RendererCanvasRenderRD::_canvas_texture_invalidation_callback, kv);\n+\t\t\t}\n \t\t}\n \n \t\tif (state.current_batch_uniform_set != *uniform_set) {\ndiff --git a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\nindex 3b071cd804a1..0605b18ba44e 100644\n--- a/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n+++ b/servers/rendering/renderer_rd/renderer_canvas_render_rd.h\n@@ -485,9 +485,14 @@ class RendererCanvasRenderRD : public RendererCanvasRender {\n \n \tstatic void _before_evict(RendererCanvasRenderRD::RIDSetKey &p_key, RID &p_rid);\n \tstatic void _uniform_set_invalidation_callback(void *p_userdata);\n+\tstatic void _canvas_texture_invalidation_callback(bool p_deleted, void *p_userdata);\n \n \ttypedef LRUCache<RIDSetKey, RID, HashableHasher<RIDSetKey>, HashMapComparatorDefault<RIDSetKey>, _before_evict> RIDCache;\n \tRIDCache rid_set_to_uniform_set;\n+\t/// Maps a CanvasTexture to its associated uniform sets, which must\n+\t/// be invalidated when the CanvasTexture is updated, such as changing the\n+\t/// diffuse texture.\n+\tHashMap<RID, TightLocalVector<RID>> canvas_texture_to_uniform_set;\n \n \tstruct Batch {\n \t\t// Position in the UBO measured in bytes\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\nindex a297b9717816..69ae3d971a4e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.cpp\n@@ -43,9 +43,15 @@ using namespace RendererRD;\n void TextureStorage::CanvasTexture::clear_cache() {\n \tinfo_cache[0] = CanvasTextureCache();\n \tinfo_cache[1] = CanvasTextureCache();\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(false, invalidated_callback_userdata);\n+\t}\n }\n \n TextureStorage::CanvasTexture::~CanvasTexture() {\n+\tif (invalidated_callback != nullptr) {\n+\t\tinvalidated_callback(true, invalidated_callback_userdata);\n+\t}\n }\n \n ///////////////////////////////////////////////////////////////////////////\n@@ -735,6 +741,16 @@ TextureStorage::CanvasTextureInfo TextureStorage::canvas_texture_get_info(RID p_\n \treturn res;\n }\n \n+void TextureStorage::canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata) {\n+\tCanvasTexture *ct = canvas_texture_owner.get_or_null(p_canvas_texture);\n+\tif (!ct) {\n+\t\treturn;\n+\t}\n+\n+\tct->invalidated_callback = p_callback;\n+\tct->invalidated_callback_userdata = p_userdata;\n+}\n+\n /* Texture API */\n \n RID TextureStorage::texture_allocate() {\ndiff --git a/servers/rendering/renderer_rd/storage_rd/texture_storage.h b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\nindex bfee1e367e0c..2073c34ded7b 100644\n--- a/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n+++ b/servers/rendering/renderer_rd/storage_rd/texture_storage.h\n@@ -90,6 +90,8 @@ class TextureStorage : public RendererTextureStorage {\n \t\t_FORCE_INLINE_ bool is_null() const { return diffuse.is_null(); }\n \t};\n \n+\ttypedef void (*InvalidationCallback)(bool p_deleted, void *p_userdata);\n+\n private:\n \tfriend class LightStorage;\n \tfriend class MaterialStorage;\n@@ -118,6 +120,9 @@ class TextureStorage : public RendererTextureStorage {\n \t\tRS::CanvasItemTextureRepeat texture_repeat = RS::CANVAS_ITEM_TEXTURE_REPEAT_DEFAULT;\n \t\tCanvasTextureCache info_cache[2];\n \n+\t\tInvalidationCallback invalidated_callback = nullptr;\n+\t\tvoid *invalidated_callback_userdata = nullptr;\n+\n \t\tSize2i size_cache = Size2i(1, 1);\n \t\tbool use_normal_cache = false;\n \t\tbool use_specular_cache = false;\n@@ -499,6 +504,7 @@ class TextureStorage : public RendererTextureStorage {\n \tvirtual void canvas_texture_set_texture_repeat(RID p_item, RS::CanvasItemTextureRepeat p_repeat) override;\n \n \tCanvasTextureInfo canvas_texture_get_info(RID p_texture, RS::CanvasItemTextureFilter p_base_filter, RS::CanvasItemTextureRepeat p_base_repeat, bool p_use_srgb, bool p_texture_is_data);\n+\tvoid canvas_texture_set_invalidation_callback(RID p_canvas_texture, InvalidationCallback p_callback, void *p_userdata);\n \n \t/* Texture API */\n \n", "instance_id": "godotengine__godot-101931", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: modifying the `.diffuse_texture` of a `CanvasTexture` at runtime via script does not result in a visual update in the Godot engine (version 4.4.beta1). The goal is evident—ensure that runtime changes to the texture are reflected visually. The statement includes relevant system information, tested versions, steps to reproduce, and a link to a minimal reproduction project (MRP), which adds to its clarity. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define the expected behavior (e.g., how the visual update should occur or under what conditions), nor does it mention specific constraints or edge cases (e.g., texture size limits, performance implications, or specific rendering pipelines affected). Additionally, the impact on the player character (\"no longer turn around\") is mentioned but not elaborated upon, leaving room for interpretation. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope and depth of code changes are significant, as they involve modifications across multiple files (`renderer_canvas_render_rd.cpp`, `renderer_canvas_render_rd.h`, `texture_storage.cpp`, and `texture_storage.h`) in the Godot engine's rendering subsystem. These changes are not isolated to a single function but require understanding and altering the interaction between texture storage, rendering logic, and uniform set management. The addition of an invalidation callback mechanism for `CanvasTexture` indicates a need to manage resource lifecycle and caching, which impacts the system's architecture to some extent.\n\nSecond, the number of technical concepts involved is substantial. Solving this requires a deep understanding of Godot's rendering pipeline (specifically the Vulkan backend), resource management (RIDs and uniform sets), and callback mechanisms. Familiarity with C++ (including memory management and data structures like `HashMap` and `TightLocalVector`) is essential, as is knowledge of rendering concepts like texture binding and shader uniforms. Additionally, the problem touches on domain-specific knowledge of game engine internals, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes suggest potential complexities in error handling and resource management. For instance, the invalidation callback must handle both texture updates and deletion scenarios, ensuring that uniform sets are properly cleared without memory leaks or dangling references. There may also be implicit edge cases related to concurrent texture modifications or rendering in multi-threaded environments, which are not addressed in the problem statement but are critical in a game engine context.\n\nFinally, the overall complexity is heightened by the need to ensure that these changes do not introduce performance regressions or break existing functionality in a large, complex codebase like Godot. This requires not only implementing the fix but also thoroughly testing it across different rendering backends and use cases. A score of 0.75 reflects the deep understanding of the codebase architecture required, the complexity of the modifications, and the potential for subtle bugs or performance issues, placing it firmly in the \"Hard\" range, though not at the extreme end of \"Very Hard\" since it does not involve entirely new system-level designs or highly intricate algorithms.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "2D Tilemap coordinates disappear when on \"Terrains\" Mode\n### Tested versions\n\nTested Version: v4.3.stable.official [77dcf97d8]\n\n### System information\n\nWindows 10\n\n### Issue description\n\nOn the editor, when using the tilemap in \"Tiles\" mode, you can see your tile coords in the lower left corner. If you switch to \"Terrains\" mode when you no longer see the tilemap coordinates where your cursor is.\n\n![Image](https://github.com/user-attachments/assets/a106c545-8cdb-4533-9145-b19886f177a3)\n\n### Steps to reproduce\n\nCreate a new 2D TilemapLayer. Hover over the field, you can see your coords in the lower left of the game field. Switch to Terrains, coords disappear.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/plugins/tiles/tile_map_layer_editor.cpp b/editor/plugins/tiles/tile_map_layer_editor.cpp\nindex 4f09e738d1c8..33e914e967c7 100644\n--- a/editor/plugins/tiles/tile_map_layer_editor.cpp\n+++ b/editor/plugins/tiles/tile_map_layer_editor.cpp\n@@ -50,6 +50,23 @@ TileMapLayer *TileMapLayerSubEditorPlugin::_get_edited_layer() const {\n \treturn Object::cast_to<TileMapLayer>(ObjectDB::get_instance(edited_tile_map_layer_id));\n }\n \n+void TileMapLayerSubEditorPlugin::draw_tile_coords_over_viewport(Control *p_overlay, const TileMapLayer *p_edited_layer, Ref<TileSet> p_tile_set, bool p_show_rectangle_size, const Vector2i &p_rectangle_origin) {\n+\tPoint2 msgpos = Point2(20 * EDSCALE, p_overlay->get_size().y - 20 * EDSCALE);\n+\tString text = p_tile_set->local_to_map(p_edited_layer->get_local_mouse_position());\n+\n+\tif (p_show_rectangle_size) {\n+\t\tVector2i rect_size = p_tile_set->local_to_map(p_edited_layer->get_local_mouse_position()) - p_tile_set->local_to_map(p_rectangle_origin);\n+\t\ttext += vformat(\" %s (%dx%d)\", TTR(\"Drawing Rect:\"), Math::abs(rect_size.x) + 1, Math::abs(rect_size.y) + 1);\n+\t}\n+\n+\tRef<Font> font = p_overlay->get_theme_font(SceneStringName(font), SNAME(\"Label\"));\n+\tint font_size = p_overlay->get_theme_font_size(SceneStringName(font_size), SNAME(\"Label\"));\n+\n+\tp_overlay->draw_string(font, msgpos + Point2(1, 1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n+\tp_overlay->draw_string(font, msgpos + Point2(-1, -1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n+\tp_overlay->draw_string(font, msgpos, text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(1, 1, 1, 1));\n+}\n+\n void TileMapLayerEditorTilesPlugin::tile_set_changed() {\n \t_update_fix_selected_and_hovered();\n \t_update_tile_set_sources_list();\n@@ -66,7 +83,7 @@ void TileMapLayerEditorTilesPlugin::_on_scattering_spinbox_changed(double p_valu\n }\n \n void TileMapLayerEditorTilesPlugin::_update_toolbar() {\n-\t// Stop draggig if needed.\n+\t// Stop dragging if needed.\n \t_stop_dragging();\n \n \t// Hide all settings.\n@@ -783,7 +800,7 @@ bool TileMapLayerEditorTilesPlugin::forward_canvas_gui_input(const Ref<InputEven\n }\n \n void TileMapLayerEditorTilesPlugin::forward_canvas_draw_over_viewport(Control *p_overlay) {\n-\tTileMapLayer *edited_layer = _get_edited_layer();\n+\tconst TileMapLayer *edited_layer = _get_edited_layer();\n \tif (!edited_layer) {\n \t\treturn;\n \t}\n@@ -1000,19 +1017,7 @@ void TileMapLayerEditorTilesPlugin::forward_canvas_draw_over_viewport(Control *p\n \t\t\t}\n \t\t}\n \n-\t\tRef<Font> font = p_overlay->get_theme_font(SceneStringName(font), SNAME(\"Label\"));\n-\t\tint font_size = p_overlay->get_theme_font_size(SceneStringName(font_size), SNAME(\"Label\"));\n-\t\tPoint2 msgpos = Point2(20 * EDSCALE, p_overlay->get_size().y - 20 * EDSCALE);\n-\n-\t\tString text = tile_set->local_to_map(edited_layer->get_local_mouse_position());\n-\t\tif (drawing_rect) {\n-\t\t\tVector2i size = tile_set->local_to_map(edited_layer->get_local_mouse_position()) - tile_set->local_to_map(drag_start_mouse_pos);\n-\t\t\ttext += vformat(\" %s (%dx%d)\", TTR(\"Drawing Rect:\"), Math::abs(size.x) + 1, Math::abs(size.y) + 1);\n-\t\t}\n-\n-\t\tp_overlay->draw_string(font, msgpos + Point2(1, 1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n-\t\tp_overlay->draw_string(font, msgpos + Point2(-1, -1), text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(0, 0, 0, 0.8));\n-\t\tp_overlay->draw_string(font, msgpos, text, HORIZONTAL_ALIGNMENT_LEFT, -1, font_size, Color(1, 1, 1, 1));\n+\t\tdraw_tile_coords_over_viewport(p_overlay, edited_layer, tile_set, drawing_rect, drag_start_mouse_pos);\n \t}\n }\n \n@@ -3168,6 +3173,7 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \tTransform2D xform = CanvasItemEditor::get_singleton()->get_canvas_transform() * edited_layer->get_global_transform_with_canvas();\n \tVector2 mpos = edited_layer->get_local_mouse_position();\n \tVector2i tile_shape_size = tile_set->get_tile_size();\n+\tbool drawing_rect = false;\n \n \t// Handle the preview of the tiles to be placed.\n \tif (main_vbox_container->is_visible_in_tree() && has_mouse) { // Only if the tilemap editor is opened and the viewport is hovered.\n@@ -3214,6 +3220,8 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \t\t\t\t\t\tpreview.insert(Vector2i(x, y));\n \t\t\t\t\t}\n \t\t\t\t}\n+\n+\t\t\t\tdrawing_rect = !preview.is_empty();\n \t\t\t\texpand_grid = true;\n \t\t\t} else if (tool_buttons_group->get_pressed_button() == bucket_tool_button && drag_type == DRAG_TYPE_NONE) {\n \t\t\t\t// Preview for a fill.\n@@ -3272,6 +3280,8 @@ void TileMapLayerEditorTerrainsPlugin::forward_canvas_draw_over_viewport(Control\n \t\t\t\t}\n \t\t\t}\n \t\t}\n+\n+\t\tdraw_tile_coords_over_viewport(p_overlay, edited_layer, tile_set, drawing_rect, drag_start_mouse_pos);\n \t}\n }\n \ndiff --git a/editor/plugins/tiles/tile_map_layer_editor.h b/editor/plugins/tiles/tile_map_layer_editor.h\nindex aa19ead81b32..1abc6890cb08 100644\n--- a/editor/plugins/tiles/tile_map_layer_editor.h\n+++ b/editor/plugins/tiles/tile_map_layer_editor.h\n@@ -67,6 +67,7 @@ class TileMapLayerSubEditorPlugin : public Object {\n \tvirtual void forward_canvas_draw_over_viewport(Control *p_overlay) {}\n \tvirtual void tile_set_changed() {}\n \tvirtual void edit(ObjectID p_tile_map_layer_id) {}\n+\tvirtual void draw_tile_coords_over_viewport(Control *p_overlay, const TileMapLayer *p_edited_layer, Ref<TileSet> p_tile_set, bool p_show_rectangle_size, const Vector2i &p_rectangle_origin);\n };\n \n class TileMapLayerEditorTilesPlugin : public TileMapLayerSubEditorPlugin {\n", "instance_id": "godotengine__godot-101737", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the tile coordinates disappear in the editor when switching from \"Tiles\" mode to \"Terrains\" mode in a 2D TilemapLayer. It provides steps to reproduce the issue, specifies the tested version, and includes a visual reference (an image). However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (coordinates should remain visible in \"Terrains\" mode) but not explicitly stated. Additionally, there are no mentions of specific edge cases, performance requirements, or constraints that might affect the solution. While the issue is understandable, the lack of explicit expected behavior and edge case details prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, primarily affecting a single file (`tile_map_layer_editor.cpp`) with minor updates to the header file (`tile_map_layer_editor.h`). The changes involve refactoring existing code to create a reusable function (`draw_tile_coords_over_viewport`) and applying it to both \"Tiles\" and \"Terrains\" modes. The modifications do not impact the broader system architecture and are limited to UI rendering logic in the editor plugin. The amount of code change is moderate, with around 30-40 lines added or modified.\n\n2. **Clarity and Complexity of Problem Description**: As noted in the clarity score, the problem is mostly clear, requiring a straightforward fix to ensure coordinates are displayed in \"Terrains\" mode. The logic to solve this is not inherently complex, as it involves reusing existing rendering code.\n\n3. **Number of Technical Concepts**: Solving this requires understanding C++ (specifically in the context of the Godot engine), basic UI rendering (drawing text over a viewport), and familiarity with the editor plugin structure in Godot. These concepts are not particularly advanced for someone with experience in game engine development or C++. No complex algorithms, design patterns, or domain-specific knowledge beyond Godot's tilemap system are needed.\n\n4. **Edge Cases and Error Handling**: The problem statement does not mention specific edge cases, and the code changes do not introduce new error handling logic. The fix appears to handle the primary use case (displaying coordinates) without addressing potential issues like performance in large tilemaps, UI overlap, or localization of text. The simplicity of edge cases (or lack thereof) keeps the difficulty low.\n\nOverall, this task requires understanding some code logic and making simple modifications to ensure consistent behavior across modes. It does not involve deep architectural changes or complex technical challenges, justifying a score of 0.35. It is slightly above the lower end of the \"Easy\" range due to the need to understand Godot's editor plugin system and coordinate mapping logic, which might be non-trivial for a complete beginner but straightforward for an experienced developer.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Web] Cannot remove files with `DirAccess.remove_absolute`\n### Tested versions\n\nReproducible: 4.4.dev5 and 4.4dev6\n\n### System information\n\nGodot v4.4.dev6 - Windows 10.0.22631 - Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 3060 Laptop GPU (NVIDIA; 32.0.15.6603) - 12th Gen Intel(R) Core(TM) i5-12500H (16 threads)\n\n### Issue description\n\n\nOn the exported project, I am creating a file in `user://` folder, then letting users remove it. `DirAccess.remove_absolute(filepath)` returns 0 (successful), but after restarting the scene Ctrl + Refresh, the file is seen there again. \n\n\n### Steps to reproduce\n\nList folders in `user://`, if empty create a file there.\n\nDelete using `DirAccess.remove_absolute(\"user://filename\")`.\nRestart the game via refresh button on the browser.\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 File stored at: user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 [\"text.txt\"]\ntest.js:459 Deleting: user://text.txt\ntest.js:459 Deleted user://text.txt\ntest.js:459 Listing folder: user://\ntest.js:459 []\n```\nAfter refreshing,\n\n```\nListing folder: user://\ntest.js:459 [\"text.txt\"]`\n```\n\nThe `text.txt` is still there.\n\n### Minimal reproduction project (MRP)\n\n[testbug.zip](https://github.com/user-attachments/files/18067479/testbug.zip)\n\nExport as web and launch it. Check the Dev Console.\n", "patch": "diff --git a/drivers/unix/dir_access_unix.cpp b/drivers/unix/dir_access_unix.cpp\nindex 816ffd7a322f..6d3e4c7dbf19 100644\n--- a/drivers/unix/dir_access_unix.cpp\n+++ b/drivers/unix/dir_access_unix.cpp\n@@ -438,11 +438,19 @@ Error DirAccessUnix::remove(String p_path) {\n \t\treturn FAILED;\n \t}\n \n+\tint err;\n \tif (S_ISDIR(flags.st_mode) && !is_link(p_path)) {\n-\t\treturn ::rmdir(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::rmdir(p_path.utf8().get_data());\n \t} else {\n-\t\treturn ::unlink(p_path.utf8().get_data()) == 0 ? OK : FAILED;\n+\t\terr = ::unlink(p_path.utf8().get_data());\n \t}\n+\tif (err != 0) {\n+\t\treturn FAILED;\n+\t}\n+\tif (remove_notification_func != nullptr) {\n+\t\tremove_notification_func(p_path);\n+\t}\n+\treturn OK;\n }\n \n bool DirAccessUnix::is_link(String p_file) {\n@@ -552,6 +560,8 @@ DirAccessUnix::DirAccessUnix() {\n \tchange_dir(current_dir);\n }\n \n+DirAccessUnix::RemoveNotificationFunc DirAccessUnix::remove_notification_func = nullptr;\n+\n DirAccessUnix::~DirAccessUnix() {\n \tlist_dir_end();\n }\ndiff --git a/drivers/unix/dir_access_unix.h b/drivers/unix/dir_access_unix.h\nindex 8d13ff1fa88d..adf1fa80e7be 100644\n--- a/drivers/unix/dir_access_unix.h\n+++ b/drivers/unix/dir_access_unix.h\n@@ -52,6 +52,9 @@ class DirAccessUnix : public DirAccess {\n \tvirtual bool is_hidden(const String &p_name);\n \n public:\n+\ttypedef void (*RemoveNotificationFunc)(const String &p_file);\n+\tstatic RemoveNotificationFunc remove_notification_func;\n+\n \tvirtual Error list_dir_begin() override; ///< This starts dir listing\n \tvirtual String get_next() override;\n \tvirtual bool current_is_dir() const override;\ndiff --git a/drivers/unix/file_access_unix.cpp b/drivers/unix/file_access_unix.cpp\nindex f2e4b3966be8..048d42529029 100644\n--- a/drivers/unix/file_access_unix.cpp\n+++ b/drivers/unix/file_access_unix.cpp\n@@ -443,7 +443,7 @@ void FileAccessUnix::close() {\n \t_close();\n }\n \n-CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n+FileAccessUnix::CloseNotificationFunc FileAccessUnix::close_notification_func = nullptr;\n \n FileAccessUnix::~FileAccessUnix() {\n \t_close();\ndiff --git a/drivers/unix/file_access_unix.h b/drivers/unix/file_access_unix.h\nindex 66e4bccc2525..fb9d684714c3 100644\n--- a/drivers/unix/file_access_unix.h\n+++ b/drivers/unix/file_access_unix.h\n@@ -38,8 +38,6 @@\n \n #if defined(UNIX_ENABLED)\n \n-typedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n-\n class FileAccessUnix : public FileAccess {\n \tFILE *f = nullptr;\n \tint flags = 0;\n@@ -56,6 +54,7 @@ class FileAccessUnix : public FileAccess {\n #endif\n \n public:\n+\ttypedef void (*CloseNotificationFunc)(const String &p_file, int p_flags);\n \tstatic CloseNotificationFunc close_notification_func;\n \n \tvirtual Error open_internal(const String &p_path, int p_mode_flags) override; ///< open a file\ndiff --git a/platform/web/os_web.cpp b/platform/web/os_web.cpp\nindex 51facbaa845d..8f59c8ad668c 100644\n--- a/platform/web/os_web.cpp\n+++ b/platform/web/os_web.cpp\n@@ -224,6 +224,18 @@ void OS_Web::file_access_close_callback(const String &p_file, int p_flags) {\n \t}\n }\n \n+void OS_Web::dir_access_remove_callback(const String &p_file) {\n+\tOS_Web *os = OS_Web::get_singleton();\n+\tbool is_file_persistent = p_file.begins_with(\"/userfs\");\n+#ifdef TOOLS_ENABLED\n+\t// Hack for editor persistence (can we track).\n+\tis_file_persistent = is_file_persistent || p_file.begins_with(\"/home/web_user/\");\n+#endif\n+\tif (is_file_persistent) {\n+\t\tos->idb_needs_sync = true;\n+\t}\n+}\n+\n void OS_Web::update_pwa_state_callback() {\n \tif (OS_Web::get_singleton()) {\n \t\tOS_Web::get_singleton()->pwa_is_waiting = true;\n@@ -287,4 +299,5 @@ OS_Web::OS_Web() {\n \t_set_logger(memnew(CompositeLogger(loggers)));\n \n \tFileAccessUnix::close_notification_func = file_access_close_callback;\n+\tDirAccessUnix::remove_notification_func = dir_access_remove_callback;\n }\ndiff --git a/platform/web/os_web.h b/platform/web/os_web.h\nindex 1ddb745965ac..8965cc4424b7 100644\n--- a/platform/web/os_web.h\n+++ b/platform/web/os_web.h\n@@ -53,6 +53,7 @@ class OS_Web : public OS_Unix {\n \tWASM_EXPORT static void main_loop_callback();\n \n \tWASM_EXPORT static void file_access_close_callback(const String &p_file, int p_flags);\n+\tWASM_EXPORT static void dir_access_remove_callback(const String &p_file);\n \tWASM_EXPORT static void fs_sync_callback();\n \tWASM_EXPORT static void update_pwa_state_callback();\n \n", "instance_id": "godotengine__godot-100221", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: files created in the `user://` folder on a web-exported Godot project are not being removed permanently when using `DirAccess.remove_absolute()`, as they reappear after a scene refresh. The steps to reproduce are provided, along with logs that demonstrate the issue, and a minimal reproduction project is attached. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss potential causes (e.g., browser persistence or file system syncing issues on the web platform), nor does it mention specific edge cases like file permissions or concurrent access. Additionally, the expected behavior after removal (e.g., whether the file should be removed from persistent storage or just temporarily) is implied but not explicitly stated. These minor gaps prevent it from being fully comprehensive, but the overall intent and issue are clear enough to work on.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`dir_access_unix.cpp`, `dir_access_unix.h`, `file_access_unix.cpp`, `file_access_unix.h`, `os_web.cpp`, and `os_web.h`) and involves platform-specific logic for web exports in the Godot engine, requiring a good understanding of how file system operations are handled in a browser environment (e.g., IndexedDB persistence). Second, the technical concepts involved include Unix file system operations (`unlink`, `rmdir`), callback mechanisms for notifications, and platform-specific behavior on the web (e.g., syncing with persistent storage). Third, the changes impact the interaction between the core engine's file system abstraction and the web platform's implementation, which requires understanding the broader architecture of Godot's OS and file access layers. While the actual lines of code changed are relatively few, the addition of a notification callback for file removal and the logic to flag sync needs (`idb_needs_sync`) introduce subtle complexity, especially in ensuring correctness across different environments (e.g., editor vs. exported builds). Edge cases, such as handling files in different storage scopes (`/userfs` vs. `/home/web_user/`), are partially addressed in the code but add to the problem's depth. Overall, solving this requires a deep understanding of Godot's internals and web platform constraints, justifying a score of 0.65, leaning towards the harder side of the spectrum.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "cmake: incorrectly reporting MSVC as using ccache\nMentioned by @stickies-v. The CMake configure currently outputs that MSVC builds are using ccache, i.e (https://github.com/bitcoin/bitcoin/actions/runs/13063954360/job/36452895056#step:8:2374):\n```bash\nTreat compiler warnings as errors ..... ON\nUse ccache for compiling .............. ON\n```\n\nHowever that's a bug, as MSVC is currently excluded entirely from using ccache: \nhttps://github.com/bitcoin/bitcoin/blob/8fa10edcd1706a1f0dc9d8c3adbc8efa3c7755bf/cmake/ccache.cmake#L4-L6\n", "patch": "diff --git a/cmake/ccache.cmake b/cmake/ccache.cmake\nindex d1cc204c8e463..0bfd3a41f62db 100644\n--- a/cmake/ccache.cmake\n+++ b/cmake/ccache.cmake\n@@ -23,6 +23,8 @@ if(NOT MSVC)\n   else()\n     set(WITH_CCACHE OFF)\n   endif()\n+else()\n+  set(WITH_CCACHE OFF)\n endif()\n \n mark_as_advanced(CCACHE_EXECUTABLE)\n", "instance_id": "bitcoin__bitcoin-31983", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: CMake incorrectly reports that MSVC builds are using ccache, despite MSVC being explicitly excluded from ccache usage in the codebase. The goal of fixing this misreporting is evident, and references to specific lines of code and build logs help contextualize the problem. However, the statement lacks explicit mention of the expected output or behavior after the fix (e.g., should the CMake output explicitly state \"Use ccache for compiling .............. OFF\" for MSVC?). Additionally, there are minor ambiguities regarding whether this issue affects functionality or is purely a reporting bug, and no edge cases or constraints are discussed. Overall, the problem is valid and mostly clear, but minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward fix to ensure that the ccache usage flag (WITH_CCACHE) is correctly set to OFF for MSVC builds. The code change is minimal, confined to a single file (cmake/ccache.cmake), and involves adding just a couple of lines to handle the MSVC case explicitly. The scope of the change is small, with no impact on the broader system architecture or interactions between modules. The technical concepts required are basic—understanding CMake conditional logic and variable setting—which are fundamental for anyone familiar with build systems. There are no complex edge cases or error handling requirements mentioned in the problem statement or evident in the code change. This task aligns with a very easy problem, requiring only basic code modification, thus warranting a difficulty score of 0.15 (Very Easy).", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "build: depends cross-compile using Clang fails\nSeems like CMake is getting confused, and trying to build and link a `x86_64` binary, when it's meant to be (and thinks it is, according to the  configure output) building for `aarch64`:\n```bash\nmake -C depends/ CC=clang CXX=clang++ AR=llvm-ar NM=llvm-nm RANLIB=llvm-ranlib STRIP=llvm-strip NO_QT=1 NO_WALLET=1 NO_USDT=1 NO_ZMQ=1 -j18 HOST=aarch64-linux-gnu\n<snip>\ncopying packages: boost libevent\nto: /root/ci_scratch/depends/aarch64-linux-gnu\nTo build Bitcoin Core with these packages, pass '--toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake' to the first CMake invocation.\n\ncmake -B build --toolchain /root/ci_scratch/depends/aarch64-linux-gnu/toolchain.cmake\n<snip>\nCross compiling ....................... TRUE, for Linux, aarch64\nC++ compiler .......................... Clang 18.1.3, /usr/bin/clang++\n<snip>\ncmake --build build -j18 --target bitcoind --verbose\n[ 98%] Linking CXX executable bitcoind\ncd /root/ci_scratch/build/src && /usr/bin/cmake -E cmake_link_script CMakeFiles/bitcoind.dir/link.txt --verbose=1\n/usr/bin/clang++ -pipe -std=c++20 -O2 -O2 -g -fstack-protector-all -fcf-protection=full -fstack-clash-protection -Wl,-z,relro -Wl,-z,now -Wl,-z,separate-code -fPIE -pie CMakeFiles/bitcoind.dir/bitcoind.cpp.o CMakeFiles/bitcoind.dir/init/bitcoind.cpp.o -o bitcoind  libbitcoin_node.a libbitcoin_common.a libbitcoin_consensus.a secp256k1/lib/libsecp256k1.a util/libbitcoin_util.a crypto/libbitcoin_crypto.a crypto/libbitcoin_crypto_sse41.a crypto/libbitcoin_crypto_avx2.a crypto/libbitcoin_crypto_x86_shani.a ../libleveldb.a ../libcrc32c.a ../libcrc32c_sse42.a ../libminisketch.a univalue/libunivalue.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_pthreads.a /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_core.a  \n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a(http.c.o): Relocations in generic ELF (EM: 183)\n/usr/bin/ld: /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a: error adding symbols: file in wrong format\nclang++: error: linker command failed with exit code 1 (use -v to see invocation)\ngmake[3]: *** [src/CMakeFiles/bitcoind.dir/build.make:130: src/bitcoind] Error 1\n```\nMaybe there's something missing from the toolchain that we should be passing through. The libs in depends have been compiled for aarch64, i.e:\n```bash\nobjdump -x /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a | grep aarch64\nIn archive /root/ci_scratch/depends/aarch64-linux-gnu/lib/libevent_extra.a:\nevent_tagging.c.o:     file format elf64-littleaarch64\narchitecture: aarch64, flags 0x00000011:\nhttp.c.o:     file format elf64-littleaarch64\n```\n\nHowever CMake is building x86_64 object files:\n```bash\nfile build/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o\nbuild/CMakeFiles/leveldb.dir/src/leveldb/db/filename.cc.o: ELF 64-bit LSB relocatable, x86-64, version 1 (SYSV), with debug_info, not stripped\n```\nand binaries:\n```bash\nfile build/src/bitcoin-util \nbuild/src/bitcoin-util: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4ccab1d492154df5dd9a115e6bbc52371d7439b1, for GNU/Linux 3.2.0, with debug_info, not stripped\n```\n", "patch": "diff --git a/depends/Makefile b/depends/Makefile\nindex 2841d50ae4a84..f03db29eb3069 100644\n--- a/depends/Makefile\n+++ b/depends/Makefile\n@@ -203,6 +203,7 @@ endif\n $(host_prefix)/toolchain.cmake : toolchain.cmake.in $(host_prefix)/.stamp_$(final_build_id)\n \t@mkdir -p $(@D)\n \tsed -e 's|@depends_crosscompiling@|$(crosscompiling)|' \\\n+            -e 's|@host@|$(host)|' \\\n             -e 's|@host_system_name@|$($(host_os)_cmake_system_name)|' \\\n             -e 's|@host_system_version@|$($(host_os)_cmake_system_version)|' \\\n             -e 's|@host_arch@|$(host_arch)|' \\\ndiff --git a/depends/toolchain.cmake.in b/depends/toolchain.cmake.in\nindex ac24f74ad4f71..28188f6347cfd 100644\n--- a/depends/toolchain.cmake.in\n+++ b/depends/toolchain.cmake.in\n@@ -13,6 +13,10 @@ if(@depends_crosscompiling@)\n   set(CMAKE_SYSTEM_NAME @host_system_name@)\n   set(CMAKE_SYSTEM_VERSION @host_system_version@)\n   set(CMAKE_SYSTEM_PROCESSOR @host_arch@)\n+\n+  set(CMAKE_C_COMPILER_TARGET @host@)\n+  set(CMAKE_CXX_COMPILER_TARGET @host@)\n+  set(CMAKE_OBJCXX_COMPILER_TARGET @host@)\n endif()\n \n if(NOT DEFINED CMAKE_C_FLAGS_INIT)\n", "instance_id": "bitcoin__bitcoin-31849", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a cross-compilation error when building Bitcoin Core for `aarch64` using Clang and CMake, where the system incorrectly builds `x86_64` binaries despite the configuration indicating `aarch64`. The statement includes detailed logs, build commands, and evidence of the mismatch in architecture (e.g., object file formats). However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior beyond \"building for `aarch64`,\" nor does it clarify the root cause hypothesis beyond \"CMake is getting confused.\" Additionally, there are no mentions of specific constraints or edge cases related to the build environment (e.g., specific Clang or CMake versions, host system details). While the issue is well-documented with logs, the lack of a precise problem definition or potential causes makes it fall short of a comprehensive score. Hence, a score of 2 (Mostly Clear) is appropriate.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors across the evaluation criteria:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively small, confined to two files (`depends/Makefile` and `depends/toolchain.cmake.in`), and involve adding a few lines to pass the host target explicitly to CMake via compiler target variables. However, the impact of these changes is significant as they affect the entire build system configuration for cross-compilation. Understanding the interaction between the `depends` build system, CMake toolchain files, and the overall Bitcoin Core build process is necessary, which implies a broader scope beyond the modified lines.\n\n2. **Number of Technical Concepts**: Solving this requires a deep understanding of multiple complex concepts, including cross-compilation workflows, CMake toolchain configuration, compiler target triples (e.g., `aarch64-linux-gnu`), and how Clang and CMake interact during cross-compilation. Additionally, familiarity with the Bitcoin Core build system (`depends/` directory) and low-level build tools (e.g., `objdump`, `file`) for debugging architecture mismatches is essential. These concepts are advanced and not trivial for an average developer.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of cross-compilation inherently involves potential issues such as mismatched library architectures, host system compatibility, or toolchain-specific quirks (e.g., Clang version differences). The code changes do not directly address error handling, but ensuring the fix works across different environments or build configurations adds implicit complexity. Debugging such issues often requires handling subtle edge cases related to build flags or system settings.\n\n4. **Overall Complexity**: The problem requires a deep understanding of build system internals and cross-compilation, which are niche and challenging areas even for experienced developers. While the code change itself is small, identifying the root cause (CMake not respecting the target architecture) and applying the correct fix (setting `CMAKE_C_COMPILER_TARGET` and related variables) demands significant expertise. The problem also has architectural implications since it affects how the entire project is compiled for different platforms.\n\nGiven these considerations, a difficulty score of 0.65 is assigned. It is not in the \"Very Hard\" range (0.8-1.0) because the solution does not involve extensive code refactoring or advanced algorithmic design, but it is firmly in the \"Hard\" range due to the specialized knowledge and debugging effort required to understand and resolve the cross-compilation mismatch.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "gen-manpages.py should skip nonexistent binaries and still work for the existent binaries\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nBy executing `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py`, if one binary is not found, it will stop the generation of all manpages.\r\n\r\nFor example: Executing gen-manpages.py without bitcoin-qt. The command exits after detecting that bitcoin-qt does not exist, and no manpage is generated, even though only bitcoin-qt is missing.\r\n\r\n```bash\r\n➜  bitcoin git:(master) ✗ BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable\r\n➜  bitcoin git:(master) ✗ \r\n```\r\n\r\nInitially, I thought this behavior was intended, but after investigating the older shell script implementation `gen-manpages.sh`, I realized that’s not the case. `gen-manpages.sh` was able to generate all the manpages and just warned the user about missing binaries.\r\n\r\nExample using the last version of the shell script: https://github.com/bitcoin/bitcoin/blob/a5edd191be93aff8f9c0f60f04e711e2e78ecc77/contrib/devtools/gen-manpages.sh\r\n\r\n```bash\r\n➜  bitcoin git:(master) ✗ BUILDDIR=$PWD/build contrib/devtools/gen-manpages.sh\r\ncontrib/devtools/gen-manpages.sh: line 25: /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt: No such file or directory\r\nhelp2man: can't get `--help' info from /home/andre/repos/bitcoin/build/src/qt/bitcoin-qt\r\nTry `--no-discard-stderr' if option outputs to stderr\r\n➜  bitcoin git:(master) ✗ git status\r\nOn branch master\r\nYour branch is up to date with 'origin/master'.\r\n\r\nChanges not staged for commit:\r\n  (use \"git add <file>...\" to update what will be committed)\r\n  (use \"git restore <file>...\" to discard changes in working directory)\r\n\tmodified:   doc/man/bitcoin-cli.1\r\n\tmodified:   doc/man/bitcoin-tx.1\r\n\tmodified:   doc/man/bitcoin-util.1\r\n\tmodified:   doc/man/bitcoin-wallet.1\r\n\tmodified:   doc/man/bitcoind.1\r\n\r\n```\r\n\r\nThe script warned about `bitcoin-qt` being missing but still generated the other manpages, as you can see with the git status command.\n\n### Expected behaviour\n\n```sh\r\n➜  bitcoin git:(master) ✗ BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py\r\n/home/andre/repos/bitcoin/build/src/qt/bitcoin-qt not found or not an executable. Skipping...\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoind.1…\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-cli.1…\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-tx.1…\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-wallet.1…\r\nGenerating /home/andre/repos/bitcoin/doc/man/bitcoin-util.1…\r\n```\n\n### Steps to reproduce\n\nRun `BUILDDIR=$PWD/build contrib/devtools/gen-manpages.py` without having one of the binaries compiled e.g. bitcoin-qt.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster\n\n### Operating system and version\n\nDebian\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/contrib/devtools/gen-manpages.py b/contrib/devtools/gen-manpages.py\nindex 92acd9a40373c..14c8c408e83af 100755\n--- a/contrib/devtools/gen-manpages.py\n+++ b/contrib/devtools/gen-manpages.py\n@@ -6,6 +6,7 @@\n import subprocess\n import sys\n import tempfile\n+import argparse\n \n BINARIES = [\n 'src/bitcoind',\n@@ -16,6 +17,18 @@\n 'src/qt/bitcoin-qt',\n ]\n \n+parser = argparse.ArgumentParser(\n+    formatter_class=argparse.RawDescriptionHelpFormatter,\n+)\n+parser.add_argument(\n+    \"-s\",\n+    \"--skip-missing-binaries\",\n+    action=\"store_true\",\n+    default=False,\n+    help=\"skip generation for binaries that are not found in the build path\",\n+)\n+args = parser.parse_args()\n+\n # Paths to external utilities.\n git = os.getenv('GIT', 'git')\n help2man = os.getenv('HELP2MAN', 'help2man')\n@@ -38,8 +51,12 @@\n     try:\n         r = subprocess.run([abspath, \"--version\"], stdout=subprocess.PIPE, check=True, text=True)\n     except IOError:\n-        print(f'{abspath} not found or not an executable', file=sys.stderr)\n-        sys.exit(1)\n+        if(args.skip_missing_binaries):\n+            print(f'{abspath} not found or not an executable. Skipping...', file=sys.stderr)\n+            continue\n+        else:\n+            print(f'{abspath} not found or not an executable', file=sys.stderr)\n+            sys.exit(1)\n     # take first line (which must contain version)\n     verstr = r.stdout.splitlines()[0]\n     # last word of line is the actual version e.g. v22.99.0-5c6b3d5b3508\n@@ -51,6 +68,10 @@\n \n     versions.append((abspath, verstr, copyright))\n \n+if not versions:\n+    print(f'No binaries found in {builddir}. Please ensure the binaries are present in {builddir}, or set another build path using the BUILDDIR env variable.')\n+    sys.exit(1)\n+\n if any(verstr.endswith('-dirty') for (_, verstr, _) in versions):\n     print(\"WARNING: Binaries were built from a dirty tree.\")\n     print('man pages generated from dirty binaries should NOT be committed.')\n", "instance_id": "bitcoin__bitcoin-30986", "clarity": 3, "difficulty": 0.25, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly defines the current behavior of the `gen-manpages.py` script, where the script halts if a single binary is missing, and contrasts it with the expected behavior, where the script should skip missing binaries and continue generating manpages for the available ones. The statement includes detailed examples of the issue with logs and comparisons to the older shell script (`gen-manpages.sh`), which handled this case gracefully. Steps to reproduce the issue are provided, along with the expected output. There are no significant ambiguities; the goal, input, output, and constraints are well-articulated. The only minor omission is a lack of explicit mention of specific edge cases (e.g., what if no binaries are found at all), but this is addressed in the code changes and does not detract from the overall clarity.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The modification is confined to a single file (`gen-manpages.py`) and involves a small, focused change. The diff shows the addition of an argument parser to support a `--skip-missing-binaries` flag, a conditional check to skip missing binaries instead of exiting, and a small check to handle the case where no binaries are found. The changes are localized and do not impact the broader architecture of the Bitcoin Core codebase or require understanding complex interactions between modules. The amount of code change is minimal, with less than 20 lines added or modified.\n\n2. **Number of Technical Concepts:** The solution requires basic familiarity with Python, specifically the `argparse` module for command-line argument parsing and control flow modifications using `continue` in a loop. No advanced language features, algorithms, design patterns, or domain-specific knowledge (beyond understanding the purpose of manpage generation) are needed. These concepts are straightforward for anyone with basic Python experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes address a key one—handling the scenario where no binaries are found by adding an explicit check and error message. The error handling logic is simple, involving a conditional exit with a clear message. No complex edge cases (e.g., partial binary failures, permission issues, or platform-specific behaviors) are introduced or required to be handled beyond the primary issue of skipping missing binaries.\n\n4. **Overall Complexity:** The task involves understanding a small part of the script's logic (checking binary existence and running subprocesses) and making a simple modification to alter its behavior. It does not require deep knowledge of the Bitcoin Core codebase or intricate debugging. The change is akin to fixing a minor bug or adding a small feature, aligning with the lower end of the difficulty spectrum.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the task. It requires minimal effort beyond basic Python scripting skills and does not pose significant technical challenges or risks to the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Update nChainTx to 64bit type\nhttps://github.com/bitcoin/bitcoin/blob/8106b268cde8e97a7c330afdda39b6bb55e5574a/src/chain.h#L178-L186\r\n\r\nHey, it's 2024! `nChainTx` seems to currently be 953368191 (height 826100), which is hex `38d3 3e7f`, so we're only 22% of the way to an overflow, and would still need another 200k blocks (~ four years) full of 60 byte transactions to get there.\n", "patch": "diff --git a/src/chain.h b/src/chain.h\nindex e8a8c066c8e1b..c46392c5355c5 100644\n--- a/src/chain.h\n+++ b/src/chain.h\n@@ -102,7 +102,7 @@ enum BlockStatus : uint32_t {\n      *\n      * If a block's validity is at least VALID_TRANSACTIONS, CBlockIndex::nTx will be set. If a block and all previous\n      * blocks back to the genesis block or an assumeutxo snapshot block are at least VALID_TRANSACTIONS,\n-     * CBlockIndex::nChainTx will be set.\n+     * CBlockIndex::m_chain_tx_count will be set.\n      */\n     BLOCK_VALID_TRANSACTIONS =    3,\n \n@@ -173,8 +173,7 @@ class CBlockIndex\n     //! This value will be non-zero if this block and all previous blocks back\n     //! to the genesis block or an assumeutxo snapshot block have reached the\n     //! VALID_TRANSACTIONS level.\n-    //! Change to 64-bit type before 2024 (assuming worst case of 60 byte transactions).\n-    unsigned int nChainTx{0};\n+    uint64_t m_chain_tx_count{0};\n \n     //! Verification status of this block. See enum BlockStatus\n     //!\n@@ -254,10 +253,10 @@ class CBlockIndex\n      * Does not imply the transactions are consensus-valid (ConnectTip might fail)\n      * Does not imply the transactions are still stored on disk. (IsBlockPruned might return true)\n      *\n-     * Note that this will be true for the snapshot base block, if one is loaded, since its nChainTx value will have\n+     * Note that this will be true for the snapshot base block, if one is loaded, since its m_chain_tx_count value will have\n      * been set manually based on the related AssumeutxoData entry.\n      */\n-    bool HaveNumChainTxs() const { return nChainTx != 0; }\n+    bool HaveNumChainTxs() const { return m_chain_tx_count != 0; }\n \n     NodeSeconds Time() const\n     {\ndiff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 2b729e3b7a9b4..aa6d80556a073 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -180,7 +180,7 @@ class CMainParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000000000000026811d149d4d261995ec5b3f64f439a0a10e1a464af9a\n             .nTime    = 1704194835,\n-            .nTxCount = 946728933,\n+            .tx_count = 946728933,\n             .dTxRate  = 6.569290261471664,\n         };\n     }\n@@ -272,7 +272,7 @@ class CTestNetParams : public CChainParams {\n             {\n                 .height = 2'500'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xf841584909f68e47897952345234e37fcd9128cd818f41ee6c3ca68db8071be7\")},\n-                .nChainTx = 66484552,\n+                .m_chain_tx_count = 66484552,\n                 .blockhash = uint256S(\"0x0000000000000093bcb68c03a9a168ae252572d348a2eaeba2cdf9231d73206f\")\n             }\n         };\n@@ -280,7 +280,7 @@ class CTestNetParams : public CChainParams {\n         chainTxData = ChainTxData{\n             // Data from RPC: getchaintxstats 4096 000000000001323071f38f21ea5aae529ece491eadaccce506a59bcc2d968917\n             .nTime    = 1703579240,\n-            .nTxCount = 67845391,\n+            .tx_count = 67845391,\n             .dTxRate  = 1.464436832560951,\n         };\n     }\n@@ -312,7 +312,7 @@ class SigNetParams : public CChainParams {\n             chainTxData = ChainTxData{\n                 // Data from RPC: getchaintxstats 4096 0000000870f15246ba23c16e370a7ffb1fc8a3dcf8cb4492882ed4b0e3d4cd26\n                 .nTime    = 1706331472,\n-                .nTxCount = 2425380,\n+                .tx_count = 2425380,\n                 .dTxRate  = 0.008277759863833788,\n             };\n         } else {\n@@ -382,7 +382,7 @@ class SigNetParams : public CChainParams {\n             {\n                 .height = 160'000,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xfe0a44309b74d6b5883d246cb419c6221bcccf0b308c9b59b7d70783dbdf928a\")},\n-                .nChainTx = 2289496,\n+                .m_chain_tx_count = 2289496,\n                 .blockhash = uint256S(\"0x0000003ca3c99aff040f2563c2ad8f8ec88bd0fd6b8f0895cfaf1ef90353a62c\")\n             }\n         };\n@@ -498,21 +498,21 @@ class CRegTestParams : public CChainParams\n             {   // For use by unit tests\n                 .height = 110,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x6657b736d4fe4db0cbc796789e812d5dba7f5c143764b1b6905612f1830609d1\")},\n-                .nChainTx = 111,\n+                .m_chain_tx_count = 111,\n                 .blockhash = uint256S(\"0x696e92821f65549c7ee134edceeeeaaa4105647a3c4fd9f298c0aec0ab50425c\")\n             },\n             {\n                 // For use by fuzz target src/test/fuzz/utxo_snapshot.cpp\n                 .height = 200,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0x4f34d431c3e482f6b0d67b64609ece3964dc8d7976d02ac68dd7c9c1421738f2\")},\n-                .nChainTx = 201,\n+                .m_chain_tx_count = 201,\n                 .blockhash = uint256S(\"0x5e93653318f294fb5aa339d00bbf8cf1c3515488ad99412c37608b139ea63b27\"),\n             },\n             {\n                 // For use by test/functional/feature_assumeutxo.py\n                 .height = 299,\n                 .hash_serialized = AssumeutxoHash{uint256S(\"0xa4bf3407ccb2cc0145c49ebba8fa91199f8a3903daf0883875941497d2493c27\")},\n-                .nChainTx = 334,\n+                .m_chain_tx_count = 334,\n                 .blockhash = uint256S(\"0x3bb7ce5eba0be48939b7a521ac1ba9316afee2c7bada3a0cca24188e6d7d96c0\")\n             },\n         };\ndiff --git a/src/kernel/chainparams.h b/src/kernel/chainparams.h\nindex 5d45a1fa9c07f..e367de2f93982 100644\n--- a/src/kernel/chainparams.h\n+++ b/src/kernel/chainparams.h\n@@ -50,11 +50,11 @@ struct AssumeutxoData {\n     //! The expected hash of the deserialized UTXO set.\n     AssumeutxoHash hash_serialized;\n \n-    //! Used to populate the nChainTx value, which is used during BlockManager::LoadBlockIndex().\n+    //! Used to populate the m_chain_tx_count value, which is used during BlockManager::LoadBlockIndex().\n     //!\n     //! We need to hardcode the value here because this is computed cumulatively using block data,\n     //! which we do not necessarily have at the time of snapshot load.\n-    unsigned int nChainTx;\n+    uint64_t m_chain_tx_count;\n \n     //! The hash of the base block for this snapshot. Used to refer to assumeutxo data\n     //! prior to having a loaded blockindex.\n@@ -69,7 +69,7 @@ struct AssumeutxoData {\n  */\n struct ChainTxData {\n     int64_t nTime;    //!< UNIX timestamp of last known number of transactions\n-    int64_t nTxCount; //!< total number of transactions between genesis and that timestamp\n+    uint64_t tx_count; //!< total number of transactions between genesis and that timestamp\n     double dTxRate;   //!< estimated number of transactions per second after that timestamp\n };\n \ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex 29b624cb12f57..bfb11e9fcd4f4 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -410,11 +410,11 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n         m_snapshot_height = au_data.height;\n         CBlockIndex* base{LookupBlockIndex(*snapshot_blockhash)};\n \n-        // Since nChainTx (responsible for estimated progress) isn't persisted\n+        // Since m_chain_tx_count (responsible for estimated progress) isn't persisted\n         // to disk, we must bootstrap the value for assumedvalid chainstates\n         // from the hardcoded assumeutxo chainparams.\n-        base->nChainTx = au_data.nChainTx;\n-        LogPrintf(\"[snapshot] set nChainTx=%d for %s\\n\", au_data.nChainTx, snapshot_blockhash->ToString());\n+        base->m_chain_tx_count = au_data.m_chain_tx_count;\n+        LogPrintf(\"[snapshot] set m_chain_tx_count=%d for %s\\n\", au_data.m_chain_tx_count, snapshot_blockhash->ToString());\n     } else {\n         // If this isn't called with a snapshot blockhash, make sure the cached snapshot height\n         // is null. This is relevant during snapshot completion, when the blockman may be loaded\n@@ -449,15 +449,15 @@ bool BlockManager::LoadBlockIndex(const std::optional<uint256>& snapshot_blockha\n                 if (m_snapshot_height && pindex->nHeight == *m_snapshot_height &&\n                         pindex->GetBlockHash() == *snapshot_blockhash) {\n                     // Should have been set above; don't disturb it with code below.\n-                    Assert(pindex->nChainTx > 0);\n-                } else if (pindex->pprev->nChainTx > 0) {\n-                    pindex->nChainTx = pindex->pprev->nChainTx + pindex->nTx;\n+                    Assert(pindex->m_chain_tx_count > 0);\n+                } else if (pindex->pprev->m_chain_tx_count > 0) {\n+                    pindex->m_chain_tx_count = pindex->pprev->m_chain_tx_count + pindex->nTx;\n                 } else {\n-                    pindex->nChainTx = 0;\n+                    pindex->m_chain_tx_count = 0;\n                     m_blocks_unlinked.insert(std::make_pair(pindex->pprev, pindex));\n                 }\n             } else {\n-                pindex->nChainTx = pindex->nTx;\n+                pindex->m_chain_tx_count = pindex->nTx;\n             }\n         }\n         if (!(pindex->nStatus & BLOCK_FAILED_MASK) && pindex->pprev && (pindex->pprev->nStatus & BLOCK_FAILED_MASK)) {\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 9772b26aea585..02f9ecef341f7 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1725,16 +1725,16 @@ static RPCHelpMan getchaintxstats()\n \n     UniValue ret(UniValue::VOBJ);\n     ret.pushKV(\"time\", (int64_t)pindex->nTime);\n-    if (pindex->nChainTx) {\n-        ret.pushKV(\"txcount\", pindex->nChainTx);\n+    if (pindex->m_chain_tx_count) {\n+        ret.pushKV(\"txcount\", pindex->m_chain_tx_count);\n     }\n     ret.pushKV(\"window_final_block_hash\", pindex->GetBlockHash().GetHex());\n     ret.pushKV(\"window_final_block_height\", pindex->nHeight);\n     ret.pushKV(\"window_block_count\", blockcount);\n     if (blockcount > 0) {\n         ret.pushKV(\"window_interval\", nTimeDiff);\n-        if (pindex->nChainTx != 0 && past_block.nChainTx != 0) {\n-            const auto window_tx_count = pindex->nChainTx - past_block.nChainTx;\n+        if (pindex->m_chain_tx_count != 0 && past_block.m_chain_tx_count != 0) {\n+            const auto window_tx_count = pindex->m_chain_tx_count - past_block.m_chain_tx_count;\n             ret.pushKV(\"window_tx_count\", window_tx_count);\n             if (nTimeDiff > 0) {\n                 ret.pushKV(\"txrate\", double(window_tx_count) / nTimeDiff);\n@@ -2799,7 +2799,7 @@ UniValue CreateUTXOSnapshot(\n     result.pushKV(\"base_height\", tip->nHeight);\n     result.pushKV(\"path\", path.utf8string());\n     result.pushKV(\"txoutset_hash\", maybe_stats->hashSerialized.ToString());\n-    result.pushKV(\"nchaintx\", tip->nChainTx);\n+    result.pushKV(\"nchaintx\", tip->m_chain_tx_count);\n     return result;\n }\n \ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex d6b3924cda0e3..9126d8e928e30 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2956,7 +2956,7 @@ static void UpdateTipLog(\n     LogPrintf(\"%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\",\n         prefix, func_name,\n         tip->GetBlockHash().ToString(), tip->nHeight, tip->nVersion,\n-        log(tip->nChainWork.getdouble()) / log(2.0), (unsigned long)tip->nChainTx,\n+        log(tip->nChainWork.getdouble()) / log(2.0), tip->m_chain_tx_count,\n         FormatISO8601DateTime(tip->GetBlockTime()),\n         GuessVerificationProgress(params.TxData(), tip),\n         coins_tip.DynamicMemoryUsage() * (1.0 / (1 << 20)),\n@@ -3846,17 +3846,17 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n {\n     AssertLockHeld(cs_main);\n     pindexNew->nTx = block.vtx.size();\n-    // Typically nChainTx will be 0 at this point, but it can be nonzero if this\n+    // Typically m_chain_tx_count will be 0 at this point, but it can be nonzero if this\n     // is a pruned block which is being downloaded again, or if this is an\n-    // assumeutxo snapshot block which has a hardcoded nChainTx value from the\n+    // assumeutxo snapshot block which has a hardcoded m_chain_tx_count value from the\n     // snapshot metadata. If the pindex is not the snapshot block and the\n-    // nChainTx value is not zero, assert that value is actually correct.\n-    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->nChainTx : 0); };\n-    if (!Assume(pindexNew->nChainTx == 0 || pindexNew->nChainTx == prev_tx_sum(*pindexNew) ||\n+    // m_chain_tx_count value is not zero, assert that value is actually correct.\n+    auto prev_tx_sum = [](CBlockIndex& block) { return block.nTx + (block.pprev ? block.pprev->m_chain_tx_count : 0); };\n+    if (!Assume(pindexNew->m_chain_tx_count == 0 || pindexNew->m_chain_tx_count == prev_tx_sum(*pindexNew) ||\n                 pindexNew == GetSnapshotBaseBlock())) {\n-        LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-            pindexNew->nHeight, pindexNew->nChainTx, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n-        pindexNew->nChainTx = 0;\n+        LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+            pindexNew->nHeight, pindexNew->m_chain_tx_count, prev_tx_sum(*pindexNew), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+        pindexNew->m_chain_tx_count = 0;\n     }\n     pindexNew->nFile = pos.nFile;\n     pindexNew->nDataPos = pos.nPos;\n@@ -3877,15 +3877,15 @@ void ChainstateManager::ReceivedBlockTransactions(const CBlock& block, CBlockInd\n         while (!queue.empty()) {\n             CBlockIndex *pindex = queue.front();\n             queue.pop_front();\n-            // Before setting nChainTx, assert that it is 0 or already set to\n+            // Before setting m_chain_tx_count, assert that it is 0 or already set to\n             // the correct value. This assert will fail after receiving the\n             // assumeutxo snapshot block if assumeutxo snapshot metadata has an\n-            // incorrect hardcoded AssumeutxoData::nChainTx value.\n-            if (!Assume(pindex->nChainTx == 0 || pindex->nChainTx == prev_tx_sum(*pindex))) {\n-                LogWarning(\"Internal bug detected: block %d has unexpected nChainTx %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n-                   pindex->nHeight, pindex->nChainTx, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n+            // incorrect hardcoded AssumeutxoData::m_chain_tx_count value.\n+            if (!Assume(pindex->m_chain_tx_count == 0 || pindex->m_chain_tx_count == prev_tx_sum(*pindex))) {\n+                LogWarning(\"Internal bug detected: block %d has unexpected m_chain_tx_count %i that should be %i (%s %s). Please report this issue here: %s\\n\",\n+                   pindex->nHeight, pindex->m_chain_tx_count, prev_tx_sum(*pindex), PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n             }\n-            pindex->nChainTx = prev_tx_sum(*pindex);\n+            pindex->m_chain_tx_count = prev_tx_sum(*pindex);\n             pindex->nSequenceId = nBlockSequenceId++;\n             for (Chainstate *c : GetAll()) {\n                 c->TryAddBlockIndexCandidate(pindex);\n@@ -5333,17 +5333,17 @@ void ChainstateManager::CheckBlockIndex()\n             // Checks for not-invalid blocks.\n             assert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\n         }\n-        // Make sure nChainTx sum is correctly computed.\n+        // Make sure m_chain_tx_count sum is correctly computed.\n         if (!pindex->pprev) {\n-            // If no previous block, nTx and nChainTx must be the same.\n-            assert(pindex->nChainTx == pindex->nTx);\n-        } else if (pindex->pprev->nChainTx > 0 && pindex->nTx > 0) {\n-            // If previous nChainTx is set and number of transactions in block is known, sum must be set.\n-            assert(pindex->nChainTx == pindex->nTx + pindex->pprev->nChainTx);\n+            // If no previous block, nTx and m_chain_tx_count must be the same.\n+            assert(pindex->m_chain_tx_count == pindex->nTx);\n+        } else if (pindex->pprev->m_chain_tx_count > 0 && pindex->nTx > 0) {\n+            // If previous m_chain_tx_count is set and number of transactions in block is known, sum must be set.\n+            assert(pindex->m_chain_tx_count == pindex->nTx + pindex->pprev->m_chain_tx_count);\n         } else {\n-            // Otherwise nChainTx should only be set if this is a snapshot\n+            // Otherwise m_chain_tx_count should only be set if this is a snapshot\n             // block, and must be set if it is.\n-            assert((pindex->nChainTx != 0) == (pindex == snap_base));\n+            assert((pindex->m_chain_tx_count != 0) == (pindex == snap_base));\n         }\n \n         // Chainstate-specific checks on setBlockIndexCandidates\n@@ -5548,13 +5548,13 @@ bool Chainstate::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n }\n \n //! Guess how far we are in the verification process at the given block index\n-//! require cs_main if pindex has not been validated yet (because nChainTx might be unset)\n+//! require cs_main if pindex has not been validated yet (because m_chain_tx_count might be unset)\n double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pindex) {\n     if (pindex == nullptr)\n         return 0.0;\n \n-    if (!Assume(pindex->nChainTx > 0)) {\n-        LogWarning(\"Internal bug detected: block %d has unset nChainTx (%s %s). Please report this issue here: %s\\n\",\n+    if (!Assume(pindex->m_chain_tx_count > 0)) {\n+        LogWarning(\"Internal bug detected: block %d has unset m_chain_tx_count (%s %s). Please report this issue here: %s\\n\",\n                    pindex->nHeight, PACKAGE_NAME, FormatFullVersion(), PACKAGE_BUGREPORT);\n         return 0.0;\n     }\n@@ -5563,13 +5563,13 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\n \n     double fTxTotal;\n \n-    if (pindex->nChainTx <= data.nTxCount) {\n-        fTxTotal = data.nTxCount + (nNow - data.nTime) * data.dTxRate;\n+    if (pindex->m_chain_tx_count <= data.tx_count) {\n+        fTxTotal = data.tx_count + (nNow - data.nTime) * data.dTxRate;\n     } else {\n-        fTxTotal = pindex->nChainTx + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n+        fTxTotal = pindex->m_chain_tx_count + (nNow - pindex->GetBlockTime()) * data.dTxRate;\n     }\n \n-    return std::min<double>(pindex->nChainTx / fTxTotal, 1.0);\n+    return std::min<double>(pindex->m_chain_tx_count / fTxTotal, 1.0);\n }\n \n std::optional<uint256> ChainstateManager::SnapshotBlockhash() const\n@@ -6026,7 +6026,7 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(index);\n     assert(index == snapshot_start_block);\n-    index->nChainTx = au_data.nChainTx;\n+    index->m_chain_tx_count = au_data.m_chain_tx_count;\n     snapshot_chainstate.setBlockIndexCandidates.insert(snapshot_start_block);\n \n     LogPrintf(\"[snapshot] validated snapshot (%.2f MB)\\n\",\n", "instance_id": "bitcoin__bitcoin-29656", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in its intent to update the `nChainTx` variable to a 64-bit type to prevent potential overflow issues in the future. It provides context about the current value and the timeline for potential overflow, which helps in understanding the motivation behind the change. However, the statement lacks detailed requirements or constraints beyond the type change itself. For instance, it does not explicitly mention compatibility concerns, performance implications, or specific edge cases to handle during the transition. Additionally, there are no examples or test cases provided to validate the change. While the goal is clear, these missing minor details prevent it from being comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to several factors. First, the scope of code changes is moderate but straightforward, involving renaming and updating the type of `nChainTx` to `m_chain_tx_count` (or similar) across multiple files in the Bitcoin codebase. The changes span several files (`chain.h`, `chainparams.cpp`, `chainparams.h`, `blockstorage.cpp`, `blockchain.cpp`, `validation.cpp`), but they are mostly mechanical—replacing variable names and updating types from `unsigned int` or `int64_t` to `uint64_t`. Second, the technical concepts required are minimal, focusing on basic C++ type systems and understanding of variable scope within a struct or class. No complex algorithms, design patterns, or domain-specific knowledge beyond basic blockchain transaction counting are needed. Third, the problem does not appear to introduce significant edge cases or error handling beyond ensuring the new type can hold larger values, and the code changes do not suggest major architectural impacts. While the changes touch multiple parts of the codebase, the repetitive nature of the updates and the lack of deep logical complexity make this an easy task for a developer familiar with C++ and large codebases. A score of 0.25 reflects this balance of moderate scope with low technical depth.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Move to OSC 8 hyperlinks with keyboard in mark mode\n# Description of the new feature/enhancement\r\n\r\nCurrently you can cycle through URLs in the scrollback buffer with tab and shift+tab in mark mode. It would be nice if this also worked with OSC 8 hyperlinks.\r\n\r\nRight now this:\r\n```bash\r\nprintf '\\e]8;;http://example.com\\e\\\\This is a link\\e]8;;\\e\\\\\\nhttp://example.com\\n'\r\n```\r\nonly lets you shift+tab back to the plain text link, not the OSC 8 one, which you would have to navigate to using the arrow keys.\n", "patch": "diff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 9501f64a85e..707415015a6 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -437,7 +437,8 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     }\r\n \r\n     // 0. Useful tools/vars\r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     const auto viewportHeight = _GetMutableViewport().Height();\r\n \r\n     // The patterns are stored relative to the \"search area\". Initially, this search area will be the viewport,\r\n@@ -504,8 +505,18 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n     };\r\n \r\n     // 1. Look for the hyperlink\r\n-    til::point searchStart = dir == SearchDirection::Forward ? _selection->start : til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n-    til::point searchEnd = dir == SearchDirection::Forward ? til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() } : _selection->start;\r\n+    til::point searchStart;\r\n+    til::point searchEnd;\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = til::point{ bufferSize.RightInclusive(), _VisibleEndIndex() };\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = til::point{ bufferSize.Left(), _VisibleStartIndex() };\r\n+        searchEnd = _selection->start;\r\n+    }\r\n \r\n     // 1.A) Try searching the current viewport (no scrolling required)\r\n     auto resultList = _patternIntervalTree.findContained(convertToSearchArea(searchStart), convertToSearchArea(searchEnd));\r\n@@ -547,27 +558,81 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n                 searchArea = Viewport::FromDimensions(searchStart, { searchEnd.x + 1, searchEnd.y + 1 });\r\n             }\r\n         }\r\n+    }\r\n \r\n-        // 1.C) Nothing was found. Bail!\r\n-        if (!result.has_value())\r\n+    // 2. We found a hyperlink from the pattern tree. Look for embedded hyperlinks too!\r\n+    // Use the result (if one was found) to narrow down the search.\r\n+    if (dir == SearchDirection::Forward)\r\n+    {\r\n+        searchStart = _selection->start;\r\n+        searchEnd = (result ? result->first : buffer.GetLastNonSpaceCharacter());\r\n+    }\r\n+    else\r\n+    {\r\n+        searchStart = (result ? result->second : bufferSize.Origin());\r\n+        searchEnd = _selection->start;\r\n+    }\r\n+\r\n+    // Careful! Selection can point to RightExclusive(), which doesn't contain data!\r\n+    // Clamp to be safe.\r\n+    auto initialPos = dir == SearchDirection::Forward ? searchStart : searchEnd;\r\n+    bufferSize.Clamp(initialPos);\r\n+    auto iter = buffer.GetCellDataAt(initialPos);\r\n+    while (dir == SearchDirection::Forward ? iter.Pos() < searchEnd : iter.Pos() > searchStart)\r\n+    {\r\n+        // Don't let us select the same hyperlink again\r\n+        if (iter.Pos() < _selection->start || iter.Pos() > _selection->end)\r\n         {\r\n-            return;\r\n+            if (auto attr = iter->TextAttr(); attr.IsHyperlink())\r\n+            {\r\n+                // Found an embedded hyperlink!\r\n+                const auto hyperlinkId = attr.GetHyperlinkId();\r\n+\r\n+                // Expand the start to include the entire hyperlink\r\n+                TextBufferCellIterator hyperlinkStartIter{ buffer, iter.Pos() };\r\n+                while (hyperlinkStartIter.Pos() > searchStart && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    --hyperlinkStartIter;\r\n+                    attr = hyperlinkStartIter->TextAttr();\r\n+                }\r\n+                if (hyperlinkStartIter.Pos() != bufferSize.Origin())\r\n+                {\r\n+                    // undo a move to be inclusive\r\n+                    ++hyperlinkStartIter;\r\n+                }\r\n+\r\n+                // Expand the end to include the entire hyperlink\r\n+                // No need to undo a move! We'll decrement in the next step anyways.\r\n+                TextBufferCellIterator hyperlinkEndIter{ buffer, iter.Pos() };\r\n+                attr = hyperlinkEndIter->TextAttr();\r\n+                while (hyperlinkEndIter.Pos() < searchEnd && attr.IsHyperlink() && attr.GetHyperlinkId() == hyperlinkId)\r\n+                {\r\n+                    ++hyperlinkEndIter;\r\n+                    attr = hyperlinkEndIter->TextAttr();\r\n+                }\r\n+\r\n+                result = { hyperlinkStartIter.Pos(), hyperlinkEndIter.Pos() };\r\n+                break;\r\n+            }\r\n         }\r\n+        iter += dir == SearchDirection::Forward ? 1 : -1;\r\n     }\r\n \r\n-    // 2. Select the hyperlink\r\n+    // 3. Select the hyperlink, if one exists\r\n+    if (!result.has_value())\r\n     {\r\n-        auto selection{ _selection.write() };\r\n-        wil::hide_name _selection;\r\n-        selection->start = result->first;\r\n-        selection->pivot = result->first;\r\n-        selection->end = result->second;\r\n-        _selectionIsTargetingUrl = true;\r\n-        _selectionEndpoint = SelectionEndpoint::End;\r\n+        return;\r\n     }\r\n-\r\n-    // 3. Scroll to the selected area (if necessary)\r\n-    _ScrollToPoint(_selection->end);\r\n+    auto selection{ _selection.write() };\r\n+    wil::hide_name _selection;\r\n+    selection->start = result->first;\r\n+    selection->pivot = result->first;\r\n+    selection->end = result->second;\r\n+    _selectionIsTargetingUrl = true;\r\n+    _selectionEndpoint = SelectionEndpoint::End;\r\n+\r\n+    // 4. Scroll to the selected area (if necessary)\r\n+    _ScrollToPoint(selection->end);\r\n }\r\n \r\n Terminal::UpdateSelectionParams Terminal::ConvertKeyEventToUpdateSelectionParams(const ControlKeyStates mods, const WORD vkey) const noexcept\r\n", "instance_id": "microsoft__terminal-18347", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the desired enhancement: enabling navigation to OSC 8 hyperlinks in mark mode using keyboard shortcuts (tab and shift+tab), similar to how plain text URLs are currently handled. It provides a specific example with a bash command to illustrate the current limitation and the expected behavior. However, there are minor ambiguities and missing details. For instance, it does not explicitly define how OSC 8 hyperlinks should be prioritized or interact with plain text URLs during navigation (e.g., should both types be cycled through together, or should there be a distinction?). Additionally, edge cases such as overlapping hyperlinks, empty buffers, or invalid OSC 8 sequences are not mentioned. While the goal is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is moderate, primarily confined to a single file (`TerminalSelection.cpp`) and specifically to the `SelectHyperlink` function. The changes involve adding logic to detect and handle OSC 8 hyperlinks alongside existing pattern-based URL detection, which requires understanding the existing codebase's buffer and selection mechanisms. Second, the technical concepts involved include familiarity with terminal escape sequences (OSC 8), text buffer iteration, and hyperlink attribute handling, which are moderately complex but not overly advanced. Third, the code changes are significant, adding new logic for iterating through buffer cells to detect embedded hyperlinks and expanding selections to cover entire hyperlink ranges, which introduces complexity in managing positions and boundaries. Finally, while the problem statement does not explicitly mention edge cases, the code changes implicitly address scenarios like ensuring the selection does not overlap with the current selection and handling buffer boundaries, which adds some intricacy to the implementation. Overall, this task requires a solid understanding of the terminal's internal data structures and selection logic, but it does not impact the broader system architecture or demand advanced domain-specific knowledge, placing it in the medium difficulty range at 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Original console buffer is not restored when closing a secondary one\n### Windows Terminal version\r\n\r\n1.22.240823002-preview\r\n\r\n### Windows build number\r\n\r\n10.0.19045\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nReduced test code (by lhecker): \r\n```cpp\r\n#define WIN32_LEAN_AND_MEAN\r\n#include <Windows.h>\r\n\r\nint main() {\r\n    const auto buffer = CreateConsoleScreenBuffer(GENERIC_READ | GENERIC_WRITE, 0, nullptr, CONSOLE_TEXTMODE_BUFFER, nullptr);\r\n    SetConsoleActiveScreenBuffer(buffer);\r\n    CloseHandle(buffer);\r\n    return 0;\r\n}\r\n```\r\n\r\n---\r\n\r\nRun a program which creates and activates a new console screen buffer using `CreateConsoleScreenBuffer` and `SetConsoleActiveScreenBuffer`.\r\n\r\nThe following C program with argument value 0-4 does all combos:\r\n```\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n```\r\n\r\n<details>\r\n<summary>newbuf.c</summary>\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <string.h>\r\n#include <stdlib.h>\r\n#include <windows.h>\r\n\r\n\r\n#define writecon(h, s) WriteConsole(h, (s), strlen(s), 0, 0)\r\n#define ERR_EXIT(...) (fprintf(stderr, __VA_ARGS__), exit(1), 0)\r\n\r\n// usage: *argv 0|1|2|3|4\r\n// create+activate new screen buffer, print a message to it, sleep 1s, then before exit:\r\n//   0: do nothing.\r\n//   1: CloseHandle(newbuf).\r\n//   2: SetConsoleActiveScreenBuffer(orig_con)\r\n//   3: CloseHandle(newbuf), SetConsoleActiveScreenBuffer(orig_con)\r\n//   4: SetConsoleActiveScreenBuffer(orig_con), CloseHandle(newbuf)\r\n\r\nint main(int argc, char **argv)\r\n{\r\n\tint mode = argc > 1 ? atoi(argv[1]) : 0;\r\n\r\n\tHANDLE hcon = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\tif (hcon == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't get stdout handle\\n\");\r\n\r\n\tif (!writecon(hcon, \"orig screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to stdout console\\n\");\r\n\r\n\tHANDLE hnewbuf = CreateConsoleScreenBuffer(\r\n\t\tGENERIC_WRITE, FILE_SHARE_WRITE,\r\n\t\t0, CONSOLE_TEXTMODE_BUFFER, 0);\r\n\tif (hnewbuf == INVALID_HANDLE_VALUE)\r\n\t\tERR_EXIT(\"can't create new screen buf\\n\");\r\n\r\n\tif (!SetConsoleActiveScreenBuffer(hnewbuf))\r\n\t\tERR_EXIT(\"can't activete new screen buf\\n\");\r\n\r\n\tif (!writecon(hnewbuf, \"new screen buffer\\n\"))\r\n\t\tERR_EXIT(\"can't write to new screen buf\\n\");\r\n\r\n\tSleep(1000);\r\n\r\n\t// all combos of \"close new buf\" and \"restore orig buff\", + reverse order.\r\n\t//\r\n\t// expected result:\r\n\t// - all combos restore the original buf on exit (maybe implicitly)\r\n\t//\r\n\t// actual result:\r\n\t// - Working as expected in conhost.exe or OpenConsole.exe (including 1.22)\r\n\t//   or Windows Terminal (up to and including 1.21).\r\n\t//\r\n\t// - in Windows Terminal 1.22: only 2 and 4 work as expected\r\n\t//   (\"restore orig buf\" without or before \"close new buf\")\r\n\t//   - 0: no close and no manual restore: not restored.\r\n\t//   - 1: close only: not restored.\r\n\t//   - 3: close and restored manually: not restored.\r\n\r\n\tswitch (mode) {\r\n\t\tcase 0:\r\n\t\t\tbreak;\r\n\r\n\t\tcase 1:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\r\n\t\tcase 2:\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 3:\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tbreak;\r\n\r\n\t\tcase 4:  // like 3 but in reverse order\r\n\t\t\tif (!SetConsoleActiveScreenBuffer(hcon))\r\n\t\t\t\tERR_EXIT(\"can't restore orig screen buf\\n\");\r\n\t\t\tCloseHandle(hnewbuf);\r\n\t\t\tbreak;\r\n\t}\r\n\r\n\treturn 0;\r\n}\r\n```\r\n\r\n</details>\r\n\r\n\r\n\r\n### Expected Behavior\r\n\r\nOriginal screen buffer is restored when the application exits (its content and original cursor position), regardless if the new screen buffer handle is closed or not, and regardless if the original screen buffer is re-activated before exit.\r\n\r\n### Actual Behavior\r\n\r\nNo issue in conhost.exe or OpenConsole.exe (even of 1.22), or Windows terminal up to and including 1.21.\r\n\r\nWith Windows terminal 1.22 (preview):\r\n- The original screen buffer is only restored if `SetConsoleActiveScreenBuffer(orig_con)` is invoked without or before `CloseHandle(h_newbuf)`.\r\n- Specifically, it's not restored if:\r\n  - Neither `CloseHandle` nor `SetConsoleActiveScreenBuffer(orig_con)` are used.\r\n  - Only `CloseHandle` is used.\r\n  - Both `CloseHandle` and `SetConsoleActiveScreenBuffer(orig_con)` are used in that order.\n", "patch": "diff --git a/src/host/VtIo.cpp b/src/host/VtIo.cpp\nindex 026010b2f70..d64d142d210 100644\n--- a/src/host/VtIo.cpp\n+++ b/src/host/VtIo.cpp\n@@ -6,6 +6,7 @@\n \r\n #include <til/unicode.h>\r\n \r\n+#include \"directio.h\"\r\n #include \"handle.h\" // LockConsole\r\n #include \"output.h\" // CloseConsoleProcessState\r\n #include \"../interactivity/inc/ServiceLocator.hpp\"\r\n@@ -790,3 +791,51 @@ void VtIo::Writer::WriteInfos(til::point target, std::span<const CHAR_INFO> info\n         } while (--repeat);\r\n     }\r\n }\r\n+\r\n+void VtIo::Writer::WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const\r\n+{\r\n+    const auto area = static_cast<size_t>(oldSize.width * oldSize.height);\r\n+\r\n+    auto& main = newContext.GetMainBuffer();\r\n+    auto& alt = newContext.GetActiveBuffer();\r\n+    const auto hasAltBuffer = &alt != &main;\r\n+\r\n+    // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n+    if (oldSize != main.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(oldSize));\r\n+        main.SetViewportSize(&oldSize);\r\n+    }\r\n+    if (hasAltBuffer && oldSize != alt.GetBufferSize().Dimensions())\r\n+    {\r\n+        THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(oldSize));\r\n+        alt.SetViewportSize(&oldSize);\r\n+    }\r\n+\r\n+    const auto request = Viewport::FromDimensions({}, oldSize);\r\n+    Viewport read;\r\n+    til::small_vector<CHAR_INFO, 1024> infos;\r\n+    infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n+\r\n+    const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n+        THROW_IF_FAILED(ReadConsoleOutputWImplHelper(screenInfo, infos, request, read));\r\n+        for (til::CoordType i = 0; i < oldSize.height; i++)\r\n+        {\r\n+            WriteInfos({ 0, i }, { infos.begin() + i * oldSize.width, static_cast<size_t>(oldSize.width) });\r\n+        }\r\n+\r\n+        WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n+        WriteAttributes(screenInfo.GetAttributes());\r\n+        WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n+        WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n+    };\r\n+\r\n+    WriteASB(false);\r\n+    dumpScreenInfo(main);\r\n+\r\n+    if (hasAltBuffer)\r\n+    {\r\n+        WriteASB(true);\r\n+        dumpScreenInfo(alt);\r\n+    }\r\n+}\r\ndiff --git a/src/host/VtIo.hpp b/src/host/VtIo.hpp\nindex a5d13764261..4e9d250c4cf 100644\n--- a/src/host/VtIo.hpp\n+++ b/src/host/VtIo.hpp\n@@ -44,6 +44,7 @@ namespace Microsoft::Console::VirtualTerminal\n             void WriteWindowTitle(std::wstring_view title) const;\r\n             void WriteAttributes(const TextAttribute& attributes) const;\r\n             void WriteInfos(til::point target, std::span<const CHAR_INFO> infos) const;\r\n+            void WriteScreenInfo(SCREEN_INFORMATION& newContext, til::size oldSize) const;\r\n \r\n         private:\r\n             VtIo* _io = nullptr;\r\ndiff --git a/src/host/getset.cpp b/src/host/getset.cpp\nindex cb3c80d7bbb..81701a9f874 100644\n--- a/src/host/getset.cpp\n+++ b/src/host/getset.cpp\n@@ -487,49 +487,8 @@ void ApiRoutines::SetConsoleActiveScreenBufferImpl(SCREEN_INFORMATION& newContex\n \r\n         if (auto writer = gci.GetVtWriter())\r\n         {\r\n-            const auto viewport = gci.GetActiveOutputBuffer().GetBufferSize();\r\n-            const auto size = viewport.Dimensions();\r\n-            const auto area = static_cast<size_t>(viewport.Width() * viewport.Height());\r\n-\r\n-            auto& main = newContext.GetMainBuffer();\r\n-            auto& alt = newContext.GetActiveBuffer();\r\n-            const auto hasAltBuffer = &alt != &main;\r\n-\r\n-            // TODO GH#5094: This could use xterm's XTWINOPS \"\\e[8;<height>;<width>t\" escape sequence here.\r\n-            THROW_IF_NTSTATUS_FAILED(main.ResizeTraditional(size));\r\n-            main.SetViewportSize(&size);\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                THROW_IF_NTSTATUS_FAILED(alt.ResizeTraditional(size));\r\n-                alt.SetViewportSize(&size);\r\n-            }\r\n-\r\n-            Viewport read;\r\n-            til::small_vector<CHAR_INFO, 1024> infos;\r\n-            infos.resize(area, CHAR_INFO{ L' ', FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED });\r\n-\r\n-            const auto dumpScreenInfo = [&](SCREEN_INFORMATION& screenInfo) {\r\n-                THROW_IF_FAILED(ReadConsoleOutputWImpl(screenInfo, infos, viewport, read));\r\n-                for (til::CoordType i = 0; i < size.height; i++)\r\n-                {\r\n-                    writer.WriteInfos({ 0, i }, { infos.begin() + i * size.width, static_cast<size_t>(size.width) });\r\n-                }\r\n-\r\n-                writer.WriteCUP(screenInfo.GetTextBuffer().GetCursor().GetPosition());\r\n-                writer.WriteAttributes(screenInfo.GetAttributes());\r\n-                writer.WriteDECTCEM(screenInfo.GetTextBuffer().GetCursor().IsVisible());\r\n-                writer.WriteDECAWM(WI_IsFlagSet(screenInfo.OutputMode, ENABLE_WRAP_AT_EOL_OUTPUT));\r\n-            };\r\n-\r\n-            writer.WriteASB(false);\r\n-            dumpScreenInfo(main);\r\n-\r\n-            if (hasAltBuffer)\r\n-            {\r\n-                writer.WriteASB(true);\r\n-                dumpScreenInfo(alt);\r\n-            }\r\n-\r\n+            const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n             writer.Submit();\r\n         }\r\n \r\ndiff --git a/src/server/ObjectHandle.cpp b/src/server/ObjectHandle.cpp\nindex 1fbf69976fc..64f2d51a4c5 100644\n--- a/src/server/ObjectHandle.cpp\n+++ b/src/server/ObjectHandle.cpp\n@@ -273,7 +273,18 @@ INPUT_READ_HANDLE_DATA* ConsoleHandleData::GetClientInput() const\n     LOG_IF_FAILED(pScreenInfo->FreeIoHandle(this));\r\n     if (!pScreenInfo->HasAnyOpenHandles())\r\n     {\r\n+        auto& gci = Microsoft::Console::Interactivity::ServiceLocator::LocateGlobals().getConsoleInformation();\r\n+        const auto oldSize = gci.GetActiveOutputBuffer().GetBufferSize().Dimensions();\r\n+        auto writer = gci.GetVtWriter();\r\n+\r\n         SCREEN_INFORMATION::s_RemoveScreenBuffer(pScreenInfo);\r\n+\r\n+        if (writer && gci.HasActiveOutputBuffer())\r\n+        {\r\n+            auto& newContext = gci.GetActiveOutputBuffer();\r\n+            writer.WriteScreenInfo(newContext, oldSize);\r\n+            writer.Submit();\r\n+        }\r\n     }\r\n \r\n     return S_OK;\r\n", "instance_id": "microsoft__terminal-17853", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with the Windows Terminal version 1.22 (preview) where the original console screen buffer is not restored under specific conditions when closing a secondary buffer. It provides detailed steps to reproduce the issue, including test code and expected versus actual behavior. The inclusion of different test scenarios (modes 0-4) helps in understanding the specific conditions under which the problem occurs. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss potential edge cases beyond the provided test scenarios, nor does it specify if there are any performance or compatibility constraints to consider when implementing a fix. Additionally, while the expected behavior is described, there is no mention of any specific requirements or constraints for the solution (e.g., maintaining compatibility with older versions or specific Windows APIs). Thus, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.65, placing it in the \"Hard\" category. This assessment is based on the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves nuanced behavior of Windows console APIs (`CreateConsoleScreenBuffer`, `SetConsoleActiveScreenBuffer`, `CloseHandle`), which requires a deep understanding of how these APIs interact with the Windows Terminal's internal state management. The logic of screen buffer restoration is inherently complex due to the stateful nature of console handling.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (`VtIo.cpp`, `VtIo.hpp`, `getset.cpp`, `ObjectHandle.cpp`), indicating that the fix requires modifications across different parts of the codebase. The changes involve refactoring existing logic (e.g., moving screen buffer writing logic into a reusable function `WriteScreenInfo`) and adding new behavior when a screen buffer handle is closed. While the amount of code change is moderate (adding a new function and invoking it in two places), the impact is significant as it touches core console handling logic, which could affect the system's behavior broadly.\n\n3. **Number of Technical Concepts**: Solving this problem requires understanding several technical concepts, including Windows console API behavior, virtual terminal (VT) sequences, and the internal architecture of the Windows Terminal (e.g., how screen buffers are managed between main and alternate buffers). Familiarity with C++ and the specific libraries used in the codebase (e.g., `til` utilities for terminal operations) is necessary. Additionally, the developer must understand how state transitions (e.g., active buffer changes, handle closures) are handled within the terminal's architecture, which adds to the complexity.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement highlights specific scenarios where the original buffer is not restored, but the code changes must ensure that the fix does not introduce new issues, such as incorrect buffer resizing, cursor positioning errors, or attribute mismatches. The provided changes handle resizing and writing screen information for both main and alternate buffers, which suggests attention to detail, but additional edge cases (e.g., multiple rapid buffer switches, invalid handle states, or memory constraints during resizing) may need to be considered. Error handling is present in the form of `THROW_IF_NTSTATUS_FAILED` and `THROW_IF_FAILED`, but ensuring robustness across all scenarios adds to the difficulty.\n\nOverall, this problem requires a deep understanding of the Windows Terminal's internals and careful handling of state management across multiple components. The modifications, while not extensive in terms of lines of code, have a significant impact on core functionality, and the need to handle potential edge cases and ensure compatibility with existing behavior pushes this into the \"Hard\" category. It does not reach \"Very Hard\" as it does not involve system-level redesign or highly specialized domain knowledge beyond Windows console programming.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Mouse events are not sent when the mouse is outside the top of the WT\n### Windows Terminal version\r\n\r\nVersão: 1.20.11781.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nPlease clone this GitHub repository [MouseTests](https://github.com/BDisp/MouseTests.git) and run. Keep pressing the mouse inside the console and move around it, as the gif show.\r\n\r\n### Expected Behavior\r\n\r\nThe mouse events should be sent while the mouse button is pressed and moving inside or outside the console until it's released.\r\n\r\n### Actual Behavior\r\n\r\nThe mouse events are sent as expected except from outside of the console on top.\r\n\r\n![MouseTests](https://github.com/user-attachments/assets/aa84e08d-a96f-43e2-a1ee-8ae199ba74d3)\r\n\r\nWith the `conhost` the mouse events are always sent from anywhere while the mouse isn't released.\n", "patch": "diff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 7b59babd2e5..f18851c2fbb 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -329,7 +329,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         _touchAnchor = contactPoint;\r\n     }\r\n \r\n-    void ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n+    bool ControlInteractivity::PointerMoved(Control::MouseButtonState buttonState,\r\n                                             const unsigned int pointerUpdateKind,\r\n                                             const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                             const bool focused,\r\n@@ -337,11 +337,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const bool pointerPressedInBounds)\r\n     {\r\n         const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n+        bool handledCompletely = false;\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (focused && !_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n             _sendMouseEventHelper(terminalPosition, pointerUpdateKind, modifiers, 0, buttonState);\r\n+            handledCompletely = true;\r\n         }\r\n         // GH#4603 - don't modify the selection if the pointer press didn't\r\n         // actually start _in_ the control bounds. Case in point - someone drags\r\n@@ -378,6 +381,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         _core->SetHoveredCell(terminalPosition.to_core_point());\r\n+        return handledCompletely;\r\n     }\r\n \r\n     void ControlInteractivity::TouchMoved(const Core::Point newTouchPoint,\r\n@@ -682,13 +686,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                      const SHORT wheelDelta,\r\n                                                      Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto adjustment = _core->ScrollOffset() > 0 ? _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight() : 0;\r\n-        // If the click happened outside the active region, just don't send any mouse event\r\n-        if (const auto adjustedY = terminalPosition.y - adjustment; adjustedY >= 0)\r\n-        {\r\n-            return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n-        }\r\n-        return false;\r\n+        const auto adjustment = _core->BufferHeight() - _core->ScrollOffset() - _core->ViewHeight();\r\n+        // If the click happened outside the active region, core should get a chance to filter it out or clamp it.\r\n+        const auto adjustedY = terminalPosition.y - adjustment;\r\n+        return _core->SendMouseEvent({ terminalPosition.x, adjustedY }, pointerUpdateKind, modifiers, wheelDelta, toInternalMouseState(buttonState));\r\n     }\r\n \r\n     // Method Description:\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 38789827ec3..22eaa95c397 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -58,7 +58,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                             const Core::Point pixelPosition);\r\n         void TouchPressed(const Core::Point contactPoint);\r\n \r\n-        void PointerMoved(Control::MouseButtonState buttonState,\r\n+        bool PointerMoved(Control::MouseButtonState buttonState,\r\n                           const unsigned int pointerUpdateKind,\r\n                           const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                           const bool focused,\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.idl b/src/cascadia/TerminalControl/ControlInteractivity.idl\nindex d1ca9720dc6..926c1e3b0a9 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.idl\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.idl\n@@ -43,12 +43,12 @@ namespace Microsoft.Terminal.Control\n                             Microsoft.Terminal.Core.Point pixelPosition);\r\n         void TouchPressed(Microsoft.Terminal.Core.Point contactPoint);\r\n \r\n-        void PointerMoved(MouseButtonState buttonState,\r\n-                          UInt32 pointerUpdateKind,\r\n-                          Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n-                          Boolean focused,\r\n-                          Microsoft.Terminal.Core.Point pixelPosition,\r\n-                          Boolean pointerPressedInBounds);\r\n+        Boolean PointerMoved(MouseButtonState buttonState,\r\n+                             UInt32 pointerUpdateKind,\r\n+                             Microsoft.Terminal.Core.ControlKeyStates modifiers,\r\n+                             Boolean focused,\r\n+                             Microsoft.Terminal.Core.Point pixelPosition,\r\n+                             Boolean pointerPressedInBounds);\r\n \r\n         void TouchMoved(Microsoft.Terminal.Core.Point newTouchPoint,\r\n                         Boolean focused);\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..f6874c35e75 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -1910,18 +1910,18 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         if (type == Windows::Devices::Input::PointerDeviceType::Mouse ||\r\n             type == Windows::Devices::Input::PointerDeviceType::Pen)\r\n         {\r\n-            _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n-                                        TermControl::GetPointerUpdateKind(point),\r\n-                                        ControlKeyStates(args.KeyModifiers()),\r\n-                                        _focused,\r\n-                                        pixelPosition.to_core_point(),\r\n-                                        _pointerPressedInBounds);\r\n+            auto suppressFurtherHandling = _interactivity.PointerMoved(TermControl::GetPressedMouseButtons(point),\r\n+                                                                       TermControl::GetPointerUpdateKind(point),\r\n+                                                                       ControlKeyStates(args.KeyModifiers()),\r\n+                                                                       _focused,\r\n+                                                                       pixelPosition.to_core_point(),\r\n+                                                                       _pointerPressedInBounds);\r\n \r\n             // GH#9109 - Only start an auto-scroll when the drag actually\r\n             // started within our bounds. Otherwise, someone could start a drag\r\n             // outside the terminal control, drag into the padding, and trick us\r\n             // into starting to scroll.\r\n-            if (_focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n+            if (!suppressFurtherHandling && _focused && _pointerPressedInBounds && point.Properties().IsLeftButtonPressed())\r\n             {\r\n                 // We want to find the distance relative to the bounds of the\r\n                 // SwapChainPanel, not the entire control. If they drag out of\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex a5d443b915a..49fcd6d21eb 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -998,16 +998,15 @@ namespace ControlUnitTests\n         VERIFY_IS_GREATER_THAN(core->ScrollOffset(), 0);\r\n \r\n         // Viewport is now above the mutable viewport, so the mouse event\r\n-        // straight up won't be sent to the terminal.\r\n+        // will be clamped to the top line.\r\n \r\n-        expectedOutput.push_back(L\"sentinel\"); // Clearly, it won't be this string\r\n+        expectedOutput.push_back(L\"\\x1b[M &!\"); // 5, 1\r\n         interactivity->PointerPressed(leftMouseDown,\r\n                                       WM_LBUTTONDOWN, //pointerUpdateKind\r\n                                       0, // timestamp\r\n                                       modifiers,\r\n                                       cursorPosition0.to_core_point());\r\n         // Flush it out.\r\n-        conn->WriteInput(winrt_wstring_to_array_view(L\"sentinel\"));\r\n         VERIFY_ARE_EQUAL(0u, expectedOutput.size(), L\"Validate we drained all the expected output\");\r\n \r\n         // This is the part as mentioned in GH#12719\r\n", "instance_id": "microsoft__terminal-17779", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: mouse events are not being sent when the mouse is outside the top of the Windows Terminal (WT). It provides a specific version of the software, a reproducible test case via a GitHub repository, and a visual aid (GIF) to illustrate the issue. The expected behavior (mouse events should be sent regardless of position while the button is pressed) and actual behavior (events not sent when outside the top) are explicitly stated, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the problem does not specify whether this behavior is expected across different Windows versions or configurations, nor does it mention potential edge cases like multi-monitor setups or specific mouse hardware. Additionally, constraints or requirements for the fix (e.g., performance considerations or compatibility with existing features) are not provided. These omissions prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes involves multiple files (ControlInteractivity.cpp, ControlInteractivity.h, ControlInteractivity.idl, TermControl.cpp, and unit tests), indicating a need to understand interactions between different components of the Windows Terminal codebase. The changes are not trivial; they modify the behavior of mouse event handling by adjusting how events are processed and sent, including changing the return type of a method (PointerMoved) to indicate whether further processing is needed. This requires a moderate understanding of the terminal's event handling architecture.\n\nSecond, the technical concepts involved include familiarity with C++ (specifically modern C++ with WinRT), Windows API for mouse input handling, and the internal logic of the Windows Terminal's control interactivity system. While these are not extremely advanced topics, they do require specific domain knowledge of GUI event systems and terminal emulation, which adds to the complexity.\n\nThird, the problem touches on edge cases, such as ensuring mouse events are correctly handled outside the visible bounds of the terminal. The code changes suggest a need to handle or clamp coordinates (e.g., adjusting Y position based on scroll offset), which introduces moderate complexity in ensuring correctness across various scenarios. However, the problem does not appear to involve deep architectural refactoring or performance-critical optimizations, nor does it require advanced algorithms or system-level programming.\n\nFinally, the impact of the changes is localized to the mouse event handling logic and does not seem to affect the broader system architecture significantly. The amount of code changed is relatively small but meaningful, requiring careful testing (as evidenced by updates to unit tests). Balancing these factors, a difficulty score of 0.55 reflects a medium-level challenge that demands a solid understanding of the codebase and careful handling of event logic, but does not reach the level of hard or very hard due to the absence of broader systemic impact or highly intricate logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RangeFromPoint and ExpandToEnclosingUnit freezes terminal\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\nhttps://github.com/yinkaisheng/Python-UIAutomation-for-Windows 2.0.19\n\n### Steps to reproduce\n\n```python\r\nimport uiautomation as auto\r\nimport time\r\nimport typing\r\ntime.sleep(5)\r\n[x,y] = auto.GetCursorPos()\r\nc = auto.ControlFromPoint(x,y)\r\nif text_pattern := typing.cast(auto.TextPattern | None, c.GetPattern(auto.PatternId.TextPattern)):\r\n    if r := text_pattern.RangeFromPoint(x,y):\r\n        r.ExpandToEnclosingUnit(auto.TextUnit.Word)\r\n        print(r.GetText())\r\n```\r\nPut the cursor over a terminal window\n\n### Expected Behavior\n\nI get the word under the cursor.\n\n### Actual Behavior\n\nWindows terminals freezes. This program works fine with other software so I don't think the bug is in UIAutomation.\n", "patch": "diff --git a/src/interactivity/win32/uiaTextRange.cpp b/src/interactivity/win32/uiaTextRange.cpp\nindex eb78d090cfc..028e181b383 100644\n--- a/src/interactivity/win32/uiaTextRange.cpp\n+++ b/src/interactivity/win32/uiaTextRange.cpp\n@@ -69,14 +69,14 @@ IFACEMETHODIMP UiaTextRange::Clone(_Outptr_result_maybenull_ ITextRangeProvider*\n     return S_OK;\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void UiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n-    ClientToScreen(_getWindowHandle(), clientPoint->as_win32_point());\r\n+    ClientToScreen(_getWindowHandle(), clientPoint.as_win32_point());\r\n }\r\n \r\n-void UiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void UiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n-    ScreenToClient(_getWindowHandle(), screenPoint->as_win32_point());\r\n+    ScreenToClient(_getWindowHandle(), screenPoint.as_win32_point());\r\n }\r\n \r\n HWND UiaTextRange::_getWindowHandle() const\r\ndiff --git a/src/interactivity/win32/uiaTextRange.hpp b/src/interactivity/win32/uiaTextRange.hpp\nindex 7ea79364d5d..84f8b5a5392 100644\n--- a/src/interactivity/win32/uiaTextRange.hpp\n+++ b/src/interactivity/win32/uiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Console::Interactivity::Win32\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n \r\n     private:\r\n         HWND _getWindowHandle() const;\r\ndiff --git a/src/types/TermControlUiaTextRange.cpp b/src/types/TermControlUiaTextRange.cpp\nindex 6f3c82e8180..5b26dd5189d 100644\n--- a/src/types/TermControlUiaTextRange.cpp\n+++ b/src/types/TermControlUiaTextRange.cpp\n@@ -73,7 +73,7 @@ IFACEMETHODIMP TermControlUiaTextRange::Clone(_Outptr_result_maybenull_ ITextRan\n //                (0,0) is the top-left of the app window\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointToScreen(til::point& clientPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n@@ -96,8 +96,8 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    clientPoint->x = includeOffsets(clientPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    clientPoint->y = includeOffsets(clientPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    clientPoint.x = includeOffsets(clientPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    clientPoint.y = includeOffsets(clientPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n // Method Description:\r\n@@ -107,15 +107,13 @@ void TermControlUiaTextRange::_TranslatePointToScreen(til::point* clientPoint) c\n //                (0,0) is the top-left of the screen\r\n // Return Value:\r\n // - <none>\r\n-void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint) const\r\n+void TermControlUiaTextRange::_TranslatePointFromScreen(til::point& screenPoint) const\r\n {\r\n     const gsl::not_null<TermControlUiaProvider*> provider = static_cast<TermControlUiaProvider*>(_pProvider);\r\n \r\n     const auto includeOffsets = [](long screenPos, double termControlPos, double padding, double scaleFactor) {\r\n-        auto result = base::ClampedNumeric<double>(padding);\r\n-        // only the padding is in DIPs now\r\n-        result /= scaleFactor;\r\n-        result -= screenPos;\r\n+        auto result = base::ClampedNumeric<til::CoordType>(screenPos);\r\n+        result -= padding / scaleFactor;\r\n         result -= termControlPos;\r\n         return result;\r\n     };\r\n@@ -130,8 +128,8 @@ void TermControlUiaTextRange::_TranslatePointFromScreen(til::point* screenPoint)\n     // Get scale factor for display\r\n     const auto scaleFactor = provider->GetScaleFactor();\r\n \r\n-    screenPoint->x = includeOffsets(screenPoint->x, boundingRect.left, padding.left, scaleFactor);\r\n-    screenPoint->y = includeOffsets(screenPoint->y, boundingRect.top, padding.top, scaleFactor);\r\n+    screenPoint.x = includeOffsets(screenPoint.x, boundingRect.left, padding.left, scaleFactor);\r\n+    screenPoint.y = includeOffsets(screenPoint.y, boundingRect.top, padding.top, scaleFactor);\r\n }\r\n \r\n til::size TermControlUiaTextRange::_getScreenFontSize() const noexcept\r\ndiff --git a/src/types/TermControlUiaTextRange.hpp b/src/types/TermControlUiaTextRange.hpp\nindex 70ba9cac979..e619583a9e9 100644\n--- a/src/types/TermControlUiaTextRange.hpp\n+++ b/src/types/TermControlUiaTextRange.hpp\n@@ -56,8 +56,8 @@ namespace Microsoft::Terminal\n         IFACEMETHODIMP Clone(_Outptr_result_maybenull_ ITextRangeProvider** ppRetVal) override;\r\n \r\n     protected:\r\n-        void _TranslatePointToScreen(til::point* clientPoint) const override;\r\n-        void _TranslatePointFromScreen(til::point* screenPoint) const override;\r\n+        void _TranslatePointToScreen(til::point& clientPoint) const override;\r\n+        void _TranslatePointFromScreen(til::point& screenPoint) const override;\r\n         til::size _getScreenFontSize() const noexcept override;\r\n     };\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 8e83ef47aa0..0ce958e6985 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -97,30 +97,24 @@ CATCH_RETURN();\n \r\n void UiaTextRangeBase::Initialize(_In_ const UiaPoint point)\r\n {\r\n-    til::point clientPoint;\r\n-    clientPoint.x = static_cast<LONG>(point.x);\r\n-    clientPoint.y = static_cast<LONG>(point.y);\r\n-    // get row that point resides in\r\n+    til::point clientPoint{ static_cast<til::CoordType>(point.x), static_cast<til::CoordType>(point.y) };\r\n+\r\n+    // clamp the point to be within the client area\r\n     const auto windowRect = _getTerminalRect();\r\n+    clientPoint.x = std::clamp(clientPoint.x, windowRect.left, windowRect.right);\r\n+    clientPoint.y = std::clamp(clientPoint.y, windowRect.top, windowRect.bottom);\r\n+\r\n+    // convert point to be relative to client area\r\n+    _TranslatePointFromScreen(clientPoint);\r\n+\r\n+    // convert the point to screen buffer coordinates\r\n+    _pData->LockConsole();\r\n+    const auto currentFontSize = _getScreenFontSize();\r\n     const auto viewport = _pData->GetViewport().ToInclusive();\r\n-    til::CoordType row = 0;\r\n-    if (clientPoint.y <= windowRect.top)\r\n-    {\r\n-        row = viewport.top;\r\n-    }\r\n-    else if (clientPoint.y >= windowRect.bottom)\r\n-    {\r\n-        row = viewport.bottom;\r\n-    }\r\n-    else\r\n-    {\r\n-        // change point coords to pixels relative to window\r\n-        _TranslatePointFromScreen(&clientPoint);\r\n+    _pData->UnlockConsole();\r\n \r\n-        const auto currentFontSize = _getScreenFontSize();\r\n-        row = clientPoint.y / currentFontSize.height + viewport.top;\r\n-    }\r\n-    _start = { 0, row };\r\n+    _start = { clientPoint.x / currentFontSize.width + viewport.left,\r\n+               clientPoint.y / currentFontSize.height + viewport.top };\r\n     _end = _start;\r\n }\r\n \r\n@@ -1381,8 +1375,8 @@ void UiaTextRangeBase::_getBoundingRect(const til::rect& textRect, _Inout_ std::\n \r\n     // convert the coords to be relative to the screen instead of\r\n     // the client window\r\n-    _TranslatePointToScreen(&topLeft);\r\n-    _TranslatePointToScreen(&bottomRight);\r\n+    _TranslatePointToScreen(topLeft);\r\n+    _TranslatePointToScreen(bottomRight);\r\n \r\n     const long width = bottomRight.x - topLeft.x;\r\n     const long height = bottomRight.y - topLeft.y;\r\ndiff --git a/src/types/UiaTextRangeBase.hpp b/src/types/UiaTextRangeBase.hpp\nindex eec30a3dcbd..2b36ccc0efa 100644\n--- a/src/types/UiaTextRangeBase.hpp\n+++ b/src/types/UiaTextRangeBase.hpp\n@@ -123,8 +123,8 @@ namespace Microsoft::Console::Types\n         std::wstring _wordDelimiters{};\r\n         ::Search _searcher;\r\n \r\n-        virtual void _TranslatePointToScreen(til::point* clientPoint) const = 0;\r\n-        virtual void _TranslatePointFromScreen(til::point* screenPoint) const = 0;\r\n+        virtual void _TranslatePointToScreen(til::point& clientPoint) const = 0;\r\n+        virtual void _TranslatePointFromScreen(til::point& screenPoint) const = 0;\r\n \r\n         void Initialize(_In_ const UiaPoint point);\r\n \r\n", "instance_id": "microsoft__terminal-17695", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Windows Terminal freezes when using the `RangeFromPoint` and `ExpandToEnclosingUnit` functions from the UIAutomation library to retrieve text under the cursor. It provides a reproducible code snippet, specifies the software versions involved, and contrasts the behavior with other software to isolate the issue to Windows Terminal. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether the freeze is consistent across different terminal configurations or content, nor does it specify if there are any error messages or logs that could provide additional context. Additionally, edge cases (e.g., cursor at terminal boundaries, different text content) are not discussed, which could be relevant for a comprehensive understanding of the issue. Despite these minor gaps, the statement is actionable and provides enough information to start investigating the issue, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`uiaTextRange.cpp`, `uiaTextRange.hpp`, `TermControlUiaTextRange.cpp`, `TermControlUiaTextRange.hpp`, `UiaTextRangeBase.cpp`, and `UiaTextRangeBase.hpp`), indicating a need to understand and modify interactions across different components of the Windows Terminal's UIA (UI Automation) implementation. The changes primarily involve altering function signatures to use references instead of pointers for `til::point` and adjusting coordinate transformation logic, which suggests a bug fix related to how points are translated between screen and client coordinates. This requires a deep understanding of Windows API functions like `ClientToScreen` and `ScreenToClient`, as well as domain-specific knowledge of UI Automation and text range handling in a terminal context. Additionally, the modifications in `UiaTextRangeBase.cpp` (e.g., clamping coordinates and adjusting initialization logic) indicate a need to handle edge cases such as points outside the client area, which adds complexity to the solution. While the changes do not appear to impact the overall system architecture significantly, they do require careful consideration of coordinate systems, scaling factors, and potential side effects on text selection or rendering. The number of technical concepts involved—UI Automation, Windows API, coordinate transformations, and terminal-specific rendering—further elevates the difficulty. However, it does not reach the \"Very Hard\" category (0.8-1.0) as it does not involve system-level redesign or highly intricate algorithms. Thus, a score of 0.65 reflects the challenging nature of understanding and modifying a specialized part of the codebase with moderate complexity in edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "bug: doctest::String::substr() off by one at the end\n## Description\r\n\r\n`doctest::String::substr()` cuts short the last character, when extracting from the end of the `String`.\r\n\r\n\r\n### Steps to reproduce\r\n\r\n```\r\n#include <doctest/doctest.h>\r\n\r\nTEST_SUITE(\"doctest unit tests\") {\r\n    TEST_CASE(\"doctest::String::substr()\") {\r\n        const doctest::String abcde = \"abcde\";\r\n        CHECK(abcde.substr(0, 3) == \"abc\");\r\n        CHECK(abcde.substr(2, 3) == \"cde\");\r\n        CHECK(abcde.substr(0, 5) == \"abcde\");\r\n    }\r\n}\r\n```\r\n\r\n```\r\n===============================================================================\r\ncheck_doctest_string.cpp(0):\r\nTEST SUITE: doctest unit tests\r\nTEST CASE:  doctest::String::substr()\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(2, 3) == \"cde\" ) is NOT correct!\r\n  values: CHECK( cd == cde )\r\n\r\ncheck_doctest_string.cpp(0): ERROR: CHECK( abcde.substr(0, 5) == \"abcde\" ) is NOT correct!\r\n  values: CHECK( abcd == abcde )\r\n\r\n===============================================================================\r\n```\r\n\r\n\r\n### Extra information\r\n\r\n* doctest version: **v2.4.9** ... v2.4.11\r\n* Operating System: **22.04.1-Ubuntu**\r\n* Compiler+version: **GCC 12.3.0 x86_64**\r\n\n", "patch": "diff --git a/examples/all_features/CMakeLists.txt b/examples/all_features/CMakeLists.txt\nindex 19436c549..7b6277007 100644\n--- a/examples/all_features/CMakeLists.txt\n+++ b/examples/all_features/CMakeLists.txt\n@@ -9,6 +9,7 @@ set(files_with_output\n     alternative_macros.cpp\n     assertion_macros.cpp\n     stringification.cpp\n+    check_doctest_string.cpp\n     double_stringification.cpp\n     reporters_and_listeners.cpp\n     subcases.cpp\n", "instance_id": "doctest__doctest-881", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear, as it identifies a specific bug in the `doctest::String::substr()` method, provides reproducible test cases, and includes the expected versus actual output. The description of the issue (cutting short the last character when extracting from the end) is straightforward, and the steps to reproduce are well-documented with code and error output. However, there are minor ambiguities: the problem statement does not explicitly discuss edge cases beyond the provided test cases (e.g., empty strings, negative indices, or out-of-bounds conditions), nor does it specify if the fix should account for performance implications or compatibility with other parts of the library. Additionally, constraints or requirements for the solution (e.g., maintaining API compatibility) are not mentioned. Thus, while the core issue is clear, some minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4). The issue is a bug in the `doctest::String::substr()` method, likely involving an off-by-one error in the substring extraction logic, which is a common and relatively straightforward issue to debug and fix. The scope of the code changes appears limited, as the provided diff only shows the addition of a test file (`check_doctest_string.cpp`) to the build system, implying that the actual fix will likely be localized to the implementation of `substr()` in a single file or module. The technical concepts required are basic: understanding string manipulation, indexing, and boundary conditions in C++, along with familiarity with the doctest framework for testing. No advanced algorithms, design patterns, or system architecture changes are indicated. Edge cases are partially covered in the test cases provided (e.g., extracting from the start, middle, and end of the string), but additional edge cases like empty strings or invalid inputs may need to be considered, though these are not complex to handle. Overall, this problem requires understanding some code logic and making a simple modification, likely adjusting index calculations or bounds checking, which aligns with a difficulty score of 0.30.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Prevent unnecessary `VACUUM` executions for SQLite3 `stats` database\n## Description\n\nWhile profiling several queries commonly received by Admin targeting `stats` database, like queries from other `ProxySQL` instances regarding `Cluster`, it was found that one of the biggest contributions to CPU utilization for serving those queries is a `VACUUM` that is performed after the query execution.\n\nMany times this `VACUUM` is performed after queries that are idempotent on tables that won't benefit at all of this subsequent operation. This is an extract of a `perf` report:\n\n- Query: `SELECT Variable_Name, Variable_Value FROM stats_mysql_global`\n- Report extract:\n  ```\n  -   88.56%     0.01%  Admin            proxysql              [.] void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n     - 88.55% void admin_session_handler<MySQL_Session>(MySQL_Session*, void*, _PtrSize_t*)\n        + 45.64% ProxySQL_Admin::vacuum_stats(bool)\n        + 32.01% SQLite3DB::execute_statement(char const*, char**, int*, int*, SQLite3_result**)\n        + 9.94% ProxySQL_Admin::GenericRefreshStatistics(char const*, unsigned int, bool)\n        + 0.87% SQLite3_result::~SQLite3_result()\n  ```\n\nThese `VACUUM` operations should be more selective, or performed when the database is going to benefit of the operation.\n", "patch": "diff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex 41c21783f..38b2c954c 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -4048,7 +4048,7 @@ int MySQL_Session::get_pkts_from_client(bool& wrong_pass, PtrSize_t& pkt) {\n \t\t\t\t\t\t\t\t\tconst uint32_t recv_query_sz { pkt.size - 5 };\n \n \t\t\t\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_MYSQL_COM, 5, \"Processing received query\"\n-\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=%s query=%.*s\\n\",\n+\t\t\t\t\t\t\t\t\t\t\"   session=%p session_type=%d schemaname=\\\"%s\\\" query=\\\"%.*s\\\"\\n\",\n \t\t\t\t\t\t\t\t\t\tthis, session_type, schemaname ? schemaname : \"\", recv_query_sz, recv_query\n \t\t\t\t\t\t\t\t\t);\n \t\t\t\t\t\t\t\t}\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex af6b7bb87..88890c456 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -1682,20 +1682,24 @@ bool ProxySQL_Admin::GenericRefreshStatistics(const char *query_no_space, unsign\n \t\t}\n \t\t//pthread_mutex_unlock(&admin_mutex);\n \t}\n-\tif (\n-\t\tstats_mysql_processlist || stats_mysql_connection_pool || stats_mysql_connection_pool_reset ||\n-\t\tstats_mysql_query_digest || stats_mysql_query_digest_reset || stats_mysql_errors ||\n-\t\tstats_mysql_errors_reset || stats_mysql_global || stats_memory_metrics || \n-\t\tstats_mysql_commands_counters || stats_mysql_query_rules || stats_mysql_users ||\n-\t\tstats_mysql_gtid_executed || stats_mysql_free_connections || \n-\t\tstats_pgsql_global || stats_pgsql_connection_pool || stats_pgsql_connection_pool_reset ||\n-\t\tstats_pgsql_free_connections || stats_pgsql_users || stats_pgsql_processlist ||\n-\t\tstats_pgsql_errors || stats_pgsql_errors_reset || stats_pgsql_query_rules || stats_pgsql_commands_counters ||\n-\t\tstats_pgsql_query_digest || stats_pgsql_query_digest_reset\n-\t) {\n-\t\tret = true;\n+\n+\tint freelist_count = statsdb->return_one_int(\"PRAGMA freelist_count\");\n+\tif (freelist_count < 1000) {\n+\t\tret = false;\n+\t} else {\n+\t\tint page_count  = statsdb->return_one_int(\"PRAGMA page_count\");\n+\t\tret = (freelist_count * 100 / page_count) > 20;\n+\n+#ifdef DEBUG\n+\t\tif (ret) {\n+\t\t\tproxy_debug(PROXY_DEBUG_ADMIN, 4,\n+\t\t\t\t\"VACUUM required for 'stats_db'   page_count=%d freelist_count=%d\\n\",\n+\t\t\t\tpage_count, freelist_count\n+\t\t\t);\n+\t\t}\n+#endif\n \t}\n-\t\n+\n \treturn ret;\n }\n \ndiff --git a/lib/ProxySQL_Admin_Stats.cpp b/lib/ProxySQL_Admin_Stats.cpp\nindex 6de28f52f..c6b477f93 100644\n--- a/lib/ProxySQL_Admin_Stats.cpp\n+++ b/lib/ProxySQL_Admin_Stats.cpp\n@@ -428,163 +428,170 @@ void ProxySQL_Admin::p_update_stmt_metrics() {\n \t}\n }\n \n+using row_bind_t = void (*)(int offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row);\n+\n+void sqlite3_bulk_step(\n+\tSQLite3DB* db,\n+\tsqlite3_stmt* row_stmt,\n+\tsqlite3_stmt* bulk_stmt,\n+\tSQLite3_result* resultset,\n+\trow_bind_t row_bind\n+) {\n+\tint max_bulk_row_idx = resultset->rows_count / 32;\n+\tmax_bulk_row_idx = max_bulk_row_idx * 32;\n+\n+\tint rc = 0;\n+\tint row_idx = 0;\n+\n+\tfor (SQLite3_row* row : resultset->rows) {\n+\t\tint e_idx = row_idx % 32;\n+\n+\t\tif (row_idx < max_bulk_row_idx) {\n+\t\t\trow_bind(e_idx, db, bulk_stmt, row);\n+\n+\t\t\tif (e_idx == 31) {\n+\t\t\t\tSAFE_SQLITE3_STEP2(bulk_stmt);\n+\t\t\t\trc = (*proxy_sqlite3_clear_bindings)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t\trc = (*proxy_sqlite3_reset)(bulk_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\t}\n+\t\t} else {\n+\t\t\trow_bind(0, db, row_stmt, row);\n+\n+\t\t\tSAFE_SQLITE3_STEP2(row_stmt);\n+\t\t\trc = (*proxy_sqlite3_clear_bindings)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t\trc = (*proxy_sqlite3_reset)(row_stmt); ASSERT_SQLITE_OK(rc, db);\n+\t\t}\n+\n+\t\trow_idx += 1;\n+\t}\n+}\n+\n+void stats_mysql_global___bind_row(\n+\tint offset, SQLite3DB* db, sqlite3_stmt* stmt, SQLite3_row* row\n+) {\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 1, row->fields[0], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, (offset * 2) + 2, row->fields[1], -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+}\n+\n+template <class...> constexpr std::false_type always_false {};\n+\n+template <typename T>\n+const void sqlite3_global_stats_row_step(\n+\tSQLite3DB* db, sqlite3_stmt* stmt, const char* name, T val\n+) {\n+\tchar buf[32] = { 0 };\n+\n+\tif constexpr (std::is_same_v<T, int32_t>)  {\n+\t\tsprintf(buf, \"%d\", val);\n+\t} else if constexpr (std::is_same_v<T, uint64_t>) {\n+\t\tsprintf(buf, \"%lu\", val);\n+\t} else if constexpr (std::is_same_v<T, unsigned long long>) {\n+\t\tsprintf(buf, \"%llu\", val);\n+\t} else if constexpr (std::is_same_v<T, bool>) {\n+\t\tsprintf(buf, \"%s\", val ? \"true\" : \"false\");\n+\t} else {\n+\t\tstatic_assert(always_false<T>, \"Non-exhaustive switch\");\n+\t}\n+\n+\tint rc = (*proxy_sqlite3_bind_text)(stmt, 1, name, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_bind_text)(stmt, 2, buf, -1, SQLITE_TRANSIENT);\n+\tASSERT_SQLITE_OK(rc, db);\n+\n+\tSAFE_SQLITE3_STEP2(stmt);\n+\trc = (*proxy_sqlite3_clear_bindings)(stmt); ASSERT_SQLITE_OK(rc, db);\n+\trc = (*proxy_sqlite3_reset)(stmt); ASSERT_SQLITE_OK(rc, db);\n+};\n+\n void ProxySQL_Admin::stats___mysql_global() {\n \tif (!GloMTH) return;\n \tSQLite3_result * resultset=GloMTH->SQL3_GlobalStatus(true);\n \tif (resultset==NULL) return;\n+\n \tstatsdb->execute(\"BEGIN\");\n \tstatsdb->execute(\"DELETE FROM stats_mysql_global\");\n-\tchar *a=(char *)\"INSERT INTO stats_mysql_global VALUES (\\\"%s\\\",\\\"%s\\\")\";\n-\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\tSQLite3_row *r=*it;\n-\t\tint arg_len=0;\n-\t\tfor (int i=0; i<2; i++) {\n-\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t}\n-\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n+\n+\tconst string q_row_insert { \"INSERT INTO stats_mysql_global VALUES (?1, ?2)\" };\n+\tconst string q_bulk_insert {\n+\t\t\"INSERT INTO stats_mysql_global VALUES \" + generate_multi_rows_query(32, 2)\n+\t};\n+\n+\tsqlite3_stmt* row_stmt = nullptr;\n+\tint rc = statsdb->prepare_v2(q_row_insert.c_str(), &row_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\tsqlite3_stmt* bulk_stmt = nullptr;\n+\trc = statsdb->prepare_v2(q_bulk_insert.c_str(), &bulk_stmt);\n+\tASSERT_SQLITE_OK(rc, statsdb);\n+\n+\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n+\n \tdelete resultset;\n \tresultset=NULL;\n \n \tresultset=MyHGM->SQL3_Get_ConnPool_Stats();\n+\n \tif (resultset) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n-\tint highwater;\n-\tint current;\n-\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n-\tchar bu[32];\n-\tchar *vn=NULL;\n-\tchar *query=NULL;\n-\tvn=(char *)\"SQLite3_memory_bytes\";\n-\tsprintf(bu,\"%d\",current);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tint highwater, current = 0;\n+\t\t(*proxy_sqlite3_status)(SQLITE_STATUS_MEMORY_USED, &current, &highwater, 0);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"SQLite3_memory_bytes\", current);\n+\t}\n \n-\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n-\tvn=(char *)\"ConnPool_memory_bytes\";\n-\tsprintf(bu,\"%llu\",connpool_mem);\n-\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\tsprintf(query,a,vn,bu);\n-\tstatsdb->execute(query);\n-\tfree(query);\n+\t{\n+\t\tunsigned long long connpool_mem=MyHGM->Get_Memory_Stats();\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"ConnPool_memory_bytes\", connpool_mem);\n+\t}\n \n \tif (GloMyStmt) {\n-\t\tuint64_t stmt_client_active_unique = 0;\n-\t\tuint64_t stmt_client_active_total = 0;\n-\t\tuint64_t stmt_max_stmt_id = 0;\n-\t\tuint64_t stmt_cached = 0;\n-\t\tuint64_t stmt_server_active_unique = 0;\n-\t\tuint64_t stmt_server_active_total = 0;\n-\t\tGloMyStmt->get_metrics(&stmt_client_active_unique,&stmt_client_active_total,&stmt_max_stmt_id,&stmt_cached,&stmt_server_active_unique,&stmt_server_active_total);\n-\t\tvn=(char *)\"Stmt_Client_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Client_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_client_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Total\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_total);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Server_Active_Unique\";\n-\t\tsprintf(bu,\"%lu\",stmt_server_active_unique);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Max_Stmt_id\";\n-\t\tsprintf(bu,\"%lu\",stmt_max_stmt_id);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t\tvn=(char *)\"Stmt_Cached\";\n-\t\tsprintf(bu,\"%lu\",stmt_cached);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tuint64_t client_active_unique = 0;\n+\t\tuint64_t client_active_total = 0;\n+\t\tuint64_t max_stmt_id = 0;\n+\t\tuint64_t cached = 0;\n+\t\tuint64_t server_active_unique = 0;\n+\t\tuint64_t server_active_total = 0;\n+\n+\t\tGloMyStmt->get_metrics(\n+\t\t\t&client_active_unique,\n+\t\t\t&client_active_total,\n+\t\t\t&max_stmt_id,\n+\t\t\t&cached,\n+\t\t\t&server_active_unique,\n+\t\t\t&server_active_total\n+\t\t);\n+\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Total\", client_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Client_Active_Unique\", client_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Total\", server_active_total);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Server_Active_Unique\", server_active_unique);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Max_Stmt_id\", max_stmt_id);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"Stmt_Cached\", cached);\n \t}\n \n \tif (GloMyQC && (resultset= GloMyQC->SQL3_getStats())) {\n-\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\tSQLite3_row *r=*it;\n-\t\t\tint arg_len=0;\n-\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t}\n-\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\tstatsdb->execute(query);\n-\t\t\tfree(query);\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t\tdelete resultset;\n \t\tresultset=NULL;\n \t}\n \n \tif (GloMyLdapAuth) {\n \t\tresultset=GloMyLdapAuth->SQL3_getStats();\n-\t\tif (resultset) {\n-\t\t\tfor (std::vector<SQLite3_row *>::iterator it = resultset->rows.begin() ; it != resultset->rows.end(); ++it) {\n-\t\t\t\tSQLite3_row *r=*it;\n-\t\t\t\tint arg_len=0;\n-\t\t\t\tfor (int i=0; i<2; i++) {\n-\t\t\t\t\targ_len+=strlen(r->fields[i]);\n-\t\t\t\t}\n-\t\t\t\tchar *query=(char *)malloc(strlen(a)+arg_len+32);\n-\t\t\t\tsprintf(query,a,r->fields[0],r->fields[1]);\n-\t\t\t\tstatsdb->execute(query);\n-\t\t\t\tfree(query);\n-\t\t\t}\n-\t\t\tdelete resultset;\n-\t\t\tresultset=NULL;\n-\t\t}\n+\t\tsqlite3_bulk_step(statsdb, row_stmt, bulk_stmt, resultset, stats_mysql_global___bind_row);\n \t}\n \n \tif (GloMyQPro) {\n \t\tunsigned long long mu = GloMyQPro->get_new_req_conns_count();\n-\t\tvn=(char *)\"new_req_conns_count\";\n-\t\tsprintf(bu,\"%llu\",mu);\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n-\t}\n-\t{\n-\t\tvn=(char *)\"mysql_listener_paused\";\n-\t\tsprintf(bu, \"%s\", ( admin_proxysql_mysql_paused==true ? \"true\" : \"false\") );\n-\t\tquery=(char *)malloc(strlen(a)+strlen(vn)+strlen(bu)+16);\n-\t\tsprintf(query,a,vn,bu);\n-\t\tstatsdb->execute(query);\n-\t\tfree(query);\n+\t\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"new_req_conns_count\", mu);\n \t}\n+\n+\tsqlite3_global_stats_row_step(statsdb, row_stmt, \"mysql_listener_paused\", admin_proxysql_mysql_paused);\n+\n \tstatsdb->execute(\"COMMIT\");\n }\n \n", "instance_id": "sysown__proxysql-4859", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the goal of preventing unnecessary `VACUUM` operations in a SQLite3 database used by ProxySQL for stats. It provides context about the performance issue (high CPU utilization due to frequent `VACUUM` calls) and includes a relevant excerpt from a performance report to illustrate the problem. The goal of making `VACUUM` operations more selective is stated, along with the observation that many queries are idempotent and do not benefit from `VACUUM`. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what constitutes a \"benefit\" for the database from a `VACUUM` operation, nor does it specify the criteria or thresholds for when a `VACUUM` should be performed. Additionally, edge cases or specific scenarios where `VACUUM` might still be necessary are not mentioned. While the intent is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves multiple files (`ProxySQL_Admin.cpp`, `ProxySQL_Admin_Stats.cpp`, and a minor debug log change in `MySQL_Session.cpp`), indicating a need to understand interactions between different parts of the codebase, particularly how the stats database is managed and queried. The primary change in `ProxySQL_Admin.cpp` introduces a heuristic for deciding when to perform a `VACUUM` based on `freelist_count` and `page_count`, which requires understanding SQLite internals (PRAGMA statements and database page management) and applying a logical threshold for optimization. This adds a layer of complexity beyond simple bug fixes. Additionally, the extensive refactoring in `ProxySQL_Admin_Stats.cpp` to optimize SQLite insertions using bulk operations and prepared statements demonstrates a need for proficiency in SQLite API usage, C++ template programming, and performance optimization techniques. While the changes do not appear to impact the overall system architecture significantly, they do require handling potential edge cases, such as ensuring the new `VACUUM` logic does not miss critical scenarios where database maintenance is needed, though these are not explicitly detailed in the problem statement. The number of technical concepts involved—SQLite database management, performance profiling, C++ programming patterns, and debugging—further contributes to the moderate difficulty. However, the problem does not reach the \"hard\" category as it does not involve deep architectural changes, complex algorithms, or advanced domain-specific knowledge beyond database optimization. A score of 0.55 reflects this balance of moderate complexity across multiple files and concepts, with manageable but non-trivial implementation challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1, "human_difficulty_modify_explanation": -1}
{"problem_statement": "FirebaseStorage.StorageError provides limited information\n### Description\r\n\r\nOne of my TestFlight users consistently gets an error when using the FirebaseStorage API:\r\n`StorageReference.writeAsync()`\r\n\r\nLogging this error provides little insights since the localizedDescription is\r\n`The operation couldn’t be completed. (FirebaseStorage.StorageError error 0.)`\r\n\r\nUnpacking the error case and logging the `.unknown(String)` produces\r\n`An unknown error occurred, please check the server response.`\r\n\r\nThe server response isn't on the error however since its lost when the Objective-C `NSError` is converted the Swift enum via `swiftConvert(objcError:)`.\r\n\r\nWould it be possible to instead make `StorageError` conform to [`CustomNSError`](https://developer.apple.com/documentation/foundation/customnserror) and expose the `userInfo` in Swift? Would love to debug this without rewriting a significant portion of my code in Objective-C.\r\n\r\n### Reproducing the issue\r\n\r\nTrying to figure this out myself.\r\n\r\n### Firebase SDK Version\r\n\r\n10.5.0\r\n\r\n### Xcode Version\r\n\r\n14.2\r\n\r\n### Installation Method\r\n\r\nSwift Package Manager\r\n\r\n### Firebase Product(s)\r\n\r\nStorage\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n```json\r\n{\r\n  \"pins\" : [\r\n    {\r\n      \"identity\" : \"abseil-cpp-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/abseil-cpp-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"583de9bd60f66b40e78d08599cc92036c2e7e4e1\",\r\n        \"version\" : \"0.20220203.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"boringssl-swiftpm\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/boringssl-SwiftPM.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"dd3eda2b05a3f459fc3073695ad1b28659066eab\",\r\n        \"version\" : \"0.9.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"firebase-ios-sdk\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/firebase-ios-sdk\",\r\n      \"state\" : {\r\n        \"revision\" : \"f567ed9a2b30e29159df258049a9c662c517688e\",\r\n        \"version\" : \"10.5.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleappmeasurement\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleAppMeasurement.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"9a09ece724128e8d1e14c5133b87c0e236844ac0\",\r\n        \"version\" : \"10.4.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googledatatransport\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleDataTransport.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"f6b558e3f801f2cac336b04f615ce111fa9ddaa0\",\r\n        \"version\" : \"9.2.1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"googleutilities\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/GoogleUtilities.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0543562f85620b5b7c510c6bcbef75b562a5127b\",\r\n        \"version\" : \"7.11.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"grpc-ios\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/grpc/grpc-ios.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"8440b914756e0d26d4f4d054a1c1581daedfc5b6\",\r\n        \"version\" : \"1.44.3-grpc\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"gtm-session-fetcher\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/gtm-session-fetcher.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"5ccda3981422a84186387dbb763ba739178b529c\",\r\n        \"version\" : \"2.3.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"leveldb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/leveldb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0706abcc6b0bd9cedfbb015ba840e4a780b5159b\",\r\n        \"version\" : \"1.22.2\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"mixpanel-swift\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/mixpanel/mixpanel-swift\",\r\n      \"state\" : {\r\n        \"branch\" : \"master\",\r\n        \"revision\" : \"dfc52c9155f2e42fb69f98a2370647d28d7eebe1\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"nanopb\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/firebase/nanopb.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"819d0a2173aff699fb8c364b6fb906f7cdb1a692\",\r\n        \"version\" : \"2.30909.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"promises\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/google/promises.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"ec957ccddbcc710ccc64c9dcbd4c7006fcf8b73a\",\r\n        \"version\" : \"2.2.0\"\r\n      }\r\n    },\r\n    {\r\n      \"identity\" : \"swift-protobuf\",\r\n      \"kind\" : \"remoteSourceControl\",\r\n      \"location\" : \"https://github.com/apple/swift-protobuf.git\",\r\n      \"state\" : {\r\n        \"revision\" : \"0af9125c4eae12a4973fb66574c53a54962a9e1e\",\r\n        \"version\" : \"1.21.0\"\r\n      }\r\n    }\r\n  ],\r\n  \"version\" : 2\r\n}\r\n```\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseStorage/CHANGELOG.md b/FirebaseStorage/CHANGELOG.md\nindex 1baafc4bbdb..1703f2ae829 100644\n--- a/FirebaseStorage/CHANGELOG.md\n+++ b/FirebaseStorage/CHANGELOG.md\n@@ -1,3 +1,9 @@\n+# 11.0.0\n+- [fixed] Updated error handling to support both Swift error enum handling and NSError error\n+  handling. Some of the Swift enums have additional parameters which may be a **breaking** change.\n+  There are additional NSError's for completeness, but nothing related to NSError handling is\n+  breaking. (#13071, #10889, #13114)\n+\n # 10.24.0\n - [fixed] `putFile` and `putFileAsync` now work in app extensions. A background session\n    configuration is not used when uploading from an app extension (#12579).\ndiff --git a/FirebaseStorage/Sources/AsyncAwait.swift b/FirebaseStorage/Sources/AsyncAwait.swift\nindex 8fffded0e18..e38a2525711 100644\n--- a/FirebaseStorage/Sources/AsyncAwait.swift\n+++ b/FirebaseStorage/Sources/AsyncAwait.swift\n@@ -66,7 +66,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putDataAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putDataAsync\")\n         ))\n       }\n     }\n@@ -103,7 +104,8 @@ public extension StorageReference {\n       }\n       uploadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in putFileAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in putFileAsync\")\n         ))\n       }\n     }\n@@ -137,7 +139,8 @@ public extension StorageReference {\n       }\n       downloadTask.observe(.failure) { snapshot in\n         continuation.resume(with: .failure(\n-          snapshot.error ?? StorageError.internalError(\"Internal Storage Error in writeAsync\")\n+          snapshot.error ?? StorageError\n+            .internalError(message: \"Internal Storage Error in writeAsync\")\n         ))\n       }\n     }\ndiff --git a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\nindex 2cca8acdca2..5fb5ca61ae1 100644\n--- a/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageGetDownloadURLTask.swift\n@@ -74,10 +74,10 @@ class StorageGetDownloadURLTask: StorageTask, StorageTaskManagement {\n              .jsonObject(with: data) as? [String: Any] {\n             downloadURL = self.downloadURLFromMetadataDictionary(responseDictionary)\n             if downloadURL == nil {\n-              self.error = NSError(domain: StorageErrorDomain,\n-                                   code: StorageErrorCode.unknown.rawValue,\n-                                   userInfo: [NSLocalizedDescriptionKey:\n-                                     \"Failed to retrieve a download URL.\"])\n+              self.error = StorageError.unknown(\n+                message: \"Failed to retrieve a download URL.\",\n+                serverError: [:]\n+              ) as NSError\n             }\n           } else {\n             self.error = StorageErrorCode.error(withInvalidRequest: data)\ndiff --git a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\nindex 217f8775116..bb195656cae 100644\n--- a/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n+++ b/FirebaseStorage/Sources/Internal/StorageTokenAuthorizer.swift\n@@ -45,12 +45,7 @@ class StorageTokenAuthorizer: NSObject, GTMSessionFetcherAuthorizer {\n           var errorDictionary = error.userInfo\n           errorDictionary[\"ResponseErrorDomain\"] = error.domain\n           errorDictionary[\"ResponseErrorCode\"] = error.code\n-          errorDictionary[NSLocalizedDescriptionKey] =\n-            \"User is not authenticated, please authenticate\" +\n-            \" using Firebase Authentication and try again.\"\n-          tokenError = NSError(domain: \"FIRStorageErrorDomain\",\n-                               code: StorageErrorCode.unauthenticated.rawValue,\n-                               userInfo: errorDictionary)\n+          tokenError = StorageError.unauthenticated(serverError: errorDictionary) as NSError\n         } else if let token {\n           let firebaseToken = \"Firebase \\(token)\"\n           request?.setValue(firebaseToken, forHTTPHeaderField: \"Authorization\")\ndiff --git a/FirebaseStorage/Sources/Result.swift b/FirebaseStorage/Sources/Result.swift\nindex 931794cbfb1..3a73da64f97 100644\n--- a/FirebaseStorage/Sources/Result.swift\n+++ b/FirebaseStorage/Sources/Result.swift\n@@ -29,9 +29,11 @@ private func getResultCallback<T>(completion: @escaping (Result<T, Error>) -> Vo\n     if let value {\n       completion(.success(value))\n     } else if let error {\n-      completion(.failure(StorageError.swiftConvert(objcError: error as NSError)))\n+      completion(.failure(error))\n     } else {\n-      completion(.failure(StorageError.internalError(\"Internal failure in getResultCallback\")))\n+      completion(.failure(StorageError.internalError(\n+        message: \"Internal failure in getResultCallback\"\n+      )))\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/Storage.swift b/FirebaseStorage/Sources/Storage.swift\nindex 3d547e28da3..09f211d3341 100644\n--- a/FirebaseStorage/Sources/Storage.swift\n+++ b/FirebaseStorage/Sources/Storage.swift\n@@ -193,9 +193,9 @@ import FirebaseCore\n     do {\n       path = try StoragePath.path(string: url.absoluteString)\n     } catch let StoragePathError.storagePathError(message) {\n-      throw StorageError.pathError(message)\n+      throw StorageError.pathError(message: message)\n     } catch {\n-      throw StorageError.pathError(\"Internal error finding StoragePath: \\(error)\")\n+      throw StorageError.pathError(message: \"Internal error finding StoragePath: \\(error)\")\n     }\n \n     // If no default bucket exists (empty string), accept anything.\n@@ -205,7 +205,7 @@ import FirebaseCore\n     // If there exists a default bucket, throw if provided a different bucket.\n     if path.bucket != storageBucket {\n       throw StorageError\n-        .bucketMismatch(\"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n+        .bucketMismatch(message: \"Provided bucket: `\\(path.bucket)` does not match the Storage \" +\n           \"bucket of the current instance: `\\(storageBucket)`\")\n     }\n     return StorageReference(storage: self, path: path)\ndiff --git a/FirebaseStorage/Sources/StorageDownloadTask.swift b/FirebaseStorage/Sources/StorageDownloadTask.swift\nindex 8f9f0332393..91629bd632b 100644\n--- a/FirebaseStorage/Sources/StorageDownloadTask.swift\n+++ b/FirebaseStorage/Sources/StorageDownloadTask.swift\n@@ -67,8 +67,7 @@ open class StorageDownloadTask: StorageObservableTask, StorageTaskManagement {\n    * Cancels a task.\n    */\n   @objc open func cancel() {\n-    let error = StorageErrorCode.error(withCode: .cancelled)\n-    cancel(withError: error)\n+    cancel(withError: StorageError.cancelled as NSError)\n   }\n \n   /**\ndiff --git a/FirebaseStorage/Sources/StorageError.swift b/FirebaseStorage/Sources/StorageError.swift\nindex d9e80dd31bd..f3e02340a2d 100644\n--- a/FirebaseStorage/Sources/StorageError.swift\n+++ b/FirebaseStorage/Sources/StorageError.swift\n@@ -36,24 +36,17 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n   case downloadSizeExceeded = -13032\n   case cancelled = -13040\n   case invalidArgument = -13050\n+  case bucketMismatch = -13051\n+  case internalError = -13052\n+  case pathError = -13053\n \n   /**\n-   * Creates a Firebase Storage error from a specific GCS error and FIRIMPLStorageReference.\n+   * Creates a Firebase Storage error from a specific GCS error and StorageReference.\n    * @param serverError Server error to wrap and return as a Firebase Storage error.\n    * @param ref StorageReference which provides context about the request being made.\n    * @return Returns a Firebase Storage error.\n    */\n   static func error(withServerError serverError: NSError, ref: StorageReference) -> NSError {\n-    var errorCode: StorageErrorCode\n-    switch serverError.code {\n-    case 400: errorCode = .unknown\n-    case 401: errorCode = .unauthenticated\n-    case 402: errorCode = .quotaExceeded\n-    case 403: errorCode = .unauthorized\n-    case 404: errorCode = .objectNotFound\n-    default: errorCode = .unknown\n-    }\n-\n     var errorDictionary = serverError.userInfo\n     errorDictionary[\"ResponseErrorDomain\"] = serverError.domain\n     errorDictionary[\"ResponseErrorCode\"] = serverError.code\n@@ -66,7 +59,29 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     if let data = (errorDictionary[\"data\"] as? Data) {\n       errorDictionary[\"ResponseBody\"] = String(data: data, encoding: .utf8)\n     }\n-    return error(withCode: errorCode, infoDictionary: errorDictionary)\n+    let storageError = switch serverError.code {\n+    case 400: StorageError.unknown(\n+        message: \"Unknown 400 error from backend\",\n+        serverError: errorDictionary\n+      )\n+    case 401: StorageError.unauthenticated(serverError: errorDictionary)\n+    case 402: StorageError.quotaExceeded(\n+        bucket: ref.path.bucket,\n+        serverError: errorDictionary\n+      )\n+    case 403: StorageError.unauthorized(\n+        bucket: ref.path.bucket,\n+        object: ref.path.object ?? \"<object-entity-internal-error>\",\n+        serverError: errorDictionary\n+      )\n+    case 404: StorageError.objectNotFound(\n+        object: ref.path.object ?? \"<object-entity-internal-error>\", serverError: errorDictionary\n+      )\n+    default: StorageError.unknown(\n+        message: \"Unexpected \\(serverError.code) code from backend\", serverError: errorDictionary\n+      )\n+    }\n+    return storageError as NSError\n   }\n \n   /** Creates a Firebase Storage error from an invalid request.\n@@ -81,143 +96,123 @@ public let StorageErrorDomain: String = \"FIRStorageErrorDomain\"\n     } else {\n       requestString = \"<nil request returned from server>\"\n     }\n-    let invalidDataString = \"Invalid data returned from the server:\\(requestString)\"\n-    return error(\n-      withCode: .unknown,\n-      infoDictionary: [NSLocalizedFailureErrorKey: invalidDataString]\n-    )\n+    let invalidDataString = \"Invalid data returned from the server: \\(requestString)\"\n+    return StorageError.unknown(message: invalidDataString, serverError: [:]) as NSError\n   }\n+}\n \n-  /**\n-   * Creates a Firebase Storage error from a specific FIRStorageErrorCode while adding\n-   * custom info from an optionally provided info dictionary.\n-   */\n-  static func error(withCode code: StorageErrorCode,\n-                    infoDictionary: [String: Any]? = nil) -> NSError {\n-    var dictionary = infoDictionary ?? [:]\n-    var errorMessage: String\n-    switch code {\n+/// Firebase Storage errors\n+public enum StorageError: Error, CustomNSError {\n+  case unknown(message: String, serverError: [String: Any])\n+  case objectNotFound(object: String, serverError: [String: Any])\n+  case bucketNotFound(bucket: String)\n+  case projectNotFound(project: String)\n+  case quotaExceeded(bucket: String, serverError: [String: Any])\n+  case unauthenticated(serverError: [String: Any])\n+  case unauthorized(bucket: String, object: String, serverError: [String: Any])\n+  case retryLimitExceeded\n+  case nonMatchingChecksum\n+  case downloadSizeExceeded(total: Int64, maxSize: Int64)\n+  case cancelled\n+  case invalidArgument(message: String)\n+  case internalError(message: String)\n+  case bucketMismatch(message: String)\n+  case pathError(message: String)\n+\n+  // MARK: - CustomNSError\n+\n+  /// Default domain of the error.\n+  public static var errorDomain: String { return StorageErrorDomain }\n+\n+  /// The error code within the given domain.\n+  public var errorCode: Int {\n+    switch self {\n+    case .unknown:\n+      return StorageErrorCode.unknown.rawValue\n     case .objectNotFound:\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"Object \\(object) does not exist.\"\n+      return StorageErrorCode.objectNotFound.rawValue\n     case .bucketNotFound:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage = \"Bucket \\(bucket) does not exist.\"\n+      return StorageErrorCode.bucketNotFound.rawValue\n     case .projectNotFound:\n-      let project = dictionary[\"project\"] ?? \"<project-entity-internal-error>\"\n-      errorMessage = \"Project \\(project) does not exist.\"\n+      return StorageErrorCode.projectNotFound.rawValue\n     case .quotaExceeded:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      errorMessage =\n-        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n-    case .downloadSizeExceeded:\n-      let total = \"\\(dictionary[\"totalSize\"] ?? \"unknown\")\"\n-      let size = \"\\(dictionary[\"maxAllowedSize\"] ?? \"unknown\")\"\n-      errorMessage = \"Attempted to download object with size of \\(total) bytes, \" +\n-        \"which exceeds the maximum size of \\(size) bytes. \" +\n-        \"Consider raising the maximum download size, or using StorageReference.write\"\n+      return StorageErrorCode.quotaExceeded.rawValue\n     case .unauthenticated:\n-      errorMessage = \"User is not authenticated, please authenticate using Firebase \" +\n-        \"Authentication and try again.\"\n+      return StorageErrorCode.unauthenticated.rawValue\n     case .unauthorized:\n-      let bucket = dictionary[\"bucket\"] ?? \"<bucket-entity-internal-error>\"\n-      let object = dictionary[\"object\"] ?? \"<object-entity-internal-error>\"\n-      errorMessage = \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return StorageErrorCode.unauthorized.rawValue\n     case .retryLimitExceeded:\n-      errorMessage = \"Max retry time for operation exceeded, please try again.\"\n+      return StorageErrorCode.retryLimitExceeded.rawValue\n     case .nonMatchingChecksum:\n-      // TODO: replace with actual checksum strings when we choose to implement.\n-      errorMessage = \"Uploaded/downloaded object TODO has checksum: TODO \" +\n-        \"which does not match server checksum: TODO. Please retry the upload/download.\"\n+      return StorageErrorCode.nonMatchingChecksum.rawValue\n+    case .downloadSizeExceeded:\n+      return StorageErrorCode.downloadSizeExceeded.rawValue\n     case .cancelled:\n-      errorMessage = \"User cancelled the upload/download.\"\n-    case .unknown, .invalidArgument: // invalidArgument fell through in the old Objective-C code.\n-      errorMessage = \"An unknown error occurred, please check the server response.\"\n+      return StorageErrorCode.cancelled.rawValue\n+    case .invalidArgument:\n+      return StorageErrorCode.invalidArgument.rawValue\n+    case .internalError:\n+      return StorageErrorCode.internalError.rawValue\n+    case .bucketMismatch:\n+      return StorageErrorCode.bucketMismatch.rawValue\n+    case .pathError:\n+      return StorageErrorCode.pathError.rawValue\n     }\n-    dictionary[NSLocalizedDescriptionKey] = errorMessage\n-    return NSError(domain: StorageErrorDomain, code: code.rawValue, userInfo: dictionary)\n   }\n-}\n-\n-public enum StorageError: Error {\n-  case unknown(String)\n-  case objectNotFound(String)\n-  case bucketNotFound(String)\n-  case projectNotFound(String)\n-  case quotaExceeded(String)\n-  case unauthenticated\n-  case unauthorized(String, String)\n-  case retryLimitExceeded\n-  case nonMatchingChecksum\n-  case downloadSizeExceeded(Int64, Int64)\n-  case cancelled\n-  case invalidArgument(String)\n-  case internalError(String)\n-  case bucketMismatch(String)\n-  case pathError(String)\n \n-  static func swiftConvert(objcError: NSError) -> StorageError {\n-    let userInfo = objcError.userInfo\n-\n-    switch objcError.code {\n-    case StorageErrorCode.unknown.rawValue:\n-      return StorageError.unknown(objcError.localizedDescription)\n-    case StorageErrorCode.objectNotFound.rawValue:\n-      guard let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode object not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.objectNotFound(object)\n-    case StorageErrorCode.bucketNotFound.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode bucket not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.bucketNotFound(bucket)\n-    case StorageErrorCode.projectNotFound.rawValue:\n-      guard let project = userInfo[\"project\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode project not found error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.projectNotFound(project)\n-    case StorageErrorCode.quotaExceeded.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String else {\n-        return StorageError\n-          .internalError(\"Failed to decode quota exceeded error: \\(objcError.localizedDescription)\")\n-      }\n-      return StorageError.quotaExceeded(bucket)\n-    case StorageErrorCode.unauthenticated.rawValue: return StorageError.unauthenticated\n-    case StorageErrorCode.unauthorized.rawValue:\n-      guard let bucket = userInfo[\"bucket\"] as? String,\n-            let object = userInfo[\"object\"] as? String else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode unauthorized error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.unauthorized(bucket, object)\n-    case StorageErrorCode.retryLimitExceeded.rawValue: return StorageError.retryLimitExceeded\n-    case StorageErrorCode.nonMatchingChecksum.rawValue: return StorageError\n-      .nonMatchingChecksum\n-    case StorageErrorCode.downloadSizeExceeded.rawValue:\n-      guard let total = userInfo[\"totalSize\"] as? Int64,\n-            let maxSize = userInfo[\"maxAllowedSize\"] as? Int64 else {\n-        return StorageError\n-          .internalError(\n-            \"Failed to decode downloadSizeExceeded error: \\(objcError.localizedDescription)\"\n-          )\n-      }\n-      return StorageError.downloadSizeExceeded(total, maxSize)\n-    case StorageErrorCode.cancelled.rawValue: return StorageError.cancelled\n-    case StorageErrorCode.invalidArgument.rawValue: return StorageError\n-      .invalidArgument(objcError.localizedDescription)\n-    default: return StorageError.internalError(\"Internal error converting ObjC Error to Swift\")\n+  /// The default user-info dictionary.\n+  public var errorUserInfo: [String: Any] {\n+    switch self {\n+    case let .unknown(message, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = message\n+      return dictionary\n+    case let .objectNotFound(object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"Object \\(object) does not exist.\"\n+      return dictionary\n+    case let .bucketNotFound(bucket):\n+      return [NSLocalizedDescriptionKey: \"Bucket \\(bucket) does not exist.\"]\n+    case let .projectNotFound(project):\n+      return [NSLocalizedDescriptionKey: \"Project \\(project) does not exist.\"]\n+    case let .quotaExceeded(bucket, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"Quota for bucket \\(bucket) exceeded, please view quota on firebase.google.com.\"\n+      return dictionary\n+    case let .unauthenticated(serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] = \"User is not authenticated, please \" +\n+        \"authenticate using Firebase Authentication and try again.\"\n+      return dictionary\n+    case let .unauthorized(bucket, object, serverError):\n+      var dictionary = serverError\n+      dictionary[NSLocalizedDescriptionKey] =\n+        \"User does not have permission to access gs://\\(bucket)/\\(object).\"\n+      return dictionary\n+    case .retryLimitExceeded:\n+      return [NSLocalizedDescriptionKey: \"Max retry time for operation exceeded, please try again.\"]\n+    case .nonMatchingChecksum:\n+      // TODO: replace with actual checksum strings when we choose to implement.\n+      return [NSLocalizedDescriptionKey: \"Uploaded/downloaded object TODO has checksum: TODO \" +\n+        \"which does not match server checksum: TODO. Please retry the upload/download.\"]\n+    case let .downloadSizeExceeded(total, maxSize):\n+      var dictionary: [String: Any] = [\"totalSize\": total, \"maxAllowedSize\": maxSize]\n+      dictionary[NSLocalizedDescriptionKey] = \"Attempted to download object with size of \" +\n+        \"\\(total) bytes, \" +\n+        \"which exceeds the maximum size of \\(maxSize) bytes. \" +\n+        \"Consider raising the maximum download maxSize, or using StorageReference.write\"\n+      return dictionary\n+    case .cancelled:\n+      return [NSLocalizedDescriptionKey: \"User cancelled the upload/download.\"]\n+    case let .invalidArgument(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .internalError(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .bucketMismatch(message):\n+      return [NSLocalizedDescriptionKey: message]\n+    case let .pathError(message):\n+      return [NSLocalizedDescriptionKey: message]\n     }\n   }\n }\ndiff --git a/FirebaseStorage/Sources/StorageReference.swift b/FirebaseStorage/Sources/StorageReference.swift\nindex 92a547b3f14..9e4f0c29c41 100644\n--- a/FirebaseStorage/Sources/StorageReference.swift\n+++ b/FirebaseStorage/Sources/StorageReference.swift\n@@ -399,11 +399,9 @@ import Foundation\n   open func list(maxResults: Int64,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -437,11 +435,9 @@ import Foundation\n                  pageToken: String,\n                  completion: @escaping ((_: StorageListResult?, _: Error?) -> Void)) {\n     if maxResults <= 0 || maxResults > 1000 {\n-      completion(nil,\n-                 NSError(domain: StorageErrorDomain,\n-                         code: StorageErrorCode.invalidArgument.rawValue,\n-                         userInfo: [NSLocalizedDescriptionKey:\n-                           \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"]))\n+      completion(nil, StorageError.invalidArgument(\n+        message: \"Argument 'maxResults' must be between 1 and 1000 inclusive.\"\n+      ))\n     } else {\n       let fetcherService = storage.fetcherServiceForApp\n       let task = StorageListTask(reference: self,\n@@ -584,11 +580,10 @@ import Foundation\n   /// For maxSize API, return an error if the size is exceeded.\n   private func checkSizeOverflow(task: StorageTask, maxSize: Int64) -> NSError? {\n     if task.progress.totalUnitCount > maxSize || task.progress.completedUnitCount > maxSize {\n-      return StorageErrorCode.error(withCode: .downloadSizeExceeded,\n-                                    infoDictionary: [\n-                                      \"totalSize\": task.progress.totalUnitCount,\n-                                      \"maxAllowedSize\": maxSize,\n-                                    ])\n+      return StorageError.downloadSizeExceeded(\n+        total: task.progress.totalUnitCount,\n+        maxSize: maxSize\n+      ) as NSError\n     }\n     return nil\n   }\ndiff --git a/FirebaseStorage/Sources/StorageTaskSnapshot.swift b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\nindex 3c909d67855..d7b291b06a8 100644\n--- a/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n+++ b/FirebaseStorage/Sources/StorageTaskSnapshot.swift\n@@ -68,7 +68,7 @@ import Foundation\n        reference: StorageReference,\n        progress: Progress,\n        metadata: StorageMetadata? = nil,\n-       error: NSError? = nil) {\n+       error: Error? = nil) {\n     self.task = task\n     self.reference = reference\n     self.progress = progress\ndiff --git a/FirebaseStorage/Sources/StorageUploadTask.swift b/FirebaseStorage/Sources/StorageUploadTask.swift\nindex 8c99e8c4a28..5878b03fb04 100644\n--- a/FirebaseStorage/Sources/StorageUploadTask.swift\n+++ b/FirebaseStorage/Sources/StorageUploadTask.swift\n@@ -237,14 +237,10 @@ import Foundation\n        isFile == true {\n       return nil\n     }\n-    let userInfo = [NSLocalizedDescriptionKey:\n-      \"File at URL: \\(fileURL?.absoluteString ?? \"\") is not reachable.\"\n-      + \" Ensure file URL is not a directory, symbolic link, or invalid url.\"]\n-    return NSError(\n-      domain: StorageErrorDomain,\n-      code: StorageErrorCode.unknown.rawValue,\n-      userInfo: userInfo\n-    )\n+    return StorageError.unknown(message: \"File at URL: \\(fileURL?.absoluteString ?? \"\") is \" +\n+      \"not reachable. Ensure file URL is not \" +\n+      \"a directory, symbolic link, or invalid url.\",\n+      serverError: [:]) as NSError\n   }\n \n   func finishTaskWithStatus(status: StorageTaskStatus, snapshot: StorageTaskSnapshot) {\ndiff --git a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\nindex f8729a5b675..fa780f24a6c 100644\n--- a/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageAsyncAwait.swift\n@@ -118,11 +118,29 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putDataAsync(data)\n       XCTFail(\"Unexpected success from unauthorized putData\")\n-    } catch let StorageError.unauthorized(bucket, object) {\n+    } catch let StorageError.unauthorized(bucket, object, _) {\n       XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n       XCTAssertEqual(object, objectLocation)\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unauthorized\")\n+      XCTFail(\"error failed to convert to StorageError.unauthorized  \\(error)\")\n+    }\n+  }\n+\n+  func testSimplePutDataUnauthorizedWithNSError() async throws {\n+    let objectLocation = \"ios/private/secretfile.txt\"\n+    let ref = storage.reference(withPath: objectLocation)\n+    let data = try XCTUnwrap(\"Hello Swift World\".data(using: .utf8), \"Data construction failed\")\n+    do {\n+      _ = try await ref.putDataAsync(data)\n+      XCTFail(\"Unexpected success from unauthorized putData\")\n+    } catch {\n+      let e = error as NSError\n+      XCTAssertEqual(e.domain, StorageErrorDomain)\n+      XCTAssertEqual(e.code, StorageErrorCode.unauthorized.rawValue)\n+      XCTAssertEqual(e.localizedDescription, \"User does not have permission to access\" +\n+        \" gs://ios-opensource-samples.appspot.com/ios/private/secretfile.txt.\")\n+      XCTAssertEqual(e.userInfo[\"ResponseErrorCode\"] as? Int, 403)\n+      print(e)\n     }\n   }\n \n@@ -136,13 +154,13 @@ class StorageAsyncAwait: StorageIntegrationCommon {\n     do {\n       _ = try await ref.putFileAsync(from: fileURL)\n       XCTFail(\"Unexpected success from putFile of a directory\")\n-    } catch let StorageError.unknown(reason) {\n+    } catch let StorageError.unknown(reason, _) {\n       XCTAssertTrue(reason.starts(with: \"File at URL:\"))\n       XCTAssertTrue(reason.hasSuffix(\n         \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n       ))\n     } catch {\n-      XCTFail(\"error failed to convert to StorageError.unknown\")\n+      XCTFail(\"error failed to convert to StorageError.unknown \\(error)\")\n     }\n   }\n \ndiff --git a/FirebaseStorage/Tests/Integration/StorageIntegration.swift b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\nindex 2f407dc7427..7e93e84e7fe 100644\n--- a/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n+++ b/FirebaseStorage/Tests/Integration/StorageIntegration.swift\n@@ -201,7 +201,7 @@ class StorageResultTests: StorageIntegrationCommon {\n         XCTFail(\"Unexpected success from unauthorized putData\")\n       case let .failure(error as StorageError):\n         switch error {\n-        case let .unauthorized(bucket, object):\n+        case let .unauthorized(bucket, object, serverError):\n           XCTAssertEqual(bucket, \"ios-opensource-samples.appspot.com\")\n           XCTAssertEqual(object, file)\n           expectation.fulfill()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageAPITests.swift b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\nindex 02d6b06e557..0244d22f7be 100644\n--- a/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageAPITests.swift\n@@ -158,6 +158,9 @@ final class StorageAPITests: XCTestCase {\n     case .downloadSizeExceeded: return code\n     case .cancelled: return code\n     case .invalidArgument: return code\n+    case .bucketMismatch: return code\n+    case .internalError: return code\n+    case .pathError: return code\n     @unknown default:\n       fatalError()\n     }\ndiff --git a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\nindex 52592be27c2..a711125d8c1 100644\n--- a/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageGetMetadataTests.swift\n@@ -181,7 +181,9 @@ class StorageGetMetadataTests: StorageTestHelpers {\n       fetcherService: fetcherService!.self,\n       queue: dispatchQueue!.self\n     ) { metadata, error in\n-      XCTAssertEqual((error as? NSError)!.code, StorageErrorCode.unknown.rawValue)\n+      XCTAssertNil(metadata)\n+      let nsError = try! XCTUnwrap(error as? NSError)\n+      XCTAssertEqual(nsError.code, StorageErrorCode.unknown.rawValue)\n       expectation.fulfill()\n     }\n     task.enqueue()\ndiff --git a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\nindex 56efb5cabf9..7854bedcf15 100644\n--- a/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageReferenceTests.swift\n@@ -72,7 +72,7 @@ class StorageReferenceTests: XCTestCase {\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bcket` does not match the Storage \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bcket` does not match the Storage \" +\n           \"bucket of the current instance: `bucket`\\\")\"\n       )\n     }\n@@ -95,8 +95,9 @@ class StorageReferenceTests: XCTestCase {\n   func testBadBucketScheme2() throws {\n     let url = try XCTUnwrap(URL(string: \"htttp://bucket/\"))\n     XCTAssertThrowsError(try storage!.reference(for: url), \"This was supposed to fail.\") { error in\n-      XCTAssertEqual(\"\\(error)\", \"pathError(\\\"Internal error: URL scheme must be one of gs://, \" +\n-        \"http://, or https://\\\")\")\n+      XCTAssertEqual(\"\\(error)\",\n+                     \"pathError(message: \\\"Internal error: URL scheme must be one of gs://, \" +\n+                       \"http://, or https://\\\")\")\n     }\n   }\n \n@@ -219,7 +220,7 @@ class StorageReferenceTests: XCTestCase {\n         XCTFail(\"Unexpected success.\", file: #file, line: #line)\n       case let .failure(error):\n         switch error {\n-        case let StorageError.unknown(message):\n+        case let StorageError.unknown(message, serverError):\n           let expectedDescription = \"File at URL: \\(dummyFileURL.absoluteString) \" +\n             \"is not reachable. Ensure file URL is not a directory, symbolic link, or invalid url.\"\n           XCTAssertEqual(expectedDescription, message)\ndiff --git a/FirebaseStorage/Tests/Unit/StorageTests.swift b/FirebaseStorage/Tests/Unit/StorageTests.swift\nindex ff605798ef8..bbc19194c62 100644\n--- a/FirebaseStorage/Tests/Unit/StorageTests.swift\n+++ b/FirebaseStorage/Tests/Unit/StorageTests.swift\n@@ -45,7 +45,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `benwu-test2.storage.firebase.com` does not match the \" +\n           \"Storage bucket of the current instance: `benwu-test1.storage.firebase.com`\\\")\"\n       )\n     }\n@@ -126,7 +126,7 @@ class StorageTests: XCTestCase {\n     XCTAssertThrowsError(try storage.reference(for: url), \"This was supposed to fail.\") { error in\n       XCTAssertEqual(\n         \"\\(error)\",\n-        \"bucketMismatch(\\\"Provided bucket: `bucket` does not match the \" +\n+        \"bucketMismatch(message: \\\"Provided bucket: `bucket` does not match the \" +\n           \"Storage bucket of the current instance: `notMyBucket`\\\")\"\n       )\n     }\n", "instance_id": "firebase__firebase-ios-sdk-13114", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `FirebaseStorage.StorageError` enum in Swift does not provide sufficient information from the underlying `NSError` object, particularly the `userInfo` dictionary, which is lost during conversion from Objective-C to Swift. The goal is to enhance error handling by making `StorageError` conform to `CustomNSError` to expose more detailed error information. The description includes relevant context, such as the Firebase SDK version, Xcode version, and the specific API (`StorageReference.writeAsync()`) causing the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected format or content of the `userInfo` dictionary to be exposed, nor does it provide specific examples of server responses or error scenarios to be handled. Additionally, while the issue is reproducible by the user, no concrete steps or code snippets for reproduction are provided, which could aid in understanding the problem's scope. Overall, the statement is valid and clear but lacks some finer details and examples that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, spanning multiple files (e.g., `StorageError.swift`, `StorageReference.swift`, `AsyncAwait.swift`, and various test files) within the Firebase Storage SDK. These changes involve refactoring the core error handling mechanism, which is a critical part of the library, potentially impacting many dependent components and requiring a deep understanding of the codebase's architecture. Second, the technical concepts involved are moderately complex, including Swift's error handling model, conformance to `CustomNSError`, interoperability between Objective-C and Swift, and familiarity with Firebase's internal error mapping logic. Third, the modifications require careful handling of edge cases, such as ensuring backward compatibility (noted as a breaking change in the changelog), correctly mapping server error codes to Swift enum cases, and updating test cases to validate the new behavior. While the problem does not involve advanced algorithms or system-level considerations, it demands a solid grasp of language-specific nuances (Swift/Obj-C bridging) and library-specific design patterns. The impact on the system is notable, as error handling is a foundational aspect, and the changes could affect user-facing behavior. Therefore, I assign a difficulty score of 0.65, reflecting the need for deep understanding and careful implementation across multiple modules, balanced by the absence of extremely advanced technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Regression: `win.getNativeWindowHandle()` is broken on macOS\n### Confirmation\n\n- [x] I am a [maintainer](https://github.com/orgs/electron/people) of the Electron project. (If not, please create a [different issue type](https://github.com/electron/electron/issues/new/).)\n\n### Description\n\n## Summary\n\nFor [about a month now](https://chromium-review.googlesource.com/c/chromium/src/+/6361987), `getNativeWindowHandle()` is no longer returning a `NSView*` on macOS.\n\nI found this bug today when [this new buffer safety PR](https://github.com/electron/electron/pull/46724) surfaced it. So I guess that PR is doing its job! 😆\n\nWe also have a [spec](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/spec/api-browser-window-spec.ts#L6281) that should detect this, but it seems to be [disabled in CI](https://github.com/electron/electron/blob/dd03cceda0384f62540b0cea650e73b091eab34b/.github/workflows/pipeline-segment-electron-test.yml#L195).\n\n## Storytime\n\n`BaseWindow::GetNativeWindowHandle()` works by doing a bytewise copy of NativeWindowHandle, which on macOS is a typedef for the Chromium type `gfx::NativeView`.\n\nIn the very early days of Electron, `gfx::NativeView` was, in fact, a `NSView*` and so the code worked as expected.\n\nThis changed in October 2018 with the [upstream change](https://chromium-review.googlesource.com/c/1270343) \"Make gfx::NativeView and gfx::NativeWindow not be NSView and NSWindow\".  Happily, the new type was a wrapper class whose only field was the `NSView` pointer, so a bytewise copy worked anyway. The code still worked as expected... by accident. \n\nThe type changed again [in March 2025](https://chromium-review.googlesource.com/c/chromium/src/+/6361987). It's now a subclass of [base::apple::WeakNSView](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#59) which [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.h#78) a `std::unique_ptr`. If that was a pointer to a NSView, in theory a bytewise copy would _still_ work as before due to the same lucky accident. Unfortunately, it's a pointer to [an opaque data type](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#13) that in turn [holds](https://chromium.googlesource.com/chromium/src/+/main/base/apple/owned_objc.mm#14) a NSView*. So instead of returning a `NSView*`, the bytewise copy is now returning a `NSView**`. 😵\n\n**BUT!** To add insult to injury, it's a little worse than that. Since the new wrapper class [also has another field](https://chromium-review.googlesource.com/c/chromium/src/+/6361987/10/ui/gfx/native_widget_types.h), we're also writing another `sizeof(uintptr_t)` bytes at the end of that `NSView**`. \n\n", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex ea1637c990309..45fafbdb52eb5 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -125,6 +125,7 @@ filenames = {\n     \"shell/browser/animation_util.h\",\n     \"shell/browser/animation_util_mac.mm\",\n     \"shell/browser/api/electron_api_app_mac.mm\",\n+    \"shell/browser/api/electron_api_base_window_mac.mm\",\n     \"shell/browser/api/electron_api_menu_mac.h\",\n     \"shell/browser/api/electron_api_menu_mac.mm\",\n     \"shell/browser/api/electron_api_native_theme_mac.mm\",\ndiff --git a/shell/browser/api/electron_api_base_window.cc b/shell/browser/api/electron_api_base_window.cc\nindex 848cc6cc2c9f8..a7983dd39c8bc 100644\n--- a/shell/browser/api/electron_api_base_window.cc\n+++ b/shell/browser/api/electron_api_base_window.cc\n@@ -70,6 +70,7 @@ namespace electron::api {\n \n namespace {\n \n+#if !BUILDFLAG(IS_MAC)\n // Converts binary data to Buffer.\n v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n@@ -78,6 +79,7 @@ v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n [[nodiscard]] constexpr std::array<int, 2U> ToArray(const gfx::Size size) {\n   return {size.width(), size.height()};\n@@ -778,6 +780,7 @@ std::string BaseWindow::GetMediaSourceId() const {\n   return window_->GetDesktopMediaID().ToString();\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   // TODO(MarshallOfSound): Replace once\n   // https://chromium-review.googlesource.com/c/chromium/src/+/1253094/ has\n@@ -785,6 +788,7 @@ v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n   NativeWindowHandle handle = window_->GetNativeWindowHandle();\n   return ToBuffer(isolate(), &handle, sizeof(handle));\n }\n+#endif\n \n void BaseWindow::SetProgressBar(double progress, gin_helper::Arguments* args) {\n   gin_helper::Dictionary options;\ndiff --git a/shell/browser/api/electron_api_base_window_mac.mm b/shell/browser/api/electron_api_base_window_mac.mm\nnew file mode 100644\nindex 0000000000000..148ec216283f7\n--- /dev/null\n+++ b/shell/browser/api/electron_api_base_window_mac.mm\n@@ -0,0 +1,32 @@\n+// Copyright (c) 2025 Microsoft, Inc.\n+// Use of this source code is governed by the MIT license that can be\n+// found in the LICENSE file.\n+\n+#include \"shell/browser/api/electron_api_base_window.h\"\n+\n+#include \"electron/buildflags/buildflags.h\"\n+#include \"shell/browser/api/electron_api_view.h\"\n+#include \"shell/browser/native_window.h\"\n+#include \"shell/common/node_includes.h\"\n+\n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+namespace electron::api {\n+\n+v8::Local<v8::Value> BaseWindow::GetNativeWindowHandle() {\n+  NSView* handle = window_->GetNativeWindowHandle().GetNativeNSView();\n+  return ToBuffer(isolate(), &handle, sizeof(handle));\n+}\n+\n+}  // namespace electron::api\ndiff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 0779c4919b29a..bf5f6ec4b44b2 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -3743,15 +3743,17 @@ void WebContents::SetDevToolsWebContents(const WebContents* devtools) {\n     inspectable_web_contents_->SetDevToolsWebContents(devtools->web_contents());\n }\n \n+#if !BUILDFLAG(IS_MAC)\n v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n   gfx::NativeView ptr = web_contents()->GetNativeView();\n-  auto buffer = node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr),\n-                                   sizeof(gfx::NativeView));\n+  auto buffer =\n+      node::Buffer::Copy(isolate, reinterpret_cast<char*>(&ptr), sizeof(ptr));\n   if (buffer.IsEmpty())\n     return v8::Null(isolate);\n   else\n     return buffer.ToLocalChecked();\n }\n+#endif\n \n v8::Local<v8::Value> WebContents::DevToolsWebContents(v8::Isolate* isolate) {\n   if (devtools_web_contents_.IsEmpty())\ndiff --git a/shell/browser/api/electron_api_web_contents_mac.mm b/shell/browser/api/electron_api_web_contents_mac.mm\nindex 52c4362839610..1358b3dde95da 100644\n--- a/shell/browser/api/electron_api_web_contents_mac.mm\n+++ b/shell/browser/api/electron_api_web_contents_mac.mm\n@@ -6,6 +6,7 @@\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n+#include \"shell/common/node_includes.h\"\n #include \"ui/base/cocoa/command_dispatcher.h\"\n #include \"ui/base/cocoa/nsmenu_additions.h\"\n #include \"ui/base/cocoa/nsmenuitem_additions.h\"\n@@ -92,4 +93,22 @@ - (void)redispatchKeyEvent:(NSEvent*)event;\n   return false;\n }\n \n+namespace {\n+\n+// Converts binary data to Buffer.\n+v8::Local<v8::Value> ToBuffer(v8::Isolate* isolate, void* val, int size) {\n+  auto buffer = node::Buffer::Copy(isolate, static_cast<char*>(val), size);\n+  if (buffer.IsEmpty())\n+    return v8::Null(isolate);\n+  else\n+    return buffer.ToLocalChecked();\n+}\n+\n+}  // namespace\n+\n+v8::Local<v8::Value> WebContents::GetNativeView(v8::Isolate* isolate) const {\n+  NSView* handle = web_contents()->GetNativeView().GetNativeNSView();\n+  return ToBuffer(isolate, &handle, sizeof(handle));\n+}\n+\n }  // namespace electron::api\ndiff --git a/shell/browser/native_window.h b/shell/browser/native_window.h\nindex cc4d150ca72b1..831cf8947aa85 100644\n--- a/shell/browser/native_window.h\n+++ b/shell/browser/native_window.h\n@@ -58,9 +58,9 @@ class BrowserView;\n }\n \n #if BUILDFLAG(IS_MAC)\n-typedef gfx::NativeView NativeWindowHandle;\n+using NativeWindowHandle = gfx::NativeView;\n #else\n-typedef gfx::AcceleratedWidget NativeWindowHandle;\n+using NativeWindowHandle = gfx::AcceleratedWidget;\n #endif\n \n class NativeWindow : public base::SupportsUserData,\n", "instance_id": "electron__electron-46733", "clarity": 3, "difficulty": 0.65, "clarity_explanation": "The problem statement is exceptionally detailed and comprehensive. It provides a clear summary of the issue, explaining that `win.getNativeWindowHandle()` no longer returns the expected `NSView*` on macOS due to upstream changes in Chromium. The description includes a historical context (\"Storytime\") that outlines how the issue evolved over time due to changes in the `gfx::NativeView` type, and it precisely identifies the root cause of the bug (a bytewise copy returning a `NSView**` instead of `NSView*`, compounded by additional field misalignment). The statement also references relevant upstream changes, PRs, and even disabled CI tests, providing a full picture of the issue. There are no significant ambiguities; the goal (fix the return value of `getNativeWindowHandle()` on macOS), the cause, and the expected behavior are all well-defined. While edge cases are not explicitly mentioned, the depth of technical detail and context compensates for this minor omission, making it a comprehensive problem description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes involves multiple files and requires platform-specific handling (macOS), as seen in the addition of new files (`electron_api_base_window_mac.mm`) and modifications to existing ones (`electron_api_base_window.cc`, `electron_api_web_contents_mac.mm`, etc.). The changes are not trivial; they involve conditional compilation (`#if !BUILDFLAG(IS_MAC)`) to separate macOS-specific logic from other platforms, indicating a need to understand cross-platform code organization. Second, the technical concepts required include familiarity with Chromium's `gfx::NativeView` type, macOS-specific Objective-C++ programming (e.g., handling `NSView*` pointers), and Node.js integration (e.g., converting native handles to V8 buffers). Additionally, the problem demands an understanding of memory layout and pointer dereferencing issues caused by upstream type changes, which is a nuanced and error-prone area. Third, while edge cases are not explicitly mentioned in the problem statement, the code changes suggest potential risks around pointer handling and memory safety, especially given the historical \"lucky accidents\" in bytewise copying. Finally, the impact is significant as it fixes a regression in a core API (`getNativeWindowHandle()`), which likely affects downstream consumers of the Electron framework. However, it does not reach the \"Very Hard\" category (0.8-1.0) because it does not involve system-level redesign or highly complex algorithms; it is more about precise, platform-specific adjustments within a well-defined scope. A score of 0.65 reflects the need for deep understanding of the codebase and careful handling of platform-specific details, but not the extreme complexity of, say, architectural overhauls or novel algorithm design.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.8, "human_difficulty_modify_explanation": "As we all know, pointer management in C++ is notoriously troublesome, especially when it comes to cross-platform collaboration."}
{"problem_statement": "[Documentation request] Explain why someone might enable the fuse `loadBrowserProcessSpecificV8Snapshot`\nThe [documentation](https://www.electronjs.org/docs/latest/tutorial/fuses#loadbrowserprocessspecificv8snapshot) of the fuse `loadBrowserProcessSpecificV8Snapshot` does not explain in which cases it would make sense to enable the fuse, i.e. why someone would want the browser process to use a separate V8 snapshot or what benefits and drawbacks that brings with it.\n\nIt would be great if that could be documented.\n", "patch": "diff --git a/docs/tutorial/fuses.md b/docs/tutorial/fuses.md\nindex 3e644f02dcad9..1afa53d6a7df3 100644\n--- a/docs/tutorial/fuses.md\n+++ b/docs/tutorial/fuses.md\n@@ -68,6 +68,10 @@ The onlyLoadAppFromAsar fuse changes the search system that Electron uses to loc\n \n The loadBrowserProcessSpecificV8Snapshot fuse changes which V8 snapshot file is used for the browser process.  By default Electron's processes will all use the same V8 snapshot file.  When this fuse is enabled the browser process uses the file called `browser_v8_context_snapshot.bin` for its V8 snapshot. The other processes will use the V8 snapshot file that they normally do.\n \n+V8 snapshots can be useful to improve app startup performance. V8 lets you take snapshots of initialized heaps and then load them back in to avoid the cost of initializing the heap.\n+\n+Using separate snapshots for renderer processes and the main process can improve security, especially to make sure that the renderer doesn't use a snapshot with `nodeIntegration` enabled. See [#35170](https://github.com/electron/electron/issues/35170) for details.\n+\n ### `grantFileProtocolExtraPrivileges`\n \n **Default:** Enabled\n", "instance_id": "electron__electron-44710", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in its intent: it requests additional documentation for the `loadBrowserProcessSpecificV8Snapshot` fuse in Electron, specifically asking for an explanation of why someone might enable it and the associated benefits and drawbacks. The goal is well-defined, and the context (a link to the existing documentation) is provided. However, there are minor ambiguities, such as the lack of specific guidance on the depth or technical detail expected in the explanation (e.g., should it include performance metrics, security implications, or specific use cases?). Additionally, while the problem is straightforward, it assumes some familiarity with Electron and V8 snapshots, which might not be explicitly clear to all readers. Hence, it falls under \"Mostly Clear\" with minor details missing.", "difficulty_explanation": "The difficulty of this task is very low, falling in the 0.0-0.2 range. The task involves adding a small amount of explanatory text to an existing documentation file (`fuses.md`), as shown in the code changes. The scope of the change is minimal, confined to a single file with just a few lines of added content. It does not require modifying any functional code, understanding complex interactions within the codebase, or impacting the system's architecture. The technical concepts involved are relatively basic—knowledge of V8 snapshots and their role in Electron's performance and security is sufficient, and the provided code change already demonstrates an understanding of these concepts (e.g., referencing improved startup performance and security benefits). No edge cases or error handling are relevant since this is purely a documentation task. The primary challenge might be ensuring the explanation is accurate and concise, but this does not require deep technical expertise beyond a surface-level understanding of Electron's architecture. Therefore, I assess this as a very easy task.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: zstd is not enabled in accept-encoding\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n31.3.1\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nany\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n_No response_\r\n\r\n### Expected Behavior\r\n\r\nzstd is a supported content encoding method, and the accept-encoding should be \"gzip, deflate, br, zstd\"\r\n\r\n<img width=\"920\" alt=\"截屏2024-07-31 06 43 43\" src=\"https://github.com/user-attachments/assets/11d536fd-f7bd-4a31-93cb-36960de0dfea\">\r\n\r\n\r\n### Actual Behavior\r\n\r\nit's not enabled even it's forcely enabled it in network conditions panel, the accept-encoding header is still \"gzip, deflate, br\".\r\n<img width=\"812\" alt=\"截屏2024-07-31 06 40 16\" src=\"https://github.com/user-attachments/assets/c47a5f8a-9393-40a2-a1fb-ef81695a9be5\">\r\n\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nJust start the default electron fiddle, open the dev tools and set location.href to any site for example 'https://www.google.com/' then check the request headers in network panel.\n", "patch": "diff --git a/shell/browser/net/system_network_context_manager.cc b/shell/browser/net/system_network_context_manager.cc\nindex be839e174243c..8b8beac393cfb 100644\n--- a/shell/browser/net/system_network_context_manager.cc\n+++ b/shell/browser/net/system_network_context_manager.cc\n@@ -195,6 +195,8 @@ SystemNetworkContextManager::CreateDefaultNetworkContextParams() {\n void SystemNetworkContextManager::ConfigureDefaultNetworkContextParams(\n     network::mojom::NetworkContextParams* network_context_params) {\n   network_context_params->enable_brotli = true;\n+  network_context_params->enable_zstd =\n+      base::FeatureList::IsEnabled(net::features::kZstdContentEncoding);\n \n   network_context_params->enable_referrers = true;\n \n", "instance_id": "electron__electron-43150", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the 'zstd' content encoding is not included in the 'accept-encoding' header of HTTP requests in Electron, even when forcibly enabled in the network conditions panel. The expected behavior (\"gzip, deflate, br, zstd\") and actual behavior (\"gzip, deflate, br\") are explicitly stated, and screenshots are provided for visual reference, which aids in understanding the issue. Additionally, steps to reproduce the bug are given, which helps in validating the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this issue affects all platforms or only Windows (despite the reporter using Windows), and there are no mentions of specific edge cases or constraints (e.g., does this depend on specific server configurations or Electron settings?). Furthermore, there is no discussion of potential side effects or compatibility issues that enabling 'zstd' might introduce. Due to these minor gaps, the clarity score is set to 2 (Mostly Clear) rather than 3.", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the 'Easy' category (0.2-0.4). Let's break this down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal, involving only a single file (`system_network_context_manager.cc`) and the addition of two lines to enable 'zstd' content encoding based on a feature flag. This modification is localized and does not appear to impact the broader system architecture or require changes across multiple modules. The change is straightforward and does not necessitate a deep understanding of the Electron codebase beyond the specific network context configuration.\n\n2. **Number of Technical Concepts:** The solution requires basic knowledge of C++ (the language used in the Electron codebase) and a rudimentary understanding of network context parameters in Electron/Chromium. The concept of content encoding (e.g., 'zstd', 'brotli') is relevant but not complex, as the change simply toggles a flag based on a feature list. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic HTTP headers and content encoding are needed.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases or error conditions, and the code change does not introduce new error handling logic. However, a developer might need to consider whether enabling 'zstd' could lead to compatibility issues with servers that do not support it or potential performance implications, though these are not addressed in the provided diff. The simplicity of the change suggests that edge case handling is minimal at this stage.\n\n4. **Overall Complexity:** The task is a simple bug fix that involves enabling a feature already supported in the underlying Chromium framework (as evidenced by the feature flag `net::features::kZstdContentEncoding`). It does not require deep architectural changes or extensive debugging.\n\nGiven these points, a difficulty score of 0.25 is appropriate. It reflects an easy task that requires understanding some code logic (network context configuration) and making a simple modification, with minimal impact on the broader codebase and no significant edge case complexity mentioned in the problem or code change.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: nativeImage.createThumbnailFromPath fails to resolve in renderer process from version 25.0.0\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n29.2.0\r\n\r\n### What operating system are you using?\r\n\r\nmacOS\r\n\r\n### Operating System Version\r\n\r\n13.6 (22G116)\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\n24.8.8\r\n\r\n### Expected Behavior\r\n\r\nThe function should resolve as it did in version 24.8.8, returning a thumbnail image or throwing an error if the operation fails.\r\n\r\n### Actual Behavior\r\n\r\nThe function call does not resolve or throw errors, leaving the operation in an unresolved state.\r\n\r\n### Testcase Gist URL\r\n\r\nhttps://gist.github.com/gaodeng/05a4fefb9cde972336a1285821953df6\r\n\r\n### Additional Information\r\n\r\n_No response_\n", "patch": "diff --git a/shell/common/api/electron_api_native_image_mac.mm b/shell/common/api/electron_api_native_image_mac.mm\nindex cf9c6cdcfa37f..e45eaae9a9387 100644\n--- a/shell/common/api/electron_api_native_image_mac.mm\n+++ b/shell/common/api/electron_api_native_image_mac.mm\n@@ -14,6 +14,7 @@\n \n #include \"base/apple/foundation_util.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/bind_post_task.h\"\n #include \"gin/arguments.h\"\n #include \"shell/common/gin_converters/image_converter.h\"\n #include \"shell/common/gin_helper/promise.h\"\n@@ -38,6 +39,23 @@\n   return def;\n }\n \n+void ReceivedThumbnailResult(CGSize size,\n+                             gin_helper::Promise<gfx::Image> p,\n+                             QLThumbnailRepresentation* thumbnail,\n+                             NSError* error) {\n+  if (error || !thumbnail) {\n+    std::string err_msg([error.localizedDescription UTF8String]);\n+    p.RejectWithErrorMessage(\"unable to retrieve thumbnail preview \"\n+                             \"image for the given path: \" +\n+                             err_msg);\n+  } else {\n+    NSImage* result = [[NSImage alloc] initWithCGImage:[thumbnail CGImage]\n+                                                  size:size];\n+    gfx::Image image(result);\n+    p.Resolve(image);\n+  }\n+}\n+\n // static\n v8::Local<v8::Promise> NativeImage::CreateThumbnailFromPath(\n     v8::Isolate* isolate,\n@@ -70,31 +88,15 @@\n                      size:cg_size\n                     scale:[screen backingScaleFactor]\n       representationTypes:QLThumbnailGenerationRequestRepresentationTypeAll]);\n-  __block gin_helper::Promise<gfx::Image> p = std::move(promise);\n+  __block auto block_callback = base::BindPostTaskToCurrentDefault(\n+      base::BindOnce(&ReceivedThumbnailResult, cg_size, std::move(promise)));\n+  auto completionHandler =\n+      ^(QLThumbnailRepresentation* thumbnail, NSError* error) {\n+        std::move(block_callback).Run(thumbnail, error);\n+      };\n   [[QLThumbnailGenerator sharedGenerator]\n       generateBestRepresentationForRequest:request\n-                         completionHandler:^(\n-                             QLThumbnailRepresentation* thumbnail,\n-                             NSError* error) {\n-                           if (error || !thumbnail) {\n-                             std::string err_msg(\n-                                 [error.localizedDescription UTF8String]);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.RejectWithErrorMessage(\n-                                   \"unable to retrieve thumbnail preview \"\n-                                   \"image for the given path: \" +\n-                                   err_msg);\n-                             });\n-                           } else {\n-                             NSImage* result = [[NSImage alloc]\n-                                 initWithCGImage:[thumbnail CGImage]\n-                                            size:cg_size];\n-                             gfx::Image image(result);\n-                             dispatch_async(dispatch_get_main_queue(), ^{\n-                               p.Resolve(image);\n-                             });\n-                           }\n-                         }];\n+                         completionHandler:completionHandler];\n \n   return handle;\n }\ndiff --git a/shell/common/platform_util_mac.mm b/shell/common/platform_util_mac.mm\nindex 60419c7b28daa..32972a5dfe44f 100644\n--- a/shell/common/platform_util_mac.mm\n+++ b/shell/common/platform_util_mac.mm\n@@ -15,11 +15,15 @@\n #include \"base/apple/osstatus_logging.h\"\n #include \"base/files/file_path.h\"\n #include \"base/files/file_util.h\"\n+#include \"base/functional/bind.h\"\n #include \"base/functional/callback.h\"\n #include \"base/logging.h\"\n #include \"base/mac/scoped_aedesc.h\"\n #include \"base/strings/stringprintf.h\"\n #include \"base/strings/sys_string_conversions.h\"\n+#include \"base/task/thread_pool.h\"\n+#include \"content/public/browser/browser_task_traits.h\"\n+#include \"content/public/browser/browser_thread.h\"\n #include \"net/base/apple/url_conversions.h\"\n #include \"ui/views/widget/widget.h\"\n #include \"url/gurl.h\"\n@@ -183,15 +187,12 @@ void OpenExternal(const GURL& url,\n     return;\n   }\n \n-  bool activate = options.activate;\n-  __block OpenCallback c = std::move(callback);\n-  dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),\n-                 ^{\n-                   __block std::string error = OpenURL(ns_url, activate);\n-                   dispatch_async(dispatch_get_main_queue(), ^{\n-                     std::move(c).Run(error);\n-                   });\n-                 });\n+  base::ThreadPool::PostTaskAndReplyWithResult(\n+      FROM_HERE,\n+      {base::MayBlock(), base::WithBaseSyncPrimitives(),\n+       base::TaskPriority::USER_BLOCKING,\n+       base::TaskShutdownBehavior::SKIP_ON_SHUTDOWN},\n+      base::BindOnce(&OpenURL, ns_url, options.activate), std::move(callback));\n }\n \n bool MoveItemToTrashWithError(const base::FilePath& full_path,\ndiff --git a/spec/api-native-image-spec.ts b/spec/api-native-image-spec.ts\nindex 7e055dd6a169f..d498214942af9 100644\n--- a/spec/api-native-image-spec.ts\n+++ b/spec/api-native-image-spec.ts\n@@ -1,6 +1,6 @@\n import { expect } from 'chai';\n import { nativeImage } from 'electron/common';\n-import { ifdescribe, ifit } from './lib/spec-helpers';\n+import { ifdescribe, ifit, itremote, useRemoteContext } from './lib/spec-helpers';\n import * as path from 'node:path';\n \n describe('nativeImage module', () => {\n@@ -426,6 +426,8 @@ describe('nativeImage module', () => {\n   });\n \n   ifdescribe(process.platform !== 'linux')('createThumbnailFromPath(path, size)', () => {\n+    useRemoteContext({ webPreferences: { contextIsolation: false, nodeIntegration: true } });\n+\n     it('throws when invalid size is passed', async () => {\n       const badSize = { width: -1, height: -1 };\n \n@@ -473,6 +475,13 @@ describe('nativeImage module', () => {\n       const result = await nativeImage.createThumbnailFromPath(imgPath, maxSize);\n       expect(result.getSize()).to.deep.equal(maxSize);\n     });\n+\n+    itremote('works in the renderer', async (path: string) => {\n+      const { nativeImage } = require('electron');\n+      const goodSize = { width: 100, height: 100 };\n+      const result = await nativeImage.createThumbnailFromPath(path, goodSize);\n+      expect(result.isEmpty()).to.equal(false);\n+    }, [path.join(fixturesPath, 'assets', 'logo.png')]);\n   });\n \n   describe('addRepresentation()', () => {\ndiff --git a/spec/api-shell-spec.ts b/spec/api-shell-spec.ts\nindex 749677311bd57..a2e9cef96ff8c 100644\n--- a/spec/api-shell-spec.ts\n+++ b/spec/api-shell-spec.ts\n@@ -31,7 +31,7 @@ describe('shell module', () => {\n     });\n     afterEach(closeAllWindows);\n \n-    it('opens an external link', async () => {\n+    async function urlOpened () {\n       let url = 'http://127.0.0.1';\n       let requestReceived: Promise<any>;\n       if (process.platform === 'linux') {\n@@ -53,12 +53,26 @@ describe('shell module', () => {\n         url = (await listen(server)).url;\n         requestReceived = new Promise<void>(resolve => server.on('connection', () => resolve()));\n       }\n+      return { url, requestReceived };\n+    }\n \n+    it('opens an external link', async () => {\n+      const { url, requestReceived } = await urlOpened();\n       await Promise.all<void>([\n         shell.openExternal(url),\n         requestReceived\n       ]);\n     });\n+\n+    it('opens an external link in the renderer', async () => {\n+      const { url, requestReceived } = await urlOpened();\n+      const w = new BrowserWindow({ show: false, webPreferences: { sandbox: false, contextIsolation: false, nodeIntegration: true } });\n+      await w.loadURL('about:blank');\n+      await Promise.all<void>([\n+        w.webContents.executeJavaScript(`require(\"electron\").shell.openExternal(${JSON.stringify(url)})`),\n+        requestReceived\n+      ]);\n+    });\n   });\n \n   describe('shell.trashItem()', () => {\n", "instance_id": "electron__electron-41875", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: the `nativeImage.createThumbnailFromPath` function fails to resolve or throw errors in the renderer process starting from Electron version 25.0.0, whereas it worked correctly in version 24.8.8. The expected behavior (resolving with a thumbnail or throwing an error) and actual behavior (unresolved state) are explicitly stated, which provides a good foundation for understanding the bug. Additionally, relevant details such as the Electron version, operating system (macOS), and architecture (x64) are provided, along with a test case gist URL for reproducibility. However, the statement lacks specific details about potential causes or contexts in which the issue occurs (e.g., specific file types or paths that fail). Edge cases or constraints are not mentioned, which could be critical for a complete understanding of the problem scope. Therefore, while the problem is valid and mostly clear, minor details are missing, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assess the difficulty of this problem as 0.65, placing it in the \"Hard\" range (0.6-0.8), based on the following analysis of the factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem statement is mostly clear, the lack of detail about specific failure conditions or edge cases adds some complexity to diagnosing the root cause. The issue involves asynchronous behavior and inter-process communication in Electron (between main and renderer processes), which inherently increases the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (`electron_api_native_image_mac.mm`, `platform_util_mac.mm`, and test files `api-native-image-spec.ts` and `api-shell-spec.ts`), indicating a moderate scope. The primary fix in `electron_api_native_image_mac.mm` involves refactoring the asynchronous handling of thumbnail generation using `base::BindPostTask` to ensure proper thread dispatching, which suggests a need to understand Electron's threading model and macOS-specific APIs (`QLThumbnailGenerator`). The changes in `platform_util_mac.mm` address a related issue with external URL opening, also involving threading adjustments. While the changes are not architecturally significant, they require understanding interactions between Electron's main and renderer processes, as well as macOS-specific APIs. The amount of code change is moderate, with significant logic modifications rather than trivial updates.\n\n3. **Number of Technical Concepts to Understand**: Solving this problem requires familiarity with several concepts: (a) Electron's architecture, particularly the distinction between main and renderer processes and how promises are handled across them; (b) macOS-specific APIs like `QLThumbnailGenerator` for thumbnail generation; (c) C++ threading and asynchronous programming using `base::BindPostTask` and dispatch queues; (d) V8 JavaScript engine integration with native code via `gin_helper::Promise`; and (e) testing in Electron, as evidenced by updates to test specs. These concepts are moderately complex, especially for someone not deeply familiar with Electron's internals or macOS development.\n\n4. **Potential Edge Cases and Error Handling Requirements**: The problem statement does not explicitly mention edge cases, but the code changes address error handling by properly rejecting promises with detailed error messages when thumbnail generation fails. The fix also ensures that callbacks are executed on the correct thread, which is critical for avoiding deadlocks or unresolved promises. Potential edge cases include invalid file paths, unsupported file types for thumbnails, or permissions issues on macOS, which are not explicitly handled in the diff but may need consideration. The error handling logic added is non-trivial due to the asynchronous nature of the operation.\n\nOverall, this problem requires a deep understanding of Electron's threading model, macOS APIs, and asynchronous programming in C++. The changes impact multiple files and involve moderate complexity in ensuring proper promise resolution across processes. While it does not involve a complete architectural overhaul or extremely advanced concepts, it is challenging enough to be classified as \"Hard\" with a score of 0.65, reflecting the need for specialized knowledge and careful handling of asynchronous behavior.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1, "human_difficulty_explanation": -1}
{"problem_statement": "[Windows] Scons isn't detecting MinGW and fails when building\n### Tested versions\n\n- Reproducible in master (4.5.dev) - commit [6b5b84c0c50135e88691e035d3e00c68a2ae5aa4]\n- **Not** reproducible in 4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Laptop GPU (NVIDIA; 32.0.15.6636) - AMD Ryzen 7 7735HS with Radeon Graphics (16 threads)\n\n### Issue description\n\nScons fails to detect MinGW (I'm using [LLVM-MinGW](https://github.com/mstorsjo/llvm-mingw/releases/)) which is included in my PATH, then complains it can't find MSVC and errors out. Scons works perfectly fine for me in 4.4 stable.\n\nThis is what I get when trying to build on master:\n\n```\n> scons\nscons: Reading SConscript files ...\nAutomatically detected platform: windows\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\n\nscons: warning: No versions of the MSVC compiler were found.\n  Visual Studio C/C++ compilers may not be set correctly.\n  Requested tool(s) are: ['msvc', 'mslink', 'mslib']\nFile \"D:\\Godot Dev\\godot\\SConstruct\", line 441, in <module>\nAuto-detected 16 CPU cores available for build parallelism. Using 15 cores by default. You can override it with the `-j` or `num_jobs` arguments.\nBuilding for platform \"windows\", architecture \"x86_64\", target \"template_release\".\nKeyError: 'VSWHERE':\n  File \"D:\\Godot Dev\\godot\\SConstruct\", line 623:\n    cc_version = methods.get_compiler_version(env)\n  File \"D:\\Godot Dev\\godot\\methods.py\", line 698:\n    env[\"VSWHERE\"],\n  File \"C:\\Users\\ahmou\\AppData\\Local\\Packages\\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\\LocalCache\\local-packages\\Python311\\site-packages\\SCons\\Environment.py\", line 603:\n    return self._dict[key]\n```\n\n### Steps to reproduce\n\nTry building on Windows with MinGW, without MSVC installed\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/platform/windows/detect.py b/platform/windows/detect.py\nindex 31a8d07fea80..789909b22351 100644\n--- a/platform/windows/detect.py\n+++ b/platform/windows/detect.py\n@@ -148,7 +148,9 @@ def detect_build_env_arch():\n \n \n def get_tools(env: \"SConsEnvironment\"):\n-    if os.name != \"nt\" or env.get(\"use_mingw\"):\n+    from SCons.Tool.MSCommon import msvc_exists\n+\n+    if os.name != \"nt\" or env.get(\"use_mingw\") or not msvc_exists():\n         return [\"mingw\"]\n     else:\n         msvc_arch_aliases = {\"x86_32\": \"x86\", \"arm32\": \"arm\"}\n", "instance_id": "godotengine__godot-104744", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Scons fails to detect MinGW on Windows in the master branch (Godot v4.5.dev) while it works in the stable branch (v4.4.stable). The goal is implicitly to fix the detection of MinGW to allow building without MSVC. The description includes relevant system information, tested versions, and steps to reproduce, which are helpful. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior (e.g., should Scons prioritize MinGW over MSVC or provide a fallback mechanism?) or mention specific constraints or edge cases (e.g., different MinGW versions or PATH configurations). Additionally, there are no examples of expected output or detailed error logs beyond the provided snippet. While the issue is understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the easy range (0.2-0.4) due to the following analysis based on the provided factors:\n\n1. **Scope and Depth of Code Changes:** The code change is minimal and localized to a single file (`detect.py`) and a specific function (`get_tools`). It involves adding a check for MSVC existence before deciding whether to use MinGW or MSVC tools. The diff shows a small modification (adding an import and a conditional check), indicating a low amount of code change with no impact on the broader system architecture or multiple modules.\n\n2. **Number of Technical Concepts:** Solving this requires understanding Scons build system configuration, specifically how tools are detected and prioritized on Windows. It also involves familiarity with the Scons API (e.g., `msvc_exists()` from `SCons.Tool.MSCommon`) and basic Python scripting. These concepts are relatively straightforward for someone with build system experience, though they might be less familiar to a general developer without specific Scons knowledge.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the nature of the issue suggests potential considerations like different MinGW installations, PATH misconfigurations, or scenarios where both MSVC and MinGW are present. The provided code change does not address these explicitly, and no additional error handling logic is introduced in the diff. The complexity of edge cases appears low at this stage, as the fix focuses on a basic detection check.\n\n4. **Overall Assessment:** The problem requires understanding a specific part of the build system logic and making a simple conditional modification. It does not involve complex algorithms, deep architectural changes, or advanced language features. The main challenge lies in knowing the Scons tool detection mechanism, which is a moderate but not overly complex concept. Therefore, I assign a difficulty score of 0.35, reflecting an easy problem that requires some targeted knowledge and minimal code changes but is not trivially solvable by a complete novice.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "RichTextLabel table with padding and BBCode enabled cause misalignment\n### Tested versions\n\nv4.5.dev.custom_build.6b4fda04c\n\n### System information\n\nGodot v4.5.dev (6b4fda04c) - Ubuntu 22.04.5 LTS 22.04 - X11 display driver, Multi-window, 1 monitor - OpenGL 3 (Compatibility) - D3D12 (AMD Radeon(TM) Graphics) - AMD Ryzen 5 5600H with Radeon Graphics (12 threads)\n\n### Issue description\n\nWhen using a RichTextLabel with BBCode enabled, tables with padding display incorrect horizontal and vertical alignment. This issue only occurs when BBCode is enabled.\nI would like to fix this bug as my first contribution to Godot. I'm already investigating the offset calculation in the relevant functions and would appreciate any guidance from the maintainers on the correct approach.\n\nhttps://github.com/user-attachments/assets/b1a6895c-f446-4fa2-b885-6757e4ca36d9\n\n### Steps to reproduce\n\n1.Create a RichTextLabel node\n2.Enable BBCode (set bbcode_enabled = true)\n3.Set text content with a table that includes padding, for example:\n```\n[table=1]\n[cell bg=black padding=20,20,20,20]Lorem ipsum dolor sit amet, consectetur adipiscing elit.[/cell]\n[/table]\n```\n\n\n### Minimal reproduction project (MRP)\n\n[padding-misalignment.zip](https://github.com/user-attachments/files/19135134/padding-misalignment.zip)\n", "patch": "diff --git a/scene/gui/rich_text_label.cpp b/scene/gui/rich_text_label.cpp\nindex 19d59e53c99f..d3648c9faf02 100644\n--- a/scene/gui/rich_text_label.cpp\n+++ b/scene/gui/rich_text_label.cpp\n@@ -685,6 +685,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t} else {\n \t\t\tp_table->total_width += p_table->columns[i].width;\n \t\t}\n+\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t}\n \n \t// Resize to max_width if needed and distribute the remaining space.\n@@ -702,6 +703,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\tp_table->columns[i].width = p_table->columns[i].max_width;\n \t\t\t\tp_table->total_width -= dif;\n \t\t\t\ttotal_ratio -= p_table->columns[i].expand_ratio;\n+\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t}\n \t\t}\n \t\t// Grow.\n@@ -715,6 +717,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t\t\t\t\tint incr = MIN(dif, slice);\n \t\t\t\t\t\tp_table->columns[i].width += incr;\n \t\t\t\t\t\tp_table->total_width += incr;\n+\t\t\t\t\t\tp_table->columns[i].width_with_padding = p_table->columns[i].width;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n@@ -745,6 +748,7 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \n \t\t\tframe->lines[i].text_buf->set_width(p_table->columns[column].width);\n \t\t\tp_table->columns[column].width = MAX(p_table->columns[column].width, ceil(frame->lines[i].text_buf->get_size().x));\n+\t\t\tp_table->columns[column].width_with_padding = MAX(p_table->columns[column].width_with_padding, ceil(frame->lines[i].text_buf->get_size().x + frame->padding.position.x + frame->padding.size.x));\n \n \t\t\tframe->lines[i].offset.y = prev_h;\n \n@@ -780,6 +784,12 @@ void RichTextLabel::_set_table_size(ItemTable *p_table, int p_available_width) {\n \t\t}\n \t\tidx++;\n \t}\n+\n+\t// Recalculate total width.\n+\tp_table->total_width = 0;\n+\tfor (int i = 0; i < col_count; i++) {\n+\t\tp_table->total_width += p_table->columns[i].width_with_padding + theme_cache.table_h_separation;\n+\t}\n }\n \n int RichTextLabel::_draw_line(ItemFrame *p_frame, int p_line, const Vector2 &p_ofs, int p_width, float p_vsep, const Color &p_base_color, int p_outline_size, const Color &p_outline_color, const Color &p_font_shadow_color, int p_shadow_outline_size, const Point2 &p_shadow_ofs, int &r_processed_glyphs) {\ndiff --git a/scene/gui/rich_text_label.h b/scene/gui/rich_text_label.h\nindex 013ee15c03fe..dd1cedcd8bb5 100644\n--- a/scene/gui/rich_text_label.h\n+++ b/scene/gui/rich_text_label.h\n@@ -347,6 +347,7 @@ class RichTextLabel : public Control {\n \t\t\tint min_width = 0;\n \t\t\tint max_width = 0;\n \t\t\tint width = 0;\n+\t\t\tint width_with_padding = 0;\n \t\t};\n \n \t\tLocalVector<Column> columns;\n", "instance_id": "godotengine__godot-104662", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear, earning a score of 2 (Mostly Clear). The issue is well-defined: misalignment in tables with padding in a `RichTextLabel` when BBCode is enabled in the Godot engine. The description includes specific steps to reproduce the issue, a minimal reproduction project (MRP), and relevant system information, which aids in understanding the context. However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly define what \"correct\" alignment should look like, nor does it specify the expected output or behavior after the fix. Additionally, while edge cases like specific padding values or table configurations are implied, they are not explicitly mentioned. These missing details could lead to uncertainty during implementation or validation of the solution.", "difficulty_explanation": "I assign a difficulty score of 0.55, placing this problem in the medium range (0.4-0.6). Here's the breakdown based on the evaluation factors:\n\n1. **Clarity and Complexity of Problem Description**: While the problem is mostly clear, the lack of explicit expected output or detailed edge cases adds a slight layer of complexity in determining the correct fix. The logic behind table rendering and padding calculations in a graphical context (Godot engine) is moderately complex, requiring an understanding of text layout and rendering.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`rich_text_label.cpp`) and its header (`rich_text_label.h`), specifically within the table sizing logic. The modifications involve adding a new field (`width_with_padding`) to track padded widths and updating the total width calculation to account for padding and separation. The changes are relatively small (a few lines of code) and do not appear to impact the broader system architecture. However, they require understanding the existing table rendering logic and how padding interacts with width calculations, which adds some depth to the task.\n\n3. **Number of Technical Concepts**: Solving this requires familiarity with C++ (as the Godot engine is written in it), specifically struct modifications and pointer handling. Additionally, it demands domain-specific knowledge of text rendering in GUI systems, particularly how Godot's `RichTextLabel` processes BBCode and applies padding. While no advanced algorithms or design patterns are involved, understanding the rendering pipeline and offset calculations is non-trivial for someone unfamiliar with GUI programming or Godot's internals.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of table rendering suggests potential issues like zero or negative padding, very large padding values, nested tables, or interactions with other BBCode features. The code changes do not introduce explicit error handling, but ensuring the fix works across various table configurations and padding values adds moderate complexity. There is also a risk of introducing new bugs in width calculations if edge cases are not considered.\n\nOverall, this problem is of medium difficulty because it requires a moderate understanding of Godot's rendering logic and careful handling of padding in table layouts. It is not a simple bug fix (e.g., changing a constant), nor is it a highly complex architectural change. It sits in the middle, requiring targeted modifications with some risk of unintended side effects if not thoroughly tested. The score of 0.55 reflects this balance, leaning slightly above the midpoint of the medium range due to the domain-specific knowledge required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Script Editor - Error Panel stays open after error fixed\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.7260) - AMD Ryzen 3 3100 4-Core Processor (8 threads)\n\n### Issue description\n\nScript Editor - Error Panel stays open after error fixed\nin order to close the panel, need to cause an error to have the expand collapse button, this fresh first error after fix also collapses the panel.\n\n### Steps to reproduce\n\ncreate a script.\nmake an error,\nexpand the error panel\nfix the error in script\n> now you have the panel open with no errors but also no way to hide this Error Panel\n\n### Minimal reproduction project (MRP)\n\nAny simple project would do.\n", "patch": "diff --git a/editor/code_editor.cpp b/editor/code_editor.cpp\nindex bc678b5ba1be..1b77ae749e40 100644\n--- a/editor/code_editor.cpp\n+++ b/editor/code_editor.cpp\n@@ -1668,9 +1668,9 @@ void CodeTextEditor::set_error_count(int p_error_count) {\n \terror_button->set_text(itos(p_error_count));\n \terror_button->set_visible(p_error_count > 0);\n \tif (p_error_count > 0) {\n-\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time_with_errors); // Parsing should happen sooner.\n \t} else {\n+\t\t_set_show_errors_panel(false);\n \t\tidle->set_wait_time(idle_time);\n \t}\n }\n", "instance_id": "godotengine__godot-104169", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the Script Editor's Error Panel in Godot v4.4.stable remains open even after an error is fixed, with no apparent way to close it unless another error is triggered. The steps to reproduce are straightforward and easy to follow, and the issue's context (Script Editor in Godot) is provided along with system information. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the panel auto-close when no errors exist, or should there be a manual close button?). Additionally, there are no mentions of edge cases or specific constraints that might affect the solution. While the issue is understandable, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, as it involves a single file (`code_editor.cpp`) and a small modification to the logic in the `set_error_count` method. The change appears to address the issue by ensuring the error panel is hidden when the error count reaches zero, which is a simple adjustment. Second, the technical concepts required are basic: understanding of C++ syntax, conditional logic, and familiarity with the Godot editor's codebase structure. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic UI handling in Godot are needed. Third, the change does not impact the broader system architecture or require understanding complex interactions between modules. Finally, while the problem statement does not explicitly mention edge cases, the nature of the issue (UI panel visibility) suggests minimal complexity in error handling—likely just ensuring the panel state is correctly toggled based on error count. Overall, this is a straightforward bug fix requiring minimal effort and understanding, hence a difficulty score of 0.25.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Callable.callv() will make call with wrong arguments if a const Array is passed\n### Tested versions\r\n\r\n- Reproducible in 4.3.beta2.official [b75f0485b]\r\n\r\n### System information\r\n\r\nWindows 10 - Godot 4.3.beta2.official [b75f0485b]\r\n\r\n### Issue description\r\n\r\nUsing Callable().callv() will result in a call using the wrong arguments, if the Array being passed is a const.\r\nThe bug does not occur if the Array being passed is a var.\r\nThe bug does not occur if we use Callable().bindv().call() instead.\r\n\r\n### Steps to reproduce\r\n\r\nThe following code can demonstrate the bug. The debugger does not show any errors or warnings.\r\n```extends Node2D\r\n\r\nconst arr_const = ['one','two','three','four']\r\nvar arr_var = ['one','two','three','four']\r\n\r\nfunc _ready() -> void:\r\n\t# non-const works\r\n\tsomefunc.callv(arr_var)\r\n\t# const fails\r\n\tsomefunc.callv(arr_const)\r\n\t# temporary workaround\r\n\tsomefunc.bindv(arr_const).call()\r\n\t\r\nfunc somefunc(v1,v2,v3,v4):\r\n\tprint('%s,%s,%s,%s'% [v1,v2,v3,v4])\r\n```\r\nwill print:\r\n```\r\none,two,three,four\r\nfour,four,four,four\r\none,two,three,four\r\n```\r\nThe first and third calls work as expected, with the four arguments in the arrays.\r\nOnly the second call, which used a const Array and .callv(), made a call with all arguments replaced by the last argument.\r\n\r\nIn this example, I use a function directly, but this can be reproduced with any Callable().\r\n\r\nThis seems like a similar issue as #69237, with a similar workaround, but in this case the correct number of arguments was passed.\r\n\r\n\r\n### Minimal reproduction project (MRP)\r\n\r\n[callablecheck.zip](https://github.com/user-attachments/files/15974691/callablecheck.zip)\r\n\n", "patch": "diff --git a/core/variant/array.cpp b/core/variant/array.cpp\nindex d91612b420ca..2357e3f907ab 100644\n--- a/core/variant/array.cpp\n+++ b/core/variant/array.cpp\n@@ -88,11 +88,11 @@ Array::Iterator Array::end() {\n }\n \n Array::ConstIterator Array::begin() const {\n-\treturn ConstIterator(_p->array.ptr(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr());\n }\n \n Array::ConstIterator Array::end() const {\n-\treturn ConstIterator(_p->array.ptr() + _p->array.size(), _p->read_only);\n+\treturn ConstIterator(_p->array.ptr() + _p->array.size());\n }\n \n Variant &Array::operator[](int p_idx) {\n@@ -104,10 +104,6 @@ Variant &Array::operator[](int p_idx) {\n }\n \n const Variant &Array::operator[](int p_idx) const {\n-\tif (unlikely(_p->read_only)) {\n-\t\t*_p->read_only = _p->array[p_idx];\n-\t\treturn *_p->read_only;\n-\t}\n \treturn _p->array[p_idx];\n }\n \ndiff --git a/core/variant/array.h b/core/variant/array.h\nindex 841b6ff8eaa4..a796a2581171 100644\n--- a/core/variant/array.h\n+++ b/core/variant/array.h\n@@ -56,21 +56,19 @@ class Array {\n \t\t_FORCE_INLINE_ bool operator==(const ConstIterator &p_other) const { return element_ptr == p_other.element_ptr; }\n \t\t_FORCE_INLINE_ bool operator!=(const ConstIterator &p_other) const { return element_ptr != p_other.element_ptr; }\n \n-\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr, Variant *p_read_only = nullptr) :\n-\t\t\t\telement_ptr(p_element_ptr), read_only(p_read_only) {}\n+\t\t_FORCE_INLINE_ ConstIterator(const Variant *p_element_ptr) :\n+\t\t\t\telement_ptr(p_element_ptr) {}\n \t\t_FORCE_INLINE_ ConstIterator() {}\n \t\t_FORCE_INLINE_ ConstIterator(const ConstIterator &p_other) :\n-\t\t\t\telement_ptr(p_other.element_ptr), read_only(p_other.read_only) {}\n+\t\t\t\telement_ptr(p_other.element_ptr) {}\n \n \t\t_FORCE_INLINE_ ConstIterator &operator=(const ConstIterator &p_other) {\n \t\t\telement_ptr = p_other.element_ptr;\n-\t\t\tread_only = p_other.read_only;\n \t\t\treturn *this;\n \t\t}\n \n \tprivate:\n \t\tconst Variant *element_ptr = nullptr;\n-\t\tVariant *read_only = nullptr;\n \t};\n \n \tstruct Iterator {\n@@ -96,7 +94,7 @@ class Array {\n \t\t}\n \n \t\toperator ConstIterator() const {\n-\t\t\treturn ConstIterator(element_ptr, read_only);\n+\t\t\treturn ConstIterator(element_ptr);\n \t\t}\n \n \tprivate:\ndiff --git a/core/variant/variant.h b/core/variant/variant.h\nindex e38f7c9b0bae..f0bd7ec6824e 100644\n--- a/core/variant/variant.h\n+++ b/core/variant/variant.h\n@@ -997,18 +997,10 @@ Array::Iterator &Array::Iterator::operator--() {\n }\n \n const Variant &Array::ConstIterator::operator*() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn *read_only;\n-\t}\n \treturn *element_ptr;\n }\n \n const Variant *Array::ConstIterator::operator->() const {\n-\tif (unlikely(read_only)) {\n-\t\t*read_only = *element_ptr;\n-\t\treturn read_only;\n-\t}\n \treturn element_ptr;\n }\n \n", "instance_id": "godotengine__godot-103999", "clarity": 3, "difficulty": 0.55, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly describes the issue with `Callable().callv()` when a const Array is passed, including the specific behavior (arguments being replaced by the last element). The goal is evident: fix the bug related to const Array handling in the Godot engine. The input, output, and constraints are implicitly defined through the provided code example and the minimal reproduction project (MRP). The steps to reproduce are detailed, and the expected versus actual output is explicitly shown. Additionally, the statement references a similar issue (#69237) for context and provides a workaround, which adds to the clarity. There are no significant ambiguities, and the problem description includes all critical details needed to understand and address the issue.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. \n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, affecting only a few files (`array.cpp`, `array.h`, and `variant.h`) in the Godot engine's core variant system. The modifications involve removing logic related to a `read_only` variable in the `ConstIterator` class and associated dereferencing operations. While the changes are not extensive in terms of lines of code, they impact a critical part of the engine (the variant and array handling system), which requires careful consideration to avoid introducing new bugs. The changes do not appear to affect the broader system architecture but do require understanding the internal representation of arrays and their const behavior.\n\n2. **Number of Technical Concepts**: Solving this problem requires a moderate understanding of C++ concepts, specifically const correctness, iterators, and pointer dereferencing. Familiarity with Godot's internal `Variant` and `Array` classes is necessary, as these are core components of the engine's type system. The bug relates to how const arrays are accessed and copied, which involves understanding memory management and the implications of removing the `read_only` workaround. While the concepts are not overly advanced, they do require a solid grasp of C++ and some domain-specific knowledge of Godot's internals.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention additional edge cases beyond the const Array issue, and the code changes do not introduce new error handling logic. However, since the fix modifies how const arrays are accessed, there is an implicit need to ensure that other use cases (e.g., different array sizes, types of elements, or concurrent access) are not adversely affected. This adds a layer of complexity to testing and validation, though it is not explicitly detailed in the problem.\n\n4. **Overall Complexity**: The problem is not trivial as it involves debugging and modifying a core component of a game engine, which inherently carries risks of unintended side effects. However, it is not extremely challenging either, as the bug is well-isolated, and the fix is straightforward once the root cause (improper handling of const arrays via `read_only`) is identified. The difficulty lies in understanding the specific behavior of Godot's `Array` class and ensuring the fix does not break other functionality, which places it in the medium range.\n\nA score of 0.55 reflects a medium difficulty level, leaning slightly above the midpoint due to the need for domain-specific knowledge of Godot and the potential impact on a critical system component, balanced by the localized nature of the changes and the clarity of the bug's manifestation.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Skeleton's deferred update process should be performed after physics interpolation\n### Tested versions\n\n- Reproduced in v4.4.beta4.official [93d270693]\n\n### System information\n\nGodot v4.4.beta4 - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3070 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i9-12900K (24 threads)\n\n### Issue description\n\nEnabling physics interpolation in project settings and following procedures to manually implement interpolation for camera movement ([trying to follow this](https://docs.godotengine.org/en/3.6/tutorials/physics/interpolation/advanced_physics_interpolation.html#mouse-look)) results in the SkeletonIK3D failing to have physics interpolation while moving and looking around, while everything else is smooth:\n\nhttps://github.com/user-attachments/assets/0645a0ac-7f8b-48fe-a912-1e8695df23ec\n\n\nIt is noteworthy that disabling physics interpolation globally but keeping the manual implementation on the camera results in smooth ik movement when looking around but NOT while walking:\n\nhttps://github.com/user-attachments/assets/bf066442-43d8-4549-9d8b-55cc49cd6035\n\nIt's entirely possible I am implementing this incorrectly, in which case, better documentation/information would be really helpful, as currently it seems unclear how to properly implement first person camera mouse movement with physics interpolation on high refresh monitors and inverse kinematics.\n\n### Steps to reproduce\n\n1. Enable physics interpolation globally and turn down the physics tick rate to 10 (so the effect is more clear)\n2. Create a first person player with a camera child that is top level and has it's interpolation turned off, and manually implemented (see camera_3d.gd)\n3. Using a rigged model (provided in the MRP) attach a skeletonIK3D node and put its target to a Marker3D node that is a child of the camera\n4. Play the project and walk/look around\n\n\n### Minimal reproduction project (MRP)\n\n[firstpersontest.zip](https://github.com/user-attachments/files/18858802/firstpersontest.zip)\n", "patch": "diff --git a/core/local_vector.h b/core/local_vector.h\nindex fe14dbb494ef..5dfe273c40c7 100644\n--- a/core/local_vector.h\n+++ b/core/local_vector.h\n@@ -104,6 +104,15 @@ class LocalVector {\n \t\t}\n \t}\n \n+\tbool erase_unordered(const T &p_val) {\n+\t\tint64_t idx = find(p_val);\n+\t\tif (idx >= 0) {\n+\t\t\tremove_unordered(idx);\n+\t\t\treturn true;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n \tU erase_multiple_unordered(const T &p_val) {\n \t\tU from = 0;\n \t\tU count = 0;\ndiff --git a/doc/classes/BoneAttachment.xml b/doc/classes/BoneAttachment.xml\nindex 8d427fbf8eb3..703a231b22d9 100644\n--- a/doc/classes/BoneAttachment.xml\n+++ b/doc/classes/BoneAttachment.xml\n@@ -14,6 +14,7 @@\n \t\t<member name=\"bone_name\" type=\"String\" setter=\"set_bone_name\" getter=\"get_bone_name\" default=\"&quot;&quot;\">\n \t\t\tThe name of the attached bone.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t</members>\n \t<constants>\n \t</constants>\ndiff --git a/doc/classes/VehicleWheel.xml b/doc/classes/VehicleWheel.xml\nindex c51542abe72c..67a80e0bf832 100644\n--- a/doc/classes/VehicleWheel.xml\n+++ b/doc/classes/VehicleWheel.xml\n@@ -52,6 +52,7 @@\n \t\t\t[b]Note:[/b] The simulation does not take the effect of gears into account, you will need to add logic for this if you wish to simulate gears.\n \t\t\tA negative value will result in the wheel reversing.\n \t\t</member>\n+\t\t<member name=\"physics_interpolation_mode\" type=\"int\" setter=\"set_physics_interpolation_mode\" getter=\"get_physics_interpolation_mode\" overrides=\"Node\" enum=\"Node.PhysicsInterpolationMode\" default=\"1\" />\n \t\t<member name=\"steering\" type=\"float\" setter=\"set_steering\" getter=\"get_steering\" default=\"0.0\">\n \t\t\tThe steering angle for the wheel. Setting this to a non-zero value will result in the vehicle turning when it's moving.\n \t\t</member>\ndiff --git a/doc/classes/VisualServer.xml b/doc/classes/VisualServer.xml\nindex 027a4a1c2413..042fe81ba650 100644\n--- a/doc/classes/VisualServer.xml\n+++ b/doc/classes/VisualServer.xml\n@@ -1488,14 +1488,6 @@\n \t\t\t\tSets a material that will override the material for all surfaces on the mesh associated with this instance. Equivalent to [member GeometryInstance.material_override].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_reset_physics_interpolation\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<description>\n-\t\t\t\tPrevents physics interpolation for the current physics tick.\n-\t\t\t\tThis is useful when moving an instance to a new location, to give an instantaneous change rather than interpolation from the previous location.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_base\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n@@ -1537,14 +1529,6 @@\n \t\t\t\tSets a margin to increase the size of the AABB when culling objects from the view frustum. This allows you to avoid culling objects that fall outside the view frustum. Equivalent to [member GeometryInstance.extra_cull_margin].\n \t\t\t</description>\n \t\t</method>\n-\t\t<method name=\"instance_set_interpolated\">\n-\t\t\t<return type=\"void\" />\n-\t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\n-\t\t\t<argument index=\"1\" name=\"interpolated\" type=\"bool\" />\n-\t\t\t<description>\n-\t\t\t\tTurns on and off physics interpolation for the instance.\n-\t\t\t</description>\n-\t\t</method>\n \t\t<method name=\"instance_set_layer_mask\">\n \t\t\t<return type=\"void\" />\n \t\t\t<argument index=\"0\" name=\"instance\" type=\"RID\" />\ndiff --git a/scene/3d/arvr_nodes.cpp b/scene/3d/arvr_nodes.cpp\nindex 7b5e96759bf6..a68360fb6d8e 100644\n--- a/scene/3d/arvr_nodes.cpp\n+++ b/scene/3d/arvr_nodes.cpp\n@@ -613,7 +613,7 @@ void ARVROrigin::_notification(int p_what) {\n \t\t}; break;\n \t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n \t\t\t// set our world origin to our node transform\n-\t\t\tarvr_server->set_world_origin(get_global_transform());\n+\t\t\tarvr_server->set_world_origin(get_global_transform_interpolated());\n \n \t\t\t// check if we have a primary interface\n \t\t\tRef<ARVRInterface> arvr_interface = arvr_server->get_primary_interface();\ndiff --git a/scene/3d/bone_attachment.cpp b/scene/3d/bone_attachment.cpp\nindex fc9f67abd526..5b2f4cd25492 100644\n--- a/scene/3d/bone_attachment.cpp\n+++ b/scene/3d/bone_attachment.cpp\n@@ -105,6 +105,7 @@ void BoneAttachment::_notification(int p_what) {\n }\n \n BoneAttachment::BoneAttachment() {\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n \tbound = false;\n }\n \ndiff --git a/scene/3d/camera.cpp b/scene/3d/camera.cpp\nindex 8645e8567ee4..5b59a6785139 100644\n--- a/scene/3d/camera.cpp\n+++ b/scene/3d/camera.cpp\n@@ -45,6 +45,13 @@ void Camera::_request_camera_update() {\n \t_update_camera();\n }\n \n+void Camera::fti_update_servers() {\n+\tif (camera.is_valid()) {\n+\t\tTransform tr = _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n+\t\tVisualServer::get_singleton()->camera_set_transform(camera, tr);\n+\t}\n+}\n+\n void Camera::_update_camera_mode() {\n \tforce_change = true;\n \tswitch (mode) {\n@@ -85,12 +92,8 @@ void Camera::_update_camera() {\n \tif (!is_physics_interpolated_and_enabled()) {\n \t\tVisualServer::get_singleton()->camera_set_transform(camera, get_camera_transform());\n \t} else {\n-\t\t// Ideally we shouldn't be moving a physics interpolated camera within a frame,\n-\t\t// because it will break smooth interpolation, but it may occur on e.g. level load.\n-\t\tif (!Engine::get_singleton()->is_in_physics_frame() && camera.is_valid()) {\n-\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t}\n+\t\t// Force a refresh next frame.\n+\t\tfti_notify_node_changed();\n \t}\n \n \t// here goes listener stuff\n@@ -114,40 +117,6 @@ void Camera::_physics_interpolated_changed() {\n \t_update_process_mode();\n }\n \n-void Camera::_physics_interpolation_ensure_data_flipped() {\n-\t// The curr -> previous update can either occur\n-\t// on the INTERNAL_PHYSICS_PROCESS OR\n-\t// on NOTIFICATION_TRANSFORM_CHANGED,\n-\t// if NOTIFICATION_TRANSFORM_CHANGED takes place\n-\t// earlier than INTERNAL_PHYSICS_PROCESS on a tick.\n-\t// This is to ensure that the data keeps flowing, but the new data\n-\t// doesn't overwrite before prev has been set.\n-\n-\t// Keep the data flowing.\n-\tuint64_t tick = Engine::get_singleton()->get_physics_frames();\n-\tif (_interpolation_data.last_update_physics_tick != tick) {\n-\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t_interpolation_data.last_update_physics_tick = tick;\n-\t\tphysics_interpolation_flip_data();\n-\t}\n-}\n-\n-void Camera::_physics_interpolation_ensure_transform_calculated(bool p_force) const {\n-\tDEV_CHECK_ONCE(!Engine::get_singleton()->is_in_physics_frame());\n-\n-\tInterpolationData &id = _interpolation_data;\n-\tuint64_t frame = Engine::get_singleton()->get_frames_drawn();\n-\n-\tif (id.last_update_frame != frame || p_force) {\n-\t\tid.last_update_frame = frame;\n-\n-\t\tTransformInterpolator::interpolate_transform(id.xform_prev, id.xform_curr, id.xform_interpolated, Engine::get_singleton()->get_physics_interpolation_fraction());\n-\n-\t\tTransform &tr = id.camera_xform_interpolated;\n-\t\ttr = _get_adjusted_camera_transform(id.xform_interpolated);\n-\t}\n-}\n-\n void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal) {\n \t_desired_process_internal = p_process_internal;\n \t_desired_physics_process_internal = p_physics_process_internal;\n@@ -155,17 +124,8 @@ void Camera::set_desired_process_modes(bool p_process_internal, bool p_physics_p\n }\n \n void Camera::_update_process_mode() {\n-\tbool process = _desired_process_internal;\n-\tbool physics_process = _desired_physics_process_internal;\n-\n-\tif (is_physics_interpolated_and_enabled()) {\n-\t\tif (is_current()) {\n-\t\t\tprocess = true;\n-\t\t\tphysics_process = true;\n-\t\t}\n-\t}\n-\tset_process_internal(process);\n-\tset_physics_process_internal(physics_process);\n+\tset_process_internal(_desired_process_internal);\n+\tset_physics_process_internal(_desired_physics_process_internal);\n }\n \n void Camera::_notification(int p_what) {\n@@ -182,56 +142,21 @@ void Camera::_notification(int p_what) {\n \t\t\t\tviewport->_camera_set(this);\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && camera.is_valid()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated();\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated Camera: \" + rtos(_interpolation_data.xform_interpolated.origin.x) + \"\\t( prev \" + rtos(_interpolation_data.xform_prev.origin.x) + \", curr \" + rtos(_interpolation_data.xform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_INTERNAL_PHYSICS_PROCESS: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (is_physics_interpolated_and_enabled()) {\n-\t\t\t\t_physics_interpolation_ensure_data_flipped();\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n #if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n \t\t\t\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n \t\t\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(get_instance_id(), \"Interpolated Camera triggered from outside physics process\");\n \t\t\t\t}\n-#endif\n \t\t\t}\n+#endif\n \t\t\t_request_camera_update();\n \t\t\tif (doppler_tracking != DOPPLER_TRACKING_DISABLED) {\n \t\t\t\tvelocity_tracker->update_position(get_global_transform().origin);\n \t\t\t}\n-\t\t\t// Allow auto-reset when first adding to the tree, as a convenience.\n-\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n-\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n-\t\t\t\t_set_physics_interpolation_reset_requested(false);\n-\t\t\t}\n-\n \t\t} break;\n \t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (is_inside_tree()) {\n-\t\t\t\t_interpolation_data.xform_curr = get_global_transform();\n-\t\t\t\t_interpolation_data.xform_prev = _interpolation_data.xform_curr;\n-\t\t\t\t_update_process_mode();\n-\t\t\t}\n-\t\t} break;\n-\t\tcase NOTIFICATION_PAUSED: {\n-\t\t\tif (is_physics_interpolated_and_enabled() && is_inside_tree() && is_visible_in_tree()) {\n-\t\t\t\t_physics_interpolation_ensure_transform_calculated(true);\n-\t\t\t\tVisualServer::get_singleton()->camera_set_transform(camera, _interpolation_data.camera_xform_interpolated);\n-\t\t\t}\n+\t\t\t_update_process_mode();\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tif (!get_tree()->is_node_being_edited(this)) {\n@@ -274,8 +199,7 @@ Transform Camera::_get_adjusted_camera_transform(const Transform &p_xform) const\n \n Transform Camera::get_camera_transform() const {\n \tif (is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame()) {\n-\t\t_physics_interpolation_ensure_transform_calculated();\n-\t\treturn _interpolation_data.camera_xform_interpolated;\n+\t\treturn _get_adjusted_camera_transform(_get_cached_global_transform_interpolated());\n \t}\n \n \treturn _get_adjusted_camera_transform(get_global_transform());\n@@ -865,9 +789,16 @@ float ClippedCamera::get_margin() const {\n \treturn margin;\n }\n void ClippedCamera::set_process_mode(ProcessMode p_mode) {\n-\tif (is_physics_interpolated_and_enabled() && p_mode == CLIP_PROCESS_IDLE) {\n-\t\tp_mode = CLIP_PROCESS_PHYSICS;\n-\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\tif (is_physics_interpolated_and_enabled()) {\n+\t\tif (p_mode == CLIP_PROCESS_IDLE) {\n+\t\t\tp_mode = CLIP_PROCESS_PHYSICS;\n+\t\t\tWARN_PRINT_ONCE(\"[Physics interpolation] Forcing ClippedCamera to PROCESS_PHYSICS mode.\");\n+\t\t}\n+\n+\t\tprocess_mode = p_mode;\n+\n+\t\tset_desired_process_modes(false, true);\n+\t\treturn;\n \t}\n \n \tif (process_mode == p_mode) {\n@@ -881,8 +812,11 @@ ClippedCamera::ProcessMode ClippedCamera::get_process_mode() const {\n \treturn process_mode;\n }\n \n-void ClippedCamera::physics_interpolation_flip_data() {\n+void ClippedCamera::fti_pump() {\n \t_interpolation_data.clip_offset_prev = _interpolation_data.clip_offset_curr;\n+\n+\t// Must call the base class.\n+\tSpatial::fti_pump();\n }\n \n void ClippedCamera::_physics_interpolated_changed() {\n@@ -899,6 +833,11 @@ Transform ClippedCamera::_get_adjusted_camera_transform(const Transform &p_xform\n \treturn t;\n }\n \n+void ClippedCamera::fti_update_servers() {\n+\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n+\tCamera::fti_update_servers();\n+}\n+\n void ClippedCamera::_notification(int p_what) {\n \tif (p_what == NOTIFICATION_ENTER_TREE) {\n \t\t// Switch process mode to physics if we are turning on interpolation.\n@@ -966,10 +905,6 @@ void ClippedCamera::_notification(int p_what) {\n \t\t_update_camera();\n \t}\n \n-\tif (is_physics_interpolated_and_enabled() && (p_what == NOTIFICATION_INTERNAL_PROCESS)) {\n-\t\tclip_offset = ((_interpolation_data.clip_offset_curr - _interpolation_data.clip_offset_prev) * Engine::get_singleton()->get_physics_interpolation_fraction()) + _interpolation_data.clip_offset_prev;\n-\t}\n-\n \tif (p_what == NOTIFICATION_LOCAL_TRANSFORM_CHANGED) {\n \t\tupdate_gizmo();\n \t}\ndiff --git a/scene/3d/camera.h b/scene/3d/camera.h\nindex afa95b046bbe..72fdb2641d05 100644\n--- a/scene/3d/camera.h\n+++ b/scene/3d/camera.h\n@@ -91,26 +91,10 @@ class Camera : public Spatial {\n \tRef<SpatialVelocityTracker> velocity_tracker;\n \tbool affect_lod = true;\n \n-\t///////////////////////////////////////////////////////\n-\t// INTERPOLATION FUNCTIONS\n-\tvoid _physics_interpolation_ensure_transform_calculated(bool p_force = false) const;\n-\tvoid _physics_interpolation_ensure_data_flipped();\n-\n-\t// These can be set by derived Cameras,\n-\t// if they wish to do processing (while still\n-\t// allowing physics interpolation to function).\n+\t// These can be set by derived Cameras.\n \tbool _desired_process_internal = false;\n \tbool _desired_physics_process_internal = false;\n \n-\tmutable struct InterpolationData {\n-\t\tTransform xform_curr;\n-\t\tTransform xform_prev;\n-\t\tTransform xform_interpolated;\n-\t\tTransform camera_xform_interpolated; // After modification according to camera type.\n-\t\tuint32_t last_update_physics_tick = 0;\n-\t\tuint32_t last_update_frame = UINT32_MAX;\n-\t} _interpolation_data;\n-\n \tvoid _update_process_mode();\n \n protected:\n@@ -118,9 +102,6 @@ class Camera : public Spatial {\n \t// This is because physics interpolation may need to request process modes additionally.\n \tvoid set_desired_process_modes(bool p_process_internal, bool p_physics_process_internal);\n \n-\t// Opportunity for derived classes to interpolate extra attributes.\n-\tvirtual void physics_interpolation_flip_data() {}\n-\n \tvirtual void _physics_interpolated_changed();\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n \t///////////////////////////////////////////////////////\n@@ -128,6 +109,7 @@ class Camera : public Spatial {\n \tvoid _update_camera();\n \tvirtual void _request_camera_update();\n \tvoid _update_camera_mode();\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tvirtual void _validate_property(PropertyInfo &p_property) const;\n@@ -248,8 +230,9 @@ class ClippedCamera : public Camera {\n \n protected:\n \tvirtual Transform _get_adjusted_camera_transform(const Transform &p_xform) const;\n-\tvirtual void physics_interpolation_flip_data();\n+\tvirtual void fti_pump();\n \tvirtual void _physics_interpolated_changed();\n+\tvirtual void fti_update_servers();\n \t///////////////////////////////////////////////////////\n \n \tvoid _notification(int p_what);\ndiff --git a/scene/3d/spatial.cpp b/scene/3d/spatial.cpp\nindex cac9673bfa06..394f334adc48 100644\n--- a/scene/3d/spatial.cpp\n+++ b/scene/3d/spatial.cpp\n@@ -118,7 +118,7 @@ void Spatial::_propagate_transform_changed(Spatial *p_origin) {\n #endif\n \t\tget_tree()->xform_change_list.add(&xform_change);\n \t}\n-\tdata.dirty |= DIRTY_GLOBAL;\n+\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED;\n \n \tdata.children_lock--;\n }\n@@ -174,13 +174,27 @@ void Spatial::_notification(int p_what) {\n \t\t\t\t_propagate_merging_allowed(merging_allowed);\n \t\t\t}\n \n-\t\t\tdata.dirty |= DIRTY_GLOBAL; //global is always dirty upon entering a scene\n+\t\t\tdata.dirty |= DIRTY_GLOBAL | DIRTY_GLOBAL_INTERPOLATED; //global is always dirty upon entering a scene\n \t\t\t_notify_dirty();\n \n \t\t\tnotification(NOTIFICATION_ENTER_WORLD);\n \n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\t// Always reset FTI when entering tree.\n+\t\t\t\tfti_pump();\n+\n+\t\t\t\t// No need to interpolate as we are doing a reset.\n+\t\t\t\tdata.global_transform_interpolated = get_global_transform();\n+\n+\t\t\t\t// Make sure servers are up to date.\n+\t\t\t\tfti_update_servers();\n+\t\t\t}\n \t\t} break;\n \t\tcase NOTIFICATION_EXIT_TREE: {\n+\t\t\tif (is_inside_tree()) {\n+\t\t\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t\t\t}\n+\n \t\t\tnotification(NOTIFICATION_EXIT_WORLD, true);\n \t\t\tif (xform_change.in_list()) {\n \t\t\t\tget_tree()->xform_change_list.remove(&xform_change);\n@@ -252,6 +266,13 @@ void Spatial::_notification(int p_what) {\n \t\t\tif (data.client_physics_interpolation_data) {\n \t\t\t\tdata.client_physics_interpolation_data->global_xform_prev = data.client_physics_interpolation_data->global_xform_curr;\n \t\t\t}\n+\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t} break;\n+\n+\t\tcase NOTIFICATION_PAUSED: {\n+\t\t\tif (is_physics_interpolated_and_enabled()) {\n+\t\t\t\tdata.local_transform_prev = data.local_transform;\n+\t\t\t}\n \t\t} break;\n \n \t\tdefault: {\n@@ -281,7 +302,22 @@ void Spatial::set_global_rotation(const Vector3 &p_euler_rad) {\n \tset_global_transform(transform);\n }\n \n+void Spatial::fti_pump() {\n+\tif (data.dirty & DIRTY_LOCAL) {\n+\t\t_update_local_transform();\n+\t}\n+\n+\tdata.local_transform_prev = data.local_transform;\n+}\n+\n+void Spatial::fti_notify_node_changed() {\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_set_transform(*this);\n+\t}\n+}\n+\n void Spatial::set_transform(const Transform &p_transform) {\n+\tfti_notify_node_changed();\n \tdata.local_transform = p_transform;\n \tdata.dirty |= DIRTY_VECTORS;\n \tdata.dirty &= ~DIRTY_LOCAL;\n@@ -404,14 +440,19 @@ Transform Spatial::_get_global_transform_interpolated(real_t p_interpolation_fra\n }\n \n Transform Spatial::get_global_transform_interpolated() {\n+#if 1\n \t// Pass through if physics interpolation is switched off.\n \t// This is a convenience, as it allows you to easy turn off interpolation\n \t// without changing any code.\n-\tif (!is_physics_interpolated_and_enabled()) {\n-\t\treturn get_global_transform();\n+\tif (data.fti_global_xform_interp_set && is_physics_interpolated_and_enabled() && !Engine::get_singleton()->is_in_physics_frame() && is_visible_in_tree()) {\n+\t\treturn data.global_transform_interpolated;\n \t}\n \n-\t// If we are in the physics frame, the interpolated global transform is meaningless.\n+\treturn get_global_transform();\n+#else\n+\t// OLD METHOD - deprecated since moving to SceneTreeFTI,\n+\t// but leaving for reference and comparison for debugging.\n+\n \t// However, there is an exception, we may want to use this as a means of starting off the client\n \t// interpolation pump if not already started (when _is_physics_interpolated_client_side() is false).\n \tif (Engine::get_singleton()->is_in_physics_frame() && _is_physics_interpolated_client_side()) {\n@@ -419,6 +460,7 @@ Transform Spatial::get_global_transform_interpolated() {\n \t}\n \n \treturn _get_global_transform_interpolated(Engine::get_singleton()->get_physics_interpolation_fraction());\n+#endif\n }\n \n Transform Spatial::get_global_transform() const {\n@@ -484,6 +526,7 @@ Transform Spatial::get_relative_transform(const Node *p_parent) const {\n }\n \n void Spatial::set_translation(const Vector3 &p_translation) {\n+\tfti_notify_node_changed();\n \tdata.local_transform.origin = p_translation;\n \t_change_notify(\"transform\");\n \t_propagate_transform_changed(this);\n@@ -493,6 +536,7 @@ void Spatial::set_translation(const Vector3 &p_translation) {\n }\n \n void Spatial::set_rotation(const Vector3 &p_euler_rad) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.scale = data.local_transform.basis.get_scale();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -512,6 +556,7 @@ void Spatial::set_rotation_degrees(const Vector3 &p_euler_deg) {\n }\n \n void Spatial::set_scale(const Vector3 &p_scale) {\n+\tfti_notify_node_changed();\n \tif (data.dirty & DIRTY_VECTORS) {\n \t\tdata.rotation = data.local_transform.basis.get_rotation();\n \t\tdata.dirty &= ~DIRTY_VECTORS;\n@@ -1061,6 +1106,11 @@ Spatial::Spatial() :\n \tdata.disable_scale = false;\n \tdata.vi_visible = true;\n \tdata.merging_allowed = true;\n+\n+\tdata.fti_on_frame_list = false;\n+\tdata.fti_on_tick_list = false;\n+\tdata.fti_global_xform_interp_set = false;\n+\n \tdata.merging_mode = MERGING_MODE_INHERIT;\n \n \tdata.client_physics_interpolation_data = nullptr;\n@@ -1077,4 +1127,8 @@ Spatial::Spatial() :\n \n Spatial::~Spatial() {\n \t_disable_client_physics_interpolation();\n+\n+\tif (is_inside_tree()) {\n+\t\tget_tree()->get_scene_tree_fti().spatial_notify_delete(this);\n+\t}\n }\ndiff --git a/scene/3d/spatial.h b/scene/3d/spatial.h\nindex 9c80044919eb..53c595ee3f3a 100644\n--- a/scene/3d/spatial.h\n+++ b/scene/3d/spatial.h\n@@ -52,6 +52,8 @@ class Spatial : public Node {\n \tGDCLASS(Spatial, Node);\n \tOBJ_CATEGORY(\"3D\");\n \n+\tfriend class SceneTreeFTI;\n+\n public:\n \tenum MergingMode : unsigned int {\n \t\tMERGING_MODE_INHERIT,\n@@ -74,15 +76,27 @@ class Spatial : public Node {\n \t\tDIRTY_NONE = 0,\n \t\tDIRTY_VECTORS = 1,\n \t\tDIRTY_LOCAL = 2,\n-\t\tDIRTY_GLOBAL = 4\n+\t\tDIRTY_GLOBAL = 4,\n+\t\tDIRTY_GLOBAL_INTERPOLATED = 8,\n \t};\n \n \tmutable SelfList<Node> xform_change;\n \tSelfList<Spatial> _client_physics_interpolation_spatials_list;\n \n \tstruct Data {\n+\t\t// Interpolated global transform - correct on the frame only.\n+\t\t// Only used with FTI.\n+\t\tTransform global_transform_interpolated;\n+\n+\t\t// Current xforms are either\n+\t\t// * Used for everything (when not using FTI)\n+\t\t// * Correct on the physics tick (when using FTI)\n \t\tmutable Transform global_transform;\n \t\tmutable Transform local_transform;\n+\n+\t\t// Only used with FTI.\n+\t\tTransform local_transform_prev;\n+\n \t\tmutable Vector3 rotation;\n \t\tmutable Vector3 scale;\n \n@@ -108,6 +122,11 @@ class Spatial : public Node {\n \t\tbool visible : 1;\n \t\tbool disable_scale : 1;\n \n+\t\t// Scene tree interpolation\n+\t\tbool fti_on_frame_list : 1;\n+\t\tbool fti_on_tick_list : 1;\n+\t\tbool fti_global_xform_interp_set : 1;\n+\n \t\tbool merging_allowed : 1;\n \n \t\tint children_lock;\n@@ -139,9 +158,27 @@ class Spatial : public Node {\n \n \tvoid _set_vi_visible(bool p_visible);\n \tbool _is_vi_visible() const { return data.vi_visible; }\n+\n \tTransform _get_global_transform_interpolated(real_t p_interpolation_fraction);\n+\tconst Transform &_get_cached_global_transform_interpolated() const { return data.global_transform_interpolated; }\n \tvoid _disable_client_physics_interpolation();\n \n+\t// Calling this announces to the FTI system that a node has been moved,\n+\t// or requires an update in terms of interpolation\n+\t// (e.g. changing Camera zoom even if position hasn't changed).\n+\tvoid fti_notify_node_changed();\n+\n+\t// Opportunity after FTI to update the servers\n+\t// with global_transform_interpolated,\n+\t// and any custom interpolated data in derived classes.\n+\t// Make sure to call the parent class fti_update_servers(),\n+\t// so all data is updated to the servers.\n+\tvirtual void fti_update_servers() {}\n+\n+\t// Pump the FTI data, also gives a chance for inherited classes\n+\t// to pump custom data, but they *must* call the base class here too.\n+\tvirtual void fti_pump();\n+\n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\n \ndiff --git a/scene/3d/vehicle_body.cpp b/scene/3d/vehicle_body.cpp\nindex 8231e4a6daf8..724867a0bcc1 100644\n--- a/scene/3d/vehicle_body.cpp\n+++ b/scene/3d/vehicle_body.cpp\n@@ -44,7 +44,7 @@ class btVehicleJacobianEntry {\n \n \treal_t getDiagonal() const { return m_Adiag; }\n \n-\tbtVehicleJacobianEntry(){};\n+\tbtVehicleJacobianEntry() {}\n \t//constraint between two different rigidbodies\n \tbtVehicleJacobianEntry(\n \t\t\tconst Basis &world2A,\n@@ -366,6 +366,8 @@ VehicleWheel::VehicleWheel() {\n \tm_raycastInfo.m_suspensionLength = 0.0;\n \n \tbody = nullptr;\n+\n+\tset_physics_interpolation_mode(PHYSICS_INTERPOLATION_MODE_OFF);\n }\n \n void VehicleBody::_update_wheel_transform(VehicleWheel &wheel, PhysicsDirectBodyState *s) {\ndiff --git a/scene/3d/visual_instance.cpp b/scene/3d/visual_instance.cpp\nindex cf80a6742dd7..05d7414b9698 100644\n--- a/scene/3d/visual_instance.cpp\n+++ b/scene/3d/visual_instance.cpp\n@@ -82,6 +82,12 @@ void VisualInstance::set_instance_use_identity_transform(bool p_enable) {\n \t}\n }\n \n+void VisualInstance::fti_update_servers() {\n+\tif (!_is_using_identity_transform()) {\n+\t\tVisualServer::get_singleton()->instance_set_transform(get_instance(), _get_cached_global_transform_interpolated());\n+\t}\n+}\n+\n void VisualInstance::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_ENTER_WORLD: {\n@@ -97,33 +103,26 @@ void VisualInstance::_notification(int p_what) {\n \n \t\t} break;\n \t\tcase NOTIFICATION_TRANSFORM_CHANGED: {\n-\t\t\tif (_is_vi_visible() || is_physics_interpolated_and_enabled()) {\n+\t\t\tif (_is_vi_visible()) {\n \t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\n-\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n-\t\t\t\t\t// unset, to prevent streaking from the origin.\n-\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_physics_interpolated_and_enabled() && is_inside_tree()) {\n-\t\t\t\t\t\tif (_is_vi_visible()) {\n-\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t// Physics interpolated VIs don't need to send their transform immediately after setting,\n+\t\t\t\t\t// indeed it is counterproductive, because the interpolated transform will be sent\n+\t\t\t\t\t// to the VisualServer immediately prior to rendering.\n+\t\t\t\t\tif (!is_physics_interpolated_and_enabled()) {\n+\t\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\t// For instance when first adding to the tree, when the previous transform is\n+\t\t\t\t\t\t// unset, to prevent streaking from the origin.\n+\t\t\t\t\t\tif (_is_physics_interpolation_reset_requested() && is_inside_tree()) {\n+\t\t\t\t\t\t\tif (_is_vi_visible()) {\n+\t\t\t\t\t\t\t\t_notification(NOTIFICATION_RESET_PHYSICS_INTERPOLATION);\n+\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t\t}\n-\t\t\t\t\t\t_set_physics_interpolation_reset_requested(false);\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t}\n \t\t} break;\n-\t\tcase NOTIFICATION_RESET_PHYSICS_INTERPOLATION: {\n-\t\t\tif (_is_vi_visible() && is_physics_interpolated() && is_inside_tree()) {\n-\t\t\t\t// We must ensure the VisualServer transform is up to date before resetting.\n-\t\t\t\t// This is because NOTIFICATION_TRANSFORM_CHANGED is deferred,\n-\t\t\t\t// and cannot be relied to be called in order before NOTIFICATION_RESET_PHYSICS_INTERPOLATION.\n-\t\t\t\tif (!_is_using_identity_transform()) {\n-\t\t\t\t\tVisualServer::get_singleton()->instance_set_transform(instance, get_global_transform());\n-\t\t\t\t}\n-\n-\t\t\t\tVisualServer::get_singleton()->instance_reset_physics_interpolation(instance);\n-\t\t\t}\n-\t\t} break;\n \t\tcase NOTIFICATION_EXIT_WORLD: {\n \t\t\tVisualServer::get_singleton()->instance_set_scenario(instance, RID());\n \t\t\tVisualServer::get_singleton()->instance_attach_skeleton(instance, RID());\n@@ -140,10 +139,6 @@ void VisualInstance::_notification(int p_what) {\n \t}\n }\n \n-void VisualInstance::_physics_interpolated_changed() {\n-\tVisualServer::get_singleton()->instance_set_interpolated(instance, is_physics_interpolated());\n-}\n-\n RID VisualInstance::get_instance() const {\n \treturn instance;\n }\ndiff --git a/scene/3d/visual_instance.h b/scene/3d/visual_instance.h\nindex 0b605ed15c72..ce8164bff25b 100644\n--- a/scene/3d/visual_instance.h\n+++ b/scene/3d/visual_instance.h\n@@ -51,8 +51,8 @@ class VisualInstance : public CullInstance {\n protected:\n \tvoid _update_visibility();\n \tvirtual void _refresh_portal_mode();\n-\tvirtual void _physics_interpolated_changed();\n \tvoid set_instance_use_identity_transform(bool p_enable);\n+\tvirtual void fti_update_servers();\n \n \tvoid _notification(int p_what);\n \tstatic void _bind_methods();\ndiff --git a/scene/animation/skeleton_ik.cpp b/scene/animation/skeleton_ik.cpp\nindex 22561d1d7be8..8fed9677ae51 100644\n--- a/scene/animation/skeleton_ik.cpp\n+++ b/scene/animation/skeleton_ik.cpp\n@@ -276,7 +276,7 @@ void FabrikInverseKinematic::solve(Task *p_task, real_t blending_delta, bool ove\n \tp_task->skeleton->set_bone_global_pose_override(p_task->chain.chain_root.bone, Transform(), 0.0, false);\n \tVector3 origin_pos = p_task->skeleton->get_bone_global_pose(p_task->chain.chain_root.bone).origin;\n \n-\tmake_goal(p_task, p_task->skeleton->get_global_transform().affine_inverse(), blending_delta);\n+\tmake_goal(p_task, p_task->skeleton->get_global_transform_interpolated().affine_inverse(), blending_delta);\n \n \tif (p_use_magnet && p_task->chain.middle_chain_item) {\n \t\tp_task->chain.magnet_position = p_task->chain.middle_chain_item->initial_transform.origin.linear_interpolate(p_magnet_position, blending_delta);\ndiff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 6a7f4b4eb55c..33a828e41757 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -538,6 +538,8 @@ void SceneTree::set_physics_interpolation_enabled(bool p_enabled) {\n \t_physics_interpolation_enabled = p_enabled;\n \tVisualServer::get_singleton()->set_physics_interpolation_enabled(p_enabled);\n \n+\tget_scene_tree_fti().set_enabled(get_root(), p_enabled);\n+\n \t// Perform an auto reset on the root node for convenience for the user.\n \tif (root) {\n \t\troot->reset_physics_interpolation();\n@@ -563,6 +565,7 @@ void SceneTree::iteration_prepare() {\n \t\t// Make sure any pending transforms from the last tick / frame\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().tick_update();\n \t\tVisualServer::get_singleton()->tick();\n \t}\n }\n@@ -628,6 +631,17 @@ bool SceneTree::idle(float p_time) {\n \t//print_line(\"node count: \"+itos(get_node_count()));\n \t//print_line(\"TEXTURE RAM: \"+itos(VS::get_singleton()->get_render_info(VS::INFO_TEXTURE_MEM_USED)));\n \n+\t// First pass of scene tree fixed timestep interpolation.\n+\tif (get_scene_tree_fti().is_enabled()) {\n+\t\t// Special, we need to ensure RenderingServer is up to date\n+\t\t// with *all* the pending xforms *before* updating it during\n+\t\t// the FTI update.\n+\t\t// If this is not done, we can end up with a deferred `set_transform()`\n+\t\t// overwriting the interpolated xform in the server.\n+\t\tflush_transform_notifications();\n+\t\tget_scene_tree_fti().frame_update(get_root(), true);\n+\t}\n+\n \troot_lock++;\n \n \tif (MainLoop::idle(p_time)) {\n@@ -733,6 +747,11 @@ bool SceneTree::idle(float p_time) {\n \n #endif\n \n+\t// Second pass of scene tree fixed timestep interpolation.\n+\t// ToDo: Possibly needs another flush_transform_notifications here\n+\t// depending on whether there are side effects to _call_idle_callbacks().\n+\tget_scene_tree_fti().frame_update(get_root(), false);\n+\n \tVisualServer::get_singleton()->pre_draw(true);\n \n \treturn _quit;\ndiff --git a/scene/main/scene_tree.h b/scene/main/scene_tree.h\nindex 292cdf23ec28..b8ab1ed4b3fc 100644\n--- a/scene/main/scene_tree.h\n+++ b/scene/main/scene_tree.h\n@@ -35,6 +35,7 @@\n #include \"core/os/main_loop.h\"\n #include \"core/os/thread_safe.h\"\n #include \"core/self_list.h\"\n+#include \"scene/main/scene_tree_fti.h\"\n #include \"scene/resources/mesh.h\"\n #include \"scene/resources/world.h\"\n #include \"scene/resources/world_2d.h\"\n@@ -160,6 +161,7 @@ class SceneTree : public MainLoop {\n \tStretchAspect stretch_aspect;\n \tSize2i stretch_min;\n \treal_t stretch_scale;\n+\tSceneTreeFTI scene_tree_fti;\n \n \tvoid _update_font_oversampling(float p_ratio);\n \tvoid _update_root_rect();\n@@ -438,6 +440,8 @@ class SceneTree : public MainLoop {\n \tvoid client_physics_interpolation_add_spatial(SelfList<Spatial> *p_elem);\n \tvoid client_physics_interpolation_remove_spatial(SelfList<Spatial> *p_elem);\n \n+\tSceneTreeFTI &get_scene_tree_fti() { return scene_tree_fti; }\n+\n \tstatic void add_idle_callback(IdleCallback p_callback);\n \tSceneTree();\n \t~SceneTree();\ndiff --git a/scene/main/scene_tree_fti.cpp b/scene/main/scene_tree_fti.cpp\nnew file mode 100644\nindex 000000000000..f9e3ef26fbd1\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.cpp\n@@ -0,0 +1,288 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.cpp                                                    */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef _3D_DISABLED\n+\n+#include \"scene_tree_fti.h\"\n+#include \"core/engine.h\"\n+#include \"core/error_macros.h\"\n+#include \"core/math/transform_interpolator.h\"\n+#include \"core/os/os.h\"\n+#include \"scene/3d/spatial.h\"\n+#include \"scene/3d/visual_instance.h\"\n+\n+void SceneTreeFTI::_reset_flags(Node *p_node) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\tif (s) {\n+\t\ts->data.fti_on_frame_list = false;\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// In most cases the later  NOTIFICATION_RESET_PHYSICS_INTERPOLATION\n+\t\t// will reset this, but this should help cover hidden nodes.\n+\t\ts->data.local_transform_prev = s->data.local_transform;\n+\t}\n+\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_reset_flags(p_node->get_child(n));\n+\t}\n+}\n+\n+void SceneTreeFTI::set_enabled(Node *p_root, bool p_enabled) {\n+\tif (data.enabled == p_enabled) {\n+\t\treturn;\n+\t}\n+\n+\tdata.spatial_tick_list[0].clear();\n+\tdata.spatial_tick_list[1].clear();\n+\n+\t// Spatial flags must be reset.\n+\tif (p_root) {\n+\t\t_reset_flags(p_root);\n+\t}\n+\n+\tdata.enabled = p_enabled;\n+}\n+\n+void SceneTreeFTI::tick_update() {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tuint32_t curr_mirror = data.mirror;\n+\tuint32_t prev_mirror = curr_mirror ? 0 : 1;\n+\n+\tLocalVector<Spatial *> &curr = data.spatial_tick_list[curr_mirror];\n+\tLocalVector<Spatial *> &prev = data.spatial_tick_list[prev_mirror];\n+\n+\t// First detect on the previous list but not on this tick list.\n+\tfor (uint32_t n = 0; n < prev.size(); n++) {\n+\t\tSpatial *s = prev[n];\n+\t\tif (!s->data.fti_on_tick_list) {\n+\t\t\t// Needs a reset so jittering will stop.\n+\t\t\ts->fti_pump();\n+\n+\t\t\t// This may not get updated so set it to the same as global xform.\n+\t\t\t// TODO: double check this is the best value.\n+\t\t\ts->data.global_transform_interpolated = s->get_global_transform();\n+\n+\t\t\t// Remove from interpolation list.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\ts->data.fti_on_frame_list = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\t// Now pump all on the current list.\n+\tfor (uint32_t n = 0; n < curr.size(); n++) {\n+\t\tSpatial *s = curr[n];\n+\n+\t\t// Reset, needs to be marked each tick.\n+\t\ts->data.fti_on_tick_list = false;\n+\n+\t\t// Pump.\n+\t\ts->fti_pump();\n+\t}\n+\n+\t// Clear previous list and flip.\n+\tprev.clear();\n+\tdata.mirror = prev_mirror;\n+}\n+\n+void SceneTreeFTI::_spatial_notify_set_transform(Spatial &r_spatial) {\n+\t// This may be checked by the calling routine already,\n+\t// but needs to be double checked for custom SceneTrees.\n+\tif (!data.enabled || !r_spatial.is_physics_interpolated()) {\n+\t\treturn;\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_tick_list) {\n+\t\tr_spatial.data.fti_on_tick_list = true;\n+\t\tdata.spatial_tick_list[data.mirror].push_back(&r_spatial);\n+\t}\n+\n+\tif (!r_spatial.data.fti_on_frame_list) {\n+\t\tr_spatial.data.fti_on_frame_list = true;\n+\t}\n+}\n+\n+void SceneTreeFTI::spatial_notify_delete(Spatial *p_spatial) {\n+\tif (!data.enabled) {\n+\t\treturn;\n+\t}\n+\n+\tif (p_spatial->data.fti_on_frame_list) {\n+\t\tp_spatial->data.fti_on_frame_list = false;\n+\t}\n+\n+\t// This can potentially be optimized for large scenes with large churn,\n+\t// as it will be doing a linear search through the lists.\n+\tdata.spatial_tick_list[0].erase_unordered(p_spatial);\n+\tdata.spatial_tick_list[1].erase_unordered(p_spatial);\n+}\n+\n+void SceneTreeFTI::_update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform, int p_depth) {\n+\tSpatial *s = Object::cast_to<Spatial>(p_node);\n+\n+\t// Don't recurse into hidden branches.\n+\tif (s && !s->is_visible()) {\n+\t\t// NOTE : If we change from recursing entire tree, we should do an is_visible_in_tree()\n+\t\t// check for the first of the branch.\n+\t\treturn;\n+\t}\n+\n+\t// Not a Spatial.\n+\t// Could be e.g. a viewport or something\n+\t// so we should still recurse to children.\n+\tif (!s) {\n+\t\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, nullptr, p_depth + 1);\n+\t\t}\n+\t\treturn;\n+\t}\n+\n+\t// Start the active interpolation chain from here onwards\n+\t// as we recurse further into the SceneTree.\n+\t// Once we hit an active (interpolated) node, we have to fully\n+\t// process all ancestors because their xform will also change.\n+\t// Anything not moving (inactive) higher in the tree need not be processed.\n+\tif (!p_active) {\n+\t\tif (data.frame_start) {\n+\t\t\t// On the frame start, activate whenever we hit something that requests interpolation.\n+\t\t\tif (s->data.fti_on_frame_list) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// On the frame end, we want to re-interpolate *anything* that has moved\n+\t\t\t// since the frame start.\n+\t\t\tif (s->data.dirty & Spatial::DIRTY_GLOBAL_INTERPOLATED) {\n+\t\t\t\tp_active = true;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tif (data.frame_start) {\n+\t\t// Mark on the Spatial whether we have set global_transform_interp.\n+\t\t// This can later be used when calling `get_global_transform_interpolated()`\n+\t\t// to know which xform to return.\n+\t\ts->data.fti_global_xform_interp_set = p_active;\n+\t}\n+\n+\tif (p_active) {\n+#if 0\n+\t\tbool dirty = s->data.dirty & Spatial::DIRTY_GLOBAL_INTERP;\n+\n+\t\tif (data.debug) {\n+\t\t\tString sz;\n+\t\t\tfor (int n = 0; n < p_depth; n++) {\n+\t\t\t\tsz += \"\\t\";\n+\t\t\t}\n+\t\t\tprint_line(sz + p_node->get_name() + (dirty ? \" DIRTY\" : \"\"));\n+\t\t}\n+#endif\n+\n+\t\t// First calculate our local xform.\n+\t\t// This will either use interpolation, or just use the current local if not interpolated.\n+\t\tTransform local_interp;\n+\t\tif (s->is_physics_interpolated()) {\n+\t\t\tTransformInterpolator::interpolate_transform(s->data.local_transform_prev, s->data.local_transform, local_interp, p_interpolation_fraction);\n+\t\t} else {\n+\t\t\tlocal_interp = s->data.local_transform;\n+\t\t}\n+\n+\t\t// Concatenate parent xform.\n+\t\tif (!s->is_set_as_toplevel()) {\n+\t\t\tif (p_parent_global_xform) {\n+\t\t\t\ts->data.global_transform_interpolated = (*p_parent_global_xform) * local_interp;\n+\t\t\t} else {\n+\t\t\t\tconst Spatial *parent = s->get_parent_spatial();\n+\n+\t\t\t\tif (parent) {\n+\t\t\t\t\tconst Transform &parent_glob = parent->data.fti_global_xform_interp_set ? parent->data.global_transform_interpolated : parent->data.global_transform;\n+\t\t\t\t\ts->data.global_transform_interpolated = parent_glob * local_interp;\n+\t\t\t\t} else {\n+\t\t\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t\t\t}\n+\t\t\t}\n+\t\t} else {\n+\t\t\ts->data.global_transform_interpolated = local_interp;\n+\t\t}\n+\n+\t\t// Upload to VisualServer the interpolated global xform.\n+\t\ts->fti_update_servers();\n+\n+\t} // if active.\n+\n+\t// Remove the dirty interp flag from EVERYTHING as we go.\n+\ts->data.dirty &= ~Spatial::DIRTY_GLOBAL_INTERPOLATED;\n+\n+\t// Recurse to children.\n+\tfor (int n = 0; n < p_node->get_child_count(); n++) {\n+\t\t_update_dirty_spatials(p_node->get_child(n), p_current_frame, p_interpolation_fraction, p_active, s->data.fti_global_xform_interp_set ? &s->data.global_transform_interpolated : &s->data.global_transform, p_depth + 1);\n+\t}\n+}\n+\n+void SceneTreeFTI::frame_update(Node *p_root, bool p_frame_start) {\n+\tif (!data.enabled || !p_root) {\n+\t\treturn;\n+\t}\n+\n+\tdata.frame_start = p_frame_start;\n+\n+\tfloat f = Engine::get_singleton()->get_physics_interpolation_fraction();\n+\tuint32_t frame = Engine::get_singleton()->get_frames_drawn();\n+\n+// #define SCENE_TREE_FTI_TAKE_TIMINGS\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t before = OS::get_singleton()->get_ticks_usec();\n+#endif\n+\n+\tif (data.debug) {\n+\t\tprint_line(String(\"\\nScene: \") + (data.frame_start ? \"start\" : \"end\") + \"\\n\");\n+\t}\n+\n+\t// Probably not the most optimal approach as we traverse the entire SceneTree\n+\t// but simple and foolproof.\n+\t// Can be optimized later.\n+\t_update_dirty_spatials(p_root, frame, f, false);\n+\n+\tif (!p_frame_start && data.debug) {\n+\t\tdata.debug = false;\n+\t}\n+\n+#ifdef SCENE_TREE_FTI_TAKE_TIMINGS\n+\tuint64_t after = OS::get_singleton()->get_ticks_usec();\n+\tif ((Engine::get_singleton()->get_frames_drawn() % 60) == 0) {\n+\t\tprint_line(\"Took \" + itos(after - before) + \" usec \" + (data.frame_start ? \"start\" : \"end\"));\n+\t}\n+#endif\n+}\n+\n+#endif // ndef _3D_DISABLED\ndiff --git a/scene/main/scene_tree_fti.h b/scene/main/scene_tree_fti.h\nnew file mode 100644\nindex 000000000000..5e76d30c7b10\n--- /dev/null\n+++ b/scene/main/scene_tree_fti.h\n@@ -0,0 +1,112 @@\n+/**************************************************************************/\n+/*  scene_tree_fti.h                                                      */\n+/**************************************************************************/\n+/*                         This file is part of:                          */\n+/*                             GODOT ENGINE                               */\n+/*                        https://godotengine.org                         */\n+/**************************************************************************/\n+/* Copyright (c) 2014-present Godot Engine contributors (see AUTHORS.md). */\n+/* Copyright (c) 2007-2014 Juan Linietsky, Ariel Manzur.                  */\n+/*                                                                        */\n+/* Permission is hereby granted, free of charge, to any person obtaining  */\n+/* a copy of this software and associated documentation files (the        */\n+/* \"Software\"), to deal in the Software without restriction, including    */\n+/* without limitation the rights to use, copy, modify, merge, publish,    */\n+/* distribute, sublicense, and/or sell copies of the Software, and to     */\n+/* permit persons to whom the Software is furnished to do so, subject to  */\n+/* the following conditions:                                              */\n+/*                                                                        */\n+/* The above copyright notice and this permission notice shall be         */\n+/* included in all copies or substantial portions of the Software.        */\n+/*                                                                        */\n+/* THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND,        */\n+/* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF     */\n+/* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. */\n+/* IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY   */\n+/* CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,   */\n+/* TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE      */\n+/* SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.                 */\n+/**************************************************************************/\n+\n+#ifndef SCENE_TREE_FTI_H\n+#define SCENE_TREE_FTI_H\n+\n+#include <core/local_vector.h>\n+#include <core/os/mutex.h>\n+\n+class Spatial;\n+class Node;\n+class Transform;\n+\n+#ifdef _3D_DISABLED\n+// Stubs\n+class SceneTreeFTI {\n+public:\n+\tvoid frame_update(Node *p_root, bool p_frame_start) {}\n+\tvoid tick_update() {}\n+\tvoid set_enabled(Node *p_root, bool p_enabled) {}\n+\tbool is_enabled() const { return false; }\n+\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {}\n+\tvoid spatial_notify_delete(Spatial *p_spatial) {}\n+};\n+#else\n+\n+// Important.\n+// This class uses raw pointers, so it is essential that on deletion, this class is notified\n+// so that any references can be cleared up to prevent dangling pointer access.\n+\n+// This class can be used from a custom SceneTree.\n+\n+// Note we could potentially make SceneTreeFTI static / global to avoid the lookup through scene tree,\n+// but this covers the custom case of multiple scene trees.\n+\n+// This class is not thread safe, but can be made thread safe easily with a mutex as in the 4.x version.\n+\n+class SceneTreeFTI {\n+\tstruct Data {\n+\t\t// Prev / Curr lists of spatials having local xforms pumped.\n+\t\tLocalVector<Spatial *> spatial_tick_list[2];\n+\t\tuint32_t mirror = 0;\n+\n+\t\tbool enabled = false;\n+\n+\t\t// Whether we are in physics ticks, or in a frame.\n+\t\tbool in_frame = false;\n+\n+\t\t// Updating at the start of the frame, or the end on second pass.\n+\t\tbool frame_start = true;\n+\n+\t\tbool debug = false;\n+\t} data;\n+\n+\tvoid _update_dirty_spatials(Node *p_node, uint32_t p_current_frame, float p_interpolation_fraction, bool p_active, const Transform *p_parent_global_xform = nullptr, int p_depth = 0);\n+\tvoid _reset_flags(Node *p_node);\n+\tvoid _spatial_notify_set_transform(Spatial &r_spatial);\n+\n+public:\n+\t// Hottest function, allow inlining the data.enabled check.\n+\tvoid spatial_notify_set_transform(Spatial &r_spatial) {\n+\t\tif (!data.enabled) {\n+\t\t\treturn;\n+\t\t}\n+\t\t_spatial_notify_set_transform(r_spatial);\n+\t}\n+\n+\tvoid spatial_notify_delete(Spatial *p_spatial);\n+\n+\t// Calculate interpolated xforms, send to visual server.\n+\tvoid frame_update(Node *p_root, bool p_frame_start);\n+\n+\t// Update local xform pumps.\n+\tvoid tick_update();\n+\n+\tvoid set_enabled(Node *p_root, bool p_enabled);\n+\tbool is_enabled() const { return data.enabled; }\n+\n+\tvoid set_debug_next_frame() { data.debug = true; }\n+};\n+\n+#endif // ndef _3D_DISABLED\n+\n+#endif // SCENE_TREE_FTI_H\ndiff --git a/servers/visual/rasterizer.h b/servers/visual/rasterizer.h\nindex 2b2259cc17f0..e99b16da6c4c 100644\n--- a/servers/visual/rasterizer.h\n+++ b/servers/visual/rasterizer.h\n@@ -92,16 +92,8 @@ class RasterizerScene {\n \t\tRID material_override;\n \t\tRID material_overlay;\n \n-\t\t// This is the main transform to be drawn with ..\n-\t\t// This will either be the interpolated transform (when using fixed timestep interpolation)\n-\t\t// or the ONLY transform (when not using FTI).\n \t\tTransform transform;\n \n-\t\t// for interpolation we store the current transform (this physics tick)\n-\t\t// and the transform in the previous tick\n-\t\tTransform transform_curr;\n-\t\tTransform transform_prev;\n-\n \t\tint depth_layer;\n \t\tuint32_t layer_mask;\n \n@@ -123,16 +115,6 @@ class RasterizerScene {\n \t\tbool baked_light : 1; //this flag is only to know if it actually did use baked light\n \t\tbool redraw_if_visible : 1;\n \n-\t\tbool on_interpolate_list : 1;\n-\t\tbool on_interpolate_transform_list : 1;\n-\t\tbool interpolated : 1;\n-\t\tTransformInterpolator::Method interpolation_method : 3;\n-\n-\t\t// For fixed timestep interpolation.\n-\t\t// Note 32 bits is plenty for checksum, no need for real_t\n-\t\tfloat transform_checksum_curr;\n-\t\tfloat transform_checksum_prev;\n-\n \t\tfloat depth; //used for sorting\n \n \t\tSelfList<InstanceBase> dependency_item;\n@@ -158,12 +140,6 @@ class RasterizerScene {\n \t\t\tlightmap_capture = nullptr;\n \t\t\tlightmap_slice = -1;\n \t\t\tlightmap_uv_rect = Rect2(0, 0, 1, 1);\n-\t\t\ton_interpolate_list = false;\n-\t\t\ton_interpolate_transform_list = false;\n-\t\t\tinterpolated = true;\n-\t\t\tinterpolation_method = TransformInterpolator::INTERP_LERP;\n-\t\t\ttransform_checksum_curr = 0.0;\n-\t\t\ttransform_checksum_prev = 0.0;\n \t\t}\n \t};\n \ndiff --git a/servers/visual/visual_server_raster.h b/servers/visual/visual_server_raster.h\nindex 6d088c09c3ec..297e3693096a 100644\n--- a/servers/visual/visual_server_raster.h\n+++ b/servers/visual/visual_server_raster.h\n@@ -573,8 +573,6 @@ class VisualServerRaster : public VisualServer {\n \tBIND2(instance_set_layer_mask, RID, uint32_t)\n \tBIND3(instance_set_pivot_data, RID, float, bool)\n \tBIND2(instance_set_transform, RID, const Transform &)\n-\tBIND2(instance_set_interpolated, RID, bool)\n-\tBIND1(instance_reset_physics_interpolation, RID)\n \tBIND2(instance_attach_object_instance_id, RID, ObjectID)\n \tBIND3(instance_set_blend_shape_weight, RID, int, float)\n \tBIND3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual/visual_server_scene.cpp b/servers/visual/visual_server_scene.cpp\nindex bdea223d5cee..1552469abb6a 100644\n--- a/servers/visual/visual_server_scene.cpp\n+++ b/servers/visual/visual_server_scene.cpp\n@@ -673,9 +673,6 @@ void VisualServerScene::instance_set_scenario(RID p_instance, RID p_scenario) {\n \t\t\t_instance_destroy_occlusion_rep(instance);\n \t\t}\n \n-\t\t// remove any interpolation data associated with the instance in this scenario\n-\t\t_interpolation_data.notify_free_instance(p_instance, *instance);\n-\n \t\tswitch (instance->base_type) {\n \t\t\tcase VS::INSTANCE_LIGHT: {\n \t\t\t\tInstanceLightData *light = static_cast<InstanceLightData *>(instance->base_data);\n@@ -765,27 +762,6 @@ void VisualServerScene::instance_set_pivot_data(RID p_instance, float p_sorting_\n \tinstance->use_aabb_center = p_use_aabb_center;\n }\n \n-void VisualServerScene::instance_reset_physics_interpolation(RID p_instance) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\n-\tif (_interpolation_data.interpolation_enabled && instance->interpolated) {\n-\t\tinstance->transform_prev = instance->transform_curr;\n-\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\tprint_line(\"instance_reset_physics_interpolation .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-\t\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\t}\n-}\n-\n-void VisualServerScene::instance_set_interpolated(RID p_instance, bool p_interpolated) {\n-\tInstance *instance = instance_owner.get(p_instance);\n-\tERR_FAIL_COND(!instance);\n-\tinstance->interpolated = p_interpolated;\n-}\n-\n void VisualServerScene::instance_set_transform(RID p_instance, const Transform &p_transform) {\n \tInstance *instance = instance_owner.get(p_instance);\n \tERR_FAIL_COND(!instance);\n@@ -794,47 +770,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \tprint_line(\"instance_set_transform \" + rtos(p_transform.origin.x) + \" .. tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n #endif\n \n-\tif (!(_interpolation_data.interpolation_enabled && instance->interpolated) || !instance->scenario) {\n-\t\tif (instance->transform == p_transform) {\n-\t\t\treturn; //must be checked to avoid worst evil\n-\t\t}\n-\n-#ifdef DEBUG_ENABLED\n-\n-\t\tfor (int i = 0; i < 4; i++) {\n-\t\t\tconst Vector3 &v = i < 3 ? p_transform.basis.elements[i] : p_transform.origin;\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.x));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.y));\n-\t\t\tERR_FAIL_COND(Math::is_inf(v.z));\n-\t\t\tERR_FAIL_COND(Math::is_nan(v.z));\n-\t\t}\n-\n-#endif\n-\t\tinstance->transform = p_transform;\n-\t\t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\t\tif ((_interpolation_data.interpolation_enabled && !instance->interpolated) && (Engine::get_singleton()->is_in_physics_frame())) {\n-\t\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Non-interpolated triggered from physics process\");\n-\t\t}\n-#endif\n-\n-\t\treturn;\n-\t}\n-\n-\tfloat new_checksum = TransformInterpolator::checksum_transform(p_transform);\n-\tbool checksums_match = (instance->transform_checksum_curr == new_checksum) && (instance->transform_checksum_prev == new_checksum);\n-\n-\t// we can't entirely reject no changes because we need the interpolation\n-\t// system to keep on stewing\n-\n-\t// Optimized check. First checks the checksums. If they pass it does the slow check at the end.\n-\t// Alternatively we can do this non-optimized and ignore the checksum...\n-\t// if no change\n-\tif (checksums_match && (instance->transform_curr == p_transform) && (instance->transform_prev == p_transform)) {\n-\t\treturn;\n+\tif (instance->transform == p_transform) {\n+\t\treturn; //must be checked to avoid worst evil\n \t}\n \n #ifdef DEBUG_ENABLED\n@@ -850,62 +787,8 @@ void VisualServerScene::instance_set_transform(RID p_instance, const Transform &\n \t}\n \n #endif\n-\n-\tinstance->transform_curr = p_transform;\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\tprint_line(\"\\tprev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x));\n-#endif\n-\n-\t// keep checksums up to date\n-\tinstance->transform_checksum_curr = new_checksum;\n-\n-\tif (!instance->on_interpolate_transform_list) {\n-\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\tinstance->on_interpolate_transform_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_transform_update_list_curr->size());\n-\t}\n-\n-\t// If the instance is invisible, then we are simply updating the data flow, there is no need to calculate the interpolated\n-\t// transform or anything else.\n-\t// Ideally we would not even call the VisualServer::set_transform() when invisible but that would entail having logic\n-\t// to keep track of the previous transform on the SceneTree side. The \"early out\" below is less efficient but a lot cleaner codewise.\n-\tif (!instance->visible) {\n-\t\treturn;\n-\t}\n-\n-\t// decide on the interpolation method .. slerp if possible\n-\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\n-\tif (!instance->on_interpolate_list) {\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t} else {\n-\t\tDEV_ASSERT(_interpolation_data.instance_interpolate_update_list.size());\n-\t}\n-\n+\tinstance->transform = p_transform;\n \t_instance_queue_update(instance, true);\n-\n-#if defined(DEBUG_ENABLED) && defined(TOOLS_ENABLED)\n-\tif (!Engine::get_singleton()->is_in_physics_frame()) {\n-\t\tPHYSICS_INTERPOLATION_NODE_WARNING(instance->object_id, \"Interpolated triggered from outside physics process\");\n-\t}\n-#endif\n-}\n-\n-void VisualServerScene::InterpolationData::notify_free_instance(RID p_rid, Instance &r_instance) {\n-\tr_instance.on_interpolate_list = false;\n-\tr_instance.on_interpolate_transform_list = false;\n-\n-\tif (!interpolation_enabled) {\n-\t\treturn;\n-\t}\n-\n-\t// if the instance was on any of the lists, remove\n-\tinstance_interpolate_update_list.erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_curr->erase_multiple_unordered(p_rid);\n-\tinstance_transform_update_list_prev->erase_multiple_unordered(p_rid);\n }\n \n void VisualServerScene::update_interpolation_tick(bool p_process) {\n@@ -915,84 +798,11 @@ void VisualServerScene::update_interpolation_tick(bool p_process) {\n \n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_tick(p_process);\n-\n-\t// detect any that were on the previous transform list that are no longer active,\n-\t// we should remove them from the interpolate list\n-\n-\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_prev->size(); n++) {\n-\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_prev)[n];\n-\t\tInstance *instance = instance_owner.getornull(rid);\n-\n-\t\tbool active = true;\n-\n-\t\t// no longer active? (either the instance deleted or no longer being transformed)\n-\t\tif (instance && !instance->on_interpolate_transform_list) {\n-\t\t\tactive = false;\n-\t\t\tinstance->on_interpolate_list = false;\n-\n-\t\t\t// make sure the most recent transform is set\n-\t\t\tinstance->transform = instance->transform_curr;\n-\n-\t\t\t// and that both prev and current are the same, just in case of any interpolations\n-\t\t\tinstance->transform_prev = instance->transform_curr;\n-\n-\t\t\t// make sure are updated one more time to ensure the AABBs are correct\n-\t\t\t_instance_queue_update(instance, true);\n-\t\t}\n-\n-\t\tif (!instance) {\n-\t\t\tactive = false;\n-\t\t}\n-\n-\t\tif (!active) {\n-\t\t\t_interpolation_data.instance_interpolate_update_list.erase(rid);\n-\t\t}\n-\t}\n-\n-\t// and now for any in the transform list (being actively interpolated), keep the previous transform\n-\t// value up to date ready for the next tick\n-\tif (p_process) {\n-\t\tfor (unsigned int n = 0; n < _interpolation_data.instance_transform_update_list_curr->size(); n++) {\n-\t\t\tconst RID &rid = (*_interpolation_data.instance_transform_update_list_curr)[n];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tinstance->transform_prev = instance->transform_curr;\n-\t\t\t\tinstance->transform_checksum_prev = instance->transform_checksum_curr;\n-\t\t\t\tinstance->on_interpolate_transform_list = false;\n-\t\t\t}\n-\t\t}\n-\t}\n-\n-\t// we maintain a mirror list for the transform updates, so we can detect when an instance\n-\t// is no longer being transformed, and remove it from the interpolate list\n-\tSWAP(_interpolation_data.instance_transform_update_list_curr, _interpolation_data.instance_transform_update_list_prev);\n-\n-\t// prepare for the next iteration\n-\t_interpolation_data.instance_transform_update_list_curr->clear();\n }\n \n void VisualServerScene::update_interpolation_frame(bool p_process) {\n \t// update interpolation in storage\n \tVSG::storage->update_interpolation_frame(p_process);\n-\n-\tif (p_process) {\n-\t\treal_t f = Engine::get_singleton()->get_physics_interpolation_fraction();\n-\n-\t\tfor (unsigned int i = 0; i < _interpolation_data.instance_interpolate_update_list.size(); i++) {\n-\t\t\tconst RID &rid = _interpolation_data.instance_interpolate_update_list[i];\n-\t\t\tInstance *instance = instance_owner.getornull(rid);\n-\t\t\tif (instance) {\n-\t\t\t\tTransformInterpolator::interpolate_transform_via_method(instance->transform_prev, instance->transform_curr, instance->transform, f, instance->interpolation_method);\n-\n-#ifdef VISUAL_SERVER_DEBUG_PHYSICS_INTERPOLATION\n-\t\t\t\tprint_line(\"\\t\\tinterpolated: \" + rtos(instance->transform.origin.x) + \"\\t( prev \" + rtos(instance->transform_prev.origin.x) + \", curr \" + rtos(instance->transform_curr.origin.x) + \" ) on tick \" + itos(Engine::get_singleton()->get_physics_frames()));\n-#endif\n-\n-\t\t\t\t// make sure AABBs are constantly up to date through the interpolation\n-\t\t\t\t_instance_queue_update(instance, true);\n-\t\t\t}\n-\t\t} // for n\n-\t}\n }\n \n void VisualServerScene::instance_attach_object_instance_id(RID p_instance, ObjectID p_id) {\n@@ -1046,25 +856,6 @@ void VisualServerScene::instance_set_visible(RID p_instance, bool p_visible) {\n \n \tinstance->visible = p_visible;\n \n-\t// Special case for physics interpolation, we want to ensure the interpolated data is up to date\n-\tif (_interpolation_data.interpolation_enabled && p_visible && instance->interpolated && instance->scenario && !instance->on_interpolate_list) {\n-\t\t// Do all the extra work we normally do on instance_set_transform(), because this is optimized out for hidden instances.\n-\t\t// This prevents a glitch of stale interpolation transform data when unhiding before the next physics tick.\n-\t\tinstance->interpolation_method = TransformInterpolator::find_method(instance->transform_prev.basis, instance->transform_curr.basis);\n-\t\t_interpolation_data.instance_interpolate_update_list.push_back(p_instance);\n-\t\tinstance->on_interpolate_list = true;\n-\t\t_instance_queue_update(instance, true);\n-\n-\t\t// We must also place on the transform update list for a tick, so the system\n-\t\t// can auto-detect if the instance is no longer moving, and remove from the interpolate lists again.\n-\t\t// If this step is ignored, an unmoving instance could remain on the interpolate lists indefinitely\n-\t\t// (or rather until the object is deleted) and cause unnecessary updates and drawcalls.\n-\t\tif (!instance->on_interpolate_transform_list) {\n-\t\t\t_interpolation_data.instance_transform_update_list_curr->push_back(p_instance);\n-\t\t\tinstance->on_interpolate_transform_list = true;\n-\t\t}\n-\t}\n-\n \t// give the opportunity for the spatial partitioning scene to use a special implementation of visibility\n \t// for efficiency (supported in BVH but not octree)\n \n@@ -4496,7 +4287,6 @@ bool VisualServerScene::free(RID p_rid) {\n \t\tupdate_dirty_instances();\n \n \t\tInstance *instance = instance_owner.get(p_rid);\n-\t\t_interpolation_data.notify_free_instance(p_rid, *instance);\n \n \t\tinstance_set_use_lightmap(p_rid, RID(), RID(), -1, Rect2(0, 0, 1, 1));\n \t\tinstance_set_scenario(p_rid, RID());\ndiff --git a/servers/visual/visual_server_scene.h b/servers/visual/visual_server_scene.h\nindex 56b6ceb5b60b..76b890765796 100644\n--- a/servers/visual/visual_server_scene.h\n+++ b/servers/visual/visual_server_scene.h\n@@ -397,12 +397,6 @@ class VisualServerScene {\n \tvirtual void set_physics_interpolation_enabled(bool p_enabled);\n \n \tstruct InterpolationData {\n-\t\tvoid notify_free_instance(RID p_rid, Instance &r_instance);\n-\t\tLocalVector<RID> instance_interpolate_update_list;\n-\t\tLocalVector<RID> instance_transform_update_lists[2];\n-\t\tLocalVector<RID> *instance_transform_update_list_curr = &instance_transform_update_lists[0];\n-\t\tLocalVector<RID> *instance_transform_update_list_prev = &instance_transform_update_lists[1];\n-\n \t\tbool interpolation_enabled = false;\n \t} _interpolation_data;\n \n@@ -662,8 +656,6 @@ class VisualServerScene {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask);\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center);\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform);\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated);\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance);\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id);\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight);\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material);\ndiff --git a/servers/visual/visual_server_wrap_mt.h b/servers/visual/visual_server_wrap_mt.h\nindex 6ba16fb7786f..a422de5f6401 100644\n--- a/servers/visual/visual_server_wrap_mt.h\n+++ b/servers/visual/visual_server_wrap_mt.h\n@@ -481,8 +481,6 @@ class VisualServerWrapMT : public VisualServer {\n \tFUNC2(instance_set_layer_mask, RID, uint32_t)\n \tFUNC3(instance_set_pivot_data, RID, float, bool)\n \tFUNC2(instance_set_transform, RID, const Transform &)\n-\tFUNC2(instance_set_interpolated, RID, bool)\n-\tFUNC1(instance_reset_physics_interpolation, RID)\n \tFUNC2(instance_attach_object_instance_id, RID, ObjectID)\n \tFUNC3(instance_set_blend_shape_weight, RID, int, float)\n \tFUNC3(instance_set_surface_material, RID, int, RID)\ndiff --git a/servers/visual_server.cpp b/servers/visual_server.cpp\nindex f13470cf11de..93ca55c52437 100644\n--- a/servers/visual_server.cpp\n+++ b/servers/visual_server.cpp\n@@ -2172,8 +2172,6 @@ void VisualServer::_bind_methods() {\n \tClassDB::bind_method(D_METHOD(\"instance_set_scenario\", \"instance\", \"scenario\"), &VisualServer::instance_set_scenario);\n \tClassDB::bind_method(D_METHOD(\"instance_set_layer_mask\", \"instance\", \"mask\"), &VisualServer::instance_set_layer_mask);\n \tClassDB::bind_method(D_METHOD(\"instance_set_transform\", \"instance\", \"transform\"), &VisualServer::instance_set_transform);\n-\tClassDB::bind_method(D_METHOD(\"instance_set_interpolated\", \"instance\", \"interpolated\"), &VisualServer::instance_set_interpolated);\n-\tClassDB::bind_method(D_METHOD(\"instance_reset_physics_interpolation\", \"instance\"), &VisualServer::instance_reset_physics_interpolation);\n \tClassDB::bind_method(D_METHOD(\"instance_attach_object_instance_id\", \"instance\", \"id\"), &VisualServer::instance_attach_object_instance_id);\n \tClassDB::bind_method(D_METHOD(\"instance_set_blend_shape_weight\", \"instance\", \"shape\", \"weight\"), &VisualServer::instance_set_blend_shape_weight);\n \tClassDB::bind_method(D_METHOD(\"instance_set_surface_material\", \"instance\", \"surface\", \"material\"), &VisualServer::instance_set_surface_material);\ndiff --git a/servers/visual_server.h b/servers/visual_server.h\nindex 9668be06c56f..7ea42a4ebf34 100644\n--- a/servers/visual_server.h\n+++ b/servers/visual_server.h\n@@ -878,8 +878,6 @@ class VisualServer : public Object {\n \tvirtual void instance_set_layer_mask(RID p_instance, uint32_t p_mask) = 0;\n \tvirtual void instance_set_pivot_data(RID p_instance, float p_sorting_offset, bool p_use_aabb_center) = 0;\n \tvirtual void instance_set_transform(RID p_instance, const Transform &p_transform) = 0;\n-\tvirtual void instance_set_interpolated(RID p_instance, bool p_interpolated) = 0;\n-\tvirtual void instance_reset_physics_interpolation(RID p_instance) = 0;\n \tvirtual void instance_attach_object_instance_id(RID p_instance, ObjectID p_id) = 0;\n \tvirtual void instance_set_blend_shape_weight(RID p_instance, int p_shape, float p_weight) = 0;\n \tvirtual void instance_set_surface_material(RID p_instance, int p_surface, RID p_material) = 0;\n", "instance_id": "godotengine__godot-103685", "clarity": 2, "difficulty": 0.85, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue with SkeletonIK3D failing to interpolate smoothly when physics interpolation is enabled in Godot v4.4.beta4, particularly in the context of camera movement and inverse kinematics in a first-person setup. It provides steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. Additionally, visual evidence (via GitHub asset links) is provided to demonstrate the problem. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement suggests uncertainty about whether the issue lies in the implementation or the engine itself (\"It's entirely possible I am implementing this incorrectly\"), and it lacks specific technical details about the expected behavior of SkeletonIK3D with physics interpolation. Furthermore, critical constraints or edge cases (e.g., specific refresh rates or hardware configurations beyond the provided system info) are not explicitly mentioned. While the intent and reproduction steps are clear, these minor gaps in specificity and clarity about the root cause or expected fix lower the score to \"Mostly Clear.\"\n", "difficulty_explanation": "\nI assign a difficulty score of 0.85, placing this problem in the \"Very Hard\" category due to several factors:\n\n1. **Scope and Depth of Code Changes**: The code changes provided are extensive, spanning multiple files and modules within the Godot engine, including core data structures (`LocalVector`), scene management (`SceneTree`, `Spatial`, `Camera`), visual rendering (`VisualServer`, `Rasterizer`), and specific 3D components (`BoneAttachment`, `VehicleWheel`, `SkeletonIK`). The changes involve a significant overhaul of the physics interpolation system, introducing a new `SceneTreeFTI` class for fixed timestep interpolation and removing or refactoring existing interpolation logic. This impacts the system's architecture fundamentally, as it redefines how transforms are managed and updated across frames and physics ticks, affecting a wide range of engine components. The sheer volume of code changes (hundreds of lines across critical files) and the need to understand interactions between rendering, physics, and scene tree systems elevate the complexity.\n\n2. **Number of Technical Concepts**: Solving this problem requires a deep understanding of several advanced concepts, including:\n   - Physics interpolation and fixed timestep rendering in game engines, which involves managing state between physics updates and rendering frames.\n   - Godot's internal architecture, particularly the `VisualServer`, `SceneTree`, and `Spatial` hierarchies, as well as how transforms are propagated and rendered.\n   - Transform interpolation algorithms (e.g., `TransformInterpolator`), requiring knowledge of linear algebra and 3D mathematics.\n   - Low-level engine optimizations, such as managing dirty flags (`DIRTY_GLOBAL_INTERPOLATED`) and efficient list operations (`LocalVector` modifications).\n   - Domain-specific knowledge of inverse kinematics (`SkeletonIK3D`) and camera systems in 3D game engines.\n   These concepts are complex and require significant experience with game engine internals, making this a highly technical challenge.\n\n3. **Potential Edge Cases and Error Handling**: The problem and code changes implicitly address several edge cases, such as handling visibility states, inactive nodes, and transform updates outside physics frames. The code introduces mechanisms to prevent jittering (e.g., resetting interpolation data when nodes are no longer active) and ensures smooth transitions during scene tree changes (e.g., entering/exiting tree). However, the complexity of these edge cases is high, as they involve subtle interactions between visibility, physics ticks, and rendering updates. Error handling logic, such as ensuring transforms are not corrupted during interpolation, is also critical and non-trivial to implement correctly across all scenarios (e.g., high refresh rates, paused states, or sudden transform changes).\n\n4. **Overall Complexity and Impact**: The task requires not just fixing a bug but rearchitecting a core part of the engine's interpolation system to address the issue with `SkeletonIK3D`. This involves balancing performance (e.g., minimizing unnecessary updates in `SceneTreeFTI`) with correctness (e.g., ensuring interpolated transforms are accurate). The risk of introducing new bugs or performance regressions is significant, given the broad impact on the engine's rendering and physics systems. This level of challenge demands advanced expertise in Rust/C++ (as Godot is primarily C++), deep familiarity with game engine design, and careful consideration of system-level implications.\n\nGiven these factors, a score of 0.85 reflects the very high difficulty of this task, requiring extensive experience, intricate logic, and a comprehensive understanding of Godot's internals. It falls short of the absolute maximum (1.0) as it does not involve entirely novel system-level innovations (e.g., a new distributed system protocol) but rather a complex refactoring of existing systems.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Android rotating screen more than once causes a crash\n### Tested versions\n\nReproducible in:  4.4.dev4, 4.4.dev5, 4.4.beta, 4.4.rc1\nNot reproducible in: 4.4.dev3, 4.4.dev1, 4.3.stable\nRegression starting in 4.4.dev4 and still present in current 4.4.rc1\n\n### System information\n\nAndroid 14, Rendering: Forward Mobile Vulkan 1.1.128, GPU:Qualcomm Adreno 619, Hardware: Motorola One 5G Ace\n\n### Issue description\n\nRotating the phone screen more than once causes the exported game/app to crash on Android. Expected to be able to rotate the screen more than once in any direction without crashing.\n\n\n### Steps to reproduce\n\nCreate a new empty project, Set Project>Project Settings>Display>Window>Handheld>Orientation>Sensor.\nExport the project to Android and run.\nRotate the screen once than rotate it again (crash).\n\n### Minimal reproduction project (MRP)\n\nN/A. Reproducible in a new project with Display Orientation set to Sensor on Android.\n", "patch": "diff --git a/.github/workflows/android_builds.yml b/.github/workflows/android_builds.yml\nindex 443b0be0f388..426efac6ece3 100644\n--- a/.github/workflows/android_builds.yml\n+++ b/.github/workflows/android_builds.yml\n@@ -62,8 +62,8 @@ jobs:\n       - name: Download pre-built Android Swappy Frame Pacing Library\n         uses: dsaltares/fetch-gh-release-asset@1.1.2\n         with:\n-          repo: darksylinc/godot-swappy\n-          version: tags/v2023.3.0.0\n+          repo: godotengine/godot-swappy\n+          version: tags/from-source-2025-01-31\n           file: godot-swappy.7z\n           target: swappy/godot-swappy.7z\n \ndiff --git a/.gitignore b/.gitignore\nindex 2c3bf742ba2e..8adc7b786c63 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -263,6 +263,11 @@ bld/\n !thirdparty/**/arm/\n !thirdparty/**/arm64/\n \n+thirdparty/swappy-frame-pacing/arm64-v8a/abi.json\n+thirdparty/swappy-frame-pacing/armeabi-v7a/abi.json\n+thirdparty/swappy-frame-pacing/x86/abi.json\n+thirdparty/swappy-frame-pacing/x86_64/abi.json\n+\n # Visual Studio 2015/2017 cache/options directory\n .vs/\n \ndiff --git a/platform/android/detect.py b/platform/android/detect.py\nindex 571cfd9819c0..cac7c3f48d4e 100644\n--- a/platform/android/detect.py\n+++ b/platform/android/detect.py\n@@ -187,7 +187,7 @@ def configure(env: \"SConsEnvironment\"):\n     has_swappy = detect_swappy()\n     if not has_swappy:\n         print_warning(\n-            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/darksylinc/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n+            \"Swappy Frame Pacing not detected! It is strongly recommended you download it from https://github.com/godotengine/godot-swappy/releases and extract it so that the following files can be found:\\n\"\n             + \" thirdparty/swappy-frame-pacing/arm64-v8a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/armeabi-v7a/libswappy_static.a\\n\"\n             + \" thirdparty/swappy-frame-pacing/x86/libswappy_static.a\\n\"\ndiff --git a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\nindex d29ac01af384..25ce813968f7 100644\n--- a/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n+++ b/thirdparty/swappy-frame-pacing/common/gamesdk_common.h\n@@ -31,11 +31,12 @@\n \n // There are separate versions for each GameSDK component that use this format:\n #define ANDROID_GAMESDK_PACKED_VERSION(MAJOR, MINOR, BUGFIX) \\\n-    ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n+  ((MAJOR << 16) | (MINOR << 8) | (BUGFIX))\n // Accessors\n #define ANDROID_GAMESDK_MAJOR_VERSION(PACKED) ((PACKED) >> 16)\n #define ANDROID_GAMESDK_MINOR_VERSION(PACKED) (((PACKED) >> 8) & 0xff)\n #define ANDROID_GAMESDK_BUGFIX_VERSION(PACKED) ((PACKED) & 0xff)\n \n-#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX, GIT) \\\n-#MAJOR \".\" #MINOR \".\" #BUGFIX \".\" #GIT\n+#define AGDK_STRINGIFY(NUMBER) #NUMBER\n+#define AGDK_STRING_VERSION(MAJOR, MINOR, BUGFIX) \\\n+  AGDK_STRINGIFY(MAJOR) \".\" AGDK_STRINGIFY(MINOR) \".\" AGDK_STRINGIFY(BUGFIX)\ndiff --git a/thirdparty/swappy-frame-pacing/swappyVk.h b/thirdparty/swappy-frame-pacing/swappyVk.h\nindex 020683cbc43c..654fcbf4a4a7 100644\n--- a/thirdparty/swappy-frame-pacing/swappyVk.h\n+++ b/thirdparty/swappy-frame-pacing/swappyVk.h\n@@ -281,30 +281,30 @@ void SwappyVk_uninjectTracer(const SwappyTracer* tracer);\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyVkFunctionProvider {\n-    /**\n-     * @brief Callback to initialize the function provider.\n-     *\n-     * This function is called by Swappy before any functions are requested.\n-     * E.g. so you can call dlopen on the Vulkan library.\n-     */\n-    bool (*init)();\n-\n-    /**\n-     * @brief Callback to get the address of a function.\n-     *\n-     * This function is called by Swappy to get the address of a Vulkan\n-     * function.\n-     * @param name The null-terminated name of the function.\n-     */\n-    void* (*getProcAddr)(const char* name);\n-\n-    /**\n-     * @brief Callback to close any resources owned by the function provider.\n-     *\n-     * This function is called by Swappy when no more functions will be\n-     * requested, e.g. so you can call dlclose on the Vulkan library.\n-     */\n-    void (*close)();\n+  /**\n+   * @brief Callback to initialize the function provider.\n+   *\n+   * This function is called by Swappy before any functions are requested.\n+   * E.g. so you can call dlopen on the Vulkan library.\n+   */\n+  bool (*init)();\n+\n+  /**\n+   * @brief Callback to get the address of a function.\n+   *\n+   * This function is called by Swappy to get the address of a Vulkan\n+   * function.\n+   * @param name The null-terminated name of the function.\n+   */\n+  void* (*getProcAddr)(const char* name);\n+\n+  /**\n+   * @brief Callback to close any resources owned by the function provider.\n+   *\n+   * This function is called by Swappy when no more functions will be\n+   * requested, e.g. so you can call dlclose on the Vulkan library.\n+   */\n+  void (*close)();\n } SwappyVkFunctionProvider;\n \n /**\n@@ -384,7 +384,8 @@ void SwappyVk_enableStats(VkSwapchainKHR swapchain, bool enabled);\n \n  * @see SwappyVk_enableStats.\n  */\n-void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t image);\n+void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain,\n+                               uint32_t image);\n \n /**\n  * @brief Returns the stats collected, if statistics collection was toggled on.\n@@ -396,11 +397,11 @@ void SwappyVk_recordFrameStart(VkQueue queue, VkSwapchainKHR swapchain, uint32_t\n  * conditions.\n  *\n  * @param[in]  swapchain   - The swapchain for which stats are being queried.\n- * @param      swappyStats - Pointer to a SwappyStats that will be populated with\n- *                             the collected stats. Cannot be NULL.\n+ * @param      swappyStats - Pointer to a SwappyStats that will be populated\n+ * with the collected stats. Cannot be NULL.\n  * @see SwappyStats\n  */\n-void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n+void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats* swappyStats);\n \n /**\n  * @brief Clears the frame statistics collected so far.\n@@ -413,6 +414,58 @@ void SwappyVk_getStats(VkSwapchainKHR swapchain, SwappyStats *swappyStats);\n  */\n void SwappyVk_clearStats(VkSwapchainKHR swapchain);\n \n+/**\n+ * @brief Reset the swappy pacing mechanism\n+ *\n+ * In cases where the frame timing history is irrelevant (for example during\n+ * scene/level transitions or after loading screens), calling this would\n+ * remove all the history for frame pacing. Calling this entry point\n+ * would reset the frame rate to the initial state at the end of the current\n+ * frame. Then swappy would just pace as normal with fresh state from next\n+ * frame. There are no error conditions associated with this call.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which frame pacing is reset.\n+ */\n+void SwappyVk_resetFramePacing(VkSwapchainKHR swapchain);\n+\n+/**\n+ * @brief Enable/Disable the swappy pacing mechanism\n+ *\n+ * By default frame pacing is enabled when swappy is used, however it can be\n+ * disabled at runtime by calling `SwappyVk_enableFramePacing(swapchain,\n+ * false)`. When the frame pacing is disabled, ::SwappyVk_enableBlockingWait\n+ * will control whether\n+ * ::SwappyVk_queuePresent will return immediately, or will block until the\n+ * previous frame's GPU work is completed. All enabling/disabling effects take\n+ * place from next frame. Once disabled, `SwappyVk_enableFramePacing(swapchain,\n+ * true)` will enable frame pacing again with a fresh frame time state -\n+ * equivalent of calling ::SwappyVk_resetFramePacing().\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, enables frame pacing otherwise disables it\n+ */\n+void SwappyVk_enableFramePacing(VkSwapchainKHR swapchain, bool enable);\n+\n+/**\n+ * @brief Enable/Disable blocking wait when frame-pacing is disabled\n+ *\n+ * By default ::SwappyVk_queuePresent will do a blocking wait until previous\n+ * frame's GPU work is completed. However when frame pacing is disabled, calling\n+ * `SwappyVk_enableBlockingWait(swapchain, false)` will ensure that\n+ * ::SwappyVk_queuePresent returns without waiting for previous frame's GPU\n+ * work. This behaviour impacts the GPU time returned in the\n+ * ::SwappyPostWaitCallback callback. If the last frame's GPU work is done by\n+ * the time ::SwappyVk_queuePresent for this frame is called, then the previous\n+ * frame's GPU time will be returned otherwise `-1` will be delivered in the\n+ * callback for the frame. This setting has no impact when frame pacing is\n+ * enabled.\n+ *\n+ * @param[in]  swapchain   - The swapchain for which stats are being queried.\n+ * @param      enable      - If true, ::SwappyVk_queuePresent will block until\n+ * the previous frame's GPU work is complete.\n+ */\n+void SwappyVk_enableBlockingWait(VkSwapchainKHR swapchain, bool enable);\n+\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\ndiff --git a/thirdparty/swappy-frame-pacing/swappy_common.h b/thirdparty/swappy-frame-pacing/swappy_common.h\nindex b711ca910fb3..acceb4243df6 100644\n--- a/thirdparty/swappy-frame-pacing/swappy_common.h\n+++ b/thirdparty/swappy-frame-pacing/swappy_common.h\n@@ -48,22 +48,22 @@\n \n // Internal macros to track Swappy version, do not use directly.\n #define SWAPPY_MAJOR_VERSION 2\n-#define SWAPPY_MINOR_VERSION 0\n+#define SWAPPY_MINOR_VERSION 2\n #define SWAPPY_BUGFIX_VERSION 0\n-#define SWAPPY_PACKED_VERSION                                                  \\\n-    ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n-                                   SWAPPY_BUGFIX_VERSION)\n+#define SWAPPY_PACKED_VERSION                                                \\\n+  ANDROID_GAMESDK_PACKED_VERSION(SWAPPY_MAJOR_VERSION, SWAPPY_MINOR_VERSION, \\\n+                                 SWAPPY_BUGFIX_VERSION)\n \n // Internal macros to generate a symbol to track Swappy version, do not use\n // directly.\n #define SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n+  PREFIX##_##MAJOR##_##MINOR##_##BUGFIX##_##GITCOMMIT\n #define SWAPPY_VERSION_CONCAT(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT) \\\n-    SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n-#define SWAPPY_VERSION_SYMBOL                                          \\\n-    SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n-                          SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n-                          AGDK_GIT_COMMIT)\n+  SWAPPY_VERSION_CONCAT_NX(PREFIX, MAJOR, MINOR, BUGFIX, GITCOMMIT)\n+#define SWAPPY_VERSION_SYMBOL                                        \\\n+  SWAPPY_VERSION_CONCAT(Swappy_version, SWAPPY_MAJOR_VERSION,        \\\n+                        SWAPPY_MINOR_VERSION, SWAPPY_BUGFIX_VERSION, \\\n+                        AGDK_GIT_COMMIT)\n \n // Define this to 1 to enable all logging from Swappy, by default it is\n // disabled in a release build and enabled in a debug build.\n@@ -83,29 +83,29 @@ typedef uint64_t SwappyThreadId;\n  * Usage of this functionality is optional.\n  */\n typedef struct SwappyThreadFunctions {\n-    /** @brief Thread start callback.\n-     *\n-     * This function is called by Swappy to start thread_func on a new thread.\n-     * @param user_data A value to be passed the thread function.\n-     * If the thread was started, this function should set the thread_id and\n-     * return 0. If the thread was not started, this function should return a\n-     * non-zero value.\n-     */\n-    int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n-                 void* user_data);\n-\n-    /** @brief Thread join callback.\n-     *\n-     * This function is called by Swappy to join the thread with given id.\n-     */\n-    void (*join)(SwappyThreadId thread_id);\n-\n-    /** @brief Thread joinable callback.\n-     *\n-     * This function is called by Swappy to discover whether the thread with the\n-     * given id is joinable.\n-     */\n-    bool (*joinable)(SwappyThreadId thread_id);\n+  /** @brief Thread start callback.\n+   *\n+   * This function is called by Swappy to start thread_func on a new thread.\n+   * @param user_data A value to be passed the thread function.\n+   * If the thread was started, this function should set the thread_id and\n+   * return 0. If the thread was not started, this function should return a\n+   * non-zero value.\n+   */\n+  int (*start)(SwappyThreadId* thread_id, void* (*thread_func)(void*),\n+               void* user_data);\n+\n+  /** @brief Thread join callback.\n+   *\n+   * This function is called by Swappy to join the thread with given id.\n+   */\n+  void (*join)(SwappyThreadId thread_id);\n+\n+  /** @brief Thread joinable callback.\n+   *\n+   * This function is called by Swappy to discover whether the thread with the\n+   * given id is joinable.\n+   */\n+  bool (*joinable)(SwappyThreadId thread_id);\n } SwappyThreadFunctions;\n \n #ifdef __cplusplus\n@@ -138,47 +138,46 @@ const char* Swappy_versionString();\n  * ::SwappyGL_enableStats or ::SwappyVk_enableStats.\n  */\n typedef struct SwappyStats {\n-    /** @brief Total frames swapped by swappy */\n-    uint64_t totalFrames;\n-\n-    /** @brief Histogram of the number of screen refreshes a frame waited in the\n-     * compositor queue after rendering was completed.\n-     *\n-     * For example:\n-     *     if a frame waited 2 refresh periods in the compositor queue after\n-     * rendering was done, the frame will be counted in idleFrames[2]\n-     */\n-    uint64_t idleFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * requested presentation time and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the requested\n-     * timestamp swappy set, the frame will be counted in lateFrames[2]\n-     */\n-    uint64_t lateFrames[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between two\n-     * consecutive frames\n-     *\n-     * For example:\n-     *     if frame N was presented 2 refresh periods after frame N-1\n-     *     frame N will be counted in offsetFromPreviousFrame[2]\n-     */\n-    uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n-\n-    /** @brief Histogram of the number of screen refreshes passed between the\n-     * call to Swappy_recordFrameStart and the actual present time.\n-     *\n-     * For example:\n-     *     if a frame was presented 2 refresh periods after the call to\n-     * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n-     */\n-    uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n+  /** @brief Total frames swapped by swappy */\n+  uint64_t totalFrames;\n+\n+  /** @brief Histogram of the number of screen refreshes a frame waited in the\n+   * compositor queue after rendering was completed.\n+   *\n+   * For example:\n+   *     if a frame waited 2 refresh periods in the compositor queue after\n+   * rendering was done, the frame will be counted in idleFrames[2]\n+   */\n+  uint64_t idleFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * requested presentation time and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the requested\n+   * timestamp swappy set, the frame will be counted in lateFrames[2]\n+   */\n+  uint64_t lateFrames[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between two\n+   * consecutive frames\n+   *\n+   * For example:\n+   *     if frame N was presented 2 refresh periods after frame N-1\n+   *     frame N will be counted in offsetFromPreviousFrame[2]\n+   */\n+  uint64_t offsetFromPreviousFrame[MAX_FRAME_BUCKETS];\n+\n+  /** @brief Histogram of the number of screen refreshes passed between the\n+   * call to Swappy_recordFrameStart and the actual present time.\n+   *\n+   * For example:\n+   *     if a frame was presented 2 refresh periods after the call to\n+   * `Swappy_recordFrameStart` the frame will be counted in latencyFrames[2]\n+   */\n+  uint64_t latencyFrames[MAX_FRAME_BUCKETS];\n } SwappyStats;\n \n-\n #ifdef __cplusplus\n }  // extern \"C\"\n #endif\n@@ -236,43 +235,43 @@ typedef void (*SwappySwapIntervalChangedCallback)(void*);\n  * Injection of these is optional.\n  */\n typedef struct SwappyTracer {\n-    /**\n-     * Callback called before waiting to queue the frame to the composer.\n-     */\n-    SwappyPreWaitCallback preWait;\n-\n-    /**\n-     * Callback called after wait to queue the frame to the composer is done.\n-     */\n-    SwappyPostWaitCallback postWait;\n-\n-    /**\n-     * Callback called before calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPreSwapBuffersCallback preSwapBuffers;\n-\n-    /**\n-     * Callback called after calling the function to queue the frame to the\n-     * composer.\n-     */\n-    SwappyPostSwapBuffersCallback postSwapBuffers;\n-\n-    /**\n-     * Callback called at the start of a frame.\n-     */\n-    SwappyStartFrameCallback startFrame;\n-\n-    /**\n-     * Pointer to some arbitrary data that will be passed as the first argument\n-     * of callbacks.\n-     */\n-    void* userData;\n-\n-    /**\n-     * Callback called when the swap interval was changed.\n-     */\n-    SwappySwapIntervalChangedCallback swapIntervalChanged;\n+  /**\n+   * Callback called before waiting to queue the frame to the composer.\n+   */\n+  SwappyPreWaitCallback preWait;\n+\n+  /**\n+   * Callback called after wait to queue the frame to the composer is done.\n+   */\n+  SwappyPostWaitCallback postWait;\n+\n+  /**\n+   * Callback called before calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPreSwapBuffersCallback preSwapBuffers;\n+\n+  /**\n+   * Callback called after calling the function to queue the frame to the\n+   * composer.\n+   */\n+  SwappyPostSwapBuffersCallback postSwapBuffers;\n+\n+  /**\n+   * Callback called at the start of a frame.\n+   */\n+  SwappyStartFrameCallback startFrame;\n+\n+  /**\n+   * Pointer to some arbitrary data that will be passed as the first argument\n+   * of callbacks.\n+   */\n+  void* userData;\n+\n+  /**\n+   * Callback called when the swap interval was changed.\n+   */\n+  SwappySwapIntervalChangedCallback swapIntervalChanged;\n } SwappyTracer;\n \n /** @} */\n", "instance_id": "godotengine__godot-103409", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: rotating the screen more than once on Android causes a crash in specific versions of the software (4.4.dev4 to 4.4.rc1). It provides detailed system information, steps to reproduce, and specifies the affected versions, which helps in understanding the scope of the regression. However, there are minor ambiguities and missing details. For instance, the exact cause of the crash (e.g., stack trace, error logs, or specific component failure) is not mentioned, which would be critical for debugging. Additionally, while the steps to reproduce are provided, there are no specifics on the expected behavior beyond \"not crashing,\" nor are there mentions of specific edge cases or conditions under which the crash might vary (e.g., specific Android API levels or device configurations beyond the one tested). Thus, while the problem is valid and mostly clear, it lacks some critical debugging details and edge case specifications, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty score of 0.75 reflects a hard problem due to several factors. First, the scope of code changes involves multiple files and components, including updates to the Swappy Frame Pacing library (a third-party dependency for Android rendering), modifications to build configurations (e.g., GitHub workflows), and updates to header files with significant changes in functionality (e.g., adding frame pacing controls and stats handling in Vulkan rendering). This indicates a need to understand interactions between the rendering pipeline, Android-specific behaviors, and external libraries, which increases complexity. Second, the technical concepts involved are moderately advanced, including Vulkan rendering, frame pacing mechanisms, Android-specific screen rotation handling, and version-specific regressions, requiring familiarity with low-level graphics programming and Android's native development environment. Third, while the problem statement does not explicitly mention edge cases, the nature of screen rotation and rendering suggests potential complexities in handling various device orientations, refresh rates, and Android versions, as well as ensuring thread safety and performance in the rendering pipeline. Finally, the changes impact a critical part of the system (rendering on Android), which could have broader architectural implications if not handled carefully. Although the provided code changes seem to address the issue by updating the Swappy library and related configurations, implementing and verifying the fix requires deep understanding and careful testing across multiple scenarios, justifying a score in the hard range (0.6-0.8), specifically 0.75 due to the specialized knowledge of Android rendering and Vulkan required.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_modify_explanation": "The workload involved in low-level graphics programming is substantial, and given the unknown impact on the safety of other system functionalities, it is therefore rated as high difficulty."}
{"problem_statement": "\"Game Embedding not available on your OS\" EndeavorOS Hyprland\n### Tested versions\n\nReproducible in: 4.4.beta3\n\n### System information\n\nGodot v4.4.beta3 - EndeavourOS #1 SMP PREEMPT_DYNAMIC Sun, 02 Feb 2025 01:02:29 +0000 on Wayland - Wayland display driver, Single-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 500 (APL 2) - Intel(R) Celeron(R) CPU N3350 @ 1.10GHz (2 threads)\n\n### Issue description\n\nWas going to test for the first time the game embedding from 4.4 and was surprised to seed it did not work, the devlogs said it was available for linux so that got me wondering if it was a Hyprland issue, but I could not find anything online, or on the issues, easily available.\n\n### Steps to reproduce\n\n- Create any new project\n- Run any scene\n- Open game tab\n\n### Minimal reproduction project (MRP)\n\nAny godot project\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex 638262fb8bec..efc5719d2def 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -446,6 +446,10 @@ GameView::EmbedAvailability GameView::_get_embed_available() {\n \tif (get_tree()->get_root()->is_embedding_subwindows()) {\n \t\treturn EMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE;\n \t}\n+\tString display_driver = GLOBAL_GET(\"display/display_server/driver\");\n+\tif (display_driver == \"headless\" || display_driver == \"wayland\") {\n+\t\treturn EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER;\n+\t}\n \n \tEditorRun::WindowPlacement placement = EditorRun::get_window_placement();\n \tif (placement.force_fullscreen) {\n@@ -489,7 +493,14 @@ void GameView::_update_ui() {\n \t\t\t}\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_FEATURE_NOT_SUPPORTED:\n-\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\tif (DisplayServer::get_singleton()->get_name() == \"Wayland\") {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on Wayland.\\nWayland can be disabled in the Editor Settings (Run > Platforms > Linux/*BSD > Prefer Wayland).\"));\n+\t\t\t} else {\n+\t\t\t\tstate_label->set_text(TTR(\"Game embedding not available on your OS.\"));\n+\t\t\t}\n+\t\t\tbreak;\n+\t\tcase EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER:\n+\t\t\tstate_label->set_text(vformat(TTR(\"Game embedding not available for the Display Server: '%s'.\\nDisplay Server can be modified in the Project Settings (Display > Display Server > Driver).\"), GLOBAL_GET(\"display/display_server/driver\")));\n \t\t\tbreak;\n \t\tcase EMBED_NOT_AVAILABLE_MINIMIZED:\n \t\t\tstate_label->set_text(TTR(\"Game embedding not available when the game starts minimized.\\nConsider overriding the window mode project setting with the editor feature tag to Windowed to use game embedding while leaving the exported project intact.\"));\ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 6be2d961ba08..6e08c269b063 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -108,6 +108,7 @@ class GameView : public VBoxContainer {\n \t\tEMBED_NOT_AVAILABLE_MAXIMIZED,\n \t\tEMBED_NOT_AVAILABLE_FULLSCREEN,\n \t\tEMBED_NOT_AVAILABLE_SINGLE_WINDOW_MODE,\n+\t\tEMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER,\n \t};\n \n \tinline static GameView *singleton = nullptr;\n", "instance_id": "godotengine__godot-102833", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: game embedding does not work on EndeavourOS with Hyprland using the Wayland display driver in Godot v4.4.beta3. It provides system information, steps to reproduce, and mentions that the feature was expected to work on Linux based on devlogs. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"game embedding\" entails or what the expected behavior should be when it works. Additionally, there are no specific error messages or logs provided to pinpoint the root cause, and edge cases or constraints (e.g., specific Wayland compositors or hardware limitations) are not mentioned. While the issue is reproducible with any Godot project, the lack of deeper context or detailed expectations slightly reduces the clarity.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.35, placing it in the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively small and localized to two files (`game_view_plugin.cpp` and `game_view_plugin.h`) within the Godot editor plugin. The modifications involve adding a new enum value for a specific error condition (`EMBED_NOT_AVAILABLE_PROJECT_DISPLAY_DRIVER`) and updating the UI feedback to inform users about unsupported display drivers like Wayland. The changes do not impact the broader system architecture or require extensive refactoring, as they are confined to a specific feature (game embedding) and its error reporting logic. The amount of code changed is minimal, with only a few lines added or modified.\n\n2. **Number of Technical Concepts**: Solving this issue requires a basic understanding of Godot's editor plugin system, specifically how display drivers are queried and how UI elements are updated based on runtime conditions. Familiarity with C++ (used in Godot's core) is necessary, but the concepts involved—string comparison, enum usage, and UI text updates—are straightforward. No advanced algorithms, design patterns, or domain-specific knowledge (beyond basic graphics display drivers like Wayland) are required.\n\n3. **Potential Edge Cases and Error Handling**: The problem and code changes address a specific edge case: game embedding not working on Wayland or headless display drivers. The solution adds explicit error messaging to guide users on how to potentially resolve the issue (e.g., by changing settings). However, the complexity of handling these edge cases is low, as it only involves detecting the display driver and updating a UI label. No intricate error recovery or fallback mechanisms are implemented in the provided diff.\n\n4. **Overall Assessment**: This task falls into the \"Easy\" category because it involves simple modifications to existing logic, with a clear goal of improving user feedback for an unsupported feature. It requires understanding a small part of the codebase and making targeted changes without significant risk of introducing bugs or affecting other systems. The difficulty is slightly above the \"Very Easy\" range (0.0-0.2) due to the need to understand Godot's display driver system and editor settings, but it does not reach \"Medium\" difficulty (0.4-0.6) as it lacks complexity in terms of cross-module interactions or advanced technical challenges.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Jolt Physics warnings for PhysicalBone3D fail to report bone names when running physics on separate thread\n### Tested versions\n\n- Reproducible in 4.4-beta2, 4.4-beta3\n- Not reproducible in 4.3 (no Jolt implementation)\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4080 SUPER (nvidia; 565.77) - AMD Ryzen 7 8700F 8-Core Processor (16 threads)\n\n### Issue description\n\nI am using the native Jolt Physics engine on a separate thread via project settings (`physics/3d/run_on_separate_thread`). I have an armature that needs updating, so Jolt is emitting warnings. However, the warning is attempting to fetch the names of the problem bones, which is not thread-safe, so the warning text is malformed and is passed with multiple errors (as seen below).\n\n```\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine_001). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nERROR: Caller thread can't call this function in this node (/root/@EditorNode@21257/@Panel@14/@VBoxContainer@15/DockHSplitLeftL/DockHSplitLeftR/DockHSplitMain/@VBoxContainer@26/DockVSplitCenter/@VSplitContainer@54/@VBoxContainer@55/@EditorMainScreen@102/MainScreen/@CanvasItemEditor@11479/@VSplitContainer@11131/@HSplitContainer@11133/@HSplitContainer@11135/@Control@11136/@SubViewportContainer@11137/@SubViewport@11138/RDMOutpost/world/renegade/visual/renegade/Skeleton3D/Physical Bone DEF-spine). Use call_deferred() or call_thread_group() instead.\n   at: to_string (scene/main/node.cpp:2697)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects '' and ''.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\n\nWhen physics is set to run on the main thread, the problem resolves, showing the warnings as normal, including the bone names (expected behavior).\n```\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3027113173784>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3027146728218>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\nWARNING: Hinge joint bias limit is not supported when using Jolt Physics. Any such value will be ignored. This joint connects 'Physical Bone DEF-spine:<PhysicalBone3D#3102627426828>' and 'Physical Bone DEF-spine_001:<PhysicalBone3D#3102660981262>'.\n     at: set_param (modules/jolt_physics/joints/jolt_hinge_joint_3d.cpp:221)\n```\n\nShould the warning itself be deferred to the main thread?\n\n### Steps to reproduce\n\n1. Set physics to run on a separate thread `physics/3d/run_on_separate_thread`\n2. Switch Physics Engine to Jolt Physics\n3. Set up a Skeleton3D with PhysicalBone3D bones that have joint properties unsupported in Jolt (i.e. a Pinjoint configured with impulse clamping)\n4. Restart editor to see errors in console, or launch game to see them in debugger\n\n### Minimal reproduction project (MRP)\n\nWarnings should appear as soon as this project is opened and imported.\n\n[physicalbone3d_report_2025-02-09_17-35-51.zip](https://github.com/user-attachments/files/18726415/physicalbone3d_report_2025-02-09_17-35-51.zip)\n", "patch": "diff --git a/doc/classes/ProjectSettings.xml b/doc/classes/ProjectSettings.xml\nindex c48b05002c82..7d41d2faa601 100644\n--- a/doc/classes/ProjectSettings.xml\n+++ b/doc/classes/ProjectSettings.xml\n@@ -2330,6 +2330,7 @@\n \t\t</member>\n \t\t<member name=\"physics/3d/run_on_separate_thread\" type=\"bool\" setter=\"\" getter=\"\" default=\"false\">\n \t\t\tIf [code]true[/code], the 3D physics server runs on a separate thread, making better use of multi-core CPUs. If [code]false[/code], the 3D physics server runs on the main thread. Running the physics server on a separate thread can increase performance, but restricts API access to only physics process.\n+\t\t\t[b]Note:[/b] When [member physics/3d/physics_engine] is set to [code]Jolt Physics[/code], enabling this setting will prevent the 3D physics server from being able to provide any context when reporting errors and warnings, and will instead always refer to nodes as [code]&lt;unknown&gt;[/code].\n \t\t</member>\n \t\t<member name=\"physics/3d/sleep_threshold_angular\" type=\"float\" setter=\"\" getter=\"\" default=\"0.139626\">\n \t\t\tThreshold angular velocity under which a 3D physics body will be considered inactive. See [constant PhysicsServer3D.SPACE_PARAM_BODY_ANGULAR_VELOCITY_SLEEP_THRESHOLD].\ndiff --git a/modules/jolt_physics/jolt_physics_server_3d.h b/modules/jolt_physics/jolt_physics_server_3d.h\nindex 7dac7610f71a..416e3df56aec 100644\n--- a/modules/jolt_physics/jolt_physics_server_3d.h\n+++ b/modules/jolt_physics/jolt_physics_server_3d.h\n@@ -421,6 +421,7 @@ class JoltPhysicsServer3D final : public PhysicsServer3D {\n \n \tvirtual int get_process_info(PhysicsServer3D::ProcessInfo p_process_info) override;\n \n+\tbool is_on_separate_thread() const { return on_separate_thread; }\n \tbool is_active() const { return active; }\n \n \tvoid free_space(JoltSpace3D *p_space);\ndiff --git a/modules/jolt_physics/objects/jolt_object_3d.cpp b/modules/jolt_physics/objects/jolt_object_3d.cpp\nindex 1c2019d9fa3f..e9e6d504e0e7 100644\n--- a/modules/jolt_physics/objects/jolt_object_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_object_3d.cpp\n@@ -30,6 +30,7 @@\n \n #include \"jolt_object_3d.h\"\n \n+#include \"../jolt_physics_server_3d.h\"\n #include \"../jolt_project_settings.h\"\n #include \"../spaces/jolt_layers.h\"\n #include \"../spaces/jolt_space_3d.h\"\n@@ -137,6 +138,12 @@ bool JoltObject3D::can_interact_with(const JoltObject3D &p_other) const {\n }\n \n String JoltObject3D::to_string() const {\n+\tstatic const String fallback_name = \"<unknown>\";\n+\n+\tif (JoltPhysicsServer3D::get_singleton()->is_on_separate_thread()) {\n+\t\treturn fallback_name; // Calling `Object::to_string` is not thread-safe.\n+\t}\n+\n \tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n+\treturn instance != nullptr ? instance->to_string() : fallback_name;\n }\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\nindex 281591af9a6c..040d98dace9f 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.cpp\n@@ -727,8 +727,3 @@ bool JoltSoftBody3D::is_vertex_pinned(int p_index) const {\n \n \treturn pinned_vertices.has(physics_index);\n }\n-\n-String JoltSoftBody3D::to_string() const {\n-\tObject *instance = get_instance();\n-\treturn instance != nullptr ? instance->to_string() : \"<unknown>\";\n-}\ndiff --git a/modules/jolt_physics/objects/jolt_soft_body_3d.h b/modules/jolt_physics/objects/jolt_soft_body_3d.h\nindex f236310f6c69..4d7eb039426b 100644\n--- a/modules/jolt_physics/objects/jolt_soft_body_3d.h\n+++ b/modules/jolt_physics/objects/jolt_soft_body_3d.h\n@@ -167,8 +167,6 @@ class JoltSoftBody3D final : public JoltObject3D {\n \tvoid unpin_all_vertices();\n \n \tbool is_vertex_pinned(int p_index) const;\n-\n-\tString to_string() const;\n };\n \n #endif // JOLT_SOFT_BODY_3D_H\n", "instance_id": "godotengine__godot-102726", "clarity": 3, "difficulty": 0.45, "clarity_explanation": "The problem statement is comprehensive and well-structured. It clearly describes the issue: when using Jolt Physics on a separate thread in Godot 4.4, warnings fail to report bone names due to thread-safety issues, resulting in malformed output. The goal is evident—ensure warnings are meaningful even when physics runs on a separate thread. The statement includes detailed system information, tested versions, steps to reproduce, and even a minimal reproduction project (MRP). It contrasts the behavior between running physics on the main thread (correct output) and a separate thread (malformed output), providing clear examples of expected versus actual results. Constraints and context, such as the thread-safety limitation, are explicitly mentioned. There are no significant ambiguities, and the problem's scope is well-defined, making it a strong candidate for a clarity score of 3.", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes is moderate, involving modifications across a few files (e.g., `jolt_physics_server_3d.h`, `jolt_object_3d.cpp`, `jolt_soft_body_3d.cpp`, and documentation in `ProjectSettings.xml`). The changes primarily focus on adding thread-awareness to prevent unsafe calls to `Object::to_string()` and updating documentation to reflect limitations, which does not significantly impact the system's architecture. Second, the technical concepts required include understanding thread-safety in a game engine context, familiarity with Godot's physics server implementation, and basic knowledge of the Jolt Physics integration. These concepts are not overly complex for someone with experience in multi-threaded programming or game engines, though they do require specific domain knowledge. Third, the problem does not explicitly mention complex edge cases beyond the thread-safety issue, and the provided solution (returning a fallback string when on a separate thread) is straightforward, with minimal error-handling additions. Lastly, the amount of code change is small and localized, mostly involving conditional checks and documentation updates. Overall, this problem requires understanding multiple concepts and making targeted modifications, but it lacks the depth or architectural impact to push it into the hard category, justifying a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot 4.4 throws errors when using `await` on EditorPlugin\n### Tested versions\n\n- Reproducible: 4.4-dev1 and 4.4-dev7\n- Not Reproducible: 4.3-stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1650 (NVIDIA; 32.0.15.6603) - Intel(R) Core(TM) i7-2600K CPU @ 3.40GHz (8 threads)\n\n### Issue description\n\nWhen the editor starts up, calling code from an Autoload to an EditorPlugin with a function that uses `while` and `await` will result in either:\n- Working fine.\n- Throwing a Bad Address Index error.\n- Throwing an Internal Script error with opcode 0, 1 or 99.\n- Crashing to desktop.\n\n![Image](https://github.com/user-attachments/assets/24fe74ed-8acc-4ff7-b0d8-8fa50fee318a)\n\n### Steps to reproduce\n\nThe MRP will throw the error when opening the project. If it doesn't, use \"Project > Reload Current Project\" as sometimes it may simply work.\n\nThis problem seems to require a combination of a few situations to happen:\n- The EditorPlugin must be enabled. The issue vanishes when disabled, even if there are no changes in the script execution.\n- The function must be called from the Autoloader to the EditorPlugin, if called from inside the EditorPlugin, it works fine.\n- the EditorPlugin class must be loaded inside the function using `load()`. Works fine with a preloaded variable on the class scope.\n- The `await` must be inside the `while` loop.\n\n\nSome background on why I'm running code like this:\n- To isolate editor access to only inside the EditorPlugin class.\n- My plugin checks for a resource file, if it doesn't exist, creates the file and updates the FileSystem if it's in editor mode.\n- After v4.2 or v4.3, the FileSystem takes a while to load and during that time any new files or requests to update are ignored.\n- I can't use `preload()` because EditorPlugin classes are not exported to runtime.\n\n### Minimal reproduction project (MRP)\n\n[project_bad_address.zip](https://github.com/user-attachments/files/18223024/project_bad_address.zip)\n", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 961d81c034fd..c8b6227d1341 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -3710,7 +3710,9 @@ void EditorNode::set_addon_plugin_enabled(const String &p_addon, bool p_enabled,\n \t// Only try to load the script if it has a name. Else, the plugin has no init script.\n \tif (script_path.length() > 0) {\n \t\tscript_path = addon_path.get_base_dir().path_join(script_path);\n-\t\tscr = ResourceLoader::load(script_path, \"Script\", ResourceFormatLoader::CACHE_MODE_IGNORE);\n+\t\t// We should not use the cached version on startup to prevent a script reload\n+\t\t// if it is already loaded and potentially running from autoloads. See GH-100750.\n+\t\tscr = ResourceLoader::load(script_path, \"Script\", EditorFileSystem::get_singleton()->doing_first_scan() ? ResourceFormatLoader::CACHE_MODE_REUSE : ResourceFormatLoader::CACHE_MODE_IGNORE);\n \n \t\tif (scr.is_null()) {\n \t\t\tshow_warning(vformat(TTR(\"Unable to load addon script from path: '%s'.\"), script_path));\n", "instance_id": "godotengine__godot-102535", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with Godot 4.4 when using `await` in an EditorPlugin under specific conditions. It provides detailed steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. The description also includes specific scenarios (e.g., EditorPlugin must be enabled, `await` inside a `while` loop) that trigger the error, along with background on why the code is structured this way. However, there are minor ambiguities: the exact nature of the errors (e.g., \"Bad Address Index error\" or \"Internal Script error with opcode 0, 1 or 99\") is not fully explained, and the problem statement does not explicitly define the expected behavior or desired outcome beyond \"fixing the error.\" Additionally, edge cases or constraints around the timing of the FileSystem loading or other environmental factors are not fully specified, which could impact the solution's robustness. Overall, while the issue is well-documented, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code change, while seemingly small (a single line modification in `editor_node.cpp`), requires a deep understanding of the Godot engine's internals, specifically the resource loading mechanism and the interaction between EditorPlugins, Autoloads, and the FileSystem during startup. The change involves modifying the caching behavior of `ResourceLoader::load()` based on whether the editor is performing its first scan, which suggests a nuanced understanding of initialization timing and script reloading issues (as referenced by GH-100750). Second, the technical concepts involved are moderately complex, including Godot's resource management, editor-specific constraints (e.g., EditorPlugin not being exported to runtime), and the interplay of asynchronous operations (`await`) with loops in the GDScript runtime. Third, the problem likely involves subtle edge cases related to startup timing, script execution order, and FileSystem readiness, which are not fully detailed but are implied by the erratic behavior (sometimes working, sometimes crashing). While the code change itself is minimal, the impact on the system's behavior is significant, as it addresses a core editor initialization issue that could affect stability across various plugins and projects. This combination of deep domain knowledge, system-level understanding, and potential for subtle bugs or regressions places the difficulty at 0.65, within the \"Hard\" range (0.6-0.8), though not at the extreme end due to the localized nature of the fix.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.85, "human_difficulty_explanation": "The code that needs to be modified involves too many aspects such as asynchronous operations and file execution order, which most models do not possess the specialized knowledge to handle."}
{"problem_statement": "Crash when duplicating file with Ctrl+Drag and drop\n### Tested versions\n\n4.4 dev7, dev6, didn't test earlier\n\n### System information\n\nW10\n\n### Issue description\n\n```\nCrashHandlerException: Program crashed\nEngine version: Godot Engine v4.4.dev.custom_build (d2ada64a03d2abdb97cafe8f10623db8a2ce1d4c)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[0] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[1] std::_Atomic_storage<unsigned __int64,8>::load (C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Tools\\MSVC\\14.39.33519\\include\\atomic:1121)\n[2] SafeNumeric<unsigned __int64>::conditional_increment (C:\\godot_source\\core\\templates\\safe_refcount.h:139)\n[3] CowData<char32_t>::_ref (C:\\godot_source\\core\\templates\\cowdata.h:502)\n[4] String::String (C:\\godot_source\\core\\string\\ustring.h:602)\n[5] EditorFileSystemDirectory::get_file (C:\\godot_source\\editor\\editor_file_system.cpp:94)\n[6] EditorFileSystemDirectory::get_file_path (C:\\godot_source\\editor\\editor_file_system.cpp:126)\n[7] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:847)\n[8] EditorFileSystem::_notification (C:\\godot_source\\editor\\editor_file_system.cpp:1714)\n[9] EditorFileSystem::_notificationv (C:\\godot_source\\editor\\editor_file_system.h:145)\n[10] Object::notification (C:\\godot_source\\core\\object\\object.cpp:883)\n[11] SceneTree::_process_group (C:\\godot_source\\scene\\main\\scene_tree.cpp:1063)\n[12] SceneTree::_process (C:\\godot_source\\scene\\main\\scene_tree.cpp:1140)\n[13] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:580)\n[14] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[15] ProgressDialog::_update_ui (C:\\godot_source\\editor\\progress_dialog.cpp:135)\n[16] ProgressDialog::task_step (C:\\godot_source\\editor\\progress_dialog.cpp:222)\n[17] EditorNode::progress_task_step (C:\\godot_source\\editor\\editor_node.cpp:4965)\n[18] EditorProgress::step (C:\\godot_source\\editor\\editor_node.cpp:180)\n[19] EditorFileSystem::reimport_files (C:\\godot_source\\editor\\editor_file_system.cpp:3118)\n[20] EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor\\editor_file_system.cpp:963)\n[21] EditorFileSystem::_refresh_filesystem (C:\\godot_source\\editor\\editor_file_system.cpp:3044)\n[22] call_with_variant_args_helper<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:320)\n[23] call_with_variant_args<EditorFileSystem> (C:\\godot_source\\core\\variant\\binder_common.h:430)\n[24] CallableCustomMethodPointer<EditorFileSystem,void>::call (C:\\godot_source\\core\\object\\callable_method_pointer.h:109)\n[25] Callable::callp (C:\\godot_source\\core\\variant\\callable.cpp:58)\n[26] Object::emit_signalp (C:\\godot_source\\core\\object\\object.cpp:1206)\n[27] Object::emit_signal<> (C:\\godot_source\\core\\object\\object.h:926)\n[28] SceneTree::process (C:\\godot_source\\scene\\main\\scene_tree.cpp:574)\n[29] Main::iteration (C:\\godot_source\\main\\main.cpp:4493)\n[30] OS_Windows::run (C:\\godot_source\\platform\\windows\\os_windows.cpp:2062)\n[31] widechar_main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:181)\n[32] _main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:206)\n[33] main (C:\\godot_source\\platform\\windows\\godot_windows.cpp:220)\n[34] WinMain (C:\\godot_source\\platform\\windows\\godot_windows.cpp:234)\n[35] __scrt_common_main_seh (D:\\a\\_work\\1\\s\\src\\vctools\\crt\\vcstartup\\src\\startup\\exe_common.inl:288)\n[36] <couldn't map PC to fn name>\n-- END OF BACKTRACE --\n```\nAlternatively this error will appear:\n```\nERROR: Condition \"idx == -1\" is true. Continuing.\n   at: EditorFileSystem::_update_scan_actions (C:\\godot_source\\editor/editor_file_system.cpp:899)\nERROR: Attempted to call reimport_files() recursively, this is not allowed.\n   at: (C:\\godot_source\\editor/editor_file_system.cpp:3055)\n```\n\n### Steps to reproduce\n\n1. Have any PNG file in your project\n2. Drag and drop it to another directory while holding Ctrl\n3. Either crash or error\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/filesystem_dock.cpp b/editor/filesystem_dock.cpp\nindex b1156f61a3d9..e29d7424c5f3 100644\n--- a/editor/filesystem_dock.cpp\n+++ b/editor/filesystem_dock.cpp\n@@ -1959,18 +1959,12 @@ void FileSystemDock::_move_operation_confirm(const String &p_to_path, bool p_cop\n \t}\n \n \tif (p_copy) {\n-\t\tbool is_copied = false;\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n \t\t\tif (to_move[i].path != new_paths[i]) {\n \t\t\t\t_try_duplicate_item(to_move[i], new_paths[i]);\n \t\t\t\tselect_after_scan = new_paths[i];\n-\t\t\t\tis_copied = true;\n \t\t\t}\n \t\t}\n-\n-\t\tif (is_copied) {\n-\t\t\t_rescan();\n-\t\t}\n \t} else {\n \t\t// Check groups.\n \t\tfor (int i = 0; i < to_move.size(); i++) {\n", "instance_id": "godotengine__godot-102260", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash or error occurs when duplicating a file using Ctrl+Drag and Drop in the Godot Engine editor on Windows 10. It provides specific steps to reproduce the issue, the affected versions, and a detailed backtrace of the crash, which helps in identifying the problematic areas in the codebase. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior after duplication (e.g., should the file be copied and immediately visible in the new location?). Additionally, it lacks clarity on specific edge cases beyond the basic reproduction steps (e.g., behavior with different file types, large files, or nested directories). While a minimal reproduction project (MRP) is marked as N/A, it would have been helpful to have a small test case or further context about the project structure. Overall, the statement is valid and mostly clear but misses some minor details that could aid in a more comprehensive understanding of the issue.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively small, as it involves modifying a specific part of the `filesystem_dock.cpp` file to address the crash or error during file duplication. The provided diff shows a targeted change—removing a forced rescan after a copy operation—which suggests the fix does not require extensive modifications across multiple files or a deep architectural overhaul. However, understanding the root cause requires familiarity with the Godot Engine's editor filesystem logic, particularly how file operations like duplication interact with the scanning and updating mechanisms (`_update_scan_actions`, `reimport_files`, etc.), as hinted by the backtrace and error messages. This involves moderate complexity in terms of technical concepts, such as understanding reference counting (`SafeNumeric`, `CowData`), string handling in C++, and the editor's event-driven notification system. Additionally, the problem hints at potential edge cases (e.g., recursive reimport calls, as seen in the error message), which may require careful handling to prevent further crashes or errors, though these are not extensively detailed in the statement. Overall, solving this issue requires a moderate understanding of the codebase and targeted debugging skills, but it does not appear to demand advanced domain-specific knowledge or extensive system-level changes, placing it in the 0.4-0.6 range with a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`print_verbose` makes build fail when `scu_build=yes`\n### Tested versions\n\n- 4.4.beta\n\n### System information\n\nWindows 11\n\n### Issue description\n\nThe `print_verbose` macro is causing one of the CI jobs that uses `scu_build=yes` to fail in my PR although I didn't modify the file calling it.\nhttps://github.com/godotengine/godot/actions/runs/12934119444/job/36074414239\n\nMy local build also fails when I use `scu_build=yes` but works fine otherwise.\n```sh\n[100%] godot\\core/debugger/remote_debugger_peer.cpp(172): error C3861: 'print_verbose': identifier not found\n```\n\nBy the way, it works if I replace it with `WARN_VERBOSE`.\n\n### Steps to reproduce\n\n- Checkout https://github.com/godotengine/godot/pull/100516\n- I changed calls to `print_verbose`  in `core/debugger/remote_debugger_peer.cpp` to `WARN_VERBOSE` to fix CI. Change it back to `print_verbose`. \n- Build it with `scons scu_build=yes`.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/core/variant/variant_utility.cpp b/core/variant/variant_utility.cpp\nindex ec9492ac5d1c..a53b5660d5a5 100644\n--- a/core/variant/variant_utility.cpp\n+++ b/core/variant/variant_utility.cpp\n@@ -999,9 +999,7 @@ void VariantUtilityFunctions::print_rich(const Variant **p_args, int p_arg_count\n \tr_error.error = Callable::CallError::CALL_OK;\n }\n \n-#undef print_verbose\n-\n-void VariantUtilityFunctions::print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n+void VariantUtilityFunctions::_print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error) {\n \tif (OS::get_singleton()->is_stdout_verbose()) {\n \t\tString s;\n \t\tfor (int i = 0; i < p_arg_count; i++) {\n@@ -1581,16 +1579,16 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n-#define FUNCBINDVARARGV(m_func, m_args, m_category)                                                              \\\n+#define FUNCBINDVARARGV_CNAME(m_func, m_func_cname, m_args, m_category)                                          \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n \t\tstatic void call(Variant *r_ret, const Variant **p_args, int p_argcount, Callable::CallError &r_error) { \\\n \t\t\tr_error.error = Callable::CallError::CALL_OK;                                                        \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, r_error);                                        \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, r_error);                                  \\\n \t\t}                                                                                                        \\\n \t\tstatic void validated_call(Variant *r_ret, const Variant **p_args, int p_argcount) {                     \\\n \t\t\tCallable::CallError c;                                                                               \\\n-\t\t\tVariantUtilityFunctions::m_func(p_args, p_argcount, c);                                              \\\n+\t\t\tVariantUtilityFunctions::m_func_cname(p_args, p_argcount, c);                                        \\\n \t\t}                                                                                                        \\\n \t\tstatic void ptrcall(void *ret, const void **p_args, int p_argcount) {                                    \\\n \t\t\tVector<Variant> args;                                                                                \\\n@@ -1625,6 +1623,8 @@ static _FORCE_INLINE_ Variant::Type get_ret_type_helper(void (*p_func)(P...)) {\n \t};                                                                                                           \\\n \tregister_utility_function<Func_##m_func>(#m_func, m_args)\n \n+#define FUNCBINDVARARGV(m_func, m_args, m_category) FUNCBINDVARARGV_CNAME(m_func, m_func, m_args, m_category)\n+\n #define FUNCBIND(m_func, m_args, m_category)                                                                     \\\n \tclass Func_##m_func {                                                                                        \\\n \tpublic:                                                                                                      \\\n@@ -1832,7 +1832,7 @@ void Variant::_register_variant_utility_functions() {\n \tFUNCBINDVARARGV(printt, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(prints, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(printraw, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n-\tFUNCBINDVARARGV(print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n+\tFUNCBINDVARARGV_CNAME(print_verbose, _print_verbose, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_error, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \tFUNCBINDVARARGV(push_warning, sarray(), Variant::UTILITY_FUNC_TYPE_GENERAL);\n \ndiff --git a/core/variant/variant_utility.h b/core/variant/variant_utility.h\nindex 75cde4942b5f..a653369621a0 100644\n--- a/core/variant/variant_utility.h\n+++ b/core/variant/variant_utility.h\n@@ -133,8 +133,7 @@ struct VariantUtilityFunctions {\n \tstatic String type_string(Variant::Type p_type);\n \tstatic void print(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void print_rich(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n-#undef print_verbose\n-\tstatic void print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n+\tstatic void _print_verbose(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printerr(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void printt(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n \tstatic void prints(const Variant **p_args, int p_arg_count, Callable::CallError &r_error);\n", "instance_id": "godotengine__godot-102062", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `print_verbose` macro causes a build failure when `scu_build=yes` is used, and the error message and affected file are provided. The steps to reproduce are also given, along with a reference to a specific GitHub PR and CI job failure. However, there are minor ambiguities and missing details. For instance, the problem statement does not explain why `print_verbose` fails under `scu_build=yes` (e.g., is it a macro definition issue, a build configuration conflict, or something else?). Additionally, there is no mention of specific constraints or requirements for the fix beyond replacing `print_verbose` with `WARN_VERBOSE` as a workaround. Edge cases or broader implications of the issue are not discussed. Overall, while the issue is understandable and actionable, it lacks deeper context or comprehensive details about the root cause or desired solution.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are localized to two files (`variant_utility.cpp` and `variant_utility.h`) and involve renaming a function (`print_verbose` to `_print_verbose`) and updating macro definitions to handle the renaming. The changes are relatively small in terms of lines of code and do not appear to impact the broader system architecture. However, understanding the macro system (`FUNCBINDVARARGV` and its variants) and how it interacts with the build configuration (`scu_build=yes`) adds a slight layer of complexity.\n\n2. **Technical Concepts Involved:** Solving this issue requires familiarity with C++ macros, function binding mechanisms in the Godot engine (as seen in the `FUNCBINDVARARGV` macro), and build configuration options (`scu_build=yes`). While these concepts are not overly complex for an experienced C++ developer, they do require some domain-specific knowledge of the Godot engine's internals and build system, which elevates the difficulty slightly beyond a trivial fix.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases or additional error handling requirements. The code changes provided also do not introduce new error handling logic. However, the developer must ensure that renaming `print_verbose` to `_print_verbose` does not break other parts of the codebase that might rely on the original name or macro, which introduces a minor risk of unintended side effects.\n\n4. **Overall Complexity:** The issue is a build failure caused by a naming or macro resolution problem, which is a common type of bug in large C++ projects. The fix involves straightforward renaming and macro adjustments, but it requires a basic understanding of the Godot engine's utility function registration system and build configurations. This places the difficulty slightly above a very easy task (e.g., fixing a typo) but still within the easy category due to the limited scope and moderate conceptual requirements.\n\nIn summary, I assign a difficulty score of 0.35, reflecting an easy problem that requires some understanding of the codebase and build system but does not involve complex logic, extensive changes, or significant architectural impact.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Closing game running in editor no longer sends NotificationWMCloseRequest - v4.4Beta1\n### Tested versions\n\n- Reproducible in 4.4Beta1 .NET\n- Not reproducible in 4.3 .NET\n\n### System information\n\nWindows 11 - Godot_v4.4-beta1_mono_win64\n\n### Issue description\n\nWhen closing the game while running it via the editor, a NotificationWMCloseRequest is no longer sent in 4.4.\n\n### Steps to reproduce\n\nSee minimal reproduction project\n\n### Minimal reproduction project (MRP)\n\nAttached is a simple 'save on exit' project that will demonstrate the issue.  When running the game in the editor interface in 4.3, the entire game state will be saved upon closing (and loaded when you next restart the game).  When running the game in the editor interface in 4.4, the game will no longer save because a NotificationWMCloseRequest is no longer sent when the game is closing.\n\nNote: The `StageManager` class is responsible for receiving the NotificationWMCloseRequest in this project.\n\n[BrackeysFirstSavedGame.zip](https://github.com/user-attachments/files/18483606/BrackeysFirstSavedGame.zip)\n", "patch": "diff --git a/editor/plugins/game_view_plugin.cpp b/editor/plugins/game_view_plugin.cpp\nindex b1f7a8498a3a..f0f1a915f011 100644\n--- a/editor/plugins/game_view_plugin.cpp\n+++ b/editor/plugins/game_view_plugin.cpp\n@@ -652,14 +652,20 @@ void GameView::_update_arguments_for_instance(int p_idx, List<String> &r_argumen\n \tr_arguments.insert_after(N, itos(rect.size.x) + \"x\" + itos(rect.size.y));\n }\n \n-void GameView::_window_before_closing() {\n+void GameView::_window_close_request() {\n \t// Before the parent window closed, we close the embedded game. That prevents\n \t// the embedded game to be seen without a parent window for a fraction of second.\n \tif (EditorRunBar::get_singleton()->is_playing() && (embedded_process->is_embedding_completed() || embedded_process->is_embedding_in_progress())) {\n+\t\t// Try to gracefully close the window. That way, the NOTIFICATION_WM_CLOSE_REQUEST\n+\t\t// notification should be propagated in the game process.\n \t\tembedded_process->reset();\n-\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n-\t\t// actually closes.\n-\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\n+\t\t// When the embedding is not complete, we need to kill the process.\n+\t\tif (embedded_process->is_embedding_in_progress()) {\n+\t\t\t// Call deferred to prevent the _stop_pressed callback to be executed before the wrapper window\n+\t\t\t// actually closes.\n+\t\t\tcallable_mp(EditorRunBar::get_singleton(), &EditorRunBar::stop_playing).call_deferred();\n+\t\t}\n \t}\n }\n \n@@ -829,7 +835,8 @@ GameView::GameView(Ref<GameViewDebugger> p_debugger, WindowWrapper *p_wrapper) {\n \tp_debugger->connect(\"session_started\", callable_mp(this, &GameView::_sessions_changed));\n \tp_debugger->connect(\"session_stopped\", callable_mp(this, &GameView::_sessions_changed));\n \n-\tp_wrapper->connect(\"window_before_closing\", callable_mp(this, &GameView::_window_before_closing));\n+\tp_wrapper->set_override_close_request(true);\n+\tp_wrapper->connect(\"window_close_requested\", callable_mp(this, &GameView::_window_close_request));\n \tp_wrapper->connect(\"window_size_changed\", callable_mp(this, &GameView::_update_floating_window_settings));\n }\n \ndiff --git a/editor/plugins/game_view_plugin.h b/editor/plugins/game_view_plugin.h\nindex 959da73dcde8..273652dae821 100644\n--- a/editor/plugins/game_view_plugin.h\n+++ b/editor/plugins/game_view_plugin.h\n@@ -162,7 +162,7 @@ class GameView : public VBoxContainer {\n \tvoid _camera_override_button_toggled(bool p_pressed);\n \tvoid _camera_override_menu_id_pressed(int p_id);\n \n-\tvoid _window_before_closing();\n+\tvoid _window_close_request();\n \tvoid _update_floating_window_settings();\n \tvoid _attach_script_debugger();\n \tvoid _detach_script_debugger();\ndiff --git a/editor/window_wrapper.cpp b/editor/window_wrapper.cpp\nindex 37a3efc91e90..22e2fda68567 100644\n--- a/editor/window_wrapper.cpp\n+++ b/editor/window_wrapper.cpp\n@@ -101,12 +101,6 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \n \tNode *parent = _get_wrapped_control_parent();\n \n-\t// In the GameView plugin, we need to the the signal before the window is actually closed\n-\t// to prevent the embedded game to be seen the parent window for a fraction of a second.\n-\tif (!p_visible) {\n-\t\temit_signal(\"window_before_closing\");\n-\t}\n-\n \tif (wrapped_control->get_parent() != parent) {\n \t\t// Move the control to the window.\n \t\twrapped_control->reparent(parent, false);\n@@ -120,7 +114,7 @@ void WindowWrapper::_set_window_enabled_with_rect(bool p_visible, const Rect2 p_\n \t}\n \n \twindow->set_visible(p_visible);\n-\tif (!p_visible) {\n+\tif (!p_visible && !override_close_request) {\n \t\temit_signal(\"window_close_requested\");\n \t}\n \temit_signal(\"window_visibility_changed\", p_visible);\n@@ -141,10 +135,17 @@ void WindowWrapper::_window_size_changed() {\n \temit_signal(SNAME(\"window_size_changed\"));\n }\n \n+void WindowWrapper::_window_close_request() {\n+\tif (override_close_request) {\n+\t\temit_signal(\"window_close_requested\");\n+\t} else {\n+\t\tset_window_enabled(false);\n+\t}\n+}\n+\n void WindowWrapper::_bind_methods() {\n \tADD_SIGNAL(MethodInfo(\"window_visibility_changed\", PropertyInfo(Variant::BOOL, \"visible\")));\n \tADD_SIGNAL(MethodInfo(\"window_close_requested\"));\n-\tADD_SIGNAL(MethodInfo(\"window_before_closing\"));\n \tADD_SIGNAL(MethodInfo(\"window_size_changed\"));\n }\n \n@@ -330,6 +331,10 @@ void WindowWrapper::grab_window_focus() {\n \t}\n }\n \n+void WindowWrapper::set_override_close_request(bool p_enabled) {\n+\toverride_close_request = p_enabled;\n+}\n+\n WindowWrapper::WindowWrapper() {\n \tif (!EditorNode::get_singleton()->is_multi_window_enabled()) {\n \t\treturn;\n@@ -342,7 +347,7 @@ WindowWrapper::WindowWrapper() {\n \tadd_child(window);\n \twindow->hide();\n \n-\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::set_window_enabled).bind(false));\n+\twindow->connect(\"close_requested\", callable_mp(this, &WindowWrapper::_window_close_request));\n \twindow->connect(\"size_changed\", callable_mp(this, &WindowWrapper::_window_size_changed));\n \n \tShortcutBin *capturer = memnew(ShortcutBin);\ndiff --git a/editor/window_wrapper.h b/editor/window_wrapper.h\nindex 3f4e9385861c..e33c8c179d53 100644\n--- a/editor/window_wrapper.h\n+++ b/editor/window_wrapper.h\n@@ -50,12 +50,15 @@ class WindowWrapper : public MarginContainer {\n \n \tRef<Shortcut> enable_shortcut;\n \n+\tbool override_close_request = false;\n+\n \tRect2 _get_default_window_rect() const;\n \tNode *_get_wrapped_control_parent() const;\n \n \tvoid _set_window_enabled_with_rect(bool p_visible, const Rect2 p_rect);\n \tvoid _set_window_rect(const Rect2 p_rect);\n \tvoid _window_size_changed();\n+\tvoid _window_close_request();\n \n protected:\n \tstatic void _bind_methods();\n@@ -84,6 +87,8 @@ class WindowWrapper : public MarginContainer {\n \tvoid set_margins_enabled(bool p_enabled);\n \tvoid grab_window_focus();\n \n+\tvoid set_override_close_request(bool p_enabled);\n+\n \tWindowWrapper();\n \t~WindowWrapper();\n };\ndiff --git a/platform/linuxbsd/x11/display_server_x11.cpp b/platform/linuxbsd/x11/display_server_x11.cpp\nindex b17f72dc5c04..b1945eb47a2e 100644\n--- a/platform/linuxbsd/x11/display_server_x11.cpp\n+++ b/platform/linuxbsd/x11/display_server_x11.cpp\n@@ -5849,6 +5849,24 @@ Error DisplayServerX11::remove_embedded_process(OS::ProcessID p_pid) {\n \t}\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n+\n+\t// Handle bad window errors silently because just in case the embedded window was closed.\n+\tint (*oldHandler)(Display *, XErrorEvent *) = XSetErrorHandler(&bad_window_error_handler);\n+\n+\t// Send the message to gracefully close the window.\n+\tXEvent ev;\n+\tmemset(&ev, 0, sizeof(ev));\n+\tev.xclient.type = ClientMessage;\n+\tev.xclient.window = ep->process_window;\n+\tev.xclient.message_type = XInternAtom(x11_display, \"WM_PROTOCOLS\", True);\n+\tev.xclient.format = 32;\n+\tev.xclient.data.l[0] = XInternAtom(x11_display, \"WM_DELETE_WINDOW\", False);\n+\tev.xclient.data.l[1] = CurrentTime;\n+\tXSendEvent(x11_display, ep->process_window, False, NoEventMask, &ev);\n+\n+\t// Restore default error handler.\n+\tXSetErrorHandler(oldHandler);\n+\n \tembedded_processes.erase(p_pid);\n \tmemdelete(ep);\n \ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex ac7fa8b3c69e..1d3a6f0ca4f2 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2975,6 +2975,9 @@ Error DisplayServerWindows::remove_embedded_process(OS::ProcessID p_pid) {\n \n \tEmbeddedProcessData *ep = embedded_processes.get(p_pid);\n \n+\t// Send a close message to gracefully close the process.\n+\tPostMessage(ep->window_handle, WM_CLOSE, 0, 0);\n+\n \t// This is a workaround to ensure the parent window correctly regains focus after the\n \t// embedded window is closed. When the embedded window is closed while it has focus,\n \t// the parent window (the editor) does not become active. It appears focused but is not truly activated.\n", "instance_id": "godotengine__godot-101895", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `NotificationWMCloseRequest` is no longer sent when closing a game running in the editor in version 4.4Beta1 of Godot, compared to version 4.3. It provides context about the affected versions, system information, and a minimal reproduction project (MRP) to demonstrate the issue. The goal of fixing the missing notification is evident, and the steps to reproduce are referenced via the MRP. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"sending the notification\" (e.g., under what exact conditions or configurations), nor does it mention potential edge cases or constraints (e.g., behavior in different operating systems beyond Windows 11). Additionally, while the MRP is provided, the problem statement lacks inline examples or detailed expected input/output behavior. Thus, while the issue is valid and mostly clear, it misses some minor but useful details for a fully comprehensive description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`game_view_plugin.cpp`, `game_view_plugin.h`, `window_wrapper.cpp`, `window_wrapper.h`, `display_server_x11.cpp`, and `display_server_windows.cpp`), indicating a need to understand and modify interactions across different modules of the Godot engine. The changes involve not just simple bug fixes but a restructuring of how window close requests are handled, including introducing graceful shutdown mechanisms (e.g., sending `WM_CLOSE` messages on Windows or `WM_DELETE_WINDOW` on Linux). Second, the technical concepts required include knowledge of Godot's editor plugin architecture, window management in the engine, platform-specific APIs (Windows and X11), event handling, and process management for embedded games. These are moderately advanced topics, especially since they involve cross-platform considerations. Third, the problem requires handling edge cases, such as incomplete embedding states (`is_embedding_in_progress`), ensuring proper focus management after closing embedded windows, and gracefully propagating close requests without visual glitches. The code changes also impact core functionality (window closing behavior in the editor), which could have broader architectural implications if not handled carefully. While the problem does not reach \"Very Hard\" (0.8-1.0) due to the absence of extremely complex algorithms or system-level redesigns, it still demands a deep understanding of the codebase and careful implementation to avoid introducing new bugs. Hence, a score of 0.65 reflects the challenging nature of the task, balancing the complexity of multi-file changes, technical depth, and edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "TextureRect with ViewportTexture from SubViewport in SubViewportContainer crashes when switching back to scene tab.\n### Tested versions\n\n- Reproducible in v4.4-beta1.mono.official\n- Not reproducible in v4.3.stable.mono.official\n\n### System information\n\nGodot v4.4.beta1.mono - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 SUPER (nvidia; 550.120) - Intel(R) Core(TM) i7-14700KF (28 threads)\n\n### Issue description\n\nWhen a scene contains a `TextureRect`  inside of `CanvasLayer`, which has a `ViewportTexture` pointing to a `SubViewport` in a `SubViewportContainer`, the editor will crash when switching back to that scene tab.\n\nThis crash does not occur when `TextureRect` is not in a `CanvasLayer` or when `SubViewport` is not in a `SubViewportContainer`.\n\nA sample backtrace can be found below:\n\n```\n================================================================\nhandle_crash: Program crashed with signal 11\nEngine version: Godot Engine v4.4.beta1.mono.official (d33da79d3f8fe84be2521d25b9ba8e440cf25a88)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n[1] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x6068bc) [0x7ec4948068bc] (??:0)\n[2] /usr/lib/dotnet8/shared/Microsoft.NETCore.App/8.0.12/libcoreclr.so(+0x605ef5) [0x7ec494805ef5] (??:0)\n[3] /lib/x86_64-linux-gnu/libc.so.6(+0x45320) [0x7ec4cbe45320] (??:0)\n[4] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2945d4a] (??:0)\n[5] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2943eb9] (??:0)\n[6] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294c182] (??:0)\n[7] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2a563dc] (??:0)\n[8] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2ac99e3] (??:0)\n[9] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180c1] (??:0)\n[10] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[11] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x28a284f] (??:0)\n[12] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x21180b7] (??:0)\n[13] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x477e0c8] (??:0)\n[14] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29336f6] (??:0)\n[15] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[16] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2933975] (??:0)\n[17] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934792] (??:0)\n[18] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2934a10] (??:0)\n[19] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1950204] (??:0)\n[20] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[21] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x1cd37a6] (??:0)\n[22] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x484291a] (??:0)\n[23] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd0e0c] (??:0)\n[24] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x2cd1bbe] (??:0)\n[25] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x294e07f] (??:0)\n[26] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c4915] (??:0)\n[27] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29c5ab6] (??:0)\n[28] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x29dc19c] (??:0)\n[29] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4f5510b] (??:0)\n[30] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4cf5ed] (??:0)\n[31] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a0843] (??:0)\n[32] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x44a2c2f] (??:0)\n[33] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x4d8a83] (??:0)\n[34] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x41e313] (??:0)\n[35] /lib/x86_64-linux-gnu/libc.so.6(+0x2a1ca) [0x7ec4cbe2a1ca] (??:0)\n[36] /lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0x8b) [0x7ec4cbe2a28b] (??:0)\n[37] /opt/Godot_v4.4-beta1_mono_linux_x86_64/Godot_v4.4-beta1_mono_linux.x86_64() [0x443faa] (??:0)\n-- END OF BACKTRACE --\n================================================================\n```\n\n### Steps to reproduce\n\n- Create a scene with the setup below, where the `ViewportTexture` in the `TextureRect` is pointing at `SubViewport`.\n- Open a new tab in the editor\n- Switch back to the scene containing the `TextureRect`\n\n![Image](https://github.com/user-attachments/assets/aa3adc29-9eda-498d-8762-c8be95f0e221)\n\n### Minimal reproduction project (MRP)\n\n[crashrepro.zip](https://github.com/user-attachments/files/18454471/crashrepro.zip)\n", "patch": "diff --git a/scene/main/viewport.cpp b/scene/main/viewport.cpp\nindex e9dfbd6189c1..76b2502bade3 100644\n--- a/scene/main/viewport.cpp\n+++ b/scene/main/viewport.cpp\n@@ -126,7 +126,10 @@ int ViewportTexture::get_width() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().width;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.width;\n+\t}\n+\treturn vp->size.width * vp->get_stretch_transform().get_scale().width;\n }\n \n int ViewportTexture::get_height() const {\n@@ -134,7 +137,10 @@ int ViewportTexture::get_height() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn 0;\n \t}\n-\treturn get_size().height;\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size.height;\n+\t}\n+\treturn vp->size.height * vp->get_stretch_transform().get_scale().height;\n }\n \n Size2 ViewportTexture::get_size() const {\n@@ -142,8 +148,11 @@ Size2 ViewportTexture::get_size() const {\n \t\t_err_print_viewport_not_set();\n \t\treturn Size2();\n \t}\n-\tfloat scale = MIN(vp->get_screen_transform().get_scale().width, vp->get_screen_transform().get_scale().height);\n-\treturn Size2(vp->size.width * scale, vp->size.height * scale).ceil();\n+\tif (vp->is_sub_viewport()) {\n+\t\treturn vp->size;\n+\t}\n+\tSize2 scale = vp->get_stretch_transform().get_scale();\n+\treturn Size2(vp->size.width * scale.width, vp->size.height * scale.height).ceil();\n }\n \n RID ViewportTexture::get_rid() const {\n", "instance_id": "godotengine__godot-101700", "clarity": 3, "difficulty": 0.65, "clarity_explanation": "The problem statement is comprehensive and well-documented. It clearly describes the issue: a crash in the Godot editor when switching scene tabs under a specific setup involving `TextureRect`, `ViewportTexture`, `SubViewport`, and `SubViewportContainer` within a `CanvasLayer`. The statement includes detailed system information, tested versions, steps to reproduce, a minimal reproduction project (MRP), and even a backtrace of the crash. The conditions under which the crash occurs and does not occur are explicitly mentioned, reducing ambiguity. Additionally, visual aids (an image) and a downloadable reproduction project further enhance clarity. There are no significant missing details regarding the problem's context or reproduction, making it a very clear and actionable issue report.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the clarity of the problem statement helps in understanding the issue, but solving it requires a deep understanding of the Godot engine's rendering and viewport system, which is a complex domain-specific area. The code changes provided are focused on a single file (`viewport.cpp`) and modify a specific part of the `ViewportTexture` class to handle size calculations differently for sub-viewports versus regular viewports, indicating a targeted fix. However, the impact of these changes is significant as they affect core rendering logic, which could have downstream effects on other parts of the engine (e.g., how textures are displayed or scaled in different contexts). \n\nThe technical concepts involved include understanding viewport hierarchies, texture rendering, and scaling transformations in a game engine context, which are non-trivial and require familiarity with Godot's internal architecture. While the code change itself is relatively small (a few lines adjusting size calculations), determining the root cause of the crash and ensuring the fix does not introduce regressions or break other features demands careful analysis and testing. Edge cases, such as different viewport configurations, stretch modes, or editor states, are not explicitly mentioned in the problem statement but are implied given the nature of the crash, adding to the complexity of validation. \n\nOverall, this problem requires a solid grasp of the codebase's rendering pipeline and cautious modification to avoid unintended side effects, placing it in the 0.6-0.8 range. I assign a score of 0.65 as it leans toward the lower end of \"Hard\" due to the focused nature of the code change, but still demands significant expertise to ensure correctness and stability.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4 dev7] Seperation Ray causes Mesh surface errors\n### Tested versions\n\n-reproducible in 4.4 Dev 7, mono version \n\n### System information\n\nGodot v4.4.dev7.mono - Windows 10 (build 19045) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1070 (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-7640X CPU @ 4.00GHz (4 threads)\n\n### Issue description\n\nThree errors are thrown when starting a scene with a CollisionShape3D with shape set to Seperation Ray.\n![Image](https://github.com/user-attachments/assets/8da0920f-c8db-420f-9ff6-c955df909800)\n\n\n### Steps to reproduce\n\nOpen the attached project. Run the main scene.\n\nAlternatively, run a scene with a CollisionShape3D, with the shape set to Seperation Ray.\n\n### Minimal reproduction project (MRP)\n\n[surface-error-example.zip](https://github.com/user-attachments/files/18215122/surface-error-example.zip)\n\n", "patch": "diff --git a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\nindex 6db68f413ebd..db9a9bef04b2 100644\n--- a/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n+++ b/editor/plugins/gizmos/collision_shape_3d_gizmo_plugin.cpp\n@@ -350,7 +350,7 @@ void CollisionShape3DGizmoPlugin::redraw(EditorNode3DGizmo *p_gizmo) {\n \n \tif (cs->get_debug_fill_enabled()) {\n \t\tRef<ArrayMesh> array_mesh = s->get_debug_arraymesh_faces(collision_color);\n-\t\tif (array_mesh.is_valid()) {\n+\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n \t\t\tp_gizmo->add_mesh(array_mesh, material_arraymesh);\n \t\t}\n \t}\ndiff --git a/scene/resources/3d/shape_3d.cpp b/scene/resources/3d/shape_3d.cpp\nindex 63d424fb3724..4eae3ffeb2e5 100644\n--- a/scene/resources/3d/shape_3d.cpp\n+++ b/scene/resources/3d/shape_3d.cpp\n@@ -132,9 +132,12 @@ Ref<ArrayMesh> Shape3D::get_debug_mesh() {\n \t\tdebug_mesh_cache->surface_set_material(0, material);\n \n \t\tif (debug_fill) {\n-\t\t\tArray solid_array = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625))->surface_get_arrays(0);\n-\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n-\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\tRef<ArrayMesh> array_mesh = get_debug_arraymesh_faces(debug_color * Color(1.0, 1.0, 1.0, 0.0625));\n+\t\t\tif (array_mesh.is_valid() && array_mesh->get_surface_count() > 0) {\n+\t\t\t\tArray solid_array = array_mesh->surface_get_arrays(0);\n+\t\t\t\tdebug_mesh_cache->add_surface_from_arrays(Mesh::PRIMITIVE_TRIANGLES, solid_array);\n+\t\t\t\tdebug_mesh_cache->surface_set_material(1, material);\n+\t\t\t}\n \t\t}\n \t}\n \n", "instance_id": "godotengine__godot-101014", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: errors are thrown when starting a scene with a CollisionShape3D set to Separation Ray in Godot v4.4.dev7.mono. It provides system information, steps to reproduce, and a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities and missing details. The exact nature of the \"surface errors\" is not described in detail (e.g., what specific errors are thrown), and the problem statement does not explicitly mention the expected behavior or the root cause of the issue. Additionally, there are no mentions of specific edge cases or constraints that might need to be considered. While the attached image and reproduction project help, the textual description could be more comprehensive in defining the problem's scope and desired outcome.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively localized, affecting two files (`collision_shape_3d_gizmo_plugin.cpp` and `shape_3d.cpp`) in the Godot engine codebase. The modifications are small, involving conditional checks to ensure that a mesh has valid surfaces before processing. There is no indication of widespread architectural impact or the need to modify multiple interconnected modules. The changes are straightforward and do not require deep refactoring.\n\n2. **Technical Concepts Involved:** Solving this issue requires a basic understanding of C++ (used in the Godot engine), specifically working with conditional logic and object validation. Familiarity with Godot's rendering and physics systems (e.g., `ArrayMesh`, `CollisionShape3D`) is necessary, but the concepts are not overly complex for someone with moderate experience in game engine development or C++. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic 3D graphics are required.\n\n3. **Edge Cases and Error Handling:** The code changes address a specific error condition—ensuring that a mesh has valid surfaces before rendering or processing. While this implies handling an edge case (invalid or empty mesh surfaces), the solution is simple and does not involve intricate error-handling logic or performance considerations. The problem statement does not explicitly mention other edge cases to consider.\n\n4. **Overall Complexity:** The task involves understanding a small part of the codebase related to debug mesh rendering and gizmo plugins in Godot. The fix is essentially a guard clause to prevent errors when a mesh lacks surfaces, which is a common and straightforward bug-fixing pattern. There is no indication of needing to dive deeply into the broader architecture of the engine or handle complex interactions between systems.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires understanding some code logic and making simple modifications to prevent errors. It is slightly above the lower end of the range due to the need for familiarity with Godot's internal APIs and 3D graphics concepts, but it remains a relatively contained and manageable task for a developer with moderate experience.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Metal: Error compiling compute shader on iPhone A12\nWhen compiling the `particles.glsl` shader for an A12 or earlier device, it fails with the following error:\n\n```\nvalidateComputeFunctionArguments:1083: failed assertion `Compute Function(main0): argument src_particles[0] from buffer(4) with offset(0) and length(16) has space for 16 bytes, but argument has a length(128).'\n```\n\n> [!NOTE]\n>\n> Disabling API validation allows the app to run.\n\nThe issue is that when using classic binding (i.e. not argument buffers), the ABI for the shader passes the structures as arguments to the entry point:\n\n```metal\nstruct ParticleEmission\n{\n    float4x4 xform;\n    packed_float3 velocity;\n    uint flags;\n    float4 color;\n    float4 custom;\n};\n\nstruct SourceEmission\n{\n    int particle_count;\n    uint pad0;\n    uint pad1;\n    uint pad2;\n    ParticleEmission data[1];\n};\n\nkernel void main0(device SourceEmission& src_particles [[buffer(5)]], uint3 gl_GlobalInvocationID [[thread_position_in_grid]])\n{\n// ...\n```\n\nNote that the `src_particles` argument is a `struct SourceEmission`. Note again that this struct has an embedded type `struct ParticleEmission[1]`. Metal doesn't support unsized arrays, but SPRIV-Cross works around it by passing an embedded struct of size `1`. Interestingly, Metal is a variant of C++, and even Godot's definition has to use a sized array for the structure definition:\n\nhttps://github.com/godotengine/godot/blob/2450dee1bc1495daa2b7bdf06c7b3ddfbf8007e1/servers/rendering/renderer_rd/storage_rd/particles_storage.h#L157\n\nThe issue is that when Godot binds an empty emission buffer, it does not need to account for this, so it allocates a size 16:\n\nhttps://github.com/godotengine/godot/blob/d9ef826c545e7d623279c312ca837b947a4989b3/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp#L544\n\n_Originally posted by @TCROC in https://github.com/godotengine/godot/issues/99820#issuecomment-2558697999_\n            \n", "patch": "diff --git a/drivers/metal/metal_objects.mm b/drivers/metal/metal_objects.mm\nindex b44c496e4f6f..04900a0e5162 100644\n--- a/drivers/metal/metal_objects.mm\n+++ b/drivers/metal/metal_objects.mm\n@@ -56,6 +56,10 @@\n \n #import <os/signpost.h>\n \n+// We have to undefine these macros because they are defined in NSObjCRuntime.h.\n+#undef MIN\n+#undef MAX\n+\n void MDCommandBuffer::begin() {\n \tDEV_ASSERT(commandBuffer == nil);\n \tcommandBuffer = queue.commandBufferWithUnretainedReferences;\n@@ -764,6 +768,7 @@\n \t\t[render.encoder setVertexBuffers:render.vertex_buffers.ptr()\n \t\t\t\t\t\t\t\t offsets:render.vertex_offsets.ptr()\n \t\t\t\t\t\t\t   withRange:NSMakeRange(first, p_binding_count)];\n+\t\trender.dirty.clear_flag(RenderState::DIRTY_VERTEX);\n \t} else {\n \t\trender.dirty.set_flag(RenderState::DIRTY_VERTEX);\n \t}\n@@ -1082,7 +1087,7 @@\n \n \tUniformSet const &set = p_shader->sets[index];\n \n-\tfor (uint32_t i = 0; i < uniforms.size(); i++) {\n+\tfor (uint32_t i = 0; i < MIN(uniforms.size(), set.uniforms.size()); i++) {\n \t\tRDD::BoundUniform const &uniform = uniforms[i];\n \t\tUniformInfo ui = set.uniforms[i];\n \ndiff --git a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\nindex 7bd2d75c74a3..2ed4efd1572e 100644\n--- a/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n+++ b/servers/rendering/renderer_rd/storage_rd/particles_storage.cpp\n@@ -541,13 +541,15 @@ void ParticlesStorage::_particles_allocate_emission_buffer(Particles *particles)\n \n void ParticlesStorage::_particles_ensure_unused_emission_buffer(Particles *particles) {\n \tif (particles->unused_emission_storage_buffer.is_null()) {\n-\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\t// For rendering devices that do not support empty arrays (like C++),\n+\t\t// we need to size the buffer with at least 1 element.\n+\t\tparticles->unused_emission_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(ParticleEmissionBuffer));\n \t}\n }\n \n void ParticlesStorage::_particles_ensure_unused_trail_buffer(Particles *particles) {\n \tif (particles->unused_trail_storage_buffer.is_null()) {\n-\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(sizeof(uint32_t) * 4);\n+\t\tparticles->unused_trail_storage_buffer = RD::get_singleton()->storage_buffer_create(16 * sizeof(float)); // Size of mat4.\n \t}\n }\n \n", "instance_id": "godotengine__godot-100766", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: a compilation error occurs when compiling a compute shader on iPhone A12 or earlier devices due to a mismatch in buffer size allocation for a struct with an embedded array. The error message, relevant code snippets, and links to the Godot repository provide context about the root cause (Metal's handling of structs and buffer sizing). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or constraints for the fix (e.g., should the solution work for all Metal devices, or just A12 and earlier?). Additionally, edge cases such as varying struct sizes or zero-element buffers are not mentioned, which could impact the solution. While the issue is well-documented with references to specific lines of code, the lack of explicit requirements for the solution prevents it from being fully comprehensive.\n", "difficulty_explanation": "\nI rate this problem as hard with a difficulty score of 0.65 due to several factors. First, the scope of code changes involves multiple files (`metal_objects.mm` and `particles_storage.cpp`) in the Godot engine, a large and complex codebase. The modifications, while not extensive in terms of lines of code, require a deep understanding of Metal (Apple's graphics and compute API) and its interaction with shader compilation and buffer binding, which are advanced concepts. The changes also impact critical rendering logic, specifically particle emission buffers, which could have downstream effects on performance or behavior if not handled correctly. \n\nFrom a technical perspective, solving this requires knowledge of Metal's ABI (Application Binary Interface) for shaders, struct padding/alignment in C++ and Metal, and how SPIRV-Cross translates shaders. Additionally, the developer must understand Godot's rendering architecture to ensure the buffer sizing fix does not break other parts of the system. The problem also hints at potential edge cases, such as handling empty buffers or varying array sizes in structs, though these are not explicitly detailed. Error handling does not seem to be a major focus of the changes, but ensuring compatibility across different Metal devices adds complexity.\n\nOverall, this problem falls into the \"hard\" category (0.6-0.8) because it demands domain-specific knowledge of graphics programming and Metal, a nuanced understanding of the Godot engine's rendering pipeline, and careful modifications to avoid introducing new bugs. It is not \"very hard\" (0.8-1.0) as it does not involve system-level redesign or extremely intricate logic, but it is beyond medium difficulty due to the specialized knowledge and cross-file impact.\n", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_explanation": "Developers need to have a deep understanding of the detailed functions of the shader of the entire mobile operating system, which involves complex rendering logic functions."}
{"problem_statement": "Can't export project in self-contained mode\n### Tested versions\n\nRegression from #100150\n\n### System information\n\nW10\n\n### Issue description\n\nWhen using portable mode (the `._sc_` thing), exporting project results in:\n```\n  ERROR: Couldn't save project.binary at 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Can't open file from path 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: Cannot remove non-existent file or directory: 'C:/godot_source/bin/editor_data/temp/tmpproject.binary'.\n  ERROR: C:\\godot_source\\editor\\export\\editor_export_platform.h:241 - Save ZIP: Failed to move temporary file \"C:/godot_source/bin/editor_data/temp/packtmp\" to \"C:/Program Files/Godot/BugReports/Repro/.export/project.zip\".\n```\nAlthough after further testing, seems like temp folder is missing for some reason and it's not created automatically. I didn't test if it's a problem in non-portable mode (it would happen with a clean Godot installation).\n\n### Steps to reproduce\n\n1. Enable [self-contained mode](https://docs.godotengine.org/en/stable/tutorials/io/data_paths.html#doc-data-paths-self-contained-mode)\n2. Export project\n3. The exported files are not created\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_paths.cpp b/editor/editor_paths.cpp\nindex 8e9df68f3b70..cd17559ac3dc 100644\n--- a/editor/editor_paths.cpp\n+++ b/editor/editor_paths.cpp\n@@ -237,6 +237,17 @@ EditorPaths::EditorPaths() {\n \t\t}\n \t}\n \n+\t// Temporary dir.\n+\t{\n+\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\tdir->make_dir_recursive(temp_dir);\n+\t\t\tif (dir->change_dir(temp_dir) != OK) {\n+\t\t\t\tERR_PRINT(\"Could not create editor temporary directory: \" + temp_dir);\n+\t\t\t\tpaths_valid = false;\n+\t\t\t}\n+\t\t}\n+\t}\n+\n \t// Validate or create project-specific editor data dir,\n \t// including shader cache subdir.\n \tif (Engine::get_singleton()->is_project_manager_hint() || (Main::is_cmdline_tool() && !ProjectSettings::get_singleton()->is_project_loaded())) {\n", "instance_id": "godotengine__godot-100510", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to export a project in self-contained mode due to missing temporary directories, resulting in specific error messages. It provides context about the environment (Windows 10), the steps to reproduce the issue, and the observed behavior. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, it does not explicitly clarify whether this issue is exclusive to self-contained mode or if it could occur in other configurations beyond a clean installation (as mentioned but not tested). Additionally, there are no explicit mentions of expected behavior beyond \"exported files are not created,\" nor are there detailed constraints or edge cases provided in the description. The lack of a minimal reproduction project (MRP) also slightly hampers clarity for someone trying to replicate the issue from scratch. Overall, while the problem goal is understandable, these minor gaps in detail result in a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single file (`editor_paths.cpp`) and involves a small, focused modification of adding logic to create a temporary directory if it does not exist. The change does not impact multiple modules or the broader system architecture, nor does it require extensive refactoring. The amount of code change is minimal, consisting of just a few lines to handle directory creation and error logging.\n\n2. **Number of Technical Concepts:** The solution requires basic understanding of file system operations in C++ (e.g., directory creation and navigation using the `dir` object) and error handling (printing error messages). No advanced language features, complex algorithms, design patterns, or domain-specific knowledge are necessary. The concepts involved are straightforward for anyone with basic C++ experience.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention specific edge cases beyond the missing temporary directory. The code change addresses the primary issue by ensuring the directory is created, and includes basic error handling if the directory creation or navigation fails. However, potential edge cases like permission issues, disk space constraints, or concurrent access to the directory are not addressed in the problem statement or code change, and they do not seem critical to the immediate fix. The error handling added is minimal and not complex.\n\n4. **Overall Complexity:** The fix is a simple bug resolution that does not require deep understanding of the Godot engine's codebase beyond the specific `EditorPaths` class. It does not involve intricate logic, performance considerations, or interactions with other parts of the system beyond the file system operations.\n\nGiven these factors, a difficulty score of 0.25 is appropriate. It reflects an easy problem that requires understanding a small piece of code logic and making a simple modification to handle a specific failure condition. It is slightly above the \"Very Easy\" range due to the need to understand the context of directory paths in the editor's initialization process, but it remains a straightforward task for a developer with moderate experience in C++.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot will throw errors infinitely when Windows audio driver was once used by another app\n### Tested versions\n\nGodot 4.3 Stable\n\n### System information\n\nWindows 10 x64\n\n### Issue description\n\nWhen another app (like audio or video editing software) uses Windows Audio system, Godot begin to throw errors and will not stop until it will be fully closed and reopened. Even if another app is already closed and is no longer using the driver.\n\n![Image](https://github.com/user-attachments/assets/14b78097-b33d-454a-8e61-bd50e776841b)\n\n\n### Steps to reproduce\n\nOpen Godot\nOpen Vegas Pro or other video editing app at the same time\n\n### Minimal reproduction project (MRP)\n\nN/A (and not required)\n", "patch": "diff --git a/drivers/wasapi/audio_driver_wasapi.cpp b/drivers/wasapi/audio_driver_wasapi.cpp\nindex b5cb8da249af..7d5680699f41 100644\n--- a/drivers/wasapi/audio_driver_wasapi.cpp\n+++ b/drivers/wasapi/audio_driver_wasapi.cpp\n@@ -123,6 +123,8 @@ const IID IID_IAudioCaptureClient = __uuidof(IAudioCaptureClient);\n \n static bool default_output_device_changed = false;\n static bool default_input_device_changed = false;\n+static int output_reinit_countdown = 0;\n+static int input_reinit_countdown = 0;\n \n // Silence warning due to a COM API weirdness (GH-35194).\n #if defined(__GNUC__) && !defined(__clang__)\n@@ -134,6 +136,8 @@ class CMMNotificationClient : public IMMNotificationClient {\n \tLONG _cRef = 1;\n \n public:\n+\tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n+\n \tCMMNotificationClient() {}\n \tvirtual ~CMMNotificationClient() {}\n \n@@ -199,6 +203,9 @@ class CMMNotificationClient : public IMMNotificationClient {\n static CMMNotificationClient notif_client;\n \n Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_input, bool p_reinit, bool p_no_audio_client_3) {\n+\t// This function can be called recursively, so clean up before starting:\n+\taudio_device_finish(p_device);\n+\n \tWAVEFORMATEX *pwfex;\n \tComPtr<IMMDeviceEnumerator> enumerator = nullptr;\n \tComPtr<IMMDevice> output_device = nullptr;\n@@ -225,21 +232,25 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tComPtr<IMMDevice> tmp_device = nullptr;\n \n \t\t\thr = devices->Item(i, &tmp_device);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get devices item.\");\n \n \t\t\tComPtr<IPropertyStore> props = nullptr;\n \t\t\thr = tmp_device->OpenPropertyStore(STGM_READ, &props);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot open property store.\");\n \n \t\t\tPROPVARIANT propvar;\n \t\t\tPropVariantInit(&propvar);\n \n \t\t\thr = props->GetValue(PKEY_Device_FriendlyNameGodot, &propvar);\n-\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\tERR_BREAK_MSG(hr != S_OK, \"Cannot get value.\");\n \n \t\t\tif (p_device->device_name == String(propvar.pwszVal)) {\n \t\t\t\thr = tmp_device->GetId(&strId);\n-\t\t\t\tERR_BREAK(hr != S_OK);\n+\t\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\t\tPropVariantClear(&propvar);\n+\t\t\t\t\tERR_PRINT(\"Cannot get device ID string.\");\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n \n \t\t\t\tfound = true;\n \t\t\t}\n@@ -270,9 +281,14 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n \t}\n \n+\tif (notif_client.enumerator != nullptr) {\n+\t\tnotif_client.enumerator->UnregisterEndpointNotificationCallback(&notif_client);\n+\t\tnotif_client.enumerator = nullptr;\n+\t}\n \thr = enumerator->RegisterEndpointNotificationCallback(&notif_client);\n-\n-\tif (hr != S_OK) {\n+\tif (hr == S_OK) {\n+\t\tnotif_client.enumerator = enumerator;\n+\t} else {\n \t\tERR_PRINT(\"WASAPI: RegisterEndpointNotificationCallback error\");\n \t}\n \n@@ -317,6 +333,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \n \thr = p_device->audio_client->GetMixFormat(&pwfex);\n \tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t// From this point onward, CoTaskMemFree(pwfex) must be called before returning or pwfex will leak!\n \n \tprint_verbose(\"WASAPI: wFormatTag = \" + itos(pwfex->wFormatTag));\n \tprint_verbose(\"WASAPI: nChannels = \" + itos(pwfex->nChannels));\n@@ -340,6 +357,7 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tprint_verbose(\"WASAPI: closest->cbSize = \" + itos(closest->cbSize));\n \n \t\t\tWARN_PRINT(\"WASAPI: Using closest match instead\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tpwfex = closest;\n \t\t}\n \t}\n@@ -359,11 +377,13 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tp_device->format_tag = WAVE_FORMAT_IEEE_FLOAT;\n \t\t} else {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t} else {\n \t\tif (p_device->format_tag != WAVE_FORMAT_PCM && p_device->format_tag != WAVE_FORMAT_IEEE_FLOAT) {\n \t\t\tERR_PRINT(\"WASAPI: Format not supported\");\n+\t\t\tCoTaskMemFree(pwfex);\n \t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n \t\t}\n \t}\n@@ -376,10 +396,28 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t\t\tpwfex->nAvgBytesPerSec = pwfex->nSamplesPerSec * pwfex->nChannels * (pwfex->wBitsPerSample / 8);\n \t\t}\n \t\thr = p_device->audio_client->Initialize(AUDCLNT_SHAREMODE_SHARED, streamflags, p_input ? REFTIMES_PER_SEC : 0, 0, pwfex, nullptr);\n-\t\tERR_FAIL_COND_V_MSG(hr != S_OK, ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\n+\t\tif (p_reinit) {\n+\t\t\t// In case we're trying to re-initialize the device, prevent throwing this error on the console,\n+\t\t\t// otherwise if there is currently no device available this will spam the console.\n+\t\t\tif (hr != S_OK) {\n+\t\t\t\tprint_verbose(\"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\treturn ERR_CANT_OPEN;\n+\t\t\t}\n+\t\t} else {\n+\t\t\tif (unlikely(hr != S_OK)) {\n+\t\t\t\tCoTaskMemFree(pwfex);\n+\t\t\t\tERR_FAIL_V_MSG(ERR_CANT_OPEN, \"WASAPI: Initialize failed with error 0x\" + String::num_uint64(hr, 16) + \".\");\n+\t\t\t}\n+\t\t}\n+\n \t\tUINT32 max_frames;\n \t\thr = p_device->audio_client->GetBufferSize(&max_frames);\n-\t\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\t\tif (unlikely(hr != S_OK)) {\n+\t\t\tCoTaskMemFree(pwfex);\n+\t\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t\t}\n \n \t\t// Due to WASAPI Shared Mode we have no control of the buffer size\n \t\tif (!p_input) {\n@@ -453,7 +491,10 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n \t} else {\n \t\thr = p_device->audio_client->GetService(IID_IAudioRenderClient, (void **)&p_device->render_client);\n \t}\n-\tERR_FAIL_COND_V(hr != S_OK, ERR_CANT_OPEN);\n+\tif (unlikely(hr != S_OK)) {\n+\t\tCoTaskMemFree(pwfex);\n+\t\tERR_FAIL_V(ERR_CANT_OPEN);\n+\t}\n \n \t// Free memory\n \tCoTaskMemFree(pwfex);\n@@ -464,6 +505,11 @@ Error AudioDriverWASAPI::audio_device_init(AudioDeviceWASAPI *p_device, bool p_i\n Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_output, false, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_output_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_output_device error after failed output audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -504,6 +550,11 @@ Error AudioDriverWASAPI::init_output_device(bool p_reinit) {\n Error AudioDriverWASAPI::init_input_device(bool p_reinit) {\n \tError err = audio_device_init(&audio_input, true, p_reinit);\n \tif (err != OK) {\n+\t\t// We've tried to init the device, but have failed. Time to clean up.\n+\t\tError finish_err = finish_input_device();\n+\t\tif (finish_err != OK) {\n+\t\t\tERR_PRINT(\"WASAPI: finish_input_device error after failed input audio_device_init\");\n+\t\t}\n \t\treturn err;\n \t}\n \n@@ -826,9 +877,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t}\n \n \t\tif (!ad->audio_output.audio_client) {\n-\t\t\tError err = ad->init_output_device(true);\n-\t\t\tif (err == OK) {\n-\t\t\t\tad->start();\n+\t\t\tif (output_reinit_countdown < 1) {\n+\t\t\t\tError err = ad->init_output_device(true);\n+\t\t\t\tif (err == OK) {\n+\t\t\t\t\tad->start();\n+\t\t\t\t} else {\n+\t\t\t\t\toutput_reinit_countdown = 1000;\n+\t\t\t\t}\n+\t\t\t} else {\n+\t\t\t\toutput_reinit_countdown--;\n \t\t\t}\n \n \t\t\tavail_frames = 0;\n@@ -899,9 +956,15 @@ void AudioDriverWASAPI::thread_func(void *p_udata) {\n \t\t\t}\n \n \t\t\tif (!ad->audio_input.audio_client) {\n-\t\t\t\tError err = ad->init_input_device(true);\n-\t\t\t\tif (err == OK) {\n-\t\t\t\t\tad->input_start();\n+\t\t\t\tif (input_reinit_countdown < 1) {\n+\t\t\t\t\tError err = ad->init_input_device(true);\n+\t\t\t\t\tif (err == OK) {\n+\t\t\t\t\t\tad->input_start();\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\tinput_reinit_countdown = 1000;\n+\t\t\t\t\t}\n+\t\t\t\t} else {\n+\t\t\t\t\tinput_reinit_countdown--;\n \t\t\t\t}\n \t\t\t}\n \t\t}\n", "instance_id": "godotengine__godot-100116", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Godot throws infinite errors when the Windows audio driver is used by another application, and the errors persist even after the other application is closed. The description includes the tested version (Godot 4.3 Stable), system information (Windows 10 x64), and steps to reproduce the issue, which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the exact nature of the errors (error messages or logs) is not provided beyond a reference to an image, which is inaccessible in this text format. Additionally, there are no specific requirements or expectations for the solution (e.g., desired behavior after the fix), and edge cases or constraints are not explicitly mentioned. While the issue is valid and reproducible, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant but localized to a single file (`audio_driver_wasapi.cpp`), involving modifications to the WASAPI audio driver implementation in Godot. The changes span multiple functions and introduce new logic for reinitialization countdowns and error handling, indicating a moderate amount of code change (around 100+ lines modified). Second, the technical concepts required are complex, including deep knowledge of the Windows Audio Session API (WASAPI), COM programming (e.g., handling `ComPtr`, `IMMDeviceEnumerator`, and error codes like `HRESULT`), and audio driver initialization logic. Understanding the interaction between Godot's audio system and Windows audio drivers is crucial, as is familiarity with the specific error conditions that arise from shared audio resources. Third, the problem involves handling edge cases, such as repeated initialization failures and resource cleanup to prevent memory leaks (e.g., ensuring `CoTaskMemFree` is called appropriately), which adds to the complexity. Finally, while the changes do not impact the broader system architecture, they require a nuanced understanding of the audio driver's behavior under concurrent access by multiple applications, as well as careful error handling to avoid spamming logs or causing further instability. A score of 0.75 reflects the need for specialized knowledge of Windows audio APIs and the intricate error recovery logic required, placing it on the higher end of the \"Hard\" range but not quite at \"Very Hard\" since it does not involve system-wide refactoring or advanced domain-specific algorithms.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GetRandBytes() Hangs on Samsung Galaxy S25 and OnePlus 13\n### Is there an existing issue for this?\n\n- [x] I have searched the existing issues\n\n### Current behaviour\n\nWe have been using Bitcoin Core natively in the Nunchuk Bitcoin wallet, available on both desktop and mobile. On Samsung Galaxy S25 and OnePlus 13 (both running Android 15 with the SM8750-AB Snapdragon 8 Elite 3nm processor), the app fails to initialize due to an issue in `GetRandBytes()`.\n\nThe problem occurs when `GetRandBytes()` calls `GetRNDRRS()`, resulting in an infinite loop without retrieving entropy from the hardware.\n\n```\nuint64_t GetRNDRRS() noexcept\n{\n    uint8_t ok;\n    uint64_t r1;\n    do {\n        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n        if (ok) break;\n        __asm__ volatile(\"yield\");\n    } while (true);\n    return r1;\n}\n```\n\nBuild with: Android NDK 25.1.8937393 & 27.2.12479018\n\nRelated PR: https://github.com/bitcoin/bitcoin/pull/26839\n\nTested on commit: `57b47c47ef0bd36e1c32d709c62998c51dc76f34`\n\n### Expected behaviour\n\n`GetRandBytes()` should return entropy without hanging.\n\n### Steps to reproduce\n\n- Build Bitcoin Core for Android on master or 57b47c47ef0bd36e1c32d709c62998c51dc76f34\n- Call `GetRandBytes`\n- Function gets stuck\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@57b47c47ef0bd36e1c32d709c62998c51dc76f34\n\n### Operating system and version\n\nAndroid 15\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/random.cpp b/src/random.cpp\nindex 5b605e988d0c5..6acbbcc210a15 100644\n--- a/src/random.cpp\n+++ b/src/random.cpp\n@@ -192,11 +192,13 @@ uint64_t GetRdSeed() noexcept\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n \n bool g_rndr_supported = false;\n+bool g_rndrrs_supported = false;\n \n void InitHardwareRand()\n {\n     if (getauxval(AT_HWCAP2) & HWCAP2_RNG) {\n         g_rndr_supported = true;\n+        g_rndrrs_supported = VerifyRNDRRS();\n     }\n }\n \n@@ -204,8 +206,10 @@ void ReportHardwareRand()\n {\n     // This must be done in a separate function, as InitHardwareRand() may be indirectly called\n     // from global constructors, before logging is initialized.\n-    if (g_rndr_supported) {\n+    if (g_rndr_supported && g_rndrrs_supported) {\n         LogPrintf(\"Using RNDR and RNDRRS as additional entropy sources\\n\");\n+    } else if (g_rndr_supported) {\n+        LogPrintf(\"Using RNDR as an additional entropy source\\n\");\n     }\n }\n \n@@ -227,24 +231,43 @@ uint64_t GetRNDR() noexcept\n     return r1;\n }\n \n-/** Read 64 bits of entropy using rndrrs.\n- *\n+// Helper function to retrieve random value using RNDRRS\n+bool GetRNDRRSInternal(uint64_t &r1) noexcept\n+{\n+    uint8_t ok = 0;\n+    __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n+                     : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n+    return ok != 0;\n+}\n+\n+\n+/** Read 64 bits of entropy using RNDRRS.\n  * Must only be called when RNDRRS is supported.\n  */\n uint64_t GetRNDRRS() noexcept\n {\n-    uint8_t ok = 0;\n     uint64_t r1;\n-    do {\n-        // https://developer.arm.com/documentation/ddi0601/2022-12/AArch64-Registers/RNDRRS--Reseeded-Random-Number\n-        __asm__ volatile(\"mrs %0, s3_3_c2_c4_1; cset %w1, ne;\"\n-                         : \"=r\"(r1), \"=r\"(ok)::\"cc\");\n-        if (ok) break;\n+    while (!GetRNDRRSInternal(r1)) {\n         __asm__ volatile(\"yield\");\n-    } while (true);\n+    }\n     return r1;\n }\n \n+/** Verify if RNDRRS is supported and functional.\n+ * Return true if it works within the retry limit.\n+ */\n+bool VerifyRNDRRS() noexcept\n+{\n+    uint64_t test;\n+    for (int retry = 0; retry < 10; ++retry) {\n+        if (GetRNDRRSInternal(test)) {\n+            return true;\n+        }\n+        __asm__ volatile(\"yield\");\n+    }\n+    return false;\n+}\n+\n #else\n /* Access to other hardware random number generators could be added here later,\n  * assuming it is sufficiently fast (in the order of a few hundred CPU cycles).\n@@ -295,7 +318,7 @@ void SeedHardwareSlow(CSHA512& hasher) noexcept {\n         return;\n     }\n #elif defined(__aarch64__) && defined(HWCAP2_RNG)\n-    if (g_rndr_supported) {\n+    if (g_rndrrs_supported) {\n         for (int i = 0; i < 4; ++i) {\n             uint64_t out = GetRNDRRS();\n             hasher.Write((const unsigned char*)&out, sizeof(out));\n", "instance_id": "bitcoin__bitcoin-31826", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: `GetRandBytes()` hangs on specific Android devices (Samsung Galaxy S25 and OnePlus 13) due to an infinite loop in `GetRNDRRS()`. It provides context about the environment (Android 15, specific hardware), the affected function, and the expected behavior (returning entropy without hanging). Steps to reproduce are included, and relevant code snippets are provided. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether this issue occurs consistently or intermittently, nor does it provide detailed logs or debugging output to pinpoint the root cause (e.g., whether the hardware instruction itself fails or if there are other environmental factors). Additionally, edge cases or specific conditions under which the hang occurs are not specified. Overall, while the goal and issue are clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" range due to several factors. First, the clarity and complexity of the problem require understanding low-level hardware interactions (specifically, ARM architecture's RNDRRS instruction for random number generation), which is a niche and advanced topic. The code changes, while localized to a single file (`random.cpp`), involve non-trivial modifications, including adding a verification mechanism for RNDRRS support and adjusting the logic to prevent infinite loops. This requires knowledge of inline assembly, hardware capability flags (e.g., `HWCAP2_RNG`), and the Android NDK build environment.\n\nSecond, the scope of changes, though limited to one file, impacts a critical component of the system (random number generation for cryptographic operations in Bitcoin Core), necessitating careful consideration of security and reliability. The changes also require understanding the interaction between hardware entropy sources and the software stack, which adds to the depth of the problem.\n\nThird, the number of technical concepts involved is significant: inline assembly for ARM, hardware entropy sources (RNDR and RNDRRS), Android-specific hardware behavior, and error handling for hardware failures. These concepts are moderately to highly complex, especially for developers without experience in low-level programming or hardware interactions.\n\nFinally, potential edge cases and error handling are critical here. The problem statement does not explicitly mention edge cases, but the code changes introduce a retry limit to prevent infinite loops, indicating an awareness of hardware failure scenarios. Handling such cases (e.g., fallback mechanisms if RNDRRS consistently fails) adds complexity, as does ensuring that the entropy source remains secure and reliable across different devices and Android versions.\n\nOverall, this problem requires a deep understanding of both the codebase and hardware-specific behavior, along with careful handling of critical system functionality, justifying a difficulty score of 0.65. It is not in the \"Very Hard\" range because the changes are localized and do not involve a complete architectural overhaul or advanced algorithmic design.", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.9, "human_difficulty_explanation": "Experience with low-level programming or hardware interaction is required."}
{"problem_statement": "28.0rc1 synchronizes much slower on Windows\nBitcoin Core 28.0rc1 (both pre-built and self-built binary) on Windows 10 synchronizes much slower than 27.0 after around block 120,000 when blocks stop being almost empty. I'm running with default settings (dbcache=450, pruning disabled).\r\n\r\nTime to synchronize to block 300,000: (measured around 10 runs each, alternating between the versions)\r\n27.0: **695 seconds**\r\n28.0rc1: **2760 seconds**\r\n\r\n![28.0rc1](https://github.com/user-attachments/assets/060a1e18-7f97-4e86-9ba8-5bf867b3510e)\r\n\r\nRunning the Linux pre-built binary in WSL doesn't show the slowdown, so it's probably limited to Windows.\r\n\r\n~~I'm going to bisect this, but that will definitely take me a while. If anyone suspects a commit/PR that I should look at first that might help.~~ I've bisected this down to #28052, for more details see https://github.com/bitcoin/bitcoin/issues/30833#issuecomment-2335184072.\n", "patch": "diff --git a/src/addrdb.cpp b/src/addrdb.cpp\nindex e9838d722291e..b89141c88e324 100644\n--- a/src/addrdb.cpp\n+++ b/src/addrdb.cpp\n@@ -73,7 +73,7 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n         remove(pathTmp);\n         return false;\n     }\n-    if (!FileCommit(fileout.Get())) {\n+    if (!fileout.Commit()) {\n         fileout.fclose();\n         remove(pathTmp);\n         LogError(\"%s: Failed to flush file %s\\n\", __func__, fs::PathToString(pathTmp));\ndiff --git a/src/bench/streams_findbyte.cpp b/src/bench/streams_findbyte.cpp\nindex 5098262e9afa6..004bf8ffc9dc7 100644\n--- a/src/bench/streams_findbyte.cpp\n+++ b/src/bench/streams_findbyte.cpp\n@@ -19,7 +19,7 @@ static void FindByte(benchmark::Bench& bench)\n     uint8_t data[file_size] = {0};\n     data[file_size-1] = 1;\n     file << data;\n-    std::rewind(file.Get());\n+    file.seek(0, SEEK_SET);\n     BufferedFile bf{file, /*nBufSize=*/file_size + 1, /*nRewindIn=*/file_size};\n \n     bench.run([&] {\ndiff --git a/src/index/blockfilterindex.cpp b/src/index/blockfilterindex.cpp\nindex 41bdca9df562a..26de7eee32fc0 100644\n--- a/src/index/blockfilterindex.cpp\n+++ b/src/index/blockfilterindex.cpp\n@@ -151,7 +151,7 @@ bool BlockFilterIndex::CustomCommit(CDBBatch& batch)\n         LogError(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n-    if (!FileCommit(file.Get())) {\n+    if (!file.Commit()) {\n         LogError(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n         return false;\n     }\n@@ -201,11 +201,11 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n             LogPrintf(\"%s: Failed to open filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!TruncateFile(last_file.Get(), pos.nPos)) {\n+        if (!last_file.Truncate(pos.nPos)) {\n             LogPrintf(\"%s: Failed to truncate filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\n-        if (!FileCommit(last_file.Get())) {\n+        if (!last_file.Commit()) {\n             LogPrintf(\"%s: Failed to commit filter file %d\\n\", __func__, pos.nFile);\n             return 0;\n         }\ndiff --git a/src/index/txindex.cpp b/src/index/txindex.cpp\nindex 80f615ed0e77b..425a7f00a0d08 100644\n--- a/src/index/txindex.cpp\n+++ b/src/index/txindex.cpp\n@@ -87,10 +87,7 @@ bool TxIndex::FindTx(const uint256& tx_hash, uint256& block_hash, CTransactionRe\n     CBlockHeader header;\n     try {\n         file >> header;\n-        if (fseek(file.Get(), postx.nTxOffset, SEEK_CUR)) {\n-            LogError(\"%s: fseek(...) failed\\n\", __func__);\n-            return false;\n-        }\n+        file.seek(postx.nTxOffset, SEEK_CUR);\n         file >> TX_WITH_WITNESS(tx);\n     } catch (const std::exception& e) {\n         LogError(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\nindex b40ca0260beee..44c2808c3bd46 100644\n--- a/src/node/blockstorage.cpp\n+++ b/src/node/blockstorage.cpp\n@@ -683,7 +683,7 @@ bool BlockManager::UndoWriteToDisk(const CBlockUndo& blockundo, FlatFilePos& pos\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write undo data\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\n@@ -981,7 +981,7 @@ bool BlockManager::WriteBlockToDisk(const CBlock& block, FlatFilePos& pos) const\n     fileout << GetParams().MessageStart() << nSize;\n \n     // Write block\n-    long fileOutPos = ftell(fileout.Get());\n+    long fileOutPos = fileout.tell();\n     if (fileOutPos < 0) {\n         LogError(\"%s: ftell failed\\n\", __func__);\n         return false;\ndiff --git a/src/node/mempool_persist.cpp b/src/node/mempool_persist.cpp\nindex a265c2e12d15a..ff7de8c64a259 100644\n--- a/src/node/mempool_persist.cpp\n+++ b/src/node/mempool_persist.cpp\n@@ -199,8 +199,8 @@ bool DumpMempool(const CTxMemPool& pool, const fs::path& dump_path, FopenFn mock\n         LogInfo(\"Writing %d unbroadcast transactions to file.\\n\", unbroadcast_txids.size());\n         file << unbroadcast_txids;\n \n-        if (!skip_file_commit && !FileCommit(file.Get()))\n-            throw std::runtime_error(\"FileCommit failed\");\n+        if (!skip_file_commit && !file.Commit())\n+            throw std::runtime_error(\"Commit failed\");\n         file.fclose();\n         if (!RenameOver(dump_path + \".new\", dump_path)) {\n             throw std::runtime_error(\"Rename failed\");\ndiff --git a/src/node/utxo_snapshot.cpp b/src/node/utxo_snapshot.cpp\nindex 976421e455391..7d589c886b824 100644\n--- a/src/node/utxo_snapshot.cpp\n+++ b/src/node/utxo_snapshot.cpp\n@@ -73,9 +73,11 @@ std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path chaindir)\n     }\n     afile >> base_blockhash;\n \n-    if (std::fgetc(afile.Get()) != EOF) {\n+    int64_t position = afile.tell();\n+    afile.seek(0, SEEK_END);\n+    if (position != afile.tell()) {\n         LogPrintf(\"[snapshot] warning: unexpected trailing data in %s\\n\", read_from_str);\n-    } else if (std::ferror(afile.Get())) {\n+    } else if (afile.IsError()) {\n         LogPrintf(\"[snapshot] warning: i/o error reading %s\\n\", read_from_str);\n     }\n     return base_blockhash;\ndiff --git a/src/streams.cpp b/src/streams.cpp\nindex cdd36a86feb17..5f7baf92b9e8e 100644\n--- a/src/streams.cpp\n+++ b/src/streams.cpp\n@@ -4,21 +4,29 @@\n \n #include <span.h>\n #include <streams.h>\n+#include <util/fs_helpers.h>\n \n #include <array>\n \n+AutoFile::AutoFile(std::FILE* file, std::vector<std::byte> data_xor)\n+    : m_file{file}, m_xor{std::move(data_xor)}\n+{\n+    if (!IsNull()) {\n+        auto pos{std::ftell(m_file)};\n+        if (pos >= 0) m_position = pos;\n+    }\n+}\n+\n std::size_t AutoFile::detail_fread(Span<std::byte> dst)\n {\n     if (!m_file) throw std::ios_base::failure(\"AutoFile::read: file handle is nullptr\");\n-    if (m_xor.empty()) {\n-        return std::fread(dst.data(), 1, dst.size(), m_file);\n-    } else {\n-        const auto init_pos{std::ftell(m_file)};\n-        if (init_pos < 0) throw std::ios_base::failure(\"AutoFile::read: ftell failed\");\n-        std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n-        util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n-        return ret;\n+    size_t ret = std::fread(dst.data(), 1, dst.size(), m_file);\n+    if (!m_xor.empty()) {\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::read: position unknown\");\n+        util::Xor(dst.subspan(0, ret), m_xor, *m_position);\n     }\n+    if (m_position.has_value()) *m_position += ret;\n+    return ret;\n }\n \n void AutoFile::seek(int64_t offset, int origin)\n@@ -29,18 +37,23 @@ void AutoFile::seek(int64_t offset, int origin)\n     if (std::fseek(m_file, offset, origin) != 0) {\n         throw std::ios_base::failure(feof() ? \"AutoFile::seek: end of file\" : \"AutoFile::seek: fseek failed\");\n     }\n+    if (origin == SEEK_SET) {\n+        m_position = offset;\n+    } else if (origin == SEEK_CUR && m_position.has_value()) {\n+        *m_position += offset;\n+    } else {\n+        int64_t r{std::ftell(m_file)};\n+        if (r < 0) {\n+            throw std::ios_base::failure(\"AutoFile::seek: ftell failed\");\n+        }\n+        m_position = r;\n+    }\n }\n \n int64_t AutoFile::tell()\n {\n-    if (IsNull()) {\n-        throw std::ios_base::failure(\"AutoFile::tell: file handle is nullptr\");\n-    }\n-    int64_t r{std::ftell(m_file)};\n-    if (r < 0) {\n-        throw std::ios_base::failure(\"AutoFile::tell: ftell failed\");\n-    }\n-    return r;\n+    if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::tell: position unknown\");\n+    return *m_position;\n }\n \n void AutoFile::read(Span<std::byte> dst)\n@@ -60,6 +73,7 @@ void AutoFile::ignore(size_t nSize)\n             throw std::ios_base::failure(feof() ? \"AutoFile::ignore: end of file\" : \"AutoFile::ignore: fread failed\");\n         }\n         nSize -= nNow;\n+        if (m_position.has_value()) *m_position += nNow;\n     }\n }\n \n@@ -70,19 +84,34 @@ void AutoFile::write(Span<const std::byte> src)\n         if (std::fwrite(src.data(), 1, src.size(), m_file) != src.size()) {\n             throw std::ios_base::failure(\"AutoFile::write: write failed\");\n         }\n+        if (m_position.has_value()) *m_position += src.size();\n     } else {\n-        auto current_pos{std::ftell(m_file)};\n-        if (current_pos < 0) throw std::ios_base::failure(\"AutoFile::write: ftell failed\");\n+        if (!m_position.has_value()) throw std::ios_base::failure(\"AutoFile::write: position unknown\");\n         std::array<std::byte, 4096> buf;\n         while (src.size() > 0) {\n             auto buf_now{Span{buf}.first(std::min<size_t>(src.size(), buf.size()))};\n             std::copy(src.begin(), src.begin() + buf_now.size(), buf_now.begin());\n-            util::Xor(buf_now, m_xor, current_pos);\n+            util::Xor(buf_now, m_xor, *m_position);\n             if (std::fwrite(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n                 throw std::ios_base::failure{\"XorFile::write: failed\"};\n             }\n             src = src.subspan(buf_now.size());\n-            current_pos += buf_now.size();\n+            *m_position += buf_now.size();\n         }\n     }\n }\n+\n+bool AutoFile::Commit()\n+{\n+    return ::FileCommit(m_file);\n+}\n+\n+bool AutoFile::IsError()\n+{\n+    return ferror(m_file);\n+}\n+\n+bool AutoFile::Truncate(unsigned size)\n+{\n+    return ::TruncateFile(m_file, size);\n+}\ndiff --git a/src/streams.h b/src/streams.h\nindex c2a9dea2878d1..431a4d77c6ced 100644\n--- a/src/streams.h\n+++ b/src/streams.h\n@@ -390,9 +390,10 @@ class AutoFile\n protected:\n     std::FILE* m_file;\n     std::vector<std::byte> m_xor;\n+    std::optional<int64_t> m_position;\n \n public:\n-    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={}) : m_file{file}, m_xor{std::move(data_xor)} {}\n+    explicit AutoFile(std::FILE* file, std::vector<std::byte> data_xor={});\n \n     ~AutoFile() { fclose(); }\n \n@@ -419,12 +420,6 @@ class AutoFile\n         return ret;\n     }\n \n-    /** Get wrapped FILE* without transfer of ownership.\n-     * @note Ownership of the FILE* will remain with this class. Use this only if the scope of the\n-     * AutoFile outlives use of the passed pointer.\n-     */\n-    std::FILE* Get() const { return m_file; }\n-\n     /** Return true if the wrapped FILE* is nullptr, false otherwise.\n      */\n     bool IsNull() const { return m_file == nullptr; }\n@@ -458,6 +453,10 @@ class AutoFile\n         ::Unserialize(*this, obj);\n         return *this;\n     }\n+\n+    bool Commit();\n+    bool IsError();\n+    bool Truncate(unsigned size);\n };\n \n /** Wrapper around an AutoFile& that implements a ring buffer to\ndiff --git a/src/util/asmap.cpp b/src/util/asmap.cpp\nindex f50cd8a28c12d..04b0673c49b42 100644\n--- a/src/util/asmap.cpp\n+++ b/src/util/asmap.cpp\n@@ -203,10 +203,10 @@ std::vector<bool> DecodeAsmap(fs::path path)\n         LogPrintf(\"Failed to open asmap file from disk\\n\");\n         return bits;\n     }\n-    fseek(filestr, 0, SEEK_END);\n-    int length = ftell(filestr);\n+    file.seek(0, SEEK_END);\n+    int length = file.tell();\n     LogPrintf(\"Opened asmap file %s (%d bytes) from disk\\n\", fs::quoted(fs::PathToString(path)), length);\n-    fseek(filestr, 0, SEEK_SET);\n+    file.seek(0, SEEK_SET);\n     uint8_t cur_byte;\n     for (int i = 0; i < length; ++i) {\n         file >> cur_byte;\n", "instance_id": "bitcoin__bitcoin-30884", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: Bitcoin Core 28.0rc1 synchronizes significantly slower on Windows compared to version 27.0, with specific performance metrics provided (e.g., time to synchronize to block 300,000). It also narrows down the issue to a specific commit/PR (#28052) and notes that the problem is Windows-specific, as Linux builds in WSL do not exhibit the slowdown. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior beyond synchronization speed, nor does it provide detailed context about the root cause or specific components affected (though it references a commit). Additionally, edge cases or specific conditions under which the slowdown occurs (beyond default settings and block 120,000) are not mentioned. While the issue is valid and the goal is implied (fix the performance regression), the lack of deeper technical context or explicit requirements for the solution slightly reduces clarity.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, spanning multiple files (e.g., `streams.cpp`, `addrdb.cpp`, `blockstorage.cpp`, etc.) and involving modifications to core file handling logic in the Bitcoin Core codebase. The changes replace low-level file operations (e.g., `ftell`, `fseek`, `FileCommit`) with a custom abstraction in the `AutoFile` class, which requires understanding the interaction between different modules and ensuring consistency across the system. Second, the technical concepts involved are moderately complex, including file I/O operations, position tracking in streams, XOR-based data handling, and Windows-specific performance considerations. Third, the problem likely involves subtle edge cases, such as file position errors, commit failures, or platform-specific behaviors (e.g., Windows vs. Linux file handling), which are not fully detailed in the problem statement but are evident in the code changes (e.g., error handling for `tell` and `seek`). Finally, the performance regression suggests a need for deep understanding of the codebase architecture and potentially system-level debugging to identify why the abstraction introduced in commit #28052 causes a slowdown on Windows. While not at the extreme end of difficulty (e.g., designing a new consensus protocol), this problem requires significant expertise in C++ file handling, cross-platform development, and performance optimization, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Improve minimum file descriptor accounting and documentation\n#16003 has been closed, and I've pulled out the unrelated p2p change. However I think it's worth someone following up and taking a look at our startup file descriptor accounting. \r\n\r\nAs mentioned in #16003, if `bitcoind` is started somewhere that the maximum number of open file descriptors is limited, we can run into some nonsensical behaviour. Such as a \"negative\" number of maximum connections:\r\n\r\n```bash\r\n# using bash\r\nulimit -n 150\r\nsrc/bitcoind\r\n[init] Using at most -8 automatic connections (150 file descriptors available)\r\n```\r\n\r\nIt's also impossible to shutdown `bitcoind` from this state as the `opencon` thread will never exit.\r\n\r\nIt would be good for someone to look through this code, document assumptions, and fix issues like the above.\r\n\r\nYou do not need to request permission to start working on this. You are encouraged to comment on the issue if you are planning to work on it. This will help other contributors monitor which issues are actively being addressed and is also an effective way to request assistance if and when you need it.\r\n\r\nFor guidance on contributing, please read [CONTRIBUTING.md](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md) before opening your pull request.\r\n\n", "patch": "diff --git a/src/init.cpp b/src/init.cpp\nindex e60feecf108be..3c4b72d3e4ffe 100644\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -147,11 +147,12 @@ static constexpr bool DEFAULT_STOPAFTERBLOCKIMPORT{false};\n // Win32 LevelDB doesn't use filedescriptors, and the ones used for\n // accessing block files don't count towards the fd_set size limit\n // anyway.\n-#define MIN_CORE_FILEDESCRIPTORS 0\n+#define MIN_LEVELDB_FDS 0\n #else\n-#define MIN_CORE_FILEDESCRIPTORS 150\n+#define MIN_LEVELDB_FDS 150\n #endif\n \n+static constexpr int MIN_CORE_FDS = MIN_LEVELDB_FDS + NUM_FDS_MESSAGE_CAPTURE;\n static const char* DEFAULT_ASMAP_FILENAME=\"ip_asn.map\";\n \n /**\n@@ -834,8 +835,7 @@ void InitLogging(const ArgsManager& args)\n namespace { // Variables internal to initialization process only\n \n int nMaxConnections;\n-int nUserMaxConnections;\n-int nFD;\n+int available_fds;\n ServiceFlags nLocalServices = ServiceFlags(NODE_NETWORK_LIMITED | NODE_WITNESS);\n int64_t peer_connect_timeout;\n std::set<BlockFilterType> g_enabled_filter_types;\n@@ -987,27 +987,33 @@ bool AppInitParameterInteraction(const ArgsManager& args)\n         return InitError(Untranslated(\"Cannot set -listen=0 together with -listenonion=1\"));\n     }\n \n-    // Make sure enough file descriptors are available\n-    int nBind = std::max(nUserBind, size_t(1));\n-    nUserMaxConnections = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n-    nMaxConnections = std::max(nUserMaxConnections, 0);\n-\n-    nFD = RaiseFileDescriptorLimit(nMaxConnections + MIN_CORE_FILEDESCRIPTORS + MAX_ADDNODE_CONNECTIONS + nBind + NUM_FDS_MESSAGE_CAPTURE);\n+    // Make sure enough file descriptors are available. We need to reserve enough FDs to account for the bare minimum,\n+    // plus all manual connections and all bound interfaces. Any remainder will be available for connection sockets\n \n-#ifdef USE_POLL\n-    int fd_max = nFD;\n-#else\n-    int fd_max = FD_SETSIZE;\n+    // Number of bound interfaces (we have at least one)\n+    int nBind = std::max(nUserBind, size_t(1));\n+    // Maximum number of connections with other nodes, this accounts for all types of outbounds and inbounds except for manual\n+    int user_max_connection = args.GetIntArg(\"-maxconnections\", DEFAULT_MAX_PEER_CONNECTIONS);\n+    if (user_max_connection < 0) {\n+        return InitError(Untranslated(\"-maxconnections must be greater or equal than zero\"));\n+    }\n+    // Reserve enough FDs to account for the bare minimum, plus any manual connections, plus the bound interfaces\n+    int min_required_fds = MIN_CORE_FDS + MAX_ADDNODE_CONNECTIONS + nBind;\n+\n+    // Try raising the FD limit to what we need (available_fds may be smaller than the requested amount if this fails)\n+    available_fds = RaiseFileDescriptorLimit(user_max_connection + min_required_fds);\n+    // If we are using select instead of poll, our actual limit may be even smaller\n+#ifndef USE_POLL\n+    available_fds = std::min(FD_SETSIZE, available_fds);\n #endif\n+    if (available_fds < min_required_fds)\n+        return InitError(strprintf(_(\"Not enough file descriptors available. %d available, %d required.\"), available_fds, min_required_fds));\n+\n     // Trim requested connection counts, to fit into system limitations\n-    // <int> in std::min<int>(...) to work around FreeBSD compilation issue described in #2695\n-    nMaxConnections = std::max(std::min<int>(nMaxConnections, fd_max - nBind - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE), 0);\n-    if (nFD < MIN_CORE_FILEDESCRIPTORS)\n-        return InitError(_(\"Not enough file descriptors available.\"));\n-    nMaxConnections = std::min(nFD - MIN_CORE_FILEDESCRIPTORS - MAX_ADDNODE_CONNECTIONS - NUM_FDS_MESSAGE_CAPTURE, nMaxConnections);\n+    nMaxConnections = std::min(available_fds - min_required_fds, user_max_connection);\n \n-    if (nMaxConnections < nUserMaxConnections)\n-        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), nUserMaxConnections, nMaxConnections));\n+    if (nMaxConnections < user_max_connection)\n+        InitWarning(strprintf(_(\"Reducing -maxconnections from %d to %d, because of system limitations.\"), user_max_connection, nMaxConnections));\n \n     // ********************************************************* Step 3: parameter-to-internal-flags\n     if (auto result{init::SetLoggingCategories(args)}; !result) return InitError(util::ErrorString(result));\n@@ -1155,7 +1161,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         return false;\n     }\n \n-    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, nFD);\n+    LogPrintf(\"Using at most %i automatic connections (%i file descriptors available)\\n\", nMaxConnections, available_fds);\n \n     // Warn about relative -datadir path.\n     if (args.IsArgSet(\"-datadir\") && !args.GetPathArg(\"-datadir\").is_absolute()) {\n", "instance_id": "bitcoin__bitcoin-30065", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in identifying the issue with file descriptor accounting in the Bitcoin Core software (`bitcoind`), particularly under constrained environments where the maximum number of open file descriptors is limited. It highlights a specific undesirable behavior (negative maximum connections) and mentions the inability to shut down the application in certain states. However, the statement lacks detailed requirements or examples beyond the initial description. For instance, it does not specify expected behavior for edge cases, constraints on file descriptor limits across different platforms, or detailed success criteria for the fix. Additionally, while it suggests documenting assumptions, it does not clarify what specific aspects of the code or behavior need documentation. Despite these minor ambiguities, the goal of improving file descriptor accounting and fixing the mentioned issues is understandable, and the provided code changes align with the described problem.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily within a single file (`init.cpp`), and involves modifications to the logic for calculating and managing file descriptors and maximum connections. However, the changes require a solid understanding of system-level concepts such as file descriptor limits, platform-specific behaviors (e.g., differences between `poll` and `select`), and their impact on a networked application like Bitcoin Core. The problem also demands familiarity with the codebase's initialization process and how different components (e.g., connection handling, logging) interact with file descriptor limits. The code changes introduce error handling for insufficient file descriptors and adjust the logic to prevent negative connection counts, which adds a layer of complexity in ensuring correctness across various system configurations. While the problem does not significantly impact the broader architecture or require extensive cross-module changes, it does involve careful consideration of edge cases (e.g., very low file descriptor limits) and system constraints. Overall, this task requires a moderate level of expertise in systems programming and a good grasp of the Bitcoin Core initialization logic, placing it in the medium difficulty range of 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Re-registered WSL distro profiles do not get auto generated on terminal restart unless state.json is deleted.\n### Windows Terminal version (or Windows build number)\n\nMicrosoft Windows [Version 10.0.19043.1237]\n\n### Other Software\n\nWSL\n\n### Steps to reproduce\n\n- close terminal\r\n- re-register an existing WSL distribution which had an existing profile in WT before\r\n- remove that profile from WT's config\r\n- open terminal\r\n- config file does NOT contain the new distribution's auto-generated profile\n\n### Expected Behavior\n\nAn auto-generated profile for the WSL distro which was registered.\n\n### Actual Behavior\n\nA profile is not added automatically, to make WT add the profile, the state.json file must be deleted, and the terminal must be reopened.\r\n\r\nI'm just blindly guessing but I'm assuming this bug as to do w caching existing profiles in state.json, wt looks at the guid in state.json, assumes thats already generated, and skips trying to generate it again for the config.\r\n\r\nAlso, just for my own curiosity, how are the GUIDs generated for a distro? Is it a uuid v5 with the terminal uuid namespace? I registered a custom distro using `wsl --import` and it gave it a GUID too. A uuid v5 is what i could tell from the source code, but i tried generating some UUID v5s myself using the terminal's runtime namespace and the name of the distro, and the results weren't the same.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 739e0c5e6f8..62e496c1d15 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -457,6 +457,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n         _SetupProfileEventHandling(profile);\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            contentFrame().Navigate(xaml_typename<Editor::Profiles_Base_Orphaned>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n+            const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n+            _breadcrumbs.Append(crumb);\r\n+            profile.CurrentPage(ProfileSubPage::Base);\r\n+            return;\r\n+        }\r\n+\r\n         contentFrame().Navigate(xaml_typename<Editor::Profiles_Base>(), winrt::make<implementation::NavigateToProfileArgs>(profile, *this));\r\n         const auto crumb = winrt::make<Breadcrumb>(box_value(profile), profile.Name(), BreadcrumbSubPage::None);\r\n         _breadcrumbs.Append(crumb);\r\n@@ -621,6 +630,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         _Navigate(profileViewModel, BreadcrumbSubPage::None);\r\n     }\r\n \r\n+    static MUX::Controls::InfoBadge _createGlyphIconBadge(wil::zwstring_view glyph)\r\n+    {\r\n+        MUX::Controls::InfoBadge badge;\r\n+        MUX::Controls::FontIconSource icon;\r\n+        icon.FontFamily(winrt::Windows::UI::Xaml::Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n+        icon.FontSize(12);\r\n+        icon.Glyph(glyph);\r\n+        badge.IconSource(icon);\r\n+        return badge;\r\n+    }\r\n+\r\n     MUX::Controls::NavigationViewItem MainPage::_CreateProfileNavViewItem(const Editor::ProfileViewModel& profile)\r\n     {\r\n         MUX::Controls::NavigationViewItem profileNavItem;\r\n@@ -628,6 +648,15 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         profileNavItem.Tag(box_value<Editor::ProfileViewModel>(profile));\r\n         profileNavItem.Icon(UI::IconPathConverter::IconWUX(profile.EvaluatedIcon()));\r\n \r\n+        if (profile.Orphaned())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xE7BA\") /* Warning Triangle */);\r\n+        }\r\n+        else if (profile.Hidden())\r\n+        {\r\n+            profileNavItem.InfoBadge(_createGlyphIconBadge(L\"\\xED1A\") /* Hide */);\r\n+        }\r\n+\r\n         // Update the menu item when the icon/name changes\r\n         auto weakMenuItem{ make_weak(profileNavItem) };\r\n         profile.PropertyChanged([weakMenuItem](const auto&, const WUX::Data::PropertyChangedEventArgs& args) {\r\n@@ -642,6 +671,10 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n                 {\r\n                     menuItem.Content(box_value(tag.Name()));\r\n                 }\r\n+                else if (args.PropertyName() == L\"Hidden\")\r\n+                {\r\n+                    menuItem.InfoBadge(tag.Hidden() ? _createGlyphIconBadge(L\"\\xED1A\") /* Hide */ : nullptr);\r\n+                }\r\n             }\r\n         });\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\nindex 7d2aed1b744..7d6456886ac 100644\n--- a/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n+++ b/src/cascadia/TerminalSettingsEditor/Microsoft.Terminal.Settings.Editor.vcxproj\n@@ -113,6 +113,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClInclude>\r\n+    <ClInclude Include=\"Profiles_Base_Orphaned.h\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClInclude>\r\n     <ClInclude Include=\"Profiles_Advanced.h\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -176,6 +180,9 @@\n     <Page Include=\"Profiles_Base.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n+    <Page Include=\"Profiles_Base_Orphaned.xaml\">\r\n+      <SubType>Designer</SubType>\r\n+    </Page>\r\n     <Page Include=\"Profiles_Advanced.xaml\">\r\n       <SubType>Designer</SubType>\r\n     </Page>\r\n@@ -269,6 +276,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </ClCompile>\r\n+    <ClCompile Include=\"Profiles_Base_Orphaned.cpp\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </ClCompile>\r\n     <ClCompile Include=\"Profiles_Advanced.cpp\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n@@ -354,6 +365,10 @@\n       <DependentUpon>Profiles_Base.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\n     </Midl>\r\n+    <Midl Include=\"Profiles_Base_Orphaned.idl\">\r\n+      <DependentUpon>Profiles_Base_Orphaned.xaml</DependentUpon>\r\n+      <SubType>Code</SubType>\r\n+    </Midl>\r\n     <Midl Include=\"Profiles_Advanced.idl\">\r\n       <DependentUpon>Profiles_Advanced.xaml</DependentUpon>\r\n       <SubType>Code</SubType>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\nindex 66d8371c3ea..ab927bd890b 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.cpp\n@@ -225,6 +225,11 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         return !IsBaseLayer();\r\n     }\r\n \r\n+    bool ProfileViewModel::Orphaned() const\r\n+    {\r\n+        return _profile.Orphaned();\r\n+    }\r\n+\r\n     Editor::AppearanceViewModel ProfileViewModel::DefaultAppearance()\r\n     {\r\n         return _defaultAppearanceViewModel;\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\nindex c396fe38ec8..0b84a515ead 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.h\n@@ -85,6 +85,8 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         bool AutoMarkPromptsAvailable() const noexcept;\r\n         bool RepositionCursorWithMouseAvailable() const noexcept;\r\n \r\n+        bool Orphaned() const;\r\n+\r\n         til::typed_event<Editor::ProfileViewModel, Editor::DeleteProfileEventArgs> DeleteProfileRequested;\r\n \r\n         VIEW_MODEL_OBSERVABLE_PROPERTY(ProfileSubPage, CurrentPage);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\nindex 9bf20079cba..08f0108a8a9 100644\n--- a/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/ProfileViewModel.idl\n@@ -81,6 +81,7 @@ namespace Microsoft.Terminal.Settings.Editor\n         void CreateUnfocusedAppearance();\r\n         void DeleteUnfocusedAppearance();\r\n \r\n+\tBoolean Orphaned { get; };\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Name);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Guid, Guid);\r\n         OBSERVABLE_PROJECTED_PROFILE_SETTING(String, Source);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\nnew file mode 100644\nindex 00000000000..bc27cc4c2da\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.cpp\n@@ -0,0 +1,50 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#include \"pch.h\"\n+#include \"Profiles_Base_Orphaned.h\"\n+#include \"Profiles_Base_Orphaned.g.cpp\"\n+#include \"ProfileViewModel.h\"\n+\n+#include <LibraryResources.h>\n+#include \"..\\WinRTUtils\\inc\\Utils.h\"\n+\n+using namespace winrt::Windows::UI::Xaml;\n+using namespace winrt::Windows::UI::Xaml::Controls;\n+using namespace winrt::Windows::UI::Xaml::Navigation;\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    Profiles_Base_Orphaned::Profiles_Base_Orphaned()\n+    {\n+        InitializeComponent();\n+        Automation::AutomationProperties::SetName(DeleteButton(), RS_(L\"Profile_DeleteButton/Text\"));\n+    }\n+\n+    void Profiles_Base_Orphaned::OnNavigatedTo(const NavigationEventArgs& e)\n+    {\n+        const auto args = e.Parameter().as<Editor::NavigateToProfileArgs>();\n+        _Profile = args.Profile();\n+\n+        _layoutUpdatedRevoker = LayoutUpdated(winrt::auto_revoke, [this](auto /*s*/, auto /*e*/) {\n+            // This event fires every time the layout changes, but it is always the last one to fire\n+            // in any layout change chain. That gives us great flexibility in finding the right point\n+            // at which to initialize our renderer (and our terminal).\n+            // Any earlier than the last layout update and we may not know the terminal's starting size.\n+\n+            // Only let this succeed once.\n+            _layoutUpdatedRevoker.revoke();\n+\n+            if (_Profile.FocusDeleteButton())\n+            {\n+                DeleteButton().Focus(FocusState::Programmatic);\n+                _Profile.FocusDeleteButton(false);\n+            }\n+        });\n+    }\n+\n+    void Profiles_Base_Orphaned::DeleteConfirmation_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*e*/)\n+    {\n+        winrt::get_self<ProfileViewModel>(_Profile)->DeleteProfile();\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\nnew file mode 100644\nindex 00000000000..3fca070c89e\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.h\n@@ -0,0 +1,30 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+#pragma once\n+\n+#include \"Profiles_Base_Orphaned.g.h\"\n+#include \"ViewModelHelpers.h\"\n+#include \"Utils.h\"\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n+{\n+    struct Profiles_Base_Orphaned : public HasScrollViewer<Profiles_Base_Orphaned>, Profiles_Base_OrphanedT<Profiles_Base_Orphaned>\n+    {\n+    public:\n+        Profiles_Base_Orphaned();\n+\n+        void OnNavigatedTo(const Windows::UI::Xaml::Navigation::NavigationEventArgs& e);\n+        void DeleteConfirmation_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\n+\n+        WINRT_PROPERTY(Editor::ProfileViewModel, Profile, nullptr);\n+\n+    private:\n+        winrt::Windows::UI::Xaml::Controls::SwapChainPanel::LayoutUpdated_revoker _layoutUpdatedRevoker;\n+    };\n+};\n+\n+namespace winrt::Microsoft::Terminal::Settings::Editor::factory_implementation\n+{\n+    BASIC_FACTORY(Profiles_Base_Orphaned);\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\nnew file mode 100644\nindex 00000000000..e0266fd3d8a\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.idl\n@@ -0,0 +1,13 @@\n+// Copyright (c) Microsoft Corporation.\n+// Licensed under the MIT license.\n+\n+import \"ProfileViewModel.idl\";\n+\n+namespace Microsoft.Terminal.Settings.Editor\n+{\n+    [default_interface] runtimeclass Profiles_Base_Orphaned : Windows.UI.Xaml.Controls.Page\n+    {\n+        Profiles_Base_Orphaned();\n+        ProfileViewModel Profile { get; };\n+    }\n+}\ndiff --git a/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\nnew file mode 100644\nindex 00000000000..a21bbf5e85b\n--- /dev/null\n+++ b/src/cascadia/TerminalSettingsEditor/Profiles_Base_Orphaned.xaml\n@@ -0,0 +1,59 @@\n+<!--\r\n+    Copyright (c) Microsoft Corporation. All rights reserved. Licensed under\r\n+    the MIT License. See LICENSE in the project root for license information.\r\n+-->\r\n+<Page x:Class=\"Microsoft.Terminal.Settings.Editor.Profiles_Base_Orphaned\"\r\n+      xmlns=\"http://schemas.microsoft.com/winfx/2006/xaml/presentation\"\r\n+      xmlns:x=\"http://schemas.microsoft.com/winfx/2006/xaml\"\r\n+      xmlns:d=\"http://schemas.microsoft.com/expression/blend/2008\"\r\n+      xmlns:local=\"using:Microsoft.Terminal.Settings.Editor\"\r\n+      xmlns:mc=\"http://schemas.openxmlformats.org/markup-compatibility/2006\"\r\n+      xmlns:model=\"using:Microsoft.Terminal.Settings.Model\"\r\n+      xmlns:mtu=\"using:Microsoft.Terminal.UI\"\r\n+      xmlns:muxc=\"using:Microsoft.UI.Xaml.Controls\"\r\n+      mc:Ignorable=\"d\">\r\n+\r\n+    <Page.Resources>\r\n+        <ResourceDictionary>\r\n+            <ResourceDictionary.MergedDictionaries>\r\n+                <ResourceDictionary Source=\"CommonResources.xaml\" />\r\n+            </ResourceDictionary.MergedDictionaries>\r\n+        </ResourceDictionary>\r\n+    </Page.Resources>\r\n+\r\n+    <StackPanel Style=\"{StaticResource SettingsStackStyle}\">\r\n+        <!--  Delete Button  -->\r\n+        <local:SettingContainer x:Uid=\"Profile_Delete_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <Button x:Name=\"DeleteButton\"\r\n+                        Click=\"DeleteConfirmation_Click\"\r\n+                        Style=\"{StaticResource DeleteButtonStyle}\">\r\n+                    <Button.Content>\r\n+                        <StackPanel Orientation=\"Horizontal\">\r\n+                            <FontIcon FontSize=\"{StaticResource StandardIconSize}\"\r\n+                                      Glyph=\"&#xE74D;\" />\r\n+                            <TextBlock x:Uid=\"Profile_DeleteButton\"\r\n+                                       Margin=\"10,0,0,0\" />\r\n+                        </StackPanel>\r\n+                    </Button.Content>\r\n+                </Button>\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Name\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Name, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+\r\n+        <local:SettingContainer x:Uid=\"Profile_Source_Orphaned\">\r\n+            <local:SettingContainer.Content>\r\n+                <TextBlock FontFamily=\"Segoe UI, Segoe Fluent Icons, Segoe MDL2 Assets\"\r\n+                           Style=\"{StaticResource SettingsPageItemDescriptionStyle}\"\r\n+                           Text=\"{x:Bind Profile.Source, Mode=OneTime}\" />\r\n+            </local:SettingContainer.Content>\r\n+        </local:SettingContainer>\r\n+    </StackPanel>\r\n+</Page>\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 46524ca62d4..86c0ae46144 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -1961,4 +1961,16 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+  <data name=\"Profile_Delete_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Profile no longer detected</value>\r\n+  </data>\r\n+  <data name=\"Profile_Delete_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>This automatically-detected profile appears to have been uninstalled. Changes you have made to it are preserved, but it cannot be used until it has been reinstalled.</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.Header\" xml:space=\"preserve\">\r\n+    <value>Original Source</value>\r\n+  </data>\r\n+  <data name=\"Profile_Source_Orphaned.HelpText\" xml:space=\"preserve\">\r\n+    <value>Indicates the software that originally created this profile.</value>\r\n+  </data>\r\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\nindex 6b412d28b68..eeb3d7cc2e3 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettings.cpp\n@@ -103,7 +103,7 @@ Model::CascadiaSettings CascadiaSettings::Copy() const\n             for (const auto& profile : targetProfiles)\r\n             {\r\n                 allProfiles.emplace_back(*profile);\r\n-                if (!profile->Hidden())\r\n+                if (!profile->Hidden() && !profile->Orphaned())\r\n                 {\r\n                     activeProfiles.emplace_back(*profile);\r\n                 }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 15a6bd153c9..ea9bda76166 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -1226,12 +1226,12 @@ CascadiaSettings::CascadiaSettings(SettingsLoader&& loader) :\n             const auto& parents = profile->Parents();\r\n             if (std::none_of(parents.begin(), parents.end(), [&](const auto& parent) { return parent->Source() == source; }))\r\n             {\r\n-                continue;\r\n+                profile->Orphaned(true);\r\n             }\r\n         }\r\n \r\n         allProfiles.emplace_back(*profile);\r\n-        if (!profile->Hidden())\r\n+        if (!profile->Hidden() && !profile->Orphaned())\r\n         {\r\n             activeProfiles.emplace_back(*profile);\r\n         }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 561a21017fc..88ae6e8590b 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -104,6 +104,7 @@ winrt::com_ptr<Profile> Profile::CopySettings() const\n     const auto defaultAppearance = AppearanceConfig::CopyAppearance(winrt::get_self<AppearanceConfig>(_DefaultAppearance), weakProfile);\r\n \r\n     profile->_Deleted = _Deleted;\r\n+    profile->_Orphaned = _Orphaned;\r\n     profile->_Updates = _Updates;\r\n     profile->_Guid = _Guid;\r\n     profile->_Name = _Name;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.h b/src/cascadia/TerminalSettingsModel/Profile.h\nindex 24fbb7d1f2d..86110c206ea 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.h\n+++ b/src/cascadia/TerminalSettingsModel/Profile.h\n@@ -115,6 +115,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         void Icon(const hstring& value);\r\n \r\n         WINRT_PROPERTY(bool, Deleted, false);\r\n+        WINRT_PROPERTY(bool, Orphaned, false);\r\n         WINRT_PROPERTY(OriginTag, Origin, OriginTag::None);\r\n         WINRT_PROPERTY(guid, Updates);\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.idl b/src/cascadia/TerminalSettingsModel/Profile.idl\nindex b93a52aa797..331fc1345cf 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.idl\n+++ b/src/cascadia/TerminalSettingsModel/Profile.idl\n@@ -41,6 +41,8 @@ namespace Microsoft.Terminal.Settings.Model\n \r\n         // True if the user explicitly removed this Profile from settings.json.\r\n         Boolean Deleted { get; };\r\n+        // True if the user *kept* this Profile, but it disappeared from the system.\r\n+        Boolean Orphaned { get; };\r\n \r\n         // Helper for magically using a commandline for an icon for a profile\r\n         // without an explicit icon.\r\n", "instance_id": "microsoft__terminal-18188", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: re-registered WSL distro profiles are not auto-generated in Windows Terminal upon restart unless the state.json file is deleted. It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, it does not explicitly define what constitutes a \"re-registered\" WSL distribution or provide details on the environment setup beyond the Windows version and WSL mention. Additionally, while the user speculates about caching in state.json, there is no confirmation or detailed explanation of the root cause in the problem statement. Edge cases, such as multiple re-registrations or interactions with other terminal configurations, are not mentioned. Overall, the statement is valid and clear but lacks some depth in constraints and edge case specifications.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files and modules within the Windows Terminal codebase, including UI components (XAML files), view models, and settings management logic. The changes involve adding a new concept of \"orphaned\" profiles, which requires modifications to the profile model, UI navigation, and serialization logic, indicating a moderate-to-high impact on the codebase. Second, the technical concepts involved are relatively complex, requiring knowledge of C++/WinRT, XAML for UI development, and the Windows Terminal's internal architecture for profile management and state persistence. Understanding how profiles are generated, cached, and managed in state.json is non-trivial and likely requires familiarity with the codebase's design patterns and data flow. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest handling scenarios where profiles are no longer detected (orphaned), which introduces the need for robust error handling and state management. This includes ensuring that UI updates and profile deletion logic work seamlessly for such cases. The overall amount of code change is significant, with new files added and existing logic modified across several components. However, it does not reach the \"Very Hard\" category as it does not appear to involve system-level changes, performance optimizations, or highly intricate domain-specific knowledge beyond the terminal's profile system. A score of 0.65 reflects the need for a deep understanding of specific parts of the codebase and the complexity of integrating the new \"orphaned\" profile feature without breaking existing functionality.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal]: Screen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\n### Windows Terminal version\r\n\r\n1.22.2362.0\r\n\r\n### Windows build number\r\n\r\n27695.1000\r\n\r\n### Other Software\r\n\r\nTest Environment:\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\n\r\n### Steps to reproduce\r\n\r\n**Repro steps :**\r\n1.Open Windows Terminal.\r\n2.Navigate to the editor.\r\n3.Turn on Narrator by pressing 'Ctrl + Windows + Enter' keys.\r\n4.Now turn on mark mode by pressing 'Ctrl + Shift + M' keys.\r\n5. Now navigate among words using 'Ctrl + Left/Right' keys.\r\n6.Observe the screen reader narration here.\r\n\r\n**Observation using NVDA and JAWS screen reader:**\r\nSame issue repro with NVDA and JAWS screen reader also.\r\n\r\n**User Experience**\r\nUsers who rely on screen reader may not get the info properly while navigating in mark mode.\r\n \r\n **WCAG Reference Link:**\r\n https://www.w3.org/WAI/WCAG21/Understanding/info-and-relationships\r\n \r\n**Attachment :**\r\n[Screen reader is not announcing full word information while navigating via ctrl + left_right arrow keys.zip](https://github.com/user-attachments/files/16943981/Screen.reader.is.not.announcing.full.word.information.while.navigating.via.ctrl.%2B.left_right.arrow.keys.zip)\r\n\r\n\r\n### Expected Behavior\r\n\r\nScreen reader should narrate complete word information while navigating using ctrl + left/right arrow keys in mark mode.\r\n\r\n### Actual Behavior\r\n\r\nScreen reader is just announcing a single character information while navigating using ctrl + left/right arrow keys in mark mode.\r\nFor example:\r\nFor word \"Microsoft\", screen reader is just announcing as 'M selected' when we navigate using 'Ctrl + Left' arrow key and announces as 't selected' using 'Ctrl + Right' arrow.\n", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex b77cf969f49..1a896e0ced6 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -163,6 +163,7 @@ CBN\n cbt\n Ccc\n CCCBB\n+CCCDDD\n cch\n CCHAR\n CCmd\n@@ -369,6 +370,7 @@ DColor\n dcommon\n DComposition\n dde\n+DDDCCC\n DDESHARE\n DDevice\n DEADCHAR\ndiff --git a/src/buffer/out/Row.cpp b/src/buffer/out/Row.cpp\nindex 7a46215b6fc..63ba83f4cd5 100644\n--- a/src/buffer/out/Row.cpp\n+++ b/src/buffer/out/Row.cpp\n@@ -80,11 +80,12 @@ constexpr OutIt copy_n_small(InIt first, Diff count, OutIt dest)\n     return dest;\r\n }\r\n \r\n-CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept :\r\n+CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t charsLength, til::CoordType currentColumn, til::CoordType columnCount) noexcept :\r\n     _chars{ chars },\r\n     _charOffsets{ charOffsets },\r\n-    _lastCharOffset{ lastCharOffset },\r\n-    _currentColumn{ currentColumn }\r\n+    _charsLength{ charsLength },\r\n+    _currentColumn{ currentColumn },\r\n+    _columnCount{ columnCount }\r\n {\r\n }\r\n \r\n@@ -92,7 +93,7 @@ CharToColumnMapper::CharToColumnMapper(const wchar_t* chars, const uint16_t* cha\n // This function in particular returns the glyph's first column.\r\n til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept\r\n {\r\n-    targetOffset = clamp(targetOffset, 0, _lastCharOffset);\r\n+    targetOffset = clamp(targetOffset, 0, _charsLength);\r\n \r\n     // This code needs to fulfill two conditions on top of the obvious (a forward/backward search):\r\n     // A: We never want to stop on a column that is marked with CharOffsetsTrailer (= \"GetLeadingColumn\").\r\n@@ -130,10 +131,14 @@ til::CoordType CharToColumnMapper::GetLeadingColumnAt(ptrdiff_t targetOffset) no\n til::CoordType CharToColumnMapper::GetTrailingColumnAt(ptrdiff_t offset) noexcept\r\n {\r\n     auto col = GetLeadingColumnAt(offset);\r\n-    // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n-    // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n-    for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+\r\n+    if (col < _columnCount)\r\n     {\r\n+        // This loop is a little redundant with the forward search loop in GetLeadingColumnAt()\r\n+        // but it's realistically not worth caring about this. This code is not a bottleneck.\r\n+        for (; WI_IsFlagSet(_charOffsets[col + 1], CharOffsetsTrailer); ++col)\r\n+        {\r\n+        }\r\n     }\r\n     return col;\r\n }\r\n@@ -1114,6 +1119,9 @@ std::wstring_view ROW::GetText() const noexcept\n     return { _chars.data(), width };\r\n }\r\n \r\n+// Arguments:\r\n+// - columnBegin: inclusive\r\n+// - columnEnd: exclusive\r\n std::wstring_view ROW::GetText(til::CoordType columnBegin, til::CoordType columnEnd) const noexcept\r\n {\r\n     const auto columns = GetReadableColumnCount();\r\n@@ -1219,15 +1227,15 @@ T ROW::_adjustForward(T column) const noexcept\n }\r\n \r\n // Creates a CharToColumnMapper given an offset into _chars.data().\r\n-// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120).\r\n+// In other words, for a 120 column ROW with just ASCII text, the offset should be [0,120].\r\n CharToColumnMapper ROW::_createCharToColumnMapper(ptrdiff_t offset) const noexcept\r\n {\r\n     const auto charsSize = _charSize();\r\n-    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize - 1);\r\n+    const auto lastChar = gsl::narrow_cast<ptrdiff_t>(charsSize);\r\n     // We can sort of guess what column belongs to what offset because BMP glyphs are very common and\r\n     // UTF-16 stores them in 1 char. In other words, usually a ROW will have N chars for N columns.\r\n     const auto guessedColumn = gsl::narrow_cast<til::CoordType>(clamp(offset, 0, _columnCount));\r\n-    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn };\r\n+    return CharToColumnMapper{ _chars.data(), _charOffsets.data(), lastChar, guessedColumn, _columnCount };\r\n }\r\n \r\n const std::optional<ScrollbarData>& ROW::GetScrollbarData() const noexcept\r\ndiff --git a/src/buffer/out/Row.hpp b/src/buffer/out/Row.hpp\nindex d2c19036baf..44156d1b881 100644\n--- a/src/buffer/out/Row.hpp\n+++ b/src/buffer/out/Row.hpp\n@@ -71,7 +71,7 @@ struct RowCopyTextFromState\n // into a ROW's text this class can tell you what cell that pointer belongs to.\r\n struct CharToColumnMapper\r\n {\r\n-    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn) noexcept;\r\n+    CharToColumnMapper(const wchar_t* chars, const uint16_t* charOffsets, ptrdiff_t lastCharOffset, til::CoordType currentColumn, til::CoordType columnCount) noexcept;\r\n \r\n     til::CoordType GetLeadingColumnAt(ptrdiff_t targetOffset) noexcept;\r\n     til::CoordType GetTrailingColumnAt(ptrdiff_t offset) noexcept;\r\n@@ -85,8 +85,9 @@ struct CharToColumnMapper\n \r\n     const wchar_t* _chars;\r\n     const uint16_t* _charOffsets;\r\n-    ptrdiff_t _lastCharOffset;\r\n+    ptrdiff_t _charsLength;\r\n     til::CoordType _currentColumn;\r\n+    til::CoordType _columnCount;\r\n };\r\n \r\n class ROW final\r\ndiff --git a/src/buffer/out/UTextAdapter.cpp b/src/buffer/out/UTextAdapter.cpp\nindex ff0861ce54d..717d97812aa 100644\n--- a/src/buffer/out/UTextAdapter.cpp\n+++ b/src/buffer/out/UTextAdapter.cpp\n@@ -411,16 +411,13 @@ Microsoft::Console::ICU::unique_uregex Microsoft::Console::ICU::CreateRegex(cons\n     return unique_uregex{ re };\r\n }\r\n \r\n-// Returns an inclusive point range given a text start and end position.\r\n+// Returns a half-open [beg,end) range given a text start and end position.\r\n // This function is designed to be used with uregex_start64/uregex_end64.\r\n til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegularExpression* re)\r\n {\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     const auto nativeIndexBeg = uregex_start64(re, 0, &status);\r\n-    auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n-\r\n-    // The parameters are given as a half-open [beg,end) range, but the point_span we return in closed [beg,end].\r\n-    nativeIndexEnd--;\r\n+    const auto nativeIndexEnd = uregex_end64(re, 0, &status);\r\n \r\n     const auto& textBuffer = *static_cast<const TextBuffer*>(ut->context);\r\n     til::point_span ret;\r\n@@ -439,7 +436,7 @@ til::point_span Microsoft::Console::ICU::BufferRangeFromMatch(UText* ut, URegula\n     if (utextAccess(ut, nativeIndexEnd, true))\r\n     {\r\n         const auto y = accessCurrentRow(ut);\r\n-        ret.end.x = textBuffer.GetRowByOffset(y).GetTrailingColumnAtCharOffset(ut->chunkOffset);\r\n+        ret.end.x = textBuffer.GetRowByOffset(y).GetLeadingColumnAtCharOffset(ut->chunkOffset);\r\n         ret.end.y = y;\r\n     }\r\n     else\r\ndiff --git a/src/buffer/out/textBuffer.cpp b/src/buffer/out/textBuffer.cpp\nindex a920854b732..df30a3ffb23 100644\n--- a/src/buffer/out/textBuffer.cpp\n+++ b/src/buffer/out/textBuffer.cpp\n@@ -1118,6 +1118,14 @@ void TextBuffer::TriggerNewTextNotification(const std::wstring_view newText)\n     }\r\n }\r\n \r\n+void TextBuffer::TriggerSelection()\r\n+{\r\n+    if (_isActiveBuffer && _renderer)\r\n+    {\r\n+        _renderer->TriggerSelection();\r\n+    }\r\n+}\r\n+\r\n // Method Description:\r\n // - get delimiter class for buffer cell position\r\n // - used for double click selection and uia word navigation\r\n@@ -1132,6 +1140,213 @@ DelimiterClass TextBuffer::_GetDelimiterClassAt(const til::point pos, const std:\n     return GetRowByOffset(realPos.y).DelimiterClassAt(realPos.x, wordDelimiters);\r\n }\r\n \r\n+til::point TextBuffer::GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos < bufferSize.Origin())\r\n+    {\r\n+        // can't move further back, so return early at origin\r\n+        return bufferSize.Origin();\r\n+    }\r\n+    else if (pos >= limit)\r\n+    {\r\n+        // clamp to limit,\r\n+        // but still do movement\r\n+        pos = limit;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     CCC___|   -->   |CCC___  CCC|___\r\n+    //     DDD___|   -->   |DDD___  DDD|___\r\n+    //     ___CCC|   -->   ___|CCC  ___|CCC\r\n+    //     DDDCCC|   -->   DDD|CCC  DDD|CCC\r\n+    //     ___DDD|   -->   ___|DDD  ___|DDD\r\n+    //     CCCDDD|   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the beginning of the delimiter class run\r\n+    // 2. (includeWhitespace) if we were on a ControlChar, go back one more delimiter class run\r\n+    const auto initialDelimiter = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.Left())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the left boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+    else if (initialDelimiter == DelimiterClass::ControlChar)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+        pos = _GetDelimiterClassRunStart(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+til::point TextBuffer::GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize{ GetSize() };\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // can't move further forward,\r\n+        // so return early at limit\r\n+        return limit;\r\n+    }\r\n+    else if (const auto origin{ bufferSize.Origin() }; pos < origin)\r\n+    {\r\n+        // clamp to origin,\r\n+        // but still do movement\r\n+        pos = origin;\r\n+    }\r\n+\r\n+    // Consider the delimiter classes represented as these chars:\r\n+    // - ControlChar:   \"_\"\r\n+    // - DelimiterChar: \"D\"\r\n+    // - RegularChar:   \"C\"\r\n+    // Expected results (\"|\" is the position):\r\n+    //   includeWhitespace: true     false\r\n+    //     |CCC___   -->   CCC___|  CCC|___\r\n+    //     |DDD___   -->   DDD___|  DDD|___\r\n+    //     |___CCC   -->   ___|CCC  ___|CCC\r\n+    //     |DDDCCC   -->   DDD|CCC  DDD|CCC\r\n+    //     |___DDD   -->   ___|DDD  ___|DDD\r\n+    //     |CCCDDD   -->   CCC|DDD  CCC|DDD\r\n+    // So the heuristic we use is:\r\n+    // 1. move to the end of the delimiter class run\r\n+    // 2. (includeWhitespace) if the next delimiter class run is a ControlChar, go forward one more delimiter class run\r\n+    pos = _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    if (!includeWhitespace || pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // Special case:\r\n+        // we're at the right boundary (and end of a delimiter class run),\r\n+        // we already know we can't wrap, so return early\r\n+        return pos;\r\n+    }\r\n+\r\n+    if (const auto nextDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+        nextDelimClass == DelimiterClass::ControlChar)\r\n+    {\r\n+        return _GetDelimiterClassRunEnd(pos, wordDelimiters);\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+bool TextBuffer::IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    if (!bufferSize.IsInExclusiveBounds(pos))\r\n+    {\r\n+        // not in bounds\r\n+        return false;\r\n+    }\r\n+\r\n+    // buffer boundaries are always word boundaries\r\n+    if (pos == bufferSize.Origin() || pos == bufferSize.BottomInclusiveRightExclusive())\r\n+    {\r\n+        return true;\r\n+    }\r\n+\r\n+    // at beginning of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.Left())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y - 1);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // at end of the row, but we didn't wrap\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        const auto& row = GetRowByOffset(pos.y);\r\n+        if (!row.WasWrapForced())\r\n+        {\r\n+            return true;\r\n+        }\r\n+    }\r\n+\r\n+    // we can treat text as contiguous,\r\n+    // use DecrementInBounds (not exclusive) here\r\n+    auto prevPos = pos;\r\n+    bufferSize.DecrementInBounds(prevPos);\r\n+    const auto prevDelimiterClass = _GetDelimiterClassAt(prevPos, wordDelimiters);\r\n+\r\n+    // if we changed delimiter class\r\n+    // and the current delimiter class is not a control char,\r\n+    // we're at a word boundary\r\n+    const auto currentDelimiterClass = _GetDelimiterClassAt(pos, wordDelimiters);\r\n+    return prevDelimiterClass != currentDelimiterClass && currentDelimiterClass != DelimiterClass::ControlChar;\r\n+}\r\n+\r\n+til::point TextBuffer::_GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.Origin(); pos = nextPos)\r\n+    {\r\n+        bufferSize.DecrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.RightExclusive())\r\n+        {\r\n+            // wrapped onto previous line,\r\n+            // check if it was forced to wrap\r\n+            const auto& row = GetRowByOffset(nextPos.y);\r\n+            if (!row.WasWrapForced())\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (_GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class, we're done (don't apply move)\r\n+            return pos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n+// Method Description:\r\n+// - Get the exclusive position for the end of the current delimiter class run\r\n+// Arguments:\r\n+// - pos - the buffer position being within the current delimiter class\r\n+// - wordDelimiters - what characters are we considering for the separation of words\r\n+til::point TextBuffer::_GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto initialDelimClass = bufferSize.IsInBounds(pos) ? _GetDelimiterClassAt(pos, wordDelimiters) : DelimiterClass::ControlChar;\r\n+    for (auto nextPos = pos; nextPos != bufferSize.BottomInclusiveRightExclusive(); pos = nextPos)\r\n+    {\r\n+        bufferSize.IncrementInExclusiveBounds(nextPos);\r\n+\r\n+        if (nextPos.x == bufferSize.Left())\r\n+        {\r\n+            // wrapped onto next line,\r\n+            // check if it was forced to wrap or switched delimiter class\r\n+            const auto& row = GetRowByOffset(pos.y);\r\n+            if (!row.WasWrapForced() || _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+            {\r\n+                return pos;\r\n+            }\r\n+        }\r\n+        else if (bufferSize.IsInBounds(nextPos) && _GetDelimiterClassAt(nextPos, wordDelimiters) != initialDelimClass)\r\n+        {\r\n+            // if we changed delim class,\r\n+            // apply the move and return\r\n+            return nextPos;\r\n+        }\r\n+    }\r\n+    return pos;\r\n+}\r\n+\r\n // Method Description:\r\n // - Get the til::point for the beginning of the word you are on\r\n // Arguments:\r\n@@ -1520,13 +1735,14 @@ til::point TextBuffer::GetGlyphStart(const til::point pos, std::optional<til::po\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    // limit is exclusive, so we need to move back to be within valid bounds\r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    // if we're on a trailing byte, move to the leading byte\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n         bufferSize.DecrementInBounds(resultPos, true);\r\n     }\r\n@@ -1548,12 +1764,13 @@ til::point TextBuffer::GetGlyphEnd(const til::point pos, bool accessibilityMode,\n     const auto limit{ limitOptional.value_or(bufferSize.EndExclusive()) };\r\n \r\n     // Clamp pos to limit\r\n-    if (bufferSize.CompareInBounds(resultPos, limit, true) > 0)\r\n+    if (resultPos > limit)\r\n     {\r\n-        resultPos = limit;\r\n+        return limit;\r\n     }\r\n \r\n-    if (resultPos != limit && GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(resultPos) &&\r\n+        GetCellDataAt(resultPos)->DbcsAttr() == DbcsAttribute::Leading)\r\n     {\r\n         bufferSize.IncrementInBounds(resultPos, true);\r\n     }\r\n@@ -1610,6 +1827,31 @@ bool TextBuffer::MoveToNextGlyph(til::point& pos, bool allowExclusiveEnd, std::o\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move forward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.IncrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Update pos to be the beginning of the previous glyph/character. This is used for accessibility\r\n // Arguments:\r\n@@ -1642,6 +1884,31 @@ bool TextBuffer::MoveToPreviousGlyph(til::point& pos, std::optional<til::point>\n     return success;\r\n }\r\n \r\n+bool TextBuffer::MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional) const\r\n+{\r\n+    const auto bufferSize = GetSize();\r\n+    const auto limit{ limitOptional.value_or(bufferSize.BottomInclusiveRightExclusive()) };\r\n+\r\n+    if (pos >= limit)\r\n+    {\r\n+        // Corner Case: we're on/past the limit\r\n+        // Clamp us to the limit\r\n+        pos = limit;\r\n+        return false;\r\n+    }\r\n+\r\n+    // Try to move backward, but if we hit the buffer boundary, we fail to move.\r\n+    const bool success = bufferSize.DecrementInExclusiveBounds(pos);\r\n+    if (success &&\r\n+        bufferSize.IsInBounds(pos) &&\r\n+        GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // Move again if we're on a wide glyph\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+    return success;\r\n+}\r\n+\r\n // Method Description:\r\n // - Determines the line-by-line rectangles based on two COORDs\r\n // - expands the rectangles to support wide glyphs\r\n@@ -1660,12 +1927,10 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n {\r\n     std::vector<til::inclusive_rect> textRects;\r\n \r\n-    const auto bufferSize = GetSize();\r\n-\r\n     // (0,0) is the top-left of the screen\r\n     // the physically \"higher\" coordinate is closer to the top-left\r\n     // the physically \"lower\" coordinate is closer to the bottom-right\r\n-    const auto [higherCoord, lowerCoord] = bufferSize.CompareInBounds(start, end) <= 0 ?\r\n+    const auto [higherCoord, lowerCoord] = start <= end ?\r\n                                                std::make_tuple(start, end) :\r\n                                                std::make_tuple(end, start);\r\n \r\n@@ -1686,6 +1951,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n         }\r\n         else\r\n         {\r\n+            const auto bufferSize = GetSize();\r\n             textRow.left = (row == higherCoord.y) ? higherCoord.x : bufferSize.Left();\r\n             textRow.right = (row == lowerCoord.y) ? lowerCoord.x : bufferSize.RightInclusive();\r\n         }\r\n@@ -1710,7 +1976,7 @@ const std::vector<til::inclusive_rect> TextBuffer::GetTextRects(til::point start\n // - Else if a blockSelection, returns spans corresponding to each line in the block selection\r\n // Arguments:\r\n // - start: beginning of the text region of interest (inclusive)\r\n-// - end: the other end of the text region of interest (inclusive)\r\n+// - end: the other end of the text region of interest (exclusive)\r\n // - blockSelection: when enabled, get spans for each line covered by the block\r\n // - bufferCoordinates: when enabled, treat the coordinates as relative to\r\n //                      the buffer rather than the screen.\r\n@@ -1780,31 +2046,17 @@ void TextBuffer::_ExpandTextRow(til::inclusive_rect& textRow) const\n \r\n     // expand left side of rect\r\n     til::point targetPoint{ textRow.left, textRow.top };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.Left())\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.DecrementInExclusiveBounds(targetPoint);\r\n         textRow.left = targetPoint.x;\r\n     }\r\n \r\n     // expand right side of rect\r\n     targetPoint = { textRow.right, textRow.bottom };\r\n-    if (GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Leading)\r\n+    if (bufferSize.IsInBounds(targetPoint) && GetCellDataAt(targetPoint)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        if (targetPoint.x == bufferSize.RightInclusive())\r\n-        {\r\n-            bufferSize.DecrementInBounds(targetPoint);\r\n-        }\r\n-        else\r\n-        {\r\n-            bufferSize.IncrementInBounds(targetPoint);\r\n-        }\r\n+        bufferSize.IncrementInExclusiveBounds(targetPoint);\r\n         textRow.right = targetPoint.x;\r\n     }\r\n }\r\n@@ -1821,8 +2073,8 @@ size_t TextBuffer::SpanLength(const til::point coordStart, const til::point coor\n // - Retrieves the plain text data between the specified coordinates.\r\n // Arguments:\r\n // - trimTrailingWhitespace - remove the trailing whitespace at the end of the result.\r\n-// - start - where to start getting text (should be at or prior to \"end\")\r\n-// - end - where to end getting text\r\n+// - start - where to start getting text (should be at or prior to \"end\") (inclusive)\r\n+// - end - where to end getting text (exclusive)\r\n // Return Value:\r\n // - Just the text.\r\n std::wstring TextBuffer::GetPlainText(const til::point start, const til::point end) const\r\n@@ -1851,7 +2103,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto maxX = req.bufferCoordinates ? req.maxX : ScreenToBufferLineInclusive(til::point{ req.maxX, iRow }, lineRendition).x;\r\n \r\n         rowBeg = minX;\r\n-        rowEnd = maxX + 1; // +1 to get an exclusive end\r\n+        rowEnd = maxX;\r\n     }\r\n     else\r\n     {\r\n@@ -1860,7 +2112,7 @@ std::tuple<til::CoordType, til::CoordType, bool> TextBuffer::_RowCopyHelper(cons\n         const auto end = req.bufferCoordinates ? req.end : ScreenToBufferLineInclusive(req.end, lineRendition);\r\n \r\n         rowBeg = iRow != beg.y ? 0 : beg.x;\r\n-        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x + 1; // +1 to get an exclusive end\r\n+        rowEnd = iRow != end.y ? row.GetReadableColumnCount() : end.x;\r\n     }\r\n \r\n     // Our selection mechanism doesn't stick to glyph boundaries at the moment.\r\n@@ -1905,7 +2157,7 @@ std::wstring TextBuffer::GetPlainText(const CopyRequest& req) const\n         const auto& row = GetRowByOffset(iRow);\r\n         const auto& [rowBeg, rowEnd, addLineBreak] = _RowCopyHelper(req, iRow, row);\r\n \r\n-        // save selected text\r\n+        // save selected text (exclusive end)\r\n         selectedText += row.GetText(rowBeg, rowEnd);\r\n \r\n         if (addLineBreak && iRow != req.end.y)\r\ndiff --git a/src/buffer/out/textBuffer.hpp b/src/buffer/out/textBuffer.hpp\nindex c97de9e7523..775417caab0 100644\n--- a/src/buffer/out/textBuffer.hpp\n+++ b/src/buffer/out/textBuffer.hpp\n@@ -170,9 +170,15 @@ class TextBuffer final\n     void TriggerScroll();\r\n     void TriggerScroll(const til::point delta);\r\n     void TriggerNewTextNotification(const std::wstring_view newText);\r\n+    void TriggerSelection();\r\n \r\n     til::point GetWordStart(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     til::point GetWordEnd(const til::point target, const std::wstring_view wordDelimiters, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    til::point GetWordStart2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    til::point GetWordEnd2(til::point pos, const std::wstring_view wordDelimiters, bool includeWhitespace, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+\r\n+    bool IsWordBoundary(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n     bool MoveToNextWord(til::point& pos, const std::wstring_view wordDelimiters, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousWord(til::point& pos, const std::wstring_view wordDelimiters) const;\r\n \r\n@@ -180,6 +186,8 @@ class TextBuffer final\n     til::point GetGlyphEnd(const til::point pos, bool accessibilityMode = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToNextGlyph(til::point& pos, bool allowBottomExclusive = false, std::optional<til::point> limitOptional = std::nullopt) const;\r\n     bool MoveToPreviousGlyph(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToNextGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n+    bool MoveToPreviousGlyph2(til::point& pos, std::optional<til::point> limitOptional = std::nullopt) const;\r\n \r\n     const std::vector<til::inclusive_rect> GetTextRects(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n     std::vector<til::point_span> GetTextSpans(til::point start, til::point end, bool blockSelection, bool bufferCoordinates) const;\r\n@@ -322,6 +330,8 @@ class TextBuffer final\n     void _SetFirstRowIndex(const til::CoordType FirstRowIndex) noexcept;\r\n     void _ExpandTextRow(til::inclusive_rect& selectionRow) const;\r\n     DelimiterClass _GetDelimiterClassAt(const til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunStart(til::point pos, const std::wstring_view wordDelimiters) const;\r\n+    til::point _GetDelimiterClassRunEnd(til::point pos, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForAccessibility(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordStartForSelection(const til::point target, const std::wstring_view wordDelimiters) const;\r\n     til::point _GetWordEndForAccessibility(const til::point target, const std::wstring_view wordDelimiters, const til::point limit) const;\r\ndiff --git a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\nindex be9e941c757..81974fe83ab 100644\n--- a/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n+++ b/src/buffer/out/ut_textbuffer/UTextAdapterTests.cpp\n@@ -49,15 +49,15 @@ class UTextAdapterTests\n             return { { beg, 0 }, { end, 0 } };\r\n         };\r\n \r\n-        auto expected = std::vector{ s(0, 2), s(8, 10) };\r\n+        auto expected = std::vector{ s(0, 3), s(8, 11) };\r\n         auto actual = buffer.SearchText(L\"abc\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(5, 5) };\r\n+        expected = std::vector{ s(5, 6) };\r\n         actual = buffer.SearchText(L\"𝒷\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n \r\n-        expected = std::vector{ s(12, 15) };\r\n+        expected = std::vector{ s(12, 16) };\r\n         actual = buffer.SearchText(L\"ネコ\", SearchFlag::None);\r\n         VERIFY_ARE_EQUAL(expected, actual);\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex b46da5236af..72a8e85ad55 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1200,7 +1200,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n \r\n         const auto bufferSize{ _terminal->GetTextBuffer().GetSize() };\r\n         info.StartAtLeftBoundary = _terminal->GetSelectionAnchor().x == bufferSize.Left();\r\n-        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightInclusive();\r\n+        info.EndAtRightBoundary = _terminal->GetSelectionEnd().x == bufferSize.RightExclusive();\r\n         return info;\r\n     }\r\n \r\n@@ -1217,8 +1217,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n+        // clamp the converted position to be within the viewport bounds\r\n+        // x: allow range of [0, RightExclusive]\r\n+        // GH #18106: right exclusive needed for selection to support exclusive end\r\n         til::point terminalPosition{\r\n-            std::clamp(position.x, 0, _terminal->GetViewport().Width() - 1),\r\n+            std::clamp(position.x, 0, _terminal->GetViewport().Width()),\r\n             std::clamp(position.y, 0, _terminal->GetViewport().Height() - 1)\r\n         };\r\n \r\n@@ -2722,7 +2725,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bufferSize.DecrementInBounds(inclusiveEnd);\r\n \r\n         _terminal->SelectNewRegion(s.start, inclusiveEnd);\r\n-        _renderer->TriggerSelection();\r\n     }\r\n \r\n     void ControlCore::SelectCommand(const bool goUp)\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.cpp b/src/cascadia/TerminalControl/ControlInteractivity.cpp\nindex 1da3b89ab1d..f4c0feed2a3 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.cpp\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.cpp\n@@ -241,7 +241,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                               const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                               const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         const auto altEnabled = modifiers.IsAltPressed();\r\n         const auto shiftEnabled = modifiers.IsShiftPressed();\r\n@@ -338,7 +338,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                             const Core::Point pixelPosition,\r\n                                             const bool pointerPressedInBounds)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n         // Returning true from this function indicates that the caller should do no further processing of this movement.\r\n         bool handledCompletely = false;\r\n \r\n@@ -372,7 +372,19 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // _touchdown_ point here. We want to start the selection\r\n                     // from where the user initially clicked, not where they are\r\n                     // now.\r\n-                    _core->SetSelectionAnchor(_getTerminalPosition(til::point{ touchdownPoint }));\r\n+                    auto termPos = _getTerminalPosition(til::point{ touchdownPoint }, false);\r\n+                    if (dx < 0)\r\n+                    {\r\n+                        // _getTerminalPosition(_, false) will floor the x-value,\r\n+                        //   meaning that the selection will start on the left-side\r\n+                        //   of the current cell. This is great if the use is dragging\r\n+                        //   towards the right.\r\n+                        // If the user is dragging towards the left (dx < 0),\r\n+                        //   we want to select the current cell, so place the anchor on the right\r\n+                        //   side of the current cell.\r\n+                        termPos.x++;\r\n+                    }\r\n+                    _core->SetSelectionAnchor(termPos);\r\n \r\n                     // stop tracking the touchdown point\r\n                     _singleClickTouchdownPos = std::nullopt;\r\n@@ -428,7 +440,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                                const ::Microsoft::Terminal::Core::ControlKeyStates modifiers,\r\n                                                const Core::Point pixelPosition)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, false);\r\n         // Short-circuit isReadOnly check to avoid warning dialog\r\n         if (!_core->IsInReadOnlyMode() && _canSendVTMouseInput(modifiers))\r\n         {\r\n@@ -475,7 +487,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                                           const Core::Point pixelPosition,\r\n                                           const Control::MouseButtonState buttonState)\r\n     {\r\n-        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition });\r\n+        const auto terminalPosition = _getTerminalPosition(til::point{ pixelPosition }, true);\r\n \r\n         // Short-circuit isReadOnly check to avoid warning dialog.\r\n         //\r\n@@ -662,7 +674,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - cursorPosition: in pixels, relative to the origin of the control\r\n     void ControlInteractivity::SetEndSelectionPoint(const Core::Point pixelPosition)\r\n     {\r\n-        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }));\r\n+        _core->SetEndSelectionPoint(_getTerminalPosition(til::point{ pixelPosition }, true));\r\n         _selectionNeedsToBeCopied = true;\r\n     }\r\n \r\n@@ -672,12 +684,22 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Arguments:\r\n     // - pixelPosition: the (x,y) position of a given point (i.e.: mouse cursor).\r\n     //    NOTE: origin (0,0) is top-left.\r\n+    // - roundToNearestCell: if true, round the x-value. Otherwise, floor it (standard int division)\r\n     // Return Value:\r\n     // - the corresponding viewport terminal position for the given Point parameter\r\n-    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition)\r\n+    til::point ControlInteractivity::_getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell)\r\n     {\r\n         // Get the size of the font, which is in pixels\r\n-        const til::size fontSize{ _core->GetFont().GetSize() };\r\n+        const auto fontSize{ _core->GetFont().GetSize() };\r\n+\r\n+        if (roundToNearestCell)\r\n+        {\r\n+            // GH#5099: round the x-value to the nearest cell\r\n+            til::point result;\r\n+            result.x = gsl::narrow_cast<til::CoordType>(std::round(gsl::narrow_cast<double>(pixelPosition.x) / fontSize.width));\r\n+            result.y = pixelPosition.y / fontSize.height;\r\n+            return result;\r\n+        }\r\n         // Convert the location in pixels to characters within the current viewport.\r\n         return pixelPosition / fontSize;\r\n     }\r\ndiff --git a/src/cascadia/TerminalControl/ControlInteractivity.h b/src/cascadia/TerminalControl/ControlInteractivity.h\nindex 18d55b53cfa..dcf2c811d02 100644\n--- a/src/cascadia/TerminalControl/ControlInteractivity.h\n+++ b/src/cascadia/TerminalControl/ControlInteractivity.h\n@@ -155,7 +155,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         bool _canSendVTMouseInput(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers);\r\n         bool _shouldSendAlternateScroll(const ::Microsoft::Terminal::Core::ControlKeyStates modifiers, const int32_t delta);\r\n \r\n-        til::point _getTerminalPosition(const til::point pixelPosition);\r\n+        til::point _getTerminalPosition(const til::point pixelPosition, bool roundToNearestCell);\r\n \r\n         bool _sendMouseEventHelper(const til::point terminalPosition,\r\n                                    const unsigned int pointerUpdateKind,\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex 67a1523e99b..9e6350df044 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -478,7 +478,7 @@ bool Terminal::ShouldSendAlternateScroll(const unsigned int uiButton,\n // - The position relative to the viewport\r\n std::wstring Terminal::GetHyperlinkAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos));\r\n+    return GetHyperlinkAtBufferPosition(_ConvertToBufferCell(viewportPos, false));\r\n }\r\n \r\n std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\r\n@@ -502,12 +502,8 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n         result = GetHyperlinkIntervalFromViewportPosition(viewportPos);\r\n         if (result.has_value())\r\n         {\r\n-            // GetPlainText and _ConvertToBufferCell work with inclusive coordinates, but interval's\r\n-            // stop point is (horizontally) exclusive, so let's just update it.\r\n-            result->stop.x--;\r\n-\r\n-            result->start = _ConvertToBufferCell(result->start);\r\n-            result->stop = _ConvertToBufferCell(result->stop);\r\n+            result->start = _ConvertToBufferCell(result->start, false);\r\n+            result->stop = _ConvertToBufferCell(result->stop, true);\r\n         }\r\n     }\r\n     else\r\n@@ -544,7 +540,7 @@ std::wstring Terminal::GetHyperlinkAtBufferPosition(const til::point bufferPos)\n // - The hyperlink ID\r\n uint16_t Terminal::GetHyperlinkIdAtViewportPosition(const til::point viewportPos)\r\n {\r\n-    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos))->TextAttr().GetHyperlinkId();\r\n+    return _activeBuffer().GetCellDataAt(_ConvertToBufferCell(viewportPos, false))->TextAttr().GetHyperlinkId();\r\n }\r\n \r\n // Method description:\r\n@@ -1466,7 +1462,6 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n                 // PointTree uses half-open ranges and viewport-relative coordinates.\r\n                 range.start.y -= beg;\r\n                 range.end.y -= beg;\r\n-                range.end.x++;\r\n                 intervals.push_back(PointTree::interval(range.start, range.end, 0));\r\n             } while (uregex_findNext(re.get(), &status));\r\n         }\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex 0ff2cb1955e..1459c39fc3c 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -478,7 +478,7 @@ class Microsoft::Terminal::Core::Terminal final :\n     std::vector<til::point_span> _GetSelectionSpans() const noexcept;\r\n     std::pair<til::point, til::point> _PivotSelection(const til::point targetPos, bool& targetStart) const noexcept;\r\n     std::pair<til::point, til::point> _ExpandSelectionAnchors(std::pair<til::point, til::point> anchors) const;\r\n-    til::point _ConvertToBufferCell(const til::point viewportPos) const;\r\n+    til::point _ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const;\r\n     void _ScrollToPoint(const til::point pos);\r\n     void _MoveByChar(SelectionDirection direction, til::point& pos);\r\n     void _MoveByWord(SelectionDirection direction, til::point& pos);\r\ndiff --git a/src/cascadia/TerminalCore/TerminalSelection.cpp b/src/cascadia/TerminalCore/TerminalSelection.cpp\nindex 6a800f329dd..9501f64a85e 100644\n--- a/src/cascadia/TerminalCore/TerminalSelection.cpp\n+++ b/src/cascadia/TerminalCore/TerminalSelection.cpp\n@@ -93,14 +93,21 @@ const til::point Terminal::GetSelectionEnd() const noexcept\n til::point Terminal::SelectionStartForRendering() const\r\n {\r\n     auto pos{ _selection->start };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n+    {\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n     if (pos.x != bufferSize.Left())\r\n     {\r\n         // In general, we need to draw the marker one before the\r\n         // beginning of the selection.\r\n         // When we're at the left boundary, we want to\r\n         // flip the marker, so we skip this step.\r\n-        bufferSize.DecrementInBounds(pos);\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -112,14 +119,21 @@ til::point Terminal::SelectionStartForRendering() const\n til::point Terminal::SelectionEndForRendering() const\r\n {\r\n     auto pos{ _selection->end };\r\n-    const auto bufferSize{ GetTextBuffer().GetSize() };\r\n-    if (pos.x != bufferSize.RightInclusive())\r\n+    const auto& buffer = GetTextBuffer();\r\n+    const auto bufferSize{ buffer.GetSize() };\r\n+    if (bufferSize.IsInBounds(pos) && buffer.GetCellDataAt(pos)->DbcsAttr() == DbcsAttribute::Trailing)\r\n     {\r\n-        // In general, we need to draw the marker one after the\r\n-        // end of the selection.\r\n+        // if we're on a trailing byte, move off of it to include it\r\n+        bufferSize.IncrementInExclusiveBounds(pos);\r\n+    }\r\n+\r\n+    if (pos.x == bufferSize.RightExclusive())\r\n+    {\r\n+        // sln->end is exclusive\r\n+        // In general, we need to draw the marker on the same cell.\r\n         // When we're at the right boundary, we want to\r\n-        // flip the marker, so we skip this step.\r\n-        bufferSize.IncrementInBounds(pos);\r\n+        // flip the marker, so we move one cell to the left.\r\n+        bufferSize.DecrementInExclusiveBounds(pos);\r\n     }\r\n     pos.y = base::ClampSub(pos.y, _VisibleStartIndex());\r\n     return til::point{ pos };\r\n@@ -157,7 +171,7 @@ void Terminal::MultiClickSelection(const til::point viewportPos, SelectionExpans\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = expansionMode;\r\n@@ -179,7 +193,7 @@ void Terminal::SetSelectionAnchor(const til::point viewportPos)\n     auto selection{ _selection.write() };\r\n     wil::hide_name _selection;\r\n \r\n-    selection->pivot = _ConvertToBufferCell(viewportPos);\r\n+    selection->pivot = _ConvertToBufferCell(viewportPos, true);\r\n     selection->active = true;\r\n \r\n     _multiClickSelectionMode = SelectionExpansion::Char;\r\n@@ -198,7 +212,7 @@ void Terminal::SetSelectionEnd(const til::point viewportPos, std::optional<Selec\n // - based on the selection expansion mode\r\n // Arguments:\r\n // - viewportPos: the (x,y) coordinate on the visible viewport\r\n-// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for ShiftClick\r\n+// - newExpansionMode: overwrites the _multiClickSelectionMode for this function call. Used for Shift+Click\r\n void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewportPos, std::optional<SelectionExpansion> newExpansionMode)\r\n {\r\n     wil::hide_name _selection;\r\n@@ -209,7 +223,12 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n         return;\r\n     }\r\n \r\n-    const auto textBufferPos = _ConvertToBufferCell(viewportPos);\r\n+    auto textBufferPos = _ConvertToBufferCell(viewportPos, true);\r\n+    if (newExpansionMode && *newExpansionMode == SelectionExpansion::Char && textBufferPos >= selection->pivot)\r\n+    {\r\n+        // Shift+Click forwards should highlight the clicked space\r\n+        _activeBuffer().GetSize().IncrementInExclusiveBounds(textBufferPos);\r\n+    }\r\n \r\n     // if this is a shiftClick action, we need to overwrite the _multiClickSelectionMode value (even if it's the same)\r\n     // Otherwise, we may accidentally expand during other selection-based actions\r\n@@ -248,7 +267,7 @@ void Terminal::_SetSelectionEnd(SelectionInfo* selection, const til::point viewp\n // - the new start/end for a selection\r\n std::pair<til::point, til::point> Terminal::_PivotSelection(const til::point targetPos, bool& targetStart) const noexcept\r\n {\r\n-    if (targetStart = _activeBuffer().GetSize().CompareInBounds(targetPos, _selection->pivot) <= 0)\r\n+    if (targetStart = targetPos <= _selection->pivot)\r\n     {\r\n         // target is before pivot\r\n         // treat target as start\r\n@@ -273,17 +292,31 @@ std::pair<til::point, til::point> Terminal::_ExpandSelectionAnchors(std::pair<ti\n     auto start = anchors.first;\r\n     auto end = anchors.second;\r\n \r\n-    const auto bufferSize = _activeBuffer().GetSize();\r\n+    const auto& buffer = _activeBuffer();\r\n+    const auto bufferSize = buffer.GetSize();\r\n     switch (_multiClickSelectionMode)\r\n     {\r\n     case SelectionExpansion::Line:\r\n         start = { bufferSize.Left(), start.y };\r\n-        end = { bufferSize.RightInclusive(), end.y };\r\n+        end = { bufferSize.RightExclusive(), end.y };\r\n         break;\r\n     case SelectionExpansion::Word:\r\n-        start = _activeBuffer().GetWordStart(start, _wordDelimiters);\r\n-        end = _activeBuffer().GetWordEnd(end, _wordDelimiters);\r\n+    {\r\n+        start = buffer.GetWordStart2(start, _wordDelimiters, false);\r\n+\r\n+        // GH#5099: We round to the nearest cell boundary,\r\n+        //   so we would normally prematurely expand to the next word\r\n+        //   as we approach it during a 2x-click+drag.\r\n+        //   To remedy this, decrement the end's position by 1.\r\n+        //   However, only do this when expanding right (it's correct\r\n+        //   as is when expanding left).\r\n+        if (end > _selection->pivot)\r\n+        {\r\n+            bufferSize.DecrementInExclusiveBounds(end);\r\n+        }\r\n+        end = buffer.GetWordEnd2(end, _wordDelimiters, false);\r\n         break;\r\n+    }\r\n     case SelectionExpansion::Char:\r\n     default:\r\n         // no expansion is necessary\r\n@@ -376,9 +409,9 @@ void Terminal::ExpandSelectionToWord()\n         const auto& buffer = _activeBuffer();\r\n         auto selection{ _selection.write() };\r\n         wil::hide_name _selection;\r\n-        selection->start = buffer.GetWordStart(selection->start, _wordDelimiters);\r\n+        selection->start = buffer.GetWordStart2(selection->start, _wordDelimiters, false);\r\n         selection->pivot = selection->start;\r\n-        selection->end = buffer.GetWordEnd(selection->end, _wordDelimiters);\r\n+        selection->end = buffer.GetWordEnd2(selection->end, _wordDelimiters, false);\r\n \r\n         // if we're targeting both endpoints, instead just target \"end\"\r\n         if (WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) && WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::End))\r\n@@ -529,7 +562,6 @@ void Terminal::SelectHyperlink(const SearchDirection dir)\n         selection->start = result->first;\r\n         selection->pivot = result->first;\r\n         selection->end = result->second;\r\n-        bufferSize.DecrementInBounds(selection->end);\r\n         _selectionIsTargetingUrl = true;\r\n         _selectionEndpoint = SelectionEndpoint::End;\r\n     }\r\n@@ -625,7 +657,7 @@ void Terminal::UpdateSelection(SelectionDirection direction, SelectionExpansion\n     }\r\n     auto targetPos{ WI_IsFlagSet(_selectionEndpoint, SelectionEndpoint::Start) ? _selection->start : _selection->end };\r\n \r\n-    // 2 Perform the movement\r\n+    // 2. Perform the movement\r\n     switch (mode)\r\n     {\r\n     case SelectionExpansion::Char:\r\n@@ -695,12 +727,12 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n-        _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphStart(pos);\r\n+        _activeBuffer().MoveToPreviousGlyph2(pos);\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        pos = _activeBuffer().GetGlyphEnd(pos);\r\n+        // We need the limit to be the mutable viewport here,\r\n+        // otherwise we're allowed to navigate by character past the mutable bottom\r\n+        _activeBuffer().MoveToNextGlyph2(pos, _GetMutableViewport().BottomInclusiveRightExclusive());\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -714,7 +746,7 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n         const auto bufferSize{ _activeBuffer().GetSize() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + 1 };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -722,61 +754,45 @@ void Terminal::_MoveByChar(SelectionDirection direction, til::point& pos)\n \r\n void Terminal::_MoveByWord(SelectionDirection direction, til::point& pos)\r\n {\r\n+    const auto& buffer = _activeBuffer();\r\n     switch (direction)\r\n     {\r\n     case SelectionDirection::Left:\r\n     {\r\n-        const auto wordStartPos{ _activeBuffer().GetWordStart(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(_selection->pivot, pos) < 0)\r\n-        {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = wordStartPos;\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-        }\r\n-        else if (wordStartPos == pos)\r\n-        {\r\n-            // already at the beginning of the current word,\r\n-            // move to the beginning of the previous word\r\n-            _activeBuffer().GetSize().DecrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // move to the beginning of the current word\r\n-            pos = wordStartPos;\r\n+            // didn't move because we're already at the beginning of a word,\r\n+            // so move to the beginning of the previous word\r\n+            buffer.GetSize().DecrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordStart2(nextPos, _wordDelimiters, true);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Right:\r\n     {\r\n-        const auto wordEndPos{ _activeBuffer().GetWordEnd(pos, _wordDelimiters) };\r\n-        if (_activeBuffer().GetSize().CompareInBounds(pos, _selection->pivot) < 0)\r\n+        const auto mutableViewportEndExclusive = _GetMutableViewport().BottomInclusiveRightExclusive();\r\n+        auto nextPos = pos;\r\n+        nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n+        if (nextPos == pos)\r\n         {\r\n-            // If we're moving towards the pivot, move one more cell\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-        }\r\n-        else if (wordEndPos == pos)\r\n-        {\r\n-            // already at the end of the current word,\r\n-            // move to the end of the next word\r\n-            _activeBuffer().GetSize().IncrementInBounds(pos);\r\n-            pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n-        }\r\n-        else\r\n-        {\r\n-            // move to the end of the current word\r\n-            pos = wordEndPos;\r\n+            // didn't move because we're already at the end of a word,\r\n+            // so move to the end of the next word\r\n+            buffer.GetSize().IncrementInExclusiveBounds(nextPos);\r\n+            nextPos = buffer.GetWordEnd2(nextPos, _wordDelimiters, true, mutableViewportEndExclusive);\r\n         }\r\n+        pos = nextPos;\r\n         break;\r\n     }\r\n     case SelectionDirection::Up:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordStart(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordStart2(pos, _wordDelimiters, true);\r\n         break;\r\n     case SelectionDirection::Down:\r\n         _MoveByChar(direction, pos);\r\n-        pos = _activeBuffer().GetWordEnd(pos, _wordDelimiters);\r\n+        pos = buffer.GetWordEnd2(pos, _wordDelimiters, true);\r\n         break;\r\n     }\r\n }\r\n@@ -790,7 +806,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         pos = { bufferSize.Left(), pos.y };\r\n         break;\r\n     case SelectionDirection::Right:\r\n-        pos = { bufferSize.RightInclusive(), pos.y };\r\n+        pos = { bufferSize.RightExclusive(), pos.y };\r\n         break;\r\n     case SelectionDirection::Up:\r\n     {\r\n@@ -804,7 +820,7 @@ void Terminal::_MoveByViewport(SelectionDirection direction, til::point& pos) no\n         const auto viewportHeight{ _GetMutableViewport().Height() };\r\n         const auto mutableBottom{ _GetMutableViewport().BottomInclusive() };\r\n         const auto newY{ pos.y + viewportHeight };\r\n-        pos = newY > mutableBottom ? til::point{ bufferSize.RightInclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n+        pos = newY > mutableBottom ? til::point{ bufferSize.RightExclusive(), mutableBottom } : til::point{ pos.x, newY };\r\n         break;\r\n     }\r\n     }\r\n@@ -821,7 +837,7 @@ void Terminal::_MoveByBuffer(SelectionDirection direction, til::point& pos) noex\n         break;\r\n     case SelectionDirection::Right:\r\n     case SelectionDirection::Down:\r\n-        pos = { bufferSize.RightInclusive(), _GetMutableViewport().BottomInclusive() };\r\n+        pos = { bufferSize.RightExclusive(), _GetMutableViewport().BottomInclusive() };\r\n         break;\r\n     }\r\n }\r\n@@ -901,13 +917,17 @@ Terminal::TextCopyData Terminal::RetrieveSelectedTextFromBuffer(const bool singl\n // - convert viewport position to the corresponding location on the buffer\r\n // Arguments:\r\n // - viewportPos: a coordinate on the viewport\r\n+// - allowRightExclusive: if true, clamp to the right exclusive boundary of the buffer.\r\n+//     Careful! This position doesn't point to any data in the buffer!\r\n // Return Value:\r\n // - the corresponding location on the buffer\r\n-til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\r\n+til::point Terminal::_ConvertToBufferCell(const til::point viewportPos, bool allowRightExclusive) const\r\n {\r\n     const auto yPos = _VisibleStartIndex() + viewportPos.y;\r\n     til::point bufferPos = { viewportPos.x, yPos };\r\n-    _activeBuffer().GetSize().Clamp(bufferPos);\r\n+    const auto bufferSize = _activeBuffer().GetSize();\r\n+    bufferPos.x = std::clamp(bufferPos.x, bufferSize.Left(), allowRightExclusive ? bufferSize.RightExclusive() : bufferSize.RightInclusive());\r\n+    bufferPos.y = std::clamp(bufferPos.y, bufferSize.Top(), bufferSize.BottomInclusive());\r\n     return bufferPos;\r\n }\r\n \r\n@@ -917,7 +937,7 @@ til::point Terminal::_ConvertToBufferCell(const til::point viewportPos) const\n // - pos: a coordinate relative to the buffer (not viewport)\r\n void Terminal::_ScrollToPoint(const til::point pos)\r\n {\r\n-    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInBounds(pos))\r\n+    if (const auto visibleViewport = _GetVisibleViewport(); !visibleViewport.IsInExclusiveBounds(pos))\r\n     {\r\n         if (const auto amtAboveView = visibleViewport.Top() - pos.y; amtAboveView > 0)\r\n         {\r\ndiff --git a/src/cascadia/TerminalCore/terminalrenderdata.cpp b/src/cascadia/TerminalCore/terminalrenderdata.cpp\nindex 006d87aabe5..d7bca1077cc 100644\n--- a/src/cascadia/TerminalCore/terminalrenderdata.cpp\n+++ b/src/cascadia/TerminalCore/terminalrenderdata.cpp\n@@ -201,6 +201,11 @@ til::CoordType Terminal::_ScrollToPoints(const til::point coordStart, const til:\n     return _VisibleStartIndex();\r\n }\r\n \r\n+// Method Description:\r\n+// - selects the region from coordStart to coordEnd\r\n+// Arguments:\r\n+// - coordStart - The start point (inclusive)\r\n+// - coordEnd - The end point (inclusive)\r\n void Terminal::SelectNewRegion(const til::point coordStart, const til::point coordEnd)\r\n {\r\n     const auto newScrollOffset = _ScrollToPoints(coordStart, coordEnd);\r\n@@ -210,6 +215,7 @@ void Terminal::SelectNewRegion(const til::point coordStart, const til::point coo\n     const auto newCoordEnd = til::point{ coordEnd.x, coordEnd.y - newScrollOffset };\r\n     SetSelectionAnchor(newCoordStart);\r\n     SetSelectionEnd(newCoordEnd, SelectionExpansion::Char);\r\n+    _activeBuffer().TriggerSelection();\r\n }\r\n \r\n const std::wstring_view Terminal::GetConsoleTitle() const noexcept\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\nindex e018e1fd2ad..999809cb397 100644\n--- a/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlCoreTests.cpp\n@@ -419,7 +419,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -440,7 +440,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -450,7 +450,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 0 };\r\n-            const til::point expectedEnd{ 23, 0 };\r\n+            const til::point expectedEnd{ 24, 0 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -460,7 +460,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 17, 4 };\r\n-            const til::point expectedEnd{ 23, 4 };\r\n+            const til::point expectedEnd{ 24, 4 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -502,7 +502,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -663,7 +663,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 26, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 27, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -673,7 +673,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -731,7 +731,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 20, 4 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 29, 34 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 30, 34 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -741,7 +741,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 24, 0 }; // The character after the prompt\r\n-            const til::point expectedEnd{ 21, 3 }; // x = the end of the text\r\n+            const til::point expectedEnd{ 22, 3 }; // x = the end of the text + 1 (exclusive end)\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n@@ -804,7 +804,7 @@ namespace ControlUnitTests\n             const auto& start = core->_terminal->GetSelectionAnchor();\r\n             const auto& end = core->_terminal->GetSelectionEnd();\r\n             const til::point expectedStart{ 1, 1 };\r\n-            const til::point expectedEnd{ 1, 2 };\r\n+            const til::point expectedEnd{ 2, 2 };\r\n             VERIFY_ARE_EQUAL(expectedStart, start);\r\n             VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\ndiff --git a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\nindex 49fcd6d21eb..282b1995da7 100644\n--- a/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n+++ b/src/cascadia/UnitTests_Control/ControlInteractivityTests.cpp\n@@ -438,8 +438,9 @@ namespace ControlUnitTests\n         // The viewport is on row 21, so the selection will be on:\r\n         // {(5, 5)+(0, 21)} to {(5, 5)+(0, 21)}\r\n         til::point expectedAnchor{ 5, 26 };\r\n+        til::point expectedEnd{ 6, 26 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Scroll up a line, with the left mouse button selected\");\r\n         interactivity->MouseWheel(modifiers,\r\n@@ -449,10 +450,11 @@ namespace ControlUnitTests\n \r\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The viewport is now on row 20, so the selection will be on:\r\n-        // {(5, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n-        til::point newExpectedAnchor{ 5, 25 };\r\n+        // {(5 + 1, 5)+(0, 20)} to {(5, 5)+(0, 21)}\r\n+        // NOTE: newExpectedAnchor should be expectedEnd moved up one row\r\n+        til::point newExpectedAnchor{ 6, 25 };\r\n         // Remember, the anchor is always before the end in the buffer. So yes,\r\n-        // se started the selection on 5,26, but now that's the end.\r\n+        // we started the selection on 5,26, but now that's the end.\r\n         VERIFY_ARE_EQUAL(newExpectedAnchor, core->_terminal->GetSelectionAnchor());\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n     }\r\n@@ -628,7 +630,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify that it started on the first cell we clicked on, not the one we dragged to\");\r\n         til::point expectedAnchor{ 0, 0 };\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        til::point expectedEnd{ 2, 0 };\r\n+        til::point expectedEnd{ 3, 0 }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         interactivity->PointerReleased(noMouseDown,\r\n@@ -798,8 +800,9 @@ namespace ControlUnitTests\n         // The viewport is on row (historySize + 5), so the selection will be on:\r\n         // {(5, (historySize+5))+(0, 21)} to {(5, (historySize+5))+(0, 21)}\r\n         til::point expectedAnchor{ 5, settings->HistorySize() + 5 };\r\n+        til::point expectedEnd{ 6, expectedAnchor.y }; // add 1 to x-coordinate because end is exclusive\r\n         VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionAnchor());\r\n-        VERIFY_ARE_EQUAL(expectedAnchor, core->_terminal->GetSelectionEnd());\r\n+        VERIFY_ARE_EQUAL(expectedEnd, core->_terminal->GetSelectionEnd());\r\n \r\n         Log::Comment(L\"Output a line of text\");\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n@@ -807,6 +810,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -815,7 +819,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 1, core->_terminal->GetScrollOffset());\r\n \r\n@@ -825,6 +829,7 @@ namespace ControlUnitTests\n         Log::Comment(L\"Verify the location of the selection\");\r\n         // The selection should now be 1 row lower\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         {\r\n             const auto anchor{ core->_terminal->GetSelectionAnchor() };\r\n             const auto end{ core->_terminal->GetSelectionEnd() };\r\n@@ -833,7 +838,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 2, core->_terminal->GetScrollOffset());\r\n \r\n@@ -858,15 +863,17 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"anchor:({},{})\", anchor.x, anchor.y).c_str());\r\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n+            // Selection was updated, but we didn't highlight a full cell\r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n             VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n         }\r\n \r\n-        Log::Comment(L\"Output a line ant move the mouse a little to update the selection, all at once\");\r\n+        Log::Comment(L\"Output a line and move the mouse a little to update the selection, all at once\");\r\n         // Same as above. The viewport has moved, so the mouse is still over the\r\n         // same character, even though it's at a new offset.\r\n         conn->WriteInput(winrt_wstring_to_array_view(L\"Foo\\r\\n\"));\r\n         expectedAnchor.y -= 1;\r\n+        expectedEnd.y -= 1;\r\n         VERIFY_ARE_EQUAL(scrollbackLength - 3, core->_terminal->GetScrollOffset());\r\n         interactivity->PointerMoved(leftMouseDown,\r\n                                     WM_LBUTTONDOWN, //pointerUpdateKind\r\n@@ -883,7 +890,7 @@ namespace ControlUnitTests\n             Log::Comment(fmt::format(L\"end:({},{})\", end.x, end.y).c_str());\r\n \r\n             VERIFY_ARE_EQUAL(expectedAnchor, anchor);\r\n-            VERIFY_ARE_EQUAL(expectedAnchor, end);\r\n+            VERIFY_ARE_EQUAL(expectedEnd, end);\r\n         }\r\n \r\n         // Output enough text for the selection to get pushed off the buffer\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\nindex 11f01c75297..1585fef905f 100644\n--- a/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/SelectionTest.cpp\n@@ -126,20 +126,20 @@ namespace TerminalCoreUnitTests\n \r\n             // Test with no scrollback\r\n             Log::Comment(L\"Single click selection with NO scrollback value\");\r\n-            ValidateSingleClickSelection(0, { 9, 9 }, { 9, 9 });\r\n+            ValidateSingleClickSelection(0, { 10, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Double click selection with NO scrollback value\");\r\n-            ValidateDoubleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateDoubleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n             Log::Comment(L\"Triple click selection with NO scrollback value\");\r\n-            ValidateTripleClickSelection(0, { 0, 9 }, { 9, 9 });\r\n+            ValidateTripleClickSelection(0, { 0, 9 }, { 10, 9 });\r\n \r\n             // Test with max scrollback\r\n             const til::CoordType expected_row = SHRT_MAX - 1;\r\n             Log::Comment(L\"Single click selection with MAXIMUM scrollback value\");\r\n-            ValidateSingleClickSelection(SHRT_MAX, { 9, expected_row }, { 9, expected_row });\r\n+            ValidateSingleClickSelection(SHRT_MAX, { 10, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Double click selection with MAXIMUM scrollback value\");\r\n-            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateDoubleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n             Log::Comment(L\"Triple click selection with MAXIMUM scrollback value\");\r\n-            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 9, expected_row });\r\n+            ValidateTripleClickSelection(SHRT_MAX, { 0, expected_row }, { 10, expected_row });\r\n         }\r\n \r\n         TEST_METHOD(SelectFromOutofBounds)\r\n@@ -155,7 +155,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const auto leftBoundary = viewport.Left();\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n             const auto topBoundary = viewport.Top();\r\n             const auto bottomBoundary = viewport.BottomInclusive();\r\n \r\n@@ -163,7 +163,7 @@ namespace TerminalCoreUnitTests\n             // should clamp to right boundary\r\n             term.SetSelectionAnchor({ 20, 5 });\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n-            ValidateLinearSelection(term, { rightBoundary, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { rightExclusiveBoundary, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Simulate click past left (x,y) = (-20,5)\r\n             // should clamp to left boundary\r\n@@ -197,7 +197,7 @@ namespace TerminalCoreUnitTests\n \r\n             auto viewport = term.GetViewport();\r\n             const til::CoordType leftBoundary = 0;\r\n-            const auto rightBoundary = viewport.RightInclusive();\r\n+            const auto rightExclusiveBoundary = viewport.RightExclusive();\r\n \r\n             // Simulate click at (x,y) = (5,5)\r\n             term.SetSelectionAnchor({ 5, 5 });\r\n@@ -205,7 +205,7 @@ namespace TerminalCoreUnitTests\n             // Case 1: Move out of right boundary\r\n             Log::Comment(L\"Out of bounds: X-value too large\");\r\n             term.SetSelectionEnd({ 20, 5 });\r\n-            ValidateLinearSelection(term, { 5, 5 }, { rightBoundary, 5 });\r\n+            ValidateLinearSelection(term, { 5, 5 }, { rightExclusiveBoundary, 5 });\r\n \r\n             // Case 2: Move out of left boundary\r\n             Log::Comment(L\"Out of bounds: X-value negative\");\r\n@@ -312,7 +312,7 @@ namespace TerminalCoreUnitTests\n \r\n             // Validate selection area\r\n             // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 6, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyph_Leading)\r\n@@ -334,8 +334,8 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionAnchor(clickPos);\r\n \r\n             // Validate selection area\r\n-            // Selection should expand one to the left to get the leading half of the wide glyph\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 5, 10 });\r\n+            // Selection should clamp to the left side of the glyph and stay degenerate\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 4, 10 });\r\n         }\r\n \r\n         TEST_METHOD(SelectWideGlyphsInBoxSelection)\r\n@@ -356,12 +356,26 @@ namespace TerminalCoreUnitTests\n             GetTextBuffer(term).GetCursor().SetPosition({ 7, 11 });\r\n             term.Write(burrito);\r\n \r\n+            // Text buffer should look like this:\r\n+            // -------------\r\n+            // |     A      |\r\n+            // |            |\r\n+            // |    🌯      |\r\n+            // |       🌯   |\r\n+            // |        B   |\r\n+            // -------------\r\n+            // A: selection anchor\r\n+            // B: selection end\r\n+            // The boundaries of the selection should cut through\r\n+            //  the middle of the burritos, but the selection\r\n+            //  should expand to encompass each burrito entirely.\r\n+\r\n             // Simulate ALT + click at (x,y) = (5,8)\r\n             term.SetSelectionAnchor({ 5, 8 });\r\n             term.SetBlockSelection(true);\r\n \r\n-            // Simulate move to (x,y) = (7,12)\r\n-            term.SetSelectionEnd({ 7, 12 });\r\n+            // Simulate move to (x,y) = (8,12)\r\n+            term.SetSelectionEnd({ 8, 12 });\r\n \r\n             // Simulate renderer calling TriggerSelection and acquiring selection area\r\n             auto selectionSpans = term.GetSelectionSpans();\r\n@@ -376,18 +390,18 @@ namespace TerminalCoreUnitTests\n                 if (rowValue == 10)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 4, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n                 else if (rowValue == 11)\r\n                 {\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 9, rowValue }), sp.end);\r\n                 }\r\n                 else\r\n                 {\r\n                     // Verify all lines\r\n                     VERIFY_ARE_EQUAL((til::point{ 5, rowValue }), sp.start);\r\n-                    VERIFY_ARE_EQUAL((til::point{ 7, rowValue }), sp.end);\r\n+                    VERIFY_ARE_EQUAL((til::point{ 8, rowValue }), sp.end);\r\n                 }\r\n \r\n                 rowValue++;\r\n@@ -414,7 +428,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size() - 1), 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { gsl::narrow<til::CoordType>(4 + text.size()), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_Delimiter)\r\n@@ -432,7 +446,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Word);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClick_DelimiterClass)\r\n@@ -457,10 +471,10 @@ namespace TerminalCoreUnitTests\n \r\n             // ---Validate selection area---\r\n             // \"Terminal\" is in class 2\r\n-            // \">\" is in class 1\r\n+            // \":\" and \">\" are in class 1\r\n             // the white space to the right of the \">\" is in class 0\r\n             // Double-clicking the \">\" should only highlight that cell\r\n-            ValidateLinearSelection(term, { 15, 10 }, { 15, 10 });\r\n+            ValidateLinearSelection(term, { 15, 10 }, { 16, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Right)\r\n@@ -489,7 +503,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 21, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(DoubleClickDrag_Left)\r\n@@ -502,7 +516,7 @@ namespace TerminalCoreUnitTests\n             auto settings = winrt::make<MockTermSettings>(0, 100, 100);\r\n             term.UpdateSettings(settings);\r\n \r\n-            // Insert text at position (21,10)\r\n+            // Insert text at position (4,10)\r\n             const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n@@ -513,12 +527,12 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,10)\r\n             //\r\n             // buffer: doubleClickMe dragThroughHere\r\n-            //         ^                ^\r\n-            //       finish            start\r\n+            //          ^               ^\r\n+            //        finish           start\r\n             term.SetSelectionEnd({ 5, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+            ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClick_GeneralCase)\r\n@@ -532,7 +546,7 @@ namespace TerminalCoreUnitTests\n             term.MultiClickSelection(clickPos, Terminal::SelectionExpansion::Line);\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Horizontal)\r\n@@ -549,7 +563,7 @@ namespace TerminalCoreUnitTests\n             term.SetSelectionEnd({ 7, 10 });\r\n \r\n             // Validate selection area\r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 10 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 10 });\r\n         }\r\n \r\n         TEST_METHOD(TripleClickDrag_Vertical)\r\n@@ -565,7 +579,7 @@ namespace TerminalCoreUnitTests\n             // Simulate move to (x,y) = (5,11)\r\n             term.SetSelectionEnd({ 5, 11 });\r\n \r\n-            ValidateLinearSelection(term, { 0, 10 }, { 99, 11 });\r\n+            ValidateLinearSelection(term, { 0, 10 }, { term.GetViewport().RightExclusive(), 11 });\r\n         }\r\n \r\n         TEST_METHOD(ShiftClick)\r\n@@ -579,20 +593,20 @@ namespace TerminalCoreUnitTests\n             term.UpdateSettings(settings);\r\n \r\n             // Insert text at position (4,10)\r\n-            const std::wstring_view text = L\"doubleClickMe dragThroughHere\";\r\n+            const std::wstring_view text = L\"doubleClickMe dragThroughHere anotherWord\";\r\n             GetTextBuffer(term).GetCursor().SetPosition({ 4, 10 });\r\n             term.Write(text);\r\n \r\n-            // Step 1: Create a selection on \"doubleClickMe\"\r\n+            Log::Comment(L\"Step 1 : Create a selection on \\\"doubleClickMe\\\"\");\r\n             {\r\n                 // Simulate double click at (x,y) = (5,10)\r\n                 term.MultiClickSelection({ 5, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 16, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 17, 10 });\r\n             }\r\n \r\n-            // Step 2: Shift+Click to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 2: Shift+Click to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+Click at (x,y) = (21,10)\r\n                 //\r\n@@ -602,10 +616,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area: \"doubleClickMe drag\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 21, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 22, 10 });\r\n             }\r\n \r\n-            // Step 3: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 3: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -615,10 +629,10 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Triple-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 4: Shift+Triple-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+TripleClick at (x,y) = (21,10)\r\n                 //\r\n@@ -628,60 +642,62 @@ namespace TerminalCoreUnitTests\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Line);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 100, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Double-Click at \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 5: Shift+Double-Click at \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate Shift+DoubleClick at (x,y) = (21,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start            click      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^           ^\r\n+                //       start            click       finish\r\n+                // NOTE: end is exclusive, so finish should point to the spot AFTER \"dragThroughHere\"\r\n                 term.SetSelectionEnd({ 21, 10 }, Terminal::SelectionExpansion::Word);\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag past \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 6: Drag past \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (35,10)\r\n                 // Since we were preceded by a double-click, we're in \"word\" expansion mode\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere     |\r\n-                //         ^                                 ^\r\n-                //       start                             finish (boundary)\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                              ^\r\n+                //       start                          finish\r\n                 term.SetSelectionEnd({ 35, 10 });\r\n \r\n-                // Validate selection area: \"doubleClickMe dragThroughHere...\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 99, 10 });\r\n+                // Validate selection area: \"doubleClickMe dragThroughHere anotherWord\" selected\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 45, 10 });\r\n             }\r\n \r\n-            // Step 6: Drag back to \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 7: Drag back to \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (21,10)\r\n+                // Should still be in \"word\" expansion mode!\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                ^          ^\r\n-                //       start             drag      finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                ^\r\n+                //       start            finish\r\n                 term.SetSelectionEnd({ 21, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n \r\n-            // Step 7: Drag within \"dragThroughHere\"\r\n+            Log::Comment(L\"Step 8: Drag within \\\"dragThroughHere\\\"\");\r\n             {\r\n                 // Simulate drag to (x,y) = (25,10)\r\n                 //\r\n-                // buffer: doubleClickMe dragThroughHere\r\n-                //         ^                    ^      ^\r\n-                //       start                 drag  finish\r\n+                // buffer: doubleClickMe dragThroughHere anotherWord\r\n+                //         ^                    ^\r\n+                //       start                finish\r\n                 term.SetSelectionEnd({ 25, 10 });\r\n \r\n                 // Validate selection area: \"doubleClickMe dragThroughHere\" still selected\r\n-                ValidateLinearSelection(term, { 4, 10 }, { 32, 10 });\r\n+                ValidateLinearSelection(term, { 4, 10 }, { 33, 10 });\r\n             }\r\n         }\r\n \r\n@@ -691,25 +707,27 @@ namespace TerminalCoreUnitTests\n             DummyRenderer renderer{ &term };\r\n             term.Create({ 100, 100 }, 0, renderer);\r\n \r\n-            // Step 1: Create a selection\r\n+            Log::Comment(L\"Step 1: Create a selection\");\r\n             {\r\n-                // (10,10) to (20, 10)\r\n+                // (10,10) to (20, 10) (inclusive)\r\n                 term.SelectNewRegion({ 10, 10 }, { 20, 10 });\r\n \r\n                 // Validate selection area\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n \r\n-            // Step 2: Drag to (5,10)\r\n+            Log::Comment(L\"Step 2: Drag to (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 });\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should be (10, 10)\r\n+                // NOTES:\r\n+                // - Pivot should be (10, 10)\r\n+                // - though end is generally exclusive, since we moved behind the pivot, end is actually inclusive\r\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 3: Drag back to (20,10)\r\n+            Log::Comment(L\"Step 3: Drag back to (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 });\r\n \r\n@@ -718,7 +736,7 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n             }\r\n \r\n-            // Step 4: Shift+Click at (5,10)\r\n+            Log::Comment(L\"Step 4: Shift+Click at (5,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 5, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n@@ -727,13 +745,14 @@ namespace TerminalCoreUnitTests\n                 ValidateLinearSelection(term, { 5, 10 }, { 10, 10 });\r\n             }\r\n \r\n-            // Step 5: Shift+Click back at (20,10)\r\n+            Log::Comment(L\"Step 5: Shift+Click back at (20,10)\");\r\n             {\r\n                 term.SetSelectionEnd({ 20, 10 }, Terminal::SelectionExpansion::Char);\r\n \r\n                 // Validate selection area\r\n-                // NOTE: Pivot should still be (10, 10)\r\n-                ValidateLinearSelection(term, { 10, 10 }, { 20, 10 });\r\n+                //   Pivot should still be (10, 10)\r\n+                //   Shift+Click makes end inclusive (so add 1)\r\n+                ValidateLinearSelection(term, { 10, 10 }, { 21, 10 });\r\n             }\r\n         }\r\n     };\r\ndiff --git a/src/host/selection.cpp b/src/host/selection.cpp\nindex 300068d9671..d7dcf21ebe2 100644\n--- a/src/host/selection.cpp\n+++ b/src/host/selection.cpp\n@@ -43,11 +43,32 @@ void Selection::_RegenerateSelectionSpans() const\n     endSelectionAnchor.x = (_d->coordSelectionAnchor.x == _d->srSelectionRect.left) ? _d->srSelectionRect.right : _d->srSelectionRect.left;\r\n     endSelectionAnchor.y = (_d->coordSelectionAnchor.y == _d->srSelectionRect.top) ? _d->srSelectionRect.bottom : _d->srSelectionRect.top;\r\n \r\n+    // GH #18106: Conhost and Terminal share most of the selection code.\r\n+    //    Both now store the selection data as a half-open range [start, end),\r\n+    //     where \"end\" is the bottom-right-most point.\r\n+    //    Note that Conhost defines start/end as \"start was set in time before end\",\r\n+    //     whereas above (and in Terminal) we're treating start/end as \"start is physically before end\".\r\n+    //    We want Conhost to still operate as an inclusive range.\r\n+    //    To make it \"feel\" inclusive, we need to adjust the \"end\" endpoint\r\n+    //     by incrementing it by one, so that the \"end\" endpoint is rendered\r\n+    //     and handled as selected.\r\n     const auto blockSelection = !IsLineSelection();\r\n-    _lastSelectionSpans = screenInfo.GetTextBuffer().GetTextSpans(_d->coordSelectionAnchor,\r\n-                                                                  endSelectionAnchor,\r\n-                                                                  blockSelection,\r\n-                                                                  false);\r\n+    const auto& buffer = screenInfo.GetTextBuffer();\r\n+    auto startSelectionAnchor = _d->coordSelectionAnchor;\r\n+    if (blockSelection)\r\n+    {\r\n+        // Compare x-values when we're in block selection!\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor.x <= endSelectionAnchor.x ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    else\r\n+    {\r\n+        // General comparison for line selection.\r\n+        buffer.GetSize().IncrementInExclusiveBounds(startSelectionAnchor <= endSelectionAnchor ? endSelectionAnchor : startSelectionAnchor);\r\n+    }\r\n+    _lastSelectionSpans = buffer.GetTextSpans(startSelectionAnchor,\r\n+                                              endSelectionAnchor,\r\n+                                              blockSelection,\r\n+                                              false);\r\n     _lastSelectionGeneration = _d.generation();\r\n }\r\n \r\ndiff --git a/src/host/ut_host/ClipboardTests.cpp b/src/host/ut_host/ClipboardTests.cpp\nindex 21d4c7b13b8..24f2693c643 100644\n--- a/src/host/ut_host/ClipboardTests.cpp\n+++ b/src/host/ut_host/ClipboardTests.cpp\n@@ -84,7 +84,7 @@ class ClipboardTests\n         const auto& screenInfo = gci.GetActiveOutputBuffer();\r\n         const auto& buffer = screenInfo.GetTextBuffer();\r\n \r\n-        constexpr til::point_span selection = { { 0, 0 }, { 14, 3 } };\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 15, 3 } };\r\n         const auto req = TextBuffer::CopyRequest::FromConfig(buffer, selection.start, selection.end, false, !fLineSelection, false);\r\n         return buffer.GetPlainText(req);\r\n     }\r\ndiff --git a/src/host/ut_host/SearchTests.cpp b/src/host/ut_host/SearchTests.cpp\nindex 423273b3c38..d37c3556d40 100644\n--- a/src/host/ut_host/SearchTests.cpp\n+++ b/src/host/ut_host/SearchTests.cpp\n@@ -60,7 +60,7 @@ class SearchTests\n         const auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n \r\n         auto coordEndExpected = coordStartExpected;\r\n-        coordEndExpected.x += 1;\r\n+        coordEndExpected.x += 2;\r\n \r\n         VERIFY_IS_TRUE(s.SelectCurrent());\r\n         VERIFY_ARE_EQUAL(coordStartExpected, gci.renderData.GetSelectionAnchor());\r\ndiff --git a/src/host/ut_host/SelectionTests.cpp b/src/host/ut_host/SelectionTests.cpp\nindex 62eac812053..f314e8dcc9e 100644\n--- a/src/host/ut_host/SelectionTests.cpp\n+++ b/src/host/ut_host/SelectionTests.cpp\n@@ -74,7 +74,7 @@ class SelectionTests\n                 VERIFY_ARE_EQUAL(span.end.y, sRectangleLineNumber);\r\n \r\n                 VERIFY_ARE_EQUAL(span.start.x, m_pSelection->_d->srSelectionRect.left);\r\n-                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right);\r\n+                VERIFY_ARE_EQUAL(span.end.x, m_pSelection->_d->srSelectionRect.right + 1);\r\n             }\r\n         }\r\n     }\r\n@@ -141,15 +141,17 @@ class SelectionTests\n         }\r\n     }\r\n \r\n-    void VerifyGetSelectionSpans_LineMode(const til::point start, const til::point end)\r\n+    void VerifyGetSelectionSpans_LineMode(const til::point inclusiveStart, const til::point inclusiveEnd)\r\n     {\r\n         const auto selectionSpans = m_pSelection->GetSelectionSpans();\r\n \r\n         if (VERIFY_ARE_EQUAL(1u, selectionSpans.size()))\r\n         {\r\n             auto& span{ selectionSpans[0] };\r\n-            VERIFY_ARE_EQUAL(start, span.start, L\"start\");\r\n-            VERIFY_ARE_EQUAL(end, span.end, L\"end\");\r\n+            VERIFY_ARE_EQUAL(inclusiveStart, span.start, L\"start\");\r\n+\r\n+            const til::point exclusiveEnd{ inclusiveEnd.x + 1, inclusiveEnd.y };\r\n+            VERIFY_ARE_EQUAL(exclusiveEnd, span.end, L\"end\");\r\n         }\r\n     }\r\n \r\ndiff --git a/src/host/ut_host/TextBufferTests.cpp b/src/host/ut_host/TextBufferTests.cpp\nindex 2d6c1d1628e..4252609e30f 100644\n--- a/src/host/ut_host/TextBufferTests.cpp\n+++ b/src/host/ut_host/TextBufferTests.cpp\n@@ -2432,11 +2432,11 @@ void TextBufferTests::GetTextRects()\n     std::vector<til::inclusive_rect> expected{};\r\n     if (blockSelection)\r\n     {\r\n-        expected.push_back({ 1, 0, 7, 0 });\r\n-        expected.push_back({ 1, 1, 8, 1 }); // expand right\r\n-        expected.push_back({ 1, 2, 7, 2 });\r\n-        expected.push_back({ 0, 3, 7, 3 }); // expand left\r\n-        expected.push_back({ 1, 4, 7, 4 });\r\n+        expected.push_back({ 1, 0, 8, 0 });\r\n+        expected.push_back({ 1, 1, 9, 1 }); // expand right\r\n+        expected.push_back({ 1, 2, 8, 2 });\r\n+        expected.push_back({ 0, 3, 8, 3 }); // do not expand\r\n+        expected.push_back({ 1, 4, 8, 4 });\r\n     }\r\n     else\r\n     {\r\n@@ -2444,11 +2444,11 @@ void TextBufferTests::GetTextRects()\n         expected.push_back({ 0, 1, 19, 1 });\r\n         expected.push_back({ 0, 2, 19, 2 });\r\n         expected.push_back({ 0, 3, 19, 3 });\r\n-        expected.push_back({ 0, 4, 7, 4 });\r\n+        expected.push_back({ 0, 4, 8, 4 });\r\n     }\r\n \r\n     til::point start{ 1, 0 };\r\n-    til::point end{ 7, 4 };\r\n+    til::point end{ 8, 4 };\r\n     const auto result = _buffer->GetTextRects(start, end, blockSelection, false);\r\n     VERIFY_ARE_EQUAL(expected.size(), result.size());\r\n     for (size_t i = 0; i < expected.size(); ++i)\r\n@@ -2494,8 +2494,9 @@ void TextBufferTests::GetPlainText()\n                                                        L\"  3  \" };\r\n         WriteLinesToBuffer(bufferText, *_buffer);\r\n \r\n-        // simulate a selection from origin to {4,4}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 4 } };\r\n+        // simulate a selection from origin to {5,4}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 4 } };\r\n \r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, false };\r\n         const auto result = _buffer->GetPlainText(req);\r\n@@ -2589,8 +2590,9 @@ void TextBufferTests::GetPlainText()\n         // |     |\r\n         // |_____|\r\n \r\n-        // simulate a selection from origin to {4,5}\r\n-        constexpr til::point_span selection = { { 0, 0 }, { 4, 5 } };\r\n+        // simulate a selection from origin to {5,5}\r\n+        // Remember! End is exclusive!\r\n+        constexpr til::point_span selection = { { 0, 0 }, { 5, 5 } };\r\n \r\n         const auto formatWrappedRows = blockSelection;\r\n         const auto req = TextBuffer::CopyRequest{ *_buffer, selection.start, selection.end, blockSelection, includeCRLF, trimTrailingWhitespace, formatWrappedRows };\r\ndiff --git a/src/inc/til/point.h b/src/inc/til/point.h\nindex 17bc9d1c861..95eed691671 100644\n--- a/src/inc/til/point.h\n+++ b/src/inc/til/point.h\n@@ -322,6 +322,42 @@ namespace til // Terminal Implementation Library. Also: \"Today I Learned\"\n                 func(y, x1, x2);\r\n             }\r\n         }\r\n+\r\n+        // Similar to iterate_rows above, but the \"end\" point is exclusive\r\n+        // and RightExclusive (aka \"width\") is an allowable coordinate\r\n+        constexpr void iterate_rows_exclusive(til::CoordType width, auto&& func) const\r\n+        {\r\n+            // Copy the members so that the compiler knows it doesn't\r\n+            // need to re-read them on every loop iteration.\r\n+            const auto w = width;\r\n+            auto ax = std::clamp(start.x, 0, w);\r\n+            auto ay = start.y;\r\n+            auto bx = std::clamp(end.x, 0, w);\r\n+            auto by = end.y;\r\n+\r\n+            // if start is at RightExclusive,\r\n+            // treat it as (0, y+1) (left-most point on next line)\r\n+            if (ax == w)\r\n+            {\r\n+                ay++;\r\n+                ax = 0;\r\n+            }\r\n+\r\n+            // if end is on left boundary,\r\n+            // treat it as (w, y-1) (RightExclusive on previous line)\r\n+            if (bx == 0)\r\n+            {\r\n+                by--;\r\n+                bx = w;\r\n+            }\r\n+\r\n+            for (auto y = ay; y <= by; ++y)\r\n+            {\r\n+                const auto x1 = y != ay ? 0 : ax;\r\n+                const auto x2 = y != by ? w : bx;\r\n+                func(y, x1, x2);\r\n+            }\r\n+        }\r\n     };\r\n }\r\n \r\ndiff --git a/src/renderer/atlas/AtlasEngine.api.cpp b/src/renderer/atlas/AtlasEngine.api.cpp\nindex a80ae930ba9..10cf2e3a405 100644\n--- a/src/renderer/atlas/AtlasEngine.api.cpp\n+++ b/src/renderer/atlas/AtlasEngine.api.cpp\n@@ -89,11 +89,11 @@ void AtlasEngine::_invalidateSpans(std::span<const til::point_span> spans, const\n     const auto viewport = til::rect{ 0, 0, _api.s->viewportCellCount.x, _api.s->viewportCellCount.y };\r\n     for (auto&& sp : spans)\r\n     {\r\n-        sp.iterate_rows(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n+        sp.iterate_rows_exclusive(til::CoordTypeMax, [&](til::CoordType row, til::CoordType beg, til::CoordType end) {\r\n             const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n             beg <<= shift;\r\n             end <<= shift;\r\n-            til::rect rect{ beg, row, end + 1, row + 1 };\r\n+            til::rect rect{ beg, row, end, row + 1 };\r\n             rect = rect.to_origin(viewportOrigin);\r\n             rect &= viewport;\r\n             _api.invalidatedRows.start = gsl::narrow_cast<u16>(std::min<int>(_api.invalidatedRows.start, std::max<int>(0, rect.top)));\r\ndiff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 0de92b62373..90b9083b5d3 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -427,13 +427,13 @@ try\n     if (y > hiStart.y)\r\n     {\r\n         const auto isFinalRow = y == hiEnd.y;\r\n-        const auto end = isFinalRow ? std::min(hiEnd.x + 1, x2) : x2;\r\n+        const auto end = isFinalRow ? std::min(hiEnd.x, x2) : x2;\r\n         _fillColorBitmap(row, x1, end, fgColor, bgColor);\r\n \r\n         // Return early if we couldn't paint the whole region (either this was not the last row, or\r\n         // it was the last row but the highlight ends outside of our x range.)\r\n         // We will resume from here in the next call.\r\n-        if (!isFinalRow || hiEnd.x /*inclusive*/ >= x2 /*exclusive*/)\r\n+        if (!isFinalRow || hiEnd.x > x2)\r\n         {\r\n             return S_OK;\r\n         }\r\n@@ -448,10 +448,10 @@ try\n         hiEnd = it->end - offset;\r\n \r\n         const auto isStartInside = y == hiStart.y && hiStart.x < x2;\r\n-        const auto isEndInside = y == hiEnd.y && hiEnd.x < x2;\r\n+        const auto isEndInside = y == hiEnd.y && hiEnd.x <= x2;\r\n         if (isStartInside && isEndInside)\r\n         {\r\n-            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x) + 1, fgColor, bgColor);\r\n+            _fillColorBitmap(row, hiStart.x, static_cast<size_t>(hiEnd.x), fgColor, bgColor);\r\n             ++it;\r\n         }\r\n         else\r\ndiff --git a/src/renderer/base/renderer.cpp b/src/renderer/base/renderer.cpp\nindex c44216ac470..31ab5a410e3 100644\n--- a/src/renderer/base/renderer.cpp\n+++ b/src/renderer/base/renderer.cpp\n@@ -342,9 +342,8 @@ try\n             const til::rect vp{ _viewport.ToExclusive() };\r\n             for (auto&& sp : spans)\r\n             {\r\n-                sp.iterate_rows(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n+                sp.iterate_rows_exclusive(bufferWidth, [&](til::CoordType row, til::CoordType min, til::CoordType max) {\r\n                     const auto shift = buffer.GetLineRendition(row) != LineRendition::SingleWidth ? 1 : 0;\r\n-                    max += 1; // Selection spans are inclusive (still)\r\n                     min <<= shift;\r\n                     max <<= shift;\r\n                     til::rect r{ min, row, max, row + 1 };\r\ndiff --git a/src/types/TermControlUiaProvider.cpp b/src/types/TermControlUiaProvider.cpp\nindex 34bd94f9404..3e4091bd963 100644\n--- a/src/types/TermControlUiaProvider.cpp\n+++ b/src/types/TermControlUiaProvider.cpp\n@@ -157,14 +157,8 @@ HRESULT TermControlUiaProvider::GetSelectionRange(_In_ IRawElementProviderSimple\n     RETURN_HR_IF_NULL(E_INVALIDARG, ppUtr);\r\n     *ppUtr = nullptr;\r\n \r\n-    const auto start = _pData->GetSelectionAnchor();\r\n-\r\n-    // we need to make end exclusive\r\n-    auto end = _pData->GetSelectionEnd();\r\n-    _pData->GetTextBuffer().GetSize().IncrementInBounds(end, true);\r\n-\r\n     TermControlUiaTextRange* result = nullptr;\r\n-    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, start, end, _pData->IsBlockSelection(), wordDelimiters));\r\n+    RETURN_IF_FAILED(MakeAndInitialize<TermControlUiaTextRange>(&result, _pData, pProvider, _pData->GetSelectionAnchor(), _pData->GetSelectionEnd(), _pData->IsBlockSelection(), wordDelimiters));\r\n     *ppUtr = result;\r\n     return S_OK;\r\n }\r\ndiff --git a/src/types/UiaTextRangeBase.cpp b/src/types/UiaTextRangeBase.cpp\nindex 0ce958e6985..9b3d7040a5e 100644\n--- a/src/types/UiaTextRangeBase.cpp\n+++ b/src/types/UiaTextRangeBase.cpp\n@@ -972,7 +972,7 @@ CATCH_RETURN();\n // Return Value:\r\n // - the text that the UiaTextRange encompasses\r\n #pragma warning(push)\r\n-#pragma warning(disable : 26447) // compiler isn't filtering throws inside the try/catch\r\n+#pragma warning(disable : 26440) // The function ... can be declared as noexcept.\r\n std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\r\n {\r\n     std::wstring textData{};\r\n@@ -987,13 +987,12 @@ std::wstring UiaTextRangeBase::_getTextValue(til::CoordType maxLength) const\n \r\n         // TODO GH#5406: create a different UIA parent object for each TextBuffer\r\n         // nvaccess/nvda#11428: Ensure our endpoints are in bounds\r\n-        THROW_HR_IF(E_FAIL, !bufferSize.IsInBounds(_start, true) || !bufferSize.IsInBounds(_end, true));\r\n+        auto isValid = [&](const til::point& point) {\r\n+            return bufferSize.IsInExclusiveBounds(point) || point == bufferSize.EndExclusive();\r\n+        };\r\n+        THROW_HR_IF(E_FAIL, !isValid(_start) || !isValid(_end));\r\n \r\n-        // convert _end to be inclusive\r\n-        auto inclusiveEnd = _end;\r\n-        bufferSize.DecrementInBounds(inclusiveEnd, true);\r\n-\r\n-        const auto req = TextBuffer::CopyRequest{ buffer, _start, inclusiveEnd, _blockRange, true, false, false, true };\r\n+        const auto req = TextBuffer::CopyRequest{ buffer, _start, _end, _blockRange, true, false, false, true };\r\n         auto plainText = buffer.GetPlainText(req);\r\n \r\n         if (plainText.size() > maxLengthAsSize)\r\ndiff --git a/src/types/inc/viewport.hpp b/src/types/inc/viewport.hpp\nindex fd0d5b302f8..0f1ea0bdeb8 100644\n--- a/src/types/inc/viewport.hpp\n+++ b/src/types/inc/viewport.hpp\n@@ -41,20 +41,26 @@ namespace Microsoft::Console::Types\n         til::point Origin() const noexcept;\r\n         til::point BottomRightInclusive() const noexcept;\r\n         til::point BottomRightExclusive() const noexcept;\r\n+        til::point BottomInclusiveRightExclusive() const noexcept;\r\n         til::point EndExclusive() const noexcept;\r\n         til::size Dimensions() const noexcept;\r\n \r\n         bool IsInBounds(const Viewport& other) const noexcept;\r\n         bool IsInBounds(const til::point pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IsInExclusiveBounds(const til::point pos) const noexcept;\r\n \r\n         void Clamp(til::point& pos) const;\r\n         Viewport Clamp(const Viewport& other) const noexcept;\r\n \r\n         bool IncrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n         bool DecrementInBounds(til::point& pos, bool allowEndExclusive = false) const noexcept;\r\n+        bool IncrementInExclusiveBounds(til::point& pos) const noexcept;\r\n+        bool DecrementInExclusiveBounds(til::point& pos) const noexcept;\r\n         int CompareInBounds(const til::point first, const til::point second, bool allowEndExclusive = false) const noexcept;\r\n+        int CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept;\r\n \r\n         bool WalkInBounds(til::point& pos, const til::CoordType delta, bool allowEndExclusive = false) const noexcept;\r\n+        bool WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept;\r\n         til::point GetWalkOrigin(const til::CoordType delta) const noexcept;\r\n         static til::CoordType DetermineWalkDirection(const Viewport& source, const Viewport& target) noexcept;\r\n \r\ndiff --git a/src/types/viewport.cpp b/src/types/viewport.cpp\nindex 30c5307dd14..ce4b38565eb 100644\n--- a/src/types/viewport.cpp\n+++ b/src/types/viewport.cpp\n@@ -118,6 +118,11 @@ til::point Viewport::BottomRightExclusive() const noexcept\n     return { RightExclusive(), BottomExclusive() };\r\n }\r\n \r\n+til::point Viewport::BottomInclusiveRightExclusive() const noexcept\r\n+{\r\n+    return { RightExclusive(), BottomInclusive() };\r\n+}\r\n+\r\n // Method Description:\r\n // - For Accessibility, get a til::point representing the end of this viewport in exclusive terms.\r\n // - This is needed to represent an exclusive endpoint in UiaTextRange that includes the last\r\n@@ -295,6 +300,61 @@ bool Viewport::WalkInBounds(til::point& pos, const til::CoordType delta, bool al\n     return off == offClamped;\r\n }\r\n \r\n+bool Viewport::IncrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, 1);\r\n+}\r\n+\r\n+bool Viewport::DecrementInExclusiveBounds(til::point& pos) const noexcept\r\n+{\r\n+    return WalkInExclusiveBounds(pos, -1);\r\n+}\r\n+\r\n+bool Viewport::IsInExclusiveBounds(const til::point pos) const noexcept\r\n+{\r\n+    return pos.x >= Left() && pos.x <= RightExclusive() &&\r\n+           pos.y >= Top() && pos.y <= BottomInclusive();\r\n+}\r\n+\r\n+int Viewport::CompareInExclusiveBounds(const til::point first, const til::point second) const noexcept\r\n+{\r\n+    // Assert that our coordinates are within the expected boundaries\r\n+    assert(IsInExclusiveBounds(first));\r\n+    assert(IsInExclusiveBounds(second));\r\n+\r\n+    // First set the distance vertically\r\n+    //   If first is on row 4 and second is on row 6, first will be -2 rows behind second * an 80 character row would be -160.\r\n+    //   For the same row, it'll be 0 rows * 80 character width = 0 difference.\r\n+    auto retVal = (first.y - second.y) * Width();\r\n+\r\n+    // Now adjust for horizontal differences\r\n+    //   If first is in position 15 and second is in position 30, first is -15 left in relation to 30.\r\n+    retVal += (first.x - second.x);\r\n+\r\n+    // Further notes:\r\n+    //   If we already moved behind one row, this will help correct for when first is right of second.\r\n+    //     For example, with row 4, col 79 and row 5, col 0 as first and second respectively, the distance is -1.\r\n+    //     Assume the row width is 80.\r\n+    //     Step one will set the retVal as -80 as first is one row behind the second.\r\n+    //     Step two will then see that first is 79 - 0 = +79 right of second and add 79\r\n+    //     The total is -80 + 79 = -1.\r\n+    return retVal;\r\n+}\r\n+\r\n+bool Viewport::WalkInExclusiveBounds(til::point& pos, const til::CoordType delta) const noexcept\r\n+{\r\n+    const auto l = static_cast<ptrdiff_t>(_sr.left);\r\n+    const auto t = static_cast<ptrdiff_t>(_sr.top);\r\n+    const auto w = static_cast<ptrdiff_t>(std::max(0, _sr.right - _sr.left + 2));\r\n+    const auto h = static_cast<ptrdiff_t>(std::max(0, _sr.bottom - _sr.top + 1));\r\n+    const auto max = w * h;\r\n+    const auto off = w * (pos.y - t) + (pos.x - l) + delta;\r\n+    const auto offClamped = std::clamp(off, ptrdiff_t{ 0 }, max);\r\n+    pos.x = gsl::narrow_cast<til::CoordType>(offClamped % w + l);\r\n+    pos.y = gsl::narrow_cast<til::CoordType>(offClamped / w + t);\r\n+    return off == offClamped;\r\n+}\r\n+\r\n // Routine Description:\r\n // - If walking through a viewport, one might want to know the origin\r\n //   for the direction walking.\r\n", "instance_id": "microsoft__terminal-18106", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the screen reader in Windows Terminal does not announce full word information when navigating in mark mode using Ctrl + Left/Right arrow keys, instead only announcing single characters. It provides specific steps to reproduce, expected behavior, actual behavior, and references to accessibility guidelines (WCAG). However, it lacks some critical details, such as explicit mention of specific edge cases (e.g., behavior with non-ASCII characters, wrapped lines, or empty buffers) and constraints on the solution (e.g., performance requirements or compatibility with other features). Additionally, while the problem is tied to accessibility, it does not specify the exact interaction with screen reader APIs or expected integration points, which could lead to minor ambiguities during implementation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., text buffer handling, selection logic, rendering, and UI interaction) in a complex codebase like Windows Terminal. The changes involve deep modifications to core components such as `TextBuffer`, `Terminal`, and `ControlInteractivity`, requiring a thorough understanding of how selection and navigation interact with the rendering and accessibility layers. Second, the problem demands knowledge of multiple technical concepts, including text buffer management, Unicode handling (e.g., wide glyphs, DBCS attributes), accessibility APIs (e.g., UIA), and screen reader integration, which are non-trivial and require domain-specific expertise. Third, the code changes impact critical functionality (selection and navigation), necessitating careful handling of numerous edge cases such as wide characters, line wrapping, buffer boundaries, and different selection modes (char, word, line). Finally, the solution must ensure compatibility with existing features and maintain performance, adding to the complexity. While not at the extreme end of difficulty (e.g., requiring system-level redesign), this problem demands a deep understanding of the codebase architecture and careful implementation, justifying a score of 0.75.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Windows Terminal - Settings]: In dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n27695.1000\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 27695.1000)\r\nApp: Windows Terminal Preview\n\n### Steps to reproduce\n\n**Prerequisites:**\r\nSettings> Personalization> Colors> Choose your Mode> Dark Mode.\r\n\r\n**Repro steps:**\r\n1. Open the 'windows terminal' application.\r\n2. Apply dark mode by following the prerequisites.\r\n3. Now open 'Setting' and activate 'Startup' tab.\r\n4. Navigate to the 'Defaults' tab and activate it.\r\n5. Now navigate to the 'Appearance' button and activate it.\r\n6. Now navigate to any control like 'Line height' and change value.\r\n7. 'Reset to inherited value' button will appear.\r\n8. Open Accessibility Insights for windows and check contrast ratio of 'Reset to inherited value' icon. \r\n9. Observe the issue.\r\n\r\n**User experience:**\r\nLow vision users will find difficulty in tracking the control, if contrast ratio for the control's icon is less than '3:1' (Required).\r\n\r\n**WCAG Reference Link:**\r\n[[MAS 4.3.1 – No Disruption of Accessibility Features.docx (sharepoint.com)](https://microsoft.sharepoint.com/:w:/s/accessibility/EegntkLK4KBBvzE1qsKpIoABG2UIxUY2y3uo1LomKoz_bg?e=wLbDEr)](https://www.w3.org/WAI/WCAG22/Understanding/non-text-contrast)\r\n\r\n**Attachment:**\r\n[MAS1.4.11 - In Dark mode, cca failed for 'Reset to inherited value' button..zip](https://github.com/user-attachments/files/16959865/MAS1.4.11.-.In.Dark.mode.cca.failed.for.Reset.to.inherited.value.button.zip)\n\n### Expected Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon should be greater than or equal to 3:1. \n\n### Actual Behavior\n\nIn dark mode, Luminosity ratio for 'Reset to inherited value' icon is '2.6:1', which is less than required '3:1'.\r\n\r\n**Note:**\r\nSame issue repro for all 'Reset to inherited value' button's icon throughout.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\nindex 0e12e7d3de7..72b254e4e41 100644\n--- a/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/SettingContainerStyle.xaml\n@@ -44,6 +44,9 @@\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n \r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorDark2\" />\r\n+\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"HighContrast\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -73,6 +76,9 @@\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"SystemColorWindowTextColorBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight1\" />\r\n         </ResourceDictionary>\r\n         <ResourceDictionary x:Key=\"Dark\">\r\n             <Style x:Key=\"SecondaryTextBlockStyle\"\r\n@@ -106,6 +112,9 @@\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n             <StaticResource x:Key=\"SettingContainerMessageForeground\"\r\n                             ResourceKey=\"TextFillColorPrimaryBrush\" />\r\n+\r\n+            <StaticResource x:Key=\"SettingContainerResetButtonIconForeground\"\r\n+                            ResourceKey=\"SystemAccentColorLight2\" />\r\n         </ResourceDictionary>\r\n     </ResourceDictionary.ThemeDictionaries>\r\n \r\n@@ -136,7 +145,7 @@\n \r\n     <Style x:Key=\"SettingContainerFontIconStyle\"\r\n            TargetType=\"FontIcon\">\r\n-        <Setter Property=\"Foreground\" Value=\"{StaticResource SystemAccentColor}\" />\r\n+        <Setter Property=\"Foreground\" Value=\"{ThemeResource SettingContainerResetButtonIconForeground}\" />\r\n         <Setter Property=\"FontSize\" Value=\"11\" />\r\n         <Setter Property=\"FontFamily\" Value=\"{ThemeResource SymbolThemeFontFamily}\" />\r\n     </Style>\r\n", "instance_id": "microsoft__terminal-17912", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the context (Windows Terminal in dark mode), the specific problem (luminosity ratio of the 'Reset to inherited value' icon being below the required 3:1), steps to reproduce, expected behavior, and actual behavior. It also references accessibility guidelines (WCAG) and includes attachments for further context. However, there are minor ambiguities: the problem statement does not explicitly discuss potential challenges in adjusting the contrast ratio (e.g., whether changing colors might conflict with other UI elements or themes) or specify if there are constraints on which colors can be used to achieve the required ratio. Additionally, edge cases such as behavior in other themes or high-contrast modes are not fully addressed in the statement, though the code changes partially account for them. Overall, the statement is valid and clear but lacks some minor details that could impact implementation.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling in the easy range (0.2-0.4). The issue involves adjusting the foreground color of an icon to meet accessibility contrast ratio requirements, which is a straightforward UI tweak. The code changes are confined to a single file (SettingContainerStyle.xaml) and involve minimal modifications—adding theme-specific resource definitions for the icon foreground color and updating a style setter to use the new resource. This requires basic understanding of XAML (Extensible Application Markup Language) for Windows UI development and familiarity with theme dictionaries and resource usage, but no complex algorithms, design patterns, or deep architectural changes are needed. The scope of the change is small, with no impact on the broader system architecture or interactions between modules. While the problem touches on accessibility (an important domain-specific concept), the technical implementation is simple. Edge cases, such as ensuring the new colors work across different themes (Dark, Light, High Contrast), are implicitly handled in the code changes but do not add significant complexity. Overall, this is a simple bug fix requiring minimal effort and expertise beyond basic UI development skills.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Can't off feature \"Auto recognize URLs\"\n### Windows Terminal version\n\n1.22.2281.0\n\n### Windows build number\n\n10.0.19045.3448\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nbroken features:\r\n\"experimental.detectURLs\": false,\r\n\r\nwork fine:\r\nMicrosoft.WindowsTerminal_1.17.11461.0_x64.zip\r\nMicrosoft.WindowsTerminal_1.18.2681.0_x64.zip\r\n\r\n\r\nbroken:\r\nMicrosoft.WindowsTerminal_1.19.10302.0_x64.zip\r\n...\r\nMicrosoft.WindowsTerminal_1.20.11781.0_x64.zip\r\n\r\nlatest Canary terminal-1.22.2281.0 also broken\r\n\r\n\r\ntest URL:\r\nhttps://aka.ms/terminal-documentation\r\n\n\n### Expected Behavior\n\nrecognized URLs are not highlighted\n\n### Actual Behavior\n\nrecognized URLs is highlighted\r\nanyway\r\n\r\nwhen \r\n\"experimental.detectURLs\": false,\r\nor\r\n\"experimental.detectURLs\": true,\n", "patch": "diff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex a7530807d07..87236331fca 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1425,6 +1425,11 @@ PointTree Terminal::_getPatterns(til::CoordType beg, til::CoordType end) const\n         LR\"(\\b(?:https?|ftp|file)://[-A-Za-z0-9+&@#/%?=~_|$!:,.;]*[A-Za-z0-9+&@#/%=~_|$])\",\r\n     };\r\n \r\n+    if (!_detectURLs)\r\n+    {\r\n+        return {};\r\n+    }\r\n+\r\n     auto text = ICU::UTextFromTextBuffer(_activeBuffer(), beg, end + 1);\r\n     UErrorCode status = U_ZERO_ERROR;\r\n     PointTree::interval_vector intervals;\r\ndiff --git a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\nindex 827c4da85ce..ac9841369db 100644\n--- a/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n+++ b/src/cascadia/UnitTests_TerminalCore/TerminalBufferTests.cpp\n@@ -607,6 +607,13 @@ void TerminalBufferTests::TestURLPatternDetection()\n     constexpr auto urlStartX = BeforeStr.size();\r\n     constexpr auto urlEndX = BeforeStr.size() + UrlStr.size() - 1;\r\n \r\n+    // This is off by default; turn it on for the test.\r\n+    auto originalDetectURLs = term->_detectURLs;\r\n+    auto restoreDetectUrls = wil::scope_exit([&]() {\r\n+        term->_detectURLs = originalDetectURLs;\r\n+    });\r\n+    term->_detectURLs = true;\r\n+\r\n     auto& termSm = *term->_stateMachine;\r\n     termSm.ProcessString(fmt::format(FMT_COMPILE(L\"{}{}{}\"), BeforeStr, UrlStr, AfterStr));\r\n     term->UpdatePatternsUnderLock();\r\n", "instance_id": "microsoft__terminal-17731", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"Auto recognize URLs\" feature in Windows Terminal does not respect the configuration setting \"experimental.detectURLs\": false, and URLs are still highlighted despite the setting. The expected behavior (URLs should not be highlighted when the setting is false) and actual behavior (URLs are highlighted regardless of the setting) are explicitly stated, which provides a clear goal for the fix. Additionally, specific version numbers where the feature works and where it is broken are provided, along with a test URL for reproduction. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this issue occurs under specific conditions (e.g., certain terminal profiles, themes, or input types) or if there are any related side effects. Edge cases, such as malformed URLs or specific text rendering scenarios, are not mentioned. While the issue is reproducible based on the provided information, these missing details prevent the statement from being fully comprehensive.", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Let's break this down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to two files: `Terminal.cpp` and `TerminalBufferTests.cpp`. In `Terminal.cpp`, the fix involves adding a conditional check to return an empty `PointTree` if URL detection is disabled, effectively preventing URL pattern matching. In `TerminalBufferTests.cpp`, the change ensures the test explicitly enables URL detection to maintain test validity. These modifications are straightforward, affecting only a small part of the codebase without impacting the broader system architecture or requiring extensive refactoring.\n\n2. **Number of Technical Concepts**: The solution requires basic understanding of C++ (control flow with conditionals), familiarity with the Windows Terminal codebase's internal state (specifically the `_detectURLs` flag), and minimal knowledge of how pattern detection works in the terminal (returning an empty result to disable highlighting). No advanced algorithms, design patterns, or domain-specific knowledge are needed beyond basic terminal rendering logic.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce or handle any complex error conditions. The fix is a simple early return, which inherently avoids further processing and thus minimizes the risk of edge case issues. However, a developer might need to consider whether disabling URL detection could inadvertently affect other features (e.g., text selection or rendering), but this is not evident from the provided diff or problem statement.\n\n4. **Overall Complexity**: The issue is a straightforward bug fix that involves toggling behavior based on a configuration flag. It does not require deep understanding of the codebase beyond the specific function being modified, nor does it involve performance optimization, complex data structures, or cross-module interactions.\n\nGiven these factors, a difficulty score of 0.25 reflects the simplicity of the fix, requiring only basic code modifications and minimal understanding of the surrounding logic. It is slightly above the \"Very Easy\" range due to the need to understand the context of URL detection and ensure the test code is updated accordingly, but it remains an easy task for a developer familiar with C++ and the Windows Terminal codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Gaps between block elements when using Direct2D\n### Windows Terminal version\r\n\r\nCurrent main\r\n\r\n### Windows build number\r\n\r\n10.0.19045.4291\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\n- System-wide scale and layout (display settings): 100%\r\n- WT PowerShell profile settings:\r\n  - Font face: \"Cascadia Mono\"\r\n  - Font size: \"12.2\"\r\n  - Line height: \"1.2\"\r\n  - Font weight: \"Normal\"\r\n  - Builtin Glyphs: \"On\"\r\n  - ![image](https://github.com/microsoft/terminal/assets/11535558/c5d3dcab-d3f3-4928-bb64-b5106f9c4eec)\r\n  - Graphics API: \"Direct2D\"\r\n  - ![image](https://github.com/microsoft/terminal/assets/11535558/92c17826-e955-4155-8c98-57ecbd565c40)\r\n\r\n- Type \"▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄\" at the pwsh prompt\r\n  ```pwsh\r\n  \"▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄\"\r\n  ```\r\n\r\n\r\n### Expected Behavior\r\n\r\n[Block elements](https://unicode.org/charts/PDF/U2580.pdf) are fused into a solid bar.\r\n\r\n### Actual Behavior\r\n\r\n![image](https://github.com/microsoft/terminal/assets/11535558/41b56b19-9f19-4300-a76c-f1022d65926f)\r\n\n", "patch": "diff --git a/src/renderer/atlas/AtlasEngine.cpp b/src/renderer/atlas/AtlasEngine.cpp\nindex 28295aeadd2..b5a89f6c09d 100644\n--- a/src/renderer/atlas/AtlasEngine.cpp\n+++ b/src/renderer/atlas/AtlasEngine.cpp\n@@ -74,9 +74,8 @@ try\n         _handleSettingsUpdate();\r\n     }\r\n \r\n-    if (ATLAS_DEBUG_DISABLE_PARTIAL_INVALIDATION || _hackTriggerRedrawAll)\r\n+    if constexpr (ATLAS_DEBUG_DISABLE_PARTIAL_INVALIDATION)\r\n     {\r\n-        _hackTriggerRedrawAll = false;\r\n         _api.invalidatedRows = invalidatedRowsAll;\r\n         _api.scrollOffset = 0;\r\n     }\r\n@@ -703,8 +702,6 @@ void AtlasEngine::_recreateFontDependentResources()\n             _api.textFormatAxes[i] = { fontAxisValues.data(), fontAxisValues.size() };\r\n         }\r\n     }\r\n-\r\n-    _hackWantsBuiltinGlyphs = _p.s->font->builtinGlyphs && !_hackIsBackendD2D;\r\n }\r\n \r\n void AtlasEngine::_recreateCellCountDependentResources()\r\n@@ -765,18 +762,13 @@ void AtlasEngine::_flushBufferLine()\n     // This would seriously blow us up otherwise.\r\n     Expects(_api.bufferLineColumn.size() == _api.bufferLine.size() + 1);\r\n \r\n+    const auto builtinGlyphs = _p.s->font->builtinGlyphs;\r\n     const auto beg = _api.bufferLine.data();\r\n     const auto len = _api.bufferLine.size();\r\n     size_t segmentBeg = 0;\r\n     size_t segmentEnd = 0;\r\n     bool custom = false;\r\n \r\n-    if (!_hackWantsBuiltinGlyphs)\r\n-    {\r\n-        _mapRegularText(0, len);\r\n-        return;\r\n-    }\r\n-\r\n     while (segmentBeg < len)\r\n     {\r\n         segmentEnd = segmentBeg;\r\n@@ -789,7 +781,7 @@ void AtlasEngine::_flushBufferLine()\n                 codepoint = til::combine_surrogates(codepoint, beg[i++]);\r\n             }\r\n \r\n-            const auto c = BuiltinGlyphs::IsBuiltinGlyph(codepoint) || BuiltinGlyphs::IsSoftFontChar(codepoint);\r\n+            const auto c = (builtinGlyphs && BuiltinGlyphs::IsBuiltinGlyph(codepoint)) || BuiltinGlyphs::IsSoftFontChar(codepoint);\r\n             if (custom != c)\r\n             {\r\n                 break;\r\ndiff --git a/src/renderer/atlas/AtlasEngine.h b/src/renderer/atlas/AtlasEngine.h\nindex 1f26644ebe6..ccb4da9fb4e 100644\n--- a/src/renderer/atlas/AtlasEngine.h\n+++ b/src/renderer/atlas/AtlasEngine.h\n@@ -127,18 +127,6 @@ namespace Microsoft::Console::Render::Atlas\n         std::unique_ptr<IBackend> _b;\r\n         RenderingPayload _p;\r\n \r\n-        // _p.s->font->builtinGlyphs is the setting which decides whether we should map box drawing glyphs to\r\n-        // our own builtin versions. There's just one problem: BackendD2D doesn't have this functionality.\r\n-        // But since AtlasEngine shapes the text before it's handed to the backends, it would need to know\r\n-        // whether BackendD2D is in use, before BackendD2D even exists. These two flags solve the issue\r\n-        // by triggering a complete, immediate redraw whenever the backend type changes.\r\n-        //\r\n-        // The proper solution is to move text shaping into the backends.\r\n-        // Someone just needs to write a generic \"TextBuffer to DWRITE_GLYPH_RUN\" function.\r\n-        bool _hackIsBackendD2D = false;\r\n-        bool _hackWantsBuiltinGlyphs = true;\r\n-        bool _hackTriggerRedrawAll = false;\r\n-\r\n         struct ApiState\r\n         {\r\n             GenerationalSettings s = DirtyGenerationalSettings();\r\ndiff --git a/src/renderer/atlas/AtlasEngine.r.cpp b/src/renderer/atlas/AtlasEngine.r.cpp\nindex a0dbdcc5470..3591abe7905 100644\n--- a/src/renderer/atlas/AtlasEngine.r.cpp\n+++ b/src/renderer/atlas/AtlasEngine.r.cpp\n@@ -77,7 +77,7 @@ CATCH_RETURN()\n \r\n [[nodiscard]] bool AtlasEngine::RequiresContinuousRedraw() noexcept\r\n {\r\n-    return ATLAS_DEBUG_CONTINUOUS_REDRAW || (_b && _b->RequiresContinuousRedraw()) || _hackTriggerRedrawAll;\r\n+    return ATLAS_DEBUG_CONTINUOUS_REDRAW || (_b && _b->RequiresContinuousRedraw());\r\n }\r\n \r\n void AtlasEngine::WaitUntilCanRender() noexcept\r\n@@ -282,21 +282,15 @@ void AtlasEngine::_recreateBackend()\n     {\r\n     case GraphicsAPI::Direct2D:\r\n         _b = std::make_unique<BackendD2D>();\r\n-        _hackIsBackendD2D = true;\r\n         break;\r\n     default:\r\n         _b = std::make_unique<BackendD3D>(_p);\r\n-        _hackIsBackendD2D = false;\r\n         break;\r\n     }\r\n \r\n     // This ensures that the backends redraw their entire viewports whenever a new swap chain is created,\r\n     // EVEN IF we got called when no actual settings changed (i.e. rendering failure, etc.).\r\n     _p.MarkAllAsDirty();\r\n-\r\n-    const auto hackWantsBuiltinGlyphs = _p.s->font->builtinGlyphs && !_hackIsBackendD2D;\r\n-    _hackTriggerRedrawAll = _hackWantsBuiltinGlyphs != hackWantsBuiltinGlyphs;\r\n-    _hackWantsBuiltinGlyphs = hackWantsBuiltinGlyphs;\r\n }\r\n \r\n void AtlasEngine::_handleSwapChainUpdate()\r\ndiff --git a/src/renderer/atlas/BackendD2D.cpp b/src/renderer/atlas/BackendD2D.cpp\nindex 5a663b49d04..cf7bd8a2bec 100644\n--- a/src/renderer/atlas/BackendD2D.cpp\n+++ b/src/renderer/atlas/BackendD2D.cpp\n@@ -4,6 +4,8 @@\n #include \"pch.h\"\r\n #include \"BackendD2D.h\"\r\n \r\n+#include <til/unicode.h>\r\n+\r\n #if ATLAS_DEBUG_SHOW_DIRTY\r\n #include \"colorbrewer.h\"\r\n #endif\r\n@@ -94,11 +96,15 @@ void BackendD2D::_handleSettingsUpdate(const RenderingPayload& p)\n                 .dpiY = static_cast<f32>(p.s->font->dpi),\r\n             };\r\n             // ID2D1RenderTarget and ID2D1DeviceContext are the same and I'm tired of pretending they're not.\r\n-            THROW_IF_FAILED(p.d2dFactory->CreateDxgiSurfaceRenderTarget(surface.get(), &props, reinterpret_cast<ID2D1RenderTarget**>(_renderTarget.addressof())));\r\n-            _renderTarget.try_query_to(_renderTarget4.addressof());\r\n+            THROW_IF_FAILED(p.d2dFactory->CreateDxgiSurfaceRenderTarget(surface.get(), &props, reinterpret_cast<ID2D1RenderTarget**>(_renderTarget.put())));\r\n \r\n             _renderTarget->SetUnitMode(D2D1_UNIT_MODE_PIXELS);\r\n-            _renderTarget->SetAntialiasMode(D2D1_ANTIALIAS_MODE_ALIASED);\r\n+\r\n+            _renderTarget.try_query_to(_renderTarget4.put());\r\n+            if (_renderTarget4)\r\n+            {\r\n+                THROW_IF_FAILED(_renderTarget4->CreateSpriteBatch(_builtinGlyphBatch.put()));\r\n+            }\r\n         }\r\n         {\r\n             static constexpr D2D1_COLOR_F color{};\r\n@@ -108,18 +114,15 @@ void BackendD2D::_handleSettingsUpdate(const RenderingPayload& p)\n         }\r\n     }\r\n \r\n-    if (!_dottedStrokeStyle)\r\n-    {\r\n-        static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n-        static constexpr FLOAT dashes[2]{ 1, 1 };\r\n-        THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dottedStrokeStyle.addressof()));\r\n-    }\r\n-\r\n     if (renderTargetChanged || fontChanged)\r\n     {\r\n         const auto dpi = static_cast<f32>(p.s->font->dpi);\r\n         _renderTarget->SetDpi(dpi, dpi);\r\n         _renderTarget->SetTextAntialiasMode(static_cast<D2D1_TEXT_ANTIALIAS_MODE>(p.s->font->antialiasingMode));\r\n+\r\n+        _builtinGlyphsRenderTarget.reset();\r\n+        _builtinGlyphsBitmap.reset();\r\n+        _builtinGlyphsRenderTargetActive = false;\r\n     }\r\n \r\n     if (renderTargetChanged || fontChanged || cellCountChanged)\r\n@@ -199,6 +202,12 @@ void BackendD2D::_drawText(RenderingPayload& p)\n \r\n         for (const auto& m : row->mappings)\r\n         {\r\n+            if (!m.fontFace)\r\n+            {\r\n+                baselineX = _drawBuiltinGlyphs(p, row, m, baselineY, baselineX);\r\n+                continue;\r\n+            }\r\n+\r\n             const auto colorsBegin = row->colors.begin();\r\n             auto it = colorsBegin + m.glyphsFrom;\r\n             const auto end = colorsBegin + m.glyphsTo;\r\n@@ -228,42 +237,39 @@ void BackendD2D::_drawText(RenderingPayload& p)\n                     baselineY,\r\n                 };\r\n \r\n-                if (glyphRun.fontFace)\r\n+                D2D1_RECT_F bounds = GlyphRunEmptyBounds;\r\n+                wil::com_ptr<IDWriteColorGlyphRunEnumerator1> enumerator;\r\n+\r\n+                if (p.s->font->colorGlyphs)\r\n                 {\r\n-                    D2D1_RECT_F bounds = GlyphRunEmptyBounds;\r\n-                    wil::com_ptr<IDWriteColorGlyphRunEnumerator1> enumerator;\r\n+                    enumerator = TranslateColorGlyphRun(p.dwriteFactory4.get(), baselineOrigin, &glyphRun);\r\n+                }\r\n \r\n-                    if (p.s->font->colorGlyphs)\r\n+                if (enumerator)\r\n+                {\r\n+                    while (ColorGlyphRunMoveNext(enumerator.get()))\r\n                     {\r\n-                        enumerator = TranslateColorGlyphRun(p.dwriteFactory4.get(), baselineOrigin, &glyphRun);\r\n+                        const auto colorGlyphRun = ColorGlyphRunGetCurrentRun(enumerator.get());\r\n+                        ColorGlyphRunDraw(_renderTarget4.get(), _emojiBrush.get(), brush, colorGlyphRun);\r\n+                        ColorGlyphRunAccumulateBounds(_renderTarget.get(), colorGlyphRun, bounds);\r\n                     }\r\n+                }\r\n+                else\r\n+                {\r\n+                    _renderTarget->DrawGlyphRun(baselineOrigin, &glyphRun, brush, DWRITE_MEASURING_MODE_NATURAL);\r\n+                    GlyphRunAccumulateBounds(_renderTarget.get(), baselineOrigin, &glyphRun, bounds);\r\n+                }\r\n \r\n-                    if (enumerator)\r\n-                    {\r\n-                        while (ColorGlyphRunMoveNext(enumerator.get()))\r\n-                        {\r\n-                            const auto colorGlyphRun = ColorGlyphRunGetCurrentRun(enumerator.get());\r\n-                            ColorGlyphRunDraw(_renderTarget4.get(), _emojiBrush.get(), brush, colorGlyphRun);\r\n-                            ColorGlyphRunAccumulateBounds(_renderTarget.get(), colorGlyphRun, bounds);\r\n-                        }\r\n-                    }\r\n-                    else\r\n+                if (bounds.top < bounds.bottom)\r\n+                {\r\n+                    // Since we used SetUnitMode(D2D1_UNIT_MODE_PIXELS), bounds.top/bottom is in pixels already and requires no conversion/rounding.\r\n+                    if (row->lineRendition != LineRendition::DoubleHeightTop)\r\n                     {\r\n-                        _renderTarget->DrawGlyphRun(baselineOrigin, &glyphRun, brush, DWRITE_MEASURING_MODE_NATURAL);\r\n-                        GlyphRunAccumulateBounds(_renderTarget.get(), baselineOrigin, &glyphRun, bounds);\r\n+                        row->dirtyBottom = std::max(row->dirtyBottom, static_cast<i32>(lrintf(bounds.bottom)));\r\n                     }\r\n-\r\n-                    if (bounds.top < bounds.bottom)\r\n+                    if (row->lineRendition != LineRendition::DoubleHeightBottom)\r\n                     {\r\n-                        // Since we used SetUnitMode(D2D1_UNIT_MODE_PIXELS), bounds.top/bottom is in pixels already and requires no conversion/rounding.\r\n-                        if (row->lineRendition != LineRendition::DoubleHeightTop)\r\n-                        {\r\n-                            row->dirtyBottom = std::max(row->dirtyBottom, static_cast<i32>(lrintf(bounds.bottom)));\r\n-                        }\r\n-                        if (row->lineRendition != LineRendition::DoubleHeightBottom)\r\n-                        {\r\n-                            row->dirtyTop = std::min(row->dirtyTop, static_cast<i32>(lrintf(bounds.top)));\r\n-                        }\r\n+                        row->dirtyTop = std::min(row->dirtyTop, static_cast<i32>(lrintf(bounds.top)));\r\n                     }\r\n                 }\r\n \r\n@@ -274,6 +280,8 @@ void BackendD2D::_drawText(RenderingPayload& p)\n             }\r\n         }\r\n \r\n+        _flushBuiltinGlyphs();\r\n+\r\n         if (!row->gridLineRanges.empty())\r\n         {\r\n             _drawGridlineRow(p, row, y);\r\n@@ -300,6 +308,160 @@ void BackendD2D::_drawText(RenderingPayload& p)\n     }\r\n }\r\n \r\n+f32 BackendD2D::_drawBuiltinGlyphs(const RenderingPayload& p, const ShapedRow* row, const FontMapping& m, f32 baselineY, f32 baselineX)\r\n+{\r\n+    const f32 cellTop = baselineY - p.s->font->baseline;\r\n+    const f32 cellBottom = cellTop + p.s->font->cellSize.y;\r\n+    const f32 cellWidth = p.s->font->cellSize.x;\r\n+\r\n+    _prepareBuiltinGlyphRenderTarget(p);\r\n+\r\n+    for (size_t i = m.glyphsFrom; i < m.glyphsTo; ++i)\r\n+    {\r\n+        // This code runs when fontFace == nullptr. This is only the case for builtin glyphs which then use the glyphIndices\r\n+        // to store UTF16 code points. In other words, this doesn't accidentally corrupt any actual glyph indices.\r\n+        u32 ch = row->glyphIndices[i];\r\n+        if (til::is_leading_surrogate(ch))\r\n+        {\r\n+            i += 1;\r\n+            ch = til::combine_surrogates(ch, row->glyphIndices[i]);\r\n+        }\r\n+\r\n+        // If we don't have support for ID2D1SpriteBatch we don't support builtin glyphs.\r\n+        // But we do still need to account for the glyphAdvances, which is why we can't just skip everything.\r\n+        // It's very unlikely for a target device to not support ID2D1SpriteBatch as it's very old at this point.\r\n+        if (_builtinGlyphBatch)\r\n+        {\r\n+            if (const auto off = BuiltinGlyphs::GetBitmapCellIndex(ch); off >= 0)\r\n+            {\r\n+                const D2D1_RECT_F dst{ baselineX, cellTop, baselineX + cellWidth, cellBottom };\r\n+                const auto src = _prepareBuiltinGlyph(p, ch, off);\r\n+                const auto color = colorFromU32(row->colors[i]);\r\n+                THROW_IF_FAILED(_builtinGlyphBatch->AddSprites(1, &dst, &src, &color, nullptr, sizeof(D2D1_RECT_F), sizeof(D2D1_RECT_U), sizeof(D2D1_COLOR_F), sizeof(D2D1_MATRIX_3X2_F)));\r\n+            }\r\n+        }\r\n+\r\n+        baselineX += row->glyphAdvances[i];\r\n+    }\r\n+\r\n+    return baselineX;\r\n+}\r\n+\r\n+void BackendD2D::_prepareBuiltinGlyphRenderTarget(const RenderingPayload& p)\r\n+{\r\n+    // If we don't have support for ID2D1SpriteBatch none of the related members will be initialized or used.\r\n+    // We can just early-return in that case.\r\n+    if (!_builtinGlyphBatch)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    // If the render target is already created, all of the below has already been done in a previous frame.\r\n+    // Once the relevant settings change for some reason (primarily the font->cellSize), then _handleSettingsUpdate()\r\n+    // will reset the render target which will cause us to skip this condition and re-initialize it below.\r\n+    if (_builtinGlyphsRenderTarget)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto cellWidth = static_cast<u32>(p.s->font->cellSize.x);\r\n+    const auto cellHeight = static_cast<u32>(p.s->font->cellSize.y);\r\n+    const auto cellArea = cellWidth * cellHeight;\r\n+    const auto area = cellArea * BuiltinGlyphs::TotalCharCount;\r\n+\r\n+    // This block of code calculates the size of a power-of-2 texture that has an area larger than the given `area`.\r\n+    // For instance, for an area of 985x1946 = 1916810 it would result in a u/v of 2048x1024 (area = 2097152).\r\n+    // We throw the \"v\" in this case away, because we don't really need power-of-2 textures here,\r\n+    // but you can find the complete code over in BackendD3D. If someone deleted it in the meantime:\r\n+    //   const auto index = bitness_of_area_minus_1 - std::countl_zero(area - 1); // aka: _BitScanReverse\r\n+    //   const auto u = 1u << ((index + 2) / 2);\r\n+    //   const auto v = 1u << ((index + 1) / 2);\r\n+    unsigned long index;\r\n+    _BitScanReverse(&index, area - 1);\r\n+    const auto potWidth = 1u << ((index + 2) / 2);\r\n+\r\n+    const auto cellCountU = potWidth / cellWidth;\r\n+    const auto cellCountV = (BuiltinGlyphs::TotalCharCount + cellCountU - 1) / cellCountU;\r\n+    const auto u = cellCountU * cellWidth;\r\n+    const auto v = cellCountV * cellHeight;\r\n+\r\n+    const D2D1_SIZE_F sizeF{ static_cast<f32>(u), static_cast<f32>(v) };\r\n+    const D2D1_SIZE_U sizeU{ gsl::narrow_cast<UINT32>(u), gsl::narrow_cast<UINT32>(v) };\r\n+    static constexpr D2D1_PIXEL_FORMAT format{ DXGI_FORMAT_A8_UNORM, D2D1_ALPHA_MODE_PREMULTIPLIED };\r\n+    wil::com_ptr<ID2D1BitmapRenderTarget> target;\r\n+    THROW_IF_FAILED(_renderTarget->CreateCompatibleRenderTarget(&sizeF, &sizeU, &format, D2D1_COMPATIBLE_RENDER_TARGET_OPTIONS_NONE, target.addressof()));\r\n+\r\n+    THROW_IF_FAILED(target->GetBitmap(_builtinGlyphsBitmap.put()));\r\n+    _builtinGlyphsRenderTarget = target.query<ID2D1DeviceContext>();\r\n+    _builtinGlyphsBitmapCellCountU = cellCountU;\r\n+    _builtinGlyphsRenderTargetActive = false;\r\n+    memset(&_builtinGlyphsReady[0], 0, sizeof(_builtinGlyphsReady));\r\n+}\r\n+\r\n+D2D1_RECT_U BackendD2D::_prepareBuiltinGlyph(const RenderingPayload& p, char32_t ch, u32 off)\r\n+{\r\n+    const u32 w = p.s->font->cellSize.x;\r\n+    const u32 h = p.s->font->cellSize.y;\r\n+    const u32 l = (off % _builtinGlyphsBitmapCellCountU) * w;\r\n+    const u32 t = (off / _builtinGlyphsBitmapCellCountU) * h;\r\n+    D2D1_RECT_U rectU{ l, t, l + w, t + h };\r\n+\r\n+    // Check if we previously cached this glyph already.\r\n+    if (_builtinGlyphsReady[off])\r\n+    {\r\n+        return rectU;\r\n+    }\r\n+\r\n+    static constexpr D2D1_COLOR_F shadeColorMap[] = {\r\n+        { 1, 1, 1, 0.25f }, // Shape_Filled025\r\n+        { 1, 1, 1, 0.50f }, // Shape_Filled050\r\n+        { 1, 1, 1, 0.75f }, // Shape_Filled075\r\n+        { 1, 1, 1, 1.00f }, // Shape_Filled100\r\n+    };\r\n+\r\n+    if (!_builtinGlyphsRenderTargetActive)\r\n+    {\r\n+        _builtinGlyphsRenderTarget->BeginDraw();\r\n+        _builtinGlyphsRenderTargetActive = true;\r\n+    }\r\n+\r\n+    const auto brush = _brushWithColor(0xffffffff);\r\n+    const D2D1_RECT_F rectF{\r\n+        static_cast<f32>(rectU.left),\r\n+        static_cast<f32>(rectU.top),\r\n+        static_cast<f32>(rectU.right),\r\n+        static_cast<f32>(rectU.bottom),\r\n+    };\r\n+    BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _builtinGlyphsRenderTarget.get(), brush, shadeColorMap, rectF, ch);\r\n+\r\n+    _builtinGlyphsReady[off] = true;\r\n+    return rectU;\r\n+}\r\n+\r\n+void BackendD2D::_flushBuiltinGlyphs()\r\n+{\r\n+    // If we don't have support for ID2D1SpriteBatch none of the related members will be initialized or used.\r\n+    // We can just early-return in that case.\r\n+    if (!_builtinGlyphBatch)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    if (_builtinGlyphsRenderTargetActive)\r\n+    {\r\n+        THROW_IF_FAILED(_builtinGlyphsRenderTarget->EndDraw());\r\n+        _builtinGlyphsRenderTargetActive = false;\r\n+    }\r\n+\r\n+    if (const auto count = _builtinGlyphBatch->GetSpriteCount(); count > 0)\r\n+    {\r\n+        _renderTarget4->SetAntialiasMode(D2D1_ANTIALIAS_MODE_ALIASED);\r\n+        _renderTarget4->DrawSpriteBatch(_builtinGlyphBatch.get(), 0, count, _builtinGlyphsBitmap.get(), D2D1_BITMAP_INTERPOLATION_MODE_NEAREST_NEIGHBOR, D2D1_SPRITE_OPTIONS_NONE);\r\n+        _renderTarget4->SetAntialiasMode(D2D1_ANTIALIAS_MODE_PER_PRIMITIVE);\r\n+        _builtinGlyphBatch->Clear();\r\n+    }\r\n+}\r\n+\r\n f32 BackendD2D::_drawTextPrepareLineRendition(const RenderingPayload& p, const ShapedRow* row, f32 baselineY) const noexcept\r\n {\r\n     const auto lineRendition = row->lineRendition;\r\n@@ -410,44 +572,118 @@ f32r BackendD2D::_getGlyphRunDesignBounds(const DWRITE_GLYPH_RUN& glyphRun, f32\n \r\n void BackendD2D::_drawGridlineRow(const RenderingPayload& p, const ShapedRow* row, u16 y)\r\n {\r\n-    const auto widthShift = gsl::narrow_cast<u8>(row->lineRendition != LineRendition::SingleWidth);\r\n-    const auto cellSize = p.s->font->cellSize;\r\n-    const auto rowTop = gsl::narrow_cast<i16>(cellSize.y * y);\r\n-    const auto rowBottom = gsl::narrow_cast<i16>(rowTop + cellSize.y);\r\n-    const auto textCellCenter = row->lineRendition == LineRendition::DoubleHeightTop ? rowBottom : rowTop;\r\n+    const auto cellWidth = static_cast<f32>(p.s->font->cellSize.x);\r\n+    const auto cellHeight = static_cast<f32>(p.s->font->cellSize.y);\r\n+    const auto rowTop = cellHeight * y;\r\n+    const auto rowBottom = rowTop + cellHeight;\r\n+    const auto cellCenter = row->lineRendition == LineRendition::DoubleHeightTop ? rowBottom : rowTop;\r\n+    const auto scaleHorizontal = row->lineRendition != LineRendition::SingleWidth ? 0.5f : 1.0f;\r\n+    const auto scaledCellWidth = cellWidth * scaleHorizontal;\r\n \r\n     const auto appendVerticalLines = [&](const GridLineRange& r, FontDecorationPosition pos) {\r\n-        const auto from = r.from >> widthShift;\r\n-        const auto to = r.to >> widthShift;\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n+        auto x = from + pos.position;\r\n \r\n-        auto posX = from * cellSize.x + pos.position;\r\n-        const auto end = to * cellSize.x;\r\n-\r\n-        D2D1_POINT_2F point0{ 0, static_cast<f32>(textCellCenter) };\r\n-        D2D1_POINT_2F point1{ 0, static_cast<f32>(textCellCenter + cellSize.y) };\r\n+        D2D1_POINT_2F point0{ 0, cellCenter };\r\n+        D2D1_POINT_2F point1{ 0, cellCenter + cellHeight };\r\n         const auto brush = _brushWithColor(r.gridlineColor);\r\n         const f32 w = pos.height;\r\n         const f32 hw = w * 0.5f;\r\n \r\n-        for (; posX < end; posX += cellSize.x)\r\n+        for (; x < to; x += cellWidth)\r\n         {\r\n-            const auto centerX = posX + hw;\r\n+            const auto centerX = x + hw;\r\n             point0.x = centerX;\r\n             point1.x = centerX;\r\n             _renderTarget->DrawLine(point0, point1, brush, w, nullptr);\r\n         }\r\n     };\r\n     const auto appendHorizontalLine = [&](const GridLineRange& r, FontDecorationPosition pos, ID2D1StrokeStyle* strokeStyle, const u32 color) {\r\n-        const auto from = r.from >> widthShift;\r\n-        const auto to = r.to >> widthShift;\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n \r\n         const auto brush = _brushWithColor(color);\r\n         const f32 w = pos.height;\r\n-        const f32 centerY = textCellCenter + pos.position + w * 0.5f;\r\n-        const D2D1_POINT_2F point0{ static_cast<f32>(from * cellSize.x), centerY };\r\n-        const D2D1_POINT_2F point1{ static_cast<f32>(to * cellSize.x), centerY };\r\n+        const f32 centerY = cellCenter + pos.position + w * 0.5f;\r\n+        const D2D1_POINT_2F point0{ from, centerY };\r\n+        const D2D1_POINT_2F point1{ to, centerY };\r\n         _renderTarget->DrawLine(point0, point1, brush, w, strokeStyle);\r\n     };\r\n+    const auto appendCurlyLine = [&](const GridLineRange& r) {\r\n+        const auto& font = *p.s->font;\r\n+\r\n+        const auto duTop = static_cast<f32>(font.doubleUnderline[0].position);\r\n+        const auto duBottom = static_cast<f32>(font.doubleUnderline[1].position);\r\n+        // The double-underline height is also our target line width.\r\n+        const auto duHeight = static_cast<f32>(font.doubleUnderline[0].height);\r\n+\r\n+        // This gives it the same position and height as our double-underline. There's no particular reason for that, apart from\r\n+        // it being simple to implement and robust against more peculiar fonts with unusually large/small descenders, etc.\r\n+        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom, which is why `position` has a min().\r\n+        const auto height = std::max(3.0f, duBottom + duHeight - duTop);\r\n+        const auto position = std::min(duTop, cellHeight - height - duHeight);\r\n+\r\n+        // The amplitude of the wave needs to account for the stroke width, so that the final height including\r\n+        // antialiasing isn't larger than our target `height`. That's why we calculate `(height - duHeight)`.\r\n+        //\r\n+        // In other words, Direct2D draws strokes centered on the path. This also means that (for instance)\r\n+        // for a line width of 1px, we need to ensure that the amplitude passes through the center of a pixel.\r\n+        // Because once the path gets stroked, it'll occupy half a pixel on either side of the path.\r\n+        // This results in a \"crisp\" look. That's why we do `round(amp + half) - half`.\r\n+        const auto halfLineWidth = 0.5f * duHeight;\r\n+        const auto amplitude = roundf((height - duHeight) * 0.5f + halfLineWidth) - halfLineWidth;\r\n+        // While the amplitude needs to account for the stroke width, the vertical center of the wave needs\r\n+        // to be at an integer pixel position of course. Otherwise, the wave won't be vertically symmetric.\r\n+        const auto center = cellCenter + position + amplitude + halfLineWidth;\r\n+\r\n+        const auto top = center - 2.0f * amplitude;\r\n+        const auto bottom = center + 2.0f * amplitude;\r\n+        const auto step = 0.5f * height;\r\n+        const auto period = 4.0f * step;\r\n+\r\n+        const auto from = r.from * scaledCellWidth;\r\n+        const auto to = r.to * scaledCellWidth;\r\n+        // Align the start of the wave to the nearest preceding period boundary.\r\n+        // This ensures that the wave is continuous across color and cell changes.\r\n+        auto x = floorf(from / period) * period;\r\n+\r\n+        wil::com_ptr<ID2D1PathGeometry> geometry;\r\n+        THROW_IF_FAILED(p.d2dFactory->CreatePathGeometry(geometry.addressof()));\r\n+\r\n+        wil::com_ptr<ID2D1GeometrySink> sink;\r\n+        THROW_IF_FAILED(geometry->Open(sink.addressof()));\r\n+\r\n+        // This adds complete periods of the wave until we reach the end of the range.\r\n+        sink->BeginFigure({ x, center }, D2D1_FIGURE_BEGIN_HOLLOW);\r\n+        for (D2D1_QUADRATIC_BEZIER_SEGMENT segment; x < to;)\r\n+        {\r\n+            x += step;\r\n+            segment.point1.x = x;\r\n+            segment.point1.y = top;\r\n+            x += step;\r\n+            segment.point2.x = x;\r\n+            segment.point2.y = center;\r\n+            sink->AddQuadraticBezier(&segment);\r\n+\r\n+            x += step;\r\n+            segment.point1.x = x;\r\n+            segment.point1.y = bottom;\r\n+            x += step;\r\n+            segment.point2.x = x;\r\n+            segment.point2.y = center;\r\n+            sink->AddQuadraticBezier(&segment);\r\n+        }\r\n+        sink->EndFigure(D2D1_FIGURE_END_OPEN);\r\n+\r\n+        THROW_IF_FAILED(sink->Close());\r\n+\r\n+        const auto brush = _brushWithColor(r.underlineColor);\r\n+        const D2D1_RECT_F clipRect{ from, rowTop, to, rowBottom };\r\n+        _renderTarget->PushAxisAlignedClip(&clipRect, D2D1_ANTIALIAS_MODE_ALIASED);\r\n+        _renderTarget->DrawGeometry(geometry.get(), brush, duHeight, nullptr);\r\n+        _renderTarget->PopAxisAlignedClip();\r\n+    };\r\n \r\n     for (const auto& r : row->gridLineRanges)\r\n     {\r\n@@ -481,8 +717,28 @@ void BackendD2D::_drawGridlineRow(const RenderingPayload& p, const ShapedRow* ro\n         }\r\n         else if (r.lines.any(GridLines::DottedUnderline, GridLines::HyperlinkUnderline))\r\n         {\r\n+            if (!_dottedStrokeStyle)\r\n+            {\r\n+                static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n+                static constexpr FLOAT dashes[2]{ 1, 1 };\r\n+                THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dottedStrokeStyle.addressof()));\r\n+            }\r\n             appendHorizontalLine(r, p.s->font->underline, _dottedStrokeStyle.get(), r.underlineColor);\r\n         }\r\n+        else if (r.lines.test(GridLines::DashedUnderline))\r\n+        {\r\n+            if (!_dashedStrokeStyle)\r\n+            {\r\n+                static constexpr D2D1_STROKE_STYLE_PROPERTIES props{ .dashStyle = D2D1_DASH_STYLE_CUSTOM };\r\n+                static constexpr FLOAT dashes[2]{ 2, 2 };\r\n+                THROW_IF_FAILED(p.d2dFactory->CreateStrokeStyle(&props, &dashes[0], 2, _dashedStrokeStyle.addressof()));\r\n+            }\r\n+            appendHorizontalLine(r, p.s->font->underline, _dashedStrokeStyle.get(), r.underlineColor);\r\n+        }\r\n+        else if (r.lines.test(GridLines::CurlyUnderline))\r\n+        {\r\n+            appendCurlyLine(r);\r\n+        }\r\n         else if (r.lines.test(GridLines::DoubleUnderline))\r\n         {\r\n             for (const auto pos : p.s->font->doubleUnderline)\r\ndiff --git a/src/renderer/atlas/BackendD2D.h b/src/renderer/atlas/BackendD2D.h\nindex e6993d60603..4206390ea52 100644\n--- a/src/renderer/atlas/BackendD2D.h\n+++ b/src/renderer/atlas/BackendD2D.h\n@@ -3,9 +3,8 @@\n \r\n #pragma once\r\n \r\n-#include <til/flat_set.h>\r\n-\r\n #include \"Backend.h\"\r\n+#include \"BuiltinGlyphs.h\"\r\n \r\n namespace Microsoft::Console::Render::Atlas\r\n {\r\n@@ -19,6 +18,10 @@ namespace Microsoft::Console::Render::Atlas\n         ATLAS_ATTR_COLD void _handleSettingsUpdate(const RenderingPayload& p);\r\n         void _drawBackground(const RenderingPayload& p);\r\n         void _drawText(RenderingPayload& p);\r\n+        ATLAS_ATTR_COLD f32 _drawBuiltinGlyphs(const RenderingPayload& p, const ShapedRow* row, const FontMapping& m, f32 baselineY, f32 baselineX);\r\n+        void _prepareBuiltinGlyphRenderTarget(const RenderingPayload& p);\r\n+        D2D1_RECT_U _prepareBuiltinGlyph(const RenderingPayload& p, char32_t ch, u32 off);\r\n+        void _flushBuiltinGlyphs();\r\n         ATLAS_ATTR_COLD f32 _drawTextPrepareLineRendition(const RenderingPayload& p, const ShapedRow* row, f32 baselineY) const noexcept;\r\n         ATLAS_ATTR_COLD void _drawTextResetLineRendition(const ShapedRow* row) const noexcept;\r\n         ATLAS_ATTR_COLD f32r _getGlyphRunDesignBounds(const DWRITE_GLYPH_RUN& glyphRun, f32 baselineX, f32 baselineY);\r\n@@ -37,10 +40,18 @@ namespace Microsoft::Console::Render::Atlas\n         wil::com_ptr<ID2D1DeviceContext> _renderTarget;\r\n         wil::com_ptr<ID2D1DeviceContext4> _renderTarget4; // Optional. Supported since Windows 10 14393.\r\n         wil::com_ptr<ID2D1StrokeStyle> _dottedStrokeStyle;\r\n+        wil::com_ptr<ID2D1StrokeStyle> _dashedStrokeStyle;\r\n         wil::com_ptr<ID2D1Bitmap> _backgroundBitmap;\r\n         wil::com_ptr<ID2D1BitmapBrush> _backgroundBrush;\r\n         til::generation_t _backgroundBitmapGeneration;\r\n \r\n+        wil::com_ptr<ID2D1DeviceContext> _builtinGlyphsRenderTarget;\r\n+        wil::com_ptr<ID2D1Bitmap> _builtinGlyphsBitmap;\r\n+        wil::com_ptr<ID2D1SpriteBatch> _builtinGlyphBatch;\r\n+        u32 _builtinGlyphsBitmapCellCountU = 0;\r\n+        bool _builtinGlyphsRenderTargetActive = false;\r\n+        bool _builtinGlyphsReady[BuiltinGlyphs::TotalCharCount]{};\r\n+\r\n         wil::com_ptr<ID2D1Bitmap> _cursorBitmap;\r\n         til::size _cursorBitmapSize; // in columns/rows\r\n \r\ndiff --git a/src/renderer/atlas/BackendD3D.cpp b/src/renderer/atlas/BackendD3D.cpp\nindex fe07271c16a..d85d6e0365f 100644\n--- a/src/renderer/atlas/BackendD3D.cpp\n+++ b/src/renderer/atlas/BackendD3D.cpp\n@@ -295,20 +295,20 @@ void BackendD3D::_updateFontDependents(const RenderingPayload& p)\n     // baseline of curlyline is at the middle of singly underline. When there's\r\n     // limited space to draw a curlyline, we apply a limit on the peak height.\r\n     {\r\n-        const auto cellHeight = static_cast<f32>(font.cellSize.y);\r\n-        const auto duTop = static_cast<f32>(font.doubleUnderline[0].position);\r\n-        const auto duBottom = static_cast<f32>(font.doubleUnderline[1].position);\r\n-        const auto duHeight = static_cast<f32>(font.doubleUnderline[0].height);\r\n+        const int cellHeight = font.cellSize.y;\r\n+        const int duTop = font.doubleUnderline[0].position;\r\n+        const int duBottom = font.doubleUnderline[1].position;\r\n+        const int duHeight = font.doubleUnderline[0].height;\r\n \r\n         // This gives it the same position and height as our double-underline. There's no particular reason for that, apart from\r\n         // it being simple to implement and robust against more peculiar fonts with unusually large/small descenders, etc.\r\n-        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom.\r\n-        const auto height = std::max(3.0f, duBottom + duHeight - duTop);\r\n-        const auto top = std::min(duTop, floorf(cellHeight - height - duHeight));\r\n+        // We still need to ensure though that it doesn't clip out of the cellHeight at the bottom, which is why `position` has a min().\r\n+        const auto height = std::max(3, duBottom + duHeight - duTop);\r\n+        const auto position = std::min(duTop, cellHeight - height - duHeight);\r\n \r\n         _curlyLineHalfHeight = height * 0.5f;\r\n-        _curlyUnderline.position = gsl::narrow_cast<u16>(lrintf(top));\r\n-        _curlyUnderline.height = gsl::narrow_cast<u16>(lrintf(height));\r\n+        _curlyUnderline.position = gsl::narrow_cast<u16>(position);\r\n+        _curlyUnderline.height = gsl::narrow_cast<u16>(height);\r\n     }\r\n \r\n     DWrite_GetRenderParams(p.dwriteFactory.get(), &_gamma, &_cleartypeEnhancedContrast, &_grayscaleEnhancedContrast, _textRenderingParams.put());\r\n@@ -1509,7 +1509,19 @@ BackendD3D::AtlasGlyphEntry* BackendD3D::_drawBuiltinGlyph(const RenderingPayloa\n     }\r\n     else\r\n     {\r\n-        BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _d2dRenderTarget.get(), _brush.get(), r, glyphIndex);\r\n+        // This code works in tandem with SHADING_TYPE_TEXT_BUILTIN_GLYPH in our pixel shader.\r\n+        // Unless someone removed it, it should have a lengthy comment visually explaining\r\n+        // what each of the 3 RGB components do. The short version is:\r\n+        //   R: stretch the checkerboard pattern (Shape_Filled050) horizontally\r\n+        //   G: invert the pixels\r\n+        //   B: overrides the above and fills it\r\n+        static constexpr D2D1_COLOR_F shadeColorMap[] = {\r\n+            { 1, 0, 0, 1 }, // Shape_Filled025\r\n+            { 0, 0, 0, 1 }, // Shape_Filled050\r\n+            { 1, 1, 0, 1 }, // Shape_Filled075\r\n+            { 1, 1, 1, 1 }, // Shape_Filled100\r\n+        };\r\n+        BuiltinGlyphs::DrawBuiltinGlyph(p.d2dFactory.get(), _d2dRenderTarget.get(), _brush.get(), shadeColorMap, r, glyphIndex);\r\n         shadingType = ShadingType::TextBuiltinGlyph;\r\n     }\r\n \r\ndiff --git a/src/renderer/atlas/BuiltinGlyphs.cpp b/src/renderer/atlas/BuiltinGlyphs.cpp\nindex c46bfc01fc0..92d87bc0b45 100644\n--- a/src/renderer/atlas/BuiltinGlyphs.cpp\n+++ b/src/renderer/atlas/BuiltinGlyphs.cpp\n@@ -135,8 +135,6 @@ inline constexpr f32 Pos_Lut[][2] = {\n     /* Pos_11_12       */ { 11.0f / 12.0f, 0.0f },\n };\n \n-static constexpr char32_t BoxDrawing_FirstChar = 0x2500;\n-static constexpr u32 BoxDrawing_CharCount = 0xA0;\n static constexpr Instruction BoxDrawing[BoxDrawing_CharCount][InstructionsPerGlyph] = {\n     // U+2500 ─ BOX DRAWINGS LIGHT HORIZONTAL\n     {\n@@ -964,8 +962,6 @@ static constexpr Instruction BoxDrawing[BoxDrawing_CharCount][InstructionsPerGly\n     },\n };\n \n-static constexpr char32_t Powerline_FirstChar = 0xE0B0;\n-static constexpr u32 Powerline_CharCount = 0x10;\n static constexpr Instruction Powerline[Powerline_CharCount][InstructionsPerGlyph] = {\n     // U+E0B0 Right triangle solid\n     {\n@@ -1071,7 +1067,20 @@ static const Instruction* GetInstructions(char32_t codepoint) noexcept\n     return nullptr;\n }\n \n-void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_RECT_F& rect, char32_t codepoint)\n+i32 BuiltinGlyphs::GetBitmapCellIndex(char32_t codepoint) noexcept\n+{\n+    if (BoxDrawing_IsMapped(codepoint))\n+    {\n+        return codepoint - BoxDrawing_FirstChar;\n+    }\n+    if (Powerline_IsMapped(codepoint))\n+    {\n+        return codepoint - Powerline_FirstChar + BoxDrawing_CharCount;\n+    }\n+    return -1;\n+}\n+\n+void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_COLOR_F (&shadeColorMap)[4], const D2D1_RECT_F& rect, char32_t codepoint)\n {\n     renderTarget->PushAxisAlignedClip(&rect, D2D1_ANTIALIAS_MODE_ALIASED);\n     const auto restoreD2D = wil::scope_exit([&]() {\n@@ -1122,15 +1131,18 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         const auto lineOffsetX = isHollowRect || isLineX ? lineWidthHalf : 0.0f;\n         const auto lineOffsetY = isHollowRect || isLineY ? lineWidthHalf : 0.0f;\n \n-        begX = roundf(begX - lineOffsetX) + lineOffsetX;\n-        begY = roundf(begY - lineOffsetY) + lineOffsetY;\n-        endX = roundf(endX + lineOffsetX) - lineOffsetX;\n-        endY = roundf(endY + lineOffsetY) - lineOffsetY;\n-\n-        const auto begXabs = begX + rectX;\n-        const auto begYabs = begY + rectY;\n-        const auto endXabs = endX + rectX;\n-        const auto endYabs = endY + rectY;\n+        // Direct2D draws strokes centered on the path. In order to make them pixel-perfect we need to round the\n+        // coordinates to whole pixels, but offset by half the stroke width (= the radius of the stroke).\n+        //\n+        // All floats up to this point will be highly \"consistent\" between different `rect`s of identical size and\n+        // different shapes, because the above calculations work with only a small set of constant floats.\n+        // However, the addition of a potentially fractional begX/Y with a highly variable `rect` position is different.\n+        // Rounding beg/endX/Y first ensures that we continue to get a consistent behavior between calls.\n+        // This is particularly noticeable at smaller font sizes, where the line width is just a pixel or two.\n+        const auto begXabs = rectX + roundf(begX - lineOffsetX) + lineOffsetX;\n+        const auto begYabs = rectY + roundf(begY - lineOffsetY) + lineOffsetY;\n+        const auto endXabs = rectX + roundf(endX + lineOffsetX) - lineOffsetX;\n+        const auto endYabs = rectY + roundf(endY + lineOffsetY) - lineOffsetY;\n \n         switch (shape)\n         {\n@@ -1139,21 +1151,8 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         case Shape_Filled075:\n         case Shape_Filled100:\n         {\n-            // This code works in tandem with SHADING_TYPE_TEXT_BUILTIN_GLYPH in our pixel shader.\n-            // Unless someone removed it, it should have a lengthy comment visually explaining\n-            // what each of the 3 RGB components do. The short version is:\n-            //   R: stretch the checkerboard pattern (Shape_Filled050) horizontally\n-            //   G: invert the pixels\n-            //   B: overrides the above and fills it\n-            static constexpr D2D1_COLOR_F colors[] = {\n-                { 1, 0, 0, 1 }, // Shape_Filled025\n-                { 0, 0, 0, 1 }, // Shape_Filled050\n-                { 1, 1, 0, 1 }, // Shape_Filled075\n-                { 1, 1, 1, 1 }, // Shape_Filled100\n-            };\n-\n             const auto brushColor = brush->GetColor();\n-            brush->SetColor(&colors[shape]);\n+            brush->SetColor(&shadeColorMap[shape]);\n \n             const D2D1_RECT_F r{ begXabs, begYabs, endXabs, endYabs };\n             renderTarget->FillRectangle(&r, brush);\n@@ -1183,13 +1182,13 @@ void BuiltinGlyphs::DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext*\n         }\n         case Shape_FilledEllipsis:\n         {\n-            const D2D1_ELLIPSE e{ { begXabs, begYabs }, endX, endY };\n+            const D2D1_ELLIPSE e{ { rectX + begX, rectY + begY }, endX, endY };\n             renderTarget->FillEllipse(&e, brush);\n             break;\n         }\n         case Shape_EmptyEllipsis:\n         {\n-            const D2D1_ELLIPSE e{ { begXabs, begYabs }, endX, endY };\n+            const D2D1_ELLIPSE e{ { rectX + begX, rectY + begY }, endX, endY };\n             renderTarget->DrawEllipse(&e, brush, lineWidth, nullptr);\n             break;\n         }\ndiff --git a/src/renderer/atlas/BuiltinGlyphs.h b/src/renderer/atlas/BuiltinGlyphs.h\nindex f399653893c..b6cce3a3974 100644\n--- a/src/renderer/atlas/BuiltinGlyphs.h\n+++ b/src/renderer/atlas/BuiltinGlyphs.h\n@@ -8,7 +8,17 @@\n namespace Microsoft::Console::Render::Atlas::BuiltinGlyphs\r\n {\r\n     bool IsBuiltinGlyph(char32_t codepoint) noexcept;\r\n-    void DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_RECT_F& rect, char32_t codepoint);\r\n+    void DrawBuiltinGlyph(ID2D1Factory* factory, ID2D1DeviceContext* renderTarget, ID2D1SolidColorBrush* brush, const D2D1_COLOR_F (&shadeColorMap)[4], const D2D1_RECT_F& rect, char32_t codepoint);\r\n+\r\n+    inline constexpr char32_t BoxDrawing_FirstChar = 0x2500;\r\n+    inline constexpr u32 BoxDrawing_CharCount = 0xA0;\r\n+\r\n+    inline constexpr char32_t Powerline_FirstChar = 0xE0B0;\r\n+    inline constexpr u32 Powerline_CharCount = 0x10;\r\n+\r\n+    inline constexpr u32 TotalCharCount = BoxDrawing_CharCount + Powerline_CharCount;\r\n+\r\n+    i32 GetBitmapCellIndex(char32_t codepoint) noexcept;\r\n \r\n     // This is just an extra. It's not actually implemented as part of BuiltinGlyphs.cpp.\r\n     constexpr bool IsSoftFontChar(char32_t ch) noexcept\r\ndiff --git a/src/tools/RenderingTests/main.cpp b/src/tools/RenderingTests/main.cpp\nindex 45dfcf66ea7..2d0ef8612a4 100644\n--- a/src/tools/RenderingTests/main.cpp\n+++ b/src/tools/RenderingTests/main.cpp\n@@ -108,15 +108,15 @@ static void printfUTF16(_In_z_ _Printf_format_string_ wchar_t const* const forma\n \r\n static void wait()\r\n {\r\n-    printUTF16(L\"\\x1B[9999;1HPress any key to continue...\");\r\n+    printUTF16(L\"\\x1b[9999;1HPress any key to continue...\");\r\n     _getch();\r\n }\r\n \r\n static void clear()\r\n {\r\n     printUTF16(\r\n-        L\"\\x1B[H\" // move cursor to 0,0\r\n-        L\"\\x1B[2J\" // clear screen\r\n+        L\"\\x1b[H\" // move cursor to 0,0\r\n+        L\"\\x1b[2J\" // clear screen\r\n     );\r\n }\r\n \r\n@@ -166,7 +166,7 @@ int main()\n             for (const auto& t : consoleAttributeTests)\r\n             {\r\n                 const auto length = static_cast<DWORD>(wcslen(t.text));\r\n-                printfUTF16(L\"\\x1B[%d;5H%s\", row + 1, t.text);\r\n+                printfUTF16(L\"\\x1b[%d;5H%s\", row + 1, t.text);\r\n \r\n                 WORD attributes[32];\r\n                 std::fill_n(&attributes[0], length, static_cast<WORD>(FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED | t.attribute));\r\n@@ -190,16 +190,16 @@ int main()\n                 { L\"overlined\", 53 },\r\n             };\r\n \r\n-            printfUTF16(L\"\\x1B[3;39HANSI escape SGR:\");\r\n+            printfUTF16(L\"\\x1b[3;39HANSI escape SGR:\");\r\n \r\n             int row = 5;\r\n             for (const auto& t : basicSGR)\r\n             {\r\n-                printfUTF16(L\"\\x1B[%d;39H\\x1b[%dm%s\\x1b[m\", row, t.attribute, t.text);\r\n+                printfUTF16(L\"\\x1b[%d;39H\\x1b[%dm%s\\x1b[m\", row, t.attribute, t.text);\r\n                 row += 2;\r\n             }\r\n \r\n-            printfUTF16(L\"\\x1B[%d;39H\\x1b]8;;https://example.com\\x1b\\\\hyperlink\\x1b]8;;\\x1b\\\\\", row);\r\n+            printfUTF16(L\"\\x1b[%d;39H\\x1b]8;;https://example.com\\x1b\\\\hyperlink\\x1b]8;;\\x1b\\\\\", row);\r\n         }\r\n \r\n         {\r\n@@ -211,18 +211,18 @@ int main()\n                 { L\"dashed\", 5 },\r\n             };\r\n \r\n-            printfUTF16(L\"\\x1B[3;63HStyled Underlines:\");\r\n+            printfUTF16(L\"\\x1b[3;63HStyled Underlines:\");\r\n \r\n             int row = 5;\r\n             for (const auto& t : styledUnderlines)\r\n             {\r\n-                printfUTF16(L\"\\x1B[%d;63H\\x1b[4:%dm\", row, t.attribute);\r\n+                printfUTF16(L\"\\x1b[%d;63H\\x1b[4:%dm\", row, t.attribute);\r\n \r\n                 const auto len = wcslen(t.text);\r\n                 for (size_t i = 0; i < len; ++i)\r\n                 {\r\n                     const auto color = colorbrewer::pastel1[i % std::size(colorbrewer::pastel1)];\r\n-                    printfUTF16(L\"\\x1B[58:2::%d:%d:%dm%c\", (color >> 16) & 0xff, (color >> 8) & 0xff, color & 0xff, t.text[i]);\r\n+                    printfUTF16(L\"\\x1b[58:2::%d:%d:%dm%c\", (color >> 16) & 0xff, (color >> 8) & 0xff, color & 0xff, t.text[i]);\r\n                 }\r\n \r\n                 printfUTF16(L\"\\x1b[m\");\r\n@@ -236,19 +236,19 @@ int main()\n \r\n     {\r\n         printUTF16(\r\n-            L\"\\x1B[3;5HDECDWL Double Width \\U0001FAE0 \\x1B[45;92mA\\u0353\\u0353\\x1B[m B\\u036F\\u036F\"\r\n-            L\"\\x1B[4;3H\\x1b#6DECDWL Double Width         \\U0001FAE0 \\x1B[45;92mA\\u0353\\u0353\\x1B[m B\\u036F\\u036F\"\r\n-            L\"\\x1B[7;5HDECDHL Double Height \\U0001F952\\U0001F6C1 A\\u0353\\u0353 \\x1B[45;92mB\\u036F\\u036F\\x1B[m \\x1B[45;92mX\\u0353\\u0353\\x1B[m Y\\u036F\\u036F\"\r\n-            L\"\\x1B[8;3H\\x1b#3DECDHL Double Height Top    \\U0001F952 A\\u0353\\u0353 \\x1B[45;92mB\\u036F\\u036F\\x1B[m\"\r\n-            L\"\\x1B[9;3H\\x1b#4DECDHL Double Height Bottom \\U0001F6C1 \\x1B[45;92mX\\u0353\\u0353\\x1B[m Y\\u036F\\u036F\"\r\n-            L\"\\x1B[13;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[15;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[17;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[19;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[21;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[22;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1B[3mitalic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n-            L\"\\x1B[24;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n-            L\"\\x1B[25;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1B[45;92m!\\x1B[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\");\r\n+            L\"\\x1b[3;5HDECDWL Double Width \\U0001FAE0 \\x1b[45;92mA\\u0353\\u0353\\x1b[m B\\u036F\\u036F\"\r\n+            L\"\\x1b[4;3H\\x1b#6DECDWL Double Width         \\U0001FAE0 \\x1b[45;92mA\\u0353\\u0353\\x1b[m B\\u036F\\u036F\"\r\n+            L\"\\x1b[7;5HDECDHL Double Height \\U0001F952\\U0001F6C1 A\\u0353\\u0353 \\x1b[45;92mB\\u036F\\u036F\\x1b[m \\x1b[45;92mX\\u0353\\u0353\\x1b[m Y\\u036F\\u036F\"\r\n+            L\"\\x1b[8;3H\\x1b#3DECDHL Double Height Top    \\U0001F952 A\\u0353\\u0353 \\x1b[45;92mB\\u036F\\u036F\\x1b[m\"\r\n+            L\"\\x1b[9;3H\\x1b#4DECDHL Double Height Bottom \\U0001F6C1 \\x1b[45;92mX\\u0353\\u0353\\x1b[m Y\\u036F\\u036F\"\r\n+            L\"\\x1b[12;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[14;5H\\x1b]8;;https://example.com\\x1b\\\\DECDxL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[16;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[18;3H\\x1b#6\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDWL.html\\x1b\\\\DECDWL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[20;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[21;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[3;4:3;58:2::255:0:0mita\\x1b[58:2::0:255:0mlic\\x1b[m        \\x1b[4munderline\\x1b[m        \\x1b[7mreverse\\x1b[m\"\r\n+            L\"\\x1b[23;3H\\x1b#3\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\"\r\n+            L\"\\x1b[24;3H\\x1b#4\\x1b]8;;https://vt100.net/docs/vt510-rm/DECDHL.html\\x1b\\\\DECDHL\\x1b]8;;\\x1b\\\\ <\\x1b[45;92m!\\x1b[m-- \\x1b[9mstrikethrough\\x1b[m \\x1b[21mdouble underline\\x1b[m \\x1b[53moverlined\\x1b[m\");\r\n \r\n         static constexpr WORD attributes[]{\r\n             FOREGROUND_BLUE | FOREGROUND_GREEN | FOREGROUND_RED | COMMON_LVB_GRID_HORIZONTAL,\r\n@@ -264,7 +264,7 @@ int main()\n         DWORD numberOfAttrsWritten;\r\n         DWORD offset = 0;\r\n \r\n-        for (const auto r : { 12, 14, 16, 18, 20, 21, 23, 24 })\r\n+        for (const auto r : { 11, 13, 15, 17, 19, 20, 22, 23 })\r\n         {\r\n             COORD coord;\r\n             coord.X = r > 14 ? 2 : 4;\r\n@@ -338,14 +338,14 @@ int main()\n \r\n #define DRCS_SEQUENCE L\"\\x1b( @#\\x1b(A\"\r\n         printUTF16(\r\n-            L\"\\x1B[3;5HDECDLD and DRCS test - it should show \\\"WT\\\" in a single cell\"\r\n-            L\"\\x1B[5;5HRegular: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[7;3H\\x1b#6DECDWL: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[9;3H\\x1b#3DECDHL: \" DRCS_SEQUENCE L\"\"\r\n-            L\"\\x1B[10;3H\\x1b#4DECDHL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[3;5HDECDLD and DRCS test - it should show \\\"WT\\\" in a single cell\"\r\n+            L\"\\x1b[5;5HRegular: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[7;3H\\x1b#6DECDWL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[9;3H\\x1b#3DECDHL: \" DRCS_SEQUENCE L\"\"\r\n+            L\"\\x1b[10;3H\\x1b#4DECDHL: \" DRCS_SEQUENCE L\"\"\r\n             // We map soft fonts into the private use area starting at U+EF20. This test ensures\r\n             // that we correctly map actual fallback glyphs mixed into the DRCS glyphs.\r\n-            L\"\\x1B[12;5HUnicode Fallback: \\uE000\\uE001\" DRCS_SEQUENCE L\"\\uE003\\uE004\");\r\n+            L\"\\x1b[12;5HUnicode Fallback: \\uE000\\uE001\" DRCS_SEQUENCE L\"\\uE003\\uE004\");\r\n #undef DRCS_SEQUENCE\r\n \r\n         wait();\r\n", "instance_id": "microsoft__terminal-17278", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: there are visible gaps between block elements when using Direct2D in Windows Terminal, which should ideally render as a solid bar. The goal (fusing block elements into a solid bar), the environment (Windows Terminal version, build number, and settings), and steps to reproduce are provided with sufficient detail, including images for expected and actual behavior. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the constraints or edge cases (e.g., specific Unicode ranges, font configurations, or scaling factors beyond 100%) that might affect the rendering. Additionally, while the expected behavior is described, there is no mention of potential trade-offs or performance considerations for the fix. Overall, the statement is valid and clear but lacks some depth in specifying edge cases or broader implications, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75 (Hard) to this problem based on the following analysis of the factors:\n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files (`AtlasEngine.cpp`, `AtlasEngine.h`, `BackendD2D.cpp`, `BackendD2D.h`, `BackendD3D.cpp`, `BuiltinGlyphs.cpp`, `BuiltinGlyphs.h`, and `RenderingTests/main.cpp`), indicating a broad impact across the rendering subsystem of Windows Terminal. The modifications involve significant refactoring, such as removing hacky workarounds (e.g., `_hackIsBackendD2D`, `_hackWantsBuiltinGlyphs`) and introducing new rendering logic for built-in glyphs using `ID2D1SpriteBatch` in Direct2D. This requires understanding and altering interactions between the `AtlasEngine` and backend rendering implementations (`BackendD2D` and `BackendD3D`), which suggests a deep impact on the rendering architecture.\n\n2. **Number of Technical Concepts**: Solving this problem demands familiarity with several advanced concepts, including Direct2D and Direct3D rendering APIs, glyph rendering and text shaping, Unicode handling (e.g., surrogate pairs), and Windows-specific graphics programming. The changes involve intricate handling of bitmap rendering for built-in glyphs, sprite batching, and pixel-perfect rendering techniques (e.g., adjusting for stroke width and antialiasing). Additionally, domain-specific knowledge of terminal rendering (e.g., line renditions, grid lines, and ANSI escape sequences) is required. These concepts are complex and necessitate a strong background in graphics programming.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes reveal several implicit considerations, such as handling different font sizes, cell dimensions, Unicode codepoints (including surrogates), and fallback scenarios for devices lacking `ID2D1SpriteBatch` support. The implementation also addresses rendering precision (e.g., rounding coordinates for pixel-perfect lines) and clipping issues. These edge cases add complexity, as they require careful testing and validation to ensure consistent rendering across diverse configurations.\n\n4. **Overall Complexity**: The combination of architectural changes, advanced graphics programming, and nuanced edge case handling places this problem in the \"Hard\" category. It requires a deep understanding of the Windows Terminal rendering pipeline and the ability to refactor core components without introducing regressions. While it does not reach the \"Very Hard\" level (e.g., no system-level or distributed system challenges), it is still a significant undertaking due to the specialized knowledge and precision required. A score of 0.75 reflects the high difficulty, balancing between complex refactoring and the absence of extreme system-wide implications.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "UI style errors: Menu items capitalization and … (ellipses) mark misuse\n### Windows Terminal version\r\n\r\n1.20.10572.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.3235\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nDisplay the tab contextual menu, preferably with a second pane open to show all options.\r\n![image](https://github.com/microsoft/terminal/assets/25664275/469f703e-1a8c-4dae-a7d8-ac11a8da44f6)\r\nThere are several problems with this menu.\r\n\r\n### First: Excessive capitalization\r\nIf you check out the style guide: https://learn.microsoft.com/en-us/style-guide/text-formatting/formatting-common-text-elements\r\nYou'll see that `UI text or strings` should use `Sentence-style capitalization`, this is further described at https://learn.microsoft.com/en-us/style-guide/capitalization\r\n```\r\ncapitalize the first word and lowercase the rest.\r\nExceptions: Proper nouns, including brand, product, and service names, are always capitalized.\r\nIf a title or heading includes a colon, capitalize the first word after it.\r\n```\r\n`Tab`, `New`, `Window`, `Right` are not brands, products, or service names, they should not be capitalized.\r\nThis looks worse in other languages as determiners make the capitalized words lose their vertical alignment, as seen in #16819.\r\n\r\n### Second: Misuse of `…` (ellipses)\r\nFrom the Windows UX design guide: https://learn.microsoft.com/en-us/windows/win32/uxguide/text-ui#guidelines\r\n```\r\nEllipses mean incompleteness. Use ellipses in UI text as follows:\r\n\r\nCommands: Indicate that a command needs additional information.\r\nDon't use an ellipsis whenever an action displays another window only when additional information is required.\r\nFor more information, see [Command Buttons](https://learn.microsoft.com/en-us/windows/win32/uxguide/ctrl-command-buttons).\r\n\r\n(… more details about truncated text, use in data and labels not included here)\r\n```\r\nI know this is getting out of style, but `…` and `>` next to menu items were originally designed to provide predictability.\r\nThe `…` after a menu item means selecting it will display a follow-up dialog or window asking for more options before completing the selected action, while `>` after a menu item means selecting it will display a cascading submenu, finally, neither means selecting it will perform the action immediately.\r\nTherefore, they are mutually exclusive, you cannot have `…` and `>` on the same menu item, clicking it either displays a dialog/window, or a submenu, it cannot do both.\r\n\r\nMore modern Windows UI is trying to get rid of `…` on menu items, trading discoverability and predictability for the sake of visual style, but including it when it doesn't mean a subsequent window will get displayed breaks both the UI guidelines we had since Windows 3.x, and the modern look. Those `Close…` have to go.\r\n\r\nNote the tab contextual menu was taken as an example because it contains all the problems I wanted to mention, but other menus also contain similar errors.\r\n\r\n### Expected Behavior\r\n\r\nUI consistency _(didn't there used to be a UI guidelines check before inclusion as a Windows component?)_.\r\n\r\n### Actual Behavior\r\n\r\nUnpredictability and confusion 🤪\n", "patch": "diff --git a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\nindex 54cd9e9bc30..15b79c40ffc 100644\n--- a/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalApp/Resources/en-US/Resources.resw\n@@ -191,43 +191,43 @@\n     <value>Multiple panes</value>\r\n   </data>\r\n   <data name=\"TabCloseSubMenu\" xml:space=\"preserve\">\r\n-    <value>Close...</value>\r\n+    <value>Close</value>\r\n   </data>\r\n   <data name=\"TabCloseAfter\" xml:space=\"preserve\">\r\n-    <value>Close Tabs to the Right</value>\r\n+    <value>Close tabs to the right</value>\r\n   </data>\r\n   <data name=\"TabCloseOther\" xml:space=\"preserve\">\r\n-    <value>Close Other Tabs</value>\r\n+    <value>Close other tabs</value>\r\n   </data>\r\n   <data name=\"TabClose\" xml:space=\"preserve\">\r\n-    <value>Close Tab</value>\r\n+    <value>Close tab</value>\r\n   </data>\r\n   <data name=\"PaneClose\" xml:space=\"preserve\">\r\n-    <value>Close Pane</value>\r\n+    <value>Close pane</value>\r\n   </data>\r\n   <data name=\"SplitTabText\" xml:space=\"preserve\">\r\n-    <value>Split Tab</value>\r\n+    <value>Split tab</value>\r\n   </data>\r\n   <data name=\"SplitPaneText\" xml:space=\"preserve\">\r\n-    <value>Split Pane</value>\r\n+    <value>Split pane</value>\r\n   </data>\r\n   <data name=\"SearchWebText\" xml:space=\"preserve\">\r\n-    <value>Web Search</value>\r\n+    <value>Web search</value>\r\n   </data>\r\n   <data name=\"TabColorChoose\" xml:space=\"preserve\">\r\n-    <value>Color...</value>\r\n+    <value>Change tab color</value>\r\n   </data>\r\n   <data name=\"TabColorCustomButton.Content\" xml:space=\"preserve\">\r\n-    <value>Custom...</value>\r\n+    <value>Custom</value>\r\n   </data>\r\n   <data name=\"TabColorClearButton.Content\" xml:space=\"preserve\">\r\n     <value>Reset</value>\r\n   </data>\r\n   <data name=\"RenameTabText\" xml:space=\"preserve\">\r\n-    <value>Rename Tab</value>\r\n+    <value>Rename tab</value>\r\n   </data>\r\n   <data name=\"DuplicateTabText\" xml:space=\"preserve\">\r\n-    <value>Duplicate Tab</value>\r\n+    <value>Duplicate tab</value>\r\n   </data>\r\n   <data name=\"InvalidBackgroundImage\" xml:space=\"preserve\">\r\n     <value>Found a profile with an invalid \"backgroundImage\". Defaulting that profile to have no background image. Make sure that when setting a \"backgroundImage\", the value is a valid file path to an image.</value>\r\n@@ -462,7 +462,7 @@\n     <value>About</value>\r\n   </data>\r\n   <data name=\"AboutDialog.PrimaryButtonText\" xml:space=\"preserve\">\r\n-    <value>Send Feedback</value>\r\n+    <value>Send feedback</value>\r\n   </data>\r\n   <data name=\"AboutDialog.CloseButtonText\" xml:space=\"preserve\">\r\n     <value>OK</value>\r\n@@ -472,11 +472,11 @@\n     <comment>This is the heading for a version number label</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_GettingStartedLink.Content\" xml:space=\"preserve\">\r\n-    <value>Getting Started</value>\r\n+    <value>Getting started</value>\r\n     <comment>A hyperlink name for a guide on how to get started using Terminal</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_SourceCodeLink.Content\" xml:space=\"preserve\">\r\n-    <value>Source Code</value>\r\n+    <value>Source code</value>\r\n     <comment>A hyperlink name for the Terminal's documentation</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_DocumentationLink.Content\" xml:space=\"preserve\">\r\n@@ -484,15 +484,15 @@\n     <comment>A hyperlink name for user documentation</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_ReleaseNotesLink.Content\" xml:space=\"preserve\">\r\n-    <value>Release Notes</value>\r\n+    <value>Release notes</value>\r\n     <comment>A hyperlink name for the Terminal's release notes</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_PrivacyPolicyLink.Content\" xml:space=\"preserve\">\r\n-    <value>Privacy Policy</value>\r\n+    <value>Privacy policy</value>\r\n     <comment>A hyperlink name for the Terminal's privacy policy</comment>\r\n   </data>\r\n   <data name=\"AboutDialog_ThirdPartyNoticesLink.Content\" xml:space=\"preserve\">\r\n-    <value>Third-Party Notices</value>\r\n+    <value>Third-Party notices</value>\r\n     <comment>A hyperlink name for the Terminal's third-party notices</comment>\r\n   </data>\r\n   <data name=\"QuitDialog.CloseButtonText\" xml:space=\"preserve\">\r\n@@ -579,10 +579,10 @@\n     <value>Failed parsing command line:</value>\r\n   </data>\r\n   <data name=\"CommandPaletteControlName\" xml:space=\"preserve\">\r\n-    <value>Command Palette</value>\r\n+    <value>Command palette</value>\r\n   </data>\r\n   <data name=\"TabSwitcherControlName\" xml:space=\"preserve\">\r\n-    <value>Tab Switcher</value>\r\n+    <value>Tab switcher</value>\r\n   </data>\r\n   <data name=\"TabSwitcher_SearchBoxText\" xml:space=\"preserve\">\r\n     <value>Type a tab name...</value>\r\n@@ -731,10 +731,10 @@\n     <value>Maximize</value>\r\n   </data>\r\n   <data name=\"WindowRestoreDownButtonToolTip\" xml:space=\"preserve\">\r\n-    <value>Restore Down</value>\r\n+    <value>Restore down</value>\r\n   </data>\r\n   <data name=\"CommandPaletteMenuItem\" xml:space=\"preserve\">\r\n-    <value>Command Palette</value>\r\n+    <value>Command palette</value>\r\n   </data>\r\n   <data name=\"NotificationIconFocusTerminal\" xml:space=\"preserve\">\r\n     <value>Focus Terminal</value>\r\n@@ -754,7 +754,7 @@\n     <value>Split the window and start in given directory</value>\r\n   </data>\r\n   <data name=\"ExportTabText\" xml:space=\"preserve\">\r\n-    <value>Export Text</value>\r\n+    <value>Export text</value>\r\n   </data>\r\n   <data name=\"ExportFailure\" xml:space=\"preserve\">\r\n     <value>Failed to export terminal content</value>\r\n@@ -766,7 +766,7 @@\n     <value>Find</value>\r\n   </data>\r\n   <data name=\"PlainText\" xml:space=\"preserve\">\r\n-    <value>Plain Text</value>\r\n+    <value>Plain text</value>\r\n   </data>\r\n   <data name=\"CloseOnExitInfoBar.Message\" xml:space=\"preserve\">\r\n     <value>Termination behavior can be configured in advanced profile settings.</value>\r\n@@ -775,7 +775,7 @@\n     <value>Don't show again</value>\r\n   </data>\r\n   <data name=\"ElevationShield.[using:Windows.UI.Xaml.Controls]ToolTipService.ToolTip\" xml:space=\"preserve\">\r\n-    <value>This Terminal window is running as Admin</value>\r\n+    <value>This Terminal window is running as administrator</value>\r\n   </data>\r\n   <data name=\"CommandPalette_MatchesAvailable\" xml:space=\"preserve\">\r\n     <value>Suggestions found: {0}</value>\r\n@@ -835,10 +835,10 @@\n     <value>Close this tab</value>\r\n   </data>\r\n   <data name=\"NewTabMenuFolderEmpty\" xml:space=\"preserve\">\r\n-    <value>Empty...</value>\r\n+    <value>Empty</value>\r\n   </data>\r\n   <data name=\"ClosePaneText\" xml:space=\"preserve\">\r\n-    <value>Close Pane</value>\r\n+    <value>Close pane</value>\r\n   </data>\r\n   <data name=\"ClosePaneToolTip\" xml:space=\"preserve\">\r\n     <value>Close the active pane if multiple panes are present</value>\r\n@@ -848,13 +848,13 @@\n     <comment>Text used to identify the reset button</comment>\r\n   </data>\r\n   <data name=\"MoveTabToNewWindowText\" xml:space=\"preserve\">\r\n-    <value>Move Tab to New Window</value>\r\n+    <value>Move tab to new window</value>\r\n   </data>\r\n   <data name=\"MoveTabToNewWindowToolTip\" xml:space=\"preserve\">\r\n     <value>Moves tab to a new window </value>\r\n   </data>\r\n   <data name=\"RunAsAdminFlyout.Text\" xml:space=\"preserve\">\r\n-    <value>Run as Administrator</value>\r\n+    <value>Run as administrator</value>\r\n     <comment>This text is displayed on context menu for profile entries in add new tab button.</comment>\r\n   </data>\r\n   <data name=\"TerminalPage_PaneMovedAnnouncement_ExistingTab\" xml:space=\"preserve\">\r\n@@ -893,7 +893,7 @@\n     <value>If set, the command will be appended to the profile's default command instead of replacing it.</value>\r\n   </data>\r\n   <data name=\"RestartConnectionText\" xml:space=\"preserve\">\r\n-    <value>Restart Connection</value>\r\n+    <value>Restart connection</value>\r\n   </data>\r\n   <data name=\"RestartConnectionToolTip\" xml:space=\"preserve\">\r\n     <value>Restart the active pane connection</value>\r\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex ceb3860f1ff..e0a93ee9275 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -1372,7 +1372,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         auto weakThis{ get_weak() };\r\n \r\n-        // \"Color...\"\r\n+        // \"Change tab color...\"\r\n         Controls::MenuFlyoutItem chooseColorMenuItem;\r\n         {\r\n             Controls::FontIcon colorPickSymbol;\r\n@@ -1391,7 +1391,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem renameTabMenuItem;\r\n         {\r\n-            // \"Rename Tab\"\r\n+            // \"Rename tab\"\r\n             Controls::FontIcon renameTabSymbol;\r\n             renameTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             renameTabSymbol.Glyph(L\"\\xE8AC\"); // Rename\r\n@@ -1408,7 +1408,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem duplicateTabMenuItem;\r\n         {\r\n-            // \"Duplicate Tab\"\r\n+            // \"Duplicate tab\"\r\n             Controls::FontIcon duplicateTabSymbol;\r\n             duplicateTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             duplicateTabSymbol.Glyph(L\"\\xF5ED\");\r\n@@ -1425,7 +1425,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem splitTabMenuItem;\r\n         {\r\n-            // \"Split Tab\"\r\n+            // \"Split tab\"\r\n             Controls::FontIcon splitTabSymbol;\r\n             splitTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             splitTabSymbol.Glyph(L\"\\xF246\"); // ViewDashboard\r\n@@ -1442,7 +1442,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem moveTabToNewWindowMenuItem;\r\n         {\r\n-            // \"Move Tab to New Window\"\r\n+            // \"Move tab to new window\"\r\n             Controls::FontIcon moveTabToNewWindowTabSymbol;\r\n             moveTabToNewWindowTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             moveTabToNewWindowTabSymbol.Glyph(L\"\\xE8A7\");\r\n@@ -1459,7 +1459,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem closePaneMenuItem = _closePaneMenuItem;\r\n         {\r\n-            // \"Close Pane\"\r\n+            // \"Close pane\"\r\n             closePaneMenuItem.Click({ get_weak(), &TerminalTab::_closePaneClicked });\r\n             closePaneMenuItem.Text(RS_(L\"ClosePaneText\"));\r\n \r\n@@ -1471,7 +1471,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem exportTabMenuItem;\r\n         {\r\n-            // \"Export Tab\"\r\n+            // \"Export tab\"\r\n             Controls::FontIcon exportTabSymbol;\r\n             exportTabSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             exportTabSymbol.Glyph(L\"\\xE74E\"); // Save\r\n@@ -1505,7 +1505,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         Controls::MenuFlyoutItem restartConnectionMenuItem = _restartConnectionMenuItem;\r\n         {\r\n-            // \"Restart Connection\"\r\n+            // \"Restart connection\"\r\n             Controls::FontIcon restartConnectionSymbol;\r\n             restartConnectionSymbol.FontFamily(Media::FontFamily{ L\"Segoe Fluent Icons, Segoe MDL2 Assets\" });\r\n             restartConnectionSymbol.Glyph(L\"\\xE72C\");\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\nindex 03e330d9ecd..6179099bdf5 100644\n--- a/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsModel/Resources/en-US/Resources.resw\n@@ -118,13 +118,13 @@\n     <value>System.Resources.ResXResourceWriter, System.Windows.Forms, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089</value>\r\n   </resheader>\r\n   <data name=\"SetColorSchemeParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Select color scheme...</value>\r\n+    <value>Select color scheme</value>\r\n   </data>\r\n   <data name=\"NewTabParentCommandName\" xml:space=\"preserve\">\r\n-    <value>New Tab...</value>\r\n+    <value>New tab</value>\r\n   </data>\r\n   <data name=\"SplitPaneParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Split Pane...</value>\r\n+    <value>Split pane</value>\r\n   </data>\r\n   <data name=\"ApplicationDisplayNamePortable\" xml:space=\"preserve\">\r\n     <value>Terminal (Portable)</value>\r\n@@ -325,7 +325,7 @@\n     <comment>{Locked=\"JSON\"}. \"JSON\" is the extension of the file that will be opened.</comment>\r\n   </data>\r\n   <data name=\"OpenTabColorPickerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Set the tab color...</value>\r\n+    <value>Set the tab color</value>\r\n   </data>\r\n   <data name=\"PasteTextCommandKey\" xml:space=\"preserve\">\r\n     <value>Paste</value>\r\n@@ -347,7 +347,7 @@\n     <value>Reset tab title</value>\r\n   </data>\r\n   <data name=\"OpenTabRenamerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Rename tab title...</value>\r\n+    <value>Rename tab title</value>\r\n   </data>\r\n   <data name=\"ResizePaneCommandKey\" xml:space=\"preserve\">\r\n     <value>Resize pane</value>\r\n@@ -441,7 +441,7 @@\n     <value>Switch to the last tab</value>\r\n   </data>\r\n   <data name=\"TabSearchCommandKey\" xml:space=\"preserve\">\r\n-    <value>Search for tab...</value>\r\n+    <value>Search for tab</value>\r\n   </data>\r\n   <data name=\"ToggleAlwaysOnTopCommandKey\" xml:space=\"preserve\">\r\n     <value>Toggle always on top mode</value>\r\n@@ -450,10 +450,10 @@\n     <value>Toggle command palette</value>\r\n   </data>\r\n   <data name=\"SuggestionsCommandHistoryCommandKey\" xml:space=\"preserve\">\r\n-    <value>Recent commands...</value>\r\n+    <value>Recent commands</value>\r\n   </data>\r\n   <data name=\"SuggestionsCommandKey\" xml:space=\"preserve\">\r\n-    <value>Open suggestions...</value>\r\n+    <value>Open suggestions</value>\r\n   </data>\r\n   <data name=\"ToggleCommandPaletteCommandLineModeCommandKey\" xml:space=\"preserve\">\r\n     <value>Toggle command palette in command line mode</value>\r\n@@ -505,7 +505,7 @@\n     <value>Break into the debugger</value>\r\n   </data>\r\n   <data name=\"OpenSettingsUICommandKey\" xml:space=\"preserve\">\r\n-    <value>Open settings...</value>\r\n+    <value>Open settings</value>\r\n   </data>\r\n   <data name=\"RenameWindowCommandKey\" xml:space=\"preserve\">\r\n     <value>Rename window to \"{0}\"</value>\r\n@@ -515,7 +515,7 @@\n     <value>Reset window name</value>\r\n   </data>\r\n   <data name=\"OpenWindowRenamerCommandKey\" xml:space=\"preserve\">\r\n-    <value>Rename window...</value>\r\n+    <value>Rename window</value>\r\n   </data>\r\n   <data name=\"DisplayWorkingDirectoryCommandKey\" xml:space=\"preserve\">\r\n     <value>Display Terminal's current working directory</value>\r\n@@ -566,7 +566,7 @@\n     <value>Quit the Terminal</value>\r\n   </data>\r\n   <data name=\"SetOpacityParentCommandName\" xml:space=\"preserve\">\r\n-    <value>Set background opacity...</value>\r\n+    <value>Set background opacity</value>\r\n   </data>\r\n   <data name=\"IncreaseOpacityCommandKey\" xml:space=\"preserve\">\r\n     <value>Increase background opacity by {0}%</value>\r\n", "instance_id": "microsoft__terminal-16886", "clarity": 3, "difficulty": 0.15, "clarity_explanation": "The problem statement is comprehensive and well-detailed. It clearly outlines the issues with UI style errors in the Windows Terminal application, specifically focusing on excessive capitalization and misuse of ellipses in menu items. The statement provides explicit references to Microsoft style guides and UX design guidelines, ensuring that the expected behavior is well-defined. It includes visual examples (via a linked image) and mentions specific menu items and their issues. Additionally, it addresses the impact of these issues in different languages and provides a historical context for UI design choices. There are no significant ambiguities; the goal (achieving UI consistency), the issues, and the expected fixes are all clearly articulated. The only minor omission is the lack of explicit mention of specific edge cases or localization challenges beyond a reference to other languages, but this does not detract from the overall clarity.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range, as it involves straightforward modifications to resource strings and comments in the codebase. The code changes are limited to updating text strings in resource files (`Resources.resw`) and corresponding comments in the C++ code (`TerminalTab.cpp`) to adhere to sentence-style capitalization and remove inappropriate ellipses usage. The scope of changes is narrow, affecting only specific UI text elements across a couple of files, with no impact on the system's architecture or logic. No complex technical concepts, algorithms, or deep understanding of the codebase are required beyond basic familiarity with resource files and string manipulation. There are no significant edge cases or error handling requirements mentioned or implied in the problem statement or code changes, as the task is purely cosmetic. The primary challenge might be ensuring consistency across all UI elements, but this is a minor concern given the provided diff. Overall, this is a very easy task suitable for a junior developer or someone with minimal experience in the codebase.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "gltfpack: EXT_texture_webp support\nSpec [here](https://github.com/KhronosGroup/glTF/tree/main/extensions/2.0/Vendor/EXT_texture_webp).\r\n\r\nModel before:\r\n[webp_demo.zip](https://github.com/zeux/meshoptimizer/files/10695236/webp_demo.zip)\r\n```json\r\n{\r\n\"textures\":[{\"sampler\":0,\"extensions\":{\"EXT_texture_webp\":{\"source\":0}}}],\r\n\"extensionsUsed\":[\"EXT_texture_webp\"],\"extensionsRequired\":[\"EXT_texture_webp\"]\r\n}\r\n```\r\nModel after:\r\n[webp_demo_gltfpack.zip](https://github.com/zeux/meshoptimizer/files/10695237/webp_demo_gltfpack.zip)\r\n```json\r\n{\r\n\"extensionsUsed\":[\"KHR_mesh_quantization\",\"KHR_texture_transform\"],\"extensionsRequired\":[\"KHR_mesh_quantization\"],\r\n\"textures\":[{}]\r\n}\r\n```\n", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex ac392aba4..36fd644e1 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -395,6 +395,8 @@ typedef struct cgltf_texture\n \tcgltf_sampler* sampler;\n \tcgltf_bool has_basisu;\n \tcgltf_image* basisu_image;\n+\tcgltf_bool has_webp;\n+\tcgltf_image* webp_image;\n \tcgltf_extras extras;\n \tcgltf_size extensions_count;\n \tcgltf_extension* extensions;\n@@ -4551,6 +4553,34 @@ static int cgltf_parse_json_texture(cgltf_options* options, jsmntok_t const* tok\n \t\t\t\t\t\t}\n \t\t\t\t\t}\n \t\t\t\t}\n+\t\t\t\telse if (cgltf_json_strcmp(tokens + i, json_chunk, \"EXT_texture_webp\") == 0)\n+\t\t\t\t{\n+\t\t\t\t\tout_texture->has_webp = 1;\n+\t\t\t\t\t++i;\n+\t\t\t\t\tCGLTF_CHECK_TOKTYPE(tokens[i], JSMN_OBJECT);\n+\t\t\t\t\tint num_properties = tokens[i].size;\n+\t\t\t\t\t++i;\n+\n+\t\t\t\t\tfor (int t = 0; t < num_properties; ++t)\n+\t\t\t\t\t{\n+\t\t\t\t\t\tCGLTF_CHECK_KEY(tokens[i]);\n+\n+\t\t\t\t\t\tif (cgltf_json_strcmp(tokens + i, json_chunk, \"source\") == 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t\tout_texture->webp_image = CGLTF_PTRINDEX(cgltf_image, cgltf_json_to_int(tokens + i, json_chunk));\n+\t\t\t\t\t\t\t++i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\telse\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\ti = cgltf_skip_json(tokens, i + 1);\n+\t\t\t\t\t\t}\n+\t\t\t\t\t\tif (i < 0)\n+\t\t\t\t\t\t{\n+\t\t\t\t\t\t\treturn i;\n+\t\t\t\t\t\t}\n+\t\t\t\t\t}\n+\t\t\t\t}\n \t\t\t\telse\n \t\t\t\t{\n \t\t\t\t\ti = cgltf_parse_json_unprocessed_extension(options, tokens, i, json_chunk, &(out_texture->extensions[out_texture->extensions_count++]));\n@@ -6561,6 +6591,7 @@ static int cgltf_fixup_pointers(cgltf_data* data)\n \t{\n \t\tCGLTF_PTRFIXUP(data->textures[i].image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].basisu_image, data->images, data->images_count);\n+\t\tCGLTF_PTRFIXUP(data->textures[i].webp_image, data->images, data->images_count);\n \t\tCGLTF_PTRFIXUP(data->textures[i].sampler, data->samplers, data->samplers_count);\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex ffe6d1e12..4b278676a 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -85,6 +85,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_texture_transform\n - EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n+- EXT_texture_webp\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\n \ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex f3156d3e3..ee46fa6a7 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -454,6 +454,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tbool ext_instancing = false;\n \tbool ext_texture_transform = false;\n \tbool ext_texture_basisu = false;\n+\tbool ext_texture_webp = false;\n \n \tsize_t accr_offset = 0;\n \tsize_t node_offset = 0;\n@@ -512,6 +513,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\tassert(textures[i].remap == int(texture_offset));\n \t\ttexture_offset++;\n \t\text_texture_basisu = ext_texture_basisu || texture.has_basisu;\n+\t\text_texture_webp = ext_texture_webp || texture.has_webp;\n \t}\n \n \tfor (size_t i = 0; i < data->materials_count; ++i)\n@@ -838,6 +840,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t    {\"KHR_materials_variants\", data->variants_count > 0, false},\n \t    {\"KHR_lights_punctual\", data->lights_count > 0, false},\n \t    {\"KHR_texture_basisu\", (!json_textures.empty() && settings.texture_ktx2) || ext_texture_basisu, true},\n+\t    {\"EXT_texture_webp\", ext_texture_webp, true},\n \t    {\"EXT_mesh_gpu_instancing\", ext_instancing, true},\n \t};\n \ndiff --git a/gltf/image.cpp b/gltf/image.cpp\nindex 129938a0e..972b4c441 100644\n--- a/gltf/image.cpp\n+++ b/gltf/image.cpp\n@@ -8,6 +8,7 @@ static const char* kMimeTypes[][2] = {\n     {\"image/jpeg\", \".jpeg\"},\n     {\"image/png\", \".png\"},\n     {\"image/ktx2\", \".ktx2\"},\n+    {\"image/webp\", \".webp\"},\n };\n \n static const char* inferMimeType(const char* path)\n@@ -128,6 +129,7 @@ static int readInt32LE(const std::string& data, size_t offset)\n \t       (unsigned((unsigned char)data[offset + 3]) << 24);\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool getDimensionsPng(const std::string& data, int& width, int& height)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -146,6 +148,7 @@ static bool getDimensionsPng(const std::string& data, int& width, int& height)\n \treturn true;\n }\n \n+// https://en.wikipedia.org/wiki/JPEG_File_Interchange_Format#File_format_structure\n static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n {\n \tsize_t offset = 0;\n@@ -189,6 +192,7 @@ static bool getDimensionsJpeg(const std::string& data, int& width, int& height)\n \treturn false;\n }\n \n+// https://en.wikipedia.org/wiki/PNG#File_format\n static bool hasTransparencyPng(const std::string& data)\n {\n \tif (data.size() < 8 + 8 + 13 + 4)\n@@ -224,6 +228,7 @@ static bool hasTransparencyPng(const std::string& data)\n \treturn false;\n }\n \n+// https://github.khronos.org/KTX-Specification/ktxspec.v2.html\n static bool hasTransparencyKtx2(const std::string& data)\n {\n \tif (data.size() < 12 + 17 * 4)\n@@ -261,12 +266,45 @@ static bool hasTransparencyKtx2(const std::string& data)\n \treturn false;\n }\n \n+// https://developers.google.com/speed/webp/docs/riff_container\n+static bool hasTransparencyWebP(const std::string& data)\n+{\n+\tif (data.size() < 12 + 4 + 12)\n+\t\treturn false;\n+\n+\tif (data.compare(0, 4, \"RIFF\") != 0)\n+\t\treturn false;\n+\tif (data.compare(8, 4, \"WEBP\") != 0)\n+\t\treturn false;\n+\n+\t// WebP data may use VP8L, VP8X or VP8 format, but VP8 does not support transparency\n+\tif (data.compare(12, 4, \"VP8L\") == 0)\n+\t{\n+\t\tif (unsigned(data[20]) != 0x2f)\n+\t\t\treturn false;\n+\n+\t\t// width (14) | height (14) | alpha_is_used (1) | version_number(3)\n+\t\tunsigned int header = readInt32LE(data, 21);\n+\t\treturn (header & (1 << 28)) != 0;\n+\t}\n+\telse if (data.compare(12, 4, \"VP8X\") == 0)\n+\t{\n+\t\t// zero (2) | icc (1) | alpha (1) | exif (1) | xmp (1) | animation (1) | zero (1)\n+\t\tunsigned char header = data[20];\n+\t\treturn (header & (1 << 4)) != 0;\n+\t}\n+\n+\treturn false;\n+}\n+\n bool hasAlpha(const std::string& data, const char* mime_type)\n {\n \tif (strcmp(mime_type, \"image/png\") == 0)\n \t\treturn hasTransparencyPng(data);\n \telse if (strcmp(mime_type, \"image/ktx2\") == 0)\n \t\treturn hasTransparencyKtx2(data);\n+\telse if (strcmp(mime_type, \"image/webp\") == 0)\n+\t\treturn hasTransparencyWebP(data);\n \telse\n \t\treturn false;\n }\ndiff --git a/gltf/material.cpp b/gltf/material.cpp\nindex 0931b2e05..68d5610c8 100644\n--- a/gltf/material.cpp\n+++ b/gltf/material.cpp\n@@ -11,10 +11,10 @@ static bool areTexturesEqual(const cgltf_texture& lhs, const cgltf_texture& rhs)\n \tif (lhs.sampler != rhs.sampler)\n \t\treturn false;\n \n-\tif (lhs.has_basisu != rhs.has_basisu)\n+\tif (lhs.basisu_image != rhs.basisu_image)\n \t\treturn false;\n \n-\tif (lhs.basisu_image != rhs.basisu_image)\n+\tif (lhs.webp_image != rhs.webp_image)\n \t\treturn false;\n \n \treturn true;\n@@ -446,9 +446,12 @@ static const cgltf_image* getTextureImage(const cgltf_texture* texture)\n \tif (texture && texture->image)\n \t\treturn texture->image;\n \n-\tif (texture && texture->has_basisu && texture->basisu_image)\n+\tif (texture && texture->basisu_image)\n \t\treturn texture->basisu_image;\n \n+\tif (texture && texture->webp_image)\n+\t\treturn texture->webp_image;\n+\n \treturn NULL;\n }\n \ndiff --git a/gltf/write.cpp b/gltf/write.cpp\nindex 13f2f3ad5..429d0c446 100644\n--- a/gltf/write.cpp\n+++ b/gltf/write.cpp\n@@ -975,13 +975,20 @@ void writeTexture(std::string& json, const cgltf_texture& texture, const ImageIn\n \t\t}\n \t}\n \n-\tif (texture.has_basisu && texture.basisu_image)\n+\tif (texture.basisu_image)\n \t{\n \t\tcomma(json);\n \t\tappend(json, \"\\\"extensions\\\":{\\\"KHR_texture_basisu\\\":{\\\"source\\\":\");\n \t\tappend(json, size_t(texture.basisu_image - data->images));\n \t\tappend(json, \"}}\");\n \t}\n+\telse if (texture.webp_image)\n+\t{\n+\t\tcomma(json);\n+\t\tappend(json, \"\\\"extensions\\\":{\\\"EXT_texture_webp\\\":{\\\"source\\\":\");\n+\t\tappend(json, size_t(texture.webp_image - data->images));\n+\t\tappend(json, \"}}\");\n+\t}\n }\n \n void writeMeshAttributes(std::string& json, std::vector<BufferView>& views, std::string& json_accessors, size_t& accr_offset, const Mesh& mesh, int target, const QuantizationPosition& qp, const QuantizationTexture& qt, const Settings& settings)\n", "instance_id": "zeux__meshoptimizer-709", "clarity": 2, "difficulty": 0.5, "clarity_explanation": "The problem statement is mostly clear in its intent to add support for the EXT_texture_webp extension in the gltfpack tool, as part of handling WebP texture formats in glTF models. It provides a reference to the specification and includes before-and-after examples of the model JSON, which helps in understanding the expected transformation. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior when processing WebP textures (e.g., whether they should be preserved, converted, or handled differently based on certain conditions). Additionally, edge cases, constraints, or specific requirements for WebP support (like compatibility with other extensions or tools) are not mentioned. While the provided JSON snippets and linked specification help, the lack of detailed requirements or explicit goals beyond \"support\" leaves room for interpretation, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.50) due to several factors. \n\n1. **Scope and Depth of Code Changes:** The changes span multiple files (cgltf.h, gltfpack.cpp, image.cpp, material.cpp, write.cpp, and README.md), indicating a moderate impact across the codebase. The modifications involve adding new fields to data structures, updating parsing logic, handling image transparency, and ensuring proper serialization of the WebP extension in the output. While the changes are not architecturally significant (they don't alter the core design of gltfpack), they require understanding and modifying several interconnected components, such as texture handling, image processing, and JSON output generation.\n\n2. **Technical Concepts Involved:** Solving this problem requires familiarity with the glTF format and its extension mechanism, specifically EXT_texture_webp. It also involves knowledge of C++ (struct modifications, pointer handling), JSON parsing (via cgltf library), and image format specifics (WebP container structure for transparency detection). Additionally, the developer must understand how gltfpack processes textures and extensions, which involves some domain-specific knowledge of 3D model optimization. While these concepts are not overly complex for an experienced developer, they do require a moderate level of expertise and research into the WebP format and glTF specifications.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes introduce logic for detecting WebP transparency and handling different WebP formats (VP8L, VP8X). This suggests some consideration of edge cases, such as invalid or unsupported WebP data. The code also includes error checking during JSON parsing for the extension. However, the complexity of these edge cases is moderate, as they are mostly confined to format validation and do not involve intricate error recovery or performance-critical scenarios.\n\n4. **Overall Complexity:** The task requires a developer to integrate a new feature (WebP texture support) into an existing system, which involves understanding the glTF ecosystem, making consistent updates across multiple modules, and ensuring compatibility with existing functionality (e.g., other texture formats like PNG or KTX2). While not overly challenging, it is more than a simple bug fix or feature addition due to the need for cross-file modifications and domain knowledge. It does not reach the \"hard\" category as it lacks deep architectural changes, complex algorithms, or significant performance optimization challenges.\n\nThus, a difficulty score of 0.50 reflects a medium-level problem that requires a solid understanding of the codebase and moderate technical skills to implement correctly.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[FEATURE] Optimize compilation speed by reorganize headers\n# Introduction\r\n\r\nThe calculation core is a header-only library in C++. In each build target of unit test, C API, validation test, etc, we have multiple translation units (`.cpp` files). The compilation speed is slow in both CI and local development machine. This is frustrating and slows down the development.\r\n\r\n# Proposal\r\n\r\nWe would like to re-organize the headers in the header only library to reduce the dependencies between the headers. Hopefully we can increase the compilation speed. Possible ways of improvement can be:\r\n\r\n1. Remove most of the standard library include in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp). Only keep the absolute common standard libraries (like `cstddef`). Include the needed standard library in individual header files where it is needed.\r\n2. Forward declare classes in the main file [`power_grid_model.hpp`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/power_grid_model.hpp), so that other headers can use the opaque type if the full type is not needed. This reduces the dependencies between the headers.\r\n3. Use separate header file with `type_traits` types to specify the `input`, `update`, .. types of each component. In this way, when compiling meta-data (like serializer), we do not need to include all the component types, only the traiter types.\r\n4. Make the `MathSolver` a generic template class with supported solvers, just like how the `MainModelImpl` is templated with the components\r\n5. Move generic template class `using` declarations like [`using MainModel = MainModelImpl<...>;`](https://github.com/PowerGridModel/power-grid-model/blob/main/power_grid_model_c/power_grid_model/include/power_grid_model/main_model.hpp#L1225-L1228) to separate header files, e.g. `main_model.hpp` and `main_model_impl.hpp`. The tester of dispatch functionality of the `MainModel` could then use a component-less instance.\r\n\n", "patch": "diff --git a/power_grid_model_c/power_grid_model_c/src/buffer.cpp b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\nindex aeb6374bc..d4d268674 100644\n--- a/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n+++ b/power_grid_model_c/power_grid_model_c/src/buffer.cpp\n@@ -20,10 +20,15 @@ using meta_data::RawDataPtr;\n \n // buffer control\n RawDataPtr PGM_create_buffer(PGM_Handle* /* handle */, PGM_MetaComponent const* component, PGM_Idx size) {\n+    // alignment should be maximum of alignment of the component and alignment of void*\n+    size_t const alignment = std::max(component->alignment, sizeof(void*));\n+    // total bytes should be multiple of alignment\n+    size_t const requested_bytes = component->size * size;\n+    size_t const rounded_bytes = ((requested_bytes + alignment - 1) / alignment) * alignment;\n #ifdef _WIN32\n-    return _aligned_malloc(component->size * size, component->alignment);\n+    return _aligned_malloc(rounded_bytes, alignment);\n #else\n-    return std::aligned_alloc(component->alignment, component->size * size);\n+    return std::aligned_alloc(alignment, rounded_bytes);\n #endif\n }\n void PGM_destroy_buffer(RawDataPtr ptr) {\n", "instance_id": "PowerGridModel__power-grid-model-718", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in its intent to optimize compilation speed by reorganizing headers in a C++ header-only library. The introduction provides context about the issue (slow compilation speed in CI and local development), and the proposal lists specific strategies for improvement, such as reducing standard library includes, forward declarations, and separating type definitions into different headers. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not specify measurable goals or benchmarks for \"improved compilation speed,\" nor does it provide concrete examples of current dependencies causing issues. Additionally, there is no mention of potential risks or trade-offs (e.g., increased maintenance complexity due to header reorganization). Edge cases or constraints, such as compatibility with existing code or specific build systems, are also not addressed. While the overall goal and approach are understandable, these missing details could lead to misinterpretation or incomplete solutions.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The proposed changes involve reorganizing headers across a header-only C++ library, which likely affects multiple files and modules. Modifications to core files like `power_grid_model.hpp` and `main_model.hpp` suggest a deep impact on the codebase's structure. The suggestions (e.g., forward declarations, separating type traits, and templating `MathSolver`) indicate a need for systemic refactoring rather than isolated changes. While the provided code diff (in `buffer.cpp`) is minor and unrelated to the main header reorganization, it hints at potential broader changes not fully shown in the snippet. The overall scope appears significant, potentially affecting the entire build process and architecture of the library.\n\n2. **Clarity and Complexity of Problem Logic**: The problem's logic is inherently complex as it deals with compilation speed optimization, a non-trivial aspect of C++ development. Reducing header dependencies requires a deep understanding of include graphs, translation units, and how the compiler processes headers. The proposed solutions, such as forward declarations and splitting type definitions, add further complexity as they require careful design to avoid breaking existing code or introducing circular dependencies.\n\n3. **Number of Technical Concepts**: Solving this problem demands expertise in several advanced C++ concepts, including header dependency management, forward declarations, template metaprogramming (for `MathSolver` and `MainModelImpl`), and type traits. Additionally, knowledge of build systems (e.g., CMake or similar) and compiler behavior (e.g., how includes affect compilation time) is necessary. These concepts are not beginner-friendly and require significant experience to apply correctly in a large codebase.\n\n4. **Edge Cases and Error Handling**: While the problem statement does not explicitly mention edge cases, the nature of header reorganization implies several potential pitfalls, such as breaking existing code due to missing includes, introducing circular dependencies, or affecting downstream consumers of the library (e.g., unit tests, C API). Error handling in the build process (e.g., ensuring compatibility across platforms or compilers) may also need to be considered. These implicit edge cases add to the difficulty, as they require foresight and thorough testing.\n\nOverall, this problem requires a deep understanding of C++ internals, careful refactoring across multiple files, and consideration of subtle build-time impacts. It falls short of \"Very Hard\" (0.8-1.0) because it does not appear to involve system-level or domain-specific challenges beyond compilation optimization (e.g., no distributed systems or complex algorithms are mentioned). However, it is still a challenging task best suited for experienced developers familiar with large-scale C++ projects.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "run script doesn't upload dsym files when <paths> parameter passed\n### Description\n\nWhen I try to upload multiple dsym files with <paths> parameter using run, it doesn't start uploading at all. I see this output in the build logs:\r\n\r\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"my.dSYM\", \"myother.dSYM\", \"--build-phase \", \"--validate\"]\r\n\r\nWhen I change these lines in the run script:\r\n```\r\nVALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\r\nUPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\r\n```\r\nto\r\n```\r\nVALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\r\nUPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS\"\r\n```\r\nit works, since the <paths> parameter should be the last parameter.\n\n### Reproducing the issue\n\nCall the run scirpt with a paths parameter to point another dSYM file.\n\n### Firebase SDK Version\n\n11.4\n\n### Xcode Version\n\n16\n\n### Installation Method\n\nCocoaPods\n\n### Firebase Product(s)\n\nCrashlytics\n\n### Targeted Platforms\n\niOS\n\n### Relevant Log Output\n\n```shell\nShowing All Messages, Filtering for \"dsym\".\r\nDSYM Paths: [\"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChat-Debug.app.dSYM\", \"/Users/osrl/Library/Developer/Xcode/DerivedData/MonoChat-bnvacbqslsvvixekiyryrsoiawlx/Build/Products/Debug-iphonesimulator/MonoChatShared.framework.dSYM\", \"--build-phase\", \"--validate\"]\n```\n\n\n### If using Swift Package Manager, the project's Package.resolved\n\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\n\n### If using CocoaPods, the project's Podfile.lock\n\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nPODS:\r\n  - FirebaseAnalytics (11.4.0):\r\n    - FirebaseAnalytics/AdIdSupport (= 11.4.0)\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseAnalytics/AdIdSupport (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleAppMeasurement (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - FirebaseCore (11.4.2):\r\n    - FirebaseCoreInternal (< 12.0, >= 11.4.2)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/Logger (~> 8.0)\r\n  - FirebaseCoreExtension (11.4.1):\r\n    - FirebaseCore (~> 11.0)\r\n  - FirebaseCoreInternal (11.4.2):\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n  - FirebaseCrashlytics (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - FirebaseRemoteConfigInterop (~> 11.0)\r\n    - FirebaseSessions (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseInstallations (11.4.0):\r\n    - FirebaseCore (~> 11.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - FirebaseRemoteConfigInterop (11.4.0)\r\n  - FirebaseSessions (11.4.0):\r\n    - FirebaseCore (~> 11.4)\r\n    - FirebaseCoreExtension (~> 11.4)\r\n    - FirebaseInstallations (~> 11.0)\r\n    - GoogleDataTransport (~> 10.0)\r\n    - GoogleUtilities/Environment (~> 8.0)\r\n    - GoogleUtilities/UserDefaults (~> 8.0)\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesSwift (~> 2.1)\r\n  - GoogleAppMeasurement (11.4.0):\r\n    - GoogleAppMeasurement/AdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/AdIdSupport (11.4.0):\r\n    - GoogleAppMeasurement/WithoutAdIdSupport (= 11.4.0)\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleAppMeasurement/WithoutAdIdSupport (11.4.0):\r\n    - GoogleUtilities/AppDelegateSwizzler (~> 8.0)\r\n    - GoogleUtilities/MethodSwizzler (~> 8.0)\r\n    - GoogleUtilities/Network (~> 8.0)\r\n    - \"GoogleUtilities/NSData+zlib (~> 8.0)\"\r\n    - nanopb (~> 3.30910.0)\r\n  - GoogleDataTransport (10.1.0):\r\n    - nanopb (~> 3.30910.0)\r\n    - PromisesObjC (~> 2.4)\r\n  - GoogleUtilities/AppDelegateSwizzler (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Network\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Environment (8.0.2):\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Logger (8.0.2):\r\n    - GoogleUtilities/Environment\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/MethodSwizzler (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Network (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - \"GoogleUtilities/NSData+zlib\"\r\n    - GoogleUtilities/Privacy\r\n    - GoogleUtilities/Reachability\r\n  - \"GoogleUtilities/NSData+zlib (8.0.2)\":\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/Privacy (8.0.2)\r\n  - GoogleUtilities/Reachability (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - GoogleUtilities/UserDefaults (8.0.2):\r\n    - GoogleUtilities/Logger\r\n    - GoogleUtilities/Privacy\r\n  - KMPNativeCoroutinesAsync (1.0.0-ALPHA-34):\r\n    - KMPNativeCoroutinesCore (= 1.0.0-ALPHA-34)\r\n  - KMPNativeCoroutinesCore (1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelCore (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCoreObjC (= 1.0.0-BETA-4)\r\n  - KMPObservableViewModelCoreObjC (1.0.0-BETA-4)\r\n  - KMPObservableViewModelSwiftUI (1.0.0-BETA-4):\r\n    - KMPObservableViewModelCore (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (5.3.92)\r\n  - lottie-ios (4.5.0)\r\n  - MijickPopupView (2.7.1)\r\n  - nanopb (3.30910.0):\r\n    - nanopb/decode (= 3.30910.0)\r\n    - nanopb/encode (= 3.30910.0)\r\n  - nanopb/decode (3.30910.0)\r\n  - nanopb/encode (3.30910.0)\r\n  - OneSignalXCFramework (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalExtension (= 3.12.10)\r\n    - OneSignalXCFramework/OneSignalOutcomes (= 3.12.10)\r\n  - OneSignalXCFramework/OneSignalCore (3.12.10)\r\n  - OneSignalXCFramework/OneSignalExtension (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n    - OneSignalXCFramework/OneSignalOutcomes\r\n  - OneSignalXCFramework/OneSignalOutcomes (3.12.10):\r\n    - OneSignalXCFramework/OneSignalCore\r\n  - PromisesObjC (2.4.0)\r\n  - PromisesSwift (2.4.0):\r\n    - PromisesObjC (= 2.4.0)\r\n\r\nDEPENDENCIES:\r\n  - FirebaseAnalytics\r\n  - FirebaseCrashlytics\r\n  - KMPNativeCoroutinesAsync (= 1.0.0-ALPHA-34)\r\n  - KMPObservableViewModelSwiftUI (= 1.0.0-BETA-4)\r\n  - linphone-sdk-novideo (~> 5.3.90)\r\n  - lottie-ios\r\n  - MijickPopupView\r\n  - OneSignalXCFramework (~> 3.12.9)\r\n\r\nSPEC REPOS:\r\n  https://github.com/CocoaPods/Specs.git:\r\n    - FirebaseAnalytics\r\n    - FirebaseCore\r\n    - FirebaseCoreExtension\r\n    - FirebaseCoreInternal\r\n    - FirebaseCrashlytics\r\n    - FirebaseInstallations\r\n    - FirebaseRemoteConfigInterop\r\n    - FirebaseSessions\r\n    - GoogleAppMeasurement\r\n    - GoogleDataTransport\r\n    - GoogleUtilities\r\n    - KMPNativeCoroutinesAsync\r\n    - KMPNativeCoroutinesCore\r\n    - KMPObservableViewModelCore\r\n    - KMPObservableViewModelCoreObjC\r\n    - KMPObservableViewModelSwiftUI\r\n    - lottie-ios\r\n    - MijickPopupView\r\n    - nanopb\r\n    - OneSignalXCFramework\r\n    - PromisesObjC\r\n    - PromisesSwift\r\n  https://gitlab.linphone.org/BC/public/podspec.git:\r\n    - linphone-sdk-novideo\r\n\r\nSPEC CHECKSUMS:\r\n  FirebaseAnalytics: 3feef9ae8733c567866342a1000691baaa7cad49\r\n  FirebaseCore: 6b32c57269bd999aab34354c3923d92a6e5f3f84\r\n  FirebaseCoreExtension: f1bc67a4702931a7caa097d8e4ac0a1b0d16720e\r\n  FirebaseCoreInternal: 35731192cab10797b88411be84940d2beb33a238\r\n  FirebaseCrashlytics: 41bbdd2b514a8523cede0c217aee6ef7ecf38401\r\n  FirebaseInstallations: 6ef4a1c7eb2a61ee1f74727d7f6ce2e72acf1414\r\n  FirebaseRemoteConfigInterop: e76f46ffa4d6a65e273d4dfebb6a79e588cec136\r\n  FirebaseSessions: 3f56f177d9e53a85021d16b31f9a111849d1dd8b\r\n  GoogleAppMeasurement: 987769c4ca6b968f2479fbcc9fe3ce34af454b8e\r\n  GoogleDataTransport: aae35b7ea0c09004c3797d53c8c41f66f219d6a7\r\n  GoogleUtilities: 26a3abef001b6533cf678d3eb38fd3f614b7872d\r\n  KMPNativeCoroutinesAsync: 709d922d3c8db3b83c5f0ce4035123dd7e6187b1\r\n  KMPNativeCoroutinesCore: 7e18aa574381ab40ea6a5b90ec2dffd362c0082b\r\n  KMPObservableViewModelCore: ded4abdfcc3566844c8dd18e23accd5cacd89a91\r\n  KMPObservableViewModelCoreObjC: d74dbf0c84cb8f66d6c706e89add1df9b8f653f4\r\n  KMPObservableViewModelSwiftUI: c3f740105ba32cd964cab1794d631b759d76a1d0\r\n  linphone-sdk-novideo: 50b8bcad0511613eca167586e75858f03cbaeb03\r\n  lottie-ios: a881093fab623c467d3bce374367755c272bdd59\r\n  MijickPopupView: 54863e093a18d6435cd5068850414570f9c1ba07\r\n  nanopb: fad817b59e0457d11a5dfbde799381cd727c1275\r\n  OneSignalXCFramework: e458f7a374192598a1d66418e1b61481c3cdf0e9\r\n  PromisesObjC: f5707f49cb48b9636751c5b2e7d227e43fba9f47\r\n  PromisesSwift: 9d77319bbe72ebf6d872900551f7eeba9bce2851\r\n\r\nPODFILE CHECKSUM: 4a3c4d0cf9b5f244d507d3ec13bca26d8124fa8b\r\n\r\nCOCOAPODS: 1.15.2\r\n\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/Crashlytics/run b/Crashlytics/run\nindex 93a6f11e7ae..bb1d43d8f0f 100755\n--- a/Crashlytics/run\n+++ b/Crashlytics/run\n@@ -46,8 +46,8 @@ for i in \"$@\"; do\n   ARGUMENTS=\"$ARGUMENTS \\\"$i\\\"\"\n done\n \n-VALIDATE_ARGUMENTS=\"$ARGUMENTS --build-phase --validate\"\n-UPLOAD_ARGUMENTS=\"$ARGUMENTS --build-phase\"\n+VALIDATE_ARGUMENTS=\"--build-phase --validate $ARGUMENTS\"\n+UPLOAD_ARGUMENTS=\"--build-phase $ARGUMENTS \"\n \n # Quote the path to handle folders with special characters\n COMMAND_PATH=\"\\\"$DIR/upload-symbols\\\" \"\n", "instance_id": "firebase__firebase-ios-sdk-13966", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `run` script fails to upload dSYM files when the `<paths>` parameter is passed, due to the order of arguments in the script. The description includes relevant logs, reproduction steps, and context about the environment (Firebase SDK version, Xcode version, installation method, etc.), which helps in understanding the issue. The provided solution (reordering the arguments) is also clear. However, there are minor ambiguities, such as a lack of detailed explanation about why the order of arguments matters or what the expected behavior of the `--build-phase` and `--validate` flags is. Additionally, edge cases or potential side effects of the change are not mentioned, which could be critical for a complete understanding. Overall, the statement is valid and clear but misses some minor details, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward fix to a shell script by reordering arguments in two lines of code. The scope of the change is minimal, confined to a single file (`Crashlytics/run`), and does not impact the broader codebase or system architecture. The technical concepts required are basic shell scripting and understanding of command-line argument handling, which are not complex. There are no significant edge cases or error handling requirements mentioned in the problem statement, and the provided logs and reproduction steps make the issue easy to diagnose and resolve. The change is essentially a small bug fix with no deep understanding of the Firebase Crashlytics system or iOS development required beyond the script itself. Therefore, I assign a difficulty score of 0.15, placing it in the \"Very Easy\" range (0.0-0.2), as it requires only a basic code modification.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Cleanup deprecated notification API usages in Firebase\n### Description\r\n\r\nFirebase has multiple usages of the deprecated ` (void)application:(UIApplication *)application\r\n    didReceiveRemoteNotification:(NSDictionary *)userInfo ` API. \r\n\r\nIt's usages should be removed across Firebase and GoogleUtilities.\r\n\r\nIn addition, GoogleUtilities should stop conditionalizing the swizzling of the replacement API: https://github.com/google/GoogleUtilities/blame/main/GoogleUtilities/AppDelegateSwizzler/GULAppDelegateSwizzler.m#L520\r\n\r\nAuth part of this is done in #13003 \r\nGoogleUtilities in https://github.com/google/GoogleUtilities/pull/162\r\nFirebaseMessging and CocoaPods updates still need to be done.\r\n\r\n### Reproducing the issue\r\n\r\n_No response_\r\n\r\n### Firebase SDK Version\r\n\r\nAll\r\n\r\n### Xcode Version\r\n\r\n14.3\r\n\r\n### Installation Method\r\n\r\nN/A\r\n\r\n### Firebase Product(s)\r\n\r\nAuthentication\r\n\r\n### Targeted Platforms\r\n\r\niOS\r\n\r\n### Relevant Log Output\r\n\r\n_No response_\r\n\r\n### If using Swift Package Manager, the project's Package.resolved\r\n\r\n<!--- Look below for instructions on how to share your Package.resolved. --->\r\n\r\n<details>\r\n<summary>Expand <code>Package.resolved</code> snippet</summary>\r\n<br>\r\n\r\n```json\r\n\r\nReplace this line with the contents of your Package.resolved.\r\n\r\n```\r\n\r\n</details>\r\n\r\n\r\n### If using CocoaPods, the project's Podfile.lock\r\n\r\n<!--- Look below for instructions on how to share your Podfile.lock. --->\r\n\r\n<details>\r\n<summary>Expand <code>Podfile.lock</code> snippet</summary>\r\n<br>\r\n\r\n```yml\r\n\r\nReplace this line with the contents of your Podfile.lock!\r\n\r\n```\r\n\r\n</details>\r\n\n", "patch": "diff --git a/FirebaseMessaging/Sources/FIRMessaging.m b/FirebaseMessaging/Sources/FIRMessaging.m\nindex 9511d34a29e..9a688b034be 100644\n--- a/FirebaseMessaging/Sources/FIRMessaging.m\n+++ b/FirebaseMessaging/Sources/FIRMessaging.m\n@@ -437,9 +437,7 @@ - (void)handleIncomingLinkIfNeededFromMessage:(NSDictionary *)message {\n     // Similarly, |application:openURL:sourceApplication:annotation:| will also always be called,\n     // due to the default swizzling done by FIRAAppDelegateProxy in Firebase Analytics\n   } else if ([appDelegate respondsToSelector:openURLWithSourceApplicationSelector]) {\n-// TODO(Xcode 15): When Xcode 15 is the minimum supported Xcode version, it will be unnecessary to\n-// check if `TARGET_OS_VISION` is defined.\n-#if TARGET_OS_IOS && (!defined(TARGET_OS_VISION) || !TARGET_OS_VISION)\n+#if TARGET_OS_IOS\n #pragma clang diagnostic push\n #pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n     [appDelegate application:application\ndiff --git a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\nindex 52c5ff0f82d..5cd5d8b16a2 100644\n--- a/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n+++ b/FirebaseMessaging/Sources/FIRMessagingRemoteNotificationsProxy.m\n@@ -384,13 +384,6 @@ id FIRMessagingPropertyNameFromObject(id object, NSString *propertyName, Class k\n }\n \n #pragma mark - GULApplicationDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  [[FIRMessaging messaging] appDidReceiveMessage:userInfo];\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\nindex 6bf33f9b5d6..ea061e8a284 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingAPNSInfo.m\n@@ -75,10 +75,12 @@ + (BOOL)supportsSecureCoding {\n }\n \n - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n-  id deviceToken = [aDecoder decodeObjectForKey:kFIRInstanceIDAPNSInfoTokenKey];\n-  if (![deviceToken isKindOfClass:[NSData class]]) {\n+  NSData *deviceToken = [aDecoder decodeObjectOfClass:[NSData class]\n+                                               forKey:kFIRInstanceIDAPNSInfoTokenKey];\n+  if (!deviceToken) {\n     return nil;\n   }\n+\n   BOOL isSandbox = [aDecoder decodeBoolForKey:kFIRInstanceIDAPNSInfoSandboxKey];\n   return [self initWithDeviceToken:(NSData *)deviceToken isSandbox:isSandbox];\n }\ndiff --git a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\nindex 90420d1e72e..2852f0cad69 100644\n--- a/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n+++ b/FirebaseMessaging/Sources/Token/FIRMessagingTokenInfo.m\n@@ -143,32 +143,29 @@ - (nullable instancetype)initWithCoder:(NSCoder *)aDecoder {\n   BOOL needsMigration = NO;\n   // These value cannot be nil\n \n-  id authorizedEntity = [aDecoder decodeObjectForKey:kFIRInstanceIDAuthorizedEntityKey];\n-  if (![authorizedEntity isKindOfClass:[NSString class]]) {\n+  NSString *authorizedEntity = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                      forKey:kFIRInstanceIDAuthorizedEntityKey];\n+  if (!authorizedEntity) {\n     return nil;\n   }\n \n-  id scope = [aDecoder decodeObjectForKey:kFIRInstanceIDScopeKey];\n-  if (![scope isKindOfClass:[NSString class]]) {\n+  NSString *scope = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDScopeKey];\n+  if (!scope) {\n     return nil;\n   }\n \n-  id token = [aDecoder decodeObjectForKey:kFIRInstanceIDTokenKey];\n-  if (![token isKindOfClass:[NSString class]]) {\n+  NSString *token = [aDecoder decodeObjectOfClass:[NSString class] forKey:kFIRInstanceIDTokenKey];\n+  if (!token) {\n     return nil;\n   }\n \n-  // These values are nullable, so only fail the decode if the type does not match\n+  // These values are nullable, so don't fail on nil.\n \n-  id appVersion = [aDecoder decodeObjectForKey:kFIRInstanceIDAppVersionKey];\n-  if (appVersion && ![appVersion isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n+  NSString *appVersion = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                forKey:kFIRInstanceIDAppVersionKey];\n+  NSString *firebaseAppID = [aDecoder decodeObjectOfClass:[NSString class]\n+                                                   forKey:kFIRInstanceIDFirebaseAppIDKey];\n \n-  id firebaseAppID = [aDecoder decodeObjectForKey:kFIRInstanceIDFirebaseAppIDKey];\n-  if (firebaseAppID && ![firebaseAppID isKindOfClass:[NSString class]]) {\n-    return nil;\n-  }\n   NSSet *classes = [[NSSet alloc] initWithArray:@[ FIRMessagingAPNSInfo.class ]];\n   FIRMessagingAPNSInfo *rawAPNSInfo = [aDecoder decodeObjectOfClasses:classes\n                                                                forKey:kFIRInstanceIDAPNSInfoKey];\ndiff --git a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\nindex d3bbdc3ead3..16f7086f1d3 100644\n--- a/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n+++ b/FirebaseMessaging/Tests/UnitTests/FIRMessagingRemoteNotificationsProxyTest.m\n@@ -64,19 +64,13 @@ @interface FakeAppDelegate : NSObject <GULApplicationDelegate>\n @property(nonatomic, strong) NSError *registerForRemoteNotificationsError;\n @end\n @implementation FakeAppDelegate\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-implementations\"\n-- (void)application:(GULApplication *)application\n-    didReceiveRemoteNotification:(NSDictionary *)userInfo {\n-  self.remoteNotificationMethodWasCalled = YES;\n-}\n-#pragma clang diagnostic pop\n \n #if TARGET_OS_IOS || TARGET_OS_TV\n - (void)application:(UIApplication *)application\n     didReceiveRemoteNotification:(NSDictionary *)userInfo\n           fetchCompletionHandler:(void (^)(UIBackgroundFetchResult))completionHandler {\n   self.remoteNotificationWithFetchHandlerWasCalled = YES;\n+  completionHandler(UIBackgroundFetchResultNewData);\n }\n #endif\n \n@@ -192,6 +186,7 @@ - (void)testSwizzlingNonAppDelegate {\n #if !SWIFT_PACKAGE\n // The next 3 tests depend on a sharedApplication which is not available in the Swift PM test env.\n - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n+  XCTestExpectation *expectation = [self expectationWithDescription:@\"completion\"];\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n   [self.proxy swizzleMethodsIfPossible];\n@@ -199,15 +194,18 @@ - (void)testSwizzledIncompleteAppDelegateRemoteNotificationMethod {\n   NSDictionary *notification = @{@\"test\" : @\"\"};\n   OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n \n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n   [incompleteAppDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-        didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n+        didReceiveRemoteNotification:notification\n+              fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+                [expectation fulfill];\n+              }];\n \n   [self.mockMessaging verify];\n+  [self waitForExpectationsWithTimeout:0.5 handler:nil];\n }\n \n+// This test demonstrates the difference between Firebase 10 and 11. In 10 and earlier the\n+// swizzler inserts the old `didReceiveRemoteNotification` method. In 11, the new.\n - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n   IncompleteAppDelegate *incompleteAppDelegate = [[IncompleteAppDelegate alloc] init];\n   [[GULAppDelegateSwizzler sharedApplication] setDelegate:incompleteAppDelegate];\n@@ -216,11 +214,11 @@ - (void)testIncompleteAppDelegateRemoteNotificationWithFetchHandlerMethod {\n #if TARGET_OS_IOS || TARGET_OS_TV\n   SEL remoteNotificationWithFetchHandler = @selector(application:\n                                     didReceiveRemoteNotification:fetchCompletionHandler:);\n-  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n+  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotificationWithFetchHandler]);\n #endif\n \n   SEL remoteNotification = @selector(application:didReceiveRemoteNotification:);\n-  XCTAssertTrue([incompleteAppDelegate respondsToSelector:remoteNotification]);\n+  XCTAssertFalse([incompleteAppDelegate respondsToSelector:remoteNotification]);\n }\n \n - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n@@ -230,21 +228,6 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   NSDictionary *notification = @{@\"test\" : @\"\"};\n \n-  // Test application:didReceiveRemoteNotification:\n-\n-  // Verify our swizzled method was called\n-  OCMExpect([self.mockMessaging appDidReceiveMessage:notification]);\n-\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-  [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n-      didReceiveRemoteNotification:notification];\n-#pragma clang diagnostic pop\n-\n-  // Verify our original method was called\n-  XCTAssertTrue(appDelegate.remoteNotificationMethodWasCalled);\n-  [self.mockMessaging verify];\n-\n   // Test application:didReceiveRemoteNotification:fetchCompletionHandler:\n #if TARGET_OS_IOS || TARGET_OS_TV\n   // Verify our swizzled method was called\n@@ -252,7 +235,8 @@ - (void)testSwizzledAppDelegateRemoteNotificationMethods {\n \n   [appDelegate application:[GULAppDelegateSwizzler sharedApplication]\n       didReceiveRemoteNotification:notification\n-            fetchCompletionHandler:^(UIBackgroundFetchResult result){\n+            fetchCompletionHandler:^(UIBackgroundFetchResult result) {\n+              XCTAssertEqual(result, UIBackgroundFetchResultNewData);\n             }];\n \n   // Verify our original method was called\n", "instance_id": "firebase__firebase-ios-sdk-13064", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to remove deprecated API usages related to Firebase notifications and to update swizzling behavior in GoogleUtilities. It specifies the deprecated API, mentions the affected components (FirebaseMessaging, CocoaPods, and GoogleUtilities), and provides references to related PRs and issues. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, it lacks explicit mention of the expected behavior after removing the deprecated API (e.g., what should replace it in all cases), does not specify edge cases or potential risks of removing the API, and provides no detailed steps or examples for reproduction or testing. Additionally, the scope of \"Firebase SDK Version: All\" and \"Installation Method: N/A\" leaves uncertainty about specific version constraints or testing environments. Overall, while the goal is understandable, these gaps could lead to misinterpretation or incomplete solutions without further clarification.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files within the FirebaseMessaging module, including core functionality (FIRMessaging.m, FIRMessagingRemoteNotificationsProxy.m) and token handling (FIRMessagingAPNSInfo.m, FIRMessagingTokenInfo.m), as well as unit tests. This requires understanding interactions between different parts of the codebase, such as app delegate swizzling and notification handling. Second, the technical concepts involved include familiarity with iOS-specific APIs (UIApplicationDelegate methods), Objective-C runtime behavior (swizzling), deprecated API migration, and conditional compilation for different iOS targets. While these concepts are not extraordinarily complex for an experienced iOS developer, they do require a solid grasp of Apple's ecosystem and Firebase's architecture. Third, the changes involve removing deprecated methods and updating method signatures, which could introduce subtle compatibility issues or require careful handling of backward compatibility, though specific edge cases are not mentioned in the problem statement. Finally, the impact on the system's architecture appears moderate, as it involves updating core notification handling logic but does not seem to require a full redesign. Given these considerations, the problem is more complex than a simple bug fix or feature addition but does not reach the level of a deep architectural refactor or highly intricate logic implementation, placing it at a difficulty of 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Setting vibrancy removes window border style\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n35.1.4\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS 15.2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n34.0.0\n\n### Expected Behavior\n\nIn previous version (34.0.0), when I had vibrancy set to `\"sidebar\"` and frame to `false`, window did look like this:\n\n(it has macOS style border frame)\n\n![Image](https://github.com/user-attachments/assets/755227cf-30dc-473d-a220-bca0535477bb)\n\n### Actual Behavior\n\nNow, with exactly the same settings, the window looks like this (vibrancy set to `\"sidebar\"` and frame to `false`):\n\nmacOS style border of the window disappears\n\n![Image](https://github.com/user-attachments/assets/4071ee03-cfd1-4ad4-830a-ac66ed654ae3)\n\nEven if I enable `frame` to `true` (which I dont want to do as it enables traffic lights), it doesnt help:\n\n![Image](https://github.com/user-attachments/assets/f1abc4fd-9968-45b2-b583-0fd4a444e453)\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\n_No response_\n", "patch": "diff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex 590ac6d8bb7cd..5420e14aecd7d 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -225,6 +225,7 @@ class NativeWindowMac : public NativeWindow,\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\n+  void OnWidgetInitialized() override;\n \n   // ui::NativeThemeObserver:\n   void OnNativeThemeUpdated(ui::NativeTheme* observed_theme) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex 8bb7d5b51fa43..a895f26446213 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -1861,6 +1861,28 @@ int NonClientHitTest(const gfx::Point& point) override {\n   return std::nullopt;\n }\n \n+void NativeWindowMac::OnWidgetInitialized() {\n+  // |window_| is not yet assigned when this function is called, so we need to\n+  // get the window from the widget.\n+  NSWindow* window = widget()->GetNativeWindow().GetNativeNSWindow();\n+\n+  // In |NativeWidgetNSWindowBridge::InitCompositorView| in Chromium,\n+  // translucent windows are assigned a clear background color. This causes\n+  // undesirable side effects, such as a window with vibrancy losing its natural\n+  // system border highlight. We undo that behavior here.\n+  //\n+  // Ref:\n+  // https://source.chromium.org/chromium/chromium/src/+/main:components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm;l=1341-1342;drc=e7c8be576285195257b0813326b3bab154dc7e73\n+  if (!transparent()) {\n+    if ([[window backgroundColor] isEqual:NSColor.clearColor]) {\n+      [window setBackgroundColor:NSColor.windowBackgroundColor];\n+    }\n+    if (![window isOpaque]) {\n+      [window setOpaque:YES];\n+    }\n+  }\n+}\n+\n // static\n std::unique_ptr<NativeWindow> NativeWindow::Create(\n     const gin_helper::Dictionary& options,\n", "instance_id": "electron__electron-46648", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: setting vibrancy to \"sidebar\" with frame set to false removes the macOS-style window border in Electron version 35.1.4, which was not the case in version 34.0.0. The expected and actual behaviors are illustrated with images, which help in understanding the visual impact of the bug. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this behavior occurs under specific conditions or configurations beyond the mentioned settings. Additionally, there is no mention of potential edge cases (e.g., different macOS versions, other vibrancy settings, or window styles) or constraints that might affect the solution. The lack of a test case or reproducible code snippet also slightly reduces clarity, as it leaves some room for interpretation regarding the exact context of the issue. Overall, while the core issue is well-articulated, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code changes is relatively focused, involving modifications to a single class (`NativeWindowMac`) in two files (`native_window_mac.h` and `native_window_mac.mm`). The changes are localized to adding a new method (`OnWidgetInitialized`) and implementing logic to override background color and opacity settings for non-transparent windows. However, the changes require a moderate understanding of the Electron codebase and Chromium's native window handling on macOS, specifically how window properties like transparency and vibrancy interact with system-level rendering (e.g., `NSWindow` properties in macOS). The technical concepts involved include familiarity with Objective-C++ (used in `.mm` files), macOS-specific UI rendering behaviors, and the Electron framework's window management architecture. Additionally, the solution touches on a subtle interaction between Electron's settings and Chromium's default behavior for translucent windows, which adds a layer of complexity in diagnosing and fixing the issue. While no explicit edge cases or error handling are mentioned in the problem statement, the code change implicitly addresses a specific rendering issue, and potential edge cases (e.g., different window styles or macOS versions) might need consideration during testing or further refinement. The impact on the system's architecture is minimal, as it does not alter core functionality but rather corrects an unintended side effect. Overall, this problem requires a moderate level of expertise and understanding of platform-specific nuances, placing it in the 0.4-0.6 range, with a score of 0.55 reflecting the balance between focused changes and the need for specialized knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: EXCEPTION_ACCESS_VIOLATION crash on `BrowserWindow.destroy()`\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n \\>=v31.0.0 (tested v31.0.0, v31.2.1, v32.0.0-aplha.10)\r\n\r\n### What operating system(s) are you using?\r\n\r\nWindows\r\n\r\n### Operating System Version\r\n\r\nWindows 10 22H2\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nv30.3.0 (and everything below it)\r\n\r\n### Expected Behavior\r\n\r\n```js\r\nchildWindow.once('close', () => {\r\n    // do some cleanup etc\r\n    childWindow.destroy();;\r\n});\r\n```\r\n\r\nshouldn't crash Electron\r\n\r\n\r\n### Actual Behavior\r\n\r\n```js\r\nfunction cleanup() {\r\n\t// do some cleanup etc\r\n    childWindow.destroy();;\r\n}\r\nipcMain.once(`done`, cleanup);\r\nchildWindow.once('close', cleanup);\r\n```\r\nif `done` ipc event is not called and the window is manually closed, the window is destroyed and a few moments later The main Electron process crash with the following trace:\r\n\r\n<details><summary>Stacktrace Windows</summary>\r\n<p>\r\n\r\n```\r\nReceived fatal exception EXCEPTION_ACCESS_VIOLATION\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03CB9E08+3764424]\r\nv8::HeapStatistics::external_memory [0x00A48A12+8338]\r\ncppgc::internal::SameThreadEnabledCheckingPolicyBase::SameThreadEnabledCheckingPolicyBase [0x00B0DE72+28834]\r\nuv_req_get_data [0x022485EE+4269966]\r\nuv_req_get_data [0x02248AAA+4271178]\r\nuv_stream_get_write_queue_size [0x0277DBD5+2462421]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nsqlite3_dbdata_init [0x068DC9A7+2609367]\r\nuv_stream_get_write_queue_size [0x0277E07F+2463615]\r\nuv_stream_get_write_queue_size [0x0277D383+2460291]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nGetClassLongW [0x76977BCA+938]\r\nCallNextHookEx [0x7697C09F+415]\r\nKiUserCallbackDispatcher [0x77EC54ED+77]\r\nPostMessageW [0x769760CC+156]\r\nOrdinal132 [0x75A435C5+4885]\r\nOrdinal45 [0x75A3FAE1+2577]\r\nOrdinal45 [0x75A3F758+1672]\r\nGetSystemMetricsForDpi [0x76976D27+487]\r\nuv_stream_get_write_queue_size [0x0277D3B9+2460345]\r\nGetHandleVerifier [0x024558B5+1278869]\r\nGetHandleVerifier [0x02455387+1277543]\r\nAddClipboardFormatListener [0x76981B7B+75]\r\nGetClassLongW [0x76977FCA+1962]\r\nDispatchMessageW [0x76976901+1265]\r\nDispatchMessageW [0x76976420+16]\r\nuv_os_getpid [0x01D81F00+6592]\r\nuv_os_getpid [0x01D81B5B+5659]\r\nv8::internal::compiler::CompilationDependencies::FieldTypeDependencyOffTheRecord [0x03C980DB+3625883]\r\nuv_os_getpid [0x01D817FB+4795]\r\nGetHandleVerifier [0x0232C67C+61788]\r\nuv_os_getpid [0x01DA8F14+166356]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169DD19+2893273]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169F5FE+2899646]\r\nv8::internal::compiler::CompilationDependencies::TransitionDependencyOffTheRecord [0x0169B4AF+2882927]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DF37+3175]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EFF0+7456]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9EEB7+7143]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9D88E+1470]\r\ncppgc::Platform::GetForegroundTaskRunner [0x00B9DA11+1857]\r\nv8::SourceLocation::SourceLocation [0x00960B7D+46669]\r\nv8::SourceLocation::SourceLocation [0x00960721+45553]\r\nGetNumaHighestNodeNumber [0x77682911+161]\r\nGetNumaHighestNodeNumber [0x776828C6+86]\r\nRtlUserFiberStart [0x77EC2DC7+23]\r\n\r\nElectron exited with code 3221226525.\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\n### Testcase Gist URL\r\n\r\n> To reproduce, click the menu item then manually close the window that appears\r\n\r\nNo dependencies:\r\n\r\nhttps://gist.github.com/Araxeus/4e80b05c8bce61a5fe709eec1e969f2b\r\n\r\nOriginal issue:\r\n\r\nhttps://gist.github.com/Araxeus/6548ef4f3438d35d1713d5fd69c3b494\r\n\r\n### Additional Information\r\n\r\n* test repo: https://github.com/Aetherinox/electron-prompts\r\n* related issue: https://github.com/Araxeus/custom-electron-prompt/issues/26\n", "patch": "diff --git a/filenames.gni b/filenames.gni\nindex 99c80b915a02d..9a950d0e1955c 100644\n--- a/filenames.gni\n+++ b/filenames.gni\n@@ -159,12 +159,8 @@ filenames = {\n     \"shell/browser/osr/osr_web_contents_view_mac.mm\",\n     \"shell/browser/relauncher_mac.cc\",\n     \"shell/browser/ui/certificate_trust_mac.mm\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.h\",\n-    \"shell/browser/ui/cocoa/delayed_native_view_host.mm\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.h\",\n     \"shell/browser/ui/cocoa/electron_bundle_mover.mm\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\",\n-    \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.h\",\n     \"shell/browser/ui/cocoa/electron_menu_controller.mm\",\n     \"shell/browser/ui/cocoa/electron_native_widget_mac.h\",\n@@ -191,8 +187,6 @@ filenames = {\n     \"shell/browser/ui/cocoa/window_buttons_proxy.mm\",\n     \"shell/browser/ui/drag_util_mac.mm\",\n     \"shell/browser/ui/file_dialog_mac.mm\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.h\",\n-    \"shell/browser/ui/inspectable_web_contents_view_mac.mm\",\n     \"shell/browser/ui/message_box_mac.mm\",\n     \"shell/browser/ui/tray_icon_cocoa.h\",\n     \"shell/browser/ui/tray_icon_cocoa.mm\",\n@@ -224,8 +218,6 @@ filenames = {\n     \"shell/browser/ui/views/electron_views_delegate.h\",\n     \"shell/browser/ui/views/frameless_view.cc\",\n     \"shell/browser/ui/views/frameless_view.h\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.cc\",\n-    \"shell/browser/ui/views/inspectable_web_contents_view_views.h\",\n     \"shell/browser/ui/views/menu_bar.cc\",\n     \"shell/browser/ui/views/menu_bar.h\",\n     \"shell/browser/ui/views/menu_delegate.cc\",\ndiff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex dc05787535848..939c67537716a 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -133,6 +133,8 @@ osr_shared_texture_remove_keyed_mutex_on_win_dxgi.patch\n feat_allow_usage_of_sccontentsharingpicker_on_supported_platforms.patch\n chore_partial_revert_of.patch\n fix_software_compositing_infinite_loop.patch\n+fix_add_method_which_disables_headless_mode_on_native_widget.patch\n+fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n refactor_unfilter_unresponsive_events.patch\n build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\ndiff --git a/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\nnew file mode 100644\nindex 0000000000000..95d22359148d2\n--- /dev/null\n+++ b/patches/chromium/fix_add_method_which_disables_headless_mode_on_native_widget.patch\n@@ -0,0 +1,26 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Cezary Kulakowski <cezary@openfin.co>\n+Date: Mon, 22 Jul 2024 16:23:13 +0200\n+Subject: fix: add method which disables headless mode on native widget\n+\n+We need this method as we create window in headless mode and we\n+switch it back to normal mode only after inital paint is done in\n+order to get some events like WebContents.beginFrameSubscription.\n+If we don't set `is_headless_` to false then some child windows\n+e.g. autofill popups will be created in headless mode leading to\n+ui problems (like dissapearing popup during typing in html's\n+input list.\n+\n+diff --git a/ui/views/widget/widget.h b/ui/views/widget/widget.h\n+index 30d0ea6633cb0f7f9aab37951a38be9b0482a12a..734e91e6d50c8d3afd20b39167c6254e934e7c1e 100644\n+--- a/ui/views/widget/widget.h\n++++ b/ui/views/widget/widget.h\n+@@ -1144,6 +1144,8 @@ class VIEWS_EXPORT Widget : public internal::NativeWidgetDelegate,\n+   // True if widget was created in headless mode.\n+   bool is_headless() const { return is_headless_; }\n+ \n++  void DisableHeadlessMode() { is_headless_ = false; }\n++\n+   // True if the window size will follow the content preferred size.\n+   bool is_autosized() const { return is_autosized_; }\n+ \ndiff --git a/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\nnew file mode 100644\nindex 0000000000000..d7e0977944197\n--- /dev/null\n+++ b/patches/chromium/fix_put_nsvisualeffectview_before_viewscompositorsuperview.patch\n@@ -0,0 +1,36 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: =?UTF-8?q?Micha=C5=82=20Pichli=C5=84ski?=\n+ <michal.pichlinski@openfin.co>\n+Date: Tue, 29 Oct 2024 21:16:29 +0100\n+Subject: fix: Put NSVisualEffectView before ViewsCompositorSuperview\n+\n+Upstreamed at https://chromium-review.googlesource.com/c/chromium/src/+/6030552\n+\n+Otherwise when using `vibrancy` in `BrowserWindow` NSVisualEffectView\n+will hide content displayed by the compositor.\n+\n+diff --git a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+index 07c3997e6565cf77362ee73959c4d21da4fefe96..3353a7847df90b58eec34ea4d6ff8fb19617f5cc 100644\n+--- a/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n++++ b/components/remote_cocoa/app_shim/native_widget_ns_window_bridge.mm\n+@@ -223,8 +223,19 @@ NSComparisonResult SubviewSorter(__kindof NSView* lhs,\n+                                  void* rank_as_void) {\n+   DCHECK_NE(lhs, rhs);\n+ \n+-  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]])\n++\n++  // Put NSVisualEffectView before ViewsCompositorSuperview otherwise when using\n++  // `vibrancy` in `BrowserWindow` NSVisualEffectView will hide content\n++  // displayed by the compositor.\n++  if ([lhs isKindOfClass:[NSVisualEffectView class]]) {\n+     return NSOrderedAscending;\n++  }\n++  if ([lhs isKindOfClass:[ViewsCompositorSuperview class]]) {\n++    if ([rhs isKindOfClass:[NSVisualEffectView class]]) {\n++      return NSOrderedDescending;\n++    }\n++    return NSOrderedAscending;\n++  }\n+ \n+   const RankMap* rank = static_cast<const RankMap*>(rank_as_void);\n+   auto left_rank = rank->find(lhs);\ndiff --git a/shell/browser/api/electron_api_web_contents_view.cc b/shell/browser/api/electron_api_web_contents_view.cc\nindex 644ea373a7287..f76209fbdf5be 100644\n--- a/shell/browser/api/electron_api_web_contents_view.cc\n+++ b/shell/browser/api/electron_api_web_contents_view.cc\n@@ -27,29 +27,14 @@\n #include \"ui/views/view_class_properties.h\"\n #include \"ui/views/widget/widget.h\"\n \n-#if BUILDFLAG(IS_MAC)\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#endif\n-\n namespace electron::api {\n \n WebContentsView::WebContentsView(v8::Isolate* isolate,\n                                  gin::Handle<WebContents> web_contents)\n-#if BUILDFLAG(IS_MAC)\n-    : View(new DelayedNativeViewHost(web_contents->inspectable_web_contents()\n-                                         ->GetView()\n-                                         ->GetNativeView())),\n-#else\n-    : View(web_contents->inspectable_web_contents()->GetView()->GetView()),\n-#endif\n+    : View(web_contents->inspectable_web_contents()->GetView()),\n       web_contents_(isolate, web_contents.ToV8()),\n       api_web_contents_(web_contents.get()) {\n-#if !BUILDFLAG(IS_MAC)\n-  // On macOS the View is a newly-created |DelayedNativeViewHost| and it is our\n-  // responsibility to delete it. On other platforms the View is created and\n-  // managed by InspectableWebContents.\n   set_delete_view(false);\n-#endif\n   view()->SetProperty(\n       views::kFlexBehaviorKey,\n       views::FlexSpecification(views::MinimumFlexSizeRule::kScaleToMinimum,\ndiff --git a/shell/browser/native_window_mac.h b/shell/browser/native_window_mac.h\nindex d153dec7f87d5..c49cdc9635932 100644\n--- a/shell/browser/native_window_mac.h\n+++ b/shell/browser/native_window_mac.h\n@@ -169,9 +169,6 @@ class NativeWindowMac : public NativeWindow,\n   void NotifyWindowDidFailToEnterFullScreen();\n   void NotifyWindowWillLeaveFullScreen();\n \n-  // views::WidgetDelegate:\n-  views::View* GetContentsView() override;\n-\n   // Cleanup observers when window is getting closed. Note that the destructor\n   // can be called much later after window gets closed, so we should not do\n   // cleanup in destructor.\n@@ -223,6 +220,7 @@ class NativeWindowMac : public NativeWindow,\n \n  protected:\n   // views::WidgetDelegate:\n+  views::View* GetContentsView() override;\n   bool CanMaximize() const override;\n   std::unique_ptr<views::NonClientFrameView> CreateNonClientFrameView(\n       views::Widget* widget) override;\ndiff --git a/shell/browser/native_window_mac.mm b/shell/browser/native_window_mac.mm\nindex dc483ee3fd3aa..2acea04280688 100644\n--- a/shell/browser/native_window_mac.mm\n+++ b/shell/browser/native_window_mac.mm\n@@ -194,6 +194,8 @@ static bool FromV8(v8::Isolate* isolate,\n   params.bounds = bounds;\n   params.delegate = this;\n   params.type = views::Widget::InitParams::TYPE_WINDOW;\n+  // Allow painting before shown, to be later disabled in ElectronNSWindow.\n+  params.headless_mode = true;\n   params.native_widget =\n       new ElectronNativeWidgetMac(this, windowType, styleMask, widget());\n   widget()->Init(std::move(params));\n@@ -1674,6 +1676,7 @@ static bool FromV8(v8::Isolate* isolate,\n   DCHECK(!IsClosed());\n   ui::NativeTheme::GetInstanceForNativeUi()->RemoveObserver(this);\n   display::Screen::GetScreen()->RemoveObserver(this);\n+  [window_ cleanup];\n }\n \n class NativeAppWindowFrameViewMac : public views::NativeFrameViewMac {\ndiff --git a/shell/browser/native_window_views.cc b/shell/browser/native_window_views.cc\nindex 1f6c3957c45ec..d5118ec346a8f 100644\n--- a/shell/browser/native_window_views.cc\n+++ b/shell/browser/native_window_views.cc\n@@ -27,6 +27,7 @@\n #include \"content/public/browser/desktop_media_id.h\"\n #include \"content/public/common/color_parser.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/views/root_view.h\"\n #include \"shell/browser/web_contents_preferences.h\"\n #include \"shell/browser/web_view_manager.h\"\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.h b/shell/browser/ui/cocoa/delayed_native_view_host.h\ndeleted file mode 100644\nindex e7020dba60715..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.h\n+++ /dev/null\n@@ -1,33 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\n-\n-#include \"ui/views/controls/native/native_view_host.h\"\n-\n-namespace electron {\n-\n-// Automatically attach the native view after the NativeViewHost is attached to\n-// a widget. (Attaching it directly would cause crash.)\n-class DelayedNativeViewHost : public views::NativeViewHost {\n- public:\n-  explicit DelayedNativeViewHost(gfx::NativeView native_view);\n-  ~DelayedNativeViewHost() override;\n-\n-  // disable copy\n-  DelayedNativeViewHost(const DelayedNativeViewHost&) = delete;\n-  DelayedNativeViewHost& operator=(const DelayedNativeViewHost&) = delete;\n-\n-  // views::View:\n-  void ViewHierarchyChanged(\n-      const views::ViewHierarchyChangedDetails& details) override;\n-\n- private:\n-  gfx::NativeView native_view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_DELAYED_NATIVE_VIEW_HOST_H_\ndiff --git a/shell/browser/ui/cocoa/delayed_native_view_host.mm b/shell/browser/ui/cocoa/delayed_native_view_host.mm\ndeleted file mode 100644\nindex 38b0796555e1f..0000000000000\n--- a/shell/browser/ui/cocoa/delayed_native_view_host.mm\n+++ /dev/null\n@@ -1,23 +0,0 @@\n-// Copyright (c) 2018 GitHub, Inc.\n-// Use of this source code is governed by the MIT license that can be\n-// found in the LICENSE file.\n-\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-\n-namespace electron {\n-\n-DelayedNativeViewHost::DelayedNativeViewHost(gfx::NativeView native_view)\n-    : native_view_(native_view) {}\n-\n-DelayedNativeViewHost::~DelayedNativeViewHost() = default;\n-\n-void DelayedNativeViewHost::ViewHierarchyChanged(\n-    const views::ViewHierarchyChangedDetails& details) {\n-  if (!details.is_add && native_view())\n-    Detach();\n-  NativeViewHost::ViewHierarchyChanged(details);\n-  if (details.is_add && GetWidget() && !native_view())\n-    Attach(native_view_);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\ndeleted file mode 100644\nindex 4286312573aab..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\n+++ /dev/null\n@@ -1,54 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-#define ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\n-\n-#import <AppKit/AppKit.h>\n-\n-#include \"base/apple/owned_objc.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-\n-namespace electron {\n-class InspectableWebContentsViewMac;\n-}\n-\n-using electron::InspectableWebContentsViewMac;\n-\n-@interface NSView (WebContentsView)\n-- (void)setMouseDownCanMoveWindow:(BOOL)can_move;\n-@end\n-\n-@interface ElectronInspectableWebContentsView : BaseView <NSWindowDelegate> {\n- @private\n-  raw_ptr<electron::InspectableWebContentsViewMac> inspectableWebContentsView_;\n-\n-  NSView* __strong fake_view_;\n-  NSWindow* __strong devtools_window_;\n-  BOOL devtools_visible_;\n-  BOOL devtools_docked_;\n-  BOOL devtools_is_first_responder_;\n-  BOOL attached_to_window_;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-}\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view;\n-- (void)notifyDevToolsFocused;\n-- (void)setCornerRadii:(CGFloat)cornerRadius;\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate;\n-- (BOOL)isDevToolsVisible;\n-- (BOOL)isDevToolsFocused;\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate;\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy;\n-- (void)setTitle:(NSString*)title;\n-- (NSString*)getTitle;\n-\n-@end\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_COCOA_ELECTRON_INSPECTABLE_WEB_CONTENTS_VIEW_H_\ndiff --git a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm b/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\ndeleted file mode 100644\nindex d719fc164e476..0000000000000\n--- a/shell/browser/ui/cocoa/electron_inspectable_web_contents_view.mm\n+++ /dev/null\n@@ -1,337 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-\n-#include \"content/public/browser/render_widget_host_view.h\"\n-#include \"shell/browser/api/electron_api_web_contents.h\"\n-#include \"shell/browser/ui/cocoa/event_dispatching_window.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-#include \"ui/base/cocoa/base_view.h\"\n-#include \"ui/gfx/mac/scoped_cocoa_disable_screen_updates.h\"\n-\n-@implementation ElectronInspectableWebContentsView\n-\n-- (instancetype)initWithInspectableWebContentsViewMac:\n-    (InspectableWebContentsViewMac*)view {\n-  self = [super init];\n-  if (!self)\n-    return nil;\n-\n-  inspectableWebContentsView_ = view;\n-  devtools_visible_ = NO;\n-  devtools_docked_ = NO;\n-  devtools_is_first_responder_ = NO;\n-  attached_to_window_ = NO;\n-\n-  if (inspectableWebContentsView_->inspectable_web_contents()->is_guest()) {\n-    fake_view_ = [[NSView alloc] init];\n-    [fake_view_ setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:fake_view_];\n-  } else {\n-    auto* contents = inspectableWebContentsView_->inspectable_web_contents()\n-                         ->GetWebContents();\n-    auto* contentsView = contents->GetNativeView().GetNativeNSView();\n-    [contentsView setAutoresizingMask:NSViewWidthSizable | NSViewHeightSizable];\n-    [self addSubview:contentsView];\n-  }\n-\n-  // See https://code.google.com/p/chromium/issues/detail?id=348490.\n-  [self setWantsLayer:YES];\n-\n-  return self;\n-}\n-\n-- (void)dealloc {\n-  [[NSNotificationCenter defaultCenter] removeObserver:self];\n-}\n-\n-- (void)resizeSubviewsWithOldSize:(NSSize)oldBoundsSize {\n-  [self adjustSubviews];\n-}\n-\n-- (void)viewDidMoveToWindow {\n-  if (attached_to_window_ && !self.window) {\n-    attached_to_window_ = NO;\n-    [[NSNotificationCenter defaultCenter] removeObserver:self];\n-  } else if (!attached_to_window_ && self.window) {\n-    attached_to_window_ = YES;\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(viewDidBecomeFirstResponder:)\n-               name:kViewDidBecomeFirstResponder\n-             object:nil];\n-    [[NSNotificationCenter defaultCenter]\n-        addObserver:self\n-           selector:@selector(parentWindowBecameMain:)\n-               name:NSWindowDidBecomeMainNotification\n-             object:nil];\n-  }\n-}\n-\n-- (IBAction)showDevTools:(id)sender {\n-  inspectableWebContentsView_->inspectable_web_contents()->ShowDevTools(true);\n-}\n-\n-- (void)notifyDevToolsFocused {\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsFocused();\n-}\n-\n-- (void)setCornerRadii:(CGFloat)cornerRadius {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-  webContentsView.wantsLayer = YES;\n-  webContentsView.layer.cornerRadius = cornerRadius;\n-}\n-\n-- (void)notifyDevToolsResized {\n-  // When devtools is opened, resizing devtools would not trigger\n-  // UpdateDraggableRegions for WebContents, so we have to notify the window\n-  // to do an update of draggable regions.\n-  if (inspectableWebContentsView_->GetDelegate())\n-    inspectableWebContentsView_->GetDelegate()->DevToolsResized();\n-}\n-\n-- (void)setDevToolsVisible:(BOOL)visible activate:(BOOL)activate {\n-  if (visible == devtools_visible_)\n-    return;\n-\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto* devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  devtools_visible_ = visible;\n-  if (devtools_docked_) {\n-    if (visible) {\n-      // Place the devToolsView under contentsView, notice that we didn't set\n-      // sizes for them until the setContentsResizingStrategy message.\n-      [self addSubview:devToolsView positioned:NSWindowBelow relativeTo:nil];\n-      [self adjustSubviews];\n-\n-      // Focus on web view.\n-      devToolsWebContents->RestoreFocus();\n-    } else {\n-      gfx::ScopedCocoaDisableScreenUpdates disabler;\n-      [devToolsView removeFromSuperview];\n-      [self adjustSubviews];\n-      [self notifyDevToolsResized];\n-    }\n-  } else {\n-    if (visible) {\n-      if (activate) {\n-        [devtools_window_ makeKeyAndOrderFront:nil];\n-      } else {\n-        [devtools_window_ orderBack:nil];\n-      }\n-    } else {\n-      [devtools_window_ setDelegate:nil];\n-      [devtools_window_ close];\n-      devtools_window_ = nil;\n-    }\n-  }\n-}\n-\n-- (BOOL)isDevToolsVisible {\n-  return devtools_visible_;\n-}\n-\n-- (BOOL)isDevToolsFocused {\n-  if (devtools_docked_) {\n-    return [[self window] isKeyWindow] && devtools_is_first_responder_;\n-  } else {\n-    return [devtools_window_ isKeyWindow];\n-  }\n-}\n-\n-// TODO: remove NSWindowStyleMaskTexturedBackground.\n-// https://github.com/electron/electron/issues/43125\n-#pragma clang diagnostic push\n-#pragma clang diagnostic ignored \"-Wdeprecated-declarations\"\n-\n-- (void)setIsDocked:(BOOL)docked activate:(BOOL)activate {\n-  // Revert to no-devtools state.\n-  [self setDevToolsVisible:NO activate:NO];\n-\n-  // Switch to new state.\n-  devtools_docked_ = docked;\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-  if (!docked) {\n-    auto styleMask = NSWindowStyleMaskTitled | NSWindowStyleMaskClosable |\n-                     NSWindowStyleMaskMiniaturizable |\n-                     NSWindowStyleMaskResizable |\n-                     NSWindowStyleMaskTexturedBackground |\n-                     NSWindowStyleMaskUnifiedTitleAndToolbar;\n-    devtools_window_ = [[EventDispatchingWindow alloc]\n-        initWithContentRect:NSMakeRect(0, 0, 800, 600)\n-                  styleMask:styleMask\n-                    backing:NSBackingStoreBuffered\n-                      defer:YES];\n-    [devtools_window_ setDelegate:self];\n-    [devtools_window_ setFrameAutosaveName:@\"electron.devtools\"];\n-    [devtools_window_ setTitle:@\"Developer Tools\"];\n-    [devtools_window_ setReleasedWhenClosed:NO];\n-    [devtools_window_ setAutorecalculatesContentBorderThickness:NO\n-                                                        forEdge:NSMaxYEdge];\n-    [devtools_window_ setContentBorderThickness:24 forEdge:NSMaxYEdge];\n-\n-    NSView* contentView = [devtools_window_ contentView];\n-    devToolsView.frame = contentView.bounds;\n-    devToolsView.autoresizingMask = NSViewWidthSizable | NSViewHeightSizable;\n-\n-    [contentView addSubview:devToolsView];\n-    [devToolsView setMouseDownCanMoveWindow:NO];\n-  } else {\n-    [devToolsView setMouseDownCanMoveWindow:YES];\n-  }\n-  [self setDevToolsVisible:YES activate:activate];\n-}\n-\n-// -Wdeprecated-declarations\n-#pragma clang diagnostic pop\n-\n-- (void)setContentsResizingStrategy:\n-    (const DevToolsContentsResizingStrategy&)strategy {\n-  strategy_.CopyFrom(strategy);\n-  [self adjustSubviews];\n-}\n-\n-- (void)adjustSubviews {\n-  if (![[self subviews] count])\n-    return;\n-\n-  if (![self isDevToolsVisible] || devtools_window_) {\n-    DCHECK_EQ(1u, [[self subviews] count]);\n-    NSView* contents = [[self subviews] objectAtIndex:0];\n-    [contents setFrame:[self bounds]];\n-    return;\n-  }\n-\n-  NSView* devToolsView = [[self subviews] objectAtIndex:0];\n-  NSView* contentsView = [[self subviews] objectAtIndex:1];\n-\n-  DCHECK_EQ(2u, [[self subviews] count]);\n-\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, gfx::Size(NSSizeToCGSize([self bounds].size)),\n-      &new_devtools_bounds, &new_contents_bounds);\n-  [devToolsView setFrame:[self flipRectToNSRect:new_devtools_bounds]];\n-  [contentsView setFrame:[self flipRectToNSRect:new_contents_bounds]];\n-\n-  // Move mask to the devtools area to exclude it from dragging.\n-  NSRect cf = contentsView.frame;\n-  NSRect sb = [self bounds];\n-  NSRect devtools_frame;\n-  if (cf.size.height < sb.size.height) {  // bottom docked\n-    devtools_frame.origin.x = 0;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width;\n-    devtools_frame.size.height = sb.size.height - cf.size.height;\n-  } else {                // left or right docked\n-    if (cf.origin.x > 0)  // left docked\n-      devtools_frame.origin.x = 0;\n-    else  // right docked.\n-      devtools_frame.origin.x = cf.size.width;\n-    devtools_frame.origin.y = 0;\n-    devtools_frame.size.width = sb.size.width - cf.size.width;\n-    devtools_frame.size.height = sb.size.height;\n-  }\n-\n-  [self notifyDevToolsResized];\n-}\n-\n-- (void)setTitle:(NSString*)title {\n-  [devtools_window_ setTitle:title];\n-}\n-\n-- (NSString*)getTitle {\n-  return [devtools_window_ title];\n-}\n-\n-- (void)viewDidBecomeFirstResponder:(NSNotification*)notification {\n-  auto* inspectable_web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents();\n-  DCHECK(inspectable_web_contents);\n-  auto* webContents = inspectable_web_contents->GetWebContents();\n-  if (!webContents)\n-    return;\n-  auto* webContentsView = webContents->GetNativeView().GetNativeNSView();\n-\n-  NSView* view = [notification object];\n-  if ([[webContentsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = NO;\n-    return;\n-  }\n-\n-  auto* devToolsWebContents =\n-      inspectable_web_contents->GetDevToolsWebContents();\n-  if (!devToolsWebContents)\n-    return;\n-  auto devToolsView = devToolsWebContents->GetNativeView().GetNativeNSView();\n-\n-  if ([[devToolsView subviews] containsObject:view]) {\n-    devtools_is_first_responder_ = YES;\n-    [self notifyDevToolsFocused];\n-  }\n-}\n-\n-- (void)parentWindowBecameMain:(NSNotification*)notification {\n-  NSWindow* parentWindow = [notification object];\n-  if ([self window] == parentWindow && devtools_docked_ &&\n-      devtools_is_first_responder_)\n-    [self notifyDevToolsFocused];\n-}\n-\n-#pragma mark - NSWindowDelegate\n-\n-- (void)windowWillClose:(NSNotification*)notification {\n-  inspectableWebContentsView_->inspectable_web_contents()->CloseDevTools();\n-}\n-\n-- (void)windowDidBecomeMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->RestoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(true);\n-\n-  [self notifyDevToolsFocused];\n-}\n-\n-- (void)windowDidResignMain:(NSNotification*)notification {\n-  content::WebContents* web_contents =\n-      inspectableWebContentsView_->inspectable_web_contents()\n-          ->GetDevToolsWebContents();\n-  if (!web_contents)\n-    return;\n-\n-  web_contents->StoreFocus();\n-\n-  content::RenderWidgetHostView* rwhv = web_contents->GetRenderWidgetHostView();\n-  if (rwhv)\n-    rwhv->SetActive(false);\n-}\n-\n-@end\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.h b/shell/browser/ui/cocoa/electron_ns_window.h\nindex 502592313c15d..63ea5355467d4 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.h\n+++ b/shell/browser/ui/cocoa/electron_ns_window.h\n@@ -29,6 +29,8 @@ class ScopedDisableResize {\n \n }  // namespace electron\n \n+class ElectronNativeWindowObserver;\n+\n @interface ElectronNSWindow : NativeWidgetMacNSWindow {\n  @private\n   raw_ptr<electron::NativeWindowMac> shell_;\n@@ -41,6 +43,7 @@ class ScopedDisableResize {\n @property(nonatomic, retain) NSImage* cornerMask;\n - (id)initWithShell:(electron::NativeWindowMac*)shell\n           styleMask:(NSUInteger)styleMask;\n+- (void)cleanup;\n - (electron::NativeWindowMac*)shell;\n - (id)accessibilityFocusedUIElement;\n - (NSRect)originalContentRectForFrameRect:(NSRect)frameRect;\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window.mm b/shell/browser/ui/cocoa/electron_ns_window.mm\nindex 5c5f1512f4a3e..30780277d3a5c 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window.mm\n@@ -8,8 +8,6 @@\n #include \"electron/mas.h\"\n #include \"shell/browser/api/electron_api_web_contents.h\"\n #include \"shell/browser/native_window_mac.h\"\n-#include \"shell/browser/ui/cocoa/delayed_native_view_host.h\"\n-#include \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n #include \"shell/browser/ui/cocoa/electron_preview_item.h\"\n #include \"shell/browser/ui/cocoa/electron_touch_bar.h\"\n #include \"shell/browser/ui/cocoa/root_view_mac.h\"\n@@ -113,6 +111,7 @@ void SwizzleSwipeWithEvent(NSView* view, SEL swiz_selector) {\n                            method_getImplementation(new_swipe_with_event));\n }\n #endif\n+\n }  // namespace\n \n @implementation ElectronNSWindow\n@@ -168,6 +167,10 @@ - (id)initWithShell:(electron::NativeWindowMac*)shell\n   return self;\n }\n \n+- (void)cleanup {\n+  shell_ = nullptr;\n+}\n+\n - (electron::NativeWindowMac*)shell {\n   return shell_;\n }\n@@ -255,6 +258,17 @@ - (void)setFrame:(NSRect)windowFrame display:(BOOL)displayViews {\n     [super setFrame:windowFrame display:displayViews];\n }\n \n+- (void)orderWindow:(NSWindowOrderingMode)place relativeTo:(NSInteger)otherWin {\n+  if (shell_) {\n+    // We initialize the window in headless mode to allow painting before it is\n+    // shown, but we don't want the headless behavior of allowing the window to\n+    // be placed unconstrained.\n+    self.isHeadless = false;\n+    shell_->widget()->DisableHeadlessMode();\n+  }\n+  [super orderWindow:place relativeTo:otherWin];\n+}\n+\n - (id)accessibilityAttributeValue:(NSString*)attribute {\n   if ([attribute isEqual:NSAccessibilityEnabledAttribute])\n     return [NSNumber numberWithBool:YES];\ndiff --git a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\nindex d6af0ac6d9bb8..3f7c689bfc8b0 100644\n--- a/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n+++ b/shell/browser/ui/cocoa/electron_ns_window_delegate.mm\n@@ -365,6 +365,19 @@ - (void)windowWillClose:(NSNotification*)notification {\n       shell_->GetNativeWindow());\n   auto* bridged_view = bridge_host->GetInProcessNSWindowBridge();\n   bridged_view->OnWindowWillClose();\n+\n+  // Native widget and its compositor have been destroyed upon close. We need\n+  // to detach contents view in order to prevent reusing its layer without\n+  // compositor in the `WebContentsViewMac::CreateViewForWidget`, leading to\n+  // `DCHECK` failure in `BrowserCompositorMac::SetParentUiLayer`.\n+  auto* contents_view =\n+      static_cast<views::WidgetDelegate*>(shell_)->GetContentsView();\n+  if (contents_view) {\n+    auto* parent = contents_view->parent();\n+    if (parent) {\n+      parent->RemoveChildView(contents_view);\n+    }\n+  }\n }\n \n - (BOOL)windowShouldClose:(id)window {\ndiff --git a/shell/browser/ui/inspectable_web_contents.cc b/shell/browser/ui/inspectable_web_contents.cc\nindex ea02168ef5596..75ebdd6441429 100644\n--- a/shell/browser/ui/inspectable_web_contents.cc\n+++ b/shell/browser/ui/inspectable_web_contents.cc\n@@ -297,11 +297,6 @@ class InspectableWebContents::NetworkResourceLoader\n   base::TimeDelta retry_delay_;\n };\n \n-// Implemented separately on each platform.\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents);\n-\n-// static\n // static\n void InspectableWebContents::RegisterPrefs(PrefRegistrySimple* registry) {\n   registry->RegisterDictionaryPref(kDevToolsBoundsPref,\n@@ -317,7 +312,7 @@ InspectableWebContents::InspectableWebContents(\n     : pref_service_(pref_service),\n       web_contents_(std::move(web_contents)),\n       is_guest_(is_guest),\n-      view_(CreateInspectableContentsView(this)) {\n+      view_(new InspectableWebContentsView(this)) {\n   const base::Value* bounds_dict =\n       &pref_service_->GetValue(kDevToolsBoundsPref);\n   if (bounds_dict->is_dict()) {\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.cc b/shell/browser/ui/inspectable_web_contents_view.cc\nindex 946b5071bcc87..e61f008414df4 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.cc\n+++ b/shell/browser/ui/inspectable_web_contents_view.cc\n@@ -5,12 +5,250 @@\n \n #include \"shell/browser/ui/inspectable_web_contents_view.h\"\n \n+#include <memory>\n+#include <utility>\n+\n+#include \"base/memory/raw_ptr.h\"\n+#include \"base/strings/utf_string_conversions.h\"\n+#include \"shell/browser/ui/drag_util.h\"\n+#include \"shell/browser/ui/inspectable_web_contents.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n+#include \"ui/base/models/image_model.h\"\n+#include \"ui/views/controls/label.h\"\n+#include \"ui/views/controls/webview/webview.h\"\n+#include \"ui/views/widget/widget.h\"\n+#include \"ui/views/widget/widget_delegate.h\"\n+#include \"ui/views/window/client_view.h\"\n+\n namespace electron {\n \n+namespace {\n+\n+class DevToolsWindowDelegate : public views::ClientView,\n+                               public views::WidgetDelegate {\n+ public:\n+  DevToolsWindowDelegate(InspectableWebContentsView* shell,\n+                         views::View* view,\n+                         views::Widget* widget)\n+      : views::ClientView(widget, view),\n+        shell_(shell),\n+        view_(view),\n+        widget_(widget) {\n+    SetOwnedByWidget(true);\n+    set_owned_by_client();\n+\n+    if (shell->GetDelegate())\n+      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n+  }\n+  ~DevToolsWindowDelegate() override = default;\n+\n+  // disable copy\n+  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n+  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n+\n+  // views::WidgetDelegate:\n+  views::View* GetInitiallyFocusedView() override { return view_; }\n+  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n+  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n+  ui::ImageModel GetWindowIcon() override { return icon_; }\n+  views::Widget* GetWidget() override { return widget_; }\n+  const views::Widget* GetWidget() const override { return widget_; }\n+  views::View* GetContentsView() override { return view_; }\n+  views::ClientView* CreateClientView(views::Widget* widget) override {\n+    return this;\n+  }\n+\n+  // views::ClientView:\n+  views::CloseRequestResult OnWindowCloseRequested() override {\n+    shell_->inspectable_web_contents()->CloseDevTools();\n+    return views::CloseRequestResult::kCannotClose;\n+  }\n+\n+ private:\n+  raw_ptr<InspectableWebContentsView> shell_;\n+  raw_ptr<views::View> view_;\n+  raw_ptr<views::Widget> widget_;\n+  ui::ImageModel icon_;\n+};\n+\n+}  // namespace\n+\n InspectableWebContentsView::InspectableWebContentsView(\n     InspectableWebContents* inspectable_web_contents)\n-    : inspectable_web_contents_(inspectable_web_contents) {}\n+    : inspectable_web_contents_(inspectable_web_contents),\n+      devtools_web_view_(new views::WebView(nullptr)),\n+      title_(u\"Developer Tools\") {\n+  if (!inspectable_web_contents_->is_guest() &&\n+      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n+    auto* contents_web_view = new views::WebView(nullptr);\n+    contents_web_view->SetWebContents(\n+        inspectable_web_contents_->GetWebContents());\n+    contents_web_view_ = contents_web_view;\n+  } else {\n+    no_contents_view_ = new views::Label(u\"No content under offscreen mode\");\n+  }\n+\n+  devtools_web_view_->SetVisible(false);\n+  AddChildView(devtools_web_view_.get());\n+  AddChildView(GetContentsView());\n+}\n+\n+InspectableWebContentsView::~InspectableWebContentsView() {\n+  if (devtools_window_)\n+    inspectable_web_contents()->SaveDevToolsBounds(\n+        devtools_window_->GetWindowBoundsInScreen());\n+}\n+\n+void InspectableWebContentsView::SetCornerRadii(\n+    const gfx::RoundedCornersF& corner_radii) {\n+  // WebView won't exist for offscreen rendering.\n+  if (contents_web_view_) {\n+    contents_web_view_->holder()->SetCornerRadii(corner_radii);\n+  }\n+}\n+\n+void InspectableWebContentsView::ShowDevTools(bool activate) {\n+  if (devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = true;\n+  if (devtools_window_) {\n+    devtools_window_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n+    if (activate) {\n+      devtools_window_->Show();\n+    } else {\n+      devtools_window_->ShowInactive();\n+    }\n+\n+    // Update draggable regions to account for the new dock position.\n+    if (GetDelegate())\n+      GetDelegate()->DevToolsResized();\n+  } else {\n+    devtools_web_view_->SetVisible(true);\n+    devtools_web_view_->SetWebContents(\n+        inspectable_web_contents_->GetDevToolsWebContents());\n+    devtools_web_view_->RequestFocus();\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+void InspectableWebContentsView::CloseDevTools() {\n+  if (!devtools_visible_)\n+    return;\n+\n+  devtools_visible_ = false;\n+  if (devtools_window_) {\n+    auto save_bounds = devtools_window_->IsMinimized()\n+                           ? devtools_window_->GetRestoredBounds()\n+                           : devtools_window_->GetWindowBoundsInScreen();\n+    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n+\n+    devtools_window_.reset();\n+    devtools_window_web_view_ = nullptr;\n+    devtools_window_delegate_ = nullptr;\n+  } else {\n+    devtools_web_view_->SetVisible(false);\n+    devtools_web_view_->SetWebContents(nullptr);\n+    DeprecatedLayoutImmediately();\n+  }\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewShowing() {\n+  return devtools_visible_;\n+}\n+\n+bool InspectableWebContentsView::IsDevToolsViewFocused() {\n+  if (devtools_window_web_view_)\n+    return devtools_window_web_view_->HasFocus();\n+  else if (devtools_web_view_)\n+    return devtools_web_view_->HasFocus();\n+  else\n+    return false;\n+}\n+\n+void InspectableWebContentsView::SetIsDocked(bool docked, bool activate) {\n+  CloseDevTools();\n+\n+  if (!docked) {\n+    devtools_window_ = std::make_unique<views::Widget>();\n+    devtools_window_web_view_ = new views::WebView(nullptr);\n+    devtools_window_delegate_ = new DevToolsWindowDelegate(\n+        this, devtools_window_web_view_, devtools_window_.get());\n+\n+    views::Widget::InitParams params(\n+        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET,\n+        views::Widget::InitParams::TYPE_WINDOW);\n+    params.delegate = devtools_window_delegate_;\n+    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n+\n+#if BUILDFLAG(IS_LINUX)\n+    params.wm_role_name = \"devtools\";\n+    if (GetDelegate())\n+      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n+                                              &params.wm_class_class);\n+#endif\n+\n+    devtools_window_->Init(std::move(params));\n+    devtools_window_->UpdateWindowIcon();\n+    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n+  }\n+\n+  ShowDevTools(activate);\n+}\n+\n+void InspectableWebContentsView::SetContentsResizingStrategy(\n+    const DevToolsContentsResizingStrategy& strategy) {\n+  strategy_.CopyFrom(strategy);\n+  DeprecatedLayoutImmediately();\n+}\n+\n+void InspectableWebContentsView::SetTitle(const std::u16string& title) {\n+  if (devtools_window_) {\n+    title_ = title;\n+    devtools_window_->UpdateWindowTitle();\n+  }\n+}\n+\n+const std::u16string InspectableWebContentsView::GetTitle() {\n+  return title_;\n+}\n+\n+void InspectableWebContentsView::Layout(PassKey) {\n+  if (!devtools_web_view_->GetVisible()) {\n+    GetContentsView()->SetBoundsRect(GetContentsBounds());\n+    // Propagate layout call to all children, for example browser views.\n+    LayoutSuperclass<View>(this);\n+    return;\n+  }\n+\n+  gfx::Size container_size(width(), height());\n+  gfx::Rect new_devtools_bounds;\n+  gfx::Rect new_contents_bounds;\n+  ApplyDevToolsContentsResizingStrategy(\n+      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n+\n+  // DevTools cares about the specific position, so we have to compensate RTL\n+  // layout here.\n+  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n+  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n+\n+  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n+  GetContentsView()->SetBoundsRect(new_contents_bounds);\n+\n+  // Propagate layout call to all children, for example browser views.\n+  LayoutSuperclass<View>(this);\n+\n+  if (GetDelegate())\n+    GetDelegate()->DevToolsResized();\n+}\n+\n+views::View* InspectableWebContentsView::GetContentsView() const {\n+  DCHECK(contents_web_view_ || no_contents_view_);\n \n-InspectableWebContentsView::~InspectableWebContentsView() = default;\n+  return contents_web_view_ ? contents_web_view_ : no_contents_view_;\n+}\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view.h b/shell/browser/ui/inspectable_web_contents_view.h\nindex a9c95d477e00d..282d3bf805a97 100644\n--- a/shell/browser/ui/inspectable_web_contents_view.h\n+++ b/shell/browser/ui/inspectable_web_contents_view.h\n@@ -9,13 +9,9 @@\n #include <string>\n \n #include \"base/memory/raw_ptr.h\"\n-#include \"build/build_config.h\"\n-\n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-#include \"ui/views/view.h\"\n-#else\n+#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n #include \"ui/gfx/native_widget_types.h\"\n-#endif\n+#include \"ui/views/view.h\"\n \n class DevToolsContentsResizingStrategy;\n \n@@ -23,23 +19,22 @@ namespace gfx {\n class RoundedCornersF;\n }  // namespace gfx\n \n-#if defined(TOOLKIT_VIEWS)\n namespace views {\n-class View;\n class WebView;\n+class Widget;\n+class WidgetDelegate;\n }  // namespace views\n-#endif\n \n namespace electron {\n \n class InspectableWebContents;\n class InspectableWebContentsViewDelegate;\n \n-class InspectableWebContentsView {\n+class InspectableWebContentsView : public views::View {\n  public:\n   explicit InspectableWebContentsView(\n       InspectableWebContents* inspectable_web_contents);\n-  virtual ~InspectableWebContentsView();\n+  ~InspectableWebContentsView() override;\n \n   InspectableWebContents* inspectable_web_contents() {\n     return inspectable_web_contents_;\n@@ -51,32 +46,40 @@ class InspectableWebContentsView {\n   }\n   InspectableWebContentsViewDelegate* GetDelegate() const { return delegate_; }\n \n-#if defined(TOOLKIT_VIEWS) && !BUILDFLAG(IS_MAC)\n-  // Returns the container control, which has devtools view attached.\n-  virtual views::View* GetView() = 0;\n-#else\n-  virtual gfx::NativeView GetNativeView() const = 0;\n-#endif\n-\n-  virtual void ShowDevTools(bool activate) = 0;\n-  virtual void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) = 0;\n-  // Hide the DevTools view.\n-  virtual void CloseDevTools() = 0;\n-  virtual bool IsDevToolsViewShowing() = 0;\n-  virtual bool IsDevToolsViewFocused() = 0;\n-  virtual void SetIsDocked(bool docked, bool activate) = 0;\n-  virtual void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) = 0;\n-  virtual void SetTitle(const std::u16string& title) = 0;\n-  virtual const std::u16string GetTitle() = 0;\n-\n- protected:\n+  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii);\n+\n+  void ShowDevTools(bool activate);\n+  void CloseDevTools();\n+  bool IsDevToolsViewShowing();\n+  bool IsDevToolsViewFocused();\n+  void SetIsDocked(bool docked, bool activate);\n+  void SetContentsResizingStrategy(\n+      const DevToolsContentsResizingStrategy& strategy);\n+  void SetTitle(const std::u16string& title);\n+  const std::u16string GetTitle();\n+\n+  // views::View:\n+  void Layout(PassKey) override;\n+\n+ private:\n+  views::View* GetContentsView() const;\n+\n   // Owns us.\n   raw_ptr<InspectableWebContents> inspectable_web_contents_;\n \n- private:\n   raw_ptr<InspectableWebContentsViewDelegate> delegate_ =\n       nullptr;  // weak references.\n+\n+  std::unique_ptr<views::Widget> devtools_window_;\n+  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n+  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n+  raw_ptr<views::View> no_contents_view_ = nullptr;\n+  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n+\n+  DevToolsContentsResizingStrategy strategy_;\n+  bool devtools_visible_ = false;\n+  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n+  std::u16string title_;\n };\n \n }  // namespace electron\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.h b/shell/browser/ui/inspectable_web_contents_view_mac.h\ndeleted file mode 100644\nindex 88b4078614f42..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.h\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-#define ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-\n-@class ElectronInspectableWebContentsView;\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewMac : public InspectableWebContentsView {\n- public:\n-  explicit InspectableWebContentsViewMac(\n-      InspectableWebContents* inspectable_web_contents);\n-  InspectableWebContentsViewMac(const InspectableWebContentsViewMac&) = delete;\n-  InspectableWebContentsViewMac& operator=(\n-      const InspectableWebContentsViewMac&) = delete;\n-  ~InspectableWebContentsViewMac() override;\n-\n-  gfx::NativeView GetNativeView() const override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void ShowDevTools(bool activate) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n- private:\n-  ElectronInspectableWebContentsView* __strong view_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_INSPECTABLE_WEB_CONTENTS_VIEW_MAC_H_\ndiff --git a/shell/browser/ui/inspectable_web_contents_view_mac.mm b/shell/browser/ui/inspectable_web_contents_view_mac.mm\ndeleted file mode 100644\nindex a3789e09a8fb3..0000000000000\n--- a/shell/browser/ui/inspectable_web_contents_view_mac.mm\n+++ /dev/null\n@@ -1,75 +0,0 @@\n-// Copyright (c) 2012 The Chromium Authors. All rights reserved.\n-// Copyright (c) 2013 Adam Roben <adam@roben.org>. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/inspectable_web_contents_view_mac.h\"\n-\n-#include \"base/strings/sys_string_conversions.h\"\n-#import \"shell/browser/ui/cocoa/electron_inspectable_web_contents_view.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-\n-namespace electron {\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewMac(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewMac::InspectableWebContentsViewMac(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      view_([[ElectronInspectableWebContentsView alloc]\n-          initWithInspectableWebContentsViewMac:this]) {}\n-\n-InspectableWebContentsViewMac::~InspectableWebContentsViewMac() {\n-  [[NSNotificationCenter defaultCenter] removeObserver:view_];\n-  CloseDevTools();\n-}\n-\n-gfx::NativeView InspectableWebContentsViewMac::GetNativeView() const {\n-  return view_;\n-}\n-\n-void InspectableWebContentsViewMac::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // We can assume all four values are identical.\n-  [view_ setCornerRadii:corner_radii.upper_left()];\n-}\n-\n-void InspectableWebContentsViewMac::ShowDevTools(bool activate) {\n-  [view_ setDevToolsVisible:YES activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::CloseDevTools() {\n-  [view_ setDevToolsVisible:NO activate:NO];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewShowing() {\n-  return [view_ isDevToolsVisible];\n-}\n-\n-bool InspectableWebContentsViewMac::IsDevToolsViewFocused() {\n-  return [view_ isDevToolsFocused];\n-}\n-\n-void InspectableWebContentsViewMac::SetIsDocked(bool docked, bool activate) {\n-  [view_ setIsDocked:docked activate:activate];\n-}\n-\n-void InspectableWebContentsViewMac::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  [view_ setContentsResizingStrategy:strategy];\n-}\n-\n-void InspectableWebContentsViewMac::SetTitle(const std::u16string& title) {\n-  [view_ setTitle:base::SysUTF16ToNSString(title)];\n-}\n-\n-const std::u16string InspectableWebContentsViewMac::GetTitle() {\n-  return base::SysNSStringToUTF16([view_ getTitle]);\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/frameless_view.cc b/shell/browser/ui/views/frameless_view.cc\nindex c963d1731093a..dcfed5ef695f0 100644\n--- a/shell/browser/ui/views/frameless_view.cc\n+++ b/shell/browser/ui/views/frameless_view.cc\n@@ -5,6 +5,8 @@\n #include \"shell/browser/ui/views/frameless_view.h\"\n \n #include \"shell/browser/native_window_views.h\"\n+#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n+#include \"ui/aura/window.h\"\n #include \"ui/base/hit_test.h\"\n #include \"ui/base/metadata/metadata_impl_macros.h\"\n #include \"ui/views/widget/widget.h\"\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.cc b/shell/browser/ui/views/inspectable_web_contents_view_views.cc\ndeleted file mode 100644\nindex 61a5b013ecb12..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.cc\n+++ /dev/null\n@@ -1,257 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#include \"shell/browser/ui/views/inspectable_web_contents_view_views.h\"\n-\n-#include <memory>\n-#include <utility>\n-\n-#include \"base/memory/raw_ptr.h\"\n-#include \"shell/browser/ui/drag_util.h\"\n-#include \"shell/browser/ui/inspectable_web_contents.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_delegate.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view_delegate.h\"\n-#include \"ui/base/models/image_model.h\"\n-#include \"ui/gfx/geometry/rounded_corners_f.h\"\n-#include \"ui/views/controls/label.h\"\n-#include \"ui/views/controls/webview/webview.h\"\n-#include \"ui/views/widget/widget.h\"\n-#include \"ui/views/widget/widget_delegate.h\"\n-#include \"ui/views/window/client_view.h\"\n-\n-namespace electron {\n-\n-namespace {\n-\n-class DevToolsWindowDelegate : public views::ClientView,\n-                               public views::WidgetDelegate {\n- public:\n-  DevToolsWindowDelegate(InspectableWebContentsViewViews* shell,\n-                         views::View* view,\n-                         views::Widget* widget)\n-      : views::ClientView(widget, view),\n-        shell_(shell),\n-        view_(view),\n-        widget_(widget) {\n-    SetOwnedByWidget(true);\n-    set_owned_by_client();\n-\n-    if (shell->GetDelegate())\n-      icon_ = shell->GetDelegate()->GetDevToolsWindowIcon();\n-  }\n-  ~DevToolsWindowDelegate() override = default;\n-\n-  // disable copy\n-  DevToolsWindowDelegate(const DevToolsWindowDelegate&) = delete;\n-  DevToolsWindowDelegate& operator=(const DevToolsWindowDelegate&) = delete;\n-\n-  // views::WidgetDelegate:\n-  views::View* GetInitiallyFocusedView() override { return view_; }\n-  std::u16string GetWindowTitle() const override { return shell_->GetTitle(); }\n-  ui::ImageModel GetWindowAppIcon() override { return GetWindowIcon(); }\n-  ui::ImageModel GetWindowIcon() override { return icon_; }\n-  views::Widget* GetWidget() override { return widget_; }\n-  const views::Widget* GetWidget() const override { return widget_; }\n-  views::View* GetContentsView() override { return view_; }\n-  views::ClientView* CreateClientView(views::Widget* widget) override {\n-    return this;\n-  }\n-\n-  // views::ClientView:\n-  views::CloseRequestResult OnWindowCloseRequested() override {\n-    shell_->inspectable_web_contents()->CloseDevTools();\n-    return views::CloseRequestResult::kCannotClose;\n-  }\n-\n- private:\n-  raw_ptr<InspectableWebContentsViewViews> shell_;\n-  raw_ptr<views::View> view_;\n-  raw_ptr<views::Widget> widget_;\n-  ui::ImageModel icon_;\n-};\n-\n-}  // namespace\n-\n-InspectableWebContentsView* CreateInspectableContentsView(\n-    InspectableWebContents* inspectable_web_contents) {\n-  return new InspectableWebContentsViewViews(inspectable_web_contents);\n-}\n-\n-InspectableWebContentsViewViews::InspectableWebContentsViewViews(\n-    InspectableWebContents* inspectable_web_contents)\n-    : InspectableWebContentsView(inspectable_web_contents),\n-      devtools_web_view_(new views::WebView(nullptr)),\n-      title_(u\"Developer Tools\") {\n-  if (!inspectable_web_contents_->is_guest() &&\n-      inspectable_web_contents_->GetWebContents()->GetNativeView()) {\n-    auto* contents_web_view = new views::WebView(nullptr);\n-    contents_web_view->SetWebContents(\n-        inspectable_web_contents_->GetWebContents());\n-    contents_view_ = contents_web_view_ = contents_web_view;\n-  } else {\n-    contents_view_ = new views::Label(u\"No content under offscreen mode\");\n-  }\n-\n-  devtools_web_view_->SetVisible(false);\n-  AddChildView(devtools_web_view_.get());\n-  AddChildView(contents_view_.get());\n-}\n-\n-InspectableWebContentsViewViews::~InspectableWebContentsViewViews() {\n-  if (devtools_window_)\n-    inspectable_web_contents()->SaveDevToolsBounds(\n-        devtools_window_->GetWindowBoundsInScreen());\n-}\n-\n-views::View* InspectableWebContentsViewViews::GetView() {\n-  return this;\n-}\n-\n-void InspectableWebContentsViewViews::SetCornerRadii(\n-    const gfx::RoundedCornersF& corner_radii) {\n-  // WebView won't exist for offscreen rendering.\n-  if (contents_web_view_) {\n-    contents_web_view_->holder()->SetCornerRadii(\n-        gfx::RoundedCornersF(corner_radii));\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::ShowDevTools(bool activate) {\n-  if (devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = true;\n-  if (devtools_window_) {\n-    devtools_window_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_window_->SetBounds(inspectable_web_contents()->dev_tools_bounds());\n-    if (activate) {\n-      devtools_window_->Show();\n-    } else {\n-      devtools_window_->ShowInactive();\n-    }\n-\n-    // Update draggable regions to account for the new dock position.\n-    if (GetDelegate())\n-      GetDelegate()->DevToolsResized();\n-  } else {\n-    devtools_web_view_->SetVisible(true);\n-    devtools_web_view_->SetWebContents(\n-        inspectable_web_contents_->GetDevToolsWebContents());\n-    devtools_web_view_->RequestFocus();\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-void InspectableWebContentsViewViews::CloseDevTools() {\n-  if (!devtools_visible_)\n-    return;\n-\n-  devtools_visible_ = false;\n-  if (devtools_window_) {\n-    auto save_bounds = devtools_window_->IsMinimized()\n-                           ? devtools_window_->GetRestoredBounds()\n-                           : devtools_window_->GetWindowBoundsInScreen();\n-    inspectable_web_contents()->SaveDevToolsBounds(save_bounds);\n-\n-    devtools_window_.reset();\n-    devtools_window_web_view_ = nullptr;\n-    devtools_window_delegate_ = nullptr;\n-  } else {\n-    devtools_web_view_->SetVisible(false);\n-    devtools_web_view_->SetWebContents(nullptr);\n-    DeprecatedLayoutImmediately();\n-  }\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewShowing() {\n-  return devtools_visible_;\n-}\n-\n-bool InspectableWebContentsViewViews::IsDevToolsViewFocused() {\n-  if (devtools_window_web_view_)\n-    return devtools_window_web_view_->HasFocus();\n-  else if (devtools_web_view_)\n-    return devtools_web_view_->HasFocus();\n-  else\n-    return false;\n-}\n-\n-void InspectableWebContentsViewViews::SetIsDocked(bool docked, bool activate) {\n-  CloseDevTools();\n-\n-  if (!docked) {\n-    devtools_window_ = std::make_unique<views::Widget>();\n-    devtools_window_web_view_ = new views::WebView(nullptr);\n-    devtools_window_delegate_ = new DevToolsWindowDelegate(\n-        this, devtools_window_web_view_, devtools_window_.get());\n-\n-    views::Widget::InitParams params{\n-        views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET};\n-    params.ownership = views::Widget::InitParams::WIDGET_OWNS_NATIVE_WIDGET;\n-    params.delegate = devtools_window_delegate_;\n-    params.bounds = inspectable_web_contents()->dev_tools_bounds();\n-\n-#if BUILDFLAG(IS_LINUX)\n-    params.wm_role_name = \"devtools\";\n-    if (GetDelegate())\n-      GetDelegate()->GetDevToolsWindowWMClass(&params.wm_class_name,\n-                                              &params.wm_class_class);\n-#endif\n-\n-    devtools_window_->Init(std::move(params));\n-    devtools_window_->UpdateWindowIcon();\n-    devtools_window_->widget_delegate()->SetHasWindowSizeControls(true);\n-  }\n-\n-  ShowDevTools(activate);\n-}\n-\n-void InspectableWebContentsViewViews::SetContentsResizingStrategy(\n-    const DevToolsContentsResizingStrategy& strategy) {\n-  strategy_.CopyFrom(strategy);\n-  DeprecatedLayoutImmediately();\n-}\n-\n-void InspectableWebContentsViewViews::SetTitle(const std::u16string& title) {\n-  if (devtools_window_) {\n-    title_ = title;\n-    devtools_window_->UpdateWindowTitle();\n-  }\n-}\n-\n-const std::u16string InspectableWebContentsViewViews::GetTitle() {\n-  return title_;\n-}\n-\n-void InspectableWebContentsViewViews::Layout(PassKey) {\n-  if (!devtools_web_view_->GetVisible()) {\n-    contents_view_->SetBoundsRect(GetContentsBounds());\n-    // Propagate layout call to all children, for example browser views.\n-    LayoutSuperclass<View>(this);\n-    return;\n-  }\n-\n-  gfx::Size container_size(width(), height());\n-  gfx::Rect new_devtools_bounds;\n-  gfx::Rect new_contents_bounds;\n-  ApplyDevToolsContentsResizingStrategy(\n-      strategy_, container_size, &new_devtools_bounds, &new_contents_bounds);\n-\n-  // DevTools cares about the specific position, so we have to compensate RTL\n-  // layout here.\n-  new_devtools_bounds.set_x(GetMirroredXForRect(new_devtools_bounds));\n-  new_contents_bounds.set_x(GetMirroredXForRect(new_contents_bounds));\n-\n-  devtools_web_view_->SetBoundsRect(new_devtools_bounds);\n-  contents_view_->SetBoundsRect(new_contents_bounds);\n-\n-  // Propagate layout call to all children, for example browser views.\n-  LayoutSuperclass<View>(this);\n-\n-  if (GetDelegate())\n-    GetDelegate()->DevToolsResized();\n-}\n-\n-}  // namespace electron\ndiff --git a/shell/browser/ui/views/inspectable_web_contents_view_views.h b/shell/browser/ui/views/inspectable_web_contents_view_views.h\ndeleted file mode 100644\nindex 36554a497d6f2..0000000000000\n--- a/shell/browser/ui/views/inspectable_web_contents_view_views.h\n+++ /dev/null\n@@ -1,63 +0,0 @@\n-// Copyright (c) 2014 The Chromium Authors. All rights reserved.\n-// Use of this source code is governed by a BSD-style license that can be\n-// found in the LICENSE-CHROMIUM file.\n-\n-#ifndef ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-#define ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n-\n-#include <memory>\n-\n-#include \"base/compiler_specific.h\"\n-#include \"base/memory/raw_ptr.h\"\n-#include \"chrome/browser/devtools/devtools_contents_resizing_strategy.h\"\n-#include \"shell/browser/ui/inspectable_web_contents_view.h\"\n-#include \"third_party/skia/include/core/SkRegion.h\"\n-#include \"ui/views/view.h\"\n-\n-namespace views {\n-class WebView;\n-class Widget;\n-class WidgetDelegate;\n-}  // namespace views\n-\n-namespace electron {\n-\n-class InspectableWebContentsViewViews : public InspectableWebContentsView,\n-                                        public views::View {\n- public:\n-  explicit InspectableWebContentsViewViews(\n-      InspectableWebContents* inspectable_web_contents);\n-  ~InspectableWebContentsViewViews() override;\n-\n-  // InspectableWebContentsView:\n-  views::View* GetView() override;\n-  void ShowDevTools(bool activate) override;\n-  void SetCornerRadii(const gfx::RoundedCornersF& corner_radii) override;\n-  void CloseDevTools() override;\n-  bool IsDevToolsViewShowing() override;\n-  bool IsDevToolsViewFocused() override;\n-  void SetIsDocked(bool docked, bool activate) override;\n-  void SetContentsResizingStrategy(\n-      const DevToolsContentsResizingStrategy& strategy) override;\n-  void SetTitle(const std::u16string& title) override;\n-  const std::u16string GetTitle() override;\n-\n-  // views::View:\n-  void Layout(PassKey) override;\n-\n- private:\n-  std::unique_ptr<views::Widget> devtools_window_;\n-  raw_ptr<views::WebView> devtools_window_web_view_ = nullptr;\n-  raw_ptr<views::WebView> contents_web_view_ = nullptr;\n-  raw_ptr<views::View> contents_view_ = nullptr;\n-  raw_ptr<views::WebView> devtools_web_view_ = nullptr;\n-\n-  DevToolsContentsResizingStrategy strategy_;\n-  bool devtools_visible_ = false;\n-  raw_ptr<views::WidgetDelegate> devtools_window_delegate_ = nullptr;\n-  std::u16string title_;\n-};\n-\n-}  // namespace electron\n-\n-#endif  // ELECTRON_SHELL_BROWSER_UI_VIEWS_INSPECTABLE_WEB_CONTENTS_VIEW_VIEWS_H_\n", "instance_id": "electron__electron-45238", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: an `EXCEPTION_ACCESS_VIOLATION` crash occurs in Electron when `BrowserWindow.destroy()` is called under specific conditions (e.g., when a window is manually closed before an IPC event is triggered). The expected and actual behaviors are outlined with code snippets, and a stack trace is provided for debugging context. Additionally, links to test cases and related issues are included, which help in reproducing the problem. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly clarify the root cause of the crash (e.g., whether it's a memory access issue, a race condition, or a lifecycle management problem in Electron's window handling). The constraints or specific conditions under which the crash consistently occurs are not fully detailed beyond the provided test case. Edge cases, such as different window states or user interactions, are not mentioned. Overall, while the problem is valid and mostly clear, these minor gaps prevent it from being comprehensive.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category, due to several factors:\n\n1. **Scope and Depth of Code Changes**: The code changes span multiple files and modules within the Electron codebase, affecting core components like window management (`NativeWindowMac`, `ElectronNSWindow`), UI rendering (`InspectableWebContentsView`), and platform-specific logic (macOS and Windows via Chromium patches). The modifications include removing deprecated or problematic macOS-specific UI handling code (e.g., `DelayedNativeViewHost`, `ElectronInspectableWebContentsView`), adding new methods to manage headless mode, and ensuring proper cleanup to prevent crashes. These changes impact the system's architecture, particularly in how windows and their associated views are managed and destroyed, requiring a deep understanding of Electron's integration with Chromium's UI stack.\n\n2. **Number of Technical Concepts**: Solving this issue requires familiarity with several advanced concepts, including Electron's window lifecycle management, Chromium's `views` framework, macOS-specific Cocoa APIs (e.g., `NSWindow`, `NSVisualEffectView`), and V8 JavaScript engine integration (given the crash stack trace involves V8 internals). Additionally, understanding headless mode behavior, inter-process communication (IPC), and platform-specific rendering pipelines is necessary. The patches to Chromium indicate a need to modify upstream behavior, which adds complexity due to the need to align with Chromium's design patterns and ensure compatibility.\n\n3. **Potential Edge Cases and Error Handling**: The problem involves a crash triggered by specific user interactions (manual window closure before an IPC event), suggesting that edge cases around window destruction, event ordering, and state management are critical. The code changes address these by adding cleanup logic (e.g., detaching views to prevent reuse without a compositor) and handling headless mode transitions, but the problem statement does not fully enumerate other potential edge cases (e.g., multiple windows, rapid open/close cycles, or different OS versions). Implementing robust error handling for these scenarios adds to the difficulty.\n\n4. **Overall Complexity**: The combination of platform-specific code (macOS and Windows), integration with a large and complex codebase like Electron/Chromium, and the need to debug a low-level crash (access violation) makes this a challenging problem. It requires not only coding skills but also debugging expertise, familiarity with Electron's internals, and the ability to navigate and modify a multi-layered architecture without introducing regressions.\n\nWhile not at the extreme end of difficulty (e.g., requiring novel algorithm design or system-level innovations), this problem demands significant expertise and careful handling of complex interactions, justifying a score of 0.75.\n", "clarity_label": 1, "difficulty_label": 0, "human_clarity": -1, "human_difficulty": 0.95, "human_difficulty_explanation": "This requires an understanding of the macOS and Windows code cores, which is difficult even for human experts to handle, and should be set to the highest difficulty of 0.95"}
{"problem_statement": "[Bug]: protocol.handle fails when filename contains '#'\n### Preflight Checklist\n\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n30.0.2\n\n### What operating system are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 10 version 22H2\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nThe image should display as normal.\n\n### Actual Behavior\n\nWhen you're handling a file:// protocol request, it's being treated like a regular URL. However, the file:// protocol is different from HTTP or HTTPS URLs in how it handles characters like #. In a file:// URL, the # character is typically part of the file or directory name and is not treated as a fragment identifier like in HTTP URLs.\n\n### Testcase Gist URL\n\nhttps://gist.github.com/KBriscoe/550df36cd29a4d27a7672f1404a9e990\n\n### Additional Information\n\nIf using the gist, the filepaths need to be updated in the renderer.js to actual images. The issue is when the image contains '#' in my case and I looked through the protocol.handle and saw it was treating it like a web request I believe where # usually means to truncate off the rest of the request. So it ends up trying to get an incorrect path item.\n", "patch": "diff --git a/docs/api/protocol.md b/docs/api/protocol.md\nindex 6d2de18751de4..3f4ce799a1370 100644\n--- a/docs/api/protocol.md\n+++ b/docs/api/protocol.md\n@@ -9,10 +9,14 @@ An example of implementing a protocol that has the same effect as the\n \n ```js\n const { app, protocol, net } = require('electron')\n+const path = require('node:path')\n+const url = require('node:url')\n \n app.whenReady().then(() => {\n-  protocol.handle('atom', (request) =>\n-    net.fetch('file://' + request.url.slice('atom://'.length)))\n+  protocol.handle('atom', (request) => {\n+    const filePath = request.url.slice('atom://'.length)\n+    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+  })\n })\n ```\n \n@@ -42,7 +46,7 @@ app.whenReady().then(() => {\n \n   ses.protocol.handle('atom', (request) => {\n     const filePath = request.url.slice('atom://'.length)\n-    return net.fetch(url.pathToFileURL(path.join(__dirname, filePath)).toString())\n+    return net.fetch(url.pathToFileURL(path.resolve(__dirname, filePath)).toString())\n   })\n \n   const mainWindow = new BrowserWindow({ webPreferences: { partition } })\n", "instance_id": "electron__electron-42111", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `protocol.handle` function in Electron fails when a filename contains a '#' character due to it being treated as a fragment identifier like in HTTP URLs, rather than part of the file path in a `file://` URL. The expected behavior (image should display normally) and actual behavior (incorrect path resolution due to truncation at '#') are provided, along with a test case gist URL for reproduction. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the full range of problematic characters beyond '#', nor does it specify if this issue affects only certain file types or operating systems beyond Windows. Additionally, while the gist is referenced, it requires manual filepath updates, which adds a small layer of uncertainty for someone trying to replicate the issue. Overall, the statement is valid and clear but lacks comprehensive edge case details and explicit constraints.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`docs/api/protocol.md`) and involve modifying a small section of example code for the `protocol.handle` function. The changes do not impact the broader Electron codebase or architecture but are limited to updating documentation with a more robust way to handle file paths using `path.resolve` and `url.pathToFileURL`. The amount of code change is minimal, focusing on a specific logic adjustment.\n\n2. **Technical Concepts Involved**: Solving this requires basic familiarity with Node.js modules like `path` and `url`, as well as an understanding of how Electron's `protocol.handle` and `net.fetch` work with custom protocols and file URLs. The concept of URL parsing and file path resolution is straightforward for someone with moderate experience in JavaScript/Node.js. No advanced algorithms, design patterns, or domain-specific knowledge beyond Electron's protocol handling are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement highlights a specific edge case (filenames with '#'), and the code change addresses it by ensuring proper file path resolution. However, the solution does not introduce complex error handling logic beyond using standard path resolution functions. Additional edge cases (e.g., other special characters, invalid paths) are not mentioned or addressed in the provided changes, keeping the complexity low.\n\n4. **Overall Complexity**: The task involves understanding a specific bug in URL handling and applying a simple fix through proper path manipulation. It does not require deep knowledge of the Electron codebase or significant architectural changes. The problem is approachable for someone with basic to intermediate experience in Electron or Node.js development.\n\nThus, a difficulty score of 0.35 reflects the simplicity of the fix, the limited scope of changes, and the straightforward technical concepts involved, while acknowledging the need for some understanding of Electron's protocol handling and file URL logic.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Default export values are ignored if negative\n### Tested versions\n\n- Reproducible in 4.5.dev [215acd52e82f4c575abb715e25e54558deeef998]\n- Not reproducible in 4.4.1 and earlier\n\n### System information\n\nGodot v4.5.dev.mono (215acd52e) - Linux Mint 22.1 (Xia) on X11 - X11 display driver, Single-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (nvidia; 550.120) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 threads)\n\n### Issue description\n\nWhen setting a default value to an export property, if the value is negative, the editor does not recognize the value as the default. Setting the value to `0` will not be saved to the `.tscn` since the editor still thinks it's the default value for the type.\n\n![Image](https://github.com/user-attachments/assets/66e7fecb-c086-44b8-89a9-176bad5edd4f)\n\n![Image](https://github.com/user-attachments/assets/a64167a0-7273-4884-8b16-4d789572ad57)\n\n![Image](https://github.com/user-attachments/assets/f90f40fc-615c-4057-9b29-5713cf95ca07)\n\n### Steps to reproduce\n\nCreate a Node with a script.\nAdd an export property of type `int` and set the default value to a negative number.\nAdd the node to scene.\nSave and reopen the scene.\n\n### Minimal reproduction project (MRP)\n\n[ExportTest.zip](https://github.com/user-attachments/files/19725812/ExportTest.zip)\n", "patch": "diff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\nindex f201b7c8d8dd..4caf51dc5a01 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedFields_ScriptPropertyDefVal.generated.cs\n@@ -22,7 +22,7 @@ partial class ExportedFields\n         values.Add(PropertyName.@_fieldInt16, global::Godot.Variant.From<short>(___fieldInt16_default_value));\n         int ___fieldInt32_default_value = 10;\n         values.Add(PropertyName.@_fieldInt32, global::Godot.Variant.From<int>(___fieldInt32_default_value));\n-        long ___fieldInt64_default_value = 10;\n+        long ___fieldInt64_default_value = -10_000;\n         values.Add(PropertyName.@_fieldInt64, global::Godot.Variant.From<long>(___fieldInt64_default_value));\n         byte ___fieldByte_default_value = 10;\n         values.Add(PropertyName.@_fieldByte, global::Godot.Variant.From<byte>(___fieldByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\nindex ce154cad8e88..0bf0b0845a45 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/GeneratedSources/ExportedProperties_ScriptPropertyDefVal.generated.cs\n@@ -36,7 +36,7 @@ partial class ExportedProperties\n         values.Add(PropertyName.@PropertyInt16, global::Godot.Variant.From<short>(__PropertyInt16_default_value));\n         int __PropertyInt32_default_value = 10;\n         values.Add(PropertyName.@PropertyInt32, global::Godot.Variant.From<int>(__PropertyInt32_default_value));\n-        long __PropertyInt64_default_value = 10;\n+        long __PropertyInt64_default_value = -10_000;\n         values.Add(PropertyName.@PropertyInt64, global::Godot.Variant.From<long>(__PropertyInt64_default_value));\n         byte __PropertyByte_default_value = 10;\n         values.Add(PropertyName.@PropertyByte, global::Godot.Variant.From<byte>(__PropertyByte_default_value));\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\nindex 0938d10afe58..07ae5cb68427 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedFields.cs\n@@ -9,7 +9,7 @@ public partial class ExportedFields : GodotObject\n     [Export] private SByte _fieldSByte = 10;\n     [Export] private Int16 _fieldInt16 = 10;\n     [Export] private Int32 _fieldInt32 = 10;\n-    [Export] private Int64 _fieldInt64 = 10;\n+    [Export] private Int64 _fieldInt64 = -10_000;\n     [Export] private Byte _fieldByte = 10;\n     [Export] private UInt16 _fieldUInt16 = 10;\n     [Export] private UInt32 _fieldUInt32 = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\nindex 9ae23066fc4b..d7fcdc6b1b58 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators.Tests/TestData/Sources/ExportedProperties.cs\n@@ -97,7 +97,7 @@ public String LamdaPropertyString\n     [Export] private SByte PropertySByte { get; set; } = 10;\n     [Export] private Int16 PropertyInt16 { get; set; } = 10;\n     [Export] private Int32 PropertyInt32 { get; set; } = 10;\n-    [Export] private Int64 PropertyInt64 { get; set; } = 10;\n+    [Export] private Int64 PropertyInt64 { get; set; } = -10_000;\n     [Export] private Byte PropertyByte { get; set; } = 10;\n     [Export] private UInt16 PropertyUInt16 { get; set; } = 10;\n     [Export] private UInt32 PropertyUInt32 { get; set; } = 10;\ndiff --git a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\nindex fff32a108004..6c3824711f8c 100644\n--- a/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n+++ b/modules/mono/editor/Godot.NET.Sdk/Godot.SourceGenerators/ScriptPropertyDefValGenerator.cs\n@@ -430,6 +430,13 @@ private static bool IsStaticallyResolvable(ExpressionSyntax expression, Semantic\n                 return true;\n             }\n \n+            // Handle negative literals (e.g., `-10`)\n+            if (expression is PrefixUnaryExpressionSyntax { Operand: LiteralExpressionSyntax } &&\n+                expression.Kind() == SyntaxKind.UnaryMinusExpression)\n+            {\n+                return true;\n+            }\n+\n             // Handle identifiers (e.g., variable names)\n             if (expression is IdentifierNameSyntax identifier)\n             {\n", "instance_id": "godotengine__godot-105352", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: default export values for properties in Godot are ignored if they are negative, leading to incorrect behavior in the editor when saving scenes. It provides specific version information, system details, steps to reproduce, and even a minimal reproduction project, which are helpful for understanding the context. However, there are minor ambiguities. For instance, the problem statement does not explicitly define the expected behavior (e.g., should negative values be saved as default in the `.tscn` file, or is there another intended fix?). Additionally, edge cases or constraints (e.g., specific integer ranges or other property types affected) are not mentioned, which could impact the solution's completeness. Overall, while the issue is well-documented with examples and reproduction steps, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, affecting a few files in the Godot.NET SDK module. The modifications involve updating default values in test data (e.g., changing a default value from 10 to -10,000) and adding logic in the `ScriptPropertyDefValGenerator.cs` to handle negative literals. The changes do not appear to impact the broader system architecture or require extensive refactoring, as they are confined to specific test cases and a single generator function. The amount of code change is minimal, with only a few lines added or modified per file.\n\n2. **Number of Technical Concepts**: Solving this issue requires understanding C# syntax (specifically handling unary minus expressions in syntax trees), familiarity with Godot's export property system, and some knowledge of source generators in .NET. These concepts are not overly complex for a developer with moderate experience in C# and code generation. The fix involves recognizing and supporting negative literals in the syntax parser, which is a straightforward extension of existing logic.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases beyond negative values, and the code changes do not introduce significant error handling logic. However, a developer might need to consider whether other unary operations or complex expressions should be handled similarly, though this is not evident from the provided diff. The complexity of edge cases appears low at this stage.\n\n4. **Overall Complexity**: The issue requires understanding a specific bug in the editor's handling of default values and making targeted changes to support negative numbers in the source generator. While it involves some logic modification (e.g., updating the parser to handle unary minus expressions), it does not require deep architectural changes or advanced domain-specific knowledge beyond the Godot/.NET context. The test data updates suggest this is partly a validation or test coverage issue rather than a core system problem.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires moderate understanding of the codebase and simple modifications, with minimal impact on the overall system. It is slightly above the lower end of the easy range due to the need to understand source generators and syntax tree manipulation, which might be unfamiliar to junior developers but are routine for those with a few years of experience.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Hashtag comments after \"#region\" command won't fold the multiline comment unless there is space.\n### Tested versions\n\nV4.3\n\n### System information\n\nWin11\n\n### Issue description\n\nWhen putting \"#region\" command, the hashtag comments after it won't fold unless there is a space between. Happens with both a single hashtag and double hashtag comments. But it won't happen with triple quotes -comment.\n\n### Steps to reproduce\n\nAfter command \"#region\" add \"#\" or \"##\" comment next line without any space.\n\n### Minimal reproduction project (MRP)\n\n![Image](https://github.com/user-attachments/assets/40e5627f-2a48-4c93-a8e2-b9fce6acbd5c)\n", "patch": "diff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 9722b5e2eefa..870c5bbf842d 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -1645,12 +1645,12 @@ bool CodeEdit::can_fold_line(int p_line) const {\n \t\tif (delimiter_end_line == p_line) {\n \t\t\t/* Check we are the start of the block. */\n \t\t\tif (p_line - 1 >= 0) {\n-\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1)) {\n+\t\t\t\tif ((in_string != -1 && is_in_string(p_line - 1) != -1) || (in_comment != -1 && is_in_comment(p_line - 1) != -1 && !is_line_code_region_start(p_line - 1) && !is_line_code_region_end(p_line - 1))) {\n \t\t\t\t\treturn false;\n \t\t\t\t}\n \t\t\t}\n \t\t\t/* Check it continues for at least one line. */\n-\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1));\n+\t\t\treturn ((in_string != -1 && is_in_string(p_line + 1) != -1) || (in_comment != -1 && is_in_comment(p_line + 1) != -1 && !is_line_code_region_start(p_line + 1) && !is_line_code_region_end(p_line + 1)));\n \t\t}\n \t\treturn ((in_string != -1 && is_in_string(delimiter_end_line) != -1) || (in_comment != -1 && is_in_comment(delimiter_end_line) != -1));\n \t}\n@@ -1705,6 +1705,10 @@ void CodeEdit::fold_line(int p_line) {\n \t\t\t\t\tif ((in_string != -1 && is_in_string(i) == -1) || (in_comment != -1 && is_in_comment(i) == -1)) {\n \t\t\t\t\t\tbreak;\n \t\t\t\t\t}\n+\t\t\t\t\tif (in_comment != -1 && (is_line_code_region_start(i) || is_line_code_region_end(i))) {\n+\t\t\t\t\t\t// A code region tag should split a comment block, ending it early.\n+\t\t\t\t\t\tbreak;\n+\t\t\t\t\t}\n \t\t\t\t\tend_line = i;\n \t\t\t\t}\n \t\t\t}\n", "instance_id": "godotengine__godot-105007", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"#region\" command in a code editor does not fold hashtag comments (single or double) unless there is a space between the command and the comment. It also specifies that this issue does not occur with triple-quote comments and provides steps to reproduce the issue along with a minimal reproduction example (via an image). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should folding work without a space, or is a space required by design?). Additionally, it lacks clarity on whether this is a bug or a feature request, and there are no explicit mentions of edge cases or constraints (e.g., specific languages or comment styles beyond hashtags). While the intent is understandable, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided diff shows modifications to a single file (`code_edit.cpp`) in a specific class or module related to code folding logic. The changes are localized to two functions (`can_fold_line` and `fold_line`), involving a small number of lines (adding conditions to handle code region tags within comments). There is no indication of widespread impact on the system's architecture or interactions with other modules, making the scope relatively narrow.\n\n2. **Technical Concepts Involved**: Solving this requires understanding basic C++ syntax and control flow, as well as familiarity with the specific codebase's logic for handling code folding, comments, and region delimiters. The concepts involved—checking for comment states and region tags—are not inherently complex and do not require advanced language features, libraries, or algorithms. It appears to be a straightforward bug fix rather than a feature implementation or architectural change.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes suggest consideration of scenarios where a code region tag appears within a comment block (e.g., splitting a comment block early if a region tag is encountered). The modifications add logic to handle such cases, but they do not appear particularly complex or numerous. Error handling requirements seem minimal, as the changes focus on adjusting existing conditional checks rather than introducing new error paths.\n\n4. **Overall Complexity**: The task involves understanding a specific part of the code editor's folding mechanism and making targeted modifications. While it requires some familiarity with the codebase's internal logic (e.g., functions like `is_line_code_region_start` and `is_in_comment`), it does not demand deep architectural knowledge or extensive refactoring. The problem is more about tweaking existing behavior than designing new functionality.\n\nGiven these points, a score of 0.35 reflects an \"Easy\" task that requires moderate understanding of the code logic and simple modifications to address the issue. It is slightly above the lower end of the easy range due to the need to understand the specific folding logic and ensure the fix does not introduce unintended side effects in comment handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[GUI] Setting a control's recursive mode to disabled does not work on start\n### Tested versions\n\nlatest main branch [2303ce843a362cf5497ca3336451de23793eb711]\n\n### System information\n\nGodot v4.5.dev (2303ce843) - Windows 10 (build 19044) - Multi-window, 4 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4060 Ti (NVIDIA; 32.0.15.7260) - AMD Ryzen 9 5900X 12-Core Processor (24 threads)\n\n### Issue description\n\n#97495 introduces properties for managing children's controls' focus mode and mouse filters. However, this won't work if you set the recursive behavior to `Disable` in the editor.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/c498932f-8874-4a14-a693-fe0e09b74443\n\n\n### Minimal reproduction project (MRP)\n\n[MrpRecursiveGuiDisable.zip](https://github.com/user-attachments/files/19391423/MrpRecursiveGuiDisable.zip)\n", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..8d34746529e7 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -1880,16 +1880,20 @@ void Control::set_mouse_recursive_behavior(RecursiveBehavior p_recursive_mouse_b\n \tif (data.mouse_recursive_behavior == p_recursive_mouse_behavior) {\n \t\treturn;\n \t}\n+\t_set_mouse_recursive_behavior_ignore_cache(p_recursive_mouse_behavior);\n+}\n+\n+void Control::_set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior) {\n \tdata.mouse_recursive_behavior = p_recursive_mouse_behavior;\n \tif (p_recursive_mouse_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n+\t\t\t_propagate_mouse_behavior_recursively(parent->data.parent_mouse_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_mouse_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n+\t\t_propagate_mouse_behavior_recursively(p_recursive_mouse_behavior, false);\n \t}\n \n \tif (get_viewport()) {\n@@ -2064,16 +2068,20 @@ void Control::set_focus_recursive_behavior(RecursiveBehavior p_recursive_focus_b\n \tif (data.focus_recursive_behavior == p_recursive_focus_behavior) {\n \t\treturn;\n \t}\n+\t_set_focus_recursive_behavior_ignore_cache(p_recursive_focus_behavior);\n+}\n+\n+void Control::_set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_focus_behavior) {\n \tdata.focus_recursive_behavior = p_recursive_focus_behavior;\n \tif (p_recursive_focus_behavior == RECURSIVE_BEHAVIOR_INHERITED) {\n \t\tControl *parent = get_parent_control();\n \t\tif (parent) {\n-\t\t\t_apply_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n+\t\t\t_propagate_focus_behavior_recursively(parent->data.parent_focus_recursive_behavior, false);\n \t\t} else {\n-\t\t\t_apply_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n+\t\t\t_propagate_focus_behavior_recursively(RECURSIVE_BEHAVIOR_ENABLED, false);\n \t\t}\n \t} else {\n-\t\t_apply_focus_behavior_recursively(p_recursive_focus_behavior, false);\n+\t\t_propagate_focus_behavior_recursively(p_recursive_focus_behavior, false);\n \t}\n }\n \n@@ -2449,7 +2457,7 @@ bool Control::_is_focus_disabled_recursively() const {\n \treturn false;\n }\n \n-void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_skip_non_inherited) {\n \tif (is_inside_tree() && (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED || (data.focus_recursive_behavior == RECURSIVE_BEHAVIOR_INHERITED && p_focus_recursive_behavior == RECURSIVE_BEHAVIOR_DISABLED)) && has_focus()) {\n \t\trelease_focus();\n \t}\n@@ -2463,7 +2471,7 @@ void Control::_apply_focus_behavior_recursively(RecursiveBehavior p_focus_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_focus_behavior_recursively(p_focus_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_focus_behavior_recursively(p_focus_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -2480,7 +2488,7 @@ bool Control::_is_parent_mouse_disabled() const {\n \treturn false;\n }\n \n-void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n+void Control::_propagate_mouse_behavior_recursively(RecursiveBehavior p_mouse_recursive_behavior, bool p_skip_non_inherited) {\n \tif (p_skip_non_inherited && data.mouse_recursive_behavior != RECURSIVE_BEHAVIOR_INHERITED) {\n \t\treturn;\n \t}\n@@ -2490,7 +2498,7 @@ void Control::_apply_mouse_behavior_recursively(RecursiveBehavior p_mouse_recurs\n \tfor (int i = 0; i < get_child_count(); i++) {\n \t\tControl *control = Object::cast_to<Control>(get_child(i));\n \t\tif (control) {\n-\t\t\tcontrol->_apply_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n+\t\t\tcontrol->_propagate_mouse_behavior_recursively(p_mouse_recursive_behavior, true);\n \t\t}\n \t}\n }\n@@ -3450,8 +3458,8 @@ void Control::_notification(int p_notification) {\n \n \t\t\t_update_layout_mode();\n \n-\t\t\tset_focus_recursive_behavior(data.focus_recursive_behavior);\n-\t\t\tset_mouse_recursive_behavior(data.mouse_recursive_behavior);\n+\t\t\t_set_focus_recursive_behavior_ignore_cache(data.focus_recursive_behavior);\n+\t\t\t_set_mouse_recursive_behavior_ignore_cache(data.mouse_recursive_behavior);\n \t\t} break;\n \n \t\tcase NOTIFICATION_UNPARENTED: {\ndiff --git a/scene/gui/control.h b/scene/gui/control.h\nindex 8188b3ba31d0..b2001fdd259f 100644\n--- a/scene/gui/control.h\n+++ b/scene/gui/control.h\n@@ -330,8 +330,10 @@ class Control : public CanvasItem {\n \tvoid _window_find_focus_neighbor(const Vector2 &p_dir, Node *p_at, const Rect2 &p_rect, const Rect2 &p_clamp, real_t p_min, real_t &r_closest_dist_squared, Control **r_closest);\n \tControl *_get_focus_neighbor(Side p_side, int p_count = 0);\n \tbool _is_focus_disabled_recursively() const;\n-\tvoid _apply_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n-\tvoid _apply_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_focus_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _propagate_mouse_behavior_recursively(RecursiveBehavior p_focus_recursive_behavior, bool p_force);\n+\tvoid _set_mouse_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n+\tvoid _set_focus_recursive_behavior_ignore_cache(RecursiveBehavior p_recursive_mouse_behavior);\n \n \t// Theming.\n \n", "instance_id": "godotengine__godot-104444", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: setting a control's recursive mode to \"Disable\" does not work as expected when initialized in the editor. It provides context about the affected feature (focus mode and mouse filters for GUI controls), references a related issue (#97495), and includes system information, tested versions, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. The exact expected behavior when recursive mode is set to \"Disable\" is not explicitly described, nor are the specific conditions under which the issue manifests (e.g., does it fail only on start, or under other scenarios as well?). Additionally, the steps to reproduce are provided as a link to an asset, which is not directly accessible in the text, making it less comprehensive for immediate understanding. Edge cases or specific failure scenarios are also not detailed in the description. Thus, while the problem is valid and mostly clear, it lacks some minor but important details for full clarity.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`control.cpp`) and its associated header (`control.h`) in the Godot engine's GUI module. The changes involve renaming functions (e.g., `_apply_*_behavior_recursively` to `_propagate_*_behavior_recursively`) and introducing new helper methods to bypass caching logic during initialization, indicating a bug fix related to initialization behavior. The amount of code change is moderate, with modifications to several related functions but no major architectural impact.\n\nSecond, the technical concepts required include an understanding of GUI control hierarchies, recursive behavior propagation, and initialization logic in a game engine context (Godot). Familiarity with C++ (used in Godot's codebase) and object-oriented design is necessary, but the concepts are not overly complex for someone with moderate experience in systems programming or game development. The changes also require understanding the interaction between parent and child controls in a tree structure, which adds a layer of complexity but is still within a manageable scope.\n\nThird, the problem does not explicitly mention edge cases or error handling requirements in the statement, but the code changes suggest a focus on ensuring proper behavior during initialization (e.g., ignoring cached values). There are no significant additions to error handling logic in the diff, which keeps the complexity moderate. However, potential edge cases like nested control hierarchies or dynamic changes to recursive behavior might need consideration, though they are not evident in the provided changes.\n\nOverall, this problem requires understanding multiple related concepts (GUI control behavior, initialization, and recursive propagation) and making targeted but non-trivial modifications. It does not demand deep architectural changes or advanced domain-specific knowledge beyond typical game engine development, placing it in the medium difficulty range at 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "ScrollContainer focus StyleBox is not clipped by parent\n### Tested versions\n\nv4.4.dev6.official [1f47e4c4e]\n\n### System information\n\nFedora Linux 40 (KDE Plasma) on Wayland - X11 display driver, Multi-window\n\n### Issue description\n\n![Image](https://github.com/user-attachments/assets/14590874-4426-4de5-919b-caab8b9a6239)\n\nPR https://github.com/godotengine/godot/pull/97521 added a focus style for ScrollContainer this has the same problem as following issues:\n\nTree:\nhttps://github.com/godotengine/godot/issues/100063\nhttps://github.com/godotengine/godot/issues/88749\nhttps://github.com/godotengine/godot/issues/74670\n\n\n\nItemList:\nhttps://github.com/godotengine/godot/issues/77919\n\n\n### Steps to reproduce\n\nA ScrollContainer inside another ScrollContainer\nAdd some content to both\nEnable draw_focus_border for second ScrollContainer\nSelect something in the second ScrollContainer so it gets focus\nScroll the first ScrollContainer\n\n### Minimal reproduction project (MRP)\n\n[scrollfocus.zip](https://github.com/user-attachments/files/18052689/scrollfocus.zip)\n\n", "patch": "diff --git a/editor/editor_inspector.cpp b/editor/editor_inspector.cpp\nindex 0fbb74939ccd..54a25c62438f 100644\n--- a/editor/editor_inspector.cpp\n+++ b/editor/editor_inspector.cpp\n@@ -4956,12 +4956,6 @@ void EditorInspector::_clear_current_favorites() {\n \tupdate_tree();\n }\n \n-void EditorInspector::_update_theme() {\n-\tupdating_theme = true;\n-\tadd_theme_style_override(SceneStringName(panel), get_theme_stylebox(SceneStringName(panel), SNAME(\"Tree\")));\n-\tupdating_theme = false;\n-}\n-\n void EditorInspector::_notification(int p_what) {\n \tswitch (p_what) {\n \t\tcase NOTIFICATION_TRANSLATION_CHANGED: {\n@@ -4989,17 +4983,11 @@ void EditorInspector::_notification(int p_what) {\n \t\t\tERR_FAIL_NULL(EditorFeatureProfileManager::get_singleton());\n \t\t\tEditorFeatureProfileManager::get_singleton()->connect(\"current_feature_profile_changed\", callable_mp(this, &EditorInspector::_feature_profile_changed));\n \t\t\tset_process(is_visible_in_tree());\n-\t\t\tget_parent()->connect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t\t_update_theme();\n \t\t\tif (!is_sub_inspector()) {\n \t\t\t\tget_tree()->connect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n \t\t\t}\n \t\t} break;\n \n-\t\tcase NOTIFICATION_EXIT_TREE: {\n-\t\t\tget_parent()->disconnect(SceneStringName(theme_changed), callable_mp(this, &EditorInspector::_update_theme));\n-\t\t} break;\n-\n \t\tcase NOTIFICATION_PREDELETE: {\n \t\t\tif (!is_sub_inspector() && is_inside_tree()) {\n \t\t\t\tget_tree()->disconnect(\"node_removed\", callable_mp(this, &EditorInspector::_node_removed));\n@@ -5059,10 +5047,6 @@ void EditorInspector::_notification(int p_what) {\n \t\t} break;\n \n \t\tcase EditorSettings::NOTIFICATION_EDITOR_SETTINGS_CHANGED: {\n-\t\t\tif (!is_sub_inspector() && EditorThemeManager::is_generated_theme_outdated()) {\n-\t\t\t\t_update_theme();\n-\t\t\t}\n-\n \t\t\tif (use_settings_name_style && EditorSettings::get_singleton()->check_changed_settings_in_group(\"interface/editor/localize_settings\")) {\n \t\t\t\tEditorPropertyNameProcessor::Style style = EditorPropertyNameProcessor::get_settings_style();\n \t\t\t\tif (property_name_style != style) {\ndiff --git a/editor/editor_inspector.h b/editor/editor_inspector.h\nindex 14e2d816f12c..6049d6dce1c5 100644\n--- a/editor/editor_inspector.h\n+++ b/editor/editor_inspector.h\n@@ -638,8 +638,6 @@ class EditorInspector : public ScrollContainer {\n \tvoid _set_property_favorited(const String &p_path, bool p_favorited);\n \tvoid _clear_current_favorites();\n \n-\tvoid _update_theme();\n-\n \tvoid _node_removed(Node *p_node);\n \n \tHashMap<StringName, int> per_array_page;\ndiff --git a/editor/themes/editor_theme_manager.cpp b/editor/themes/editor_theme_manager.cpp\nindex 986a0469e740..d2e8d300d8e1 100644\n--- a/editor/themes/editor_theme_manager.cpp\n+++ b/editor/themes/editor_theme_manager.cpp\n@@ -1888,8 +1888,6 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \t\tp_theme->set_stylebox(\"FocusViewport\", EditorStringName(EditorStyles), style_widget_focus_viewport);\n \n \t\tRef<StyleBoxFlat> style_widget_scroll_container = p_config.button_style_focus->duplicate();\n-\t\t// Make the focus outline appear to be flush with the buttons it's focusing, so not draw on top of the content.\n-\t\tstyle_widget_scroll_container->set_expand_margin_all(4);\n \t\tp_theme->set_stylebox(\"focus\", \"ScrollContainer\", style_widget_scroll_container);\n \n \t\t// This stylebox is used in 3d and 2d viewports (no borders).\n@@ -2236,6 +2234,12 @@ void EditorThemeManager::_populate_editor_styles(const Ref<EditorTheme> &p_theme\n \n \t// Editor inspector.\n \t{\n+\t\t// Panel.\n+\t\tRef<StyleBoxFlat> editor_inspector_panel = p_config.tree_panel_style->duplicate();\n+\t\teditor_inspector_panel->set_border_width_all(0);\n+\t\teditor_inspector_panel->set_content_margin_all(0);\n+\t\tp_theme->set_stylebox(SceneStringName(panel), \"EditorInspector\", editor_inspector_panel);\n+\n \t\t// Vertical separation between inspector categories and sections.\n \t\tp_theme->set_constant(\"v_separation\", \"EditorInspector\", 0);\n \ndiff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex 00a2e8e01fd8..02652547a83f 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -31,6 +31,7 @@\n #include \"scroll_container.h\"\n \n #include \"core/config/project_settings.h\"\n+#include \"scene/gui/panel_container.h\"\n #include \"scene/main/window.h\"\n #include \"scene/theme/theme_db.h\"\n \n@@ -44,7 +45,7 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -72,7 +73,16 @@ Size2 ScrollContainer::get_minimum_size() const {\n \t\t}\n \t}\n \n-\tmin_size += theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tmin_size += panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the minimum size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tmin_size += focus_size - panel_size;\n+\t\t}\n+\t}\n+\n \treturn min_size;\n }\n \n@@ -258,21 +268,45 @@ void ScrollContainer::_update_scrollbar_position() {\n \t\treturn;\n \t}\n \n+\tfloat right_margin = theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tfloat left_margin = theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\tfloat top_margin = theme_cache.panel_style->get_margin(SIDE_TOP);\n+\tfloat bottom_margin = theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n+\tif (draw_focus_border) {\n+\t\t// Only update margins if the focus style's margins don't fit into the panel style's margins.\n+\t\tfloat focus_margin = theme_cache.focus_style->get_margin(SIDE_RIGHT);\n+\t\tif (focus_margin > right_margin) {\n+\t\t\tright_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_LEFT);\n+\t\tif (focus_margin > left_margin) {\n+\t\t\tleft_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_TOP);\n+\t\tif (focus_margin > top_margin) {\n+\t\t\ttop_margin += focus_margin;\n+\t\t}\n+\t\tfocus_margin = theme_cache.focus_style->get_margin(SIDE_BOTTOM);\n+\t\tif (focus_margin > bottom_margin) {\n+\t\t\tbottom_margin += focus_margin;\n+\t\t}\n+\t}\n+\n \tSize2 hmin = h_scroll->is_visible() ? h_scroll->get_combined_minimum_size() : Size2();\n \tSize2 vmin = v_scroll->is_visible() ? v_scroll->get_combined_minimum_size() : Size2();\n \n-\tint lmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_RIGHT) : theme_cache.panel_style->get_margin(SIDE_LEFT);\n-\tint rmar = is_layout_rtl() ? theme_cache.panel_style->get_margin(SIDE_LEFT) : theme_cache.panel_style->get_margin(SIDE_RIGHT);\n+\tint lmar = is_layout_rtl() ? right_margin : left_margin;\n+\tint rmar = is_layout_rtl() ? left_margin : right_margin;\n \n \th_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_BEGIN, lmar);\n \th_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar - vmin.width);\n-\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n-\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\th_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_END, -hmin.height - bottom_margin);\n+\th_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -bottom_margin);\n \n \tv_scroll->set_anchor_and_offset(SIDE_LEFT, ANCHOR_END, -vmin.width - rmar);\n \tv_scroll->set_anchor_and_offset(SIDE_RIGHT, ANCHOR_END, -rmar);\n-\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, theme_cache.panel_style->get_margin(SIDE_TOP));\n-\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - theme_cache.panel_style->get_margin(SIDE_BOTTOM));\n+\tv_scroll->set_anchor_and_offset(SIDE_TOP, ANCHOR_BEGIN, top_margin);\n+\tv_scroll->set_anchor_and_offset(SIDE_BOTTOM, ANCHOR_END, -hmin.height - bottom_margin);\n \n \t_updating_scrollbars = false;\n }\n@@ -313,8 +347,22 @@ void ScrollContainer::_reposition_children() {\n \tSize2 size = get_size();\n \tPoint2 ofs;\n \n-\tsize -= theme_cache.panel_style->get_minimum_size();\n-\tofs += theme_cache.panel_style->get_offset();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tPoint2 panel_offset = theme_cache.panel_style->get_offset();\n+\tsize -= panel_size;\n+\tofs += panel_offset;\n+\tif (draw_focus_border) {\n+\t\t// Only update the size and offset if focus style's doesn't fit into the panel style's.\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t\tPoint2 focus_offset = theme_cache.focus_style->get_offset();\n+\t\tif (focus_offset > panel_offset) {\n+\t\t\tofs += focus_offset - panel_offset;\n+\t\t}\n+\t}\n+\n \tbool rtl = is_layout_rtl();\n \n \tif (_is_h_scroll_visible() || horizontal_scroll_mode == SCROLL_MODE_RESERVE) {\n@@ -330,7 +378,7 @@ void ScrollContainer::_reposition_children() {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \t\tSize2 minsize = c->get_combined_minimum_size();\n@@ -350,6 +398,9 @@ void ScrollContainer::_reposition_children() {\n \t\tfit_child_in_rect(c, r);\n \t}\n \n+\tif (draw_focus_border) {\n+\t\tfocus_panel->set_size(get_size());\n+\t}\n \tqueue_redraw();\n }\n \n@@ -399,6 +450,7 @@ void ScrollContainer::_notification(int p_what) {\n \t\t\tif (p_what == NOTIFICATION_THEME_CHANGED) {\n \t\t\t\tscroll_border = get_theme_constant(SNAME(\"scroll_border\"), SNAME(\"Tree\"));\n \t\t\t\tscroll_speed = get_theme_constant(SNAME(\"scroll_speed\"), SNAME(\"Tree\"));\n+\t\t\t\tfocus_panel->add_theme_style_override(\"panel\", theme_cache.focus_style);\n \t\t\t}\n \t\t} break;\n \n@@ -415,15 +467,8 @@ void ScrollContainer::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n \t\t\tdraw_style_box(theme_cache.panel_style, Rect2(Vector2(), get_size()));\n-\t\t\tif (draw_focus_border && (has_focus() || child_has_focus())) {\n-\t\t\t\tRID ci = get_canvas_item();\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, true);\n-\t\t\t\tdraw_style_box(theme_cache.focus_style, Rect2(Point2(), get_size()));\n-\t\t\t\tRenderingServer::get_singleton()->canvas_item_add_clip_ignore(ci, false);\n-\t\t\t\tfocus_border_is_drawn = true;\n-\t\t\t} else {\n-\t\t\t\tfocus_border_is_drawn = false;\n-\t\t\t}\n+\t\t\tfocus_border_is_drawn = draw_focus_border && (has_focus() || child_has_focus());\n+\t\t\tfocus_panel->set_visible(focus_border_is_drawn);\n \t\t} break;\n \n \t\tcase NOTIFICATION_DRAG_BEGIN: {\n@@ -535,7 +580,15 @@ void ScrollContainer::_notification(int p_what) {\n \n void ScrollContainer::update_scrollbars() {\n \tSize2 size = get_size();\n-\tsize -= theme_cache.panel_style->get_minimum_size();\n+\tSize2 panel_size = theme_cache.panel_style->get_minimum_size();\n+\tsize -= panel_size;\n+\tif (draw_focus_border) {\n+\t\tSize2 focus_size = theme_cache.focus_style->get_minimum_size();\n+\t\t// Only update the size if the focus style's minimum size doesn't fit into the panel style's minimum size.\n+\t\tif (focus_size > panel_size) {\n+\t\t\tsize -= focus_size - panel_size;\n+\t\t}\n+\t}\n \n \tSize2 hmin = h_scroll->get_combined_minimum_size();\n \tSize2 vmin = v_scroll->get_combined_minimum_size();\n@@ -646,7 +699,7 @@ PackedStringArray ScrollContainer::get_configuration_warnings() const {\n \t\tif (!c) {\n \t\t\tcontinue;\n \t\t}\n-\t\tif (c == h_scroll || c == v_scroll) {\n+\t\tif (c == h_scroll || c == v_scroll || c == focus_panel) {\n \t\t\tcontinue;\n \t\t}\n \n@@ -736,7 +789,9 @@ void ScrollContainer::set_draw_focus_border(bool p_draw) {\n \t\treturn;\n \t}\n \tdraw_focus_border = p_draw;\n-\tqueue_redraw();\n+\tif (is_ready()) {\n+\t\t_reposition_children();\n+\t}\n }\n \n bool ScrollContainer::get_draw_focus_border() {\n@@ -759,6 +814,17 @@ ScrollContainer::ScrollContainer() {\n \tadd_child(v_scroll, false, INTERNAL_MODE_BACK);\n \tv_scroll->connect(SceneStringName(value_changed), callable_mp(this, &ScrollContainer::_scroll_moved));\n \n+\t// We need to use a PanelContainer for the focus style instead of just drawing it directly with RenderingService\n+\t// due to a clippling issues. The Control that is being scrolled will be over the focus border because both will be\n+\t// drawn on the same CanvasItem. If we decide to ignore clipping, the focus border will be drawn even over other\n+\t// CanvasItems.\n+\tfocus_panel = memnew(PanelContainer);\n+\tfocus_panel->set_name(\"_focus\");\n+\tfocus_panel->set_mouse_filter(MOUSE_FILTER_IGNORE);\n+\tfocus_panel->set_focus_mode(FOCUS_NONE);\n+\tfocus_panel->set_visible(draw_focus_border);\n+\tadd_child(focus_panel, false, INTERNAL_MODE_BACK);\n+\n \tdeadzone = GLOBAL_GET(\"gui/common/default_scroll_deadzone\");\n \n \tset_clip_contents(true);\ndiff --git a/scene/gui/scroll_container.h b/scene/gui/scroll_container.h\nindex 7f2352704114..1970ed403fc1 100644\n--- a/scene/gui/scroll_container.h\n+++ b/scene/gui/scroll_container.h\n@@ -34,6 +34,8 @@\n \n #include \"scroll_bar.h\"\n \n+class PanelContainer;\n+\n class ScrollContainer : public Container {\n \tGDCLASS(ScrollContainer, Container);\n \n@@ -49,6 +51,7 @@ class ScrollContainer : public Container {\n private:\n \tHScrollBar *h_scroll = nullptr;\n \tVScrollBar *v_scroll = nullptr;\n+\tPanelContainer *focus_panel = nullptr;\n \n \tmutable Size2 largest_child_min_size; // The largest one among the min sizes of all available child controls.\n \n", "instance_id": "godotengine__godot-104317", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the focus style for a `ScrollContainer` in the Godot engine is not being clipped by its parent, leading to visual overlap or incorrect rendering when nested inside another `ScrollContainer`. The statement includes references to related issues, steps to reproduce, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (the focus style should be clipped by the parent), but not explicitly stated. Additionally, the problem statement does not specify constraints or edge cases beyond the basic reproduction steps, such as how the clipping should behave with different themes or layouts. While the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`scroll_container.cpp`, `scroll_container.h`, `editor_inspector.cpp`, `editor_inspector.h`, and `editor_theme_manager.cpp`) in the Godot engine, indicating a need to understand interactions between different components like the `ScrollContainer`, `PanelContainer`, and theme management. The changes are not trivial; they involve modifying how the focus border is rendered (switching from direct drawing to using a `PanelContainer` to handle clipping issues) and adjusting layout calculations to account for focus style margins and sizes. This requires a deep understanding of Godot's rendering pipeline, theme system, and control hierarchy.\n\nSecond, the technical concepts involved are moderately complex. The solution necessitates knowledge of Godot's GUI system, including `CanvasItem` clipping behavior, stylebox rendering, and control positioning logic. Additionally, the developer must understand how focus states are managed and propagated through child controls. While not requiring advanced algorithms or system-level programming, these concepts demand familiarity with the engine's internals.\n\nThird, the problem involves handling edge cases, such as ensuring the focus border does not overlap with other elements and correctly adjusts to different panel and focus style configurations (e.g., margins and minimum sizes). The code changes explicitly address these by comparing and adjusting for style differences, which adds to the complexity.\n\nFinally, while the changes do not appear to impact the broader system architecture significantly, they do require careful integration to avoid introducing new rendering or layout bugs. Given the need for a solid grasp of the codebase, the multi-file modifications, and the handling of specific rendering edge cases, I assign a difficulty score of 0.65, placing it in the lower end of the \"Hard\" range. It does not reach \"Very Hard\" as it does not involve advanced domain-specific knowledge or system-level redesign, but it is beyond a medium difficulty due to the depth of understanding required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Running with the `--headless` flag does not result in removing the project's recovery mode lock if present\n### Tested versions\n\n4.4.rc1\n\n### System information\n\nGodot v4.4.rc (d91f2cd77) - Windows 11 (build 22631) - Multi-window, 3 monitors - OpenGL 3 (Compatibility) - AMD Radeon RX 7900 XT (Advanced Micro Devices, Inc.; 32.0.11037.4004) - AMD Ryzen Threadripper 7970X 32-Cores (64 threads)\n\n### Issue description\n\nRunning with the `--headless flag` does not result in a call to `_remove_lock_file`\n\n### Steps to reproduce\n\nrun any command on a project with the `--headless` flag.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex e65f894c549f..5a3a651fcd9d 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -4662,6 +4662,12 @@ void Main::cleanup(bool p_force) {\n \tResourceSaver::remove_custom_savers();\n \tPropertyListHelper::clear_base_helpers();\n \n+\t// Remove the lock file if the engine exits successfully. Some automated processes such as\n+\t// --export/--import can bypass and/or finish faster than the existing check to remove the lock file.\n+\tif (OS::get_singleton()->get_exit_code() == EXIT_SUCCESS) {\n+\t\tOS::get_singleton()->remove_lock_file();\n+\t}\n+\n \t// Flush before uninitializing the scene, but delete the MessageQueue as late as possible.\n \tmessage_queue->flush();\n \n", "instance_id": "godotengine__godot-103805", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: running a project with the `--headless` flag does not result in removing the project's recovery mode lock file. It provides context about the tested version, system information, and steps to reproduce the issue. However, there are minor ambiguities and missing details. For instance, it does not explicitly define what the \"recovery mode lock\" is or its purpose in the context of the Godot engine. Additionally, there are no specific examples of commands or scenarios where this issue manifests, nor are there mentions of expected behavior beyond a call to `_remove_lock_file`. Edge cases or potential side effects of not removing the lock file are also not discussed. While the issue is understandable to someone familiar with the Godot engine, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category. The code change provided is minimal, involving the addition of a small conditional block in a single file (`main/main.cpp`) to call `remove_lock_file()` when the engine exits successfully. The scope of the change is narrow, affecting only the cleanup process in the `Main::cleanup` function, and does not appear to impact the broader architecture of the system. The technical concepts required are straightforward: basic C++ control flow and familiarity with the Godot engine's `OS` singleton and its methods. There is no indication of complex interactions with other parts of the codebase or the need for advanced algorithms or design patterns. Regarding edge cases, the problem statement does not explicitly mention any, and the code change does not introduce significant error-handling logic beyond checking the exit code. However, a developer would need to ensure that calling `remove_lock_file()` in this context does not introduce unintended side effects (e.g., removing a lock file that should persist in certain scenarios), which adds a slight layer of complexity. Overall, this task requires understanding some code logic and making a simple modification, justifying a difficulty score of 0.25.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Panel - StyleBoxFlat with rounded borders LEFT and RIGHT creates a line of lighter color in the middle of the panel\n### Tested versions\n\nGodot Engine v4.3.stable.official.77dcf97d8\n\n\n### System information\n\nWin11 - OpenGL API 3.3.0 NVIDIA 572.16 - Compatibility - Using Device: NVIDIA - NVIDIA GeForce RTX 2060 SUPER\n\n### Issue description\n\nLeft and Right border (light line is present):\n![Image](https://github.com/user-attachments/assets/f94e6e4b-8173-464b-9ed6-d0e5d7af2fb0)\n\nTop and Bottom (no light line):\n![Image](https://github.com/user-attachments/assets/b4c36057-f442-4d78-9baf-213999381178)\n\nAt runtime:\n![Image](https://github.com/user-attachments/assets/cedfed74-36c6-4791-8e9a-1a9f33552e63)\n\nBut if I change the size (to a greater value on X axis) - the line disappears:\n![Image](https://github.com/user-attachments/assets/8b8005c4-d0db-47b3-8bc8-99ff73fa65b9)\n\n### Steps to reproduce\n\n1. Create a Panel\n2. Change the size to 128x128\n3. Add StyleBoxFlat in Theme Override - Styles\n4. Set all Corner Radiuses to 70 (to create the circle)\n5. Change the BG color to a darker one with some opacity\n6. In Border Width for the StyleBox start adding to LEFT or RIGHT (or both)\n\n### Minimal reproduction project (MRP)\n\nNot needed\n", "patch": "diff --git a/scene/resources/style_box_flat.cpp b/scene/resources/style_box_flat.cpp\nindex e4dd48d1635e..4e2e5823effd 100644\n--- a/scene/resources/style_box_flat.cpp\n+++ b/scene/resources/style_box_flat.cpp\n@@ -234,6 +234,79 @@ inline void set_inner_corner_radius(const Rect2 style_rect, const Rect2 inner_re\n \tinner_corner_radius[3] = MAX(corner_radius[3] - MIN(border_bottom, border_left), 0); // Bottom left.\n }\n \n+inline void set_corner_scale(const Rect2 &style_rect, const Rect2 &inner_rect, const real_t corner_radius[4], Point2 *inner_scale) {\n+\treal_t border_left = inner_rect.position.x - style_rect.position.x;\n+\treal_t border_top = inner_rect.position.y - style_rect.position.y;\n+\treal_t border_right = style_rect.size.width - inner_rect.size.width - border_left;\n+\treal_t border_bottom = style_rect.size.height - inner_rect.size.height - border_top;\n+\n+\t// Amount of overflow along an edge.\n+\t// Ex. SIDE_LEFT edge is the overflow between top_left and bottom_left corners.\n+\t// MIN(0,) is to ignore underflow, and negating is to make values positive.\n+\treal_t edge_overflow[4] = {\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_BOTTOM_LEFT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_TOP_LEFT] - corner_radius[CORNER_TOP_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.y - corner_radius[CORNER_TOP_RIGHT] - corner_radius[CORNER_BOTTOM_RIGHT]),\n+\t\t-MIN(0, inner_rect.size.x - corner_radius[CORNER_BOTTOM_LEFT] - corner_radius[CORNER_BOTTOM_RIGHT])\n+\t};\n+\n+\t// Sums of borders.\n+\treal_t hb_sum = border_left + border_right;\n+\treal_t vb_sum = border_top + border_bottom;\n+\n+\t// Ratio of each side to the sum of itself and opposite side.\n+\t// Since overflow only happens with opposite borders, you only need to get the ratio of each border relative to the sum of involved borders.\n+\treal_t ratios[4] = {\n+\t\t// Prevent divide by 0 errors.\n+\t\thb_sum > 0 ? (border_left / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_top / vb_sum) : 0,\n+\t\thb_sum > 0 ? (border_right / hb_sum) : 0,\n+\t\tvb_sum > 0 ? (border_bottom / vb_sum) : 0\n+\t};\n+\n+\t// Raw amount each corner should shrink.\n+\tPoint2 corner_reduction[4] = {\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_TOP] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_TOP]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_RIGHT], edge_overflow[SIDE_RIGHT] * ratios[SIDE_BOTTOM]),\n+\t\tPoint2(edge_overflow[SIDE_BOTTOM] * ratios[SIDE_LEFT], edge_overflow[SIDE_LEFT] * ratios[SIDE_BOTTOM]),\n+\t};\n+\n+\t// Corner Radii as Point2s.\n+\tPoint2 pcr[4] = {\n+\t\tPoint2(corner_radius[0], corner_radius[0]),\n+\t\tPoint2(corner_radius[1], corner_radius[1]),\n+\t\tPoint2(corner_radius[2], corner_radius[2]),\n+\t\tPoint2(corner_radius[3], corner_radius[3]),\n+\t};\n+\n+\t// If corner radii are too small, they won't shrink the full amount.\n+\t// Adjacent corners will have to shrink the leftovers if they can.\n+\t// Minf(0) is to ignore non-leftovers, and negating is to make values positive.\n+\tPoint2 leftovers[4] = {\n+\t\t-((pcr[0] - corner_reduction[0]).minf(0)),\n+\t\t-((pcr[1] - corner_reduction[1]).minf(0)),\n+\t\t-((pcr[2] - corner_reduction[2]).minf(0)),\n+\t\t-((pcr[3] - corner_reduction[3]).minf(0)),\n+\t};\n+\n+\t// New shrunken radii after distributing the leftovers.\n+\tPoint2 distributed[4] = {\n+\t\t((pcr[0] - corner_reduction[0] - leftovers[3] - leftovers[1]).maxf(0)),\n+\t\t((pcr[1] - corner_reduction[1] - leftovers[0] - leftovers[2]).maxf(0)),\n+\t\t((pcr[2] - corner_reduction[2] - leftovers[1] - leftovers[3]).maxf(0)),\n+\t\t((pcr[3] - corner_reduction[3] - leftovers[2] - leftovers[0]).maxf(0)),\n+\t};\n+\n+\t// How much the curve should scale to achieve the shrunken radii.\n+\tfor (int i = 0; i < 4; i++) {\n+\t\t// Unshrinkable is how much is still left over, even after distributing leftovers.\n+\t\t// Exclude it from the final scale.\n+\t\tPoint2 unshrinkable = (leftovers[(i + 1) % 4] + leftovers[(i + 4 - 1) % 4] - distributed[i]).maxf(0);\n+\t\tinner_scale[i] = distributed[i] / (pcr[i] - unshrinkable).maxf(FLT_EPSILON);\n+\t}\n+}\n+\n inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices, Vector<Color> &colors, const Rect2 &style_rect, const real_t corner_radius[4],\n \t\tconst Rect2 &ring_rect, const Rect2 &inner_rect, const Color &inner_color, const Color &outer_color, const int corner_detail, const Vector2 &skew, bool is_filled = false) {\n \tint vert_offset = verts.size();\n@@ -244,23 +317,30 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \treal_t ring_corner_radius[4];\n \tset_inner_corner_radius(style_rect, ring_rect, corner_radius, ring_corner_radius);\n \n+\tPoint2 ring_scale[4];\n+\tset_corner_scale(style_rect, ring_rect, ring_corner_radius, ring_scale);\n+\n \t// Corner radius center points.\n \tVector<Point2> outer_points = {\n-\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]), //tl\n-\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1], ring_rect.position.y + ring_corner_radius[1]), //tr\n-\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]), //br\n-\t\tPoint2(ring_rect.position.x + ring_corner_radius[3], ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3]) //bl\n+\t\tring_rect.position + Vector2(ring_corner_radius[0], ring_corner_radius[0]) * ring_scale[0], //tl\n+\t\tPoint2(ring_rect.position.x + ring_rect.size.x - ring_corner_radius[1] * ring_scale[1].x, ring_rect.position.y + ring_corner_radius[1] * ring_scale[1].y), //tr\n+\t\tring_rect.position + ring_rect.size - Vector2(ring_corner_radius[2], ring_corner_radius[2]) * ring_scale[2], //br\n+\t\tPoint2(ring_rect.position.x + ring_corner_radius[3] * ring_scale[3].x, ring_rect.position.y + ring_rect.size.y - ring_corner_radius[3] * ring_scale[3].y) //bl\n \t};\n \n \treal_t inner_corner_radius[4];\n \tset_inner_corner_radius(style_rect, inner_rect, corner_radius, inner_corner_radius);\n \n+\tPoint2 inner_scale[4];\n+\tset_corner_scale(style_rect, inner_rect, inner_corner_radius, inner_scale);\n+\n \tVector<Point2> inner_points = {\n-\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]), //tl\n-\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1], inner_rect.position.y + inner_corner_radius[1]), //tr\n-\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]), //br\n-\t\tPoint2(inner_rect.position.x + inner_corner_radius[3], inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3]) //bl\n+\t\tinner_rect.position + Vector2(inner_corner_radius[0], inner_corner_radius[0]) * inner_scale[0], //tl\n+\t\tPoint2(inner_rect.position.x + inner_rect.size.x - inner_corner_radius[1] * inner_scale[1].x, inner_rect.position.y + inner_corner_radius[1] * inner_scale[1].y), //tr\n+\t\tinner_rect.position + inner_rect.size - Vector2(inner_corner_radius[2], inner_corner_radius[2]) * inner_scale[2], //br\n+\t\tPoint2(inner_rect.position.x + inner_corner_radius[3] * inner_scale[3].x, inner_rect.position.y + inner_rect.size.y - inner_corner_radius[3] * inner_scale[3].y) //bl\n \t};\n+\n \t// Calculate the vertices.\n \n \t// If the center is filled, we do not draw the border and directly use the inner ring as reference. Because all calls to this\n@@ -289,8 +369,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\tconst real_t angle_sine = Math::sin(pt_angle);\n \n \t\t\t{\n-\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine + inner_points[corner_idx].x;\n-\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine + inner_points[corner_idx].y;\n+\t\t\t\tconst real_t x = inner_corner_radius[corner_idx] * angle_cosine * inner_scale[corner_idx].x + inner_points[corner_idx].x;\n+\t\t\t\tconst real_t y = inner_corner_radius[corner_idx] * angle_sine * inner_scale[corner_idx].y + inner_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs] = Vector2(x + x_skew, y + y_skew);\n@@ -298,8 +378,8 @@ inline void draw_rounded_rectangle(Vector<Vector2> &verts, Vector<int> &indices,\n \t\t\t}\n \n \t\t\tif (draw_border) {\n-\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine + outer_points[corner_idx].x;\n-\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine + outer_points[corner_idx].y;\n+\t\t\t\tconst real_t x = ring_corner_radius[corner_idx] * angle_cosine * ring_scale[corner_idx].x + outer_points[corner_idx].x;\n+\t\t\t\tconst real_t y = ring_corner_radius[corner_idx] * angle_sine * ring_scale[corner_idx].y + outer_points[corner_idx].y;\n \t\t\t\tconst float x_skew = -skew.x * (y - style_rect_center.y);\n \t\t\t\tconst float y_skew = -skew.y * (x - style_rect_center.x);\n \t\t\t\tverts_ptr[verts_size + idx_ofs + 1] = Vector2(x + x_skew, y + y_skew);\n", "instance_id": "godotengine__godot-103607", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a visual artifact (a lighter line in the middle of a panel) appears when using StyleBoxFlat with rounded borders on the left and right sides in Godot Engine v4.3. It provides specific steps to reproduce the issue, system information, and illustrative images, which help in understanding the problem context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior (e.g., should the line never appear under any conditions?) or mention specific edge cases beyond resizing the panel on the X-axis. Additionally, it lacks clarity on whether this is purely a rendering issue or tied to specific theme settings or hardware configurations beyond the provided system info. While the issue is reproducible with the given steps, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of solving this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is focused on a single file (style_box_flat.cpp) and a specific rendering logic for rounded rectangles, which limits the breadth of impact on the codebase. However, the depth of the change is significant, as it introduces a new function (set_corner_scale) with complex logic to adjust corner scaling based on border overflow and radii distribution. This requires a deep understanding of the rendering mechanics in Godot, specifically how StyleBoxFlat handles borders and corner radii, as well as vector mathematics for scaling and positioning.\n\nThe technical concepts involved include advanced 2D geometry (handling corner radii, border overflows, and scaling), Godot's rendering pipeline, and C++ programming with inline functions and array manipulations. The code changes also demonstrate a nuanced approach to distributing \"leftovers\" in corner reductions, which adds to the logical complexity. While the problem does not impact the broader system architecture, it requires precise modifications to avoid introducing new visual artifacts or performance issues in rendering.\n\nEdge cases are implicitly present, as the issue manifests under specific conditions (e.g., certain border widths and corner radii), and the solution must handle scenarios like zero borders or extreme radii values, as seen in the code's safeguards against division by zero and negative values. However, explicit error handling is not a major focus of the change. Overall, this problem demands a solid grasp of graphical rendering concepts and careful implementation, placing it in the 0.6-0.8 range. I assign a score of 0.65 to reflect the challenge of understanding and modifying the rendering logic while acknowledging that the scope is confined to a single component.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Android editor: Game crash after changing device language\n### Tested versions\n\nGodot Engine v4.3.stable.official [77dcf97d8]\n\n### System information\n\nXiaomi Redmi A2+, Android 13, compatible rendering\n\n### Issue description\n\nAfter changing device language, opening the game will hang for a few seconds then exit.\r\nThis issue occur the same way on Android emulator x86\n\n### Steps to reproduce\n\n1. Open the game\r\n2. Leave the game run in background and go to device system settings\r\n3. Change device display language\r\n4. Re-enter the game (the game will hang for a few seconds then exit)\n\n### Minimal reproduction project (MRP)\n\n[demo.zip](https://github.com/user-attachments/files/16936623/demo.zip)\r\n\n", "patch": "diff --git a/platform/android/java/app/AndroidManifest.xml b/platform/android/java/app/AndroidManifest.xml\nindex 60ce75fd16e2..1d59d15d560f 100644\n--- a/platform/android/java/app/AndroidManifest.xml\n+++ b/platform/android/java/app/AndroidManifest.xml\n@@ -46,7 +46,7 @@\n             android:excludeFromRecents=\"false\"\n             android:exported=\"true\"\n             android:screenOrientation=\"landscape\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:resizeableActivity=\"false\"\n             tools:ignore=\"UnusedAttribute\" >\n \ndiff --git a/platform/android/java/editor/src/main/AndroidManifest.xml b/platform/android/java/editor/src/main/AndroidManifest.xml\nindex a1971554bf7d..b136e348b2c7 100644\n--- a/platform/android/java/editor/src/main/AndroidManifest.xml\n+++ b/platform/android/java/editor/src/main/AndroidManifest.xml\n@@ -41,7 +41,7 @@\n \n         <activity\n             android:name=\".GodotEditor\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"true\"\n             android:icon=\"@mipmap/themed_icon\"\n             android:launchMode=\"singleTask\"\n@@ -59,7 +59,7 @@\n         </activity>\n         <activity\n             android:name=\".GodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -74,7 +74,7 @@\n         </activity>\n         <activity\n             android:name=\".embed.EmbeddedGodotGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:exported=\"false\"\n             android:icon=\"@mipmap/ic_play_window\"\n             android:label=\"@string/godot_game_activity_name\"\n@@ -87,7 +87,7 @@\n             android:screenOrientation=\"userLandscape\" />\n         <activity\n             android:name=\".GodotXRGame\"\n-            android:configChanges=\"orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n+            android:configChanges=\"layoutDirection|locale|orientation|keyboardHidden|screenSize|smallestScreenSize|density|keyboard|navigation|screenLayout|uiMode\"\n             android:process=\":GodotXRGame\"\n             android:launchMode=\"singleTask\"\n             android:icon=\"@mipmap/ic_play_window\"\n", "instance_id": "godotengine__godot-103419", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a game crash on Android after changing the device language. It provides specific details such as the tested version of Godot Engine, system information, steps to reproduce, and even a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention the expected behavior after a language change (e.g., should the game reload with the new language or ignore the change?). Additionally, there are no details about specific error messages or logs that might help pinpoint the root cause of the crash. While the steps to reproduce are clear, edge cases or additional context (e.g., does this happen with all languages or specific ones?) are not addressed. Thus, while the problem is valid and mostly clear, it lacks some minor but useful details for a fully comprehensive understanding.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" category (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are minimal and localized to AndroidManifest.xml files in the Godot Engine's Android platform module. The modification involves adding \"layoutDirection|locale\" to the `android:configChanges` attribute for several activities. This change is straightforward, affecting only configuration settings in manifest files, and does not require deep modifications to the codebase or impact the system's architecture. It is a small, targeted fix.\n\n2. **Number of Technical Concepts**: Solving this issue requires basic knowledge of Android development, specifically understanding the `android:configChanges` attribute in the AndroidManifest.xml file. This attribute is used to handle configuration changes (like language or layout direction) without restarting the activity, which likely prevents the crash. No advanced algorithms, design patterns, or complex language features are involved. Familiarity with Android's activity lifecycle and configuration management is helpful but not deeply complex.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention specific edge cases beyond the language change scenario. The code change itself does not introduce new error handling logic; it simply updates a configuration to prevent the app from restarting or crashing on locale changes. While there might be implicit edge cases (e.g., ensuring compatibility with different Android versions or handling unsupported languages), these are not addressed in the problem or code changes and do not significantly increase the difficulty.\n\n4. **Overall Complexity**: The fix is a well-known pattern in Android development for handling locale changes, and the implementation is a one-line change per activity in the manifest files. It does not require deep understanding of the broader Godot Engine codebase or complex interactions between modules. The impact is limited to the Android platform layer, and the amount of code changed is minimal.\n\nGiven these factors, the difficulty is rated at 0.25, as it involves a simple, localized fix with minimal technical complexity. It requires basic Android development knowledge and does not involve significant logic, edge case handling, or architectural changes. This is an easy problem for someone with even moderate experience in Android app development or configuration management.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crash when interacting with a re-opened scene containing an animation player\n### Tested versions\n\nAt least 4.4.beta1 to current head `6dc78c8aa17ad46e701e0c4e7b7632c2f0e098f1` but involves code introduced in  https://github.com/godotengine/godot/pull/99700 or a related PR cc @hpvb \n\n~~As far as I've seen, the crash does not happen if the editor is compiled with `dev_build=yes`~~\n\n### System information\n\nGodot v4.4.beta.mono (6dc78c8aa) - macOS Sequoia (15.2.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 (Apple8) - Apple M2 (8 threads)\n\n### Issue description\n\nAfter closing and re-opening a scene containing an animation player and then either selecting a node or closing the scene tab several times, either SIGSEGV or SIGBUS crashes the editor. From lldb:\n```\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BAD_ACCESS (code=1, address=0x3d9ec6003f8001a8)\n  * frame #0: 0x0000000102cb4df8 godot.macos.editor.arm64`Node::get_parent() const\n    frame #1: 0x0000000102468e1c godot.macos.editor.arm64`SceneTreeEditor::_update_tree(bool) + 500\n    frame #2: 0x0000000104bd0394 godot.macos.editor.arm64`CallQueue::_call_function(Callable const&, Variant const*, int, bool) + 336\n    frame #3: 0x0000000104bd06b0 godot.macos.editor.arm64`CallQueue::flush() + 352\n    frame #4: 0x0000000102ceb6d0 godot.macos.editor.arm64`SceneTree::physics_process(double) + 244\n    frame #5: 0x00000001003f366c godot.macos.editor.arm64`Main::iteration() + 596\n    frame #6: 0x0000000100383878 godot.macos.editor.arm64`OS_MacOS::run() + 148\n    frame #7: 0x00000001003b0ad4 godot.macos.editor.arm64`main + 388\n    frame #8: 0x0000000196350274 dyld`start + 2840\n```\nPresumably some call is getting inlined between _update_tree and get_parent?\n\n### Steps to reproduce\n\nClose and reopen the same scene several times in a row, optionally interacting with a node. In my tests, I saw a crash after anywhere between 1 and 4 close/reopen cycles with the last user action being any of opening the scene, closing the scene, or selecting a node in the tree.\n\n### Minimal reproduction project (MRP)\n\n[glb_test.zip](https://github.com/user-attachments/files/18680946/glb_test.zip)\n", "patch": "diff --git a/editor/gui/scene_tree_editor.cpp b/editor/gui/scene_tree_editor.cpp\nindex ab834929cd58..5aedd940e482 100644\n--- a/editor/gui/scene_tree_editor.cpp\n+++ b/editor/gui/scene_tree_editor.cpp\n@@ -924,12 +924,19 @@ void SceneTreeEditor::_update_tree(bool p_scroll_to_selected) {\n \t\t// If pinned state changed, update the currently pinned node.\n \t\tif (AnimationPlayerEditor::get_singleton()->is_pinned() != node_cache.current_has_pin) {\n \t\t\tnode_cache.current_has_pin = AnimationPlayerEditor::get_singleton()->is_pinned();\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n \t\t}\n \t\t// If the current pinned node changed update both the old and new node.\n \t\tif (node_cache.current_pinned_node != pinned_node) {\n-\t\t\tnode_cache.mark_dirty(pinned_node);\n-\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t// get_editing_node() will return deleted nodes. If the nodes are not in cache don't try to mark them.\n+\t\t\tif (node_cache.has(pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(pinned_node);\n+\t\t\t}\n+\t\t\tif (node_cache.has(node_cache.current_pinned_node)) {\n+\t\t\t\tnode_cache.mark_dirty(node_cache.current_pinned_node);\n+\t\t\t}\n \t\t\tnode_cache.current_pinned_node = pinned_node;\n \t\t}\n \n@@ -2373,6 +2380,10 @@ HashMap<Node *, SceneTreeEditor::CachedNode>::Iterator SceneTreeEditor::NodeCach\n \treturn I;\n }\n \n+bool SceneTreeEditor::NodeCache::has(Node *p_node) {\n+\treturn get(p_node, false).operator bool();\n+}\n+\n void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \tif (!p_node) {\n \t\treturn;\n@@ -2382,6 +2393,11 @@ void SceneTreeEditor::NodeCache::remove(Node *p_node, bool p_recursive) {\n \t\teditor->selected = nullptr;\n \t}\n \n+\tif (p_node == current_pinned_node) {\n+\t\tcurrent_pinned_node = nullptr;\n+\t\tcurrent_has_pin = false;\n+\t}\n+\n \teditor->marked.erase(p_node);\n \n \tHashMap<Node *, CachedNode>::Iterator I = cache.find(p_node);\n@@ -2419,6 +2435,7 @@ void SceneTreeEditor::NodeCache::mark_dirty(Node *p_node, bool p_parents) {\n \t\tif (!p_parents) {\n \t\t\tbreak;\n \t\t}\n+\n \t\tnode = node->get_parent();\n \t}\n }\n@@ -2483,4 +2500,6 @@ void SceneTreeEditor::NodeCache::clear() {\n \t}\n \tcache.clear();\n \tto_delete.clear();\n+\tcurrent_pinned_node = nullptr;\n+\tcurrent_has_pin = false;\n }\ndiff --git a/editor/gui/scene_tree_editor.h b/editor/gui/scene_tree_editor.h\nindex e789e9692419..d29c4df0cdb2 100644\n--- a/editor/gui/scene_tree_editor.h\n+++ b/editor/gui/scene_tree_editor.h\n@@ -90,6 +90,7 @@ class SceneTreeEditor : public Control {\n \n \t\tHashMap<Node *, CachedNode>::Iterator add(Node *p_node, TreeItem *p_item);\n \t\tHashMap<Node *, CachedNode>::Iterator get(Node *p_node, bool p_deleted_ok = true);\n+\t\tbool has(Node *p_node);\n \t\tvoid remove(Node *p_node, bool p_recursive = false);\n \t\tvoid mark_dirty(Node *p_node, bool p_parents = true);\n \t\tvoid mark_children_dirty(Node *p_node, bool p_recursive = false);\n", "instance_id": "godotengine__godot-102813", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash in the Godot editor when interacting with a re-opened scene containing an animation player. It provides specific details such as the affected versions, system information, steps to reproduce, and a minimal reproduction project (MRP). Additionally, a stack trace from the crash is included, which helps in identifying the problematic area of the codebase. However, there are minor ambiguities that prevent a perfect score. For instance, the exact cause of the crash (e.g., whether it's a null pointer dereference or memory corruption) is not explicitly deduced or hypothesized in the statement, leaving some room for interpretation. Furthermore, while the steps to reproduce are provided, they are somewhat vague in terms of the exact sequence or conditions that guarantee the crash (\"anywhere between 1 and 4 close/reopen cycles\"). Edge cases or specific conditions leading to the crash are not fully detailed, which could complicate debugging efforts. Overall, the statement is valid and mostly clear but lacks some precision in critical details.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the issue involves a crash in a complex editor application (Godot), which suggests a deep understanding of the editor's internals, specifically the scene tree and animation player interactions. The code changes provided are focused on the `SceneTreeEditor` class, particularly around node caching and pinned node handling, indicating that the fix requires understanding how nodes are managed and updated in the editor's GUI. The modifications are relatively localized to a single file (`scene_tree_editor.cpp`) and its header, but they involve critical logic for node management, which could have broader implications on the editor's stability if not handled correctly. \n\nFrom a technical concepts perspective, the problem requires knowledge of C++ (memory management, pointers, and object lifetimes), familiarity with Godot's architecture (scene tree, node caching, editor GUI), and debugging skills to interpret stack traces and pinpoint the root cause of a crash (SIGSEGV/SIGBUS). The changes introduce checks to prevent accessing invalid or deleted nodes, which suggests handling edge cases related to node deletion or invalidation—potentially a common source of crashes in such systems. The addition of a `has()` method and conditional checks for node existence in the cache demonstrates a need to handle these edge cases explicitly, adding to the complexity.\n\nThe difficulty is further compounded by the need to ensure that these changes do not introduce new issues in the editor's behavior, especially since the crash occurs under specific, non-deterministic conditions (re-opening scenes multiple times). While the code changes are not extensive in terms of lines of code, the impact of getting this wrong could be significant, as it deals with core editor functionality. This places the difficulty at 0.65, reflecting a hard problem that requires a solid grasp of the codebase, careful handling of edge cases, and a good understanding of C++ memory management, but it does not reach the \"Very Hard\" category as it does not appear to involve system-level or highly domain-specific challenges beyond the editor's architecture.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Exported vars  without a default set, of enum types with no entry with a value of 0, show misleading info in inspector\n### Godot version\n\nv4.0.rc6.official [0cd148313]\n\n### System information\n\nArch Linux\n\n### Issue description\n\nIn GDScript, when exporting a variable of an enum type that does NOT have an entry with value `0` (zero), and you don't  a default value, the inspector looks as if you have selected the first element, but in truth, the value of the variable is `0`.\r\n\r\nGiven the following snippet:\r\n\r\n```\r\nenum Foo{\r\n\tbar = 1,\r\n\tfoobar = 2,\r\n}\r\n@export var foo : Foo\r\n```\r\n\r\nThe inspector looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/7486114/221964166-7493668b-bf60-4f7a-b95f-787081599882.png)\r\n\r\nThis suggests `bar` is selected, and thus `foo` should be `1`.\r\n\r\nHowever,\r\n```\r\nfunc _ready():\r\n\tprint(str(foo))\r\n```\r\nprints `0` (zero).\r\n\r\nIf you _do_ give a default:\r\n\r\n```\r\n@export var foo : Foo = Foo.bar\r\n```\r\n\r\nthe inspector looks exactly the same as it did without the default specified, but the output _is_ the (expected) `1`. As a user, I thus can't tell the difference without inspecting the code. \r\n\r\nAs a user, I expect that whatever is shown in the inspector is a representation of what I'll get when I run the code. So when no default is specified, I expect that either (the inspector shows `0` or `null`) _or_ (the value of `foo` ends up being `bar` instead of `0`). Ideally, I would like it to do the latter, but I think that the former is technically more correct\n\n### Steps to reproduce\n\n1. Make a new scene \r\n2. Attach the following script:\r\n```\r\nextends Node\r\n\r\nenum Foo{\r\n\tbar = 1,\r\n\tfoobar = 2,\r\n}\r\n\r\n@export var foo : Foo\r\n\r\nfunc _ready():\r\n\tprint(str(foo))\r\n```\r\n3. Observe that the inspector for this node suggest that `foo`  is set to `bar`.\r\n4. Run the code, and observe the ouput prints `0` instead.\r\n5. Change the export line to `@export var foo : Foo = Foo.bar`\r\n6. Observe that the outliner looks exactly the same as before\r\n7. Run the code, and observe that the output now reads `1`.\n\n### Minimal reproduction project\n\nn/a, but can be supplied if helpful. \n", "patch": "diff --git a/editor/editor_properties.cpp b/editor/editor_properties.cpp\nindex 9ea0c2de9a75..52780d7c5889 100644\n--- a/editor/editor_properties.cpp\n+++ b/editor/editor_properties.cpp\n@@ -321,6 +321,9 @@ void EditorPropertyTextEnum::update_property() {\n \t\t}\n \t} else {\n \t\toption_button->select(default_option);\n+\t\tif (default_option < 0) {\n+\t\t\toption_button->set_text(current_value);\n+\t\t}\n \t}\n }\n \n@@ -699,6 +702,7 @@ void EditorPropertyEnum::update_property() {\n \tVariant current = get_edited_property_value();\n \tif (current.get_type() == Variant::NIL) {\n \t\toptions->select(-1);\n+\t\toptions->set_text(\"<null>\");\n \t\treturn;\n \t}\n \n@@ -709,6 +713,8 @@ void EditorPropertyEnum::update_property() {\n \t\t\treturn;\n \t\t}\n \t}\n+\toptions->select(-1);\n+\toptions->set_text(itos(which));\n }\n \n void EditorPropertyEnum::setup(const Vector<String> &p_options) {\n", "instance_id": "godotengine__godot-102743", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the discrepancy between the Godot inspector display and the actual value of an exported enum variable when no default is set. It includes a code snippet, steps to reproduce, and visual evidence (screenshot) to illustrate the problem. The expected behavior is also discussed, with a preference for aligning the inspector display with the runtime value. However, there are minor ambiguities: the problem statement does not explicitly define all edge cases (e.g., behavior with negative enum values or non-sequential enum values beyond the provided example) or constraints on the solution (e.g., performance considerations or compatibility with other Godot features). Additionally, while the desired outcome is mentioned, it is not definitively specified whether the inspector should show a \"null\" state or default to the first enum value. These minor missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided diff shows modifications to a single file (`editor_properties.cpp`) in the Godot engine codebase, specifically targeting the UI behavior of the inspector for enum properties. The changes are localized to a few functions (`EditorPropertyTextEnum::update_property` and `EditorPropertyEnum::update_property`) and involve a small number of lines (adding conditional text updates for invalid or null selections). There is no indication of widespread impact on the system's architecture or interactions with other modules, making the scope relatively narrow.\n\n2. **Technical Concepts Involved:** Solving this requires a basic understanding of C++ (the language used in the Godot engine), familiarity with Godot's editor property system, and how UI elements like dropdowns (`OptionButton`) are updated. The concepts are not particularly complex—primarily involving conditional logic and string manipulation to update the inspector display. No advanced algorithms, design patterns, or domain-specific knowledge beyond Godot's editor internals are needed.\n\n3. **Edge Cases and Error Handling:** The problem statement highlights a specific edge case (enums without a value of 0 and no default set), and the code changes address this by updating the inspector text to reflect the actual value or a null state. However, the complexity of handling these edge cases is low, as it involves straightforward checks and UI updates. Additional edge cases (e.g., invalid enum values or UI rendering issues) are not mentioned or addressed in the diff, suggesting limited depth in error handling requirements.\n\n4. **Overall Complexity:** The task involves understanding a small part of the Godot editor codebase and making targeted UI fixes. It does not require deep architectural changes, performance optimization, or extensive debugging of complex interactions. The problem is a straightforward bug fix with a clear path to resolution, aligning with an Easy difficulty level.\n\nA score of 0.35 is assigned as it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to understand Godot's property system and ensure the UI reflects the correct state, but it remains within the realm of simple modifications without significant technical challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crashes when callback for `RD::texture_get_data_async` is an empty method\n\n\n### Tested versions\n\n- Reproducable in 4.4-beta2, 4.4-beta1, 4.4-dev7\n\n(All versions with [#100110](https://github.com/godotengine/godot/pull/100110))\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 22631) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6094) - 12th Gen Intel(R) Core(TM) i5-12400F (12 threads)\n\n### Issue description\n\nWhen calling `RD::texture_get_data_async` from a tool script on every process and passing a callback to an empty method the Editor crashes after about 5 seconds.\n\n```\nERROR: FATAL: Index p_index = 8278 is out of bounds (count = 82).\n   at: operator[] (./core/templates/local_vector.h:178)\n\n================================================================\nCrashHandlerException: Program crashed with signal 4\nEngine version: Godot Engine v4.4.beta2.official (a013481b0911e59cc3f3dea7ebb732450c3e1460)\nDumping the backtrace. Please include this when reporting the bug to the project developer.\n\n(no backtrace.. same with --verbose)\n```\n\nRunning the game does not trigger the crash. It only seems to be happening in the editor.\n\nHaving something happen in the callback also doesn't seem to trigger the crash or perhaps delays it to great extend. I doubt that the empty callback is the root cause. It probably just triggers whatever is wrong with using it in the editor faster. Though, I'm speculating here.\n\nIf this wasn't intended to work in the editor, there should be a guard.\n\n### Steps to reproduce\n\n- Uncommennt `@tool` at the top of node.gd\n- save\n- reopen the scene\n- switch to 2D\n- wait for about 5s\n\nAlso try uncommenting the print statement in the callback. That seems to stop the crash.\n\n### Minimal reproduction project (MRP)\n\n[texture-get-data-async-empty-callback-editor-crash.zip](https://github.com/user-attachments/files/18656439/texture-get-data-async-empty-callback-editor-crash.zip)\n", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9716a42c97b9..055fcbeda64f 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -721,7 +721,6 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t_check_transfer_worker_buffer(buffer);\n \n \tBufferGetDataRequest get_data_request;\n-\tuint32_t flushed_copies = 0;\n \tget_data_request.callback = p_callback;\n \tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n \tget_data_request.size = p_size;\n@@ -738,22 +737,26 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\treturn err;\n \t\t}\n \n-\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n+\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\tif (flush_frames) {\n \t\t\tif (_buffer_make_mutable(buffer, p_buffer)) {\n \t\t\t\t// The buffer must be mutable to be used as a copy source.\n \t\t\t\tdraw_graph.add_synchronization();\n \t\t\t}\n \n-\t\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t\t}\n-\n-\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t}\n \n \t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\tif (flush_frames) {\n+\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_copy_regions.size();\n+\t\t}\n+\n \t\tRDD::BufferCopyRegion region;\n \t\tregion.src_offset = submit_from + p_offset;\n \t\tregion.dst_offset = block_write_offset;\n@@ -775,7 +778,7 @@ Error RenderingDevice::buffer_get_data_async(RID p_buffer, const Callable &p_cal\n \t\t\tdraw_graph.add_synchronization();\n \t\t}\n \n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_buffer_get_data(buffer->driver_id, buffer->draw_tracker, frames[frame].download_buffer_staging_buffers[local_index], frames[frame].download_buffer_copy_regions[local_index]);\n \t\t}\n@@ -2098,7 +2101,6 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \tuint32_t block_write_offset;\n \tuint32_t block_write_amount;\n \tStagingRequiredAction required_action;\n-\tuint32_t flushed_copies = 0;\n \tfor (uint32_t i = 0; i < tex->mipmaps; i++) {\n \t\tuint32_t image_total = get_image_format_required_size(tex->format, tex->width, tex->height, tex->depth, i + 1, &w, &h, &d);\n \t\tuint32_t tight_mip_size = image_total - mipmap_offset;\n@@ -2119,17 +2121,21 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t\t\t\t\tError err = _staging_buffer_allocate(download_staging_buffers, to_allocate, required_align, block_write_offset, block_write_amount, required_action, false);\n \t\t\t\t\tERR_FAIL_COND_V(err, ERR_CANT_CREATE);\n \n-\t\t\t\t\tif ((get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL) {\n-\t\t\t\t\t\tfor (uint32_t j = flushed_copies; j < get_data_request.frame_local_count; j++) {\n+\t\t\t\t\tconst bool flush_frames = (get_data_request.frame_local_count > 0) && required_action == STAGING_REQUIRED_ACTION_FLUSH_AND_STALL_ALL;\n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tfor (uint32_t j = 0; j < get_data_request.frame_local_count; j++) {\n \t\t\t\t\t\t\tuint32_t local_index = get_data_request.frame_local_index + j;\n \t\t\t\t\t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tflushed_copies = get_data_request.frame_local_count;\n \t\t\t\t\t}\n \n \t\t\t\t\t_staging_buffer_execute_required_action(download_staging_buffers, required_action);\n \n+\t\t\t\t\tif (flush_frames) {\n+\t\t\t\t\t\tget_data_request.frame_local_count = 0;\n+\t\t\t\t\t\tget_data_request.frame_local_index = frames[frame].download_buffer_texture_copy_regions.size();\n+\t\t\t\t\t}\n+\n \t\t\t\t\tRDD::BufferTextureCopyRegion copy_region;\n \t\t\t\t\tcopy_region.buffer_offset = block_write_offset;\n \t\t\t\t\tcopy_region.texture_subresources.aspect = tex->read_aspect_flags;\n@@ -2154,12 +2160,11 @@ Error RenderingDevice::texture_get_data_async(RID p_texture, uint32_t p_layer, c\n \t}\n \n \tif (get_data_request.frame_local_count > 0) {\n-\t\tfor (uint32_t i = flushed_copies; i < get_data_request.frame_local_count; i++) {\n+\t\tfor (uint32_t i = 0; i < get_data_request.frame_local_count; i++) {\n \t\t\tuint32_t local_index = get_data_request.frame_local_index + i;\n \t\t\tdraw_graph.add_texture_get_data(tex->driver_id, tex->draw_tracker, frames[frame].download_texture_staging_buffers[local_index], frames[frame].download_buffer_texture_copy_regions[local_index]);\n \t\t}\n \n-\t\tflushed_copies = get_data_request.frame_local_count;\n \t\tframes[frame].download_texture_get_data_requests.push_back(get_data_request);\n \t}\n \n", "instance_id": "godotengine__godot-102454", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the editor crashes when using `RD::texture_get_data_async` with an empty callback method in a tool script. It provides specific details such as the affected versions, system information, steps to reproduce, and a minimal reproduction project (MRP). The description also includes observations about the crash not occurring when running the game or when the callback has content, which adds helpful context. However, there are minor ambiguities and missing details. For instance, the root cause is speculative (\"I doubt that the empty callback is the root cause\"), and there is no clear mention of expected behavior or constraints for using `texture_get_data_async` in the editor. Additionally, edge cases beyond the empty callback are not explicitly discussed, which could impact the completeness of the solution. Overall, while the problem is well-documented, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes is focused on a single file (`rendering_device.cpp`), but the modifications are intricate, involving logic related to asynchronous data retrieval, buffer management, and frame synchronization in a rendering engine (Godot). The changes impact critical functionality, as they address a crash in the editor, which suggests a deep interaction with the rendering pipeline and memory management. Second, the technical concepts required to solve this are complex, including understanding asynchronous operations, GPU buffer handling, staging buffers, and the specific behavior of the Godot engine's rendering device API. The code changes also involve managing frame-local indices and ensuring proper synchronization, which requires a solid grasp of low-level graphics programming and concurrency. Third, while the problem statement does not explicitly mention edge cases beyond the empty callback, the nature of the crash and the speculative root cause imply that there could be subtle timing or resource management issues to handle, potentially requiring robust error handling or additional safeguards. Finally, solving this issue demands a deep understanding of the codebase architecture, particularly the rendering subsystem, making it a challenging task even for experienced developers. A score of 0.75 reflects the high complexity and specialized knowledge required, though it does not reach the \"Very Hard\" range as it does not appear to involve system-level redesign or extremely intricate domain-specific challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Functionality of cmd.exe \"color\" command broken since 1.22\n### Windows Terminal version\n\n1.22.10731.0\n\n### Windows build number\n\n10.0.26100.3624\n\n### Other Software\n\nNew history list (F7) implementation changes the default text/background colors of console and does not restore them back on close. Probably, introduced in #17445.\n\n### Steps to reproduce\n\n* Run command prompt (cmd.exe) in Terminal\n* Type `help` command. Help will be displayed.\n* Type `color E0` command. Colors of text and background will change,\n* Type `help` command again. Help will be displayed with new color. You can type other commands, they will also produce output using new colors.\n* Press F7, select `help` command from the list and press Enter, Help will be displayed with **original** color that was active before the `color E0` command was executed. All subsequent commands will also use this color.\n\n\n### Expected Behavior\n\nColor change made by `color E0` command will remain active after history usage,\n\n### Actual Behavior\n\nResult of `color E0` command is reverted by F7 implementation,\n", "patch": "diff --git a/src/host/readDataCooked.cpp b/src/host/readDataCooked.cpp\nindex 8b88f2d4a38..ea086b12301 100644\n--- a/src/host/readDataCooked.cpp\n+++ b/src/host/readDataCooked.cpp\n@@ -1119,12 +1119,33 @@ void COOKED_READ_DATA::_redisplay()\n         output.append(L\"\\x1b[J\");\r\n     }\r\n \r\n-    // Disable the cursor when opening a popup, reenable it when closing them.\r\n+    // Backup the attributes (DECSC) and disable the cursor when opening a popup (DECTCEM).\r\n+    // Restore the attributes (DECRC) reenable the cursor when closing them (DECTCEM).\r\n     if (const auto popupOpened = !_popups.empty(); _popupOpened != popupOpened)\r\n     {\r\n-        wchar_t buf[] = L\"\\x1b[?25l\";\r\n-        buf[5] = popupOpened ? 'l' : 'h';\r\n-        output.append(&buf[0], 6);\r\n+        wchar_t buf[] =\r\n+            // Back/restore cursor position & attributes (commonly supported)\r\n+            L\"\\u001b7\"\r\n+            // Show/hide cursor (commonly supported)\r\n+            \"\\u001b[?25l\"\r\n+            // The popup code uses XTPUSHSGR (CSI # {) / XTPOPSGR (CSI # }) to draw the popups in the popup-colors,\r\n+            // while properly restoring the previous VT attributes. On terminals that support them, the following\r\n+            // won't do anything. On other terminals however, it'll reset the attributes to default.\r\n+            // This is important as the first thing the popup drawing code uses CSI K to erase the previous contents\r\n+            // and CSI m to reset the attributes on terminals that don't support XTPUSHSGR/XTPOPSGR. In order for\r\n+            // the first CSI K to behave as if there had a previous CSI m, we must emit an initial CSI m here.\r\n+            // (rarely supported)\r\n+            \"\\x1b[#{\\x1b[m\\x1b[#}\";\r\n+\r\n+        buf[1] = popupOpened ? '7' : '8';\r\n+        buf[7] = popupOpened ? 'l' : 'h';\r\n+\r\n+        // When the popup closes we skip the XTPUSHSGR/XTPOPSGR sequence. This is crucial because we\r\n+        // use DECRC to restore the cursor position and attributes with a widely supported sequence.\r\n+        // If we emitted that XTPUSHSGR/XTPOPSGR sequence it would reset the attributes again.\r\n+        const size_t len = popupOpened ? 19 : 8;\r\n+\r\n+        output.append(buf, len);\r\n         _popupOpened = popupOpened;\r\n     }\r\n \r\n@@ -1595,10 +1616,10 @@ void COOKED_READ_DATA::_popupDrawPrompt(std::vector<Line>& lines, const til::Coo\n     str.append(suffix);\r\n \r\n     std::wstring line;\r\n-    line.append(L\"\\x1b[K\");\r\n+    line.append(L\"\\x1b[#{\\x1b[K\");\r\n     _appendPopupAttr(line);\r\n     const auto res = _layoutLine(line, str, 0, 0, width);\r\n-    line.append(L\"\\x1b[m\");\r\n+    line.append(L\"\\x1b[m\\x1b[#}\");\r\n \r\n     lines.emplace_back(std::move(line), 0, 0, res.column);\r\n }\r\n@@ -1654,7 +1675,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n         const auto selected = index == cl.selected && !stackedCommandNumberPopup;\r\n \r\n         std::wstring line;\r\n-        line.append(L\"\\x1b[K\");\r\n+        line.append(L\"\\x1b[#{\\x1b[K\");\r\n         _appendPopupAttr(line);\r\n \r\n         wchar_t scrollbarChar = L' ';\r\n@@ -1681,7 +1702,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n         }\r\n         else\r\n         {\r\n-            line.append(L\"\\x1b[m \");\r\n+            line.append(L\"\\x1b[m\\x1b[#} \");\r\n         }\r\n \r\n         fmt::format_to(std::back_inserter(line), FMT_COMPILE(L\"{:{}}: \"), index, indexWidth);\r\n@@ -1690,7 +1711,7 @@ void COOKED_READ_DATA::_popupDrawCommandList(std::vector<Line>& lines, const til\n \r\n         if (selected)\r\n         {\r\n-            line.append(L\"\\x1b[m\");\r\n+            line.append(L\"\\x1b[m\\x1b[#}\");\r\n         }\r\n \r\n         line.append(L\"\\r\\n\");\r\n", "instance_id": "microsoft__terminal-18797", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `color` command in `cmd.exe` within Windows Terminal reverts to original colors after using the F7 history feature, which is not the expected behavior. It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem. However, there are minor ambiguities and missing details. For instance, it does not explicitly mention whether this issue affects only specific color codes or all color changes, nor does it discuss potential edge cases like multiple color changes or interactions with other terminal features. Additionally, while it references a likely cause (a change introduced in a specific PR), it lacks deeper technical context about the terminal's color handling mechanism or the F7 history implementation. Overall, the statement is valid and clear but could benefit from more comprehensive details on constraints and edge cases.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is relatively focused, primarily within a single file (`readDataCooked.cpp`), but the modifications involve intricate handling of terminal escape sequences and attribute management (e.g., cursor visibility, color attributes). This requires a deep understanding of terminal emulation and VT (Virtual Terminal) sequences, which are niche and complex concepts. Second, the changes impact how popups (like the F7 history list) interact with terminal state, specifically color attributes, which suggests a need to understand the broader terminal rendering logic and state management. Third, the number of technical concepts involved is significant, including terminal escape codes (e.g., DECSC/DECRC for saving/restoring cursor and attributes, XTPUSHSGR/XTPOPSGR for attribute stacking), terminal popup rendering, and attribute restoration logic. These are advanced topics that require specific domain knowledge of terminal emulation. Finally, while the problem statement does not explicitly mention edge cases, the code changes imply potential complexities in ensuring that color attributes are consistently preserved across various terminal states and interactions (e.g., nested popups, multiple color changes). The solution also involves careful sequencing of escape codes to avoid unintended resets, adding to the intricacy. Overall, this problem requires a solid grasp of terminal internals and careful modification of state management logic, justifying a difficulty score of 0.65, on the lower end of the \"Hard\" range due to the focused scope of changes but still reflecting the technical depth required.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Request: \"Select color scheme...\" mouse-hover should provide color-scheme preview\n### Description of the new feature\n\nThis is a tiny quality-of-life improvement request:\n\nCTRL + SHIFT + P   ----> \"Select color scheme...\"\n\nWe see now see a dropdown of all our color schemes.\nThe UP and DOWN arrows trigger a preview of the highlighted color-scheme.\nBut hovering the mouse over a color-scheme ...only results in a 'gentle highlight', no preview.\n\nMy request: hovering over a color-scheme should also trigger a preview in the current tab.\n\nThis may seem trivial, but it would be much appreciated.\n\n\n### Proposed technical implementation details\n\n_No response_\n", "patch": "diff --git a/src/cascadia/TerminalApp/CommandPalette.cpp b/src/cascadia/TerminalApp/CommandPalette.cpp\nindex bcee25c72dd..6d5540703fc 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.cpp\n+++ b/src/cascadia/TerminalApp/CommandPalette.cpp\n@@ -530,6 +530,79 @@ namespace winrt::TerminalApp::implementation\n         }\n     }\n \n+    // Method Description:\n+    // - This event is called when the user's mouse pointer enters an individual\n+    //   item from the list. We'll get the item that was hovered and \"preview\"\n+    //   the command that the user hovered. To do that, we'll dispatch the switch\n+    //   to tab command for this tab, but not dismiss the switcher.\n+    //\n+    // Arguments:\n+    // - sender: the UI element that raised the event.\n+    // Return Value:\n+    // - <none>\n+    void CommandPalette::_listItemPointerEntered(const winrt::Windows::Foundation::IInspectable& sender,\n+                                                 const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& /*args*/)\n+    {\n+        // cancel any pending exit timer to prevent an unwanted preview revert\n+        if (_pointerExitTimer)\n+        {\n+            _pointerExitTimer.Stop();\n+        }\n+\n+        const auto listViewItem = sender.try_as<winrt::Windows::UI::Xaml::Controls::ListViewItem>();\n+        if (_currentMode == CommandPaletteMode::ActionMode && listViewItem)\n+        {\n+            const auto enteredItem = listViewItem.Content();\n+            if (const auto filteredCommand{ enteredItem.try_as<winrt::TerminalApp::FilteredCommand>() })\n+            {\n+                if (const auto actionPaletteItem{ filteredCommand.Item().try_as<winrt::TerminalApp::ActionPaletteItem>() })\n+                {\n+                    // immediately preview the hovered command\n+                    PreviewAction.raise(*this, actionPaletteItem.Command());\n+                }\n+            }\n+        }\n+    }\n+\n+    // Method Description:\n+    // - This event is called when the user's mouse pointer exits an individual\n+    //   item from the list. We then revert to previewing the selected item rather\n+    //   than the hovered one, using a short delay (via a DispatcherTimer) to smooth\n+    //   transitions when rapidly moving between items.\n+    //\n+    // Arguments:\n+    // - <none>\n+    // Return Value:\n+    // - <none>\n+    void CommandPalette::_listItemPointerExited(const winrt::Windows::Foundation::IInspectable& /*sender*/,\n+                                                const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& /*args*/)\n+    {\n+        // if there is no exit timer, create one\n+        if (!_pointerExitTimer)\n+        {\n+            _pointerExitTimer = winrt::Windows::UI::Xaml::DispatcherTimer();\n+            _pointerExitTimer.Interval(std::chrono::milliseconds(10));\n+            _pointerExitTimer.Tick([this](auto const&, auto const&) {\n+                // when the timer ticks, revert the preview to the selected command\n+                const auto selectedCommand = _filteredActionsView().SelectedItem();\n+                if (const auto filteredCommand{ selectedCommand.try_as<winrt::TerminalApp::FilteredCommand>() })\n+                {\n+                    if (_currentMode == CommandPaletteMode::ActionMode && filteredCommand)\n+                    {\n+                        if (const auto actionPaletteItem{ filteredCommand.Item().try_as<winrt::TerminalApp::ActionPaletteItem>() })\n+                        {\n+                            PreviewAction.raise(*this, actionPaletteItem.Command());\n+                        }\n+                    }\n+                }\n+                _pointerExitTimer.Stop();\n+            });\n+        }\n+\n+        // restart the timer\n+        _pointerExitTimer.Start();\n+    }\n+\n     void CommandPalette::_listItemSelectionChanged(const Windows::Foundation::IInspectable& /*sender*/, const Windows::UI::Xaml::Controls::SelectionChangedEventArgs& e)\n     {\n         // We don't care about...\n@@ -1214,6 +1287,9 @@ namespace winrt::TerminalApp::implementation\n \n         ParentCommandName(L\"\");\n         _currentNestedCommands.Clear();\n+\n+        // revert any preview\n+        _filteredActionsView().SelectedIndex(-1);\n         PreviewAction.raise(*this, nullptr);\n     }\n \n@@ -1306,6 +1382,10 @@ namespace winrt::TerminalApp::implementation\n         else\n         {\n             itemContainer.DataContext(args.Item());\n+\n+            // attach the pointer event handlers to the container\n+            itemContainer.PointerEntered({ this, &CommandPalette::_listItemPointerEntered });\n+            itemContainer.PointerExited({ this, &CommandPalette::_listItemPointerExited });\n         }\n     }\n \ndiff --git a/src/cascadia/TerminalApp/CommandPalette.h b/src/cascadia/TerminalApp/CommandPalette.h\nindex 58e34bb1f90..0da7ee13344 100644\n--- a/src/cascadia/TerminalApp/CommandPalette.h\n+++ b/src/cascadia/TerminalApp/CommandPalette.h\n@@ -78,6 +78,8 @@ namespace winrt::TerminalApp::implementation\n \n         Windows::Foundation::Collections::IVector<winrt::TerminalApp::FilteredCommand> _commandsToFilter();\n \n+        winrt::Windows::UI::Xaml::DispatcherTimer _pointerExitTimer{ nullptr }; // timer to debounce pointer exit events (used to smooth preview transitions)\n+\n         bool _lastFilterTextWasEmpty{ true };\n \n         void _populateCommands();\n@@ -103,6 +105,10 @@ namespace winrt::TerminalApp::implementation\n \n         void _listItemClicked(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Controls::ItemClickEventArgs& e);\n \n+        void _listItemPointerEntered(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::PointerRoutedEventArgs& args);\n+\n+        void _listItemPointerExited(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::Input::PointerRoutedEventArgs& args);\n+\n         void _listItemSelectionChanged(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Controls::SelectionChangedEventArgs& e);\n \n         void _moveBackButtonClicked(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs&);\n", "instance_id": "microsoft__terminal-18518", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the desired feature: a quality-of-life improvement where hovering over a color scheme in the command palette should trigger a preview, similar to what happens with arrow key navigation. The goal is well-defined, and the context (CTRL + SHIFT + P to access \"Select color scheme...\") is provided. However, there are minor ambiguities and missing details. For instance, the statement does not specify how long the preview should persist after the mouse leaves the item, nor does it address potential edge cases like rapid mouse movements or interactions with other UI elements. Additionally, there are no explicit constraints or requirements for performance or compatibility with existing features. While the intent is clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of code changes is relatively limited, primarily affecting a single file (`CommandPalette.cpp`) with additions to handle mouse hover events (`PointerEntered` and `PointerExited`) and a minor update to the header file (`CommandPalette.h`). The changes involve around 70-80 lines of new code, which is moderate but focused. Second, the technical concepts required are straightforward: understanding event handling in the Windows UI XAML framework, working with timers for debouncing (using `DispatcherTimer`), and interacting with existing command preview logic. These are not overly complex for someone familiar with C++ and UI programming. Third, the problem does not appear to impact the broader system architecture, as it is a localized UI enhancement. However, there is some complexity in handling the preview transitions smoothly (via a timer to debounce rapid hover changes), which adds a slight challenge. Edge cases, such as rapid mouse movements or ensuring the preview reverts correctly, are implicitly present but not overly intricate to address. Overall, this task requires understanding specific UI event logic and making targeted modifications, but it does not demand deep architectural changes or advanced technical expertise, justifying a score of 0.35.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Crash when switching back from the alt buffer\n### Windows Terminal version\n\nCommit edfa3ea0f0080eadf7f01b463ed0a8638de6ce04\n\n### Windows build number\n\n10.0.19045.4651\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nIt's not easy to reproduce, but I think all you really need to trigger the crash is to switch to the alt buffer with `printf \"\\e[?1049h\"`, and then switch back to the main buffer with `printf \"\\e[?1049l\"`.\r\n\r\nThis is in Windows Terminal using a build that includes the new VT passthrough (PR #17510).\n\n### Expected Behavior\n\nThe terminal should not crash.\n\n### Actual Behavior\n\nI got an access violation accessing the `screenInfo` parameter in the `WriteCharsVT` function here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/host/_stream.cpp#L353\r\n\r\nWhat happens is that we first pass the `\\e[?1049l` sequence through to conhost in the `stateMachine.ProcessString` call a couple of lines above. That ends up calling `SCREEN_INFORMATION::UseMainScreenBuffer`, which calls `s_RemoveScreenBuffer(psiAlt)`, which deletes the active `screenInfo` instance here:\r\n\r\nhttps://github.com/microsoft/terminal/blob/0199ca33ddb4a02ca3549627d772ce6b330ed1ce/src/host/screenInfo.cpp#L231\r\n\r\nThat's the same `screenInfo` instance that was passed to our `WriteCharsVT` function, so when we later try to reference that, we're referencing a deleted object. Sometimes we get lucky and nothing bad happens, but sometimes it will crash.\r\n\r\nI think maybe all we need to do to prevent the crash is to save the `screenInfo.OutputMode` at the start of the function, and then use that saved value instead of trying to look it up via the `screenInfo` object.\n", "patch": "diff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex e434e413ebd..82dda40ef9b 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -336,6 +336,9 @@ void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\n {\r\n     auto& gci = ServiceLocator::LocateGlobals().getConsoleInformation();\r\n     auto& stateMachine = screenInfo.GetStateMachine();\r\n+    // If the given screenInfo is the alternate screen buffer, disabling the alternate screen buffer in this\r\n+    // VT payload will cause the pointer to be invalidated. We thus need to get all the information we need now.\r\n+    const auto disableNewlineTranslation = WI_IsFlagSet(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN);\r\n     // When switch between the main and alt-buffer SCREEN_INFORMATION::GetActiveBuffer()\r\n     // may change, so get the VtIo reference now, just in case.\r\n     auto writer = gci.GetVtWriterForBuffer(&screenInfo);\r\n@@ -350,7 +353,7 @@ void WriteCharsVT(SCREEN_INFORMATION& screenInfo, const std::wstring_view& str)\n         // DISABLE_NEWLINE_AUTO_RETURN not being set is equivalent to a LF -> CRLF translation.\r\n         const auto write = [&](size_t beg, size_t end) {\r\n             const auto chunk = til::safe_slice_abs(str, beg, end);\r\n-            if (WI_IsFlagSet(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n+            if (disableNewlineTranslation)\r\n             {\r\n                 writer.WriteUTF16(chunk);\r\n             }\r\n", "instance_id": "microsoft__terminal-17748", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash occurs when switching between the main and alternate screen buffers in Windows Terminal due to accessing a deleted `screenInfo` object. The steps to reproduce are provided, though they are noted as not easy to replicate consistently, which introduces some ambiguity. The expected and actual behaviors are clearly stated, and the root cause of the crash is well-explained with references to specific lines of code in the repository. However, there are minor details missing, such as specific conditions or edge cases under which the crash is more likely to occur, and the problem statement does not explicitly discuss constraints or additional requirements for the fix. Overall, it is clear enough to understand the issue and propose a solution, but it lacks comprehensive detail on edge cases or broader implications.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is localized to a single function (`WriteCharsVT`) in a single file (`_stream.cpp`). The modification involves a small number of lines (adding a variable to store a value upfront and using it later), and it does not impact the broader system architecture or require changes across multiple modules. The fix is straightforward and does not necessitate deep refactoring.\n\n2. **Technical Concepts Involved**: Solving this problem requires understanding basic C++ concepts such as pointers, object lifetimes, and memory management (specifically, avoiding access to deleted objects). It also involves familiarity with the Windows Terminal codebase's handling of screen buffers and VT sequences. However, these concepts are not particularly advanced for a senior engineer, and the fix does not require complex algorithms, design patterns, or domain-specific knowledge beyond the terminal emulation context.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention additional edge cases beyond the crash scenario described. The code change addresses the primary issue (accessing a deleted object) by caching a value upfront, and no additional error handling logic is introduced or required in the provided diff. While there might be implicit edge cases related to buffer switching or VT sequence processing, they are not discussed or addressed in the solution, keeping the complexity low.\n\n4. **Overall Complexity**: The problem requires understanding a specific bug related to object lifetime in a multi-buffer terminal environment, but the solution is a simple mitigation (caching a value). It does not demand deep architectural changes or extensive debugging beyond identifying the root cause, which is already provided in the problem statement.\n\nGiven these factors, a difficulty score of 0.35 reflects an \"Easy\" problem that requires some understanding of the codebase and logic but involves a minimal and targeted code change with low risk of broader impact.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Window layout persisted in `state.json` even if window persistence not enabled\n### Windows Terminal version\n\n1.20.11215.0\n\n### Windows build number\n\n10.0.22631.3447\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Ensure window persistence is turned off\r\n2. Set windows terminal as your default terminal application\r\n3. Go to run and type `cmd /k echo hello world`\r\n4. Close the terminal\r\n5. Inspect `%LOCALAPPDATA%\\Packages\\Microsoft.WindowsTerminalPreview_8wekyb3d8bbwe\\LocalState\\state.json`\n\n### Expected Behavior\n\nThere is no history of the command that I ran in `state.json`.\n\n### Actual Behavior\n\n`state.json` has leaked my super secret command line invocation!\r\n\r\n```json\r\n{\r\n  \"persistedWindowLayouts\" : \r\n  [\r\n    {\r\n      \"initialPosition\" : \"234,234\",\r\n      \"initialSize\" : \r\n      {\r\n        \"height\" : 436.0,\r\n        \"width\" : 873.0\r\n      },\r\n      \"launchMode\" : \"default\",\r\n      \"tabLayout\" : \r\n      [\r\n        {\r\n          \"action\" : \"newTab\",\r\n          \"commandline\" : \"\\\"C:\\\\WINDOWS\\\\system32\\\\cmd.exe\\\" /k echo hello world\",\r\n          \"profile\" : \"Command Prompt\",\r\n          \"startingDirectory\" : \"C:\\\\Users\\\\Ian\",\r\n          \"suppressApplicationTitle\" : false,\r\n          \"tabTitle\" : \"C:\\\\WINDOWS\\\\system32\\\\cmd.exe\"\r\n        }\r\n      ]\r\n    }\r\n  ],\r\n  \"settingsHash\" : \"190f05f1cd1315b4-01d98faa8aecd332\"\r\n}\r\n```\r\n\r\nThis is not reproducible on version 1.19.11213.0.\n", "patch": "diff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 749fd2e842c..c04a34affc9 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -263,7 +263,7 @@ namespace winrt::TerminalApp::implementation\n         AppLogic::Current()->NotifyRootInitialized();\r\n     }\r\n \r\n-    void TerminalWindow::Quit()\r\n+    void TerminalWindow::PersistState()\r\n     {\r\n         if (_root)\r\n         {\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex b10c29a8d72..40e94a39201 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -73,7 +73,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         void Create();\r\n \r\n-        void Quit();\r\n+        void PersistState();\r\n \r\n         winrt::fire_and_forget UpdateSettings(winrt::TerminalApp::SettingsLoadEventArgs args);\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 75c47fce8bf..2cf4b317298 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -61,7 +61,7 @@ namespace TerminalApp\n         Boolean ShouldImmediatelyHandoffToElevated();\r\n         void HandoffToElevated();\r\n \r\n-        void Quit();\r\n+        void PersistState();\r\n \r\n         Windows.UI.Xaml.UIElement GetRoot();\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex 94585f4391c..63d8de231d3 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -1184,13 +1184,16 @@ winrt::fire_and_forget AppHost::_QuitRequested(const winrt::Windows::Foundation:\n     co_await wil::resume_foreground(_windowLogic.GetRoot().Dispatcher());\r\n \r\n     const auto strongThis = weakThis.lock();\r\n-    // GH #16235: If we don't have a window logic, we're already refrigerating, and won't have our _window either.\r\n-    if (!strongThis || _windowLogic == nullptr)\r\n+    if (!strongThis)\r\n     {\r\n         co_return;\r\n     }\r\n \r\n-    _windowLogic.Quit();\r\n+    if (_appLogic && _windowLogic && _appLogic.ShouldUsePersistedLayout())\r\n+    {\r\n+        _windowLogic.PersistState();\r\n+    }\r\n+\r\n     PostQuitMessage(0);\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex a8f0961e420..1e78e721fd4 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -348,6 +348,14 @@ void WindowEmperor::_becomeMonarch()\n \r\n     _revokers.WindowCreated = _manager.WindowCreated(winrt::auto_revoke, { this, &WindowEmperor::_numberOfWindowsChanged });\r\n     _revokers.WindowClosed = _manager.WindowClosed(winrt::auto_revoke, { this, &WindowEmperor::_numberOfWindowsChanged });\r\n+\r\n+    // If a previous session of Windows Terminal stored buffer_*.txt files, then we need to clean all those up on exit\r\n+    // that aren't needed anymore, even if the user disabled the ShouldUsePersistedLayout() setting in the meantime.\r\n+    {\r\n+        const auto state = ApplicationState::SharedInstance();\r\n+        const auto layouts = state.PersistedWindowLayouts();\r\n+        _requiresPersistenceCleanupOnExit = layouts && layouts.Size() > 0;\r\n+    }\r\n }\r\n \r\n // sender and args are always nullptr\r\n@@ -486,7 +494,7 @@ void WindowEmperor::_finalizeSessionPersistence() const\n     // Ensure to write the state.json before we TerminateProcess()\r\n     state.Flush();\r\n \r\n-    if (!_app.Logic().ShouldUsePersistedLayout())\r\n+    if (!_requiresPersistenceCleanupOnExit)\r\n     {\r\n         return;\r\n     }\r\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.h b/src/cascadia/WindowsTerminal/WindowEmperor.h\nindex a35032e6d5e..d4186cbbb06 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.h\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.h\n@@ -51,6 +51,7 @@ class WindowEmperor : public std::enable_shared_from_this<WindowEmperor>\n \r\n     std::unique_ptr<NotificationIcon> _notificationIcon;\r\n \r\n+    bool _requiresPersistenceCleanupOnExit = false;\r\n     bool _quitting{ false };\r\n \r\n     void _windowStartedHandlerPostXAML(const std::shared_ptr<WindowThread>& sender);\r\n", "instance_id": "microsoft__terminal-17211", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Windows Terminal persists window layout information in `state.json` even when window persistence is disabled, which is a privacy concern as it leaks command-line invocations. The steps to reproduce are detailed, and the expected versus actual behavior is explicitly stated with a JSON snippet showing the leaked data. However, there are minor ambiguities, such as the lack of explicit mention of specific edge cases (e.g., different terminal configurations or user settings) and no detailed constraints or requirements for the fix (e.g., performance considerations or backward compatibility). Additionally, the problem statement does not clarify whether this issue affects all commands or only specific ones like `cmd /k`. Despite these minor gaps, the core issue and goal are well-defined, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes spans multiple files (`TerminalWindow.cpp`, `TerminalWindow.h`, `TerminalWindow.idl`, `AppHost.cpp`, `WindowEmperor.cpp`, and `WindowEmperor.h`), indicating a need to understand interactions between different components of the Windows Terminal codebase, such as window management, application logic, and state persistence. The changes involve renaming a method (`Quit` to `PersistState`) and adding conditional logic to check if persistence is enabled before saving state, which requires a moderate understanding of the system's architecture. \n\nSecond, the technical concepts involved include familiarity with C++ (specifically WinRT and Windows-specific APIs), application state management, and configuration settings. While these are not overly complex for an experienced developer, they do require specific domain knowledge of the Windows Terminal's internals and how settings are propagated through the system.\n\nThird, the problem does not explicitly mention edge cases in the statement, but the code changes suggest considerations like ensuring persistence cleanup happens only when necessary (`_requiresPersistenceCleanupOnExit`) and handling scenarios where previous layouts exist. Error handling modifications are minimal, as the changes focus on conditional logic rather than introducing new error paths.\n\nOverall, the task requires understanding multiple parts of the codebase and making targeted but non-trivial modifications. It does not significantly impact the system's architecture or require advanced algorithms, but it is more involved than a simple bug fix due to the cross-file changes and conditional logic. Hence, a difficulty score of 0.55 is appropriate, placing it in the medium range with a slight lean towards the higher end due to the need for domain-specific knowledge.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[BUG] - Crash when dragging/dropping a dock source item in non-manual mode.\n**Describe the bug**\r\nAn item can still be dragged in non-manual docks, which causes OBS to crash.\r\n\r\n**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Create a new dynamic or search dock.\r\n2. Make sure it is populated with items.\r\n3. Drag an item up or down and release.\r\n4. Crash.\r\n\r\n**Expected behavior**\r\nDynamic and search docks should not have any ability to drag/reorder items, and should not crash if an item is accidentally dragged.\r\n\r\n**Additional context**\r\nNeed to disable drag/drop functionality for non-manual docks.\n", "patch": "diff --git a/src/quick-access-dock.cpp b/src/quick-access-dock.cpp\nindex 9c2cb10..95e6f91 100644\n--- a/src/quick-access-dock.cpp\n+++ b/src/quick-access-dock.cpp\n@@ -22,6 +22,7 @@ QuickAccessDock::QuickAccessDock(QWidget *parent, obs_data_t *obsData)\n \t_clickableScenes = obs_data_get_bool(obsData, \"clickable_scenes\");\n \n \t_widget = new QuickAccess(this, this, \"quick_access_widget\");\n+\tsetMinimumWidth(200);\n \tauto l = new QVBoxLayout;\n \tl->setContentsMargins(0, 0, 0, 0);\n \tl->addWidget(_widget);\ndiff --git a/src/quick-access.cpp b/src/quick-access.cpp\nindex 123c487..4831281 100644\n--- a/src/quick-access.cpp\n+++ b/src/quick-access.cpp\n@@ -77,57 +77,47 @@ QuickAccessItem::QuickAccessItem(QWidget *parent, QuickAccessDock *dock,\n \tlayout->addSpacing(2);\n \tlayout->addWidget(_label);\n \n-\t_actionsToolbar = new QToolBar(this);\n-\t_actionsToolbar->setObjectName(QStringLiteral(\"actionsToolbar\"));\n-\t_actionsToolbar->setIconSize(QSize(16, 16));\n-\t_actionsToolbar->setFixedHeight(22);\n-\t_actionsToolbar->setStyleSheet(\"QToolBar{spacing: 0px;}\");\n-\t_actionsToolbar->setFloatable(false);\n-\t_actionsToolbar->setSizePolicy(QSizePolicy::Maximum,\n-\t\t\t\t       QSizePolicy::Maximum);\n-\t_actionsToolbar->setStyleSheet(\n-\t\t\"QToolButton {padding: 0px; margin-left: 2px; margin-right: 2px;}\");\n-\n-\t_actionProperties = new QAction(this);\n-\t_actionProperties->setObjectName(QStringLiteral(\"actionProperties\"));\n+\t_actionProperties = new QPushButton();\n \t_actionProperties->setProperty(\"themeID\", \"propertiesIconSmall\");\n-\t_actionProperties->setText(QT_UTF8(obs_module_text(\"Properties\")));\n-\tconnect(_actionProperties, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionProperties_triggered()));\n-\t_actionsToolbar->addAction(_actionProperties);\n-\n-\t_actionFilters = new QAction(this);\n-\t_actionFilters->setObjectName(QStringLiteral(\"actionFilters\"));\n-\t_actionFilters->setShortcutContext(Qt::WidgetWithChildrenShortcut);\n+\t_actionProperties->setDisabled(false);\n+\t_actionProperties->setAccessibleDescription(\n+\t\t\"Opens the source properties window.\");\n+\t_actionProperties->setAccessibleName(\"Open Source Properties\");\n+\t_actionProperties->setToolTip(\"Open Source Properties\");\n+\t_actionProperties->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionProperties, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionProperties_triggered);\n+\n+\t_actionFilters = new QPushButton();\n \t_actionFilters->setProperty(\"themeID\", \"filtersIcon\");\n-\t_actionFilters->setText(QT_UTF8(obs_module_text(\"Filters\")));\n-\tconnect(_actionFilters, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionFilters_triggered()));\n-\t_actionsToolbar->addAction(_actionFilters);\n-\n-\t_actionScenes = new QAction(this);\n-\t_actionScenes->setObjectName(QStringLiteral(\"actionScenes\"));\n-\t_actionScenes->setShortcutContext(Qt::WidgetWithChildrenShortcut);\n+\t_actionFilters->setDisabled(false);\n+\t_actionFilters->setAccessibleDescription(\n+\t\t\"Opens the source filters window.\");\n+\t_actionFilters->setAccessibleName(\"Open Source Filters\");\n+\t_actionFilters->setToolTip(\"Open Source Filters\");\n+\t_actionFilters->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionFilters, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionFilters_triggered);\n+\n+\t_actionScenes = new QPushButton();\n \tQIcon sceneIcon;\n \tsceneIcon = qau->GetSceneIcon();\n \t_actionScenes->setIcon(sceneIcon);\n-\t_actionScenes->setText(QT_UTF8(obs_module_text(\"Scenes\")));\n-\tconnect(_actionScenes, SIGNAL(triggered()), this,\n-\t\tSLOT(on_actionScenes_triggered()));\n-\t_actionsToolbar->addAction(_actionScenes);\n-\n-\tSetButtonVisibility();\n+\t_actionScenes->setDisabled(false);\n+\t_actionScenes->setAccessibleDescription(\n+\t\t\"Opens list of all parent scenes\");\n+\t_actionScenes->setAccessibleName(\"Show Parent Scenes\");\n+\t_actionScenes->setToolTip(\"Show Parent Scenes\");\n+\t_actionScenes->setStyleSheet(\"padding: 0px; background: none\");\n+\tconnect(_actionScenes, &QPushButton::released, this,\n+\t\t&QuickAccessItem::on_actionScenes_triggered);\n+\n+\tlayout->addWidget(_actionProperties);\n+\tlayout->addWidget(_actionFilters);\n+\tlayout->addWidget(_actionScenes);\n \n-\t// Themes need the QAction dynamic properties\n-\tfor (QAction *x : _actionsToolbar->actions()) {\n-\t\tQWidget *temp = _actionsToolbar->widgetForAction(x);\n-\n-\t\tfor (QByteArray &y : x->dynamicPropertyNames()) {\n-\t\t\ttemp->setProperty(y, x->property(y));\n-\t\t}\n-\t}\n-\tlayout->addWidget(_actionsToolbar);\n \tsetLayout(layout);\n+\tSetButtonVisibility();\n }\n \n void QuickAccessItem::SetButtonVisibility()\n@@ -135,17 +125,6 @@ void QuickAccessItem::SetButtonVisibility()\n \t_actionProperties->setVisible(_configurable && _dock->ShowProperties());\n \t_actionFilters->setVisible(_dock->ShowFilters());\n \t_actionScenes->setVisible(_dock->ShowScenes());\n-\n-\t// Refresh Toolbar Styling\n-\tfor (auto x : _actionsToolbar->actions()) {\n-\t\tauto widget = _actionsToolbar->widgetForAction(x);\n-\n-\t\tif (!widget) {\n-\t\t\tcontinue;\n-\t\t}\n-\t\twidget->style()->unpolish(widget);\n-\t\twidget->style()->polish(widget);\n-\t}\n }\n \n const char *QuickAccessItem::GetSourceName()\n@@ -160,7 +139,9 @@ QuickAccessItem::~QuickAccessItem()\n {\n \tdelete _label;\n \tdelete _iconLabel;\n-\tdelete _actionsToolbar;\n+\tdelete _actionProperties;\n+\tdelete _actionFilters;\n+\tdelete _actionScenes;\n \t_clearSceneItems();\n \tobs_weak_source_release(_source);\n }\n@@ -352,9 +333,16 @@ QuickAccess::QuickAccess(QWidget *parent, QuickAccessDock *dock, QString name)\n \t_sourceList->setFrameShape(QFrame::NoFrame);\n \t_sourceList->setFrameShadow(QFrame::Plain);\n \t_sourceList->setProperty(\"showDropIndicator\", QVariant(true));\n-\t_sourceList->setDragEnabled(_dock->GetType() == \"Manual\");\n-\t_sourceList->setDragDropMode(QAbstractItemView::InternalMove);\n-\t_sourceList->setDefaultDropAction(Qt::TargetMoveAction);\n+\tif (_dock->GetType() == \"Manual\") {\n+\t\t_sourceList->setDragEnabled(true);\n+\t\t_sourceList->setDragDropMode(QAbstractItemView::InternalMove);\n+\t\t_sourceList->setDefaultDropAction(Qt::TargetMoveAction);\n+\t} else {\n+\t\t_sourceList->setDragEnabled(false);\n+\t\t_sourceList->setDragDropMode(QAbstractItemView::NoDragDrop);\n+\t\t_sourceList->viewport()->setAcceptDrops(false);\n+\t}\n+\n \tconnect(_sourceList, SIGNAL(itemSelectionChanged()), this,\n \t\tSLOT(on_sourceList_itemSelectionChanged()));\n \ndiff --git a/src/quick-access.hpp b/src/quick-access.hpp\nindex 073bfa8..3fb49ea 100644\n--- a/src/quick-access.hpp\n+++ b/src/quick-access.hpp\n@@ -72,10 +72,9 @@ class QuickAccessItem : public QFrame {\n \tQLabel *_label = nullptr;\n \tQLabel *_iconLabel = nullptr;\n \n-\tQToolBar *_actionsToolbar = nullptr;\n-\tQAction *_actionProperties = nullptr;\n-\tQAction *_actionFilters = nullptr;\n-\tQAction *_actionScenes = nullptr;\n+\tQPushButton *_actionProperties = nullptr;\n+\tQPushButton *_actionFilters = nullptr;\n+\tQPushButton *_actionScenes = nullptr;\n \n \tQPushButton *_filters = nullptr;\n \tobs_weak_source_t *_source = nullptr;\n", "instance_id": "FiniteSingularity__obs-quick-access-utility-16", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a valid description of the bug, including steps to reproduce and the expected behavior. It identifies the issue (crash when dragging/dropping items in non-manual docks) and specifies the goal (disable drag/drop functionality for non-manual docks). However, there are minor ambiguities and missing details. For instance, it does not explicitly mention whether there are specific types of non-manual docks (beyond dynamic and search docks) that need to be considered, nor does it discuss potential edge cases or constraints related to disabling drag/drop functionality. Additionally, there is no mention of whether this change might affect other parts of the application or user experience beyond preventing the crash. Despite these minor gaps, the problem statement is actionable and provides enough context to understand the issue and the desired outcome.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are relatively localized, primarily affecting the `quick-access.cpp` file with modifications to the drag/drop behavior of the `QAbstractItemView` in the `QuickAccess` class. Additional changes in UI elements (e.g., replacing `QAction` with `QPushButton` for toolbar actions) appear to be incidental or part of a broader refactoring but are not directly related to the core bug fix. The changes do not impact the broader system architecture and are confined to a specific module. The amount of code change is moderate, involving conditional logic for drag/drop settings and some UI refactoring.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of Qt framework concepts, specifically `QAbstractItemView` and its drag/drop properties (`setDragEnabled`, `setDragDropMode`, `viewport()->setAcceptDrops`). These are standard features of Qt, and the logic to disable drag/drop based on the dock type is straightforward. No advanced algorithms, design patterns, or domain-specific knowledge are required beyond familiarity with Qt's UI components.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes suggest a simple binary condition (manual vs. non-manual docks) for enabling/disabling drag/drop. There is no indication of complex error handling or unforeseen interactions with other parts of the system. However, a developer might need to consider whether disabling drag/drop could affect other functionalities or user interactions, though this is not explicitly required by the problem statement.\n\n4. **Overall Complexity:** The core fix (disabling drag/drop for non-manual docks) is a simple conditional modification that does not require deep understanding of the broader codebase. The incidental UI refactoring (e.g., changing `QAction` to `QPushButton`) adds some complexity but is still within the realm of basic UI programming tasks. There are no performance considerations or intricate logic involved.\n\nGiven these factors, a difficulty score of 0.35 reflects an \"Easy\" problem that requires understanding some code logic and making straightforward modifications. It is slightly above the lower end of the range due to the need for familiarity with Qt's drag/drop API and the moderate scope of UI-related changes, but it does not approach the complexity of a \"Medium\" difficulty problem.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`window.showSaveFilePicker()` shows warning in file picker UI\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n35.0.1, 36.0.0-alpha.2\n\n### What operating system(s) are you using?\n\nmacOS\n\n### Operating System Version\n\nmacOS Sequioa 15.3.1\n\n### What arch are you using?\n\narm64 (including Apple Silicon)\n\n### Last Known Working Electron version\n\n29.4.6\n\n### Expected Behavior\n\nIf I open a file picker with `window.showSaveFilePicker()`, it shows the standard file picker without any extra warnings.\n\nIn the context of an Electron app, I'd expect my app not to be referred to as a \"site\".\n\nAdditionally, in the context of a desktop app, a user expects the app to be able to continuously access files they select through a file picker. Warning them about that is unnecessary.\n\n### Actual Behavior\n\nThe file picker contains an ugly warning: \"Warning: this site can see edits you make\"\n\n![Screenshot](https://github.com/user-attachments/assets/b369517c-e6c3-480d-82b5-405b4abc38bb)\n\n### Testcase Gist URL\n\nhttps://gist.github.com/11316fce28ba719ce8446fb85955d50c\n\n### Additional Information\n\n_No response_\n", "patch": "diff --git a/shell/browser/file_system_access/file_system_access_permission_context.cc b/shell/browser/file_system_access/file_system_access_permission_context.cc\nindex 9f4b43645332b..865fa06f19bac 100644\n--- a/shell/browser/file_system_access/file_system_access_permission_context.cc\n+++ b/shell/browser/file_system_access/file_system_access_permission_context.cc\n@@ -825,13 +825,7 @@ std::u16string FileSystemAccessPermissionContext::GetPickerTitle(\n               ? IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_WRITABLE_DIRECTORY_TITLE\n               : IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_READABLE_DIRECTORY_TITLE);\n       break;\n-    case blink::mojom::TypeSpecificFilePickerOptionsUnion::Tag::\n-        kSaveFilePickerOptions:\n-      title = l10n_util::GetStringUTF16(\n-          IDS_FILE_SYSTEM_ACCESS_CHOOSER_OPEN_SAVE_FILE_TITLE);\n-      break;\n-    case blink::mojom::TypeSpecificFilePickerOptionsUnion::Tag::\n-        kOpenFilePickerOptions:\n+    default:\n       break;\n   }\n   return title;\n", "instance_id": "electron__electron-46067", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `window.showSaveFilePicker()` method in Electron displays an unnecessary and misleading warning in the file picker UI on macOS. The expected behavior (no warning) and actual behavior (warning displayed) are explicitly stated, along with relevant context such as Electron versions affected and a screenshot for visual reference. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this warning appears under specific conditions (e.g., certain file types or permissions) or if it is consistent across all uses of the API. Additionally, while the test case gist is provided, it is not embedded or summarized in the statement, requiring extra effort to understand the full scope. Edge cases or potential side effects of removing the warning are also not discussed, which could be critical for a complete understanding of the issue. Overall, the statement is valid and clear but lacks some minor details for full comprehensiveness.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, as it involves modifying a single file (`file_system_access_permission_context.cc`) with a small diff that removes specific logic for setting a title for the save file picker. This suggests the fix is localized and does not impact the broader architecture or multiple modules of the Electron codebase. Second, the technical concepts required to solve this are relatively straightforward: understanding basic C++ syntax, familiarity with string localization (`l10n_util`), and a basic grasp of how Electron's file system access permissions are handled. No advanced algorithms, design patterns, or domain-specific knowledge beyond typical desktop app development are needed. Third, the problem does not explicitly mention complex edge cases or error handling requirements, and the code change itself does not introduce new error handling logic—it simply removes a specific title assignment. While there might be implicit considerations (e.g., ensuring the default title or UI behavior is still appropriate after removal), these are not complex. Overall, this task requires understanding some code logic and making a simple modification, aligning with an easy difficulty level of 0.25.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Use Writing Tools in macOS 15.1\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a feature request that matches the one I want to file, without success.\n\n### Problem Description\n\nAre there plans to support apple intelligence's [`Writing Tools`](https://developer.apple.com/documentation/updates/apple-intelligence/) in electron?\n\nThe option is available in Chromium (tested on v128). Digging through the source code I found [`render_view_context_menu_mac.mm`](https://github.com/chromium/chromium/blob/main/chrome/browser/ui/cocoa/renderer_context_menu/render_view_context_menu_mac.mm) and [`text_services_context_menu.mm`](https://github.com/chromium/chromium/blob/main/ui/menus/cocoa/text_services_context_menu.mm), but I'm honestly none the wiser how it's implemented 🫠\n\n![Image](https://github.com/user-attachments/assets/072e02db-f586-4502-b7e3-d2fc90d6c144)\n\n\n### Proposed Solution\n\n`Writing Tools` could be exposed as a context menu `role`, added to the menu only if it's available. \n\nAlso need to expose [`isWritingToolsActive`](https://developer.apple.com/documentation/appkit/nstextview/4431696-iswritingtoolsactive/) for UI/UX reasons, but I guess that can be of a lower priority.\n\n### Alternatives Considered\n\nnil\n\n### Additional Information\n\nRequirements to use apple intelligence:\n\n- macOS 15.1+\n- M-series Mac\n- [Enable apple intelligence in settings](https://support.apple.com/en-sg/guide/mac-help/mchl46361784/mac)\n", "patch": "diff --git a/docs/api/menu.md b/docs/api/menu.md\nindex b9a8a7b09e07f..949720dc0e8c8 100644\n--- a/docs/api/menu.md\n+++ b/docs/api/menu.md\n@@ -73,6 +73,8 @@ The `menu` object has the following instance methods:\n \n * `options` Object (optional)\n   * `window` [BaseWindow](base-window.md) (optional) - Default is the focused window.\n+  * `frame` [WebFrameMain](web-frame-main.md) (optional) - Provide the relevant frame\n+    if you want certain OS-level features such as Writing Tools on macOS to function correctly. Typically, this should be `params.frame` from the [`context-menu` event](web-contents.md#event-context-menu) on a WebContents.\n   * `x` number (optional) - Default is the current mouse cursor position.\n     Must be declared if `y` is declared.\n   * `y` number (optional) - Default is the current mouse cursor position.\ndiff --git a/lib/browser/api/menu.ts b/lib/browser/api/menu.ts\nindex c0244cc3c1bf2..8e0a63f764654 100644\n--- a/lib/browser/api/menu.ts\n+++ b/lib/browser/api/menu.ts\n@@ -93,7 +93,7 @@ Menu.prototype.popup = function (options = {}) {\n     }\n   }\n \n-  this.popupAt(window as unknown as BaseWindow, x, y, positioningItem, sourceType, callback);\n+  this.popupAt(window as unknown as BaseWindow, options.frame, x, y, positioningItem, sourceType, callback);\n   return { browserWindow: window, x, y, position: positioningItem };\n };\n \ndiff --git a/patches/chromium/.patches b/patches/chromium/.patches\nindex 6464dce67d2ee..ace5629450845 100644\n--- a/patches/chromium/.patches\n+++ b/patches/chromium/.patches\n@@ -135,6 +135,7 @@ fix_add_method_which_disables_headless_mode_on_native_widget.patch\n refactor_unfilter_unresponsive_events.patch\n build_disable_thin_lto_mac.patch\n build_add_public_config_simdutf_config.patch\n+fix_multiple_scopedpumpmessagesinprivatemodes_instances.patch\n revert_code_health_clean_up_stale_macwebcontentsocclusion.patch\n ignore_parse_errors_for_pkey_appusermodel_toastactivatorclsid.patch\n feat_add_signals_when_embedder_cleanup_callbacks_run_for.patch\ndiff --git a/patches/chromium/fix_multiple_scopedpumpmessagesinprivatemodes_instances.patch b/patches/chromium/fix_multiple_scopedpumpmessagesinprivatemodes_instances.patch\nnew file mode 100644\nindex 0000000000000..6605f24d7b15f\n--- /dev/null\n+++ b/patches/chromium/fix_multiple_scopedpumpmessagesinprivatemodes_instances.patch\n@@ -0,0 +1,51 @@\n+From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001\n+From: Calvin Watford <watfordcalvin@gmail.com>\n+Date: Wed, 5 Mar 2025 15:26:28 -0700\n+Subject: fix: multiple ScopedPumpMessagesInPrivateModes instances\n+\n+Context: When swapping `Menu.popup` to use `ui::ShowContextMenu`, we\n+found that its use of `ScopedPumpMessagesInPrivateModes` may potentially\n+be used multiple times simultaneously. This class was designed to work\n+with only one global instance.\n+\n+This patch adds a global reference count to keep track of\n+`ScopedPumpMessagesInPrivateModes` instances and gate its\n+enable/disable behavior on this reference count.\n+\n+diff --git a/base/message_loop/message_pump_apple.mm b/base/message_loop/message_pump_apple.mm\n+index 52ed68ac3150bdeef3c5032f3f5f7df3d5aaac51..1658aece3e8fbcef89944a849e311f7949a68de9 100644\n+--- a/base/message_loop/message_pump_apple.mm\n++++ b/base/message_loop/message_pump_apple.mm\n+@@ -760,20 +760,29 @@ explicit OptionalAutoreleasePool(MessagePumpCFRunLoopBase* pump) {\n+ \n+ #else\n+ \n++static int g_private_mode_ref_count = 0;\n++\n+ ScopedPumpMessagesInPrivateModes::ScopedPumpMessagesInPrivateModes() {\n+   DCHECK(g_app_pump);\n+-  DCHECK_EQ(kNSApplicationModalSafeModeMask, g_app_pump->GetModeMask());\n+   // Pumping events in private runloop modes is known to interact badly with\n+   // app modal windows like NSAlert.\n+   if (NSApp.modalWindow) {\n+     return;\n+   }\n+-  g_app_pump->SetModeMask(kAllModesMask);\n++\n++  g_private_mode_ref_count += 1;\n++  if (g_private_mode_ref_count == 1) {\n++    g_app_pump->SetModeMask(kAllModesMask);\n++  }\n+ }\n+ \n+ ScopedPumpMessagesInPrivateModes::~ScopedPumpMessagesInPrivateModes() {\n+   DCHECK(g_app_pump);\n+-  g_app_pump->SetModeMask(kNSApplicationModalSafeModeMask);\n++  DCHECK(g_private_mode_ref_count > 0);\n++  g_private_mode_ref_count -= 1;\n++  if (g_private_mode_ref_count == 0) {\n++    g_app_pump->SetModeMask(kNSApplicationModalSafeModeMask);\n++  }\n+ }\n+ \n+ int ScopedPumpMessagesInPrivateModes::GetModeMaskForTest() {\ndiff --git a/shell/browser/api/electron_api_menu.cc b/shell/browser/api/electron_api_menu.cc\nindex daef73495bf76..595a3513c499e 100644\n--- a/shell/browser/api/electron_api_menu.cc\n+++ b/shell/browser/api/electron_api_menu.cc\n@@ -7,6 +7,7 @@\n #include <utility>\n \n #include \"shell/browser/api/electron_api_base_window.h\"\n+#include \"shell/browser/api/electron_api_web_frame_main.h\"\n #include \"shell/browser/api/ui_event.h\"\n #include \"shell/browser/javascript_environment.h\"\n #include \"shell/browser/native_window.h\"\n@@ -16,6 +17,7 @@\n #include \"shell/common/gin_converters/file_path_converter.h\"\n #include \"shell/common/gin_converters/gurl_converter.h\"\n #include \"shell/common/gin_converters/image_converter.h\"\n+#include \"shell/common/gin_converters/optional_converter.h\"\n #include \"shell/common/gin_helper/dictionary.h\"\n #include \"shell/common/gin_helper/object_template_builder.h\"\n #include \"shell/common/node_includes.h\"\ndiff --git a/shell/browser/api/electron_api_menu.h b/shell/browser/api/electron_api_menu.h\nindex c861bd97a3e80..6b5ee0635da30 100644\n--- a/shell/browser/api/electron_api_menu.h\n+++ b/shell/browser/api/electron_api_menu.h\n@@ -22,6 +22,7 @@ class Arguments;\n namespace electron::api {\n \n class BaseWindow;\n+class WebFrameMain;\n \n class Menu : public gin::Wrappable<Menu>,\n              public gin_helper::EventEmitterMixin<Menu>,\n@@ -81,6 +82,7 @@ class Menu : public gin::Wrappable<Menu>,\n   void OnMenuWillShow(ui::SimpleMenuModel* source) override;\n \n   virtual void PopupAt(BaseWindow* window,\n+                       std::optional<WebFrameMain*> frame,\n                        int x,\n                        int y,\n                        int positioning_item,\ndiff --git a/shell/browser/api/electron_api_menu_mac.h b/shell/browser/api/electron_api_menu_mac.h\nindex 679bff8784568..f4d92f0840693 100644\n--- a/shell/browser/api/electron_api_menu_mac.h\n+++ b/shell/browser/api/electron_api_menu_mac.h\n@@ -13,6 +13,7 @@\n \n namespace electron {\n class NativeWindow;\n+class WebFrameMain;\n \n namespace api {\n \n@@ -23,12 +24,14 @@ class MenuMac : public Menu {\n \n   // Menu\n   void PopupAt(BaseWindow* window,\n+               std::optional<WebFrameMain*> frame,\n                int x,\n                int y,\n                int positioning_item,\n                ui::mojom::MenuSourceType source_type,\n                base::OnceClosure callback) override;\n   void PopupOnUI(const base::WeakPtr<NativeWindow>& native_window,\n+                 const base::WeakPtr<WebFrameMain>& frame,\n                  int32_t window_id,\n                  int x,\n                  int y,\ndiff --git a/shell/browser/api/electron_api_menu_mac.mm b/shell/browser/api/electron_api_menu_mac.mm\nindex 7ea23ffd91262..f5dffd4492e2b 100644\n--- a/shell/browser/api/electron_api_menu_mac.mm\n+++ b/shell/browser/api/electron_api_menu_mac.mm\n@@ -11,11 +11,15 @@\n #include \"base/strings/sys_string_conversions.h\"\n #include \"base/task/current_thread.h\"\n #include \"base/task/sequenced_task_runner.h\"\n+#include \"content/app_shim_remote_cocoa/render_widget_host_view_cocoa.h\"  // nogncheck\n+#include \"content/browser/renderer_host/render_widget_host_view_mac.h\"  // nogncheck\n #include \"content/public/browser/browser_task_traits.h\"\n #include \"shell/browser/api/electron_api_base_window.h\"\n+#include \"shell/browser/api/electron_api_web_frame_main.h\"\n #include \"shell/browser/native_window.h\"\n #include \"shell/common/keyboard_util.h\"\n #include \"shell/common/node_includes.h\"\n+#include \"ui/base/cocoa/menu_utils.h\"\n \n namespace {\n \n@@ -48,6 +52,7 @@\n MenuMac::~MenuMac() = default;\n \n void MenuMac::PopupAt(BaseWindow* window,\n+                      std::optional<WebFrameMain*> frame,\n                       int x,\n                       int y,\n                       int positioning_item,\n@@ -57,14 +62,19 @@\n   if (!native_window)\n     return;\n \n+  base::WeakPtr<WebFrameMain> weak_frame;\n+  if (frame && frame.value()) {\n+    weak_frame = frame.value()->GetWeakPtr();\n+  }\n+\n   // Make sure the Menu object would not be garbage-collected until the callback\n   // has run.\n   base::OnceClosure callback_with_ref = BindSelfToClosure(std::move(callback));\n \n-  auto popup =\n-      base::BindOnce(&MenuMac::PopupOnUI, weak_factory_.GetWeakPtr(),\n-                     native_window->GetWeakPtr(), window->weak_map_id(), x, y,\n-                     positioning_item, std::move(callback_with_ref));\n+  auto popup = base::BindOnce(&MenuMac::PopupOnUI, weak_factory_.GetWeakPtr(),\n+                              native_window->GetWeakPtr(), weak_frame,\n+                              window->weak_map_id(), x, y, positioning_item,\n+                              std::move(callback_with_ref));\n   base::SequencedTaskRunner::GetCurrentDefault()->PostTask(FROM_HERE,\n                                                            std::move(popup));\n }\n@@ -95,6 +105,7 @@\n }\n \n void MenuMac::PopupOnUI(const base::WeakPtr<NativeWindow>& native_window,\n+                        const base::WeakPtr<WebFrameMain>& frame,\n                         int32_t window_id,\n                         int x,\n                         int y,\n@@ -145,18 +156,27 @@\n     position.x = position.x - [menu size].width;\n \n   [popup_controllers_[window_id] setCloseCallback:std::move(close_callback)];\n-  // Make sure events can be pumped while the menu is up.\n-  base::CurrentThread::ScopedAllowApplicationTasksInNativeNestedLoop allow;\n-\n-  // One of the events that could be pumped is |window.close()|.\n-  // User-initiated event-tracking loops protect against this by\n-  // setting flags in -[CrApplication sendEvent:], but since\n-  // web-content menus are initiated by IPC message the setup has to\n-  // be done manually.\n-  base::mac::ScopedSendingEvent sendingEventScoper;\n-\n-  // Don't emit unresponsive event when showing menu.\n-  [menu popUpMenuPositioningItem:item atLocation:position inView:view];\n+\n+  if (frame && frame->render_frame_host()) {\n+    auto* rfh = frame->render_frame_host()->GetOutermostMainFrameOrEmbedder();\n+    if (rfh && rfh->IsRenderFrameLive()) {\n+      auto* rwhvm =\n+          static_cast<content::RenderWidgetHostViewMac*>(rfh->GetView());\n+      RenderWidgetHostViewCocoa* cocoa_view = rwhvm->GetInProcessNSView();\n+      view = cocoa_view;\n+    }\n+  }\n+\n+  NSEvent* dummy_event = [NSEvent mouseEventWithType:NSEventTypeRightMouseDown\n+                                            location:position\n+                                       modifierFlags:0\n+                                           timestamp:0\n+                                        windowNumber:nswindow.windowNumber\n+                                             context:nil\n+                                         eventNumber:0\n+                                          clickCount:1\n+                                            pressure:0];\n+  ui::ShowContextMenu(menu, dummy_event, view, true);\n }\n \n void MenuMac::ClosePopupAt(int32_t window_id) {\ndiff --git a/shell/browser/api/electron_api_menu_views.cc b/shell/browser/api/electron_api_menu_views.cc\nindex dd5a543c965c0..67aa94e77032a 100644\n--- a/shell/browser/api/electron_api_menu_views.cc\n+++ b/shell/browser/api/electron_api_menu_views.cc\n@@ -8,6 +8,7 @@\n #include <utility>\n \n #include \"shell/browser/api/electron_api_base_window.h\"\n+#include \"shell/browser/api/electron_api_web_frame_main.h\"\n #include \"shell/browser/native_window_views.h\"\n #include \"ui/display/screen.h\"\n \n@@ -20,6 +21,7 @@ MenuViews::MenuViews(gin::Arguments* args) : Menu(args) {}\n MenuViews::~MenuViews() = default;\n \n void MenuViews::PopupAt(BaseWindow* window,\n+                        std::optional<WebFrameMain*> frame,\n                         int x,\n                         int y,\n                         int positioning_item,\ndiff --git a/shell/browser/api/electron_api_menu_views.h b/shell/browser/api/electron_api_menu_views.h\nindex 7759f07a898dd..490d4229050f3 100644\n--- a/shell/browser/api/electron_api_menu_views.h\n+++ b/shell/browser/api/electron_api_menu_views.h\n@@ -22,6 +22,7 @@ class MenuViews : public Menu {\n  protected:\n   // Menu\n   void PopupAt(BaseWindow* window,\n+               std::optional<WebFrameMain*> frame,\n                int x,\n                int y,\n                int positioning_item,\ndiff --git a/shell/browser/api/electron_api_web_frame_main.h b/shell/browser/api/electron_api_web_frame_main.h\nindex ca5cc07e7d1fa..f62d75e0a8f69 100644\n--- a/shell/browser/api/electron_api_web_frame_main.h\n+++ b/shell/browser/api/electron_api_web_frame_main.h\n@@ -73,6 +73,10 @@ class WebFrameMain final : public gin::Wrappable<WebFrameMain>,\n \n   content::RenderFrameHost* render_frame_host() const;\n \n+  base::WeakPtr<WebFrameMain> GetWeakPtr() {\n+    return weak_factory_.GetWeakPtr();\n+  }\n+\n   // disable copy\n   WebFrameMain(const WebFrameMain&) = delete;\n   WebFrameMain& operator=(const WebFrameMain&) = delete;\ndiff --git a/typings/internal-electron.d.ts b/typings/internal-electron.d.ts\nindex f7338daa599e2..5d281261bb10d 100644\n--- a/typings/internal-electron.d.ts\n+++ b/typings/internal-electron.d.ts\n@@ -166,7 +166,7 @@ declare namespace Electron {\n     commandsMap: Record<string, MenuItem>;\n     groupsMap: Record<string, MenuItem[]>;\n     getItemCount(): number;\n-    popupAt(window: BaseWindow, x: number, y: number, positioning: number, sourceType: Required<Electron.PopupOptions>['sourceType'], callback: () => void): void;\n+    popupAt(window: BaseWindow, frame: WebFrameMain | undefined, x: number, y: number, positioning: number, sourceType: Required<Electron.PopupOptions>['sourceType'], callback: () => void): void;\n     closePopupAt(id: number): void;\n     setSublabel(index: number, label: string): void;\n     setToolTip(index: number, tooltip: string): void;\n", "instance_id": "electron__electron-45138", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "The problem statement is mostly clear in its intent to integrate Apple Intelligence's \"Writing Tools\" feature into the Electron framework, specifically as a context menu role on macOS 15.1+. The goal is defined (supporting Writing Tools), and there is a proposed solution (exposing it as a context menu role and adding an API for checking if it's active). Additionally, relevant constraints like OS version and hardware requirements (M-series Mac) are provided. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement lacks specifics on how the feature should behave in different scenarios (e.g., what happens if Apple Intelligence is not enabled or supported on the system?), and there are no explicit examples of expected input/output or UI behavior beyond a screenshot. Edge cases, such as handling unsupported macOS versions or non-M-series hardware at runtime, are not addressed. Overall, while the intent and high-level requirements are clear, these minor gaps in detail slightly reduce the clarity.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes is significant, spanning multiple files across the Electron codebase (e.g., menu.ts, electron_api_menu_mac.mm, and Chromium patches) and requiring modifications to both high-level API definitions and low-level macOS-specific implementations. This indicates a need to understand interactions between Electron's JavaScript layer, C++ bindings, and native macOS integration, as well as Chromium's internals for context menu handling. Second, the technical concepts involved are moderately complex, including macOS-specific APIs (e.g., NSEvent, ui::ShowContextMenu), Chromium's rendering and widget host architecture (e.g., RenderWidgetHostViewMac), and Electron's cross-platform menu system. Additionally, the patch to handle multiple ScopedPumpMessagesInPrivateModes instances introduces subtle concurrency and event-loop considerations, which require a deep understanding of macOS event handling and potential race conditions. Third, while edge cases are not explicitly mentioned in the problem statement, the code changes suggest the need to handle scenarios like missing or invalid WebFrameMain instances, unsupported hardware/OS versions, and ensuring proper event propagation for context menus. Finally, the impact on the system's architecture is non-trivial, as it modifies how context menus are displayed and interacts with native macOS features, potentially affecting other parts of the Electron framework. Overall, this problem requires a solid grasp of multiple layers of the stack, careful handling of platform-specific details, and significant code modifications, justifying a difficulty score of 0.75.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex e039b382e3e24..4c8452fad1a8d 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "instance_id": "electron__electron-41708", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Electron crashes when closing a notification in a portal environment with libnotify 0.8.3. It provides detailed context about the environment (Linux, specific Electron versions, and portal settings), expected behavior, actual behavior, and a step-by-step analysis of the crash's root cause. Additionally, it includes links to relevant code in the Electron repository and external libraries, as well as a minimal reproducible example (MRE). However, there are minor ambiguities: the problem statement does not explicitly define the desired fix or constraints for the solution (e.g., whether the fix must maintain compatibility with older libnotify versions or other environments). Edge cases, such as behavior in non-portal environments or with different libnotify versions, are not mentioned. Overall, while the issue is well-documented, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is relatively small, confined to a single class (`LibnotifyNotification`) in two files, with minimal lines of code modified (adding a boolean flag and adjusting function calls). However, the complexity lies in understanding the interaction between Electron's notification system and the external `libnotify` library, particularly its behavior in portal environments (e.g., Flatpak/Snap). This requires knowledge of GLib signals, dynamic library loading, and the specific changes in `libnotify` 0.8.x regarding portal support, which are non-trivial concepts. Additionally, the problem involves debugging a crash caused by a double-deletion issue, necessitating a deep understanding of object lifecycle management in C++ and the asynchronous nature of signal handling in GLib. While edge cases are not extensively detailed in the problem statement, the fix must ensure that it does not introduce regressions in other environments or with different library versions, adding a layer of complexity to testing and validation. The solution also impacts a critical user-facing feature (notifications), requiring careful consideration of user experience and stability. Overall, solving this requires a solid grasp of C++ memory management, third-party library integration, and Electron's notification architecture, making it a challenging but not extremely advanced problem.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "P2TR Spending Bug - Signing Transaction Failed\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nSome Segwit Version 1 Addresses generated with [Achow101's Rust-Vanitygen](https://github.com/achow101/rust-vanitygen), or more generally some random Addresses imported using the `tr(<WIF Private Key>)` Descriptor, cause an issue when spending coins using them. Generally, the \"Signing transaction failed\" error occurs and the transaction is not created. Though, a workaround still allows to spend the coins.\n\nI don't know if the issue is exclusive to P2TR, but never encountered such problems with Vanity Version 0 Addresses in the past... I also did not encounter such issue with P2TR Addresses directly generated in Bitcoin Core with `getnewaddress` or so.\n\nMaybe it is the same issue as #5828, which was however not been reported with a concrete and reproducible example, and was closed since long... If so, then it would mean that other Address Types may be affected as TapRoot did not exist at this time. I have not found other duplicates, but sorry if I missed one...\n\n### Expected behaviour\n\nBeing able to spend using these Addresses without workarounds.\n\n### Steps to reproduce\n\n* Optional: Generate a Vanity P2TR Address with the [Achow101's Rust-Vanitygen](https://github.com/achow101/rust-vanitygen), modding it or converting the Private Key from Mainnet to Testnet if necessary. Or simply some [random WIF Private Key](https://learnmeabitcoin.com/technical/keys/private-key/wif/). Some Addresses will work, others exhibit the present issue... It seems that there is a significant proportion falling in the second case...\n* For convenience, you can simply use this one made for this Bug Report:\n```\ninternal_privkey: cNKAo2ZRsaWKcP481cEfj3astPyBrfq56JBtLeRhHUvTSuk2z4MR\ninternal_pubkey: ac414af4b822d67307fe81bef0a72ddf0be9e6ff129eb1270b1168126f619619\nAddress: tb1ptestamfzz5zguhrad6xuf7afua0csz5m6k2qclpnpkvsl20t856sxz2d89\n```\n* Import the Address, for example in Testnet4 via the Bitcoin-Qt Console: \n```\nimportdescriptors '[{\"desc\": \"tr(cNKAo2ZRsaWKcP481cEfj3astPyBrfq56JBtLeRhHUvTSuk2z4MR)#vhsk8sfh\", \"timestamp\":0}]'\n```\n* Optional: get some coins from a Testnet4 Faucet (or any other source) for this tb1ptestamfzz5zguhrad6xuf7afua0csz5m6k2qclpnpkvsl20t856sxz2d89 Address. When I submitted the Issue, there were some coins left...\n* Optional: Send some amount involving this Address. Immediately after importing the Address, it appears that there is no particular issue. See Transaction [a301d660523de70542d30490052f9e04ba3f9b5e26482745c7dbdc952802f103](https://mempool.space/testnet4/tx/a301d660523de70542d30490052f9e04ba3f9b5e26482745c7dbdc952802f103).\n* Restart Bitcoin Core, and try sending again some amount. The interface now shows a \"Signing transaction failed\" dialog followed by \"Transaction creation failed!\". Or, in the Console,\n```\nsendtoaddress tb1qn9rvr53m7qvrpysx48svuxsgahs88xfsskx367 0.0001\nSigning transaction failed (code -6)\n```\n* However, if a new Wallet is created, and the Descriptor is imported again as above, sending coins is possible again (until Bitcoin Core is restarted again). The process can be repeated to further reuse the Address (which is obviously not practical).\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@228aba2c4d9ac0b2ca3edd3c2cdf0a92e55f669b\n\n### Operating system and version\n\nDebian 13 Testing\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/script/descriptor.cpp b/src/script/descriptor.cpp\nindex 2e1a30744ec11..499af47ee553f 100644\n--- a/src/script/descriptor.cpp\n+++ b/src/script/descriptor.cpp\n@@ -312,15 +312,7 @@ class ConstPubkeyProvider final : public PubkeyProvider\n     bool ToPrivateString(const SigningProvider& arg, std::string& ret) const override\n     {\n         CKey key;\n-        if (m_xonly) {\n-            for (const auto& keyid : XOnlyPubKey(m_pubkey).GetKeyIDs()) {\n-                arg.GetKey(keyid, key);\n-                if (key.IsValid()) break;\n-            }\n-        } else {\n-            arg.GetKey(m_pubkey.GetID(), key);\n-        }\n-        if (!key.IsValid()) return false;\n+        if (!GetPrivKey(/*pos=*/0, arg, key)) return false;\n         ret = EncodeSecret(key);\n         return true;\n     }\n@@ -331,7 +323,8 @@ class ConstPubkeyProvider final : public PubkeyProvider\n     }\n     bool GetPrivKey(int pos, const SigningProvider& arg, CKey& key) const override\n     {\n-        return arg.GetKey(m_pubkey.GetID(), key);\n+        return m_xonly ? arg.GetKeyByXOnly(XOnlyPubKey(m_pubkey), key) :\n+                         arg.GetKey(m_pubkey.GetID(), key);\n     }\n     std::optional<CPubKey> GetRootPubKey() const override\n     {\n@@ -1716,7 +1709,7 @@ struct KeyParser {\n         if (miniscript::IsTapscript(m_script_ctx) && end - begin == 32) {\n             XOnlyPubKey pubkey;\n             std::copy(begin, end, pubkey.begin());\n-            if (auto pubkey_provider = InferPubkey(pubkey.GetEvenCorrespondingCPubKey(), ParseContext(), *m_in)) {\n+            if (auto pubkey_provider = InferXOnlyPubkey(pubkey, ParseContext(), *m_in)) {\n                 m_keys.emplace_back();\n                 m_keys.back().push_back(std::move(pubkey_provider));\n                 return key;\ndiff --git a/src/script/signingprovider.h b/src/script/signingprovider.h\nindex efdfd9ee566b0..5b1da681f837f 100644\n--- a/src/script/signingprovider.h\n+++ b/src/script/signingprovider.h\n@@ -136,6 +136,8 @@ class TaprootBuilder\n     std::vector<std::tuple<uint8_t, uint8_t, std::vector<unsigned char>>> GetTreeTuples() const;\n     /** Returns true if there are any tapscripts */\n     bool HasScripts() const { return !m_branch.empty(); }\n+\n+    bool operator==(const TaprootBuilder& other) const { return GetTreeTuples() == other.GetTreeTuples(); }\n };\n \n /** Given a TaprootSpendData and the output key, reconstruct its script tree.\n", "instance_id": "bitcoin__bitcoin-31590", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: a \"Signing transaction failed\" error occurs when spending coins from certain Segwit Version 1 (P2TR) addresses imported using a specific descriptor in Bitcoin Core, particularly after a restart. The goal (being able to spend without workarounds) and steps to reproduce are provided with a concrete example, including a specific private key and address for testing. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement does not explicitly clarify whether the issue is tied to a specific version of Bitcoin Core beyond the commit hash provided, nor does it detail the exact conditions under which the issue manifests (e.g., specific types of transactions or address patterns beyond \"some random addresses\"). Additionally, edge cases or potential causes are not speculated upon in depth, leaving some uncertainty for a developer approaching the problem. Despite these minor gaps, the statement is actionable with the provided reproduction steps and example data.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.75, placing it in the \"Hard\" category due to several factors across the evaluation criteria:\n\n1. **Scope and Depth of Code Changes**: The provided code changes are relatively focused, affecting only a couple of files (`descriptor.cpp` and `signingprovider.h`) with modifications to how public and private keys are handled for P2TR addresses (specifically around XOnlyPubKey handling and Taproot-related logic). However, these changes are in a critical part of the Bitcoin Core codebase related to transaction signing and descriptor parsing, which implies a high impact on the system's correctness and security. While the diff is not extensive in terms of lines of code, the modifications require a deep understanding of the interaction between key management and Taproot-specific logic, suggesting a non-trivial integration with the broader codebase.\n\n2. **Number of Technical Concepts**: Solving this issue demands familiarity with several advanced concepts, including Bitcoin's Taproot (P2TR) address format, Segwit versioning, descriptor parsing, and the internals of Bitcoin Core's signing mechanisms. Specific knowledge of XOnlyPubKey (Schnorr signatures) and how private/public key pairs are managed in the context of Taproot is crucial. Additionally, understanding the nuances of wallet state persistence (given the issue manifests after a restart) adds another layer of complexity. These are domain-specific and advanced cryptographic concepts, not general programming knowledge, raising the difficulty.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement highlights that the issue affects \"some\" addresses but not others, implying potential edge cases related to specific key patterns or wallet states. The fact that the issue disappears when creating a new wallet and re-importing the descriptor suggests a state or caching issue, which can be notoriously difficult to debug and handle. The code changes do not explicitly address error handling but modify key retrieval logic, which could introduce or resolve subtle edge cases in transaction signing. Identifying and handling these edge cases (e.g., invalid or incompatible key formats, state corruption) requires careful testing and deep insight into Bitcoin Core's behavior.\n\n4. **Overall Complexity**: While the code changes themselves are not voluminous, the problem lies in a critical and complex area of Bitcoin Core. A developer must not only understand the provided diff but also ensure that the fix does not introduce regressions in transaction signing or security vulnerabilities in Taproot handling. The need to reason about wallet state persistence and the interaction between imported descriptors and the signing process adds significant cognitive load. This is not a surface-level bug fix but a problem requiring expertise in Bitcoin's internals and careful validation.\n\nGiven these considerations, a score of 0.75 reflects the hard nature of the problem, driven by the need for specialized domain knowledge, the critical impact of the changes, and the potential for subtle edge cases. It falls short of \"Very Hard\" (0.8-1.0) because the scope of code changes is relatively contained, and the problem does not appear to require a complete architectural overhaul or novel algorithm design.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "DNS seed \"seed.bitcoinstats.com\" doesn't support filtering while the comments says it does\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nIt's stated in `chainparams.cpp` that \"seed.bitcoinstats.com\" supports filtering. However, this isn't true.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c05c214f2e9cfd6070a3c7680bfa09358fd9d97a/src/kernel/chainparams.cpp#L137\n\n### Expected behaviour\n\nSince \"seed.bitcoinstats.com\" supports filtering for `NODE_NETWORK`, when asked for `NODE_NETWORK`, it should return archival nodes. It doesn't.\n\n### Steps to reproduce\n\n`dig x1.seed.bitcoinstats.com`.\r\n\r\n```\r\n[I] calvin@bitcoin ~> dig x1.seed.bitcoinstats.com\r\n\r\n; <<>> DiG 9.18.21 <<>> x1.seed.bitcoinstats.com\r\n;; global options: +cmd\r\n;; Got answer:\r\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 60119\r\n;; flags: qr rd ra; QUERY: 1, ANSWER: 25, AUTHORITY: 0, ADDITIONAL: 1\r\n\r\n;; OPT PSEUDOSECTION:\r\n; EDNS: version: 0, flags:; udp: 1232\r\n;; QUESTION SECTION:\r\n;x1.seed.bitcoinstats.com.      IN      A\r\n\r\n;; ANSWER SECTION:\r\nx1.seed.bitcoinstats.com. 60    IN      A       13.112.109.34\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.211.51.136\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.8.38.104\r\nx1.seed.bitcoinstats.com. 60    IN      A       64.227.26.97\r\nx1.seed.bitcoinstats.com. 60    IN      A       69.55.55.188\r\nx1.seed.bitcoinstats.com. 60    IN      A       34.241.94.237\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.124.65.19\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.81.243.143\r\nx1.seed.bitcoinstats.com. 60    IN      A       51.195.28.51\r\nx1.seed.bitcoinstats.com. 60    IN      A       46.137.123.109\r\nx1.seed.bitcoinstats.com. 60    IN      A       138.68.173.152\r\nx1.seed.bitcoinstats.com. 60    IN      A       69.4.94.226\r\nx1.seed.bitcoinstats.com. 60    IN      A       142.93.200.9\r\nx1.seed.bitcoinstats.com. 60    IN      A       54.68.82.186\r\nx1.seed.bitcoinstats.com. 60    IN      A       18.202.91.9\r\nx1.seed.bitcoinstats.com. 60    IN      A       52.30.154.84\r\nx1.seed.bitcoinstats.com. 60    IN      A       116.203.99.217\r\nx1.seed.bitcoinstats.com. 60    IN      A       13.112.109.34\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.211.51.136\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.8.38.104\r\nx1.seed.bitcoinstats.com. 60    IN      A       64.227.26.97\r\nx1.seed.bitcoinstats.com. 60    IN      A       69.55.55.188\r\nx1.seed.bitcoinstats.com. 60    IN      A       34.241.94.237\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.124.65.19\r\nx1.seed.bitcoinstats.com. 60    IN      A       3.81.243.143\r\n\r\n;; Query time: 312 msec\r\n;; SERVER: 1.1.1.1#53(1.1.1.1) (UDP)\r\n;; WHEN: Fri Apr 19 19:35:56 KST 2024\r\n;; MSG SIZE  rcvd: 453\r\n```\r\n\r\nOf the returned addresses, these address do not support `NODE_NETWORK`\r\n```\r\n13.112.109.34\r\n3.8.38.104\r\n64.227.26.97\r\n69.55.55.188\r\n34.241.94.237\r\n142.93.200.9\r\n18.202.91.9\r\n52.30.154.84\r\n116.203.99.217\r\n13.112.109.34\r\n64.227.26.97\r\n69.55.55.188\r\n34.241.94.237\r\n```\r\n\r\nOne can easily check bitnodes data: https://bitnodes.io/nodes/3.8.38.104-8333/\r\n\r\nA handful of the nodes here were also unreachable at the time of this writing.\n\n### Relevant log output\n\n_No response_\n\n### How did you obtain Bitcoin Core\n\nPre-built binaries\n\n### What version of Bitcoin Core are you using?\n\nv23.0.0 but this doesn't matter here\n\n### Operating system and version\n\nAlso doesn't matter\n\n### Machine specifications\n\nI don't think this matters for this issue\n", "patch": "diff --git a/src/kernel/chainparams.cpp b/src/kernel/chainparams.cpp\nindex 3bd662b684777..c995225064ffb 100644\n--- a/src/kernel/chainparams.cpp\n+++ b/src/kernel/chainparams.cpp\n@@ -145,7 +145,6 @@ class CMainParams : public CChainParams {\n         vSeeds.emplace_back(\"seed.bitcoin.sipa.be.\"); // Pieter Wuille, only supports x1, x5, x9, and xd\n         vSeeds.emplace_back(\"dnsseed.bluematt.me.\"); // Matt Corallo, only supports x9\n         vSeeds.emplace_back(\"dnsseed.bitcoin.dashjr-list-of-p2p-nodes.us.\"); // Luke Dashjr\n-        vSeeds.emplace_back(\"seed.bitcoinstats.com.\"); // Christian Decker, supports x1 - xf\n         vSeeds.emplace_back(\"seed.bitcoin.jonasschnelli.ch.\"); // Jonas Schnelli, only supports x1, x5, x9, and xd\n         vSeeds.emplace_back(\"seed.btc.petertodd.net.\"); // Peter Todd, only supports x1, x5, x9, and xd\n         vSeeds.emplace_back(\"seed.bitcoin.sprovoost.nl.\"); // Sjors Provoost\n", "instance_id": "bitcoin__bitcoin-30720", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the DNS seed \"seed.bitcoinstats.com\" is documented as supporting filtering for `NODE_NETWORK` in the Bitcoin Core codebase, but in practice, it returns nodes that do not support this feature. The statement provides evidence through a `dig` command output and references to external data (bitnodes.io) to validate the claim. It also clearly states the expected behavior (returning archival nodes for `NODE_NETWORK`). However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define what \"filtering\" entails in this context or provide a clear standard for determining whether a node supports `NODE_NETWORK`. Additionally, while the issue is demonstrated with data, there are no specific guidelines or examples of what a correct response from the DNS seed should look like. Edge cases, such as how to handle unreachable nodes or partial support for filtering, are not addressed. Overall, the problem is valid and mostly clear but lacks some precision and depth in requirements.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range, as it involves a straightforward code modification with minimal impact on the broader codebase. The proposed solution is to remove the DNS seed \"seed.bitcoinstats.com\" from the list in `chainparams.cpp`, which is a single-line change in a single file. This does not require deep understanding of the Bitcoin Core architecture, complex logic, or interaction between multiple modules. The technical concepts involved are minimal—basic knowledge of C++ and familiarity with the purpose of DNS seeds in the Bitcoin network are sufficient. There are no significant edge cases or error handling requirements introduced by this change, as it simply removes an entry rather than modifying behavior or adding new logic. The change has no impact on the system's architecture or performance. The primary challenge lies in verifying the correctness of the claim (i.e., confirming that the DNS seed does not support filtering as expected), but this is more of a research task than a coding challenge. Overall, this is a very easy fix suitable for a beginner or someone with minimal experience in the codebase.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Compilation failure with `-O0` + `-fsanitize=address`  due to inline asm\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nConfigure with\r\n```\r\n./configure --enable-fuzz --enable-debug --with-sanitizers=address,fuzzer,undefined,integer CC=clang CXX=clang++\r\n```\r\n\r\nCompile fails:\r\n```\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:1882: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:2591: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:3284: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:4686: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:5395: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:6088: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:7490: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:8199: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:8892: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:10312: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:11021: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:11714: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:12859: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:13356: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:13853: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:14900: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:15397: note: instantiated into assembly here\r\ncrypto/sha256_sse4.cpp:44:9: error: expected relocatable expression\r\n   44 |         \"shl    $0x6,%2;\"\r\n      |         ^\r\n<inline asm>:1:15894: note: instantiated into assembly here\r\n18 errors generated.\r\nmake[2]: *** [Makefile:14531: crypto/libbitcoin_crypto_base_la-sha256_sse4.lo] Error 1\r\n```\n\n### Expected behaviour\n\nIt should successfully compile with the debug symbols so that fuzz crashes can be debugged.\r\n\r\nPreviously, it was possible to work around this issue by using `--disable-asm` however that was removed in #29407\n\n### Steps to reproduce\n\nSee above configure .\r\n\r\n`--enable-debug` and `--enable-fuzz` individually do not result in compilation failure. I am only seeing this when using them together.\n\n### Relevant log output\n\n[config.log](https://github.com/bitcoin/bitcoin/files/14854906/config.log)\r\n\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nmaster@0d509bab45d292caeaf34600e57b5928757c6005\n\n### Operating system and version\n\nArch w/ linux kernel 6.8.2\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/crypto/sha256_sse4.cpp b/src/crypto/sha256_sse4.cpp\nindex f4557291cefe5..f0e255a23cb56 100644\n--- a/src/crypto/sha256_sse4.cpp\n+++ b/src/crypto/sha256_sse4.cpp\n@@ -13,6 +13,13 @@\n namespace sha256_sse4\n {\n void Transform(uint32_t* s, const unsigned char* chunk, size_t blocks)\n+#if defined(__clang__) && !defined(__OPTIMIZE__)\n+  /*\n+  clang is unable to compile this with -O0 and -fsanitize=address.\n+  See upstream bug: https://github.com/llvm/llvm-project/issues/92182\n+  */\n+  __attribute__((no_sanitize(\"address\")))\n+#endif\n {\n     static const uint32_t K256 alignas(16) [] = {\n         0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5,\n", "instance_id": "bitcoin__bitcoin-30097", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a compilation failure occurs when using specific configuration flags (`-O0` and `-fsanitize=address`) due to inline assembly in the `sha256_sse4.cpp` file. The goal is implicitly understood as fixing the compilation error to allow successful builds with debug symbols for fuzzing. The steps to reproduce are provided, along with relevant log output and configuration details, which help in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly state the expected solution approach (though the code changes provide a hint), nor does it discuss potential constraints or side effects of disabling optimizations or sanitizers. Additionally, edge cases or alternative configurations that might also be affected are not mentioned. Overall, while the issue is clear, the lack of explicit discussion on solution constraints or broader implications prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal, confined to a single file (`sha256_sse4.cpp`), and involves adding a small attribute (`__attribute__((no_sanitize(\"address\")))` to disable address sanitization for the affected function. This does not impact the broader system architecture or require modifications across multiple modules. The change is localized and straightforward, requiring only a few lines of code.\n\n2. **Technical Concepts Involved**: Solving this problem requires understanding a few specific concepts, including inline assembly in C++ (to recognize why the error occurs with `-O0` and `-fsanitize=address`), compiler-specific attributes (like `__attribute__((no_sanitize(\"address\")))`), and the interaction between Clang's optimization levels and sanitizers. While these concepts are not trivial, they are relatively niche and do not require deep algorithmic or architectural knowledge. Familiarity with compiler behavior and debugging flags is sufficient, which is within the skill set of an intermediate developer.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases beyond the specific configuration causing the failure. The code change does not introduce new error handling logic; it simply bypasses the sanitizer for this function to allow compilation. There might be implicit considerations, such as ensuring that disabling the sanitizer does not mask other issues or affect fuzzing effectiveness, but these are not addressed in the problem or code change, keeping the complexity low.\n\n4. **Overall Complexity**: The issue is a compiler-specific quirk rather than a deep logical or architectural problem. The solution involves applying a known workaround (as hinted by the reference to an upstream LLVM bug) rather than designing a complex fix. While it requires some understanding of Clang's behavior and build configurations, it does not demand extensive debugging or refactoring. The difficulty is slightly elevated above \"Very Easy\" due to the need to understand compiler-specific issues and inline assembly, but it remains manageable for someone with moderate experience in C++ and build systems.\n\nThus, a score of 0.35 reflects an \"Easy\" problem that requires targeted knowledge and a simple code modification without significant impact on the broader codebase.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Windows Terminal Alt+F4 behaviour\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.3880\n\n### Other Software\n\nAlso reproducible in:\r\nWindows Terminal Preview\r\nVersion: 1.21.1772.0\n\n### Steps to reproduce\n\n1. Start Windows Terminal.\r\n2. Open Settings -> Interaction -> Warn when closing more than one tab -> On -> Save.\r\n3. Close Settings tab and open any second terminal tab.\r\n4. Try to close terminal window with the X button in the upper right corner. It will ask for confirmation.\r\n5. Try to close terminal window with Alt+F4 shortcut. It will close window without confirmation.\r\n6. When Settings tab is active, it sometimes asks for confilmation when I press Alt+F4, but mostly not.\n\n### Expected Behavior\n\nWindows Terminal should ask for confirmation when closing window in any way: titlebar button, Alt+F4, Alt+Space menu, Taskbar menu, etc.\n\n### Actual Behavior\n\nPressing Alt+F4 shortcut will close Window Terminal window without confirmation, but pressing title bar 'close' button shows confirmation according to \"Settings -> Interaction -> Warn when closing more than one tab\" configuration.\n", "patch": "diff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 7b4893fef1a..b2ae698205a 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -118,7 +118,7 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleCloseWindow(const IInspectable& /*sender*/,\r\n                                           const ActionEventArgs& args)\r\n     {\r\n-        CloseRequested.raise(nullptr, nullptr);\r\n+        CloseWindow();\r\n         args.Handled(true);\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 87e7b17437b..23258c25095 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -182,7 +182,6 @@ namespace winrt::TerminalApp::implementation\n         til::typed_event<IInspectable, IInspectable> SummonWindowRequested;\n         til::typed_event<IInspectable, winrt::Microsoft::Terminal::Control::WindowSizeChangedEventArgs> WindowSizeChanged;\n \n-        til::typed_event<IInspectable, IInspectable> CloseRequested;\n         til::typed_event<IInspectable, IInspectable> OpenSystemMenu;\n         til::typed_event<IInspectable, IInspectable> QuitRequested;\n         til::typed_event<IInspectable, winrt::Microsoft::Terminal::Control::ShowWindowArgs> ShowWindowChanged;\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.idl b/src/cascadia/TerminalApp/TerminalPage.idl\nindex 2679d775b09..2788cedd10c 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.idl\n+++ b/src/cascadia/TerminalApp/TerminalPage.idl\n@@ -95,7 +95,6 @@ namespace TerminalApp\n         event Windows.Foundation.TypedEventHandler<Object, Object> SummonWindowRequested;\n         event Windows.Foundation.TypedEventHandler<Object, Microsoft.Terminal.Control.WindowSizeChangedEventArgs> WindowSizeChanged;\n \n-        event Windows.Foundation.TypedEventHandler<Object, Object> CloseRequested;\n         event Windows.Foundation.TypedEventHandler<Object, Object> OpenSystemMenu;\n         event Windows.Foundation.TypedEventHandler<Object, Microsoft.Terminal.Control.ShowWindowArgs> ShowWindowChanged;\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex a722468a547..7467b64241d 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -219,7 +219,6 @@ namespace winrt::TerminalApp::implementation\n         FORWARDED_TYPED_EVENT(SetTaskbarProgress, winrt::Windows::Foundation::IInspectable, winrt::Windows::Foundation::IInspectable, _root, SetTaskbarProgress);\r\n         FORWARDED_TYPED_EVENT(IdentifyWindowsRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, IdentifyWindowsRequested);\r\n         FORWARDED_TYPED_EVENT(SummonWindowRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, SummonWindowRequested);\r\n-        FORWARDED_TYPED_EVENT(CloseRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, CloseRequested);\r\n         FORWARDED_TYPED_EVENT(OpenSystemMenu, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, OpenSystemMenu);\r\n         FORWARDED_TYPED_EVENT(QuitRequested, Windows::Foundation::IInspectable, Windows::Foundation::IInspectable, _root, QuitRequested);\r\n         FORWARDED_TYPED_EVENT(ShowWindowChanged, Windows::Foundation::IInspectable, winrt::Microsoft::Terminal::Control::ShowWindowArgs, _root, ShowWindowChanged);\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 24ce090e378..f0bf2a98bd2 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -122,7 +122,6 @@ namespace TerminalApp\n         event Windows.Foundation.TypedEventHandler<Object, Object> IdentifyWindowsRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> IsQuakeWindowChanged;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> SummonWindowRequested;\r\n-        event Windows.Foundation.TypedEventHandler<Object, Object> CloseRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> OpenSystemMenu;\r\n         event Windows.Foundation.TypedEventHandler<Object, Object> QuitRequested;\r\n         event Windows.Foundation.TypedEventHandler<Object, TerminalApp.SystemMenuChangeArgs> SystemMenuChangeRequested;\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex ac255aa95b2..0fd623aad61 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -213,9 +213,6 @@ void AppHost::Initialize()\n     _windowCallbacks.WindowCloseButtonClicked = _window->WindowCloseButtonClicked([this]() {\r\n         _windowLogic.CloseWindow();\r\n     });\r\n-    // If the user requests a close in another way handle the same as if the 'X'\r\n-    // was clicked.\r\n-    _revokers.CloseRequested = _windowLogic.CloseRequested(winrt::auto_revoke, { this, &AppHost::_CloseRequested });\r\n \r\n     // Add an event handler to plumb clicks in the titlebar area down to the\r\n     // application layer.\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.h b/src/cascadia/WindowsTerminal/AppHost.h\nindex fba8274b176..be987ef0c7a 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.h\n+++ b/src/cascadia/WindowsTerminal/AppHost.h\n@@ -138,7 +138,6 @@ class AppHost : public std::enable_shared_from_this<AppHost>\n     struct Revokers\r\n     {\r\n         winrt::TerminalApp::TerminalWindow::Initialized_revoker Initialized;\r\n-        winrt::TerminalApp::TerminalWindow::CloseRequested_revoker CloseRequested;\r\n         winrt::TerminalApp::TerminalWindow::RequestedThemeChanged_revoker RequestedThemeChanged;\r\n         winrt::TerminalApp::TerminalWindow::FullscreenChanged_revoker FullscreenChanged;\r\n         winrt::TerminalApp::TerminalWindow::FocusModeChanged_revoker FocusModeChanged;\r\n", "instance_id": "microsoft__terminal-18434", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with Windows Terminal's behavior regarding the Alt+F4 shortcut not prompting for confirmation when closing multiple tabs, despite the setting being enabled. It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem. However, there are minor ambiguities, such as the inconsistent behavior when the Settings tab is active (sometimes prompting for confirmation, mostly not), which is not fully explained or detailed. Additionally, the problem statement does not explicitly mention any specific edge cases or constraints beyond the general behavior, which could leave some room for interpretation during implementation. Overall, it is clear enough to understand the goal but lacks exhaustive detail on all possible scenarios or edge cases.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of code changes is relatively limited, affecting a small number of files (six files in total) and primarily involving the removal of an event (`CloseRequested`) and a direct call to `CloseWindow()` instead of raising the event. This suggests a straightforward modification to unify the closing behavior across different triggers (e.g., Alt+F4 and the titlebar close button). Second, the technical concepts required are not overly complex; they involve understanding event handling in a Windows application (specifically in the context of WinRT and the Windows Terminal codebase) and basic control flow modifications. Third, the changes do not appear to impact the broader system architecture significantly, as they are confined to specific event-handling logic. However, there is a slight increase in difficulty due to the need to ensure consistency in behavior across different closing methods, which might involve verifying that the `CloseWindow()` function respects the confirmation setting—an aspect not fully detailed in the provided diff. Edge cases, such as the inconsistent behavior with the Settings tab, are mentioned in the problem statement but not explicitly addressed in the code changes, which could require additional investigation or minor adjustments. Overall, this task requires understanding some code logic and making simple modifications, fitting within the lower end of the difficulty spectrum.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "No tabs in fullscreen, focus mode or not\n### Windows Terminal version (or Windows build number)\n\n1.11.2421.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nUse F11 to switch between full screen and windowed mode. In the latter, tabs appear fine. In the former, there are never tabs shown. Setting a keybind for focus toggle will only affect the windowed mode, and I cannot get tabs in full screen mode under any circumstances.\r\n\r\nI've tried opening multiple tabs to make sure it wasn't a \"auto-hide the tabs if there's only one session open\" case.\n\n### Expected Behavior\n\nI would expect full screen mode to honor the focus mode.\n\n### Actual Behavior\n\nFocus mode is not honored and tabs will never appear in full screen mode.\n", "patch": "diff --git a/doc/cascadia/profiles.schema.json b/doc/cascadia/profiles.schema.json\nindex e9f123f7007..8c3fa8220d0 100644\n--- a/doc/cascadia/profiles.schema.json\n+++ b/doc/cascadia/profiles.schema.json\n@@ -2537,6 +2537,11 @@\n           \"description\": \"When set to true, the Terminal's tab row will display a shield icon when the Terminal is running with administrator privileges\",\n           \"type\": \"boolean\"\n         },\n+        \"showTabsFullscreen\": {\n+          \"default\": false,\n+          \"description\": \"When set to true, tabs remain visible in fullscreen mode. When set to false, tabs will be hidden when entering fullscreen mode.\",\n+          \"type\": \"boolean\"\n+        },\n         \"useAcrylicInTabRow\": {\n           \"default\": false,\n           \"description\": \"When set to true, the tab row will have an acrylic material background with 50% opacity.\",\ndiff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 0eba4511a92..cf0df031750 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -243,10 +243,12 @@ namespace winrt::TerminalApp::implementation\n     // - Handle changes in tab layout.\r\n     void TerminalPage::_UpdateTabView()\r\n     {\r\n-        // Never show the tab row when we're fullscreen. Otherwise:\r\n-        // Show tabs when there's more than 1, or the user has chosen to always\r\n-        // show the tab bar.\r\n-        const auto isVisible = (!_isFullscreen && !_isInFocusMode) &&\r\n+        // The tab row should only be visible if:\r\n+        // - we're not in focus mode\r\n+        // - we're not in full screen, or the user has enabled fullscreen tabs\r\n+        // - there is more than one tab, or the user has chosen to always show tabs\r\n+        const auto isVisible = !_isInFocusMode &&\r\n+                               (!_isFullscreen || _showTabsFullscreen) &&\r\n                                (_settings.GlobalSettings().ShowTabsInTitlebar() ||\r\n                                 (_tabs.Size() > 1) ||\r\n                                 _settings.GlobalSettings().AlwaysShowTabs());\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex e73ba93193b..c71596b7080 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -269,6 +269,7 @@ namespace winrt::TerminalApp::implementation\n         _layoutUpdatedRevoker = _tabContent.LayoutUpdated(winrt::auto_revoke, { this, &TerminalPage::_OnFirstLayout });\n \n         _isAlwaysOnTop = _settings.GlobalSettings().AlwaysOnTop();\n+        _showTabsFullscreen = _settings.GlobalSettings().ShowTabsFullscreen();\n \n         // DON'T set up Toasts/TeachingTips here. They should be loaded and\n         // initialized the first time they're opened, in whatever method opens\n@@ -3599,6 +3600,8 @@ namespace winrt::TerminalApp::implementation\n         _isAlwaysOnTop = _settings.GlobalSettings().AlwaysOnTop();\n         AlwaysOnTopChanged.raise(*this, nullptr);\n \n+        _showTabsFullscreen = _settings.GlobalSettings().ShowTabsFullscreen();\n+\n         // Settings AllowDependentAnimations will affect whether animations are\n         // enabled application-wide, so we don't need to check it each time we\n         // want to create an animation.\n@@ -4023,6 +4026,37 @@ namespace winrt::TerminalApp::implementation\n         return _isAlwaysOnTop;\n     }\n \n+    // Method Description:\n+    // - Returns true if the tab row should be visible when we're in full screen\n+    //   state.\n+    // Arguments:\n+    // - <none>\n+    // Return Value:\n+    // - true if the tab row should be visible in full screen state\n+    bool TerminalPage::ShowTabsFullscreen() const\n+    {\n+        return _showTabsFullscreen;\n+    }\n+\n+    // Method Description:\n+    // - Updates the visibility of the tab row when in fullscreen state.\n+    void TerminalPage::SetShowTabsFullscreen(bool newShowTabsFullscreen)\n+    {\n+        if (_showTabsFullscreen == newShowTabsFullscreen)\n+        {\n+            return;\n+        }\n+\n+        _showTabsFullscreen = newShowTabsFullscreen;\n+\n+        // if we're currently in fullscreen, update tab view to make\n+        // sure tabs are given the correct visibility\n+        if (_isFullscreen)\n+        {\n+            _UpdateTabView();\n+        }\n+    }\n+\n     void TerminalPage::SetFullscreen(bool newFullscreen)\n     {\n         if (_isFullscreen == newFullscreen)\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.h b/src/cascadia/TerminalApp/TerminalPage.h\nindex 87e7b17437b..f749479b090 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.h\n+++ b/src/cascadia/TerminalApp/TerminalPage.h\n@@ -121,6 +121,8 @@ namespace winrt::TerminalApp::implementation\n         bool FocusMode() const;\n         bool Fullscreen() const;\n         bool AlwaysOnTop() const;\n+        bool ShowTabsFullscreen() const;\n+        void SetShowTabsFullscreen(bool newShowTabsFullscreen);\n         void SetFullscreen(bool);\n         void SetFocusMode(const bool inFocusMode);\n         void Maximized(bool newMaximized);\n@@ -229,6 +231,7 @@ namespace winrt::TerminalApp::implementation\n         bool _isFullscreen{ false };\n         bool _isMaximized{ false };\n         bool _isAlwaysOnTop{ false };\n+        bool _showTabsFullscreen{ false };\n \n         std::optional<uint32_t> _loadFromPersistedLayoutIdx{};\n \ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.cpp b/src/cascadia/TerminalApp/TerminalWindow.cpp\nindex 569b236374a..055d6123ccf 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.cpp\n+++ b/src/cascadia/TerminalApp/TerminalWindow.cpp\n@@ -289,6 +289,11 @@ namespace winrt::TerminalApp::implementation\n         return _settings.GlobalSettings().AlwaysOnTop();\r\n     }\r\n \r\n+    bool TerminalWindow::GetInitialShowTabsFullscreen()\r\n+    {\r\n+        return _settings.GlobalSettings().ShowTabsFullscreen();\r\n+    }\r\n+\r\n     bool TerminalWindow::GetMinimizeToNotificationArea()\r\n     {\r\n         return _settings.GlobalSettings().MinimizeToNotificationArea();\r\n@@ -981,6 +986,11 @@ namespace winrt::TerminalApp::implementation\n         return _root ? _root->AlwaysOnTop() : false;\r\n     }\r\n \r\n+    bool TerminalWindow::ShowTabsFullscreen() const\r\n+    {\r\n+        return _root ? _root->ShowTabsFullscreen() : false;\r\n+    }\r\n+\r\n     void TerminalWindow::SetSettingsStartupArgs(const std::vector<ActionAndArgs>& actions)\r\n     {\r\n         for (const auto& action : actions)\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.h b/src/cascadia/TerminalApp/TerminalWindow.h\nindex a722468a547..0fd63a6362c 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.h\n+++ b/src/cascadia/TerminalApp/TerminalWindow.h\n@@ -89,6 +89,7 @@ namespace winrt::TerminalApp::implementation\n         bool Fullscreen() const;\r\n         void Maximized(bool newMaximized);\r\n         bool AlwaysOnTop() const;\r\n+        bool ShowTabsFullscreen() const;\r\n         bool AutoHideWindow();\r\n         void IdentifyWindow();\r\n \r\n@@ -106,6 +107,7 @@ namespace winrt::TerminalApp::implementation\n         Microsoft::Terminal::Settings::Model::LaunchMode GetLaunchMode();\r\n         bool GetShowTabsInTitlebar();\r\n         bool GetInitialAlwaysOnTop();\r\n+        bool GetInitialShowTabsFullscreen();\r\n         float CalcSnappedDimension(const bool widthOrHeight, const float dimension) const;\r\n \r\n         Windows::UI::Xaml::UIElement GetRoot() noexcept;\r\ndiff --git a/src/cascadia/TerminalApp/TerminalWindow.idl b/src/cascadia/TerminalApp/TerminalWindow.idl\nindex 24ce090e378..63c9169caf8 100644\n--- a/src/cascadia/TerminalApp/TerminalWindow.idl\n+++ b/src/cascadia/TerminalApp/TerminalWindow.idl\n@@ -69,6 +69,7 @@ namespace TerminalApp\n         void Maximized(Boolean newMaximized);\r\n         Boolean AlwaysOnTop { get; };\r\n         Boolean AutoHideWindow { get; };\r\n+        Boolean ShowTabsFullscreen { get; };\r\n \r\n         void IdentifyWindow();\r\n         void SetPersistedLayoutIdx(UInt32 idx);\r\n@@ -82,6 +83,7 @@ namespace TerminalApp\n         Microsoft.Terminal.Settings.Model.LaunchMode GetLaunchMode();\r\n         Boolean GetShowTabsInTitlebar();\r\n         Boolean GetInitialAlwaysOnTop();\r\n+        Boolean GetInitialShowTabsFullscreen();\r\n         Single CalcSnappedDimension(Boolean widthOrHeight, Single dimension);\r\n         void TitlebarClicked();\r\n         void CloseWindow();\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.cpp b/src/cascadia/TerminalApp/TitlebarControl.cpp\nindex 1debd030544..1ed82f39ca6 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.cpp\n+++ b/src/cascadia/TerminalApp/TitlebarControl.cpp\n@@ -12,6 +12,8 @@\n \r\n #include \"TitlebarControl.g.cpp\"\r\n \r\n+using namespace winrt::Windows::UI::Xaml;\r\n+\r\n namespace winrt::TerminalApp::implementation\r\n {\r\n     TitlebarControl::TitlebarControl(uint64_t handle) :\r\n@@ -77,6 +79,11 @@ namespace winrt::TerminalApp::implementation\n         }\r\n     }\r\n \r\n+    void TitlebarControl::FullscreenChanged(const bool fullscreen)\r\n+    {\r\n+        MinMaxCloseControl().Visibility(fullscreen ? Visibility::Collapsed : Visibility::Visible);\r\n+    }\r\n+\r\n     void TitlebarControl::_OnMaximizeOrRestore(byte flag)\r\n     {\r\n         POINT point1 = {};\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.h b/src/cascadia/TerminalApp/TitlebarControl.h\nindex 8020ff90956..1008253ba8d 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.h\n+++ b/src/cascadia/TerminalApp/TitlebarControl.h\n@@ -22,6 +22,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         void SetWindowVisualState(WindowVisualState visualState);\r\n         void Root_SizeChanged(const IInspectable& sender, const Windows::UI::Xaml::SizeChangedEventArgs& e);\r\n+        void FullscreenChanged(const bool fullscreen);\r\n \r\n         void Minimize_Click(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\n         void Maximize_Click(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& e);\r\ndiff --git a/src/cascadia/TerminalApp/TitlebarControl.idl b/src/cascadia/TerminalApp/TitlebarControl.idl\nindex b7a06ba987e..8f934fae951 100644\n--- a/src/cascadia/TerminalApp/TitlebarControl.idl\n+++ b/src/cascadia/TerminalApp/TitlebarControl.idl\n@@ -22,6 +22,7 @@ namespace TerminalApp\n     {\r\n         TitlebarControl(UInt64 parentWindowHandle);\r\n         void SetWindowVisualState(WindowVisualState visualState);\r\n+        void FullscreenChanged(Boolean fullscreen);\r\n \r\n         void HoverButton(CaptionButton button);\r\n         void PressButton(CaptionButton button);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml b/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\nindex f227268613d..854fd733766 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearance.xaml\n@@ -64,6 +64,12 @@\n                           Style=\"{StaticResource ToggleSwitchInExpanderStyle}\" />\r\n         </local:SettingContainer>\r\n \r\n+        <!--  Show tabs in full screen  -->\r\n+        <local:SettingContainer x:Uid=\"Globals_ShowTabsFullscreen\">\r\n+            <ToggleSwitch IsOn=\"{x:Bind ViewModel.ShowTabsFullscreen, Mode=TwoWay}\"\r\n+                          Style=\"{StaticResource ToggleSwitchInExpanderStyle}\" />\r\n+        </local:SettingContainer>\r\n+\r\n         <!--  Show Acrylic in Tab Row  -->\r\n         <local:SettingContainer x:Uid=\"Globals_AcrylicTabRow\">\r\n             <ToggleSwitch IsOn=\"{x:Bind ViewModel.UseAcrylicInTabRow, Mode=TwoWay}\"\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\nindex 7c19b543f5b..108636a747f 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.h\n@@ -32,6 +32,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void ShowTitlebarToggled(const winrt::Windows::Foundation::IInspectable& sender, const winrt::Windows::UI::Xaml::RoutedEventArgs& args);\r\n \r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, AlwaysShowTabs);\r\n+        PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTabsFullscreen);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTabsInTitlebar);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, UseAcrylicInTabRow);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(_GlobalSettings, ShowTitleInTitlebar);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\nindex 7f39f92709f..fb75021608c 100644\n--- a/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/GlobalAppearanceViewModel.idl\n@@ -26,6 +26,7 @@ namespace Microsoft.Terminal.Settings.Editor\n         void ShowTitlebarToggled(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\n \r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, AlwaysShowTabs);\r\n+        PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTabsFullscreen);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTabsInTitlebar);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, UseAcrylicInTabRow);\r\n         PERMANENT_OBSERVABLE_PROJECTED_SETTING(Boolean, ShowTitleInTitlebar);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex d7a0c3efe36..67990bafcbc 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -2276,6 +2276,14 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n+  <data name=\"Globals_ShowTabsFullscreen.Header\" xml:space=\"preserve\">\r\n+    <value>Show tabs in full screen</value>\r\n+    <comment>Header for a control to toggle if the app should show the tabs when in full screen state.</comment>\r\n+  </data>\r\n+  <data name=\"Globals_ShowTabsFullscreen.HelpText\" xml:space=\"preserve\">\r\n+    <value>When enabled, the tab bar will be visible when the app is full screen.</value>\r\n+    <comment>A description for what the \"show tabs in full screen\" setting does.</comment>\r\n+  </data>\r\n   <data name=\"Profile_PathTranslationStyle.[using:Windows.UI.Xaml.Automation]AutomationProperties.Name\" xml:space=\"preserve\">\r\n     <value>Path translation</value>\r\n     <comment>Name for a control to select how file and directory paths are translated.</comment>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl b/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\nindex b04073273ba..cee08a2656d 100644\n--- a/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\n+++ b/src/cascadia/TerminalSettingsModel/GlobalAppSettings.idl\n@@ -57,6 +57,7 @@ namespace Microsoft.Terminal.Settings.Model\n         INHERITABLE_SETTING(Int32, InitialRows);\r\n         INHERITABLE_SETTING(Int32, InitialCols);\r\n         INHERITABLE_SETTING(Boolean, AlwaysShowTabs);\r\n+        INHERITABLE_SETTING(Boolean, ShowTabsFullscreen);\r\n         INHERITABLE_SETTING(NewTabPosition, NewTabPosition);\r\n         INHERITABLE_SETTING(Boolean, ShowTitleInTitlebar);\r\n         INHERITABLE_SETTING(Boolean, ConfirmCloseAllTabs);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/MTSMSettings.h b/src/cascadia/TerminalSettingsModel/MTSMSettings.h\nindex c2553db2e47..e74a5c8b3b0 100644\n--- a/src/cascadia/TerminalSettingsModel/MTSMSettings.h\n+++ b/src/cascadia/TerminalSettingsModel/MTSMSettings.h\n@@ -68,7 +68,8 @@ Author(s):\n     X(bool, EnableUnfocusedAcrylic, \"compatibility.enableUnfocusedAcrylic\", true)                                                                                                                     \\\r\n     X(winrt::Windows::Foundation::Collections::IVector<Model::NewTabMenuEntry>, NewTabMenu, \"newTabMenu\", winrt::single_threaded_vector<Model::NewTabMenuEntry>({ Model::RemainingProfilesEntry{} })) \\\r\n     X(bool, AllowHeadless, \"compatibility.allowHeadless\", false)                                                                                                                                      \\\r\n-    X(hstring, SearchWebDefaultQueryUrl, \"searchWebDefaultQueryUrl\", L\"https://www.bing.com/search?q=%22%s%22\")\r\n+    X(hstring, SearchWebDefaultQueryUrl, \"searchWebDefaultQueryUrl\", L\"https://www.bing.com/search?q=%22%s%22\")                                                                                       \\\r\n+    X(bool, ShowTabsFullscreen, \"showTabsFullscreen\", false)\r\n \r\n // Also add these settings to:\r\n // * Profile.idl\r\ndiff --git a/src/cascadia/WindowsTerminal/AppHost.cpp b/src/cascadia/WindowsTerminal/AppHost.cpp\nindex c7db8e38e1a..ea38d7dcdfc 100644\n--- a/src/cascadia/WindowsTerminal/AppHost.cpp\n+++ b/src/cascadia/WindowsTerminal/AppHost.cpp\n@@ -193,6 +193,7 @@ void AppHost::Initialize()\n \r\n     _window->SetAlwaysOnTop(_windowLogic.GetInitialAlwaysOnTop());\r\n     _window->SetAutoHideWindow(_windowLogic.AutoHideWindow());\r\n+    _window->SetShowTabsFullscreen(_windowLogic.GetInitialShowTabsFullscreen());\r\n \r\n     // MORE EVENT HANDLERS HERE!\r\n     // MAKE SURE THEY ARE ALL:\r\n@@ -1023,6 +1024,7 @@ void AppHost::_HandleSettingsChanged(const winrt::Windows::Foundation::IInspecta\n \r\n     _window->SetMinimizeToNotificationAreaBehavior(_windowLogic.GetMinimizeToNotificationArea());\r\n     _window->SetAutoHideWindow(_windowLogic.AutoHideWindow());\r\n+    _window->SetShowTabsFullscreen(_windowLogic.ShowTabsFullscreen());\r\n     _updateTheme();\r\n }\r\n \r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.cpp b/src/cascadia/WindowsTerminal/IslandWindow.cpp\nindex 4c950cb986d..693569791ec 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.cpp\n@@ -848,6 +848,11 @@ void IslandWindow::ShowWindowChanged(const bool showOrHide)\n     }\r\n }\r\n \r\n+void IslandWindow::SetShowTabsFullscreen(const bool newShowTabsFullscreen)\r\n+{\r\n+    _showTabsFullscreen = newShowTabsFullscreen;\r\n+}\r\n+\r\n // Method Description\r\n // - Flash the taskbar icon, indicating to the user that something needs their attention\r\n void IslandWindow::FlashTaskbar()\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.h b/src/cascadia/WindowsTerminal/IslandWindow.h\nindex 8432d4e8134..ef050291e07 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.h\n@@ -46,6 +46,7 @@ class IslandWindow :\n     void FullscreenChanged(const bool fullscreen);\n     void SetAlwaysOnTop(const bool alwaysOnTop);\n     void ShowWindowChanged(const bool showOrHide);\n+    virtual void SetShowTabsFullscreen(const bool newShowTabsFullscreen);\n \n     void FlashTaskbar();\n     void SetTaskbarProgress(const size_t state, const size_t progress);\n@@ -105,6 +106,7 @@ class IslandWindow :\n     bool _borderless{ false };\n     bool _alwaysOnTop{ false };\n     bool _fullscreen{ false };\n+    bool _showTabsFullscreen{ false };\n     bool _fWasMaximizedBeforeFullscreen{ false };\n     RECT _rcWindowBeforeFullscreen{};\n     RECT _rcWorkBeforeFullscreen{};\n@@ -112,6 +114,7 @@ class IslandWindow :\n \n     virtual void _SetIsBorderless(const bool borderlessEnabled);\n     virtual void _SetIsFullscreen(const bool fullscreenEnabled);\n+\n     void _RestoreFullscreenPosition(const RECT& rcWork);\n     void _SetFullscreenPosition(const RECT& rcMonitor, const RECT& rcWork);\n \ndiff --git a/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp b/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\nindex 3c66105885c..414e4043f88 100644\n--- a/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/NonClientIslandWindow.cpp\n@@ -1129,7 +1129,7 @@ void NonClientIslandWindow::_SetIsBorderless(const bool borderlessEnabled)\n \r\n // Method Description:\r\n // - Enable or disable fullscreen mode. When entering fullscreen mode, we'll\r\n-//   need to manually hide the entire titlebar.\r\n+//   need to check whether to hide the titlebar.\r\n // - See also IslandWindow::_SetIsFullscreen, which does additional work.\r\n // Arguments:\r\n // - fullscreenEnabled: If true, we're entering fullscreen mode. If false, we're leaving.\r\n@@ -1138,10 +1138,7 @@ void NonClientIslandWindow::_SetIsBorderless(const bool borderlessEnabled)\n void NonClientIslandWindow::_SetIsFullscreen(const bool fullscreenEnabled)\r\n {\r\n     IslandWindow::_SetIsFullscreen(fullscreenEnabled);\r\n-    if (_titlebar)\r\n-    {\r\n-        _titlebar.Visibility(_IsTitlebarVisible() ? Visibility::Visible : Visibility::Collapsed);\r\n-    }\r\n+    _UpdateTitlebarVisibility();\r\n     // GH#4224 - When the auto-hide taskbar setting is enabled, then we don't\r\n     // always get another window message to trigger us to remove the drag bar.\r\n     // So, make sure to update the size of the drag region here, so that it\r\n@@ -1149,16 +1146,42 @@ void NonClientIslandWindow::_SetIsFullscreen(const bool fullscreenEnabled)\n     _ResizeDragBarWindow();\r\n }\r\n \r\n+void NonClientIslandWindow::SetShowTabsFullscreen(const bool newShowTabsFullscreen)\r\n+{\r\n+    IslandWindow::SetShowTabsFullscreen(newShowTabsFullscreen);\r\n+\r\n+    // don't waste time recalculating UI elements if we're not\r\n+    // in fullscreen state - this setting doesn't affect other\r\n+    // window states\r\n+    if (_fullscreen)\r\n+    {\r\n+        _UpdateTitlebarVisibility();\r\n+    }\r\n+}\r\n+\r\n+void NonClientIslandWindow::_UpdateTitlebarVisibility()\r\n+{\r\n+    if (!_titlebar)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    const auto showTitlebar = _IsTitlebarVisible();\r\n+    _titlebar.Visibility(showTitlebar ? Visibility::Visible : Visibility::Collapsed);\r\n+    _titlebar.FullscreenChanged(_fullscreen);\r\n+}\r\n+\r\n // Method Description:\r\n-// - Returns true if the titlebar is visible. For things like fullscreen mode,\r\n-//   borderless mode (aka \"focus mode\"), this will return false.\r\n+// - Returns true if the titlebar is visible. For borderless mode (aka \"focus mode\"),\r\n+//   this will return false. For fullscreen, this will return false unless the user\r\n+//   has enabled fullscreen tabs.\r\n // Arguments:\r\n // - <none>\r\n // Return Value:\r\n // - true iff the titlebar is visible\r\n bool NonClientIslandWindow::_IsTitlebarVisible() const\r\n {\r\n-    return !(_fullscreen || _borderless);\r\n+    return !_borderless && (!_fullscreen || _showTabsFullscreen);\r\n }\r\n \r\n void NonClientIslandWindow::SetTitlebarBackground(winrt::Windows::UI::Xaml::Media::Brush brush)\r\ndiff --git a/src/cascadia/WindowsTerminal/NonClientIslandWindow.h b/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\nindex 76e093a2340..bdf64f98409 100644\n--- a/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/NonClientIslandWindow.h\n@@ -46,6 +46,7 @@ class NonClientIslandWindow : public IslandWindow\n     void OnApplicationThemeChanged(const winrt::Windows::UI::Xaml::ElementTheme& requestedTheme) override;\r\n \r\n     void SetTitlebarBackground(winrt::Windows::UI::Xaml::Media::Brush brush);\r\n+    void SetShowTabsFullscreen(const bool newShowTabsFullscreen) override;\r\n \r\n     virtual void UseMica(const bool newValue, const double titlebarOpacity) override;\r\n \r\n@@ -92,6 +93,7 @@ class NonClientIslandWindow : public IslandWindow\n     void _UpdateFrameMargins() const noexcept;\r\n     void _UpdateMaximizedState();\r\n     void _UpdateIslandPosition(const UINT windowWidth, const UINT windowHeight);\r\n+    void _UpdateTitlebarVisibility();\r\n \r\n     struct Revokers\r\n     {\r\n", "instance_id": "microsoft__terminal-18171", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: tabs are not visible in fullscreen mode in Windows Terminal, regardless of focus mode settings, and the user expects fullscreen mode to honor focus mode settings or allow tabs to be shown. The steps to reproduce are provided, along with expected and actual behavior, which helps in understanding the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly specify whether the solution should involve a user-configurable setting or a hardcoded behavior change. Additionally, it lacks mention of potential edge cases (e.g., behavior with specific configurations or themes) or constraints (e.g., performance considerations in fullscreen mode). While the intent is clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes is moderate, spanning multiple files (e.g., settings schema, UI logic, window management) and requiring modifications to both logic and user interface components. This indicates a need to understand interactions between different parts of the codebase, such as settings management, tab visibility logic, and fullscreen mode handling. Second, the number of technical concepts involved is not trivial; it includes understanding Windows Terminal's settings model, UI rendering logic (e.g., visibility toggles), and potentially XAML-based UI components. However, the concepts are not overly complex for someone familiar with the codebase or Windows application development. Third, the problem does not explicitly mention edge cases, but the code changes suggest handling scenarios like toggling fullscreen mode dynamically and ensuring consistency with other settings (e.g., focus mode). The error handling requirements appear minimal, as the changes focus on visibility logic rather than complex error conditions. Overall, while the problem requires a moderate level of understanding and effort across several files, it does not involve deep architectural changes or highly complex logic, placing it in the 0.4-0.6 range, specifically at 0.45.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "gltfpack: Keep `EXT_mesh_gpu_instancing`\n### Discussed in https://github.com/zeux/meshoptimizer/discussions/680\r\n\r\n<div type='discussions-op-text'>\r\n\r\n<sup>Originally posted by **BoyBaykiller** April 22, 2024</sup>\r\nI am running `gltfpack -v -mi -noq -tc -i .\\SimpleInstancing.gltf -o .\\Compressed\\Output.gltf` over [this](https://github.com/KhronosGroup/glTF-Sample-Models/tree/main/2.0/SimpleInstancing/glTF) gltf model.\r\nIt uses the EXT_mesh_gpu_instancing extension to define a bunch of instanced cubes. I can render it correctly as it, but after running it through the command the EXT_mesh_gpu_instancing extension is removed, resulting in only a single cube being rendered.</div>\n", "patch": "diff --git a/extern/cgltf.h b/extern/cgltf.h\nindex 17dc0ca5d..ac392aba4 100644\n--- a/extern/cgltf.h\n+++ b/extern/cgltf.h\n@@ -1697,7 +1697,20 @@ cgltf_result cgltf_validate(cgltf_data* data)\n \t{\n \t\tif (data->nodes[i].weights && data->nodes[i].mesh)\n \t\t{\n-\t\t\tCGLTF_ASSERT_IF (data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh->primitives_count && data->nodes[i].mesh->primitives[0].targets_count != data->nodes[i].weights_count, cgltf_result_invalid_gltf);\n+\t\t}\n+\n+\t\tif (data->nodes[i].has_mesh_gpu_instancing)\n+\t\t{\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh == NULL, cgltf_result_invalid_gltf);\n+\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes_count == 0, cgltf_result_invalid_gltf);\n+\n+\t\t\tcgltf_accessor* first = data->nodes[i].mesh_gpu_instancing.attributes[0].data;\n+\n+\t\t\tfor (cgltf_size k = 0; k < data->nodes[i].mesh_gpu_instancing.attributes_count; ++k)\n+\t\t\t{\n+\t\t\t\tCGLTF_ASSERT_IF(data->nodes[i].mesh_gpu_instancing.attributes[k].data->count != first->count, cgltf_result_invalid_gltf);\n+\t\t\t}\n \t\t}\n \t}\n \ndiff --git a/gltf/README.md b/gltf/README.md\nindex a6be16405..ffe6d1e12 100644\n--- a/gltf/README.md\n+++ b/gltf/README.md\n@@ -83,6 +83,7 @@ gltfpack supports most Khronos extensions and some multi-vendor extensions in th\n - KHR_mesh_quantization\n - KHR_texture_basisu\n - KHR_texture_transform\n+- EXT_mesh_gpu_instancing\n - EXT_meshopt_compression\n \n Even if the source file does not use extensions, gltfpack may use some extensions in the output file either by default or when certain options are used:\ndiff --git a/gltf/gltfpack.cpp b/gltf/gltfpack.cpp\nindex 2db6eff77..dee7a930a 100644\n--- a/gltf/gltfpack.cpp\n+++ b/gltf/gltfpack.cpp\n@@ -281,7 +281,10 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \tfor (size_t i = 0; i < meshes.size(); ++i)\n \t{\n \t\tMesh& mesh = meshes[i];\n-\t\tassert(mesh.instances.empty());\n+\n+\t\t// mesh is already instanced, skip\n+\t\tif (!mesh.instances.empty())\n+\t\t\tcontinue;\n \n \t\t// mesh is already world space, skip\n \t\tif (mesh.nodes.empty())\n@@ -664,9 +667,6 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\tappend(json_meshes, \"}\");\n \n-\t\tassert(mesh.nodes.empty() || mesh.instances.empty());\n-\t\text_instancing = ext_instancing || !mesh.instances.empty();\n-\n \t\tif (mesh.nodes.size())\n \t\t{\n \t\t\tfor (size_t j = 0; j < mesh.nodes.size(); ++j)\n@@ -691,7 +691,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t\t\t}\n \t\t\t}\n \t\t}\n-\t\telse if (mesh.instances.size())\n+\n+\t\tif (mesh.instances.size())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -704,7 +705,8 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \n \t\t\tnode_offset++;\n \t\t}\n-\t\telse\n+\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tassert(mesh.scene >= 0);\n \t\t\tcomma(json_roots[mesh.scene]);\n@@ -716,6 +718,7 @@ static void process(cgltf_data* data, const char* input_path, const char* output\n \t\t}\n \n \t\tmesh_offset++;\n+\t\text_instancing = ext_instancing || !mesh.instances.empty();\n \n \t\t// skip all meshes that we've written in this iteration\n \t\tassert(pi > i);\ndiff --git a/gltf/parsegltf.cpp b/gltf/parsegltf.cpp\nindex 91f0c020f..f83356b70 100644\n--- a/gltf/parsegltf.cpp\n+++ b/gltf/parsegltf.cpp\n@@ -275,6 +275,54 @@ static void parseMeshesGltf(cgltf_data* data, std::vector<Mesh>& meshes, std::ve\n \t}\n }\n \n+static void parseMeshInstancesGltf(std::vector<Transform>& instances, cgltf_node* node)\n+{\n+\tcgltf_accessor* translation = NULL;\n+\tcgltf_accessor* rotation = NULL;\n+\tcgltf_accessor* scale = NULL;\n+\n+\tfor (size_t i = 0; i < node->mesh_gpu_instancing.attributes_count; ++i)\n+\t{\n+\t\tcgltf_attribute& attr = node->mesh_gpu_instancing.attributes[i];\n+\n+\t\tif (strcmp(attr.name, \"TRANSLATION\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\ttranslation = attr.data;\n+\t\telse if (strcmp(attr.name, \"ROTATION\") == 0 && attr.data->type == cgltf_type_vec4)\n+\t\t\trotation = attr.data;\n+\t\telse if (strcmp(attr.name, \"SCALE\") == 0 && attr.data->type == cgltf_type_vec3)\n+\t\t\tscale = attr.data;\n+\t}\n+\n+\tsize_t count = node->mesh_gpu_instancing.attributes[0].data->count;\n+\n+\tinstances.reserve(instances.size() + count);\n+\n+\tcgltf_node instance = {};\n+\tinstance.parent = node;\n+\tinstance.has_translation = translation != NULL;\n+\tinstance.has_rotation = rotation != NULL;\n+\tinstance.has_scale = scale != NULL;\n+\tinstance.rotation[3] = 1.f;\n+\tinstance.scale[0] = 1.f;\n+\tinstance.scale[1] = 1.f;\n+\tinstance.scale[2] = 1.f;\n+\n+\tfor (size_t i = 0; i < count; ++i)\n+\t{\n+\t\tif (translation)\n+\t\t\tcgltf_accessor_read_float(translation, i, instance.translation, sizeof(float));\n+\t\tif (rotation)\n+\t\t\tcgltf_accessor_read_float(rotation, i, instance.rotation, sizeof(float));\n+\t\tif (scale)\n+\t\t\tcgltf_accessor_read_float(scale, i, instance.scale, sizeof(float));\n+\n+\t\tTransform xf;\n+\t\tcgltf_node_transform_world(&instance, xf.data);\n+\n+\t\tinstances.push_back(xf);\n+\t}\n+}\n+\n static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, const std::vector<std::pair<size_t, size_t> >& mesh_remap)\n {\n \tfor (size_t i = 0; i < data->nodes_count; ++i)\n@@ -289,7 +337,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t{\n \t\t\tMesh* mesh = &meshes[mi];\n \n-\t\t\tif (!mesh->nodes.empty() && mesh->skin != node.skin)\n+\t\t\tif (mesh->skin != node.skin && (!mesh->nodes.empty() || !mesh->instances.empty()))\n \t\t\t{\n \t\t\t\t// this should be extremely rare - if the same mesh is used with different skins, we need to duplicate it\n \t\t\t\t// in this case we don't spend any effort on keeping the number of duplicates to the minimum, because this\n@@ -298,8 +346,16 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\t\t\tmesh = &meshes.back();\n \t\t\t}\n \n-\t\t\tmesh->nodes.push_back(&node);\n-\t\t\tmesh->skin = node.skin;\n+\t\t\tif (node.has_mesh_gpu_instancing)\n+\t\t\t{\n+\t\t\t\tmesh->scene = 0; // we need to assign scene index since instances are attached to a scene; for now we assume 0\n+\t\t\t\tparseMeshInstancesGltf(mesh->instances, &node);\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\tmesh->skin = node.skin;\n+\t\t\t\tmesh->nodes.push_back(&node);\n+\t\t\t}\n \t\t}\n \t}\n \n@@ -308,7 +364,7 @@ static void parseMeshNodesGltf(cgltf_data* data, std::vector<Mesh>& meshes, cons\n \t\tMesh& mesh = meshes[i];\n \n \t\t// because the rest of gltfpack assumes that empty nodes array = world-space mesh, we need to filter unused meshes\n-\t\tif (mesh.nodes.empty())\n+\t\tif (mesh.nodes.empty() && mesh.instances.empty())\n \t\t{\n \t\t\tmesh.streams.clear();\n \t\t\tmesh.indices.clear();\n@@ -530,8 +586,6 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \t\t*error = getError(result, data);\n \telse if (requiresExtension(data, \"KHR_draco_mesh_compression\"))\n \t\t*error = \"file requires Draco mesh compression support\";\n-\telse if (requiresExtension(data, \"EXT_mesh_gpu_instancing\"))\n-\t\t*error = \"file requires mesh instancing support\";\n \telse if (needsDummyBuffers(data))\n \t\t*error = \"buffer has no data\";\n \n@@ -543,6 +597,8 @@ static cgltf_data* parseGltf(cgltf_data* data, cgltf_result result, std::vector<\n \n \tif (requiresExtension(data, \"KHR_mesh_quantization\"))\n \t\tfprintf(stderr, \"Warning: file uses quantized geometry; repacking may result in increased quantization error\\n\");\n+\tif (requiresExtension(data, \"EXT_mesh_gpu_instancing\") && data->scenes_count > 1)\n+\t\tfprintf(stderr, \"Warning: file uses instancing and has more than one scene; results may be incorrect\\n\");\n \n \tstd::vector<std::pair<size_t, size_t> > mesh_remap;\n \n", "instance_id": "zeux__meshoptimizer-696", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the `gltfpack` tool removes the `EXT_mesh_gpu_instancing` extension when processing a glTF model, resulting in incorrect rendering (only one cube instead of multiple instanced cubes). The goal is implied—to preserve or support the `EXT_mesh_gpu_instancing` extension during processing. However, the statement lacks explicit details about the expected behavior (e.g., how the extension should be handled or preserved) and does not mention specific constraints or edge cases (e.g., compatibility with other extensions or performance implications). Additionally, there are no examples beyond the referenced model, and the input/output formats are not detailed in the statement itself. While the issue is valid and the intent is understandable, these missing minor details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (`cgltf.h`, `gltfpack.cpp`, `parsegltf.cpp`, and documentation in `README.md`), requiring a moderate understanding of the codebase structure and interactions between parsing, processing, and validation logic for glTF models. The changes involve adding support for the `EXT_mesh_gpu_instancing` extension, which includes parsing instance attributes (translation, rotation, scale) and ensuring they are correctly handled during mesh processing. This requires familiarity with glTF specifications and the `cgltf` library, as well as concepts like mesh instancing and transformation matrices, which are moderately complex. The code modifications are not trivial—they include new validation logic, parsing functions, and conditional handling of instanced meshes versus regular nodes, indicating a need for careful integration into the existing workflow. Edge cases, such as ensuring consistency across instance attributes or handling multiple scenes (as warned in the code), add some complexity, though they are not extensively detailed in the problem statement. However, the changes do not appear to impact the core architecture significantly, nor do they require advanced domain-specific knowledge beyond glTF processing. Therefore, a score of 0.55 reflects a medium difficulty level, requiring a solid understanding of the codebase and moderate effort to implement and test the solution.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: When `window.webContents.navigationHistory.goBack()` is called, the title set by the HTML's `<title>` tag will override the title set by `window.setTitle()`.\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.0.1\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11\t23H2\t22631.4169\tWindows Feature Experience Pack 1000.22700.1034.0\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => The title of the window should not be overridden by the HTML's title when `goBack()` is called.\n```\n\n### Actual Behavior\n\n```\nconst window = new BrowserWindow();\nwindow.setTitle('myTitle');\n// After a route change in my HTML file, execute:\nwindow.webContents.navigationHistory.goBack();\n// => At this point, the title of the window is no longer 'myTitle', but the content of the title tag in the HTML file.\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nThe front-end uses Vue.js + Vue-Router\n", "patch": "diff --git a/shell/browser/api/electron_api_web_contents.cc b/shell/browser/api/electron_api_web_contents.cc\nindex 53a24ac6f5943..c01e3c5fda2aa 100644\n--- a/shell/browser/api/electron_api_web_contents.cc\n+++ b/shell/browser/api/electron_api_web_contents.cc\n@@ -2057,6 +2057,17 @@ void WebContents::DidFinishNavigation(\n       if (is_main_frame) {\n         Emit(\"did-navigate\", url, http_response_code, http_status_text);\n       }\n+\n+      content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n+\n+      // This check is needed due to an issue in Chromium\n+      // Upstream is open to patching:\n+      // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n+      // If a history entry has been made and the forward/back call has been\n+      // made, proceed with setting the new title\n+      if (entry &&\n+          (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n+        WebContents::TitleWasSet(entry);\n     }\n     if (is_guest())\n       Emit(\"load-commit\", url, is_main_frame);\n@@ -2077,15 +2088,6 @@ void WebContents::DidFinishNavigation(\n            frame_process_id, frame_routing_id);\n     }\n   }\n-  content::NavigationEntry* entry = navigation_handle->GetNavigationEntry();\n-\n-  // This check is needed due to an issue in Chromium\n-  // Check the Chromium issue to keep updated:\n-  // https://bugs.chromium.org/p/chromium/issues/detail?id=1178663\n-  // If a history entry has been made and the forward/back call has been made,\n-  // proceed with setting the new title\n-  if (entry && (entry->GetTransitionType() & ui::PAGE_TRANSITION_FORWARD_BACK))\n-    WebContents::TitleWasSet(entry);\n }\n \n void WebContents::TitleWasSet(content::NavigationEntry* entry) {\ndiff --git a/spec/api-web-contents-spec.ts b/spec/api-web-contents-spec.ts\nindex aa2c7d5297453..3f529c118d2e3 100644\n--- a/spec/api-web-contents-spec.ts\n+++ b/spec/api-web-contents-spec.ts\n@@ -631,6 +631,17 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goBack();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(0);\n       });\n+\n+      it('should have the same window title if navigating back within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        w.webContents.navigationHistory.goBack();\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoForward and navigationHistory.goForward API', () => {\n@@ -653,6 +664,16 @@ describe('webContents module', () => {\n         w.webContents.navigationHistory.goForward();\n         expect(w.webContents.navigationHistory.getActiveIndex()).to.equal(1);\n       });\n+\n+      it('should have the same window title if navigating forward within the page', async () => {\n+        const title = 'Test';\n+        w.webContents.on('did-finish-load', () => {\n+          w.setTitle(title);\n+          w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html#next`);\n+        });\n+        await w.loadURL(`file://${fixturesPath}/pages/navigation-history-anchor-in-page.html`);\n+        expect(w.getTitle()).to.equal(title);\n+      });\n     });\n \n     describe('navigationHistory.canGoToOffset(index) and navigationHistory.goToOffset(index) API', () => {\ndiff --git a/spec/fixtures/pages/navigation-history-anchor-in-page.html b/spec/fixtures/pages/navigation-history-anchor-in-page.html\nnew file mode 100644\nindex 0000000000000..03406b81f2a39\n--- /dev/null\n+++ b/spec/fixtures/pages/navigation-history-anchor-in-page.html\n@@ -0,0 +1,5 @@\n+<html>\n+<body>\n+  <span id=\"next\">This is content.</span>\n+</body>\n+</html>\n", "instance_id": "electron__electron-45981", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when `window.webContents.navigationHistory.goBack()` is called in Electron, the window title set by `window.setTitle()` is unexpectedly overridden by the HTML `<title>` tag of the navigated page. The expected and actual behaviors are provided with code snippets, which helps in understanding the bug. Additionally, the context of the front-end framework (Vue.js + Vue-Router) and the operating system (Windows 11) are mentioned, which adds some useful background. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss edge cases (e.g., what happens with multiple navigation steps or different types of navigation transitions) or constraints (e.g., whether this behavior is specific to certain Electron versions or HTML structures). There is also no test case gist provided, which could have further clarified the reproduction steps. Overall, while the core issue is well-articulated, the lack of comprehensive edge case discussion and detailed reproduction steps prevents it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves modifications in multiple files: `electron_api_web_contents.cc` (C++ backend logic in Electron) and `api-web-contents-spec.ts` (TypeScript test specs), along with the addition of a new test fixture HTML file. The changes in the C++ file require understanding Chromium's navigation handling logic, specifically the `NavigationEntry` and `PAGE_TRANSITION_FORWARD_BACK` concepts, which are moderately complex and tied to Chromium's internals. The code change itself is relatively small but impactful, as it relocates a critical logic block for title setting within the navigation flow to address the bug, requiring a good grasp of event timing in navigation handling. Second, the technical concepts involved include familiarity with Electron's API, Chromium's navigation system, and integration testing in TypeScript, which collectively demand a moderate level of expertise. Third, while the problem statement does not explicitly mention edge cases, the code changes and test additions implicitly address scenarios like in-page anchor navigation, which adds a layer of complexity to ensure the title remains consistent across different navigation types. However, the changes do not significantly impact the broader system architecture, nor do they introduce complex error handling or performance considerations. Overall, this problem requires understanding multiple concepts and making targeted but non-trivial modifications across a few files, justifying a difficulty score of 0.55, on the higher end of medium difficulty.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex 0dcfad8aa6dd5..62c5480edf965 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "instance_id": "electron__electron-41709", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: Electron crashes when closing notifications in a portal environment with libnotify 0.8.3. It provides detailed context about the environment (Linux, specific Electron versions, and portal settings), expected behavior, actual behavior, and a step-by-step analysis of the crash's root cause. Additionally, it includes links to relevant code in the Electron repository and external libraries, as well as a minimal reproducible example (MRE). However, there are minor ambiguities that prevent a perfect score. For instance, the problem statement does not explicitly define the expected fix or constraints for the solution (e.g., whether the fix must avoid breaking other environments). Edge cases, such as behavior in non-portal environments or with different libnotify versions, are not mentioned. While the analysis is thorough, it assumes familiarity with Electron's notification system and libnotify internals, which might not be immediately clear to all developers. Overall, the statement is valid and clear but lacks some minor details.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.65, placing it in the \"Hard\" category due to several factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves intricate interactions between Electron's notification system and the libnotify library in a portal environment (e.g., Flatpak/Snap). Understanding the crash requires tracing the signal handling and object lifecycle management, which adds to the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are relatively small and localized to a single file (`libnotify_notification.cc` and its header). The fix introduces a boolean flag (`on_dismissing_`) to track whether the dismissal is in progress, preventing premature destruction of the notification object. However, the change impacts a critical part of the notification handling logic, which is central to Electron's cross-platform behavior on Linux. While it does not affect the broader system architecture, it requires careful consideration of object lifecycle and signal handling to avoid introducing new bugs.\n\n3. **Number of Technical Concepts**: Solving this problem requires a deep understanding of several concepts: (a) C++ memory management and object lifecycle in the context of Electron's notification system, (b) GLib signal handling (specifically how libnotify emits signals like \"closed\"), (c) the behavior of libnotify in portal environments, and (d) Electron's internal architecture for notifications. These concepts are moderately complex and require familiarity with both Electron's codebase and Linux-specific libraries.\n\n4. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the nature of the bug (a crash during notification closure) implies potential issues with concurrent signal handling, different libnotify versions, or non-portal environments. The code change adds logic to handle the dismissal state, but it does not address broader error conditions (e.g., what happens if `notify_notification_close` fails for other reasons). Implementing a robust solution may require additional error handling and testing across various environments, increasing the difficulty.\n\nOverall, this problem is hard because it demands a nuanced understanding of Electron's notification system, Linux-specific libraries, and signal handling intricacies. While the code change itself is small, the potential for subtle bugs and the need to validate the fix across different environments elevate the difficulty. It falls short of \"Very Hard\" (0.8-1.0) because it does not involve system-level redesign or advanced domain-specific knowledge beyond the Electron and libnotify ecosystems.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Unit tests fail under `lldb` supervision\n### Tested versions\n\na210fe6dbd27cc01bffacb0ce2816e0cf303af5e / 4.0+\n\n### System information\n\nGodot v4.4.1.stable - macOS Sequoia (15.3.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M1 Max (Apple7) - Apple M1 Max (10 threads)\n\n### Issue description\n\nWhen using `lldb`, `test_os.h` fails `[OS] Execute`.\nThis is a regression from https://github.com/godotengine/godot/pull/42069 (4.0), cc @Calinou.\n\n### Steps to reproduce\n\n1. Be on macOS (may fail on linux too)\n2. run  `❯ lldb bin/godot.macos.editor.arm64 -- --test`\n3. run `run`\n4. Observe the error:\n\n```\n./tests/core/os/test_os.h:199: ERROR: CHECK( exit_code == 0 ) is NOT correct!\n  values: CHECK( 230 == 0 )\n  logged: Running the command `sh -c \"ls > /dev/null\"` returns a zero (successful) exit code.\n\nProcess 42405 stopped\n* thread #1, queue = 'com.apple.main-thread', stop reason = EXC_BREAKPOINT (code=1, subcode=0x1005063b0)\n    frame #0: 0x00000001005063b0 godot.macos.editor.arm64.master`TestOS::DOCTEST_ANON_FUNC_4825() at test_os.h:197:2 [opt]\n   194          CHECK_MESSAGE(\n   195                          err == OK,\n   196                          \"(Running the command `sh -c \\\"ls > /dev/null\\\"` returns the expected Godot error code (OK).\");\n-> 197          CHECK_MESSAGE(\n   198                          exit_code == 0,\n   199                          \"Running the command `sh -c \\\"ls > /dev/null\\\"` returns a zero (successful) exit code.\");\n   200  #endif\nTarget 0: (godot.macos.editor.arm64.master) stopped.\nwarning: godot.macos.editor.arm64.master was compiled with optimization - stepping may behave oddly; variables may not be available.\n```\n\nThe rest of the unit tests run through, so deleting the test is a temporary fix.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/drivers/unix/os_unix.cpp b/drivers/unix/os_unix.cpp\nindex d3e4ca92defb..10f8b0ba38a3 100644\n--- a/drivers/unix/os_unix.cpp\n+++ b/drivers/unix/os_unix.cpp\n@@ -805,6 +805,57 @@ Dictionary OS_Unix::execute_with_pipe(const String &p_path, const List<String> &\n #endif\n }\n \n+int OS_Unix::_wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options) {\n+\twhile (true) {\n+\t\tif (waitpid(p_pid, r_status, p_options) != -1) {\n+\t\t\t// Thread exited normally.\n+\t\t\treturn 0;\n+\t\t}\n+\t\tconst int error = errno;\n+\t\tif (error == EINTR) {\n+\t\t\t// We're in a debugger, should call waitpid again.\n+\t\t\t// See https://stackoverflow.com/a/45472920/730797.\n+\t\t\tcontinue;\n+\t\t}\n+\t\treturn error;\n+\t}\n+}\n+\n+bool OS_Unix::_check_pid_is_running(const pid_t p_pid, int *r_status) const {\n+\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n+\n+\tif (pi && !pi->is_running) {\n+\t\t// Can return cached value.\n+\t\tif (r_status) {\n+\t\t\t*r_status = pi->exit_code;\n+\t\t}\n+\t\treturn false;\n+\t}\n+\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(p_pid, &status, WNOHANG);\n+\tif (result == 0) {\n+\t\t// Thread is still running.\n+\t\treturn true;\n+\t}\n+\n+\tERR_FAIL_COND_V_MSG(result == -1, false, vformat(\"Thread %d exited with errno: %d\", (int)p_pid, errno));\n+\t// Thread exited normally.\n+\n+\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n+\n+\tif (pi) {\n+\t\tpi->is_running = false;\n+\t\tpi->exit_code = status;\n+\t}\n+\n+\tif (r_status) {\n+\t\t*r_status = status;\n+\t}\n+\n+\treturn false;\n+}\n+\n Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, String *r_pipe, int *r_exitcode, bool read_stderr, Mutex *p_pipe_mutex, bool p_open_console) {\n #ifdef __EMSCRIPTEN__\n \t// Don't compile this code at all to avoid undefined references.\n@@ -870,12 +921,12 @@ Error OS_Unix::execute(const String &p_path, const List<String> &p_arguments, St\n \t\traise(SIGKILL);\n \t}\n \n-\tint status;\n-\twaitpid(pid, &status, 0);\n+\tint status = 0;\n+\tconst int result = _wait_for_pid_completion(pid, &status, 0);\n \tif (r_exitcode) {\n \t\t*r_exitcode = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n \t}\n-\treturn OK;\n+\treturn result ? FAILED : OK;\n #endif\n }\n \n@@ -929,7 +980,7 @@ Error OS_Unix::kill(const ProcessID &p_pid) {\n \tif (!ret) {\n \t\t//avoid zombie process\n \t\tint st;\n-\t\t::waitpid(p_pid, &st, 0);\n+\t\t_wait_for_pid_completion(p_pid, &st, 0);\n \t}\n \treturn ret ? ERR_INVALID_PARAMETER : OK;\n }\n@@ -940,42 +991,19 @@ int OS_Unix::get_process_id() const {\n \n bool OS_Unix::is_process_running(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n-\n-\tif (pi && !pi->is_running) {\n-\t\treturn false;\n-\t}\n-\n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn false;\n-\t}\n-\n-\treturn true;\n+\treturn _check_pid_is_running(p_pid, nullptr);\n }\n \n int OS_Unix::get_process_exit_code(const ProcessID &p_pid) const {\n \tMutexLock lock(process_map_mutex);\n-\tconst ProcessInfo *pi = process_map->getptr(p_pid);\n \n-\tif (pi && !pi->is_running) {\n-\t\treturn pi->exit_code;\n+\tint exit_code = 0;\n+\tif (_check_pid_is_running(p_pid, &exit_code)) {\n+\t\t// Thread is still running\n+\t\treturn -1;\n \t}\n \n-\tint status = 0;\n-\tif (waitpid(p_pid, &status, WNOHANG) != 0) {\n-\t\tstatus = WIFEXITED(status) ? WEXITSTATUS(status) : status;\n-\t\tif (pi) {\n-\t\t\tpi->is_running = false;\n-\t\t\tpi->exit_code = status;\n-\t\t}\n-\t\treturn status;\n-\t}\n-\treturn -1;\n+\treturn exit_code;\n }\n \n String OS_Unix::get_locale() const {\ndiff --git a/drivers/unix/os_unix.h b/drivers/unix/os_unix.h\nindex 8fde52b5ff00..febc7c79cd89 100644\n--- a/drivers/unix/os_unix.h\n+++ b/drivers/unix/os_unix.h\n@@ -71,6 +71,9 @@ class OS_Unix : public OS {\n \tvoid _load_iconv();\n #endif\n \n+\tstatic int _wait_for_pid_completion(const pid_t p_pid, int *r_status, int p_options);\n+\tbool _check_pid_is_running(const pid_t p_pid, int *r_status) const;\n+\n protected:\n \t// UNIX only handles the core functions.\n \t// inheriting platforms under unix (eg. X11) should handle the rest\n", "instance_id": "godotengine__godot-105114", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: unit tests fail under `lldb` supervision on macOS (and potentially Linux) due to a specific test in `test_os.h` failing when executing a command. It provides detailed steps to reproduce the issue, including the exact error message and context about the failing test. Additionally, it references a related regression from a previous pull request, which adds useful context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly clarify the root cause of the failure under `lldb` (e.g., whether it's a debugger-specific behavior or a broader issue with process handling). It also lacks explicit mention of expected behavior beyond passing the test and does not discuss potential edge cases or constraints (e.g., specific `lldb` versions or system configurations). While a temporary fix (deleting the test) is mentioned, the desired permanent solution is implied but not detailed. Overall, the statement is valid and mostly clear but misses some minor details that could aid in fully understanding the issue without additional investigation.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is moderate, involving modifications to process handling logic in `os_unix.cpp` and `os_unix.h`, specifically around how processes are executed and monitored using `waitpid`. The changes are localized to a single module but require a deep understanding of UNIX process management (e.g., handling `EINTR` signals in debuggers, interpreting `waitpid` return values, and managing process status). Second, the technical concepts involved are moderately complex, including low-level system calls, signal handling, and debugger-specific behavior (e.g., `EINTR` interruptions under `lldb`), which require familiarity with UNIX internals and debugging environments. Third, the problem impacts a critical part of the system (process execution in the Godot engine), necessitating careful consideration of side effects and compatibility across platforms (macOS and potentially Linux). Fourth, while the problem statement does not explicitly mention edge cases, the code changes introduce logic to handle interruptions (`EINTR`) and non-blocking checks (`WNOHANG`), indicating a need to manage subtle error conditions and ensure robustness in a debugger context. Overall, solving this requires a solid grasp of system programming and the ability to navigate nuanced interactions between the application and debugging tools, justifying a difficulty score of 0.65. It is not \"Very Hard\" as it does not involve architectural redesign or highly specialized domain knowledge beyond UNIX systems programming.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Layout Mode becomes `2` when parent type is changed\n### Tested versions\n\n4.5 dev1\nProbably earlier too\n\n### System information\n\nW10\n\n### Issue description\n\nWhen a Control node is under a Container and the Container is changed to Control, the child's Layout Mode changes to `2` (which is Container, but without name?)\n\nhttps://github.com/user-attachments/assets/f0bb6975-4a6a-4516-92b1-93e795917629\n\n### Steps to reproduce\n\n1. Add a Container node\n2. Add a Control as its child\n3. Change Type of the Container to Control\n4. Check the Layout Mode of its child\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/scene/gui/control.cpp b/scene/gui/control.cpp\nindex a64de8fb3c5d..57bc748bfe90 100644\n--- a/scene/gui/control.cpp\n+++ b/scene/gui/control.cpp\n@@ -481,9 +481,9 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Validate which positioning properties should be displayed depending on the parent and the layout mode.\n-\tNode *parent_node = get_parent_control();\n-\tif (!parent_node) {\n-\t\t// If there is no parent, display both anchor and container options.\n+\tControl *parent_control = get_parent_control();\n+\tif (!parent_control) {\n+\t\t// If there is no parent control, display both anchor and container options.\n \n \t\t// Set the layout mode to be disabled with the proper value.\n \t\tif (p_property.name == \"layout_mode\") {\n@@ -496,7 +496,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\tif (!use_custom_anchors && (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\"))) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \t\t}\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\t// If the parent is a container, display only container-related properties.\n \t\tif (p_property.name.begins_with(\"anchor_\") || p_property.name.begins_with(\"offset_\") || p_property.name.begins_with(\"grow_\") || p_property.name == \"anchors_preset\") {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_DEFAULT;\n@@ -508,7 +508,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\tp_property.usage |= PROPERTY_USAGE_READ_ONLY;\n \t\t} else if (p_property.name == \"size_flags_horizontal\" || p_property.name == \"size_flags_vertical\") {\n \t\t\t// Filter allowed size flags based on the parent container configuration.\n-\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_node);\n+\t\t\tContainer *parent_container = Object::cast_to<Container>(parent_control);\n \t\t\tVector<int> size_flags;\n \t\t\tif (p_property.name == \"size_flags_horizontal\") {\n \t\t\t\tsize_flags = parent_container->get_allowed_size_flags_horizontal();\n@@ -548,7 +548,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t\t\t}\n \t\t}\n \t} else {\n-\t\t// If the parent is NOT a container or not a control at all, display only anchoring-related properties.\n+\t\t// If the parent is a non-container control, display only anchoring-related properties.\n \t\tif (p_property.name.begins_with(\"size_flags_\")) {\n \t\t\tp_property.usage ^= PROPERTY_USAGE_EDITOR;\n \n@@ -570,7 +570,7 @@ void Control::_validate_property(PropertyInfo &p_property) const {\n \t}\n \n \t// Disable the property if it's managed by the parent container.\n-\tif (!Object::cast_to<Container>(parent_node)) {\n+\tif (!Object::cast_to<Container>(parent_control)) {\n \t\treturn;\n \t}\n \tbool property_is_managed_by_container = false;\n@@ -905,11 +905,11 @@ void Control::_update_layout_mode() {\n }\n \n Control::LayoutMode Control::_get_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n@@ -918,20 +918,25 @@ Control::LayoutMode Control::_get_layout_mode() const {\n \t\treturn LayoutMode::LAYOUT_MODE_ANCHORS;\n \t}\n \n-\t// Otherwise fallback on what's stored.\n-\treturn data.stored_layout_mode;\n+\t// Only position/anchors modes are valid for non-container control parent.\n+\tif (data.stored_layout_mode == LayoutMode::LAYOUT_MODE_POSITION || data.stored_layout_mode == LayoutMode::LAYOUT_MODE_ANCHORS) {\n+\t\treturn data.stored_layout_mode;\n+\t}\n+\n+\t// Otherwise fallback to position mode.\n+\treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n Control::LayoutMode Control::_get_default_layout_mode() const {\n-\tNode *parent_node = get_parent_control();\n+\tControl *parent_control = get_parent_control();\n \t// In these modes the property is read-only.\n-\tif (!parent_node) {\n+\tif (!parent_control) {\n \t\treturn LayoutMode::LAYOUT_MODE_UNCONTROLLED;\n-\t} else if (Object::cast_to<Container>(parent_node)) {\n+\t} else if (Object::cast_to<Container>(parent_control)) {\n \t\treturn LayoutMode::LAYOUT_MODE_CONTAINER;\n \t}\n \n-\t// Otherwise fallback on the position mode.\n+\t// Otherwise fallback to the position mode.\n \treturn LayoutMode::LAYOUT_MODE_POSITION;\n }\n \n", "instance_id": "godotengine__godot-104614", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when a Container node is changed to a Control node, the child node's Layout Mode unexpectedly changes to '2' (interpreted as Container mode without a name). The steps to reproduce are provided, which helps in understanding the context and replicating the issue. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what the expected behavior should be (e.g., what should the Layout Mode be after the parent type change?). Additionally, there are no mentions of specific edge cases or constraints that might affect the behavior, such as different types of Control or Container nodes or hierarchical structures. While a visual asset is referenced, it is not accessible in this context, which slightly reduces clarity. Overall, the statement is valid and mostly clear but lacks some critical details about expected outcomes and edge cases.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes is relatively focused, primarily within a single file (control.cpp), and involves modifications to a few functions related to layout mode handling. The changes do not appear to impact the broader system architecture significantly, as they are localized to logic around parent-child relationships and layout mode determination. However, understanding the codebase requires familiarity with specific technical concepts, such as the Godot engine's node hierarchy, the distinction between Control and Container nodes, and the layout mode system (e.g., LAYOUT_MODE_CONTAINER, LAYOUT_MODE_POSITION). The code changes also involve type casting and conditional logic based on parent node types, which adds a layer of complexity. Additionally, while the problem statement does not explicitly mention edge cases, the code modifications suggest a need to handle scenarios where a parent is neither a Container nor a Control, or where stored layout modes are invalid, requiring careful validation and fallback logic. Overall, solving this requires a moderate understanding of the domain (Godot engine GUI system) and careful modification of existing logic, placing it at the lower end of the medium difficulty range (0.45).", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "NavigationRegion2D visible even though not enabled in Debug\n### Tested versions\n\nv4.4.stable.steam.4c311cbee\n\n### System information\n\nWindows 11 - Godot Engine v4.4.stable.steam.4c311cbee\n\n### Issue description\n\nIf you enable the option Debug > Visible Avoidance, the navigation mesh will also become visible (regardless of whether Visible Navigation is enabled). This was not the case in previous versions.\n\n### Steps to reproduce\n\nCheck Debug > Visible Avoidance\n\n### Minimal reproduction project (MRP)\n\n[new-game.zip](https://github.com/user-attachments/files/19086046/new-game.zip)\n", "patch": "diff --git a/scene/2d/navigation_region_2d.cpp b/scene/2d/navigation_region_2d.cpp\nindex 365d5ba4f68e..ef83027fa0c4 100644\n--- a/scene/2d/navigation_region_2d.cpp\n+++ b/scene/2d/navigation_region_2d.cpp\n@@ -181,7 +181,7 @@ void NavigationRegion2D::_notification(int p_what) {\n \n \t\tcase NOTIFICATION_DRAW: {\n #ifdef DEBUG_ENABLED\n-\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || NavigationServer2D::get_singleton()->get_debug_enabled()) && navigation_polygon.is_valid()) {\n+\t\t\tif (is_inside_tree() && (Engine::get_singleton()->is_editor_hint() || (NavigationServer2D::get_singleton()->get_debug_enabled() && NavigationServer2D::get_singleton()->get_debug_navigation_enabled())) && navigation_polygon.is_valid()) {\n \t\t\t\t_update_debug_mesh();\n \t\t\t\t_update_debug_edge_connections_mesh();\n \t\t\t\t_update_debug_baking_rect();\n", "instance_id": "godotengine__godot-103784", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when the \"Debug > Visible Avoidance\" option is enabled in Godot Engine v4.4, the navigation mesh becomes visible even if \"Visible Navigation\" is not enabled, which differs from previous behavior. The statement includes the tested version, system information, steps to reproduce, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior (e.g., should the navigation mesh remain hidden unless \"Visible Navigation\" is enabled?) or provide details on potential edge cases or related debug settings that might interact with this behavior. Additionally, the problem statement does not clarify the impact or priority of this issue (e.g., is it purely cosmetic, or does it affect functionality?). Despite these minor gaps, the issue is valid and understandable, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Let's break it down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The provided code change is minimal and confined to a single line in a single file (`navigation_region_2d.cpp`). It modifies a conditional statement in the `NOTIFICATION_DRAW` block to include an additional check (`NavigationServer2D::get_singleton()->get_debug_navigation_enabled()`). This change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is trivial, involving only a logical condition update.\n\n2. **Number of Technical Concepts**: Solving this issue requires a basic understanding of the Godot Engine's debug rendering logic and the `NavigationServer2D` singleton's API. The concepts involved are straightforward—conditional logic and familiarity with debug flags in the engine. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic game engine debugging are needed. For a developer familiar with Godot or similar engines, this is a simple task.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not mention specific edge cases, and the code change does not introduce or modify error handling logic. The modification is purely about toggling visibility based on debug settings, and there are no apparent complex edge cases (e.g., performance issues or conflicts with other debug features) indicated in the diff or problem description. If edge cases exist (e.g., interactions with other debug settings), they are not highlighted, and the fix appears self-contained.\n\n4. **Overall Complexity**: The task involves understanding a small part of the rendering logic for debug visualization in Godot and applying a simple fix by adding a condition to respect the \"Visible Navigation\" debug setting. This does not require deep knowledge of the codebase beyond the immediate context of the `NavigationRegion2D` class and its interaction with `NavigationServer2D`. The fix is localized and does not have broader implications for performance or architecture.\n\nGiven these factors, I assign a difficulty score of 0.25, as the problem requires minimal code changes, basic understanding of the relevant code logic, and no significant handling of edge cases or complex interactions. It is a straightforward bug fix that a junior or mid-level developer with some familiarity with the codebase could handle with ease.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Creating render pipeline for a `RDShaderFile` that doesn't have vertex shader causes crash\n### Tested versions\n\n4.4.rc3\n\n### System information\n\nGodot v4.4.rc.mono - EndeavourOS  SMP PREEMPT_DYNAMIC Sat, 22 Feb 2025 00:37:05 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Mobile) - integrated AMD Radeon Graphics (RADV RENOIR) - AMD Ryzen 7 4800U with Radeon Graphics (16 threads)\n\n### Issue description\n\nIf a glsl file only has `#[fragment]` but no `#[vertex]`, it can be successfully compiled and loaded in script. And if it is used in `RenderingDevice.render_pipeline_create`, the game will crash (if it's a tool script, the whole editor will crash).\n\n### Steps to reproduce\n\nRun the MRP, then the game crashes:\n```\nStop reason: signal SIGSEGV: address not mapped to object (fault address: 0x0)\nStop reason: signal SIGSEGV: invalid permissions for mapped object (fault address: 0x7fffa7e21fd0)\n```\nCall stack:\n```\n___lldb_unnamed_symbol2415 (@___lldb_unnamed_symbol2415:686)\n___lldb_unnamed_symbol2417 (@___lldb_unnamed_symbol2417:62)\n___lldb_unnamed_symbol2420 (@___lldb_unnamed_symbol2420:108)\nRenderingDeviceDriverVulkan::render_pipeline_create(RenderingDeviceDriver::ShaderID, RenderingDeviceDriver::VertexFormatID, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState, RenderingDeviceCommons::PipelineMultisampleState, RenderingDeviceCommons::PipelineDepthStencilState, RenderingDeviceCommons::PipelineColorBlendState, VectorView<int>, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, RenderingDeviceDriver::RenderPassID, unsigned int, VectorView<RenderingDeviceCommons::PipelineSpecializationConstant>) (/home/luo/godot/drivers/vulkan/rendering_device_driver_vulkan.cpp:5246)\nRenderingDevice::render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, RenderingDeviceCommons::PipelineRasterizationState const&, RenderingDeviceCommons::PipelineMultisampleState const&, RenderingDeviceCommons::PipelineDepthStencilState const&, RenderingDeviceCommons::PipelineColorBlendState const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, Vector<RenderingDeviceCommons::PipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:3957)\nRenderingDevice::_render_pipeline_create(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&) (/home/luo/godot/servers/rendering/rendering_device.cpp:8269)\nvoid call_with_variant_args_ret_helper<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&, 0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, Variant&, Callable::CallError&, IndexSequence<0ul, 1ul, 2ul, 3ul, 4ul, 5ul, 6ul, 7ul, 8ul, 9ul, 10ul>) (/home/luo/godot/core/variant/binder_common.h:767)\nvoid call_with_variant_args_ret_dv<__UnexistingClass, RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>(__UnexistingClass*, RID (__UnexistingClass::*)(RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&), Variant const**, int, Variant&, Callable::CallError&, Vector<Variant> const&) (/home/luo/godot/core/variant/binder_common.h:546)\nMethodBindTR<RID, RID, long, long, RenderingDeviceCommons::RenderPrimitive, Ref<RDPipelineRasterizationState> const&, Ref<RDPipelineMultisampleState> const&, Ref<RDPipelineDepthStencilState> const&, Ref<RDPipelineColorBlendState> const&, BitField<RenderingDeviceCommons::PipelineDynamicStateFlags>, unsigned int, TypedArray<RDPipelineSpecializationConstant> const&>::call(Object*, Variant const**, int, Callable::CallError&) const (/home/luo/godot/core/object/method_bind.h:524)\nGDScriptFunction::call(GDScriptInstance*, Variant const**, int, Callable::CallError&, GDScriptFunction::CallState*) (/home/luo/godot/modules/gdscript/gdscript_vm.cpp:2013)\nGDScriptInstance::callp(StringName const&, Variant const**, int, Callable::CallError&) (/home/luo/godot/modules/gdscript/gdscript.cpp:2053)\nNode::_gdvirtual__ready_call() (/home/luo/godot/scene/main/node.h:391)\nNode::_notification(int) (/home/luo/godot/scene/main/node.cpp:227)\nNode::_notificationv(int, bool) (/home/luo/godot/scene/main/node.h:49)\nCanvasItem::_notificationv(int, bool) (/home/luo/godot/scene/main/canvas_item.h:44)\nNode2D::_notificationv(int, bool) (/home/luo/godot/scene/2d/node_2d.h:37)\nObject::notification(int, bool) (/home/luo/godot/core/object/object.cpp:911)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:282)\nNode::_propagate_ready() (/home/luo/godot/scene/main/node.cpp:273)\nNode::_set_tree(SceneTree*) (/home/luo/godot/scene/main/node.cpp:3289)\n```\n\n### Minimal reproduction project (MRP)\n\n[RDShaderFileCrash.zip](https://github.com/user-attachments/files/19043836/RDShaderFileCrash.zip)\n", "patch": "diff --git a/servers/rendering/rendering_device.cpp b/servers/rendering/rendering_device.cpp\nindex 9a3e4fd9d7fa..638b529676a0 100644\n--- a/servers/rendering/rendering_device.cpp\n+++ b/servers/rendering/rendering_device.cpp\n@@ -3850,6 +3850,9 @@ RID RenderingDevice::render_pipeline_create(RID p_shader, FramebufferFormatID p_\n \tERR_FAIL_NULL_V(shader, RID());\n \tERR_FAIL_COND_V_MSG(shader->is_compute, RID(), \"Compute shaders can't be used in render pipelines\");\n \n+\t// Validate pre-raster shader. One of stages must be vertex shader or mesh shader (not implemented yet).\n+\tERR_FAIL_COND_V_MSG(!shader->stage_bits.has_flag(RDD::PIPELINE_STAGE_VERTEX_SHADER_BIT), RID(), \"Pre-raster shader (vertex shader) is not provided for pipeline creation.\");\n+\n \tFramebufferFormat fb_format;\n \t{\n \t\t_THREAD_SAFE_METHOD_\n", "instance_id": "godotengine__godot-103480", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash occurs in the Godot engine when a `RDShaderFile` lacking a vertex shader is used in `RenderingDevice.render_pipeline_create`. It provides detailed system information, steps to reproduce, a call stack, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss expected behavior or constraints for shader files (e.g., whether a vertex shader is mandatory by design or if this is an oversight). Additionally, while the crash is well-documented, there is no mention of specific edge cases beyond the absence of a vertex shader, nor any discussion of potential side effects of the proposed fix. Overall, the statement is valid and clear but lacks some minor details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4). The issue is a specific bug in the Godot engine related to shader pipeline creation, and the provided code change is a simple validation check added to `rendering_device.cpp` to ensure a vertex shader is present before proceeding with pipeline creation. Let's break this down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The modification is localized to a single file (`rendering_device.cpp`) and involves adding just a few lines of code for validation. It does not impact the broader system architecture or require changes across multiple modules. The change is minimal in terms of lines of code and does not involve complex refactoring.\n\n2. **Number of Technical Concepts**: Solving this requires a basic understanding of the Godot engine's rendering pipeline and shader handling, specifically the role of vertex shaders in render pipelines. The fix uses straightforward error checking with existing flags (`shader->stage_bits.has_flag`), which does not demand advanced language features, algorithms, or design patterns. Familiarity with C++ (used in Godot's core) and error handling macros (`ERR_FAIL_COND_V_MSG`) is sufficient, and these are not particularly complex concepts for an experienced developer.\n\n3. **Edge Cases and Error Handling**: The problem statement focuses on a specific scenario (missing vertex shader), and the code change addresses this directly with a simple error condition. There is no indication of additional edge cases or complex error handling requirements beyond this check. The fix prevents the crash by failing early with a descriptive message, which is a basic error handling approach.\n\n4. **Overall Complexity**: While the domain (game engine rendering) might seem complex, the actual fix is a small, targeted intervention that does not require deep architectural changes or advanced knowledge beyond understanding the rendering pipeline's basic requirements. It is a bug fix that involves adding a guard clause, which aligns with an \"Easy\" difficulty level.\n\nThus, a score of 0.30 reflects a problem that requires understanding some code logic and making a simple modification, fitting well within the easy range. It does not rise to a medium difficulty as it lacks complexity in scope, concepts, or edge case handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Bottom FileSystem dock does not save layout options\n### Tested versions\n\n- Reproducible in: 4.4.beta1.mono to 4.4.rc1.mono\n- Not reproducible in: 4.4.dev7.mono and earlier\n\n### System information\n\nGodot v4.4.rc1.mono - macOS Sequoia (15.3.1) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M2 Max (Apple8) - Apple M2 Max (12 threads)\n\n### Issue description\n\nThe bottom panel FileSystem dock does not save layout options (Split Mode, View items as list/thumbnails). Reopening the editor causes these layout options to be reset.\nThis issue exists only when the FileSystem dock is placed at the bottom panel, and does not exist when it is placed in any of the 8 slots on the side.\n\n### Steps to reproduce\n\nhttps://github.com/user-attachments/assets/b135bbb2-69f4-45ee-9ada-6a11bcfeb299\n\n1. Open any project.\n2. Move the FileSystem dock to the bottom panel.\n3. In the FileSystem dock, change Split Mode to top/bottom, and set View items as a list.\n4. Close Godot and reopen the project.\n5. Notice the FileSystem dock layout gets reset.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_dock_manager.cpp b/editor/editor_dock_manager.cpp\nindex 51c15f3db911..32269f91a109 100644\n--- a/editor/editor_dock_manager.cpp\n+++ b/editor/editor_dock_manager.cpp\n@@ -547,10 +547,10 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tControl *dock = dock_map[name];\n-\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (!all_docks[dock].enabled) {\n \t\t\t\t// Don't open disabled docks.\n+\t\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \t\t\t\tcontinue;\n \t\t\t}\n \t\t\tbool at_bottom = false;\n@@ -563,6 +563,7 @@ void EditorDockManager::load_docks_from_config(Ref<ConfigFile> p_layout, const S\n \t\t\t} else if (i >= 0) {\n \t\t\t\t_move_dock(dock, dock_slot[i], 0);\n \t\t\t}\n+\t\t\tdock->call(SNAME(\"_load_layout_from_config\"), p_layout, p_section);\n \n \t\t\tif (closed_docks.has(name)) {\n \t\t\t\t_move_dock(dock, closed_dock_parent);\n", "instance_id": "godotengine__godot-103266", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the specific versions of the software where the bug is reproducible, the system information, and the steps to reproduce the issue. The goal is evident: the FileSystem dock at the bottom panel does not save layout options, and this behavior needs to be fixed. The steps to reproduce are well-documented with a reference to a visual asset, and the issue's scope is narrowed down to a specific placement of the dock (bottom panel). However, there are minor ambiguities, such as the lack of explicit mention of expected behavior for edge cases (e.g., what should happen if the configuration file is corrupted or missing) and no detailed specification of the desired output format or constraints for the fix. Additionally, while the problem is clear, it does not provide a minimal reproduction project (MRP), which could have further clarified the context for developers unfamiliar with the codebase. Hence, I rate the clarity as \"Mostly Clear\" with a score of 2.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" category with a score of 0.35. Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code changes are minimal and localized to a single file (`editor_dock_manager.cpp`). The modification involves moving a function call (`_load_layout_from_config`) to ensure it is executed regardless of whether the dock is enabled or disabled. This change does not impact the broader system architecture and is confined to a specific logic block related to loading dock configurations. The amount of code change is small, with only a few lines altered.\n\n2. **Number of Technical Concepts:** Solving this issue requires a basic understanding of the Godot engine's editor codebase, specifically how docks are managed and how configuration loading works. The developer needs to understand the purpose of the `_load_layout_from_config` method and the flow of the `load_docks_from_config` function. No advanced language features, complex algorithms, or design patterns are involved. The concepts are relatively straightforward for someone familiar with C++ and the Godot engine.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, such as invalid or missing configuration data, and the code changes do not introduce new error handling logic. However, a developer might need to consider whether calling `_load_layout_from_config` in all cases could lead to unintended side effects (e.g., loading invalid configurations for disabled docks). These edge cases are not complex and can likely be handled with minimal additional effort if needed.\n\n4. **Overall Complexity:** The fix is a simple adjustment to the order of operations in the code, requiring only a basic understanding of the existing logic. It does not involve deep architectural changes, performance optimizations, or intricate domain-specific knowledge beyond the Godot editor's dock management system. The problem is a bug fix rather than a feature implementation or refactoring, which keeps the difficulty low.\n\nGiven these factors, I assess the difficulty as 0.35, indicating an \"Easy\" problem that requires understanding some code logic and making a simple modification. It is slightly above the lowest end of the \"Easy\" range (0.2-0.4) due to the need for familiarity with the Godot codebase, which might pose a minor learning curve for someone new to the project.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4 Beta 3] Embedded game window lags when changing positions and scale.\n### Tested versions\n\n- Reproductible in: v4.4.beta3.official [06acfccf8]\n\n### System information\n\nGodot v4.4.beta3 - Fedora Linux 41 (KDE Plasma) on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 4070 (nvidia; 565.77) - AMD Ryzen 9 7900X 12-Core Processor (24 threads)\n\n### Issue description\n\nWhen embedding the game window (either on a floating workspace or on the editor \"Game\" tab) and moving the \"main\" window, the embedded window will lag behind. This did not happen in earlier versions of the engine and I don't know if it happens on Windows.\n\nBETA 2\n\nhttps://github.com/user-attachments/assets/1e1b4f09-66a6-49bb-aee1-3af18d63956d\n\n---\n\nBETA 3\n\nhttps://github.com/user-attachments/assets/c5c0705d-1ae6-49c4-82ec-fa4ead231005\n\n### Steps to reproduce\n\n- Run a project on 4.4.beta3 with `Embed game on Next Play` enabled;\n- Move / scale the main window that's holding the embedded window around.\n\n### Minimal reproduction project (MRP)\n\nNot including an MRP since this can be replicated with an empty project.\n", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 72c87bfc1c6d..17c6ede2d248 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -40,6 +40,12 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\tcase NOTIFICATION_ENTER_TREE: {\n \t\t\twindow = get_window();\n \t\t} break;\n+\t\tcase NOTIFICATION_PROCESS: {\n+\t\t\tif (updated_embedded_process_queued) {\n+\t\t\t\tupdated_embedded_process_queued = false;\n+\t\t\t\t_update_embedded_process();\n+\t\t\t}\n+\t\t} break;\n \t\tcase NOTIFICATION_DRAW: {\n \t\t\t_draw();\n \t\t} break;\n@@ -179,6 +185,7 @@ void EmbeddedProcess::embed_process(OS::ProcessID p_pid) {\n \tstart_embedding_time = OS::get_singleton()->get_ticks_msec();\n \tembedding_grab_focus = has_focus();\n \ttimer_update_embedded_process->start();\n+\tset_process(true);\n \tset_notify_transform(true);\n \n \t// Attempt to embed the process, but if it has just started and the window is not ready yet,\n@@ -196,6 +203,7 @@ void EmbeddedProcess::reset() {\n \tembedding_grab_focus = false;\n \ttimer_embedding->stop();\n \ttimer_update_embedded_process->stop();\n+\tset_process(false);\n \tset_notify_transform(false);\n \tqueue_redraw();\n }\n@@ -251,11 +259,6 @@ void EmbeddedProcess::_timer_update_embedded_process_timeout() {\n \t\t\tqueue_update_embedded_process();\n \t\t}\n \t}\n-\n-\tif (updated_embedded_process_queued) {\n-\t\tupdated_embedded_process_queued = false;\n-\t\t_update_embedded_process();\n-\t}\n }\n \n void EmbeddedProcess::_update_embedded_process() {\n", "instance_id": "godotengine__godot-102618", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the embedded game window lags when the main window is moved or scaled in Godot v4.4.beta3, which is a regression from earlier versions. It provides specific version details, system information, steps to reproduce, and visual evidence through linked assets. However, there are minor ambiguities and missing details. For instance, it does not explicitly state the expected behavior (though it can be inferred as \"no lag\"), and it lacks information on whether this issue occurs across all platforms or is specific to certain configurations (e.g., Wayland on Linux). Additionally, edge cases or specific conditions under which the lag is more pronounced are not mentioned. Overall, the problem is understandable and reproducible, but it could benefit from more precise expectations and constraints.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes is relatively localized to a single file (`embedded_process.cpp`) and involves modifications to the event handling and process update logic in the Godot engine. The changes include moving the update logic from a timer-based approach to a per-frame process notification, which requires understanding the engine's notification system and how embedded windows are managed. This indicates a moderate level of complexity in terms of codebase interaction.\n\nSecond, the technical concepts involved include familiarity with Godot's internal architecture (specifically, its notification and rendering systems), C++ programming, and potentially platform-specific windowing behaviors (e.g., Wayland on Linux). While these concepts are not extremely advanced, they do require a solid understanding of game engine internals, which may not be trivial for someone unfamiliar with Godot's codebase.\n\nThird, the amount of code change is small (a few lines added or moved), and it does not appear to impact the broader system architecture significantly. However, the change could have subtle implications on performance or synchronization between the main and embedded windows, which adds a layer of complexity.\n\nFinally, while the problem statement does not explicitly mention edge cases, the nature of the issue (lag in window positioning/scaling) suggests potential challenges in handling different window states, user interactions, or platform-specific quirks. Error handling does not seem to be a major focus of the provided code changes, but ensuring the update logic does not introduce new issues (e.g., excessive redraws or missed updates) requires careful consideration.\n\nOverall, I rate this as a medium difficulty problem (0.45) because it requires a moderate understanding of the Godot engine's internals and careful handling of update logic, but it does not involve extensive refactoring, complex algorithms, or deep system-level changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4.dev7] The `Default Environment` setting is reset after the \"cold\" project loading (`res://` | `uid://` issue)\n### Tested versions\n\n- reproducible in 4.4.dev7 (maybe 4.4.x)\n- not reproducible: 4.3.stable\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - 12th Gen Intel(R) Core(TM) i5-12400 (12 threads)\n\n### Issue description\n\nThe default environment setting (`rendering/environment/defaults/default_environment`) is reset after the **\"cold\"** project loading (deleting the `.godot` folder and loading project for the first time). However, it stays on place if it was saved as `res://...` path, not as `uid://...` value. Seems like `uid` related bug.\n\n### Steps to reproduce\n\nSteps for 4.4.dev7: \n- create new project;\n- create an `Environment` asset;\n- set it as default in `Project Settings`;\n- close the project;\n- delete the `.godot` folder;\n- open the project.\n\nNot reproduced with 4.3 -> 4.4 migration because its value will still be saved as `res://`, not `uid://`.\n\n### Minimal reproduction project (MRP)\n\n[test.zip](https://github.com/user-attachments/files/18270863/test.zip)\n\n", "patch": "diff --git a/core/io/resource_uid.cpp b/core/io/resource_uid.cpp\nindex 8a8c86087d45..a73adf9d7478 100644\n--- a/core/io/resource_uid.cpp\n+++ b/core/io/resource_uid.cpp\n@@ -154,6 +154,19 @@ String ResourceUID::get_id_path(ID p_id) const {\n \tERR_FAIL_COND_V_MSG(p_id == INVALID_ID, String(), \"Invalid UID.\");\n \tMutexLock l(mutex);\n \tconst ResourceUID::Cache *cache = unique_ids.getptr(p_id);\n+\n+#if TOOLS_ENABLED\n+\t// On startup, the scan_for_uid_on_startup callback should be set and will\n+\t// execute EditorFileSystem::scan_for_uid, which scans all project files\n+\t// to reload the UID cache before the first scan.\n+\t// Note: EditorFileSystem::scan_for_uid sets scan_for_uid_on_startup to nullptr\n+\t//       once the first scan_for_uid is complete.\n+\tif (!cache && scan_for_uid_on_startup) {\n+\t\tscan_for_uid_on_startup();\n+\t\tcache = unique_ids.getptr(p_id);\n+\t}\n+#endif\n+\n \tERR_FAIL_COND_V_MSG(!cache, String(), vformat(\"Unrecognized UID: \\\"%s\\\".\", id_to_text(p_id)));\n \tconst CharString &cs = cache->cs;\n \treturn String::utf8(cs.ptr());\ndiff --git a/core/io/resource_uid.h b/core/io/resource_uid.h\nindex 6d96953fcc1d..2912168dcb4b 100644\n--- a/core/io/resource_uid.h\n+++ b/core/io/resource_uid.h\n@@ -37,6 +37,8 @@\n \n class FileAccess;\n \n+typedef void (*ResourceUIDScanForUIDOnStartup)();\n+\n class ResourceUID : public Object {\n \tGDCLASS(ResourceUID, Object)\n public:\n@@ -63,6 +65,8 @@ class ResourceUID : public Object {\n \tstatic void _bind_methods();\n \n public:\n+\tinline static ResourceUIDScanForUIDOnStartup scan_for_uid_on_startup = nullptr;\n+\n \tString id_to_text(ID p_id) const;\n \tID text_to_id(const String &p_text) const;\n \ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex 2d10e4305eaa..4c5663c3b99f 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -48,6 +48,9 @@\n #include \"scene/resources/packed_scene.h\"\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n+int EditorFileSystem::nb_files_total = 0;\n+EditorFileSystem::ScannedDirectory *EditorFileSystem::first_scan_root_dir = nullptr;\n+\n //the name is the version, to keep compatibility with different versions of Godot\n #define CACHE_FILE_NAME \"filesystem_cache10\"\n \n@@ -237,16 +240,72 @@ EditorFileSystem::ScannedDirectory::~ScannedDirectory() {\n \t}\n }\n \n-void EditorFileSystem::_first_scan_filesystem() {\n-\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n+void EditorFileSystem::_load_first_scan_root_dir() {\n \tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\n \tfirst_scan_root_dir = memnew(ScannedDirectory);\n \tfirst_scan_root_dir->full_path = \"res://\";\n+\n+\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+}\n+\n+void EditorFileSystem::scan_for_uid() {\n+\t// Load file structure into memory.\n+\t_load_first_scan_root_dir();\n+\n+\t// Load extensions for which an .import should exists.\n+\tList<String> extensionsl;\n+\tHashSet<String> import_extensions;\n+\tResourceFormatImporter::get_singleton()->get_recognized_extensions(&extensionsl);\n+\tfor (const String &E : extensionsl) {\n+\t\timport_extensions.insert(E);\n+\t}\n+\n+\t// Scan the file system to load uid.\n+\t_scan_for_uid_directory(first_scan_root_dir, import_extensions);\n+\n+\t// It's done, resetting the callback method to prevent a second scan.\n+\tResourceUID::scan_for_uid_on_startup = nullptr;\n+}\n+\n+void EditorFileSystem::_scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions) {\n+\tfor (ScannedDirectory *scan_sub_dir : p_scan_dir->subdirs) {\n+\t\t_scan_for_uid_directory(scan_sub_dir, p_import_extensions);\n+\t}\n+\n+\tfor (const String &scan_file : p_scan_dir->files) {\n+\t\tconst String ext = scan_file.get_extension().to_lower();\n+\n+\t\tif (ext == \"uid\" || ext == \"import\") {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tconst String path = p_scan_dir->full_path.path_join(scan_file);\n+\t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n+\t\tif (p_import_extensions.has(ext)) {\n+\t\t\tif (FileAccess::exists(path + \".import\")) {\n+\t\t\t\tuid = ResourceFormatImporter::get_singleton()->get_resource_uid(path);\n+\t\t\t}\n+\t\t} else {\n+\t\t\tuid = ResourceLoader::get_resource_uid(path);\n+\t\t}\n+\n+\t\tif (uid != ResourceUID::INVALID_ID) {\n+\t\t\tif (!ResourceUID::get_singleton()->has_id(uid)) {\n+\t\t\t\tResourceUID::get_singleton()->add_id(uid, path);\n+\t\t\t}\n+\t\t}\n+\t}\n+}\n+\n+void EditorFileSystem::_first_scan_filesystem() {\n+\tEditorProgress ep = EditorProgress(\"first_scan_filesystem\", TTR(\"Project initialization\"), 5);\n \tHashSet<String> existing_class_names;\n \tHashSet<String> extensions;\n \n-\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n-\tnb_files_total = _scan_new_dir(first_scan_root_dir, d);\n+\tif (!first_scan_root_dir) {\n+\t\tep.step(TTR(\"Scanning file structure...\"), 0, true);\n+\t\t_load_first_scan_root_dir();\n+\t}\n \n \t// Preloading GDExtensions file extensions to prevent looping on all the resource loaders\n \t// for each files in _first_scan_process_scripts.\n@@ -440,6 +499,7 @@ void EditorFileSystem::_scan_filesystem() {\n \t\tsd = first_scan_root_dir;\n \t\t// Will be updated on scan.\n \t\tResourceUID::get_singleton()->clear();\n+\t\tResourceUID::scan_for_uid_on_startup = nullptr;\n \t\tprocessed_files = memnew(HashSet<String>());\n \t} else {\n \t\tRef<DirAccess> d = DirAccess::create(DirAccess::ACCESS_RESOURCES);\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 5b78b86a3f3f..4f9302e045f8 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -182,7 +182,7 @@ class EditorFileSystem : public Node {\n \tstatic void _thread_func(void *_userdata);\n \n \tEditorFileSystemDirectory *new_filesystem = nullptr;\n-\tScannedDirectory *first_scan_root_dir = nullptr;\n+\tstatic ScannedDirectory *first_scan_root_dir;\n \n \tbool filesystem_changed_queued = false;\n \tbool scanning = false;\n@@ -192,13 +192,17 @@ class EditorFileSystem : public Node {\n \tfloat scan_total;\n \tString filesystem_settings_version_for_import;\n \tbool revalidate_import_files = false;\n-\tint nb_files_total = 0;\n+\tstatic int nb_files_total;\n \n \tvoid _notify_filesystem_changed();\n \tvoid _scan_filesystem();\n \tvoid _first_scan_filesystem();\n \tvoid _first_scan_process_scripts(const ScannedDirectory *p_scan_dir, List<String> &p_gdextension_extensions, HashSet<String> &p_existing_class_names, HashSet<String> &p_extensions);\n \n+\tstatic void _scan_for_uid_directory(const ScannedDirectory *p_scan_dir, const HashSet<String> &p_import_extensions);\n+\n+\tstatic void _load_first_scan_root_dir();\n+\n \tHashSet<String> late_update_files;\n \n \tvoid _save_late_updated_files();\n@@ -255,7 +259,7 @@ class EditorFileSystem : public Node {\n \tHashSet<String> valid_extensions;\n \tHashSet<String> import_extensions;\n \n-\tint _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n+\tstatic int _scan_new_dir(ScannedDirectory *p_dir, Ref<DirAccess> &da);\n \tvoid _process_file_system(const ScannedDirectory *p_scan_dir, EditorFileSystemDirectory *p_dir, ScanProgress &p_progress, HashSet<String> *p_processed_files);\n \n \tThread thread_sources;\n@@ -412,6 +416,8 @@ class EditorFileSystem : public Node {\n \n \tstatic bool _should_skip_directory(const String &p_path);\n \n+\tstatic void scan_for_uid();\n+\n \tvoid add_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tvoid remove_import_format_support_query(Ref<EditorFileSystemImportFormatSupportQuery> p_query);\n \tEditorFileSystem();\ndiff --git a/main/main.cpp b/main/main.cpp\nindex c65e6ba8acb4..6cd9c89fa8b7 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -3444,6 +3444,17 @@ Error Main::setup2(bool p_show_boot_logo) {\n \t// This loads global classes, so it must happen before custom loaders and savers are registered\n \tScriptServer::init_languages();\n \n+#if TOOLS_ENABLED\n+\n+\t// Setting up the callback to execute a scan for UIDs on disk when a UID\n+\t// does not exist in the UID cache on startup. This prevents invalid UID errors\n+\t// when opening a project without a UID cache file or with an invalid cache.\n+\tif (editor) {\n+\t\tResourceUID::scan_for_uid_on_startup = EditorFileSystem::scan_for_uid;\n+\t}\n+\n+#endif\n+\n \ttheme_db->initialize_theme();\n \taudio_server->load_default_bus_layout();\n \n@@ -3496,9 +3507,21 @@ void Main::setup_boot_logo() {\n \n \tif (show_logo) { //boot logo!\n \t\tconst bool boot_logo_image = GLOBAL_DEF_BASIC(\"application/boot_splash/show_image\", true);\n-\t\tconst String boot_logo_path = ResourceUID::ensure_path(GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String())).strip_edges();\n \t\tconst bool boot_logo_scale = GLOBAL_DEF_BASIC(\"application/boot_splash/fullsize\", true);\n \t\tconst bool boot_logo_filter = GLOBAL_DEF_BASIC(\"application/boot_splash/use_filter\", true);\n+\t\tString boot_logo_path = GLOBAL_DEF_BASIC(PropertyInfo(Variant::STRING, \"application/boot_splash/image\", PROPERTY_HINT_FILE, \"*.png\"), String());\n+\n+\t\t// If the UID cache is missing or invalid, it could be 'normal' for the UID to not exist in memory.\n+\t\t// It's too soon to scan the project files since the ResourceFormatImporter is not loaded yet,\n+\t\t// so to prevent printing errors, we will just skip the custom boot logo this time.\n+\t\tif (boot_logo_path.begins_with(\"uid://\")) {\n+\t\t\tconst ResourceUID::ID logo_id = ResourceUID::get_singleton()->text_to_id(boot_logo_path);\n+\t\t\tif (ResourceUID::get_singleton()->has_id(logo_id)) {\n+\t\t\t\tboot_logo_path = ResourceUID::get_singleton()->get_id_path(logo_id).strip_edges();\n+\t\t\t} else {\n+\t\t\t\tboot_logo_path = String();\n+\t\t\t}\n+\t\t}\n \n \t\tRef<Image> boot_logo;\n \n@@ -4215,7 +4238,7 @@ int Main::start() {\n \n #ifdef TOOLS_ENABLED\n \t\t\tif (editor) {\n-\t\t\t\tif (!recovery_mode && (game_path != String(GLOBAL_GET(\"application/run/main_scene\")) || !editor_node->has_scenes_in_session())) {\n+\t\t\t\tif (!recovery_mode && (game_path != ResourceUID::ensure_path(String(GLOBAL_GET(\"application/run/main_scene\"))) || !editor_node->has_scenes_in_session())) {\n \t\t\t\t\tError serr = editor_node->load_scene(local_game_path);\n \t\t\t\t\tif (serr != OK) {\n \t\t\t\t\t\tERR_PRINT(\"Failed to load scene\");\n", "instance_id": "godotengine__godot-102513", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: the default environment setting in Godot 4.4.dev7 is reset after a \"cold\" project loading due to a UID-related bug. It provides specific steps to reproduce the issue, mentions the affected versions, and includes system information and a minimal reproduction project. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what a \"cold\" project loading entails beyond deleting the `.godot` folder, nor does it clarify the expected behavior of the default environment setting after such a load. Additionally, while the issue is linked to `uid://` versus `res://` paths, there is no detailed explanation of why or how this distinction causes the reset. Edge cases or specific constraints related to different project configurations or environments are also not mentioned. Overall, the statement is valid and clear enough to understand the core issue, but it lacks some depth in technical context and edge case specification.\n", "difficulty_explanation": "\nI rate the difficulty of this problem as 0.75, placing it in the \"Hard\" category due to several factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the issue is mostly clear, solving it requires inferring the root cause of the UID-related bug, which is not fully detailed in the problem statement. Understanding why `uid://` paths fail during a cold load compared to `res://` paths involves non-trivial investigation into Godot's resource loading and UID caching mechanisms.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (`resource_uid.cpp`, `resource_uid.h`, `editor_file_system.cpp`, `editor_file_system.h`, `main.cpp`) and involve significant modifications to the resource UID handling and editor file system scanning logic. The changes impact core components of the Godot engine, such as how resources are identified and loaded at startup. This requires a deep understanding of the interactions between the editor, file system, and resource management systems. The amount of code changed is moderate but affects critical paths, increasing the risk of introducing new bugs or performance issues.\n\n3. **Number of Technical Concepts**: Solving this problem demands familiarity with several advanced concepts in the Godot engine, including:\n   - Resource UID management and caching.\n   - Editor file system initialization and scanning.\n   - Resource loading and path resolution mechanisms (`uid://` vs `res://`).\n   - Thread safety (mutex usage in `resource_uid.cpp`).\n   - Build-time conditional compilation (`TOOLS_ENABLED`).\n   Additionally, the solution involves understanding C++ language features like static members, function pointers, and memory management, as well as domain-specific knowledge of game engine architecture. These concepts are moderately to highly complex for someone not already familiar with Godot's internals.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes reveal several implicit considerations, such as handling missing or invalid UID caches, ensuring proper initialization during startup, and avoiding errors when resource paths cannot be resolved. The solution introduces logic to scan for UIDs on startup if a cache miss occurs, which could lead to performance concerns or race conditions if not handled carefully. Error handling is modified (e.g., skipping custom boot logos if UID resolution fails), indicating a need to anticipate and mitigate potential failures in resource loading.\n\nOverall, this problem requires a deep understanding of Godot's codebase architecture, particularly in resource management and editor initialization. The changes have a significant impact on how projects are loaded and could affect stability if not thoroughly tested. While not at the extreme end of difficulty (e.g., implementing a new system from scratch), it demands substantial expertise and careful consideration of side effects, justifying a score of 0.75.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Embed Game focus over modal popups\n### Tested versions\n\n- Reproductible in 4.4 beta 2 and master\n\n### System information\n\nGodot v4.4.beta2 - Windows 11 (build 26100) - Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 32.0.15.6636) - 11th Gen Intel(R) Core(TM) i5-11600KF @ 3.90GHz (12 threads)\n\n### Issue description\n\nThe embedding is enabled in the editor and the game is running. If a modal popup is visible and the use click on the game window, the game window appears in front of the modal popup. If this popup is small enough, it disappears and the editor is not available (ex: stop button).\n\nhttps://github.com/user-attachments/assets/9ce74cc1-e7f0-44e8-87b8-fc60c69519e5\n\n\n\n### Steps to reproduce\n\n- Enable Embed Game and disable Make Floating\n- Run the game\n- While inside the Game tab, display a modal popup (ex: Settings, Create node, etc...)\n- Click the game window\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/editor/plugins/embedded_process.cpp b/editor/plugins/embedded_process.cpp\nindex 1638c437125d..a348607a6e94 100644\n--- a/editor/plugins/embedded_process.cpp\n+++ b/editor/plugins/embedded_process.cpp\n@@ -67,20 +67,10 @@ void EmbeddedProcess::_notification(int p_what) {\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_IN: {\n \t\t\tapplication_has_focus = true;\n-\t\t\tif (embedded_process_was_focused) {\n-\t\t\t\tembedded_process_was_focused = false;\n-\t\t\t\t// Refocus the embedded process if it was focused when the application lost focus,\n-\t\t\t\t// but do not refocus if the embedded process is currently focused (indicating it just lost focus)\n-\t\t\t\t// or if the current window is a different popup or secondary window.\n-\t\t\t\tif (embedding_completed && current_process_id != focused_process_id && window && window->has_focus()) {\n-\t\t\t\t\tgrab_focus();\n-\t\t\t\t\tqueue_update_embedded_process();\n-\t\t\t\t}\n-\t\t\t}\n+\t\t\tlast_application_focus_time = OS::get_singleton()->get_ticks_msec();\n \t\t} break;\n \t\tcase NOTIFICATION_APPLICATION_FOCUS_OUT: {\n \t\t\tapplication_has_focus = false;\n-\t\t\tembedded_process_was_focused = embedding_completed && current_process_id == focused_process_id;\n \t\t} break;\n \t}\n }\n@@ -286,14 +276,27 @@ void EmbeddedProcess::_check_mouse_over() {\n \t// This method checks if the mouse is over the embedded process while the current application is focused.\n \t// The goal is to give focus to the embedded process as soon as the mouse hovers over it,\n \t// allowing the user to interact with it immediately without needing to click first.\n-\tif (!is_visible_in_tree() || !embedding_completed || !application_has_focus || !window || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\tif (!embedding_completed || !application_has_focus || !window || has_focus() || !is_visible_in_tree() || !window->has_focus() || Input::get_singleton()->is_mouse_button_pressed(MouseButton::LEFT) || Input::get_singleton()->is_mouse_button_pressed(MouseButton::RIGHT)) {\n+\t\treturn;\n+\t}\n+\n+\t// Before checking whether the mouse is truly inside the embedded process, ensure\n+\t// the editor has enough time to re-render. When a breakpoint is hit in the script editor,\n+\t// `_check_mouse_over` may be triggered before the editor hides the game workspace.\n+\t// This prevents the embedded process from regaining focus immediately after the editor has taken it.\n+\tif (OS::get_singleton()->get_ticks_msec() - last_application_focus_time < 500) {\n \t\treturn;\n \t}\n \n-\tbool focused = has_focus();\n+\t// Input::is_mouse_button_pressed is not sufficient to detect the mouse button state\n+\t// while the floating game window is being resized.\n+\tBitField<MouseButtonMask> mouse_button_mask = DisplayServer::get_singleton()->mouse_get_button_state();\n+\tif (!mouse_button_mask.is_empty()) {\n+\t\treturn;\n+\t}\n \n \t// Not stealing focus from a textfield.\n-\tif (!focused && get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n+\tif (get_viewport()->gui_get_focus_owner() && get_viewport()->gui_get_focus_owner()->is_text_field()) {\n \t\treturn;\n \t}\n \n@@ -309,14 +312,17 @@ void EmbeddedProcess::_check_mouse_over() {\n \t\treturn;\n \t}\n \n-\t// When we already have the focus and the user moves the mouse over the embedded process,\n-\t// we just need to refocus the process.\n-\tif (focused) {\n-\t\tqueue_update_embedded_process();\n-\t} else {\n-\t\tgrab_focus();\n-\t\tqueue_redraw();\n+\t// When there's a modal window, we don't want to grab the focus to prevent\n+\t// the game window to go in front of the modal window.\n+\tif (_get_current_modal_window()) {\n+\t\treturn;\n \t}\n+\n+\t// Force \"regrabbing\" the game window focus.\n+\tlast_updated_embedded_process_focused = false;\n+\n+\tgrab_focus();\n+\tqueue_redraw();\n }\n \n void EmbeddedProcess::_check_focused_process_id() {\n@@ -325,17 +331,48 @@ void EmbeddedProcess::_check_focused_process_id() {\n \t\tfocused_process_id = process_id;\n \t\tif (focused_process_id == current_process_id) {\n \t\t\t// The embedded process got the focus.\n-\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n-\t\t\tif (has_focus()) {\n-\t\t\t\t// Redraw to updated the focus style.\n-\t\t\t\tqueue_redraw();\n-\t\t\t} else {\n-\t\t\t\tgrab_focus();\n+\n+\t\t\t// Refocus the current model when focusing the embedded process.\n+\t\t\tWindow *modal_window = _get_current_modal_window();\n+\t\t\tif (!modal_window) {\n+\t\t\t\temit_signal(SNAME(\"embedded_process_focused\"));\n+\t\t\t\tif (has_focus()) {\n+\t\t\t\t\t// Redraw to updated the focus style.\n+\t\t\t\t\tqueue_redraw();\n+\t\t\t\t} else {\n+\t\t\t\t\tgrab_focus();\n+\t\t\t\t}\n \t\t\t}\n \t\t} else if (has_focus()) {\n \t\t\trelease_focus();\n \t\t}\n \t}\n+\n+\t// Ensure that the opened modal dialog is refocused when the focused process is the embedded process.\n+\tif (!application_has_focus && focused_process_id == current_process_id) {\n+\t\tWindow *modal_window = _get_current_modal_window();\n+\t\tif (modal_window) {\n+\t\t\tif (modal_window->get_mode() == Window::MODE_MINIMIZED) {\n+\t\t\t\tmodal_window->set_mode(Window::MODE_WINDOWED);\n+\t\t\t}\n+\t\t\tcallable_mp(modal_window, &Window::grab_focus).call_deferred();\n+\t\t}\n+\t}\n+}\n+\n+Window *EmbeddedProcess::_get_current_modal_window() {\n+\tVector<DisplayServer::WindowID> wl = DisplayServer::get_singleton()->get_window_list();\n+\tfor (const DisplayServer::WindowID &window_id : wl) {\n+\t\tWindow *w = Window::get_from_id(window_id);\n+\t\tif (!w) {\n+\t\t\tcontinue;\n+\t\t}\n+\n+\t\tif (w->is_exclusive()) {\n+\t\t\treturn w;\n+\t\t}\n+\t}\n+\treturn nullptr;\n }\n \n void EmbeddedProcess::_bind_methods() {\ndiff --git a/editor/plugins/embedded_process.h b/editor/plugins/embedded_process.h\nindex 3e800923a75d..6f56f255e618 100644\n--- a/editor/plugins/embedded_process.h\n+++ b/editor/plugins/embedded_process.h\n@@ -37,7 +37,7 @@ class EmbeddedProcess : public Control {\n \tGDCLASS(EmbeddedProcess, Control);\n \n \tbool application_has_focus = true;\n-\tbool embedded_process_was_focused = false;\n+\tuint64_t last_application_focus_time = 0;\n \tOS::ProcessID focused_process_id = 0;\n \tOS::ProcessID current_process_id = 0;\n \tbool embedding_grab_focus = false;\n@@ -68,6 +68,7 @@ class EmbeddedProcess : public Control {\n \tvoid _check_focused_process_id();\n \tbool _is_embedded_process_updatable();\n \tRect2i _get_global_embedded_window_rect();\n+\tWindow *_get_current_modal_window();\n \n protected:\n \tstatic void _bind_methods();\ndiff --git a/platform/windows/display_server_windows.cpp b/platform/windows/display_server_windows.cpp\nindex d0ddac4b7f9e..1a407bdd4b2f 100644\n--- a/platform/windows/display_server_windows.cpp\n+++ b/platform/windows/display_server_windows.cpp\n@@ -2986,7 +2986,8 @@ Error DisplayServerWindows::embed_process(WindowID p_window, OS::ProcessID p_pid\n \t// (e.g., a screen to the left of the main screen).\n \tconst Rect2i adjusted_rect = Rect2i(p_rect.position + _get_screens_origin(), p_rect.size);\n \n-\tSetWindowPos(ep->window_handle, nullptr, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n+\t// Use HWND_BOTTOM to prevent reordering of the embedded window over another popup.\n+\tSetWindowPos(ep->window_handle, HWND_BOTTOM, adjusted_rect.position.x, adjusted_rect.position.y, adjusted_rect.size.x, adjusted_rect.size.y, SWP_NOZORDER | SWP_NOACTIVATE | SWP_ASYNCWINDOWPOS);\n \n \tif (ep->is_visible != p_visible) {\n \t\tif (p_visible) {\n", "instance_id": "godotengine__godot-102247", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: when a modal popup is visible in the Godot editor and the user clicks on the embedded game window, the game window appears in front of the modal popup, potentially obscuring it or making the editor inaccessible. The steps to reproduce are provided, along with system information and a visual reference (though not accessible in text). However, there are minor ambiguities and missing details. For instance, the expected behavior is implied (modal popups should remain in front) but not explicitly stated. Additionally, edge cases such as specific types of modal popups, multi-monitor setups, or interactions with other editor features are not mentioned. While the issue is reproducible and the goal is inferable, a more comprehensive statement would include explicit desired outcomes and potential constraints or edge cases to consider.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (`embedded_process.cpp`, `embedded_process.h`, and `display_server_windows.cpp`), indicating a need to understand interactions between different components of the Godot editor's codebase. The changes involve significant logic modifications, such as handling focus management, detecting modal windows, and adjusting window z-ordering with system-level calls (e.g., `SetWindowPos` with `HWND_BOTTOM`). Second, the number of technical concepts involved is substantial, including understanding Godot's windowing system, focus handling, modal dialog behavior, and platform-specific APIs (Windows API for window management). Third, the problem requires addressing edge cases like ensuring the editor has time to re-render before focus changes, handling mouse button states during window resizing, and managing minimized modal windows. Finally, the changes impact critical user interaction flows in the editor, requiring careful consideration to avoid introducing new bugs or regressions. While not at the extreme end of difficulty (e.g., requiring system-level redesign or advanced domain knowledge beyond UI handling), this problem demands a deep understanding of the codebase and careful implementation, justifying a score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Follow Focus not working as expected in a rotated `ScrollContainer`\n### Tested versions\nBad: v4.0.stable.official [92bee43ad], master\n\n### System information\n\nGodot v4.4.dev (e19746352) - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 1050 Ti (nvidia; 535.183.01) - Intel(R) Core(TM) i5-7300HQ CPU @ 2.50GHz (4 threads)\n\n### Issue description\n\nhttps://github.com/user-attachments/assets/443244ff-871d-42f7-b653-a80cc0ff159d\n\nNavigating down in a rotating `ScrollContainer` with follow focus enabled, the focused control is not fully visible. Note the StyleBox border.\n\n### Steps to reproduce\n\n1. Import and run the MRP;\n2. Select any node inside the `ScrollContainer` and navigate using `Tab`/`Shift + Tab`.\n3. Navigate down to reproduce the issue.\n\n### Minimal reproduction project (MRP)\n\n[MRP.zip](https://github.com/user-attachments/files/18432280/MRP.zip)\n", "patch": "diff --git a/scene/gui/scroll_container.cpp b/scene/gui/scroll_container.cpp\nindex f3c50c626c17..3bad76baada4 100644\n--- a/scene/gui/scroll_container.cpp\n+++ b/scene/gui/scroll_container.cpp\n@@ -292,16 +292,20 @@ void ScrollContainer::_gui_focus_changed(Control *p_control) {\n void ScrollContainer::ensure_control_visible(Control *p_control) {\n \tERR_FAIL_COND_MSG(!is_ancestor_of(p_control), \"Must be an ancestor of the control.\");\n \n-\tRect2 global_rect = get_global_rect();\n-\tRect2 other_rect = p_control->get_global_rect();\n+\t// Just eliminate the rotation of this ScrollContainer.\n+\tTransform2D other_in_this = get_global_transform().affine_inverse() * p_control->get_global_transform();\n+\n+\tSize2 size = get_size();\n+\tRect2 other_rect = other_in_this.xform(Rect2(Point2(), p_control->get_size()));\n+\n \tfloat side_margin = v_scroll->is_visible() ? v_scroll->get_size().x : 0.0f;\n \tfloat bottom_margin = h_scroll->is_visible() ? h_scroll->get_size().y : 0.0f;\n \n-\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), global_rect.position.x), other_rect.position.x + other_rect.size.x - global_rect.size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n-\t\t\tMAX(MIN(other_rect.position.y, global_rect.position.y), other_rect.position.y + other_rect.size.y - global_rect.size.y + bottom_margin));\n+\tVector2 diff = Vector2(MAX(MIN(other_rect.position.x - (is_layout_rtl() ? side_margin : 0.0f), 0.0f), other_rect.position.x + other_rect.size.x - size.x + (!is_layout_rtl() ? side_margin : 0.0f)),\n+\t\t\tMAX(MIN(other_rect.position.y, 0.0f), other_rect.position.y + other_rect.size.y - size.y + bottom_margin));\n \n-\tset_h_scroll(get_h_scroll() + (diff.x - global_rect.position.x));\n-\tset_v_scroll(get_v_scroll() + (diff.y - global_rect.position.y));\n+\tset_h_scroll(get_h_scroll() + diff.x);\n+\tset_v_scroll(get_v_scroll() + diff.y);\n }\n \n void ScrollContainer::_reposition_children() {\n", "instance_id": "godotengine__godot-101625", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the \"Follow Focus\" feature in a rotated `ScrollContainer` does not work as expected, resulting in the focused control not being fully visible. It provides context with tested versions, system information, steps to reproduce, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what \"fully visible\" means in the context of a rotated container (e.g., whether it accounts for rotation-induced clipping or specific alignment). Additionally, it lacks explicit mention of expected behavior or constraints for edge cases like extreme rotations or nested containers. While the issue is reproducible with the provided steps and MRP, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the medium range due to several factors. First, the scope of code changes is relatively focused, confined to a single function (`ensure_control_visible`) in a single file (`scroll_container.cpp`) within the Godot engine codebase. The changes involve modifying the logic for calculating scroll positions to account for rotation by using a transformation matrix (`affine_inverse`) to adjust coordinates, which requires understanding 2D transformations and the Godot rendering system. This introduces a moderate level of complexity, as it involves specific technical concepts like affine transformations and coordinate systems in a GUI context. Additionally, the problem requires understanding how `ScrollContainer` interacts with its children and scroll bars, though it does not appear to impact broader system architecture. Edge cases, such as extreme rotations, right-to-left layouts (RTL), or visibility of scroll bars, are implicitly handled in the code changes but not extensively detailed in the problem statement, adding a layer of complexity in ensuring robustness. Overall, solving this requires a solid grasp of GUI rendering logic and transformation math, along with familiarity with Godot's internals, placing it at a medium difficulty level of 0.55. It is not overly complex or system-wide but goes beyond a simple bug fix due to the need for domain-specific knowledge and careful handling of coordinate transformations.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Sometimes when exporting in \"--headless\" mode, shaders with \"global uniform\" doesn't work\n### Tested versions\n\nReproduced: v4.3.stable.mono\n\n### System information\n\nGodot v4.3.stable.mono - Windows 10.0.19045 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2060 (NVIDIA; 32.0.15.6094) - AMD Ryzen 5 1600 Six-Core Processor (12 Threads)\n\n### Issue description\n\nSimilar to https://github.com/godotengine/godot/issues/102362, which seems only visual, but in some cases might change into completely breaking a shader.\nThe issue happens when you have shader with global uniforms (correctly added to the Project Settings) and export it.\n\nBehavior of exporting the project normally or via cmd and that of exporting it **via cmd with --headless** mode is different. Doing it the first method works correctly, doing it the second method breaks the shaders with global uniforms. \n\nBut importantly, the working of the exported shader will be based on **how the project was exported for the first time** \n\nSo:\n1. Export normally -> shader works in the build\n2. Export with --headless -> shader still work in the build\n\nBUT:\n1. Export with --headless -> shader does NOT work in the build\n2. **Export normally -> shader STILL does NOT work in the build**\n\nI traced this behavior to the \".godot/exported\" folder - if you remove it, you \"restart\" the process, as above.\n\nI noticed it first when setting up my CI pipeline (with Github Actions). As there is no .godot folder on the machine, and it uses --headless, it's gonna break the shaders every time. Only fix I found was including .godot/exported in the source control.\n\n\n### Steps to reproduce\n\n1. In empty project, create shader that uses \"global uniform\". Then create material using that shader and apply it on some mesh (not sure if required)\n2. Add the required global uniforms in Project Settings\n3. Remove the  \".godot/exported\" folder (if exists)\n4. Export the project using command line using \"--headless\" mode. (In case of MRP I use godot --headless --export-release \"Windows Desktop\" \"build/Shader Test.exe\")\n5. Notice the shader does not use the uniform correctly in the build\n\n### Minimal reproduction project (MRP)\n\n[shader-test.zip](https://github.com/user-attachments/files/18642930/shader-test.zip)\n", "patch": "diff --git a/servers/rendering/dummy/storage/material_storage.cpp b/servers/rendering/dummy/storage/material_storage.cpp\nindex e8b553ca7636..b22971a750cd 100644\n--- a/servers/rendering/dummy/storage/material_storage.cpp\n+++ b/servers/rendering/dummy/storage/material_storage.cpp\n@@ -30,6 +30,8 @@\n \n #include \"material_storage.h\"\n \n+#include \"core/config/project_settings.h\"\n+\n using namespace RendererDummy;\n \n MaterialStorage *MaterialStorage::singleton = nullptr;\n@@ -42,6 +44,103 @@ MaterialStorage::MaterialStorage() {\n \n MaterialStorage::~MaterialStorage() {\n \tsingleton = nullptr;\n+\tglobal_shader_variables.clear();\n+}\n+\n+void MaterialStorage::global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) {\n+\tERR_FAIL_COND(global_shader_variables.has(p_name));\n+\n+\tglobal_shader_variables[p_name] = p_type;\n+}\n+\n+void MaterialStorage::global_shader_parameter_remove(const StringName &p_name) {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\treturn;\n+\t}\n+\n+\tglobal_shader_variables.erase(p_name);\n+}\n+\n+Vector<StringName> MaterialStorage::global_shader_parameter_get_list() const {\n+\tVector<StringName> names;\n+\tfor (const KeyValue<StringName, RS::GlobalShaderParameterType> &E : global_shader_variables) {\n+\t\tnames.push_back(E.key);\n+\t}\n+\tnames.sort_custom<StringName::AlphCompare>();\n+\treturn names;\n+}\n+\n+RS::GlobalShaderParameterType MaterialStorage::global_shader_parameter_get_type(const StringName &p_name) const {\n+\tif (!global_shader_variables.has(p_name)) {\n+\t\tprint_line(\"don't have name, sorry\");\n+\t\treturn RS::GLOBAL_VAR_TYPE_MAX;\n+\t}\n+\n+\treturn global_shader_variables[p_name];\n+}\n+\n+void MaterialStorage::global_shader_parameters_load_settings(bool p_load_textures) {\n+\tList<PropertyInfo> settings;\n+\tProjectSettings::get_singleton()->get_property_list(&settings);\n+\n+\tfor (const PropertyInfo &E : settings) {\n+\t\tif (E.name.begins_with(\"shader_globals/\")) {\n+\t\t\tStringName name = E.name.get_slice(\"/\", 1);\n+\t\t\tDictionary d = GLOBAL_GET(E.name);\n+\n+\t\t\tERR_CONTINUE(!d.has(\"type\"));\n+\t\t\tERR_CONTINUE(!d.has(\"value\"));\n+\n+\t\t\tString type = d[\"type\"];\n+\n+\t\t\tstatic const char *global_var_type_names[RS::GLOBAL_VAR_TYPE_MAX] = {\n+\t\t\t\t\"bool\",\n+\t\t\t\t\"bvec2\",\n+\t\t\t\t\"bvec3\",\n+\t\t\t\t\"bvec4\",\n+\t\t\t\t\"int\",\n+\t\t\t\t\"ivec2\",\n+\t\t\t\t\"ivec3\",\n+\t\t\t\t\"ivec4\",\n+\t\t\t\t\"rect2i\",\n+\t\t\t\t\"uint\",\n+\t\t\t\t\"uvec2\",\n+\t\t\t\t\"uvec3\",\n+\t\t\t\t\"uvec4\",\n+\t\t\t\t\"float\",\n+\t\t\t\t\"vec2\",\n+\t\t\t\t\"vec3\",\n+\t\t\t\t\"vec4\",\n+\t\t\t\t\"color\",\n+\t\t\t\t\"rect2\",\n+\t\t\t\t\"mat2\",\n+\t\t\t\t\"mat3\",\n+\t\t\t\t\"mat4\",\n+\t\t\t\t\"transform_2d\",\n+\t\t\t\t\"transform\",\n+\t\t\t\t\"sampler2D\",\n+\t\t\t\t\"sampler2DArray\",\n+\t\t\t\t\"sampler3D\",\n+\t\t\t\t\"samplerCube\",\n+\t\t\t\t\"samplerExternalOES\"\n+\t\t\t};\n+\n+\t\t\tRS::GlobalShaderParameterType gvtype = RS::GLOBAL_VAR_TYPE_MAX;\n+\n+\t\t\tfor (int i = 0; i < RS::GLOBAL_VAR_TYPE_MAX; i++) {\n+\t\t\t\tif (global_var_type_names[i] == type) {\n+\t\t\t\t\tgvtype = RS::GlobalShaderParameterType(i);\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t}\n+\n+\t\t\tERR_CONTINUE(gvtype == RS::GLOBAL_VAR_TYPE_MAX); //type invalid\n+\n+\t\t\tif (!global_shader_variables.has(name)) {\n+\t\t\t\tglobal_shader_parameter_add(name, gvtype, Variant());\n+\t\t\t}\n+\t\t}\n+\t}\n }\n \n RID MaterialStorage::shader_allocate() {\n@@ -131,3 +230,56 @@ void MaterialStorage::get_shader_parameter_list(RID p_shader, List<PropertyInfo>\n \t\tp_param_list->push_back(pi);\n \t}\n }\n+\n+RID MaterialStorage::material_allocate() {\n+\treturn material_owner.allocate_rid();\n+}\n+\n+void MaterialStorage::material_initialize(RID p_rid) {\n+\tmaterial_owner.initialize_rid(p_rid, DummyMaterial());\n+}\n+\n+void MaterialStorage::material_free(RID p_rid) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_rid);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial_owner.free(p_rid);\n+}\n+\n+void MaterialStorage::material_set_shader(RID p_material, RID p_shader) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->shader = p_shader;\n+}\n+\n+void MaterialStorage::material_set_next_pass(RID p_material, RID p_next_material) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\n+\tmaterial->next_pass = p_next_material;\n+}\n+\n+void MaterialStorage::material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) {\n+\tDummyMaterial *material = material_owner.get_or_null(p_material);\n+\tERR_FAIL_NULL(material);\n+\tDummyShader *shader = shader_owner.get_or_null(material->shader);\n+\n+\tif (shader) {\n+\t\tfor (const KeyValue<StringName, ShaderLanguage::ShaderNode::Uniform> &E : shader->uniforms) {\n+\t\t\tif (E.value.scope != ShaderLanguage::ShaderNode::Uniform::SCOPE_INSTANCE) {\n+\t\t\t\tcontinue;\n+\t\t\t}\n+\n+\t\t\tRendererMaterialStorage::InstanceShaderParam p;\n+\t\t\tp.info = ShaderLanguage::uniform_to_property_info(E.value);\n+\t\t\tp.info.name = E.key; //supply name\n+\t\t\tp.index = E.value.instance_index;\n+\t\t\tp.default_value = ShaderLanguage::constant_value_to_variant(E.value.default_value, E.value.type, E.value.array_size, E.value.hint);\n+\t\t\tr_parameters->push_back(p);\n+\t\t}\n+\t}\n+\tif (material->next_pass.is_valid()) {\n+\t\tmaterial_get_instance_shader_parameters(material->next_pass, r_parameters);\n+\t}\n+}\ndiff --git a/servers/rendering/dummy/storage/material_storage.h b/servers/rendering/dummy/storage/material_storage.h\nindex 9422c395e2e6..ef46cf3b9b4f 100644\n--- a/servers/rendering/dummy/storage/material_storage.h\n+++ b/servers/rendering/dummy/storage/material_storage.h\n@@ -42,6 +42,8 @@ class MaterialStorage : public RendererMaterialStorage {\n private:\n \tstatic MaterialStorage *singleton;\n \n+\tHashMap<StringName, RS::GlobalShaderParameterType> global_shader_variables;\n+\n \tstruct DummyShader {\n \t\tHashMap<StringName, ShaderLanguage::ShaderNode::Uniform> uniforms;\n \t};\n@@ -50,6 +52,13 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \tShaderCompiler dummy_compiler;\n \n+\tstruct DummyMaterial {\n+\t\tRID shader;\n+\t\tRID next_pass;\n+\t};\n+\n+\tmutable RID_Owner<DummyMaterial> material_owner;\n+\n public:\n \tstatic MaterialStorage *get_singleton() { return singleton; }\n \n@@ -58,16 +67,16 @@ class MaterialStorage : public RendererMaterialStorage {\n \n \t/* GLOBAL SHADER UNIFORM API */\n \n-\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override {}\n-\tvirtual void global_shader_parameter_remove(const StringName &p_name) override {}\n-\tvirtual Vector<StringName> global_shader_parameter_get_list() const override { return Vector<StringName>(); }\n+\tvirtual void global_shader_parameter_add(const StringName &p_name, RS::GlobalShaderParameterType p_type, const Variant &p_value) override;\n+\tvirtual void global_shader_parameter_remove(const StringName &p_name) override;\n+\tvirtual Vector<StringName> global_shader_parameter_get_list() const override;\n \n \tvirtual void global_shader_parameter_set(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual void global_shader_parameter_set_override(const StringName &p_name, const Variant &p_value) override {}\n \tvirtual Variant global_shader_parameter_get(const StringName &p_name) const override { return Variant(); }\n-\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override { return RS::GLOBAL_VAR_TYPE_MAX; }\n+\tvirtual RS::GlobalShaderParameterType global_shader_parameter_get_type(const StringName &p_name) const override;\n \n-\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override {}\n+\tvirtual void global_shader_parameters_load_settings(bool p_load_textures = true) override;\n \tvirtual void global_shader_parameters_clear() override {}\n \n \tvirtual int32_t global_shader_parameters_instance_allocate(RID p_instance) override { return 0; }\n@@ -95,23 +104,26 @@ class MaterialStorage : public RendererMaterialStorage {\n \tvirtual RS::ShaderNativeSourceCode shader_get_native_source_code(RID p_shader) const override { return RS::ShaderNativeSourceCode(); }\n \n \t/* MATERIAL API */\n-\tvirtual RID material_allocate() override { return RID(); }\n-\tvirtual void material_initialize(RID p_rid) override {}\n-\tvirtual void material_free(RID p_rid) override {}\n+\n+\tbool owns_material(RID p_rid) { return material_owner.owns(p_rid); }\n+\n+\tvirtual RID material_allocate() override;\n+\tvirtual void material_initialize(RID p_rid) override;\n+\tvirtual void material_free(RID p_rid) override;\n \n \tvirtual void material_set_render_priority(RID p_material, int priority) override {}\n-\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override {}\n+\tvirtual void material_set_shader(RID p_shader_material, RID p_shader) override;\n \n \tvirtual void material_set_param(RID p_material, const StringName &p_param, const Variant &p_value) override {}\n \tvirtual Variant material_get_param(RID p_material, const StringName &p_param) const override { return Variant(); }\n \n-\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override {}\n+\tvirtual void material_set_next_pass(RID p_material, RID p_next_material) override;\n \n \tvirtual bool material_is_animated(RID p_material) override { return false; }\n \tvirtual bool material_casts_shadows(RID p_material) override { return false; }\n \tvirtual RS::CullMode material_get_cull_mode(RID p_material) const override { return RS::CULL_MODE_DISABLED; }\n \n-\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override {}\n+\tvirtual void material_get_instance_shader_parameters(RID p_material, List<InstanceShaderParam> *r_parameters) override;\n \tvirtual void material_update_dependency(RID p_material, DependencyTracker *p_instance) override {}\n };\n \ndiff --git a/servers/rendering/dummy/storage/utilities.h b/servers/rendering/dummy/storage/utilities.h\nindex 4e20dee640e5..02e163fd8e8e 100644\n--- a/servers/rendering/dummy/storage/utilities.h\n+++ b/servers/rendering/dummy/storage/utilities.h\n@@ -77,6 +77,9 @@ class Utilities : public RendererUtilities {\n \t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_shader(p_rid)) {\n \t\t\tRendererDummy::MaterialStorage::get_singleton()->shader_free(p_rid);\n \t\t\treturn true;\n+\t\t} else if (RendererDummy::MaterialStorage::get_singleton()->owns_material(p_rid)) {\n+\t\t\tRendererDummy::MaterialStorage::get_singleton()->material_free(p_rid);\n+\t\t\treturn true;\n \t\t}\n \t\treturn false;\n \t}\n", "instance_id": "godotengine__godot-101210", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: shaders with global uniforms fail to work correctly when a project is exported in \"--headless\" mode using Godot v4.3. It provides specific steps to reproduce the issue, mentions the affected versions, and includes a minimal reproduction project (MRP). The description also highlights the dependency on the initial export method and the role of the \".godot/exported\" folder, which adds useful context. However, there are minor ambiguities and missing details. For instance, the exact nature of \"breaking\" the shader is not fully specified (e.g., does it fail to compile, render incorrectly, or crash?). Additionally, while the steps to reproduce are provided, edge cases or specific constraints (e.g., types of global uniforms affected, specific export configurations) are not explicitly mentioned. These gaps prevent the statement from being fully comprehensive, warranting a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" range (0.6-0.8), due to the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying cause (difference in behavior between headless and normal export modes) suggests a non-trivial issue likely tied to how Godot handles shader compilation or project settings in different environments. Understanding the root cause requires familiarity with Godot's export pipeline and rendering system.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are significant, affecting multiple methods in the dummy rendering storage module of Godot (`material_storage.cpp` and `material_storage.h`). The modifications involve adding support for global shader parameters and material management in a dummy backend, which was previously unimplemented (stubbed out with empty methods). The changes span across multiple functions (e.g., `global_shader_parameter_add`, `material_allocate`, etc.) and introduce new data structures and logic. While the changes are localized to a few files, they impact a critical part of the rendering subsystem, requiring an understanding of how the dummy backend interacts with the rest of the engine.\n\n3. **Number of Technical Concepts**: Solving this problem requires knowledge of several concepts, including:\n   - Godot's rendering architecture, specifically the role of dummy storage in headless mode.\n   - Shader compilation and uniform handling in graphics programming.\n   - Project settings management and how they are loaded/exported in different modes.\n   - C++ programming with Godot's custom data structures (e.g., `RID`, `HashMap`, `StringName`) and conventions.\n   These concepts are moderately complex, especially for someone unfamiliar with game engine internals or graphics programming.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code changes introduce logic for handling shader parameter types, material allocation, and uniform scopes. Potential edge cases include invalid or unsupported uniform types, missing project settings, or recursive material dependencies (via `next_pass`). The code includes basic error checking (e.g., `ERR_FAIL_COND`, `ERR_CONTINUE`), but handling all possible failure modes in a robust way adds to the complexity. Additionally, ensuring compatibility with different export configurations and platforms (as hinted by the CI pipeline issue) increases the challenge.\n\nOverall, this problem requires a deep understanding of Godot's internals, particularly its rendering and export systems, and involves complex modifications to a critical component. It is not at the extreme end of difficulty (e.g., requiring system-level redesign or advanced domain knowledge beyond game engines), but it is challenging enough to warrant a score of 0.65. This reflects the need for specialized knowledge and careful implementation to avoid introducing new bugs in a sensitive area of the codebase.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Documentation tooltip trigger area includes end-of-line and whitespace surrounding a symbol\n### Tested versions\n\nv4.4.dev7.official [46c8f8c5c]\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - Intel(R) Iris(R) Xe Graphics (Intel Corporation; 32.0.101.5768) - 11th Gen Intel(R) Core(TM) i7-1185G7 @ 3.00GHz (8 threads)\n\n### Issue description\n\nThe symbol info / documentation tooltips (#91060) are triggered by hovering in the empty space at the end of a line or the whitespace surrounding a symbol.\n\nhttps://github.com/user-attachments/assets/d15df433-edad-4044-8bb5-b02c89c869ec\n\n\n### Steps to reproduce\n\nStop the mouse cursor in the space surrounding a hoverable symbol.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/doc/classes/TextEdit.xml b/doc/classes/TextEdit.xml\nindex 89e2a2017af1..826a491888df 100644\n--- a/doc/classes/TextEdit.xml\n+++ b/doc/classes/TextEdit.xml\n@@ -349,9 +349,12 @@\n \t\t<method name=\"get_line_column_at_pos\" qualifiers=\"const\">\n \t\t\t<return type=\"Vector2i\" />\n \t\t\t<param index=\"0\" name=\"position\" type=\"Vector2i\" />\n-\t\t\t<param index=\"1\" name=\"allow_out_of_bounds\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"1\" name=\"clamp_line\" type=\"bool\" default=\"true\" />\n+\t\t\t<param index=\"2\" name=\"clamp_column\" type=\"bool\" default=\"true\" />\n \t\t\t<description>\n-\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column, [code]y[/code] is the line. If [param allow_out_of_bounds] is [code]false[/code] and the position is not over the text, both vector values will be set to [code]-1[/code].\n+\t\t\t\tReturns the line and column at the given position. In the returned vector, [code]x[/code] is the column and [code]y[/code] is the line.\n+\t\t\t\tIf [param clamp_line] is [code]false[/code] and [param position] is below the last line, [code]Vector2i(-1, -1)[/code] is returned.\n+\t\t\t\tIf [param clamp_column] is [code]false[/code] and [param position] is outside the column range of the line, [code]Vector2i(-1, -1)[/code] is returned.\n \t\t\t</description>\n \t\t</method>\n \t\t<method name=\"get_line_count\" qualifiers=\"const\">\ndiff --git a/misc/extension_api_validation/4.3-stable.expected b/misc/extension_api_validation/4.3-stable.expected\nindex 7b5889f464b9..9c96811f875f 100644\n--- a/misc/extension_api_validation/4.3-stable.expected\n+++ b/misc/extension_api_validation/4.3-stable.expected\n@@ -309,3 +309,10 @@ Validate extension JSON: API was removed: classes/EditorSceneFormatImporter/meth\n \n This virtual method, and the internal public `get_import_flags`, were never used by the engine, since it was open sourced.\n So we're removing it despite the compat breakage as there's no way for users to rely on this affecting engine behavior.\n+\n+\n+GH-100913\n+---------\n+Validate extension JSON: Error: Field 'classes/TextEdit/methods/get_line_column_at_pos/arguments': size changed value in new API, from 2 to 3.\n+\n+Added optional argument to disallow positions that are outside the column range of the line. Compatibility method registered.\ndiff --git a/scene/gui/code_edit.cpp b/scene/gui/code_edit.cpp\nindex 7f8b4dca7862..be8b6f075d9c 100644\n--- a/scene/gui/code_edit.cpp\n+++ b/scene/gui/code_edit.cpp\n@@ -421,7 +421,7 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \t\t\t\t\t\tmpos.x = get_size().x - mpos.x;\n \t\t\t\t\t}\n \n-\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false);\n+\t\t\t\t\tPoint2i pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\t\tint line = pos.y;\n \t\t\t\t\tint col = pos.x;\n \n@@ -443,18 +443,18 @@ void CodeEdit::gui_input(const Ref<InputEvent> &p_gui_input) {\n \n \t\tif (symbol_lookup_on_click_enabled) {\n \t\t\tif (mm->is_command_or_control_pressed() && mm->get_button_mask().is_empty()) {\n-\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos);\n+\t\t\t\tsymbol_lookup_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\t\tsymbol_lookup_new_word = get_word_at_pos(mpos);\n \t\t\t\tif (symbol_lookup_new_word != symbol_lookup_word) {\n \t\t\t\t\temit_signal(SNAME(\"symbol_validate\"), symbol_lookup_new_word);\n \t\t\t\t}\n-\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos))) {\n+\t\t\t} else if (!mm->is_command_or_control_pressed() || (!mm->get_button_mask().is_empty() && symbol_lookup_pos != get_line_column_at_pos(mpos, false, false))) {\n \t\t\t\tset_symbol_lookup_word_as_valid(false);\n \t\t\t}\n \t\t}\n \n \t\tif (symbol_tooltip_on_hover_enabled) {\n-\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false);\n+\t\t\tsymbol_tooltip_pos = get_line_column_at_pos(mpos, false, false);\n \t\t\tsymbol_tooltip_word = get_word_at_pos(mpos);\n \t\t\tsymbol_tooltip_timer->start();\n \t\t}\n@@ -2388,7 +2388,7 @@ bool CodeEdit::is_symbol_lookup_on_click_enabled() const {\n \n String CodeEdit::get_text_for_symbol_lookup() const {\n \tPoint2i mp = get_local_mouse_pos();\n-\tPoint2i pos = get_line_column_at_pos(mp, false);\n+\tPoint2i pos = get_line_column_at_pos(mp, false, false);\n \tint line = pos.y;\n \tint col = pos.x;\n \ndiff --git a/scene/gui/text_edit.compat.inc b/scene/gui/text_edit.compat.inc\nindex bf73229868ef..d15740390e9d 100644\n--- a/scene/gui/text_edit.compat.inc\n+++ b/scene/gui/text_edit.compat.inc\n@@ -34,8 +34,13 @@ void TextEdit::_set_selection_mode_compat_86978(SelectionMode p_mode, int p_line\n \tset_selection_mode(p_mode);\n }\n \n+Point2i TextEdit::_get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+\treturn get_line_column_at_pos(p_pos, p_allow_out_of_bounds, true);\n+}\n+\n void TextEdit::_bind_compatibility_methods() {\n \tClassDB::bind_compatibility_method(D_METHOD(\"set_selection_mode\", \"mode\", \"line\", \"column\", \"caret_index\"), &TextEdit::_set_selection_mode_compat_86978, DEFVAL(-1), DEFVAL(-1), DEFVAL(0));\n+\tClassDB::bind_compatibility_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::_get_line_column_at_pos_bind_compat_100913, DEFVAL(true));\n }\n \n #endif\ndiff --git a/scene/gui/text_edit.cpp b/scene/gui/text_edit.cpp\nindex addbff1e979a..b707a5a93342 100644\n--- a/scene/gui/text_edit.cpp\n+++ b/scene/gui/text_edit.cpp\n@@ -4397,9 +4397,12 @@ Point2 TextEdit::get_local_mouse_pos() const {\n }\n \n String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n-\tPoint2i pos = get_line_column_at_pos(p_pos);\n+\tPoint2i pos = get_line_column_at_pos(p_pos, false, false);\n \tint row = pos.y;\n \tint col = pos.x;\n+\tif (row < 0 || col < 0) {\n+\t\treturn \"\";\n+\t}\n \n \tString s = text[row];\n \tif (s.length() == 0) {\n@@ -4435,7 +4438,7 @@ String TextEdit::get_word_at_pos(const Vector2 &p_pos) const {\n \treturn String();\n }\n \n-Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds) const {\n+Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line, bool p_clamp_column) const {\n \tfloat rows = p_pos.y - theme_cache.style_normal->get_margin(SIDE_TOP);\n \tif (!editable) {\n \t\trows -= theme_cache.style_readonly->get_offset().y / 2;\n@@ -4462,10 +4465,10 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \n \tint visible_lines = get_visible_line_count_in_range(first_vis_line, row);\n \tif (rows > visible_lines) {\n-\t\tif (!p_allow_out_of_bounds) {\n-\t\t\treturn Point2i(-1, -1);\n+\t\tif (p_clamp_line) {\n+\t\t\treturn Point2i(text[row].length(), row);\n \t\t}\n-\t\treturn Point2i(text[row].length(), row);\n+\t\treturn Point2i(-1, -1);\n \t}\n \n \tint colx = p_pos.x - (theme_cache.style_normal->get_margin(SIDE_LEFT) + gutters_width + gutter_padding);\n@@ -4482,6 +4485,11 @@ Point2i TextEdit::get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_\n \t} else {\n \t\tcolx -= wrap_indent;\n \t}\n+\n+\tif (!p_clamp_column && (colx < 0 || colx > TS->shaped_text_get_size(text_rid).x)) {\n+\t\treturn Point2i(-1, -1);\n+\t}\n+\n \tint col = TS->shaped_text_hit_test_position(text_rid, colx);\n \tif (!caret_mid_grapheme_enabled) {\n \t\tcol = TS->shaped_text_closest_character_pos(text_rid, col);\n@@ -6740,7 +6748,7 @@ void TextEdit::_bind_methods() {\n \n \tClassDB::bind_method(D_METHOD(\"get_word_at_pos\", \"position\"), &TextEdit::get_word_at_pos);\n \n-\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"allow_out_of_bounds\"), &TextEdit::get_line_column_at_pos, DEFVAL(true));\n+\tClassDB::bind_method(D_METHOD(\"get_line_column_at_pos\", \"position\", \"clamp_line\", \"clamp_column\"), &TextEdit::get_line_column_at_pos, DEFVAL(true), DEFVAL(true));\n \tClassDB::bind_method(D_METHOD(\"get_pos_at_line_column\", \"line\", \"column\"), &TextEdit::get_pos_at_line_column);\n \tClassDB::bind_method(D_METHOD(\"get_rect_at_line_column\", \"line\", \"column\"), &TextEdit::get_rect_at_line_column);\n \ndiff --git a/scene/gui/text_edit.h b/scene/gui/text_edit.h\nindex ef5110963023..8609b86eccf0 100644\n--- a/scene/gui/text_edit.h\n+++ b/scene/gui/text_edit.h\n@@ -658,6 +658,7 @@ class TextEdit : public Control {\n \n #ifndef DISABLE_DEPRECATED\n \tvoid _set_selection_mode_compat_86978(SelectionMode p_mode, int p_line = -1, int p_column = -1, int p_caret = 0);\n+\tPoint2i _get_line_column_at_pos_bind_compat_100913(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n \tstatic void _bind_compatibility_methods();\n #endif // DISABLE_DEPRECATED\n \n@@ -860,7 +861,7 @@ class TextEdit : public Control {\n \n \tString get_word_at_pos(const Vector2 &p_pos) const;\n \n-\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_allow_out_of_bounds = true) const;\n+\tPoint2i get_line_column_at_pos(const Point2i &p_pos, bool p_clamp_line = true, bool p_clamp_column = true) const;\n \tPoint2i get_pos_at_line_column(int p_line, int p_column) const;\n \tRect2i get_rect_at_line_column(int p_line, int p_column) const;\n \n", "instance_id": "godotengine__godot-100913", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: tooltips for symbol information in a text editor are triggered incorrectly by hovering over whitespace or end-of-line areas surrounding a symbol. The goal is implied to be restricting tooltip triggers to the actual symbol area. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly state the desired behavior (e.g., should tooltips only trigger on the exact symbol boundaries?) or provide specific constraints about acceptable hover areas. Additionally, edge cases such as multi-line symbols, different font sizes, or varying text layouts are not mentioned. While the issue is valid and the general intent is understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes involves multiple files (e.g., `text_edit.cpp`, `code_edit.cpp`, documentation updates in `TextEdit.xml`, and compatibility handling in `text_edit.compat.inc`), indicating a need to understand interactions between different parts of the codebase, particularly in the GUI and text rendering logic of the Godot engine. The changes modify the behavior of the `get_line_column_at_pos` method to add stricter clamping of line and column positions, which requires understanding how mouse position mapping works in the text editor component. The amount of code change is moderate, with updates to method signatures, logic for position validation, and compatibility bindings for backward compatibility.\n\nTechnically, the problem requires knowledge of C++ (as the codebase is in C++), familiarity with Godot's internal text rendering and input handling systems, and an understanding of method binding for compatibility. The concepts involved are not overly complex but do require specific domain knowledge of GUI components and event handling in Godot. Edge cases are implicitly present (e.g., handling positions outside valid text bounds, wrapped lines, or empty lines), and the code changes address these by returning invalid positions (`-1, -1`) when clamping is disabled, which adds a layer of error handling complexity. However, the problem does not impact core system architecture or require advanced algorithms, keeping it from being classified as hard. Overall, this rates as a medium difficulty task (0.45), suitable for a developer with moderate experience in C++ and some familiarity with the Godot engine's internals.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor Settings Shortcuts: Undoing changes to built-in actions creates empty action\n### Tested versions\n\nv4.3.stable.official [77dcf97d8]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.22631 - Vulkan (Forward+) - dedicated NVIDIA GeForce GTX 980 Ti (NVIDIA; 32.0.15.6603) - 13th Gen Intel(R) Core(TM) i7-13700K (24 Threads)\n\n### Issue description\n\nTwo issues happen when undoing/redoing changes to the built-in actions in the Shortcuts list:\n \n1. Undo/redo have a 1 second delay\n2. Undoing back to the default shortcut results in an empty shortcut rather than the default.\n\nhttps://github.com/user-attachments/assets/b24c9694-a1d1-4979-9b5e-63cc22127cc2\n\n\n\n### Steps to reproduce\n\n- Change one of the built-in editor shortcuts\n- Undo with Ctrl-Z\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/editor/editor_settings_dialog.cpp b/editor/editor_settings_dialog.cpp\nindex 8989b9cf9b9b..2f7dfe16072e 100644\n--- a/editor/editor_settings_dialog.cpp\n+++ b/editor/editor_settings_dialog.cpp\n@@ -314,6 +314,10 @@ void EditorSettingsDialog::_event_config_confirmed() {\n \n void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Array &p_events) {\n \tArray old_input_array = EditorSettings::get_singleton()->get_builtin_action_overrides(p_name);\n+\tif (old_input_array.is_empty()) {\n+\t\tList<Ref<InputEvent>> defaults = InputMap::get_singleton()->get_builtins_with_feature_overrides_applied()[current_edited_identifier];\n+\t\told_input_array = _event_list_to_array_helper(defaults);\n+\t}\n \n \tEditorUndoRedoManager *undo_redo = EditorUndoRedoManager::get_singleton();\n \tundo_redo->create_action(vformat(TTR(\"Edit Built-in Action: %s\"), p_name));\n@@ -321,11 +325,11 @@ void EditorSettingsDialog::_update_builtin_action(const String &p_name, const Ar\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"mark_setting_changed\", \"builtin_action_overrides\");\n \tundo_redo->add_do_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, p_events);\n \tundo_redo->add_undo_method(EditorSettings::get_singleton(), \"set_builtin_action_override\", p_name, old_input_array);\n+\tundo_redo->add_do_method(this, \"_update_shortcuts\");\n+\tundo_redo->add_undo_method(this, \"_update_shortcuts\");\n \tundo_redo->add_do_method(this, \"_settings_changed\");\n \tundo_redo->add_undo_method(this, \"_settings_changed\");\n \tundo_redo->commit_action();\n-\n-\t_update_shortcuts();\n }\n \n void EditorSettingsDialog::_update_shortcut_events(const String &p_path, const Array &p_events) {\n", "instance_id": "godotengine__godot-100069", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the undo/redo functionality for built-in editor shortcuts in the Godot engine. It specifies two distinct issues: a 1-second delay during undo/redo operations and the problem of undoing to an empty shortcut instead of the default. The steps to reproduce are provided, which helps in understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define what constitutes a \"default shortcut\" in terms of data or behavior, nor does it mention any specific constraints or edge cases (e.g., what happens with multiple undo operations or custom shortcuts). Additionally, there is no mention of expected performance requirements for fixing the delay issue. While the attached video link (presumably showing the issue) is helpful, it is not a substitute for a detailed textual description of expected behavior. Thus, the clarity score is 2 (Mostly Clear) due to these minor gaps in the problem definition.", "difficulty_explanation": "The difficulty of this problem falls in the Easy range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The provided diff shows modifications to a single file (`editor_settings_dialog.cpp`) and specifically to the `_update_builtin_action` method. The changes involve a small number of lines (adding logic to handle default shortcuts and updating undo/redo methods). There is no indication of widespread impact across multiple modules or significant architectural changes. The code change is localized and straightforward, focusing on enhancing the undo/redo behavior by fetching default input events when the override array is empty.\n\n2. **Number of Technical Concepts**: Solving this requires understanding a few specific concepts within the Godot engine's codebase, such as the `InputMap` and `EditorSettings` singletons, undo/redo management via `EditorUndoRedoManager`, and how input events are stored and manipulated as arrays. These are moderately complex for someone unfamiliar with Godot, but for a developer with experience in game engine development or C++ (as used in Godot), these are relatively standard. No advanced algorithms, design patterns, or external libraries are involved beyond the engine's internal APIs.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change implies handling the case where a built-in action has no overrides (i.e., reverting to defaults). The modification does not introduce complex error handling logic beyond ensuring the default input events are correctly fetched and applied. There might be implicit edge cases, such as ensuring the `InputMap` data is always valid or handling multiple undo/redo operations, but these are not addressed in the diff and do not seem to significantly increase complexity.\n\n4. **Overall Complexity**: While the 1-second delay issue mentioned in the problem statement is not directly addressed in the provided code changes (which focus on the empty shortcut issue), the provided diff suggests a straightforward fix for the second issue. The delay issue might require separate profiling or optimization (not shown in the diff), but based on the current scope, it does not appear to be a major factor in the difficulty. The task requires understanding some internal logic of the Godot editor but does not demand deep architectural changes or advanced technical expertise.\n\nGiven these considerations, I assign a difficulty score of 0.35, placing it on the higher end of the Easy range due to the need for domain-specific knowledge of Godot's editor internals and undo/redo system, but still within a manageable scope for a developer with moderate experience in C++ and game engines.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Header inconsistency after invalidate/reconsider block\nDemonstration using regtest.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n```\r\n\r\nMine a block\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 1,\r\n```\r\nCall invalidateblock\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 0,\r\n  \"headers\": 0,\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 1,\r\n    \"status\": \"invalid\"\r\n  },\r\n  {\r\n    \"height\": 0,\r\n    \"hash\": \"0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\nCall reconsiderblock\r\n```bash\r\n# getchaintips\r\n    \"height\": 1,\r\n    \"hash\": \"06702ef73c7d8629294f8b6386646f888d60979932ba2ee45e3495d8f25006b5\",\r\n    \"branchlen\": 0,\r\n    \"status\": \"active\"\r\n```\r\n\r\nHeader count returned by getblockchaininfo is now < # of blocks.\r\n```bash\r\n# getblockchaininfo\r\n  \"chain\": \"regtest\",\r\n  \"blocks\": 1,\r\n  \"headers\": 0,\r\n```\n", "patch": "diff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 7ffd03e71af5a..4a7af39b15144 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1648,6 +1648,7 @@ void ReconsiderBlock(ChainstateManager& chainman, uint256 block_hash) {\n         }\n \n         chainman.ActiveChainstate().ResetBlockFailureFlags(pblockindex);\n+        chainman.RecalculateBestHeader();\n     }\n \n     BlockValidationState state;\ndiff --git a/src/validation.cpp b/src/validation.cpp\nindex 8e4ea8eda2f62..dcaa8dba26602 100644\n--- a/src/validation.cpp\n+++ b/src/validation.cpp\n@@ -2045,8 +2045,9 @@ void Chainstate::InvalidChainFound(CBlockIndex* pindexNew)\n     if (!m_chainman.m_best_invalid || pindexNew->nChainWork > m_chainman.m_best_invalid->nChainWork) {\n         m_chainman.m_best_invalid = pindexNew;\n     }\n+    SetBlockFailureFlags(pindexNew);\n     if (m_chainman.m_best_header != nullptr && m_chainman.m_best_header->GetAncestor(pindexNew->nHeight) == pindexNew) {\n-        m_chainman.m_best_header = m_chain.Tip();\n+        m_chainman.RecalculateBestHeader();\n     }\n \n     LogPrintf(\"%s: invalid block=%s  height=%d  log2_work=%f  date=%s\\n\", __func__,\n@@ -3785,6 +3786,17 @@ bool Chainstate::InvalidateBlock(BlockValidationState& state, CBlockIndex* pinde\n     return true;\n }\n \n+void Chainstate::SetBlockFailureFlags(CBlockIndex* invalid_block)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    for (auto& [_, block_index] : m_blockman.m_block_index) {\n+        if (block_index.GetAncestor(invalid_block->nHeight) == invalid_block && !(block_index.nStatus & BLOCK_FAILED_MASK)) {\n+            block_index.nStatus |= BLOCK_FAILED_CHILD;\n+        }\n+    }\n+}\n+\n void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     AssertLockHeld(cs_main);\n \n@@ -6396,6 +6408,17 @@ std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n \n+void ChainstateManager::RecalculateBestHeader()\n+{\n+    AssertLockHeld(cs_main);\n+    m_best_header = ActiveChain().Tip();\n+    for (auto& entry : m_blockman.m_block_index) {\n+        if (!(entry.second.nStatus & BLOCK_FAILED_MASK) && m_best_header->nChainWork < entry.second.nChainWork) {\n+            m_best_header = &entry.second;\n+        }\n+    }\n+}\n+\n bool ChainstateManager::ValidatedSnapshotCleanup()\n {\n     AssertLockHeld(::cs_main);\ndiff --git a/src/validation.h b/src/validation.h\nindex 059ae52bdf4ca..29ff6bd94cd4e 100644\n--- a/src/validation.h\n+++ b/src/validation.h\n@@ -735,6 +735,9 @@ class Chainstate\n         EXCLUSIVE_LOCKS_REQUIRED(!m_chainstate_mutex)\n         LOCKS_EXCLUDED(::cs_main);\n \n+    /** Set invalidity status to all descendants of a block */\n+    void SetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     /** Remove invalidity status from a block and its descendants. */\n     void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n@@ -1321,6 +1324,11 @@ class ChainstateManager\n     //! nullopt.\n     std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If, due to invalidation / reconsideration of blocks, the previous\n+    //! best header is no longer valid / guaranteed to be the most-work\n+    //! header in our block-index not known to be invalid, recalculate it.\n+    void RecalculateBestHeader() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n     CCheckQueue<CScriptCheck>& GetCheckQueue() { return m_script_check_queue; }\n \n     ~ChainstateManager();\n", "instance_id": "bitcoin__bitcoin-30666", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue of header inconsistency after invalidating and reconsidering a block in a blockchain context (likely Bitcoin or a similar system, given the regtest and RPC commands). It provides a step-by-step demonstration using command-line interactions to show the discrepancy between the block count and header count after specific operations (invalidateblock and reconsiderblock). The goal of fixing the header count inconsistency is implied, and the provided code changes align with addressing this issue. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior (e.g., what the header count should be after reconsiderblock), nor does it mention specific edge cases or constraints that might affect the solution. Additionally, domain-specific terms like \"headers\" and \"best header\" are used without explanation, which could be unclear to someone unfamiliar with blockchain internals. Overall, it is mostly clear but lacks some explicit details and context for a fully comprehensive description.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes spans multiple files (rpc/blockchain.cpp, validation.cpp, and validation.h), indicating a need to understand and modify interactions between different components of the codebase. The changes involve core blockchain logic, such as recalculating the best header and managing block invalidity flags, which suggests a deep understanding of the system's architecture is required. Second, the technical concepts involved are moderately complex, including blockchain-specific mechanisms (e.g., block validation, chain work comparison, block status flags), thread safety with mutex locks (e.g., AssertLockHeld(cs_main)), and the need to ensure consistency across the block index. Third, while the problem statement does not explicitly mention edge cases, the nature of blockchain systems implies potential complexities such as handling forks, ensuring no invalid blocks are mistakenly considered as the best header, and maintaining consistency during concurrent operations. The code changes introduce new methods like RecalculateBestHeader and SetBlockFailureFlags, which require careful implementation to avoid performance issues or logical errors in a critical system component. Overall, this problem requires a solid grasp of the codebase's internals and careful handling of system invariants, justifying a difficulty score of 0.65.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "depends: Cross-compiling `qt` for `arm-linux-gnueabihf` fails\nOn Ubuntu 24.04 with glibc 2.39:\r\n```\r\ncompiling ../3rdparty/zlib/src/gzclose.c\r\nIn file included from /usr/arm-linux-gnueabihf/include/features.h:394,\r\n                 from /usr/arm-linux-gnueabihf/include/bits/libc-header-start.h:33,\r\n                 from /usr/arm-linux-gnueabihf/include/stdio.h:28,\r\n                 from ../3rdparty/zlib/src/gzguts.h:40,\r\n                 from ../3rdparty/zlib/src/gzclose.c:6:\r\n/usr/arm-linux-gnueabihf/include/features-time64.h:26:5: error: #error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n   26 | #   error \"_TIME_BITS=64 is allowed only with _FILE_OFFSET_BITS=64\"\r\n      |     ^~~~~\r\n```\r\n\r\nSome similar issues in https://bugreports.qt.io suggest to switch from the builtin `zlib` to a system one. But that doesn't look like an option for us.\n", "patch": "diff --git a/depends/packages/qt.mk b/depends/packages/qt.mk\nindex 0acf4cf565504..d057b2d410a18 100644\n--- a/depends/packages/qt.mk\n+++ b/depends/packages/qt.mk\n@@ -22,6 +22,7 @@ $(package)_patches += fix-macos-linker.patch\n $(package)_patches += memory_resource.patch\n $(package)_patches += utc_from_string_no_optimize.patch\n $(package)_patches += windows_lto.patch\n+$(package)_patches += zlib-timebits64.patch\n \n $(package)_qttranslations_file_name=qttranslations-$($(package)_suffix)\n $(package)_qttranslations_sha256_hash=24d4c58bc2a40c0f44f59ee64af4192c7d0038c1e45af61646cfc5b65058f271\n@@ -251,6 +252,7 @@ define $(package)_preprocess_cmds\n   patch -p1 -i $($(package)_patch_dir)/utc_from_string_no_optimize.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/guix_cross_lib_path.patch && \\\n   patch -p1 -i $($(package)_patch_dir)/windows_lto.patch && \\\n+  patch -p1 -i $($(package)_patch_dir)/zlib-timebits64.patch && \\\n   mkdir -p qtbase/mkspecs/macx-clang-linux &&\\\n   cp -f qtbase/mkspecs/macx-clang/qplatformdefs.h qtbase/mkspecs/macx-clang-linux/ &&\\\n   cp -f $($(package)_patch_dir)/mac-qmake.conf qtbase/mkspecs/macx-clang-linux/qmake.conf && \\\ndiff --git a/depends/patches/qt/zlib-timebits64.patch b/depends/patches/qt/zlib-timebits64.patch\nnew file mode 100644\nindex 0000000000000..139c1dfa77f3e\n--- /dev/null\n+++ b/depends/patches/qt/zlib-timebits64.patch\n@@ -0,0 +1,31 @@\n+From a566e156b3fa07b566ddbf6801b517a9dba04fa3 Mon Sep 17 00:00:00 2001\n+From: Mark Adler <madler@alumni.caltech.edu>\n+Date: Sat, 29 Jul 2023 22:13:09 -0700\n+Subject: [PATCH] Avoid compiler complaints if _TIME_BITS defined when building\n+ zlib.\n+\n+zlib does not use time_t, so _TIME_BITS is irrelevant. However it\n+may be defined anyway as part of a sledgehammer indiscriminately\n+applied to all builds.\n+\n+From https://github.com/madler/zlib/commit/a566e156b3fa07b566ddbf6801b517a9dba04fa3.patch\n+---\n+ qtbase/src/3rdparty/zlib/src/gzguts.h | 5 ++---\n+ 1 file changed, 2 insertions(+), 3 deletions(-)\n+\n+diff --git a/qtbase/src/3rdparty/zlib/src/gzguts.h b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+index e23f831f5..f9375047e 100644\n+--- a/qtbase/src/3rdparty/zlib/src/gzguts.h\n++++ b/qtbase/src/3rdparty/zlib/src/gzguts.h\n+@@ -26,9 +26,8 @@\n+ #  ifndef _LARGEFILE_SOURCE\n+ #    define _LARGEFILE_SOURCE 1\n+ #  endif\n+-#  ifdef _FILE_OFFSET_BITS\n+-#    undef _FILE_OFFSET_BITS\n+-#  endif\n++#  undef _FILE_OFFSET_BITS\n++#  undef _TIME_BITS\n+ #endif\n+ \n+ #ifdef HAVE_HIDDEN\n", "instance_id": "bitcoin__bitcoin-29985", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a compilation error occurs when cross-compiling Qt for `arm-linux-gnueabihf` on Ubuntu 24.04 due to a conflict with `_TIME_BITS=64` and `_FILE_OFFSET_BITS=64` in the zlib library. The error message and context are provided, which helps in understanding the root cause. However, there are minor ambiguities and missing details. For instance, the statement mentions that switching to a system zlib is not an option but does not explain why, which could be relevant for alternative solutions. Additionally, there are no explicit mentions of expected behavior post-fix or specific constraints for the solution (e.g., compatibility with other platforms). Despite these minor gaps, the problem's goal (fixing the compilation error) is evident, and the provided error log and reference to similar issues provide sufficient context for an experienced developer to proceed.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively narrow, focusing on a specific patch to the zlib library within the Qt build system, as seen in the modifications to `qt.mk` and the addition of a new patch file. The changes are localized to a single area (zlib's header file) and involve adding a patch to undefine `_TIME_BITS`, which is a straightforward fix once the issue is understood. However, the problem requires understanding cross-compilation challenges, familiarity with build systems (e.g., Makefiles and patching in Qt's build process), and knowledge of C preprocessor directives and their implications on system headers. Additionally, the developer needs to grasp the interaction between glibc versions, architecture-specific headers, and third-party libraries like zlib. While the patch itself is small, identifying the root cause (the conflict between `_TIME_BITS` and `_FILE_OFFSET_BITS`) and ensuring the fix does not introduce regressions in other environments adds moderate complexity. Edge cases are not explicitly mentioned in the problem statement, but a developer must consider potential impacts on other architectures or glibc versions, though the provided patch seems to address the issue generically. Overall, this problem requires a moderate level of expertise in build systems and cross-compilation but does not involve deep architectural changes or highly complex logic, justifying a score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Show a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\nShow a more descriptive error message when the ConptyConnection fails to start for some reason\n# Description of the new feature/enhancement\r\n\r\nShow a speaking error message, when it is necessary to run Terminal with admin privileges. See https://github.com/microsoft/terminal/issues/4272 for the problem\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\n", "patch": "diff --git a/.github/actions/spelling/allow/allow.txt b/.github/actions/spelling/allow/allow.txt\nindex 630edfebce7..a936b3df359 100644\n--- a/.github/actions/spelling/allow/allow.txt\n+++ b/.github/actions/spelling/allow/allow.txt\n@@ -11,6 +11,7 @@ colorbrewer\n commandlines\n consvc\n copyable\n+CText\n dalet\n dcs\n deselection\ndiff --git a/src/cascadia/TerminalConnection/ConptyConnection.cpp b/src/cascadia/TerminalConnection/ConptyConnection.cpp\nindex 0a0b26aa934..075eb734356 100644\n--- a/src/cascadia/TerminalConnection/ConptyConnection.cpp\n+++ b/src/cascadia/TerminalConnection/ConptyConnection.cpp\n@@ -428,6 +428,20 @@ namespace winrt::Microsoft::Terminal::TerminalConnection::implementation\n             TerminalOutput.raise(L\"\\r\\n\");\n             TerminalOutput.raise(badPathText);\n         }\n+        // If the requested action requires elevation, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_ELEVATION_REQUIRED))\n+        {\n+            const auto elevationText = RS_(L\"ElevationRequired\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(elevationText);\n+        }\n+        // If the requested executable was not found, display appropriate message\n+        else if (hr == HRESULT_FROM_WIN32(ERROR_FILE_NOT_FOUND))\n+        {\n+            const auto fileNotFoundText = RS_(L\"FileNotFound\");\n+            TerminalOutput.raise(L\"\\r\\n\");\n+            TerminalOutput.raise(fileNotFoundText);\n+        }\n \n         _transitionToState(ConnectionState::Failed);\n \ndiff --git a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\nindex 3532e310491..82c7291a607 100644\n--- a/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalConnection/Resources/en-US/Resources.resw\n@@ -209,7 +209,7 @@\n   </data>\r\n   <data name=\"CtrlDToClose\" xml:space=\"preserve\">\r\n     <value>You can now close this terminal with Ctrl+D, or press Enter to restart.</value>\r\n-\t  <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n+    <comment>\"Ctrl+D\" and \"Enter\" represent keys the user will press (control+D and Enter).</comment>\r\n   </data>\r\n   <data name=\"ProcessFailedToLaunch\" xml:space=\"preserve\">\r\n     <value>[error {0} when launching `{1}']</value>\r\n@@ -220,4 +220,10 @@\n     <value>Could not access starting directory \"{0}\"</value>\r\n     <comment>The first argument {0} is a path to a directory on the filesystem, as provided by the user.</comment>\r\n   </data>\r\n-</root>\r\n+  <data name=\"ElevationRequired\" xml:space=\"preserve\">\r\n+    <value>The requested operation requires elevation.</value>\r\n+  </data>\r\n+  <data name=\"FileNotFound\" xml:space=\"preserve\">\r\n+    <value>The system cannot find the file specified.</value>\r\n+  </data>\r\n+</root>\n\\ No newline at end of file\n", "instance_id": "microsoft__terminal-18462", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in its intent to enhance error messaging for the ConptyConnection when it fails to start, specifically addressing scenarios like the need for admin privileges or file not found errors. It references a related GitHub issue for context, which is helpful. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define all possible failure scenarios that should be covered beyond elevation and file not found errors, nor does it specify the exact format or tone of the error messages. Additionally, there are no examples of expected output or user interaction, which could help clarify the desired outcome. Despite these minor gaps, the overall goal is understandable, and the code changes align with the stated intent, making it \"Mostly Clear.\"", "difficulty_explanation": "The difficulty of this problem is rated as Easy (0.25) based on the following analysis of the factors:\n\n1. **Scope and Depth of Code Changes:** The modifications are localized to a single file (`ConptyConnection.cpp`) for the core logic, with additional minor updates to a resource file (`Resources.resw`) for error message strings and a spelling allowance file. The changes involve adding straightforward conditional checks for specific error codes (`ERROR_ELEVATION_REQUIRED` and `ERROR_FILE_NOT_FOUND`) and outputting corresponding error messages. There is no impact on the broader system architecture or interactions with other modules, and the amount of code change is minimal (a few lines of logic and resource additions).\n\n2. **Number of Technical Concepts:** The solution requires basic knowledge of C++ (specifically handling HRESULT error codes and string resources), familiarity with the Windows API error codes, and understanding of the project's resource system for localized strings (using `RS_` macro). These concepts are relatively simple and do not involve complex algorithms, design patterns, or domain-specific knowledge beyond basic Windows terminal behavior.\n\n3. **Potential Edge Cases and Error Handling:** The problem focuses on specific error conditions already identified in the code changes (elevation required and file not found). There are no additional complex edge cases mentioned or implied in the problem statement that need to be handled. The error handling logic added is straightforward, involving direct mapping of error codes to predefined messages.\n\n4. **Overall Complexity:** This task involves simple modifications to existing error handling logic without requiring deep understanding of the codebase or significant refactoring. It is a small, self-contained enhancement that a developer with basic to intermediate skills in C++ and familiarity with the project could implement without much difficulty.\n\nThus, the difficulty score of 0.25 reflects an Easy problem that requires minimal effort and understanding to implement, fitting within the 0.2-0.4 range for tasks involving simple function modifications and basic error handling.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Focus should move to next tab when closing a tab\n<!-- \r\n🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\nWhen a tab is closed, focus should move to the tab to the right instead of to the left.\r\n\r\nIn Firefox and Chrome, when a tab is closed by clicking on 🗙, the cursor naturally lands on the following tab, and the browser shows the content of that tab, allowing the user to close multiple tabs by chain-clicking.\r\n\r\nIn Terminal, when a tab is closed by clicking on 🗙 (or by any other method), the previous tab is shown even though the cursor is on the following tab. The user must move their cursor from the 🗙, click elsewhere on the tab to preview its contents, and then decide whether to close it. An absentminded user may close important tabs because of this unexpected behavior, particularly because Terminal does not confirm tab closing #6549. Before the user moves their cursor, the tab does not show its usual hover effect, adding to the confusion.\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "patch": "diff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 30b8ec15b81..0eba4511a92 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -491,14 +491,14 @@ namespace winrt::TerminalApp::implementation\n                 // Because this will always return -1 in this scenario unfortunately.\r\n                 //\r\n                 // So, what we're going to try to do is move the focus to the tab\r\n-                // to the left, within the bounds of how many tabs we have.\r\n+                // to the right, within the bounds of how many tabs we have.\r\n                 //\r\n                 // EX: we have 4 tabs: [A, B, C, D]. If we close:\r\n                 // * A (tabIndex=0): We'll want to focus tab B (now in index 0)\r\n-                // * B (tabIndex=1): We'll want to focus tab A (now in index 0)\r\n-                // * C (tabIndex=2): We'll want to focus tab B (now in index 1)\r\n+                // * B (tabIndex=1): We'll want to focus tab C (now in index 1)\r\n+                // * C (tabIndex=2): We'll want to focus tab D (now in index 2)\r\n                 // * D (tabIndex=3): We'll want to focus tab C (now in index 2)\r\n-                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex - 1, 0, _tabs.Size() - 1);\r\n+                const auto newSelectedIndex = std::clamp<int32_t>(tabIndex, 0, _tabs.Size() - 1);\r\n                 // _UpdatedSelectedTab will do the work of setting up the new tab as\r\n                 // the focused one, and unfocusing all the others.\r\n                 auto newSelectedTab{ _tabs.GetAt(newSelectedIndex) };\r\n", "instance_id": "microsoft__terminal-18022", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the desired behavior change: when a tab is closed in a terminal application, the focus should move to the tab on the right rather than the left, aligning with the behavior of popular web browsers like Firefox and Chrome. The description provides context on why this change is important, highlighting user experience issues such as potential confusion and accidental tab closures. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly address what should happen if the rightmost tab is closed (though the code change implies a fallback to the previous tab). Additionally, there are no specific examples or test cases provided to cover edge cases, such as closing the last tab or handling a single-tab scenario. While the intent is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range. The code change required is minimal and localized to a single file (`TabManagement.cpp`) and a specific function within it. The modification involves changing a simple logic for determining the next selected tab index after a tab closure, which is achieved by altering a single line of code (adjusting the `std::clamp` operation to focus on the right tab instead of the left). This does not require deep understanding of the broader codebase or complex interactions between modules, nor does it impact the system's architecture. The technical concepts involved are basic—simple arithmetic for index calculation and familiarity with C++ standard library functions like `std::clamp`. There are no significant edge cases or error handling requirements introduced by this change beyond what is already handled in the existing code (e.g., clamping the index within valid bounds). Overall, this is a straightforward bug fix or minor feature adjustment that a junior developer with basic C++ knowledge could implement with minimal guidance.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Crash when choosing 'Close all other panes'\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.27699.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1.\tOpen Windows Terminal.\r\n2.\tSplit panes so there are at least two panes.\r\n3.\tCtrl+Shift+P and choose ‘Close all other panes’\r\n\n\n### Expected Behavior\n\nNo crash.\n\n### Actual Behavior\n\nTerminal crashes with an access violation:\r\n\r\n```\r\n(3c78.4aa0): Access violation - code c0000005 (first/second chance not available)\r\nFor analysis of this file, run !analyze -v\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress+0x34 [inlined in TerminalApp!Pane::CollectTaskbarStates+0x82]:\r\n00007ffb`45483032 488b01          mov     rax,qword ptr [rcx] ds:00000000`00000000=????????????????\r\n```\r\n\r\nHere is the call stack:\r\n\r\n```\r\nTerminalApp!winrt::impl::consume_TerminalApp_IPaneContent<winrt::TerminalApp::IPaneContent>::TaskbarProgress\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!Pane::CollectTaskbarStates\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalTab::GetCombinedTaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalPage::TaskbarState\r\nTerminalApp!winrt::TerminalApp::implementation::TerminalWindow::TaskbarState\r\nTerminalApp!winrt::impl::produce<winrt::TerminalApp::implementation::TerminalWindow,winrt::TerminalApp::ITerminalWindow>::get_TaskbarState\r\nWindowsTerminal\r\nWindowsTerminal\r\nTerminalApp!winrt::Windows::Foundation::TypedEventHandler<winrt::Windows::Foundation::IInspectable,winrt::Windows::Foundation::IInspectable>::operator()\r\nTerminalApp!wil::details::dispatcher_handler::operator()\r\nTerminalApp!winrt::impl::delegate<winrt::Windows::UI::Core::DispatchedHandler,wil::details::dispatcher_handler>::Invoke\r\nWindows_UI!Microsoft::WRL::Details::DelegateArgTraits<long (__cdecl Windows::System::IDispatcherQueueHandler::*)(void)>::DelegateInvokeHelper<Microsoft::WRL::Implements<Microsoft::WRL::RuntimeClassFlags<2>,Windows::System::IDispatcherQueueHandler,Microsoft::WRL::FtmBase>,<lambda_980f345bc6e4ac8a906323c24a5fe9b1>,-1>::Invoke\r\nCoreMessaging!Windows::System::DispatcherQueue::DeferInvokeCallback\r\nCoreMessaging!CFlat::SehSafe::Execute<<lambda_654db17c35df07198786f0867aa10de6> >\r\nCoreMessaging!Microsoft::CoreUI::ActionCallback::ImportAdapter$\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCall::Callback_Dispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::DeferredCallDispatcher::Callback_OnDispatch\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::Dispatcher::Callback_DispatchLoop\r\nCoreMessaging!Microsoft::CoreUI::Dispatch::EventLoop::Callback_RunCoreLoop\r\nuser32!_fnDWORD\r\nntdll!KiUserCallbackDispatcherContinue\r\nwin32u!NtUserGetMessage\r\nuser32!GetMessageW\r\nWindowsTerminal\r\nWindowsTerminal\r\nWindowsTerminal\r\nucrtbase!thread_start<unsigned int (__cdecl*)(void *),1>\r\nKERNEL32!BaseThreadInitThunk\r\nntdll!RtlUserThreadStart\r\n```\n", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex a210b701528..dc235b06024 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -2956,13 +2956,13 @@ bool Pane::ContainsReadOnly() const\n // - <none>\r\n void Pane::CollectTaskbarStates(std::vector<winrt::TerminalApp::TaskbarState>& states)\r\n {\r\n-    if (_IsLeaf())\r\n+    if (_content)\r\n     {\r\n         auto tbState{ winrt::make<winrt::TerminalApp::implementation::TaskbarState>(_content.TaskbarState(),\r\n                                                                                     _content.TaskbarProgress()) };\r\n         states.push_back(tbState);\r\n     }\r\n-    else\r\n+    else if (_firstChild && _secondChild)\r\n     {\r\n         _firstChild->CollectTaskbarStates(states);\r\n         _secondChild->CollectTaskbarStates(states);\r\n", "instance_id": "microsoft__terminal-17886", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash occurs in Windows Terminal when selecting \"Close all other panes\" under specific conditions (having at least two panes open). The steps to reproduce are well-defined, and the expected behavior (no crash) versus actual behavior (crash with access violation) is explicitly stated. Additionally, a detailed call stack is provided, which helps in identifying the problematic area of the codebase. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this issue occurs under specific configurations or environments beyond the provided Windows Terminal and build versions. Edge cases, such as the behavior with different types of content in panes or varying numbers of panes, are not mentioned. These omissions prevent the statement from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, confined to a single file (`Pane.cpp`) and a small modification in the `CollectTaskbarStates` method. The change addresses a null pointer dereference issue by adding a check for `_content` before accessing it and ensuring both child panes exist before recursion. This indicates a straightforward bug fix rather than a complex feature addition or architectural change. Second, the technical concepts involved are basic: understanding null pointer checks and conditional logic in C++ within the context of the Windows Terminal codebase. No advanced algorithms, design patterns, or domain-specific knowledge beyond general C++ programming and familiarity with the project's structure are required. Third, while the crash itself is a critical issue, the provided call stack and code diff pinpoint the root cause (likely accessing a null `_content` after closing panes), reducing the debugging effort. Edge cases and error handling are not extensively discussed in the problem statement, but the fix itself does not introduce complex error handling logic beyond a simple null check. Overall, this problem requires understanding some code logic and making a simple modification, justifying a difficulty score of 0.30.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Better icons for Visual Studio Developer Command Prompt/Powershell profiles\n<!-- \r\n🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨\r\n\r\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\r\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\r\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\r\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\r\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\r\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\r\n\r\nAll good? Then proceed!\r\n-->\r\n\r\n# Description of the new feature/enhancement\r\nCustom icons for the `Developer PowerShell for VS 2022` and `Developer Command Prompt for VS 2022` profiles would be a nice touch.\r\n\r\n![5tXWrREqj0](https://github.com/user-attachments/assets/2456f899-1a19-4dfe-848c-e8543d339584)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what the problem is that the new feature would solve.\r\nDescribe why and how a user would use this new functionality (if applicable).\r\n-->\r\n\r\n# Proposed technical implementation details (optional)\r\nInclude images in the app's `ProfileIcons/` directory and automatically use them for said profiles. I threw these together in GIMP. If they are satisfactory, feel free to use them.\r\n\r\n![cmd_vs](https://github.com/user-attachments/assets/1d3da7f9-1de7-40f1-9932-196fa10ec130)\r\n\r\n![powershell5_vs](https://github.com/user-attachments/assets/1cb5ab60-31b2-4825-8666-74eca7b243fa)\r\n\r\n\r\n<!-- \r\nA clear and concise description of what you want to happen.\r\n-->\r\n\n", "patch": "diff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png\nnew file mode 100644\nindex 00000000000..9e712ad8d95\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png\nnew file mode 100644\nindex 00000000000..82aa697c74f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png\nnew file mode 100644\nindex 00000000000..ea8c240656d\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-cmd.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png\nnew file mode 100644\nindex 00000000000..54a8c126ff7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png\nnew file mode 100644\nindex 00000000000..66486474a59\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png\nnew file mode 100644\nindex 00000000000..68aa47b458f\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-powershell.scale-200.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png\nnew file mode 100644\nindex 00000000000..1fa174e5ac7\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-100.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png\nnew file mode 100644\nindex 00000000000..57615ac57ee\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-150.png differ\ndiff --git a/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png\nnew file mode 100644\nindex 00000000000..d7f31d5d715\nBinary files /dev/null and b/src/cascadia/CascadiaPackage/ProfileIcons/vs-pwsh.scale-200.png differ\ndiff --git a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\nindex 3d576f60603..6febe041d67 100644\n--- a/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n+++ b/src/cascadia/TerminalSettingsModel/CascadiaSettingsSerialization.cpp\n@@ -20,9 +20,6 @@\n #include \"SshHostGenerator.h\"\r\n #endif\r\n \r\n-// userDefault.h is like the above, but with a default template for the user's settings.json.\r\n-#include <LegacyProfileGeneratorNamespaces.h>\r\n-\r\n #include \"ApplicationState.h\"\r\n #include \"DefaultTerminal.h\"\r\n #include \"FileUtils.h\"\r\n@@ -465,6 +462,11 @@ bool SettingsLoader::FixupUserSettings()\n         CommandlinePatch{ DEFAULT_WINDOWS_POWERSHELL_GUID, L\"powershell.exe\", L\"%SystemRoot%\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\" },\r\n     };\r\n \r\n+    static constexpr std::array iconsToClearFromVisualStudioProfiles{\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\" },\r\n+        std::wstring_view{ L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\" },\r\n+    };\r\n+\r\n     auto fixedUp = userSettings.fixupsAppliedDuringLoad;\r\n     fixedUp = userSettings.globals->FixupsAppliedDuringLoad() || fixedUp;\r\n \r\n@@ -473,28 +475,39 @@ bool SettingsLoader::FixupUserSettings()\n     {\r\n         fixedUp = RemapColorSchemeForProfile(profile) || fixedUp;\r\n \r\n-        if (!profile->HasCommandline())\r\n+        if (profile->HasCommandline())\r\n         {\r\n-            continue;\r\n+            for (const auto& patch : commandlinePatches)\r\n+            {\r\n+                if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+                {\r\n+                    profile->ClearCommandline();\r\n+\r\n+                    // GH#12842:\r\n+                    // With the commandline field on the user profile gone, it's actually unknown what\r\n+                    // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n+                    // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n+                    if (profile->Commandline() != patch.after)\r\n+                    {\r\n+                        profile->Commandline(winrt::hstring{ patch.after });\r\n+                    }\r\n+\r\n+                    fixedUp = true;\r\n+                    break;\r\n+                }\r\n+            }\r\n         }\r\n \r\n-        for (const auto& patch : commandlinePatches)\r\n+        if (profile->HasIcon() && profile->HasSource() && profile->Source() == VisualStudioGenerator::Namespace)\r\n         {\r\n-            if (profile->Guid() == patch.guid && til::equals_insensitive_ascii(profile->Commandline(), patch.before))\r\n+            for (auto&& icon : iconsToClearFromVisualStudioProfiles)\r\n             {\r\n-                profile->ClearCommandline();\r\n-\r\n-                // GH#12842:\r\n-                // With the commandline field on the user profile gone, it's actually unknown what\r\n-                // commandline it'll inherit, since a user profile can have multiple parents. We have to\r\n-                // make sure we restore the correct commandline in case we don't inherit the expected one.\r\n-                if (profile->Commandline() != patch.after)\r\n+                if (profile->Icon() == icon)\r\n                 {\r\n-                    profile->Commandline(winrt::hstring{ patch.after });\r\n+                    profile->ClearIcon();\r\n+                    fixedUp = true;\r\n+                    break;\r\n                 }\r\n-\r\n-                fixedUp = true;\r\n-                break;\r\n             }\r\n         }\r\n     }\r\ndiff --git a/src/cascadia/TerminalSettingsModel/Profile.cpp b/src/cascadia/TerminalSettingsModel/Profile.cpp\nindex 0f568b37e53..66382c857b1 100644\n--- a/src/cascadia/TerminalSettingsModel/Profile.cpp\n+++ b/src/cascadia/TerminalSettingsModel/Profile.cpp\n@@ -329,7 +329,7 @@ Json::Value Profile::ToJson() const\n     // Recall: Icon isn't actually a setting in the MTSM_PROFILE_SETTINGS. We\r\n     // defined it manually in Profile, so make sure we only serialize the Icon\r\n     // if the user actually changed it here.\r\n-    JsonUtils::SetValueForKey(json, IconKey, (writeBasicSettings && HasIcon()) ? Icon() : _Icon);\r\n+    JsonUtils::SetValueForKey(json, IconKey, _Icon);\r\n \r\n     // PermissiveStringConverter is unnecessary for serialization\r\n     JsonUtils::SetValueForKey(json, PaddingKey, _Padding);\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\nindex 3fd3bca8a71..2fcfb1cc528 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.cpp\n@@ -9,9 +9,11 @@\n \r\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n \r\n+std::wstring_view VisualStudioGenerator::Namespace{ L\"Windows.Terminal.VisualStudio\" };\r\n+\r\n std::wstring_view VisualStudioGenerator::GetNamespace() const noexcept\r\n {\r\n-    return std::wstring_view{ L\"Windows.Terminal.VisualStudio\" };\r\n+    return Namespace;\r\n }\r\n \r\n void VisualStudioGenerator::GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\nindex 766d2cd7775..ef36284db74 100644\n--- a/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VisualStudioGenerator.h\n@@ -26,6 +26,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n     class VisualStudioGenerator : public IDynamicProfileGenerator\r\n     {\r\n     public:\r\n+        static std::wstring_view Namespace;\r\n         std::wstring_view GetNamespace() const noexcept override;\r\n         void GenerateProfiles(std::vector<winrt::com_ptr<implementation::Profile>>& profiles) const override;\r\n \r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\nindex dd5d42dba38..eab94e89546 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevCmdGenerator.h\n@@ -41,7 +41,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{0caa0dad-35be-5f56-a8ff-afceeeaa6101}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-cmd.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\nindex b7d14e8b951..7557b503c0b 100644\n--- a/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n+++ b/src/cascadia/TerminalSettingsModel/VsDevShellGenerator.h\n@@ -38,7 +38,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model\n \r\n         std::wstring GetProfileIconPath() const\r\n         {\r\n-            return L\"ms-appx:///ProfileIcons/{61c54bbd-c2c6-5271-96e7-009a87ff44bf}.png\";\r\n+            return L\"ms-appx:///ProfileIcons/vs-powershell.png\";\r\n         }\r\n \r\n         std::wstring GetProfileName(const VsSetupConfiguration::VsSetupInstance& instance) const;\r\n", "instance_id": "microsoft__terminal-17706", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent to add custom icons for Visual Studio Developer Command Prompt and PowerShell profiles. It provides a description of the desired feature and includes images of the proposed icons, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define how the icons should be integrated into the application (beyond placing them in a directory) or specify any constraints or requirements for icon formats, sizes, or naming conventions beyond what is shown in the code changes. Additionally, there is no mention of potential edge cases, such as what should happen if the icons are missing or if there are conflicts with existing icons. While the proposed technical implementation is provided, it lacks depth in terms of integration logic or expected behavior in the application. Overall, the statement is valid and clear in its primary objective but misses some finer details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the relatively straightforward nature of the task. Let's break it down based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes**: The code changes involve adding new icon files to a specific directory and modifying a few source files to reference these icons for Visual Studio profiles. The changes span multiple files but are mostly localized to updating paths and clearing outdated icon references. The modifications do not appear to impact the broader system architecture significantly, as they are confined to profile settings and icon handling. The amount of code change is moderate, with a mix of binary file additions (icons) and textual changes in C++ files.\n\n2. **Number of Technical Concepts**: Solving this problem requires a basic understanding of C++ (given the codebase context), file path handling, and how profile settings are managed in the application (likely Windows Terminal or a related project). There are no complex algorithms, design patterns, or advanced language features involved. The primary technical challenge is understanding the profile generation and settings serialization logic to ensure the new icons are correctly applied, which is relatively simple for someone familiar with the codebase or C++ in general.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, and the code changes do not introduce significant error handling logic. However, there are implicit considerations, such as ensuring the icon files are present and correctly referenced, or handling cases where user settings might override the default icons. These are minor and do not add substantial complexity to the task.\n\n4. **Overall Complexity**: The task involves understanding a small part of the codebase related to profile settings and making targeted updates. It does not require deep architectural changes or advanced domain-specific knowledge beyond basic application configuration. The changes are more about integration than innovation, fitting well within the \"Easy\" category. I’ve rated it slightly higher within this range (0.35) due to the need to navigate and modify multiple files and understand the profile settings logic, which adds a small layer of complexity compared to a single-file change or a trivial update.\n\nIn summary, this is an easy problem that requires moderate familiarity with the codebase and straightforward modifications to implement custom icons for specific profiles. It does not pose significant technical challenges or require handling complex edge cases.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Terminal crashes when closing any other pane than the last\n### Windows Terminal version\r\n\r\n1.21.1272.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.3593\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nopen terminal. split horizontally twice. change to middle pane. CTRL-D -- crash.\r\n\r\ni have mouse tracking turned on if relevant\r\n\r\n![term-crash](https://github.com/microsoft/terminal/assets/46322585/fbb48d78-ecf0-4ced-8d41-5995c179b7ce)\r\n\r\n\r\n### Expected Behavior\r\n\r\nobviously, no crash :)\r\n\r\n### Actual Behavior\r\n\r\nit crashes and takes \"a long time\" to start\n", "patch": "diff --git a/src/cascadia/TerminalApp/Pane.cpp b/src/cascadia/TerminalApp/Pane.cpp\nindex fd195d8d42a..899e67e14ec 100644\n--- a/src/cascadia/TerminalApp/Pane.cpp\n+++ b/src/cascadia/TerminalApp/Pane.cpp\n@@ -467,7 +467,7 @@ std::shared_ptr<Pane> Pane::NextPane(const std::shared_ptr<Pane> targetPane)\n     std::shared_ptr<Pane> nextPane = nullptr;\r\n     auto foundTarget = false;\r\n \r\n-    auto foundNext = WalkTree([&](auto pane) {\r\n+    auto foundNext = WalkTree([&](const auto& pane) {\r\n         // If we are a parent pane we don't want to move to one of our children\r\n         if (foundTarget && targetPane->_HasChild(pane))\r\n         {\r\n@@ -985,6 +985,17 @@ void Pane::_ContentLostFocusHandler(const winrt::Windows::Foundation::IInspectab\n // - <none>\r\n void Pane::Close()\r\n {\r\n+    // Pane has two events, CloseRequested and Closed. CloseRequested is raised by the content asking to be closed,\r\n+    // but also by the window who owns the tab when it's closing. The event is then caught by the TerminalTab which\r\n+    // calls Close() which then raises the Closed event. Now, if this is the last pane in the window, this will result\r\n+    // in the window raising CloseRequested again which leads to infinite recursion, so we need to guard against that.\r\n+    // Ideally we would have just a single event in the future.\r\n+    if (_closed)\r\n+    {\r\n+        return;\r\n+    }\r\n+\r\n+    _closed = true;\r\n     // Fire our Closed event to tell our parent that we should be removed.\r\n     Closed.raise(nullptr, nullptr);\r\n }\r\n@@ -1341,7 +1352,7 @@ std::shared_ptr<Pane> Pane::DetachPane(std::shared_ptr<Pane> pane)\n         detached->_ApplySplitDefinitions();\r\n \r\n         // Trigger the detached event on each child\r\n-        detached->WalkTree([](auto pane) {\r\n+        detached->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -1542,7 +1553,7 @@ void Pane::_CloseChild(const bool closeFirst)\n         {\r\n             // update our path to our first remaining leaf\r\n             _parentChildPath = _firstChild;\r\n-            _firstChild->WalkTree([](auto p) {\r\n+            _firstChild->WalkTree([](const auto& p) {\r\n                 if (p->_IsLeaf())\r\n                 {\r\n                     return true;\r\n@@ -2398,7 +2409,7 @@ void Pane::Id(uint32_t id) noexcept\n bool Pane::FocusPane(const uint32_t id)\r\n {\r\n     // Always clear the parent child path if we are focusing a leaf\r\n-    return WalkTree([=](auto p) {\r\n+    return WalkTree([=](const auto& p) {\r\n         p->_parentChildPath.reset();\r\n         if (p->_id == id)\r\n         {\r\n@@ -2421,7 +2432,7 @@ bool Pane::FocusPane(const uint32_t id)\n // - true if focus was set\r\n bool Pane::FocusPane(const std::shared_ptr<Pane> pane)\r\n {\r\n-    return WalkTree([&](auto p) {\r\n+    return WalkTree([&](const auto& p) {\r\n         if (p == pane)\r\n         {\r\n             p->_Focus();\r\ndiff --git a/src/cascadia/TerminalApp/Pane.h b/src/cascadia/TerminalApp/Pane.h\nindex f25a7b0834a..86757ad36f9 100644\n--- a/src/cascadia/TerminalApp/Pane.h\n+++ b/src/cascadia/TerminalApp/Pane.h\n@@ -248,7 +248,7 @@ class Pane : public std::enable_shared_from_this<Pane>\n \r\n     std::optional<uint32_t> _id;\r\n     std::weak_ptr<Pane> _parentChildPath{};\r\n-\r\n+    bool _closed{ false };\r\n     bool _lastActive{ false };\r\n     winrt::event_token _firstClosedToken{ 0 };\r\n     winrt::event_token _secondClosedToken{ 0 };\r\ndiff --git a/src/cascadia/TerminalApp/TabManagement.cpp b/src/cascadia/TerminalApp/TabManagement.cpp\nindex 3053d746df2..8ef5a36584e 100644\n--- a/src/cascadia/TerminalApp/TabManagement.cpp\n+++ b/src/cascadia/TerminalApp/TabManagement.cpp\n@@ -739,7 +739,7 @@ namespace winrt::TerminalApp::implementation\n             }\r\n \r\n             // Clean read-only mode to prevent additional prompt if closing the pane triggers closing of a hosting tab\r\n-            pane->WalkTree([](auto p) {\r\n+            pane->WalkTree([](const auto& p) {\r\n                 if (const auto control{ p->GetTerminalControl() })\r\n                 {\r\n                     if (control.ReadOnly())\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex ca86bb80a37..54a3e4efe09 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -3810,7 +3810,7 @@ namespace winrt::TerminalApp::implementation\n             // recipe for disaster. We won't ever open up a tab in this window.\n             newTerminalArgs.Elevate(false);\n             const auto newPane = _MakePane(newTerminalArgs, nullptr, connection);\n-            newPane->WalkTree([](auto pane) {\n+            newPane->WalkTree([](const auto& pane) {\n                 pane->FinalizeConfigurationGivenDefault();\n             });\n             _CreateNewTabFromPane(newPane);\ndiff --git a/src/cascadia/TerminalApp/TerminalTab.cpp b/src/cascadia/TerminalApp/TerminalTab.cpp\nindex d3e52d4037d..6e1be17e38b 100644\n--- a/src/cascadia/TerminalApp/TerminalTab.cpp\n+++ b/src/cascadia/TerminalApp/TerminalTab.cpp\n@@ -41,7 +41,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         auto firstId = _nextPaneId;\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // update the IDs on each pane\r\n             if (pane->_IsLeaf())\r\n             {\r\n@@ -203,7 +203,7 @@ namespace winrt::TerminalApp::implementation\n     {\r\n         ASSERT_UI_THREAD();\r\n \r\n-        _rootPane->WalkTree([&](std::shared_ptr<Pane> pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             // Attach event handlers to each new pane\r\n             _AttachEventHandlersToPane(pane);\r\n             if (auto content = pane->GetContent())\r\n@@ -275,7 +275,7 @@ namespace winrt::TerminalApp::implementation\n         _UpdateHeaderControlMaxWidth();\r\n \r\n         // Update the settings on all our panes.\r\n-        _rootPane->WalkTree([&](auto pane) {\r\n+        _rootPane->WalkTree([&](const auto& pane) {\r\n             pane->UpdateSettings(settings);\r\n             return false;\r\n         });\r\n@@ -534,7 +534,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -624,7 +624,7 @@ namespace winrt::TerminalApp::implementation\n         // manually.\r\n         _rootPane->Closed(_rootClosedToken);\r\n         auto p = _rootPane;\r\n-        p->WalkTree([](auto pane) {\r\n+        p->WalkTree([](const auto& pane) {\r\n             pane->Detached.raise(pane);\r\n         });\r\n \r\n@@ -650,7 +650,7 @@ namespace winrt::TerminalApp::implementation\n \r\n         // Add the new event handlers to the new pane(s)\r\n         // and update their ids.\r\n-        pane->WalkTree([&](auto p) {\r\n+        pane->WalkTree([&](const auto& p) {\r\n             _AttachEventHandlersToPane(p);\r\n             if (p->_IsLeaf())\r\n             {\r\n@@ -949,26 +949,20 @@ namespace winrt::TerminalApp::implementation\n \r\n         events.CloseRequested = content.CloseRequested(\r\n             winrt::auto_revoke,\r\n-            [dispatcher, weakThis](auto sender, auto&&) -> winrt::fire_and_forget {\r\n-                // Don't forget! this ^^^^^^^^ sender can't be a reference, this is a async callback.\r\n-\r\n-                // The lambda lives in the `std::function`-style container owned by `control`. That is, when the\r\n-                // `control` gets destroyed the lambda struct also gets destroyed. In other words, we need to\r\n-                // copy `weakThis` onto the stack, because that's the only thing that gets captured in coroutines.\r\n-                // See: https://devblogs.microsoft.com/oldnewthing/20211103-00/?p=105870\r\n-                const auto weakThisCopy = weakThis;\r\n-                co_await wil::resume_foreground(dispatcher);\r\n-                // Check if Tab's lifetime has expired\r\n-                if (auto tab{ weakThisCopy.get() })\r\n+            [this](auto&& sender, auto&&) {\r\n+                if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n                 {\r\n-                    if (const auto content{ sender.try_as<TerminalApp::IPaneContent>() })\r\n+                    // Calling Close() while walking the tree is not safe, because Close() mutates the tree.\r\n+                    const auto pane = _rootPane->_FindPane([&](const auto& p) -> std::shared_ptr<Pane> {\r\n+                        if (p->GetContent() == content)\r\n+                        {\r\n+                            return p;\r\n+                        }\r\n+                        return {};\r\n+                    });\r\n+                    if (pane)\r\n                     {\r\n-                        tab->_rootPane->WalkTree([content](std::shared_ptr<Pane> pane) {\r\n-                            if (pane->GetContent() == content)\r\n-                            {\r\n-                                pane->Close();\r\n-                            }\r\n-                        });\r\n+                        pane->Close();\r\n                     }\r\n                 }\r\n             });\r\n", "instance_id": "microsoft__terminal-17333", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a crash occurs in Windows Terminal when closing a pane other than the last one under specific conditions (splitting panes horizontally and using CTRL-D to close the middle pane). The steps to reproduce are provided, along with the expected behavior (no crash) and actual behavior (crash and slow restart). However, there are minor ambiguities and missing details. For instance, the problem does not specify whether the crash is consistent across different configurations or environments beyond the mentioned Windows build and Terminal version. Additionally, there are no explicit mentions of edge cases or constraints (e.g., does this happen only with specific terminal content or settings beyond mouse tracking?). While the issue is valid and reproducible based on the description, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the clarity of the problem is adequate but requires the developer to infer some details, adding to the initial understanding effort. Second, the scope of code changes spans multiple files (Pane.cpp, Pane.h, TabManagement.cpp, TerminalPage.cpp, TerminalTab.cpp), indicating a need to understand interactions across different parts of the Windows Terminal codebase, particularly the pane and tab management logic. The changes involve critical modifications, such as preventing infinite recursion in the `Close()` method by adding a guard (`_closed`), and adjusting tree traversal lambdas to use `const auto&` for safety and correctness. Third, the technical concepts involved include understanding C++ lambda captures, event handling in a UI context, tree traversal algorithms, and the specific architecture of Windows Terminal's pane and tab system. These are moderately complex and require familiarity with the codebase's design patterns. Finally, while the problem statement does not explicitly mention edge cases, the code changes suggest handling critical scenarios like preventing recursive event loops during pane closure, which is a non-trivial error handling concern. Overall, solving this requires a deep understanding of the codebase and careful modification to avoid introducing new issues, justifying a score of 0.65, leaning towards the harder end of the spectrum but not reaching the \"Very Hard\" category due to the absence of system-level or highly domain-specific challenges.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Unhandled permission denied exception in plugin-manager.cc\nWhen the chunkserver plugin is not installed (as is the default in CMake right now), it will try to load the plugin from the build directory, which may not be available (could be either permissions or it could not exist, very common when transitioning from a build environment), this causes a exception which is handled by initialize, which then causes the program exits. This is undesired as chunkserver can work without a plugin.\r\n\r\nReproduce:\r\n\r\n1. Build and install from directory where `saunafs` (or whatever user is running chunkserver) cannot access the build files.\r\n2. Run chunkserver\r\n\r\nPotential fix:\r\n\r\n```diff\r\ndiff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\nindex 30fa071a..69cf5568 100644\r\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\r\n@@ -19,19 +19,27 @@\r\n #include \"common/platform.h\"\r\n \r\n #include \"chunkserver-common/plugin_manager.h\"\r\n+#include <boost/filesystem/exception.hpp>\r\n \r\n #include \"chunkserver-common/disk_plugin.h\"\r\n #include \"slogger/slogger.h\"\r\n \r\n bool PluginManager::loadPlugins(const std::string &directory) {\r\n-\tif (!boost::filesystem::is_directory(directory) ||\r\n-\t    boost::filesystem::is_empty(directory)) {\r\n-\t\t// It is normal to not have any plugins in many scenarios\r\n-\t\tsafs_pretty_syslog(\r\n-\t\t    LOG_NOTICE,\r\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n-\t\t    directory.c_str());\r\n-\t\treturn false;\r\n+\ttry {\r\n+\t\tif (!boost::filesystem::is_directory(directory) ||\r\n+\t\t    boost::filesystem::is_empty(directory)) {\r\n+\t\t\t// It is normal to not have any plugins in many scenarios\r\n+\t\t\tsafs_pretty_syslog(\r\n+\t\t\t    LOG_NOTICE,\r\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\r\n+\t\t\t    directory.c_str());\r\n+\t\t\treturn false;\r\n+\t\t}\r\n+\t} catch (boost::filesystem::filesystem_error &e) {\r\n+\t\t\tsafs::log_info(\r\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\r\n+\t\t\t    directory.c_str(), e.what());\r\n+\t\t\treturn false;\r\n \t}\r\n \r\n \tboost::filesystem::path dir(directory);\r\n```\r\n\r\nOther idea is to include the chunkserver plugin by default when installing\n", "patch": "diff --git a/src/chunkserver/chunkserver-common/plugin_manager.cc b/src/chunkserver/chunkserver-common/plugin_manager.cc\nindex 30fa071a6..69cf5568a 100644\n--- a/src/chunkserver/chunkserver-common/plugin_manager.cc\n+++ b/src/chunkserver/chunkserver-common/plugin_manager.cc\n@@ -19,19 +19,27 @@\n #include \"common/platform.h\"\n \n #include \"chunkserver-common/plugin_manager.h\"\n+#include <boost/filesystem/exception.hpp>\n \n #include \"chunkserver-common/disk_plugin.h\"\n #include \"slogger/slogger.h\"\n \n bool PluginManager::loadPlugins(const std::string &directory) {\n-\tif (!boost::filesystem::is_directory(directory) ||\n-\t    boost::filesystem::is_empty(directory)) {\n-\t\t// It is normal to not have any plugins in many scenarios\n-\t\tsafs_pretty_syslog(\n-\t\t    LOG_NOTICE,\n-\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n-\t\t    directory.c_str());\n-\t\treturn false;\n+\ttry {\n+\t\tif (!boost::filesystem::is_directory(directory) ||\n+\t\t    boost::filesystem::is_empty(directory)) {\n+\t\t\t// It is normal to not have any plugins in many scenarios\n+\t\t\tsafs_pretty_syslog(\n+\t\t\t    LOG_NOTICE,\n+\t\t\t    \"PluginManager: Directory %s does not exist or is empty\",\n+\t\t\t    directory.c_str());\n+\t\t\treturn false;\n+\t\t}\n+\t} catch (boost::filesystem::filesystem_error &e) {\n+\t\t\tsafs::log_info(\n+\t\t\t    \"PluginManager: Directory {} cannot not be checked: {}\",\n+\t\t\t    directory.c_str(), e.what());\n+\t\t\treturn false;\n \t}\n \n \tboost::filesystem::path dir(directory);\n", "instance_id": "leil-io__saunafs-237", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: an unhandled permission denied exception in the plugin manager when the chunkserver plugin is not installed or accessible, leading to an undesired program exit. It provides steps to reproduce the issue and a potential fix via a code diff. However, there are minor ambiguities and missing details. For instance, the statement does not explicitly define the expected behavior beyond \"chunkserver can work without a plugin,\" nor does it mention specific edge cases or constraints (e.g., what should happen if partial access to the directory is available). Additionally, the alternative idea of including the plugin by default is mentioned but not elaborated upon, leaving some uncertainty about the full scope of the desired solution. Overall, the problem is valid and mostly clear, but these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is localized to a single function in `plugin_manager.cc` and involves a small, focused modification—wrapping the directory check in a try-catch block to handle filesystem errors. It does not impact multiple modules or the broader system architecture, and the amount of code change is minimal (adding exception handling and logging).\n\n2. **Technical Concepts Involved:** The solution requires understanding basic C++ exception handling and familiarity with the Boost Filesystem library, specifically `boost::filesystem::filesystem_error`. These are relatively straightforward concepts for a developer with moderate experience in C++. No advanced algorithms, design patterns, or domain-specific knowledge are needed beyond basic filesystem operations and error logging.\n\n3. **Edge Cases and Error Handling:** The problem focuses on handling a specific error condition (permission denied or non-existent directory), and the provided solution addresses this directly with a catch block. While there might be minor edge cases (e.g., partial directory access or other filesystem errors), they are not mentioned in the problem statement and do not appear to significantly complicate the solution. The error handling logic added is simple and does not require complex decision-making.\n\n4. **Overall Complexity:** The fix is a straightforward bug resolution that does not require deep understanding of the broader codebase or intricate interactions between components. It is a contained change with minimal risk of introducing side effects, assuming the logging and return behavior align with the system's expectations.\n\nGiven these points, a difficulty score of 0.25 reflects the simplicity of the task, requiring only a basic understanding of C++ error handling and a small, targeted code modification. It is slightly above the \"Very Easy\" range due to the need to understand the Boost library's exception mechanism and ensure proper logging, but it remains an easy problem overall.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Invalid TypeScript type for event 'transactions-updated'\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n32.2.8\n\n### What operating system(s) are you using?\n\nOther (specify below)\n\n### Operating System Version\n\n...\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\n_No response_\n\n### Expected Behavior\n\nExpected type:\n```ts\non(event: 'transactions-updated', listener: (event: Event, transactions: Transaction[]) => void): this;\n```\n\n### Actual Behavior\n\nActual type:\n```ts\non(event: 'transactions-updated', listener: () => void): this;\n```\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nDocs: https://www.electronjs.org/docs/latest/api/in-app-purchase#event-transactions-updated\n", "patch": "diff --git a/docs/api/in-app-purchase.md b/docs/api/in-app-purchase.md\nindex 38078ecf29dd7..0fed7b8c2c1b6 100644\n--- a/docs/api/in-app-purchase.md\n+++ b/docs/api/in-app-purchase.md\n@@ -10,13 +10,13 @@ The `inAppPurchase` module emits the following events:\n \n ### Event: 'transactions-updated'\n \n-Emitted when one or more transactions have been updated.\n-\n Returns:\n \n * `event` Event\n * `transactions` Transaction[] - Array of [`Transaction`](structures/transaction.md) objects.\n \n+Emitted when one or more transactions have been updated.\n+\n ## Methods\n \n The `inAppPurchase` module has the following methods:\n", "instance_id": "electron__electron-45527", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: there is a mismatch between the expected and actual TypeScript type definitions for the 'transactions-updated' event in the Electron framework's in-app-purchase module. The expected behavior (listener function with parameters for event and transactions) and actual behavior (listener function with no parameters) are explicitly provided, which helps in understanding the goal of the fix. However, there are minor ambiguities and missing details. For instance, the problem statement does not specify whether this mismatch affects runtime behavior or is purely a type definition issue in the documentation or type files. Additionally, there are no examples of code that would fail due to this mismatch, nor are there mentions of specific edge cases or constraints to consider when fixing the type definition. The provided documentation link is helpful, but the lack of deeper context about the impact or related codebase components slightly reduces clarity.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range, as it involves a straightforward fix to documentation or type definitions. The code change provided is minimal, affecting only a single line in the documentation file (in-app-purchase.md) to reorder the description and parameters of the 'transactions-updated' event for better clarity. However, based on the problem statement, the actual fix might also involve updating a TypeScript definition file (e.g., a .d.ts file) which is not shown in the provided diff. Even so, this task requires only basic knowledge of TypeScript type definitions and Electron's API structure. It does not involve complex logic, multiple files (beyond potentially one or two), or deep understanding of the codebase architecture. There are no significant edge cases or error handling requirements mentioned, and the change has no impact on runtime behavior or system architecture. The primary challenge is ensuring the type definition aligns with the actual implementation, which is a simple verification task. Thus, I assign a difficulty score of 0.15, reflecting a very easy problem with minimal technical depth.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Documentation request] Explain why someone might enable the fuse `loadBrowserProcessSpecificV8Snapshot`\nThe [documentation](https://www.electronjs.org/docs/latest/tutorial/fuses#loadbrowserprocessspecificv8snapshot) of the fuse `loadBrowserProcessSpecificV8Snapshot` does not explain in which cases it would make sense to enable the fuse, i.e. why someone would want the browser process to use a separate V8 snapshot or what benefits and drawbacks that brings with it.\n\nIt would be great if that could be documented.\n", "patch": "diff --git a/docs/tutorial/fuses.md b/docs/tutorial/fuses.md\nindex 3e644f02dcad9..1afa53d6a7df3 100644\n--- a/docs/tutorial/fuses.md\n+++ b/docs/tutorial/fuses.md\n@@ -68,6 +68,10 @@ The onlyLoadAppFromAsar fuse changes the search system that Electron uses to loc\n \n The loadBrowserProcessSpecificV8Snapshot fuse changes which V8 snapshot file is used for the browser process.  By default Electron's processes will all use the same V8 snapshot file.  When this fuse is enabled the browser process uses the file called `browser_v8_context_snapshot.bin` for its V8 snapshot. The other processes will use the V8 snapshot file that they normally do.\n \n+V8 snapshots can be useful to improve app startup performance. V8 lets you take snapshots of initialized heaps and then load them back in to avoid the cost of initializing the heap.\n+\n+Using separate snapshots for renderer processes and the main process can improve security, especially to make sure that the renderer doesn't use a snapshot with `nodeIntegration` enabled. See [#35170](https://github.com/electron/electron/issues/35170) for details.\n+\n ### `grantFileProtocolExtraPrivileges`\n \n **Default:** Enabled\n", "instance_id": "electron__electron-44680", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in its intent: it requests additional documentation for the `loadBrowserProcessSpecificV8Snapshot` fuse in Electron, specifically asking for an explanation of why someone might enable it and the associated benefits and drawbacks. The goal is well-defined, and the context (a link to the existing documentation) is provided. However, there are minor ambiguities, such as the lack of specific guidance on the depth or technical detail expected in the explanation. Additionally, it does not explicitly mention whether the documentation should cover specific use cases, edge cases, or performance metrics. While the intent is clear, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this task is very low, as it primarily involves adding explanatory content to an existing documentation file rather than implementing complex code or logic. The scope of the change is minimal, confined to a single file (`docs/tutorial/fuses.md`) with a small addition of text (a couple of paragraphs). It does not require deep understanding of the Electron codebase or its architecture, nor does it involve modifying any functional code or handling edge cases. The technical concepts involved are basic—understanding what a V8 snapshot is and its general purpose in improving startup performance and security. The provided code change already addresses the request by adding a concise explanation and referencing a related issue for further context. There are no significant challenges in terms of error handling, performance, or system impact. This task falls into the \"very easy\" category, as it requires only basic modifications to documentation with minimal technical depth.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Electron crashes with libnotify 0.8.3 in portal environment when closing notification\n### Preflight Checklist\r\n\r\n- [X] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\r\n- [X] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\r\n- [X] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\r\n\r\n### Electron Version\r\n\r\n25.0.0, 27.0.3 and 28.0.0-beta.2\r\n\r\n### What operating system are you using?\r\n\r\nOther Linux\r\n\r\n### Operating System Version\r\n\r\n- Arch Linux\r\n- `uname -a`: `Linux hostname 6.5.7-arch1-1 #1 SMP PREEMPT_DYNAMIC Tue, 10 Oct 2023 21:10:21 +0000 x86_64 GNU/Linux`\r\n\r\n### What arch are you using?\r\n\r\nx64\r\n\r\n### Last Known Working Electron version\r\n\r\nNot sure\r\n\r\n### Expected Behavior\r\n\r\nElectron does not crash when running `notification.close()`.\r\n\r\n### Actual Behavior\r\n\r\nElectron crashes with `notification.close()` when in portal (flatpak/snap, or `NOTIFY_FORCE_PORTAL=1` is set).\r\n\r\n### Testcase Gist URL\r\n\r\n_No response_\r\n\r\n### Additional Information\r\n\r\nAn MRE modified from electron-quick-start: https://github.com/taoky/electron-libnotify-portal-crash-mre.\r\n\r\nScreencast:\r\n\r\nhttps://github.com/electron/electron/assets/2109893/9bc49b03-ddef-4599-93e6-e7b4fb168b29\r\n\r\nMy analysis:\r\n\r\n1. `LibnotifyNotification::Show()` binds \"closed\" glib signal to `LibnotifyNotification::OnNotificationClosed` https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L91-L94\r\n2. When closing (dismissing) notification, `LibnotifyNotification::Dismiss()` is called which runs `libnotify_loader_.notify_notification_close()`: https://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/notifications/linux/libnotify_notification.cc#L167\r\n3. In `notify_notification_close()`, as libnotify 0.8.x adds supports for portal environment, it will call `remove_portal_notification()` instead of using gdbus call (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L1761>), then it calls `close_notification()` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L825>), and nightmare happens: it `g_signal_emit (notification, signals[SIGNAL_CLOSED], 0);` (<https://gitlab.gnome.org/GNOME/libnotify/-/blob/0.8.3/libnotify/notification.c#L707>).\r\n4. `LibnotifyNotification::OnNotificationClosed()` happily calls `NotificationDismissed()`, which finally calls `Destroy()`, and then `presenter()->RemoveNotification(this)`, and `this` is then `delete`d inside.\r\n5. `Notification::Close()` in electron_api_notification.cc has no idea about `notification_` being deleted, it continues, and crashes:\r\nhttps://github.com/electron/electron/blob/7999ea39e2ee9702e64e4125e8e89c314e9f468f/shell/browser/api/electron_api_notification.cc#L217C6-L227\n", "patch": "diff --git a/shell/browser/notifications/linux/libnotify_notification.cc b/shell/browser/notifications/linux/libnotify_notification.cc\nindex e039b382e3e24..4c8452fad1a8d 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.cc\n+++ b/shell/browser/notifications/linux/libnotify_notification.cc\n@@ -159,21 +159,21 @@ void LibnotifyNotification::Show(const NotificationOptions& options) {\n \n void LibnotifyNotification::Dismiss() {\n   if (!notification_) {\n-    Destroy();\n     return;\n   }\n \n   GError* error = nullptr;\n+  on_dismissing_ = true;\n   libnotify_loader_.notify_notification_close(notification_, &error);\n   if (error) {\n     log_and_clear_error(error, \"notify_notification_close\");\n-    Destroy();\n   }\n+  on_dismissing_ = false;\n }\n \n void LibnotifyNotification::OnNotificationClosed(\n     NotifyNotification* notification) {\n-  NotificationDismissed();\n+  NotificationDismissed(!on_dismissing_);\n }\n \n void LibnotifyNotification::OnNotificationView(NotifyNotification* notification,\ndiff --git a/shell/browser/notifications/linux/libnotify_notification.h b/shell/browser/notifications/linux/libnotify_notification.h\nindex 8aacd0952062a..315419fc5c734 100644\n--- a/shell/browser/notifications/linux/libnotify_notification.h\n+++ b/shell/browser/notifications/linux/libnotify_notification.h\n@@ -33,6 +33,7 @@ class LibnotifyNotification : public Notification {\n   RAW_PTR_EXCLUSION NotifyNotification* notification_ = nullptr;\n \n   ScopedGSignal signal_;\n+  bool on_dismissing_ = false;\n };\n \n }  // namespace electron\n", "instance_id": "electron__electron-41691", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue: Electron crashes when closing a notification in a portal environment with libnotify 0.8.3. It provides detailed context, including the affected Electron versions, operating system details, and a step-by-step analysis of the crash's root cause. The expected and actual behaviors are explicitly stated, and a minimal reproducible example (MRE) is referenced. However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement does not explicitly mention specific constraints or requirements for the fix (e.g., compatibility with older libnotify versions or performance considerations). Additionally, edge cases beyond the portal environment are not discussed, which could be relevant for a comprehensive solution. Overall, while the issue is well-articulated for someone familiar with the domain, these minor gaps in detail result in a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" range (0.6-0.8), due to the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: While the problem is mostly clear, the underlying issue involves intricate interactions between Electron's notification system and the libnotify library in a portal environment (e.g., Flatpak/Snap). Understanding the crash requires tracing the signal handling and object lifecycle management, which adds to the logical complexity.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are relatively localized, affecting only two files (`libnotify_notification.cc` and `libnotify_notification.h`). The modification introduces a flag (`on_dismissing_`) to track the dismissal state and prevent premature destruction of the notification object. However, this change requires a deep understanding of the notification lifecycle and signal handling in the Electron codebase. While the amount of code changed is small, the impact is significant as it addresses a critical crash bug. It does not appear to affect the broader system architecture, but it does require careful consideration of object ownership and deletion.\n\n3. **Number of Technical Concepts**: Solving this problem demands familiarity with several advanced concepts, including:\n   - C++ memory management and object lifecycle (e.g., avoiding double deletion or use-after-free issues).\n   - GLib signal handling (e.g., understanding how \"closed\" signals are emitted and handled).\n   - Domain-specific knowledge of Linux notification systems, particularly libnotify and portal environments.\n   - Electron's internal architecture for notifications.\n   These concepts are moderately to highly complex, especially for developers without prior experience in Linux desktop environments or Electron's internals.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement does not explicitly mention additional edge cases beyond the portal environment crash, but the code change implies the need to handle the timing of dismissal and signal emission carefully. The solution must ensure that it does not introduce new issues (e.g., memory leaks or crashes in non-portal environments). Error handling logic is already present in the code (e.g., checking for GError), but the fix requires ensuring that the dismissal state is correctly managed across different scenarios, which adds moderate complexity.\n\nOverall, this problem is challenging due to the need for deep knowledge of specific libraries (libnotify, GLib) and Electron's notification system, combined with the risk of subtle bugs in object lifecycle management. It does not reach the \"Very Hard\" range (0.8-1.0) because the scope of changes is limited, and the solution does not involve system-level redesign or advanced algorithms. A score of 0.65 reflects the significant technical depth required while acknowledging that the problem is solvable with focused expertise in the relevant areas.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Built-in Jolt Physics colliding shape index is always 0\n### Tested versions\n\n- Reproducible in: v4.4.stable.official [4c311cbee] with built-in Jolt Physics\n- Not reproducible in: v4.3.stable.official [77dcf97d8] with Godot Jolt 0.15.0 Extension from AssetLib\n\n### System information\n\nGodot v4.3.stable - Garuda Linux #1 ZEN SMP PREEMPT_DYNAMIC Fri, 07 Mar 2025 20:18:44 +0000 - X11 - GLES3 (Compatibility) - Mesa Intel(R) HD Graphics 630 (KBL GT2) - Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz (8 Threads)\n\n### Issue description\n\nIssue: When using Godot 4.4 with built-in Jolt Physics, `shape` value in the `get_rest_info()` output dictionary (obtained as ShapeCast3D's `collision_result`) is 0 regardless of the actual shape with which ShapeCast3D collided. \n\nExpected: different shapes have different shape indexes.\n\nThis issue does not occur when using DEFAULT physics on Godot 4.4, and it also doesnt occur when using  Godot Jolt extension or DEFAULT physics on Godot 4.3 version.\n\n### Steps to reproduce\n\n- Open MRP\n- Set project's physics engine to Jolt\n- Launch the game, note the output in the terminal being all 0 (three collision shapes report three different shapes of the same rigid body have index 0)\n- Change project's physics engine to DEFAULT\n- Launch the game, the output in the terminal should read 0 1 2 (three different shapes have different indexes)\n\nIdentical setup in a 4.3 project using the Godot Jolt Extension produces 0 1 2 as expected.\n\n### Minimal reproduction project (MRP)\n\n[ShapeTest4.4.zip](https://github.com/user-attachments/files/19436320/ShapeTest4.4.zip)\n", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\nindex ba904f0e9192..02fcbbc7e6a7 100644\n--- a/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_physics_direct_space_state_3d.cpp\n@@ -787,7 +787,6 @@ bool JoltPhysicsDirectSpaceState3D::rest_info(const ShapeParameters &p_parameter\n \tr_info->normal = to_godot(-hit.mPenetrationAxis.Normalized());\n \tr_info->rid = object->get_rid();\n \tr_info->collider_id = object->get_instance_id();\n-\tr_info->shape = 0;\n \tr_info->linear_velocity = object->get_velocity_at_position(hit_point);\n \n \treturn true;\n", "instance_id": "godotengine__godot-104599", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the specific behavior observed (shape index always being 0 with Jolt Physics in Godot 4.4), the expected behavior (different shapes having different indexes), and steps to reproduce the issue. It also includes version information and a minimal reproduction project (MRP), which aids in understanding the context. However, there are minor ambiguities: the problem statement does not explicitly mention how the shape index should be determined or retrieved in the codebase, nor does it discuss potential edge cases or constraints (e.g., whether this issue occurs with specific types of shapes or under certain conditions). Additionally, while the issue is well-documented with reproduction steps, the exact cause or expected fix is not hinted at in the statement, leaving some room for interpretation. Thus, it falls under \"Mostly Clear\" with minor details missing.", "difficulty_explanation": "The difficulty of this problem is very low, as the provided code change is minimal and straightforward. The modification involves removing a single line of code (`r_info->shape = 0;`) in a specific file, which suggests that the issue was caused by hardcoding the shape index to 0. This fix does not require deep understanding of the codebase, complex logic, or handling of edge cases. It falls into the \"Very Easy\" category (0.0-0.2) because:\n\n1. **Scope and Depth of Code Changes:** The change is isolated to a single line in one file (`jolt_physics_direct_space_state_3d.cpp`). There is no indication of broader impact on the system's architecture or interactions with other modules.\n2. **Technical Concepts:** The fix does not require advanced knowledge of programming language features, libraries, or algorithms. It only requires basic familiarity with C++ and the ability to identify a hardcoded value.\n3. **Edge Cases and Error Handling:** The problem statement and code change do not indicate any specific edge cases or error handling requirements. The removal of the hardcoded value likely allows the underlying physics engine to handle shape indexing correctly, with no additional logic needed in this fix.\n4. **Overall Effort:** The effort required to understand and apply this fix is minimal, akin to fixing a typo or changing a constant.\n\nWhile the problem context (physics engines in a game engine like Godot) might seem complex, the actual change is trivial and does not demand deep domain knowledge or extensive debugging. Therefore, a difficulty score of 0.15 is appropriate, reflecting a very easy task with minimal cognitive load.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Editor crash when trying to reimport gltf scenes that are nested in godot\n### Tested versions\n\nv4.4.1.rc1.official [daa4b058e]\n\n### System information\n\nGodot v4.4.1.rc1 - macOS Sequoia (15.1.0) - Multi-window, 1 monitor - Metal (Forward+) - integrated Apple M1 Max (Apple7) - Apple M1 Max (10 threads)\n\n### Issue description\n\nGodot crashes when trying to reimport two scenes where one scene is a child of another scene\n\nhttps://github.com/user-attachments/assets/95828c6e-d05f-4bb7-bbf8-ae44be9f130b\n\n### Steps to reproduce\n\nOpen the MRP, select both gltf files in the filesystem dock, right click and reimport\n\n### Minimal reproduction project (MRP)\n\n[mrp_nested_gltf_crash.zip](https://github.com/user-attachments/files/19266573/mrp_nested_gltf_crash.zip)\n", "patch": "diff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 520666faa839..0614aa55bd85 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -6457,6 +6457,18 @@ void EditorNode::reload_instances_with_path_in_edited_scenes() {\n \n \t\t\tget_scene_editor_data_for_node(owner, original_node, scene_editor_data_table);\n \n+\t\t\t// The current node being reloaded may also be an additional node for another node\n+\t\t\t// that is in the process of being reloaded.\n+\t\t\t// Replacing the additional node with the new one prevents a crash where nodes\n+\t\t\t// in 'addition_list' are removed from the scene tree and queued for deletion.\n+\t\t\tfor (InstanceModificationsEntry &im : scene_modifications->instance_list) {\n+\t\t\t\tfor (AdditiveNodeEntry &additive_node_entry : im.addition_list) {\n+\t\t\t\t\tif (additive_node_entry.node == original_node) {\n+\t\t\t\t\t\tadditive_node_entry.node = instantiated_node;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t}\n+\n \t\t\tbool original_node_scene_instance_load_placeholder = original_node->get_scene_instance_load_placeholder();\n \n \t\t\t// Delete all the remaining node children.\n", "instance_id": "godotengine__godot-104384", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Godot crashes when reimporting nested glTF scenes. It provides context about the tested version, system information, steps to reproduce, and even a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior after the fix (e.g., should reimporting nested scenes work seamlessly, or are there specific limitations?). Additionally, it lacks details about the root cause of the crash (e.g., is it a memory issue, a dangling pointer, or something else?), which would help in understanding the problem's scope. While the steps to reproduce are clear, edge cases or specific constraints (e.g., does this happen only with glTF files, or other formats as well?) are not mentioned. Overall, the statement is valid and mostly clear but misses some minor details that could aid in fully grasping the issue without diving into the codebase or reproduction project.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code change appears localized to a single file (`editor_node.cpp`), specifically within the `reload_instances_with_path_in_edited_scenes` function. However, the change itself addresses a critical issue related to node management during scene reloading, which suggests a deeper understanding of Godot's scene tree and instance management system is required. The modification involves updating references to nodes in an `addition_list` to prevent crashes caused by nodes being removed and queued for deletion, indicating a need to understand complex interactions between nodes and their lifecycle in the editor.\n\nSecond, the technical concepts involved are moderately advanced. The developer must be familiar with Godot's internal architecture, particularly how scene instances and node hierarchies are managed in memory during operations like reimporting. Knowledge of C++ memory management and pointer handling is crucial, as the crash likely stems from invalid references or dangling pointers. The code change, while small in terms of lines (about 10 lines), has a significant impact on preventing crashes, which implies a high level of precision and understanding of the system's behavior.\n\nThird, edge cases and error handling are implicitly critical here. The problem statement does not explicitly mention edge cases, but the nature of the crash (nested scenes during reimport) suggests that handling hierarchical dependencies and ensuring proper node replacement without breaking other parts of the scene tree are non-trivial tasks. The code change directly addresses a specific failure mode (nodes being removed and queued for deletion), but it’s unclear if other related edge cases (e.g., deeply nested scenes, circular dependencies) are also handled or need additional consideration.\n\nFinally, while the change does not appear to impact the broader system architecture, it requires a deep understanding of a specific, critical part of the Godot editor's functionality. This places the difficulty at 0.65, reflecting a hard problem that demands specialized knowledge of the codebase and careful handling of node lifecycle issues, but not reaching the \"Very Hard\" category as it does not involve extensive refactoring or system-wide changes.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`NOTIFICATION_WM_POSITION_CHANGED` is not exposed in GDExtension\n### Tested versions\n\n4.4.stable\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 Ti (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i7-6700K CPU @ 4.00GHz (8 threads)\n\n### Issue description\n\nOriginally reported here https://github.com/godotengine/godot-cpp/issues/1732\n\nThen I realized it better fits here.\nBasically, `extension_api.json` generated by Godot does not expose `NOTIFICATION_WM_POSITION_CHANGED`. Thus, it is not available in godot-cpp.\n\n### Steps to reproduce\n\nCall `godot --dump-extension-api` to generate api file. Observe that `NOTIFICATION_WM_POSITION_CHANGED` is not present.\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/doc/classes/Node.xml b/doc/classes/Node.xml\nindex 15852097fb5b..fd0a2594c293 100644\n--- a/doc/classes/Node.xml\n+++ b/doc/classes/Node.xml\n@@ -1226,6 +1226,9 @@\n \t\t<constant name=\"NOTIFICATION_VP_MOUSE_EXIT\" value=\"1011\">\n \t\t\tNotification received when the mouse cursor leaves the [Viewport]'s visible area, that is not occluded behind other [Control]s or [Window]s, provided its [member Viewport.gui_disable_input] is [code]false[/code] and regardless if it's currently focused or not.\n \t\t</constant>\n+\t\t<constant name=\"NOTIFICATION_WM_POSITION_CHANGED\" value=\"1012\">\n+\t\t\tNotification received when the window is moved.\n+\t\t</constant>\n \t\t<constant name=\"NOTIFICATION_OS_MEMORY_WARNING\" value=\"2009\">\n \t\t\tNotification received from the OS when the application is exceeding its allocated memory.\n \t\t\tImplemented only on iOS.\ndiff --git a/scene/main/node.cpp b/scene/main/node.cpp\nindex 0978aa9ddfb9..ed0add6f43cd 100644\n--- a/scene/main/node.cpp\n+++ b/scene/main/node.cpp\n@@ -3811,6 +3811,7 @@ void Node::_bind_methods() {\n \tBIND_CONSTANT(NOTIFICATION_WM_DPI_CHANGE);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_ENTER);\n \tBIND_CONSTANT(NOTIFICATION_VP_MOUSE_EXIT);\n+\tBIND_CONSTANT(NOTIFICATION_WM_POSITION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_OS_MEMORY_WARNING);\n \tBIND_CONSTANT(NOTIFICATION_TRANSLATION_CHANGED);\n \tBIND_CONSTANT(NOTIFICATION_WM_ABOUT);\n", "instance_id": "godotengine__godot-104083", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: the `NOTIFICATION_WM_POSITION_CHANGED` constant is not exposed in the `extension_api.json` file generated by Godot, making it unavailable in the `godot-cpp` library. The goal of exposing this notification is implied, and the steps to reproduce the issue are provided (generating the API file and observing the missing constant). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly state the expected behavior or use case for `NOTIFICATION_WM_POSITION_CHANGED` beyond a brief description in the code change. Additionally, there are no examples of how this notification should be used or any specific constraints or requirements for its implementation. Edge cases or potential side effects of adding this notification are also not mentioned. Despite these minor gaps, the issue is valid and understandable with the provided context and code changes.", "difficulty_explanation": "The difficulty of this problem is very low, falling in the 0.0-0.2 range, as it involves a straightforward and minimal code modification. The changes required are limited to two files: adding a constant definition in an XML documentation file (`Node.xml`) and binding the constant in the corresponding C++ source file (`node.cpp`). The scope of the change is extremely narrow, affecting only a single class or module with no apparent impact on the broader system architecture or interactions between components. The technical concepts involved are basic—understanding how constants are defined and bound in the Godot engine, which is a fundamental aspect of working with this codebase. No advanced algorithms, design patterns, or domain-specific knowledge are required beyond basic familiarity with Godot's notification system. Additionally, there are no explicit edge cases or error handling requirements mentioned in the problem statement or evident in the code changes. The overall effort is minimal, akin to adding a simple constant or fixing a small omission, making this a very easy task for anyone with basic experience in C++ and the Godot engine.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Documentation tooltip disappears when you move the mouse - 4.4 dev7\n### Tested versions\n\nGodot 4.4 Dev 7 (MACOS mono build)\n\n### System information\n\nMacOS Sequoia 15.2 running on an M1 Pro\n\n### Issue description\n\nSeveral issues:\n\n1) Tooltip disappears when you move your mouse over it. It should persist instead, and only fade out after like 0.5ms or a second when the mouse is no longer over the tooltip.\n2) Cannot click on any hyperlinks within the tooltip, for example in the video I cannot click on the Color Cheatsheet web link on the bottom\n3) Cannot scroll down\n4) It would be nice to be able to click on documentation links within the tooltip, for example hovering over @export_range, we should be able to also click on the PROPERTY_HINT_RANGE link that comes under \"See also\" in the documentation.\n\nI'm running on an M1 Pro with macOS Sequoia 15.2. Single window mode was off when the issues occurred. With this mode on I still have the same issues.\n\n### Steps to reproduce\n\nJust hover over a keyword and you will notice all the mentioned issues.\n\nhttps://github.com/user-attachments/assets/689e6cf7-392e-4dae-a2e0-9f9a811bbc90\n\n\n### Minimal reproduction project (MRP)\n\nNA\n", "patch": "diff --git a/platform/macos/godot_content_view.mm b/platform/macos/godot_content_view.mm\nindex eff33208db4b..4e7fc2180cb9 100644\n--- a/platform/macos/godot_content_view.mm\n+++ b/platform/macos/godot_content_view.mm\n@@ -622,7 +622,7 @@ - (void)updateTrackingAreas {\n \t\t[self removeTrackingArea:tracking_area];\n \t}\n \n-\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveInKeyWindow | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n+\tNSTrackingAreaOptions options = NSTrackingMouseEnteredAndExited | NSTrackingActiveWhenFirstResponder | NSTrackingCursorUpdate | NSTrackingInVisibleRect;\n \ttracking_area = [[NSTrackingArea alloc] initWithRect:[self bounds] options:options owner:self userInfo:nil];\n \n \t[self addTrackingArea:tracking_area];\n", "instance_id": "godotengine__godot-103788", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issues with the documentation tooltip in Godot 4.4 Dev 7 on macOS. It outlines multiple specific problems: the tooltip disappearing when the mouse moves over it, inability to click hyperlinks, inability to scroll, and a suggestion to enable clicking on documentation links. The description includes the environment (macOS Sequoia 15.2 on M1 Pro) and steps to reproduce the issue (hovering over a keyword). However, there are minor ambiguities and missing details. For instance, the expected behavior for tooltip persistence (e.g., exact fade-out timing) is vaguely described as \"0.5ms or a second,\" which is inconsistent and likely a typo (0.5ms is unreasonably short). Additionally, there are no explicit mentions of edge cases or specific constraints for the fixes, such as performance requirements or compatibility concerns with other platforms. While a video link is provided for context, a minimal reproduction project (MRP) is not included, which could hinder precise replication of the issue. Overall, the statement is valid and mostly clear but lacks some precision and completeness in requirements.", "difficulty_explanation": "The difficulty of this problem is rated as easy (0.25) based on the provided code changes and the nature of the issues described. Let's break it down by the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided diff shows a minimal change in a single file (`godot_content_view.mm`), specifically altering a tracking area option from `NSTrackingActiveInKeyWindow` to `NSTrackingActiveWhenFirstResponder`. This suggests the fix for at least one aspect of the issue (likely the tooltip disappearing on mouse movement) is a small, targeted modification. However, the problem statement lists multiple issues (hyperlink clicking, scrolling, and documentation link navigation), which are not addressed in the provided diff. If these additional issues require similar small changes in related areas, the overall scope remains limited. There is no indication of architectural impact or extensive cross-module changes.\n\n2. **Number of Technical Concepts:** The code change involves understanding macOS-specific Cocoa framework concepts, particularly `NSTrackingArea` and its options, which are part of the macOS platform layer in Godot. This requires some domain-specific knowledge of macOS event handling, but the concept is relatively straightforward for someone familiar with macOS development or the Godot engine's platform code. No complex algorithms, design patterns, or advanced language features are evident in the provided change. Additional issues like hyperlink clicking and scrolling might involve understanding Godot's UI event system or tooltip rendering logic, but these are likely to be at a similar or slightly higher level of complexity.\n\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases or error conditions, and the provided code change does not introduce new error handling logic. However, implementing fixes for tooltip persistence, hyperlink interaction, and scrolling might require considering edge cases such as tooltip positioning near screen edges, handling multiple overlapping tooltips, or ensuring compatibility with different input devices (e.g., trackpads vs. mice). These are not overly complex but would add some additional considerations.\n\n4. **Overall Assessment:** The provided code change is a simple tweak, and even accounting for the unaddressed issues in the problem statement, the overall task appears to involve localized fixes within the macOS platform code or Godot's UI system. It requires basic to intermediate knowledge of the Godot engine and macOS development but does not seem to demand deep architectural changes, complex algorithms, or extensive performance optimization. Therefore, I rate this as an easy problem (0.25), as it involves understanding some code logic and making relatively simple modifications, potentially across a few related areas.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Web] `Input.mouse_mode` can't capture mouse after user presses escape key in browser\n### Tested versions\n\n- Reproducible in Godot 4.4.beta2\n- Not Reproducible in 4.3\n\n### System information\n\nGodot v4.4.beta2 - Linux Mint 22 (Wilma) on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 4060 Ti (nvidia; 550.120) - AMD Ryzen 9 3900X 12-Core Processor (24 threads)\n\n### Issue description\n\nI have discovered an edge case that likely happens often. When the mouse is captured browsers tend to tell the user that they can press escape to free there mouse. If we capture the users mouse and then they press escape we can not again capture it with the current behavior. Even though the engine knows that the mouse has been released. To capture the mouse again after the user has pressed escape we must first tell the engine to release the mouse and then capture it again. So that they engine executes the correct sequence.\n\nNote: https://github.com/godotengine/godot/issues/100758#issuecomment-2624679816\n\n### Steps to reproduce\n\n\n1. Extract MRP\n2. Open MRP in Godot 4.4.beta2\n3. Ensure exports are managed for Godot 4.4.beta2\n4. Run the MRP in the browser.\n5. Capture the mouse using the button provided.\n6. Press the escape key \"esc\".\n7. Observe that your mouse is released and visible.\n8. Attempt to capture the mouse using the button provided that says \"Capture Mouse\".\n9. Observe this does not work.\n10. Press the button that says \"Capture Mouse After Release\".\n11. Observe this works.\n\nAlternatively for step 10. You can also press space bar or press the \"Release Mouse\" button. and then you can press the \"Capture Mouse\" button and it will work.\n\n### Minimal reproduction project (MRP)\n\n[web-mouse-capture-part-2.zip](https://github.com/user-attachments/files/18608637/web-mouse-capture-part-2.zip)\n", "patch": "diff --git a/platform/web/display_server_web.cpp b/platform/web/display_server_web.cpp\nindex 89cc6339d28b..180c05ef411d 100644\n--- a/platform/web/display_server_web.cpp\n+++ b/platform/web/display_server_web.cpp\n@@ -576,9 +576,17 @@ void DisplayServerWeb::_mouse_update_mode() {\n \n void DisplayServerWeb::mouse_set_mode(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_base) {\n+\n+\tif (mouse_mode_override_enabled) {\n+\t\tmouse_mode_base = p_mode;\n+\t\t// No need to update, as override is enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_base && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_base = p_mode;\n \t_mouse_update_mode();\n }\n@@ -596,9 +604,17 @@ DisplayServer::MouseMode DisplayServerWeb::mouse_get_mode() const {\n \n void DisplayServerWeb::mouse_set_mode_override(MouseMode p_mode) {\n \tERR_FAIL_INDEX(p_mode, MouseMode::MOUSE_MODE_MAX);\n-\tif (p_mode == mouse_mode_override) {\n+\n+\tif (!mouse_mode_override_enabled) {\n+\t\tmouse_mode_override = p_mode;\n+\t\t// No need to update, as override is not enabled.\n+\t\treturn;\n+\t}\n+\tif (p_mode == mouse_mode_override && p_mode == mouse_get_mode()) {\n+\t\t// No need to update, as it is currently set as the correct mode.\n \t\treturn;\n \t}\n+\n \tmouse_mode_override = p_mode;\n \t_mouse_update_mode();\n }\n", "instance_id": "godotengine__godot-102719", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the inability to recapture the mouse in a browser environment after the user presses the escape key in Godot 4.4.beta2. It provides detailed steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or constraints for mouse capture in a browser after the escape key is pressed (e.g., browser-specific behaviors or limitations). Additionally, while it references a GitHub comment for context, it does not fully clarify the desired fix or the broader implications of the issue across different environments. These minor gaps prevent it from being comprehensive, but the overall intent and reproduction steps are well-articulated.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively small, confined to a single file (`display_server_web.cpp`) and focused on modifying logic related to mouse mode handling in the Godot engine's web platform. The changes involve adding conditional checks to prevent unnecessary updates when the mouse mode is already set or when an override is not enabled, which requires a moderate understanding of the existing codebase logic. Second, the technical concepts involved include familiarity with Godot's display server architecture, mouse input handling in a web context (likely involving JavaScript interop or browser APIs like Pointer Lock API), and state management for input modes. These concepts are not overly complex but do require domain-specific knowledge of game engine internals and web platform constraints. Third, the problem touches on edge cases (e.g., user pressing escape to release the mouse), and the code changes address this by ensuring proper state transitions, though no extensive error handling or performance optimization is evident. Finally, the impact of the change is limited to the web platform's mouse handling and does not appear to affect the broader system architecture. Overall, this problem requires a moderate level of expertise and understanding of specific parts of the codebase, placing it in the 0.4-0.6 range, with a score of 0.45 reflecting the balance between focused changes and the need for contextual knowledge.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Popup menus broken when `content_scale_mode` is bigger then 1 and subwindows are not embedded\n### Tested versions\n\n- reproducable in 4.4 beta1\n- not reproducable in 4.4 dev 7 or before\n\n### System information\n\nWindows 10\n\n### Issue description\n\nWorking on applications (material maker in my case) you often want to allow scaling the window using the content_scale_factor AND allow using multiple native windows (so having embed subwindows off). Unfortunately at higher factors, popup menus (and option buttons, maybe more popups idk) don't function anymore. The lower parts of the popups does not receive input/clicks. Strangely enough the hover works fine, so I really have no clue what's going on.\n\n### Steps to reproduce\n\nCreate a popup menu or option button with a couple of items. Change the content scale factor to 2, turn embed subwindows off. Then run the game and try selecting the last popup item.\n\n### Minimal reproduction project (MRP)\n\n[mrp_scalemenupopupbug.zip](https://github.com/user-attachments/files/18592487/mrp_scalemenupopupbug.zip)\nHope this helps.\n", "patch": "diff --git a/scene/gui/popup.cpp b/scene/gui/popup.cpp\nindex 94d7303ae504..cbba65e0088b 100644\n--- a/scene/gui/popup.cpp\n+++ b/scene/gui/popup.cpp\n@@ -247,8 +247,14 @@ void PopupPanel::_input_from_window(const Ref<InputEvent> &p_event) {\n \n \t\tRef<InputEventMouseButton> b = p_event;\n \t\t// Hide it if the shadows have been clicked.\n-\t\tif (b.is_valid() && b->is_pressed() && b->get_button_index() == MouseButton::LEFT && !panel->get_global_rect().has_point(b->get_position())) {\n-\t\t\t_close_pressed();\n+\t\tif (b.is_valid() && b->is_pressed() && b->get_button_index() == MouseButton::LEFT) {\n+\t\t\tRect2 panel_area = panel->get_global_rect();\n+\t\t\tfloat win_scale = get_content_scale_factor();\n+\t\t\tpanel_area.position *= win_scale;\n+\t\t\tpanel_area.size *= win_scale;\n+\t\t\tif (!panel_area.has_point(b->get_position())) {\n+\t\t\t\t_close_pressed();\n+\t\t\t}\n \t\t}\n \t} else {\n \t\tWARN_PRINT_ONCE(\"PopupPanel has received an invalid InputEvent. Consider filtering out invalid events.\");\ndiff --git a/scene/gui/popup_menu.cpp b/scene/gui/popup_menu.cpp\nindex 092a12bd1486..b6dc75754690 100644\n--- a/scene/gui/popup_menu.cpp\n+++ b/scene/gui/popup_menu.cpp\n@@ -327,16 +327,17 @@ int PopupMenu::_get_mouse_over(const Point2 &p_over) const {\n \t\titem_clickable_area.size.width -= scroll_width;\n \t}\n \tfloat win_scale = get_content_scale_factor();\n-\titem_clickable_area.position.y = (item_clickable_area.position.y + theme_cache.panel_style->get_margin(SIDE_TOP)) * win_scale;\n+\titem_clickable_area.position.x += theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\titem_clickable_area.position.y += theme_cache.panel_style->get_margin(SIDE_TOP);\n+\titem_clickable_area.position *= win_scale;\n \titem_clickable_area.size.y -= theme_cache.panel_style->get_margin(SIDE_TOP) + theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n \titem_clickable_area.size *= win_scale;\n \n-\tif (p_over.x < item_clickable_area.position.x || p_over.x >= item_clickable_area.position.x + item_clickable_area.size.width ||\n-\t\t\tp_over.y < item_clickable_area.position.y || p_over.y >= item_clickable_area.position.y + item_clickable_area.size.height) {\n+\tif (!item_clickable_area.has_point(p_over)) {\n \t\treturn -1;\n \t}\n \n-\tfloat ofs = item_clickable_area.position.y + theme_cache.v_separation * 0.5;\n+\tfloat ofs = item_clickable_area.position.y + (float)theme_cache.v_separation * win_scale * 0.5;\n \tfor (int i = 0; i < items.size(); i++) {\n \t\tofs += i > 0 ? (float)theme_cache.v_separation * win_scale : (float)theme_cache.v_separation * win_scale * 0.5;\n \t\tofs += _get_item_height(i) * win_scale;\n@@ -430,7 +431,7 @@ void PopupMenu::_activate_submenu(int p_over, bool p_by_keyboard) {\n \t\t\tthis_rect.size.x, scaled_ofs_cache + scroll_offset + theme_cache.panel_style->get_margin(SIDE_TOP) * win_scale - theme_cache.v_separation / 2));\n \n \t// If there is an area below the submenu item, add an autohide area there.\n-\tif (scaled_ofs_cache + scaled_height_cache + scroll_offset <= control->get_size().height) {\n+\tif (scaled_ofs_cache + scaled_height_cache + scroll_offset <= control->get_size().height * win_scale) {\n \t\tconst int from = scaled_ofs_cache + scaled_height_cache + scroll_offset + theme_cache.v_separation / 2;\n \t\tsubmenu_pum->add_autohide_area(Rect2(this_rect.position.x, this_rect.position.y + from, this_rect.size.x, this_rect.size.y - from));\n \t}\n@@ -605,9 +606,13 @@ void PopupMenu::_input_from_window_internal(const Ref<InputEvent> &p_event) {\n \t\t}\n \t\titem_clickable_area.size.width -= scroll_width;\n \t}\n-\titem_clickable_area.position.y = (item_clickable_area.position.y + theme_cache.panel_style->get_margin(SIDE_TOP)) * get_content_scale_factor();\n+\n+\tfloat win_scale = get_content_scale_factor();\n+\titem_clickable_area.position.x += theme_cache.panel_style->get_margin(SIDE_LEFT);\n+\titem_clickable_area.position.y += theme_cache.panel_style->get_margin(SIDE_TOP);\n+\titem_clickable_area.position *= win_scale;\n \titem_clickable_area.size.y -= theme_cache.panel_style->get_margin(SIDE_TOP) + theme_cache.panel_style->get_margin(SIDE_BOTTOM);\n-\titem_clickable_area.size *= get_content_scale_factor();\n+\titem_clickable_area.size *= win_scale;\n \n \tRef<InputEventMouseButton> b = p_event;\n \n@@ -622,9 +627,14 @@ void PopupMenu::_input_from_window_internal(const Ref<InputEvent> &p_event) {\n \t\t\t\tis_scrolling = is_layout_rtl() ? b->get_position().x < item_clickable_area.position.x : b->get_position().x > item_clickable_area.size.width;\n \n \t\t\t\t// Hide it if the shadows have been clicked.\n-\t\t\t\tif (get_flag(FLAG_POPUP) && !panel->get_global_rect().has_point(b->get_position())) {\n-\t\t\t\t\t_close_pressed();\n-\t\t\t\t\treturn;\n+\t\t\t\tif (get_flag(FLAG_POPUP)) {\n+\t\t\t\t\tRect2 panel_area = panel->get_global_rect();\n+\t\t\t\t\tpanel_area.position *= win_scale;\n+\t\t\t\t\tpanel_area.size *= win_scale;\n+\t\t\t\t\tif (!panel_area.has_point(b->get_position())) {\n+\t\t\t\t\t\t_close_pressed();\n+\t\t\t\t\t\treturn;\n+\t\t\t\t\t}\n \t\t\t\t}\n \n \t\t\t\tif (!item_clickable_area.has_point(b->get_position())) {\n", "instance_id": "godotengine__godot-102625", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: popup menus and option buttons fail to receive input/clicks on their lower parts when the content scale factor is greater than 1 and subwindows are not embedded. It provides specific steps to reproduce the issue, mentions the affected versions, and includes a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior or desired outcome beyond \"fixing\" the input issue. Additionally, it lacks clarity on specific edge cases (e.g., different scale factors, various popup sizes, or interactions with other UI elements) and constraints (e.g., performance expectations or compatibility requirements). While the issue is reproducible and the context is provided, these missing details prevent it from being fully comprehensive, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, affecting two files (`popup.cpp` and `popup_menu.cpp`) within a GUI-related module of what appears to be a game engine (likely Godot, based on context). The changes primarily involve adjusting coordinate scaling logic to account for the content scale factor, which requires understanding how UI elements are positioned and interact with input events. Second, the technical concepts involved include GUI rendering, input event handling, and coordinate transformations, which are moderately complex but not overly advanced. Familiarity with the engine's API (e.g., `get_content_scale_factor()`, `get_global_rect()`) and internal rendering logic is necessary, but the changes do not appear to impact the broader system architecture. Third, the amount of code change is small but requires precision, as it deals with pixel-perfect input detection and scaling. Finally, while the problem statement does not explicitly mention edge cases, the code changes implicitly address issues related to scaled coordinates and input detection, suggesting some consideration of edge cases (e.g., different scale factors or window configurations). However, no extensive error handling or performance optimization is required. Overall, this problem requires a moderate understanding of the codebase and GUI systems, along with careful modifications, justifying a difficulty score of 0.45.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "`get_global_transform_interpolated()` may return wrong value when FPS < physics ticks per second\n### Tested versions\n\n- Reproducible in v3.6.stable.official [de2f0f147]\n- Reproducible in v4.4.dev1.official [28a72fa43]\n- Reproducible in v4.4.beta1.official [d33da79d3]\n- Reproducible in v4.4.beta.custom_build [a013481b0]\n\n### System information\n\nGodot v4.4.beta (a013481b0) - CachyOS Linux #1 SMP PREEMPT_DYNAMIC Mon, 20 Jan 2025 21:26:55 +0000 on Wayland - X11 display driver, Multi-window, 1 monitor - Vulkan (Forward+) - integrated Intel(R) HD Graphics 620 (KBL GT2) - Intel(R) Core(TM) i7-7500U CPU @ 2.70GHz (4 threads)\n\n### Issue description\n\nWhen FPS drops below `physics_ticks_per_second` the function `get_global_transform_interpolated()` sometimes returns wrong value.\n\nWhen calling `get_global_transform_interpolated()` in a `_process()` I expect to get the most recent interpolated transform regardless of how many physics ticks happen between successive process frames. I think the actual returned value may be interpolated transform only after 1 physics tick that occurred directly after the previous process frame.\n\nThe issue is about functionality introduced to `4.4.dev1` in https://github.com/godotengine/godot/pull/92391 but it is also reproducible in `3.6` version of physics interpolation.\n\n### Steps to reproduce\n\nRun the MRP and notice NinePatchRect is constantly jittering.\n\nIn order to reproduce the issue the project has `max_fps` set lower than `physics_ticks_per_second`.\n\nIf needed I can provide even more simplified MRP without the usage of `Camera3D.unproject_position()`.\n\n### Minimal reproduction project (MRP)\n\nGodot 4.x project:\n[test-physics-interpolation-maxfps.zip](https://github.com/user-attachments/files/18580802/test-physics-interpolation-maxfps.zip)\n\nGodot 3.x project:\n[Test Physics Interpolation max_fps Godot3.zip](https://github.com/user-attachments/files/18580804/Test.Physics.Interpolation.max_fps.Godot3.zip)\n", "patch": "diff --git a/scene/main/scene_tree.cpp b/scene/main/scene_tree.cpp\nindex 3c1809c3586b..99273ffa81c7 100644\n--- a/scene/main/scene_tree.cpp\n+++ b/scene/main/scene_tree.cpp\n@@ -559,11 +559,6 @@ void SceneTree::iteration_prepare() {\n \t\t// are flushed before pumping the interpolation prev and currents.\n \t\tflush_transform_notifications();\n \t\tVisualServer::get_singleton()->tick();\n-\n-\t\t// Any objects performing client physics interpolation\n-\t\t// should be given an opportunity to keep their previous transforms\n-\t\t// up to date before each new physics tick.\n-\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n@@ -572,6 +567,11 @@ void SceneTree::iteration_end() {\n \t// to be flushed to the VisualServer before finishing a physics tick.\n \tif (_physics_interpolation_enabled) {\n \t\tflush_transform_notifications();\n+\n+\t\t// Any objects performing client physics interpolation\n+\t\t// should be given an opportunity to keep their previous transforms\n+\t\t// up to date.\n+\t\t_client_physics_interpolation.physics_process();\n \t}\n }\n \n", "instance_id": "godotengine__godot-102184", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with `get_global_transform_interpolated()` returning incorrect values when FPS is lower than the physics ticks per second. It provides context about the affected versions of the Godot engine, system information, and steps to reproduce the issue using minimal reproduction projects (MRPs). The goal of fixing the interpolation behavior is evident, and the issue's impact (jittering in rendering) is described. However, there are minor ambiguities: the exact expected behavior of the interpolation under varying FPS conditions is not fully detailed, and potential edge cases (e.g., extreme FPS drops or specific physics tick configurations) are not explicitly mentioned. Additionally, while the MRPs are provided, the problem statement lacks specific input/output examples or detailed constraints that could further clarify the issue. Overall, it is clear enough to understand the problem but misses some finer details that would make it comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code change, while seemingly small (a few lines in `scene_tree.cpp`), involves critical timing logic in the Godot engine's scene tree iteration process. Moving the call to `_client_physics_interpolation.physics_process()` from `iteration_prepare()` to `iteration_end()` suggests a deep understanding of the engine's physics interpolation and rendering pipeline is required to ensure transforms are updated at the correct stage. This impacts the core functionality of how physics and rendering are synchronized, which is a complex architectural concern. Second, the number of technical concepts involved is significant: knowledge of game engine internals (physics ticks, frame rendering, interpolation), timing and synchronization in real-time systems, and potentially the specifics of Godot's `VisualServer` and transform notification system are necessary. Third, while the problem statement does not explicitly mention edge cases, the nature of the issue (FPS drops below physics ticks) implies potential complexities in handling varying frame rates, physics tick rates, and ensuring smooth interpolation under stress conditions. Error handling might also need to be considered to prevent jittering or transform desynchronization in extreme scenarios. Overall, solving this requires a deep dive into the engine's internals and careful consideration of timing issues, justifying a difficulty score of 0.65, leaning towards the harder end of the spectrum due to the specialized domain knowledge and potential for subtle bugs if not handled correctly.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[4.4beta1] ResourceLoader.has_cached() does not return proper values for UIDs\n### Tested versions\n\nReproducible in 4.4 dev 4, 5, 6, 7, and beta 1. Probably in previous 4.4 dev builds as well.\n\n### System information\n\nGodot v4.4.beta1 - Arch Linux #1 SMP PREEMPT_DYNAMIC Fri, 10 Jan 2025 00:39:41 +0000 on Wayland - X11 display driver, Multi-window, 2 monitors - Vulkan (Forward+) - dedicated AMD Radeon RX 6600 XT (RADV NAVI23) - AMD Ryzen 5 5600X 6-Core Processor (12 threads)\n\n### Issue description\n\nPassing a UID into `ResourceLoader.has_cached()` returns `false` for a resource that is cached. Passing the resource path for the resource with the same UID properly returns `true`.\n\n### Steps to reproduce\n\n1. Create a Sprite2D node and attach the `icon.svg` as the texture.\n2. Attach a script to the Sprite2D node to see if the `icon.svg` resource is cached. Something like:\n```\nextends Sprite2D\n\nvar resource_path: String = \"res://icon.svg\"\nvar uid: String = \"\" # Insert UID of icon.svg here.\n\n\nfunc _ready():\n\tprint(\"ResourceLoader.has_cached results:\\nResource Path: \",\n\t\t\tResourceLoader.has_cached(resource_path), \" UID: \", ResourceLoader.has_cached(uid))\n```\n3. Observe that passing the resource path returns `true` whereas passing the UID returns `false`.\n\n### Minimal reproduction project (MRP)\n\n[resource-loader-bug.zip](https://github.com/user-attachments/files/18463852/resource-loader-bug.zip)\n", "patch": "diff --git a/core/core_bind.cpp b/core/core_bind.cpp\nindex 6974d98234cc..acd589783ece 100644\n--- a/core/core_bind.cpp\n+++ b/core/core_bind.cpp\n@@ -113,12 +113,12 @@ PackedStringArray ResourceLoader::get_dependencies(const String &p_path) {\n }\n \n bool ResourceLoader::has_cached(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::has(local_path);\n }\n \n Ref<Resource> ResourceLoader::get_cached_ref(const String &p_path) {\n-\tString local_path = ProjectSettings::get_singleton()->localize_path(p_path);\n+\tString local_path = ::ResourceLoader::_validate_local_path(p_path);\n \treturn ResourceCache::get_ref(local_path);\n }\n \ndiff --git a/core/io/resource_loader.cpp b/core/io/resource_loader.cpp\nindex 8f873d859b65..7cc91ef4318b 100644\n--- a/core/io/resource_loader.cpp\n+++ b/core/io/resource_loader.cpp\n@@ -495,7 +495,7 @@ void ResourceLoader::_run_load_task(void *p_userdata) {\n \tcurr_load_task = curr_load_task_backup;\n }\n \n-static String _validate_local_path(const String &p_path) {\n+String ResourceLoader::_validate_local_path(const String &p_path) {\n \tResourceUID::ID uid = ResourceUID::get_singleton()->text_to_id(p_path);\n \tif (uid != ResourceUID::INVALID_ID) {\n \t\treturn ResourceUID::get_singleton()->get_id_path(uid);\ndiff --git a/core/io/resource_loader.h b/core/io/resource_loader.h\nindex f933e88b23bf..56052b6a6fc4 100644\n--- a/core/io/resource_loader.h\n+++ b/core/io/resource_loader.h\n@@ -36,6 +36,10 @@\n #include \"core/object/worker_thread_pool.h\"\n #include \"core/os/thread.h\"\n \n+namespace core_bind {\n+class ResourceLoader;\n+}\n+\n class ConditionVariable;\n \n template <int Tag>\n@@ -101,6 +105,7 @@ typedef void (*ResourceLoadedCallback)(Ref<Resource> p_resource, const String &p\n \n class ResourceLoader {\n \tfriend class LoadToken;\n+\tfriend class core_bind::ResourceLoader;\n \n \tenum {\n \t\tMAX_LOADERS = 64\n@@ -217,6 +222,8 @@ class ResourceLoader {\n \n \tstatic bool _ensure_load_progress();\n \n+\tstatic String _validate_local_path(const String &p_path);\n+\n public:\n \tstatic Error load_threaded_request(const String &p_path, const String &p_type_hint = \"\", bool p_use_sub_threads = false, ResourceFormatLoader::CacheMode p_cache_mode = ResourceFormatLoader::CACHE_MODE_REUSE);\n \tstatic ThreadLoadStatus load_threaded_get_status(const String &p_path, float *r_progress = nullptr);\n", "instance_id": "godotengine__godot-101752", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue with `ResourceLoader.has_cached()` not returning the correct value when a UID is passed, compared to when a resource path is used. It includes specific steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities: the problem statement does not explicitly discuss expected behavior for edge cases (e.g., invalid UIDs or non-existent resources) or constraints on the input format for UIDs. Additionally, while the issue is well-documented, the desired fix or expected outcome is implied rather than explicitly stated (e.g., should `has_cached()` always resolve UIDs to paths internally?). These minor missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, affecting a small number of files (`core_bind.cpp`, `resource_loader.cpp`, and `resource_loader.h`) and primarily involving modifications to path validation logic. The changes replace a call to `ProjectSettings::localize_path()` with a custom `ResourceLoader::_validate_local_path()` function that handles UID-to-path conversion, which is a straightforward fix once understood. However, it requires a moderate understanding of the Godot engine's resource loading system, including how UIDs and resource paths are managed internally, as well as familiarity with the `ResourceCache` and `ResourceUID` classes. The problem also touches on namespace and access control adjustments (e.g., making `_validate_local_path` non-static and adding friend class declarations), which adds a slight layer of complexity. There are no explicit edge cases mentioned in the problem statement, but the code changes implicitly handle the UID resolution case, and potential error handling for invalid UIDs or paths may need consideration. Overall, this requires understanding a few specific concepts and making targeted changes across a few files, but it does not significantly impact the broader architecture or involve deep system-level modifications. A score of 0.45 reflects this as a medium-difficulty task, leaning towards the lower end due to the focused nature of the fix.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Ctrl-Click on enum value/member does nothing\n### Tested versions\n\n- reproducible in: 4.4.dev7\n- reproducible on master (tested with a 03-Jan-2025 build - `v4.4.dev.gh-101012 [c37ada786]`)\n- works in: 4.4.dev6\n\n\n### System information\n\nGodot v4.4.dev7 - Windows 11 (build 22631) - Multi-window, 1 monitor - OpenGL 3 (Compatibility) - NVIDIA GeForce RTX 2070 SUPER (NVIDIA; 32.0.15.6636) - 13th Gen Intel(R) Core(TM) i7-13700KF (24 threads)\n\n### Issue description\n\nI mentioned this here: https://github.com/godotengine/godot/issues/100680#issuecomment-2557966392\nWhile general control-click was restored with https://github.com/godotengine/godot/pull/100707 the enum issue remains.\n\nCTRL-clicking on an enum value/member does nothing (well, it actually navigates to the beginning of the line).\n\nE.g. enum like this:\n```\nclass_name E extends Object\n\nenum Team {\n\tNone,\n\tOne,\n}\n\nfunc test():\n\tvar t = E.Team.None\n```\nand CTRL-clicking on the `None` of `E.Team.None` does not take you to the `None` under `enum Team`.\n\n\n### Steps to reproduce\n\nOpen enum.gd in MRP - same code as in description.\n\n### Minimal reproduction project (MRP)\n\n[44dev7enum.zip](https://github.com/user-attachments/files/18303044/44dev7enum.zip)\n\n", "patch": "diff --git a/modules/gdscript/gdscript_editor.cpp b/modules/gdscript/gdscript_editor.cpp\nindex c20c17f34860..7ee8d8c42614 100644\n--- a/modules/gdscript/gdscript_editor.cpp\n+++ b/modules/gdscript/gdscript_editor.cpp\n@@ -3684,12 +3684,12 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::GROUP:\n \t\t\t\t\t\treturn ERR_BUG;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CLASS: {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(member.get_datatype()), doc_type_name, doc_enum_name);\n \n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS;\n-\t\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\t} break;\n \t\t\t\t\tcase GDScriptParser::ClassNode::Member::CONSTANT:\n \t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n@@ -3712,11 +3712,11 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\t\t}\n \n \t\t\t\tif (member.type != GDScriptParser::ClassNode::Member::CLASS) {\n-\t\t\t\t\tString type_name;\n-\t\t\t\t\tString enum_name;\n-\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\tr_result.class_name = type_name;\n+\t\t\t\t\tr_result.class_name = doc_type_name;\n \t\t\t\t\tr_result.class_member = name;\n \t\t\t\t}\n \n@@ -3934,21 +3934,35 @@ static Error _lookup_symbol_from_base(const GDScriptParser::DataType &p_base, co\n \t\t\tcase GDScriptParser::DataType::ENUM: {\n \t\t\t\tif (base_type.is_meta_type) {\n \t\t\t\t\tif (base_type.enum_values.has(p_symbol)) {\n-\t\t\t\t\t\tString type_name;\n-\t\t\t\t\t\tString enum_name;\n-\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), type_name, enum_name);\n+\t\t\t\t\t\tString doc_type_name;\n+\t\t\t\t\t\tString doc_enum_name;\n+\t\t\t\t\t\tGDScriptDocGen::doctype_from_gdtype(GDScriptAnalyzer::type_from_metatype(base_type), doc_type_name, doc_enum_name);\n \n-\t\t\t\t\t\tif (CoreConstants::is_global_enum(enum_name)) {\n+\t\t\t\t\t\tif (CoreConstants::is_global_enum(doc_enum_name)) {\n \t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n \t\t\t\t\t\t\tr_result.class_name = \"@GlobalScope\";\n \t\t\t\t\t\t\tr_result.class_member = p_symbol;\n \t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t} else {\n-\t\t\t\t\t\t\tconst int dot_pos = enum_name.rfind_char('.');\n+\t\t\t\t\t\t\tconst int dot_pos = doc_enum_name.rfind_char('.');\n \t\t\t\t\t\t\tif (dot_pos >= 0) {\n \t\t\t\t\t\t\t\tr_result.type = ScriptLanguage::LOOKUP_RESULT_CLASS_CONSTANT;\n-\t\t\t\t\t\t\t\tr_result.class_name = enum_name.left(dot_pos);\n+\t\t\t\t\t\t\t\tr_result.class_name = doc_enum_name.left(dot_pos);\n \t\t\t\t\t\t\t\tr_result.class_member = p_symbol;\n+\t\t\t\t\t\t\t\tif (base_type.class_type != nullptr) {\n+\t\t\t\t\t\t\t\t\tconst String enum_name = doc_enum_name.substr(dot_pos + 1);\n+\t\t\t\t\t\t\t\t\tif (base_type.class_type->has_member(enum_name)) {\n+\t\t\t\t\t\t\t\t\t\tconst GDScriptParser::ClassNode::Member member = base_type.class_type->get_member(enum_name);\n+\t\t\t\t\t\t\t\t\t\tif (member.type == GDScriptParser::ClassNode::Member::ENUM) {\n+\t\t\t\t\t\t\t\t\t\t\tfor (const GDScriptParser::EnumNode::Value &value : member.m_enum->values) {\n+\t\t\t\t\t\t\t\t\t\t\t\tif (value.identifier->name == p_symbol) {\n+\t\t\t\t\t\t\t\t\t\t\t\t\tr_result.location = value.line;\n+\t\t\t\t\t\t\t\t\t\t\t\t\tbreak;\n+\t\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t\t}\n+\t\t\t\t\t\t\t\t}\n \t\t\t\t\t\t\t\treturn OK;\n \t\t\t\t\t\t\t}\n \t\t\t\t\t\t}\n", "instance_id": "godotengine__godot-101127", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: CTRL-clicking on an enum value in the Godot engine's GDScript editor does not navigate to the correct definition of the enum member, instead navigating to the beginning of the line. The statement includes specific versions where the issue is reproducible, system information, a minimal reproduction project (MRP), and a clear example of the problematic code. Steps to reproduce are provided, which adds to the clarity. However, there are minor ambiguities, such as the lack of explicit mention of expected behavior beyond \"navigating to the enum definition\" and no discussion of potential edge cases (e.g., nested enums, global vs. local enums, or enums in different files). Additionally, the problem statement does not specify constraints or requirements for the fix (e.g., performance considerations or compatibility with other features). Thus, while the issue is well-defined, minor details are missing, warranting a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`gdscript_editor.cpp`) and specific functions related to symbol lookup in the GDScript editor. The changes involve modifying how enum values are resolved and navigated to, which requires understanding the existing symbol lookup logic and the structure of the GDScript parser and data types. Second, the technical concepts involved include familiarity with C++ (the language of the Godot engine), the internal representation of GDScript enums, and the editor's navigation system. The code changes also require handling specific cases like global enums and extracting class and member names, which adds moderate complexity. Third, the changes impact a specific feature (CTRL-click navigation) but do not appear to affect the broader system architecture or performance significantly. Finally, while the problem statement does not explicitly mention edge cases, the code changes suggest the need to handle different enum contexts (e.g., global vs. class-specific enums) and locate the exact line of the enum value definition, which introduces some complexity in error handling and edge case management. Overall, this problem requires a solid understanding of the Godot engine's internals and moderate effort to implement and test the fix, justifying a difficulty score of 0.55.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Setting SpinBox value with signal gets overwritten by the LineEdit's text value when the LineEdit is about to lose focus.\n### Tested versions\n\n- Reproducible in v4.4.dev7.official [46c8f8c5c]\n- Reproducible in v4.3.stable.official [77dcf97d8]\n- Reproducible in v4.2.2.stable.official [15073afe3]\n\n### System information\n\nGodot v4.3.stable - Windows 10.0.19045 - GLES3 (Compatibility) - NVIDIA GeForce GTX 750 Ti (NVIDIA; 32.0.15.6094) - Intel(R) Core(TM) i5-6400 CPU @ 2.70GHz (4 Threads)\n\n### Issue description\n\nWhen setting a SpinBox value with a signal **when the SpinBox's LineEdit still has focus** and is about to lose focus the value is first set correctly but then is set again to the LineEdit's displayed value. If the value is set with `set_value_no_signal` to prevent emmiting a signal, the SpinBox will emit the `value_changed` signal with the incorrect value.\n\nhttps://github.com/user-attachments/assets/32618d3e-910a-418e-b913-0fc2db197b9d\n\n\n### Steps to reproduce\n\nUsing the MRP:\n\n1. Click on the SpinBox's LineEdit.\n2. Click on the LineEdit next to it (Or any other node. This is just so that the SpinBox loses focus)\n3. The value will be set correctly (and a signal emmited depending on what method to set the value was used)\n4. The value will then be set to whatever the SpinBox's LineEdit is displaying instead of the set value and a signal will be emmited.\n\nThe MRP has prints to inform of the values the moment before and after they are set.\n\nI've seen that the issue only occours if the value is set right before the SpinBox loses focus.\n\nThe issue is prevented if you ALSO set the SpinBox's value to its TextBox:\n`spin_box.get_line_edit().text = str(spin_box.value)`\n\n### Minimal reproduction project (MRP)\n\n[debugging.zip](https://github.com/user-attachments/files/18256719/debugging.zip)\n\n", "patch": "diff --git a/scene/gui/spin_box.cpp b/scene/gui/spin_box.cpp\nindex ffe6e2bb9785..e76170623955 100644\n--- a/scene/gui/spin_box.cpp\n+++ b/scene/gui/spin_box.cpp\n@@ -40,7 +40,7 @@ Size2 SpinBox::get_minimum_size() const {\n \treturn ms;\n }\n \n-void SpinBox::_update_text(bool p_keep_line_edit) {\n+void SpinBox::_update_text(bool p_only_update_if_value_changed) {\n \tdouble step = get_step();\n \tif (use_custom_arrow_step && custom_arrow_step != 0.0) {\n \t\tstep = custom_arrow_step;\n@@ -50,6 +50,11 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\tvalue = TS->format_number(value);\n \t}\n \n+\tif (p_only_update_if_value_changed && value == last_text_value) {\n+\t\treturn;\n+\t}\n+\tlast_text_value = value;\n+\n \tif (!line_edit->is_editing()) {\n \t\tif (!prefix.is_empty()) {\n \t\t\tvalue = prefix + \" \" + value;\n@@ -58,17 +63,12 @@ void SpinBox::_update_text(bool p_keep_line_edit) {\n \t\t\tvalue += \" \" + suffix;\n \t\t}\n \t}\n-\n-\tif (p_keep_line_edit && value == last_updated_text && value != line_edit->get_text()) {\n-\t\treturn;\n-\t}\n-\n \tline_edit->set_text_with_selection(value);\n-\tlast_updated_text = value;\n }\n \n void SpinBox::_text_submitted(const String &p_string) {\n \tif (p_string.is_empty()) {\n+\t\t_update_text();\n \t\treturn;\n \t}\n \n@@ -288,14 +288,12 @@ void SpinBox::_line_edit_editing_toggled(bool p_toggled_on) {\n \t\t\tline_edit->select_all();\n \t\t}\n \t} else {\n-\t\t// Discontinue because the focus_exit was caused by canceling or the text is empty.\n \t\tif (Input::get_singleton()->is_action_pressed(\"ui_cancel\") || line_edit->get_text().is_empty()) {\n-\t\t\t_update_text();\n-\t\t\treturn;\n+\t\t\t_update_text(); // Revert text if editing was canceled.\n+\t\t} else {\n+\t\t\t_update_text(true); // Update text in case value was changed this frame (e.g. on `focus_exited`).\n+\t\t\t_text_submitted(line_edit->get_text());\n \t\t}\n-\n-\t\tline_edit->deselect();\n-\t\t_text_submitted(line_edit->get_text());\n \t}\n }\n \ndiff --git a/scene/gui/spin_box.h b/scene/gui/spin_box.h\nindex 564294649c94..79076d3f4692 100644\n--- a/scene/gui/spin_box.h\n+++ b/scene/gui/spin_box.h\n@@ -58,13 +58,13 @@ class SpinBox : public Range {\n \tvoid _range_click_timeout();\n \tvoid _release_mouse_from_drag_mode();\n \n-\tvoid _update_text(bool p_keep_line_edit = false);\n+\tvoid _update_text(bool p_only_update_if_value_changed = false);\n \tvoid _text_submitted(const String &p_string);\n \tvoid _text_changed(const String &p_string);\n \n \tString prefix;\n \tString suffix;\n-\tString last_updated_text;\n+\tString last_text_value;\n \tdouble custom_arrow_step = 0.0;\n \tbool use_custom_arrow_step = false;\n \n", "instance_id": "godotengine__godot-100860", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the SpinBox component in the Godot engine, where setting a value via a signal gets overwritten by the LineEdit's text value when losing focus. It provides specific versions affected, system information, steps to reproduce, and a minimal reproduction project (MRP). The goal of fixing the incorrect value update behavior is evident, and the issue's context (focus loss timing) is well-articulated. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior in all scenarios (e.g., what should happen if the LineEdit text is invalid), and edge cases beyond the focus loss timing are not mentioned. Additionally, while the MRP and steps to reproduce are helpful, the lack of detailed expected output for various input scenarios slightly reduces clarity. Overall, it is a valid and mostly clear description but misses some minor details that could aid in fully understanding the requirements.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively contained, primarily affecting a single file (`spin_box.cpp`) and its associated header (`spin_box.h`), with modifications to a few key functions like `_update_text` and `_line_edit_editing_toggled`. The changes involve a moderate amount of code (around 20-30 lines modified), focusing on logic for text updates and focus handling, without impacting the broader system architecture. Second, the technical concepts required include understanding C++ class member interactions, event handling (focus and text submission events), and state management (tracking last text values), which are moderately complex but not overly advanced. Third, the problem requires handling specific edge cases related to focus loss timing and ensuring signals are emitted correctly, as highlighted in the problem statement, but these are not extraordinarily intricate. Finally, solving this requires a good grasp of the SpinBox component's internal behavior in Godot, which adds some complexity but does not necessitate deep architectural refactoring or advanced domain-specific knowledge. A score of 0.55 reflects a medium difficulty level, as it involves understanding multiple concepts and making targeted, non-trivial modifications, but it is not a highly challenging or system-wide issue.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Jolt Physics: state.get_contact_collider_position() Fails for Sleeping Bodies Despite get_contact_count() > 0\n### Tested versions\n\n- Reproducible in: 4.3.stable\n\n### System information\n\nWindows 10 - Vulkan (Forward+) - NVIDIA RTX 3060\n\n### Issue description\n\n**Jolt was just integrated to Godot, so I believe this should be in Godot issues. If not let me know!**\n\nWhen using Jolt Physics in Godot 4, and trying to get collision contact points between bodies, calling state.get_contact_collider_position(index) for a RigidBody3D results in an \"Index out of bounds\" error if the body gets in sleep mode. This occurs even when get_contact_count() reports a value greater than 0. The error does not occur with default Godot Physics\n\nThe error:\n```\n_physics_process(): Index p_contact_idx = 0 is out of bounds (body->get_contact_count() = 0).\n  <C++ Source>   src\\objects\\jolt_physics_direct_body_state_3d.cpp:217 @ _get_contact_collider_position()\n```\n\nThis behavior affects contact point calculations for bodies that are stationary but still colliding with other objects\n\n### Steps to reproduce\n\n1. Set up a scene with two colliding RigidBody3D objects.\n2. Ensure Jolt Physics is installed and defined as current physics engine\n3. Enable contact_monitor and set max_contacts_reported to a non-zero value (e.g., 5).\n4. Let one of the bodies come to rest, causing it to enter sleep mode.\n5. Execute the code below inside the body that has come to a rest:\n\n```\nextends RigidBody3D\n\nfunc _ready() -> void:\n\tcontact_monitor = true\n\tmax_contacts_reported = 5\n\nfunc _physics_process(_delta: float) -> void:\n\t# Get body rid\n\tvar rid := get_rid()\n\t# Get body physics state\n\tvar state := PhysicsServer3D.body_get_direct_state(rid)\n\t\n\tfor i in get_contact_count():\n\t\tprint(\"Contact count: \", get_contact_count(),\n\t\t\t\"  \", state.get_contact_collider_position(i))\n```\n\n**Expected Behavior:**\nstate.get_contact_collider_position(index) should return valid contact points if get_contact_count() > 0, even when the body is in sleep mode.\n\n**Observed Behavior:**\nAn \"Index out of bounds\" error occurs, and get_contact_collider_position() fails.\n\n### Minimal reproduction project (MRP)\n\nI had to remove macOS, Linux and android libraries from the Jolt folder to make the file small enough to upload. You can always reinstall jolt add-on to make sure.\n\n[BugJoltContact.zip](https://github.com/user-attachments/files/18168435/BugJoltContact.zip)\n\n\n\n", "patch": "diff --git a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\nindex 21fb76464b27..85cf08d4c921 100644\n--- a/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n+++ b/modules/jolt_physics/spaces/jolt_contact_listener_3d.cpp\n@@ -407,24 +407,28 @@ void JoltContactListener3D::_flush_contacts() {\n \t\tconst JPH::SubShapeIDPair &shape_pair = E.key;\n \t\tManifold &manifold = E.value;\n \n-\t\tconst JPH::BodyID body_ids[2] = { shape_pair.GetBody1ID(), shape_pair.GetBody2ID() };\n-\t\tconst JoltReadableBodies3D jolt_bodies = space->read_bodies(body_ids, 2);\n+\t\tconst JoltReadableBody3D jolt_body1 = space->read_body(shape_pair.GetBody1ID());\n+\t\tconst JoltReadableBody3D jolt_body2 = space->read_body(shape_pair.GetBody2ID());\n \n-\t\tJoltBody3D *body1 = jolt_bodies[0].as_body();\n+\t\tJoltBody3D *body1 = jolt_body1.as_body();\n \t\tERR_FAIL_NULL(body1);\n \n-\t\tJoltBody3D *body2 = jolt_bodies[1].as_body();\n+\t\tJoltBody3D *body2 = jolt_body2.as_body();\n \t\tERR_FAIL_NULL(body2);\n \n \t\tconst int shape_index1 = body1->find_shape_index(shape_pair.GetSubShapeID1());\n \t\tconst int shape_index2 = body2->find_shape_index(shape_pair.GetSubShapeID2());\n \n-\t\tfor (const Contact &contact : manifold.contacts1) {\n-\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body1->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts1) {\n+\t\t\t\tbody1->add_contact(body2, manifold.depth, shape_index1, shape_index2, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n-\t\tfor (const Contact &contact : manifold.contacts2) {\n-\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\tif (jolt_body2->IsActive()) {\n+\t\t\tfor (const Contact &contact : manifold.contacts2) {\n+\t\t\t\tbody2->add_contact(body1, manifold.depth, shape_index2, shape_index1, contact.normal, contact.point_self, contact.point_other, contact.velocity_self, contact.velocity_other, contact.impulse);\n+\t\t\t}\n \t\t}\n \n \t\tmanifold.contacts1.clear();\n", "instance_id": "godotengine__godot-100533", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the context (Jolt Physics integration in Godot), the specific behavior observed (failure of `state.get_contact_collider_position()` for sleeping bodies despite `get_contact_count() > 0`), and the expected behavior. It also includes steps to reproduce the issue, system information, and a minimal reproduction project (MRP). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly discuss potential edge cases beyond sleeping bodies (e.g., what happens during transitions between active and sleep states, or with multiple simultaneous contacts). Additionally, it lacks clarity on whether this behavior is specific to certain types of collisions or configurations. While the issue is well-documented, these minor gaps prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).\n", "difficulty_explanation": "\nI assign a difficulty score of 0.45, placing this problem in the medium range, based on the following analysis of the factors:\n\n1. **Clarity and Complexity of the Problem Description**: The problem is relatively straightforward—ensuring contact points are reported correctly for sleeping bodies in a physics engine. The logic is not inherently complex, but it requires understanding the specific behavior of Jolt Physics and its integration with Godot.\n\n2. **Scope and Depth of Code Changes**: The provided code changes are localized to a single file (`jolt_contact_listener_3d.cpp`) and involve a small modification to conditionally add contacts only for active bodies using `IsActive()`. The change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is minimal, focusing on adding conditional checks before processing contacts.\n\n3. **Number of Technical Concepts**: Solving this requires understanding a few specific concepts: physics engine internals (e.g., body states like active/sleeping in Jolt Physics), Godot's physics integration, and C++ programming within the context of the Jolt library. While these concepts are not overly complex for someone familiar with physics engines or game development, they do require domain-specific knowledge and familiarity with the Jolt API.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement highlights the primary edge case (sleeping bodies with reported contacts), but the code change introduces a potential issue: by skipping contact reporting for inactive bodies, it might suppress valid contact data, which could lead to other bugs or unexpected behavior in Godot. The modification does not explicitly address error handling beyond the conditional check, and further investigation might be needed to ensure no side effects occur (e.g., during state transitions or with multiple contacts). The edge case handling is moderate in complexity.\n\nOverall, this problem falls into the medium difficulty range (0.4-0.6) because it requires understanding specific domain knowledge (physics engines and Jolt/Godot integration) and making a targeted but potentially impactful change. It is not a simple bug fix due to the need to consider the implications of skipping contact reporting for inactive bodies, but it is also not a deep architectural change or a highly complex problem. A score of 0.45 reflects this balance.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "build: Native ./depends build fails on s390x\nSteps to reproduce on a fresh s390x machine:\r\n\r\n```\r\nmake NO_QT=1 NO_WALLET=1 NO_UPNP=1 NO_NATPMP=1 -j $(nproc)\r\n```\r\n\r\n(Cross-compilation to s390x works)\r\n\r\n\r\nOutput:\r\n\r\n```\r\nBuilding zeromq...\r\nmake[1]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[3]: Entering directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\n[  1%] Building CXX object CMakeFiles/objects.dir/src/address.cpp.o\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/precompiled.hpp:16,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:3:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/command.hpp:191:26: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n  191 | __attribute__ ((aligned (ZMQ_CACHELINE_SIZE)))\r\n      |                          ^~~~~~~~~~~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/platform.hpp:22:28: error: 'undefined' was not declared in this scope\r\n   22 | #define ZMQ_CACHELINE_SIZE undefined\r\n      |                            ^~~~~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/yqueue.hpp:34:45: note: in expansion of macro 'ZMQ_CACHELINE_SIZE'\r\n   34 | template <typename T, int N, size_t ALIGN = ZMQ_CACHELINE_SIZE> class yqueue_t\r\n      |                                             ^~~~~~~~~~~~~~~~~~\r\nIn file included from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/mailbox.hpp:12,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ctx.hpp:11,\r\n                 from /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/address.cpp:6:\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:155:18: error: template argument 3 is invalid\r\n  155 |     yqueue_t<T, N> _queue;\r\n      |                  ^\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In constructor 'zmq::ypipe_t<T, N>::ypipe_t()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:26:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   26 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:30:32: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   30 |         _r = _w = _f = &_queue.back ();\r\n      |                                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:31:25: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   31 |         _c.set (&_queue.back ());\r\n      |                         ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'void zmq::ypipe_t<T, N>::write(const T&, bool)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:50:16: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   50 |         _queue.back () = value_;\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:51:16: error: request for member 'push' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   51 |         _queue.push ();\r\n      |                ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:55:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   55 |             _f = &_queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::unwrite(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:66:27: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   66 |         if (_f == &_queue.back ())\r\n      |                           ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:68:16: error: request for member 'unpush' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   68 |         _queue.unpush ();\r\n      |                ^~~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:69:26: error: request for member 'back' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n   69 |         *value_ = _queue.back ();\r\n      |                          ^~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::check_read()':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:104:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  104 |         if (&_queue.front () != _r && _r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:111:30: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  111 |         _r = _c.cas (&_queue.front (), NULL);\r\n      |                              ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:117:21: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  117 |         if (&_queue.front () == _r || !_r)\r\n      |                     ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::read(T*)':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:134:26: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  134 |         *value_ = _queue.front ();\r\n      |                          ^~~~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:135:16: error: request for member 'pop' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  135 |         _queue.pop ();\r\n      |                ^~~\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp: In member function 'bool zmq::ypipe_t<T, N>::probe(bool (*)(const T&))':\r\n/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/src/ypipe.hpp:147:31: error: request for member 'front' in '((zmq::ypipe_t<T, N>*)this)->zmq::ypipe_t<T, N>::_queue', which is of non-class type 'int'\r\n  147 |         return (*fn_) (_queue.front ());\r\n      |                               ^~~~~\r\nAt global scope:\r\ncc1plus: note: unrecognized command-line option '-Wno-tautological-constant-compare' may have been intended to silence earlier diagnostics\r\nmake[3]: *** [CMakeFiles/objects.dir/build.make:90: CMakeFiles/objects.dir/src/address.cpp.o] Error 1\r\nmake[3]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[2]: *** [CMakeFiles/Makefile2:88: CMakeFiles/objects.dir/all] Error 2\r\nmake[2]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake[1]: *** [Makefile:136: all] Error 2\r\nmake[1]: Leaving directory '/b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build'\r\nmake: *** [funcs.mk:301: /b-c/depends/work/build/s390x-ibm-linux-gnu/zeromq/4.3.5-be763aa3d4e/build/.stamp_built] Error 2\r\n```\r\n\r\n\n", "patch": "diff --git a/depends/packages/zeromq.mk b/depends/packages/zeromq.mk\nindex 7620df5477727..df018a1032247 100644\n--- a/depends/packages/zeromq.mk\n+++ b/depends/packages/zeromq.mk\n@@ -10,6 +10,7 @@ $(package)_patches += builtin_sha1.patch\n $(package)_patches += fix_have_windows.patch\n $(package)_patches += openbsd_kqueue_headers.patch\n $(package)_patches += cmake_minimum.patch\n+$(package)_patches += cacheline_undefined.patch\n $(package)_patches += no_librt.patch\n \n define $(package)_set_vars\n@@ -25,6 +26,7 @@ define $(package)_preprocess_cmds\n   patch -p1 < $($(package)_patch_dir)/remove_libstd_link.patch && \\\n   patch -p1 < $($(package)_patch_dir)/macos_mktemp_check.patch && \\\n   patch -p1 < $($(package)_patch_dir)/builtin_sha1.patch && \\\n+  patch -p1 < $($(package)_patch_dir)/cacheline_undefined.patch && \\\n   patch -p1 < $($(package)_patch_dir)/fix_have_windows.patch && \\\n   patch -p1 < $($(package)_patch_dir)/openbsd_kqueue_headers.patch && \\\n   patch -p1 < $($(package)_patch_dir)/cmake_minimum.patch && \\\ndiff --git a/depends/patches/zeromq/cacheline_undefined.patch b/depends/patches/zeromq/cacheline_undefined.patch\nnew file mode 100644\nindex 0000000000000..02bd2a5fe5d5a\n--- /dev/null\n+++ b/depends/patches/zeromq/cacheline_undefined.patch\n@@ -0,0 +1,15 @@\n+Use proper STREQUAL instead of EQUAL to compare strings.txt\n+\n+See: https://github.com/zeromq/libzmq/pull/4711.\n+\n+--- a/CMakeLists.txt\n++++ b/CMakeLists.txt\n+@@ -476,7 +476,7 @@ execute_process(\n+ if(CACHELINE_SIZE STREQUAL \"\"\n+    OR CACHELINE_SIZE EQUAL 0\n+    OR CACHELINE_SIZE EQUAL -1\n+-   OR CACHELINE_SIZE EQUAL \"undefined\")\n++   OR CACHELINE_SIZE STREQUAL \"undefined\")\n+   set(ZMQ_CACHELINE_SIZE 64)\n+ else()\n+   set(ZMQ_CACHELINE_SIZE ${CACHELINE_SIZE})\n", "instance_id": "bitcoin__bitcoin-30588", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a build failure for ZeroMQ on s390x architecture during a native build. It provides steps to reproduce the issue, including the exact command to run, and includes detailed error output from the build process. The error messages point to a specific problem with the `ZMQ_CACHELINE_SIZE` macro being set to \"undefined,\" which causes compilation errors in the ZeroMQ library. However, the statement lacks explicit mention of the expected outcome or constraints (e.g., what should happen after the fix, or any performance considerations). Additionally, edge cases or potential side effects of the fix are not discussed. While the issue is clear to someone familiar with build systems and compilation errors, minor details are missing that could help in fully understanding the context or potential challenges in resolving it. Hence, I rate it as \"Mostly Clear\" with a score of 2.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" category with a score of 0.30. Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The code changes are minimal and localized to the build configuration of ZeroMQ. The fix involves adding a patch (`cacheline_undefined.patch`) to correct a string comparison in the CMake configuration file, changing `EQUAL` to `STREQUAL` for comparing the `CACHELINE_SIZE` value. The modification is limited to a single line in the CMakeLists.txt file and the addition of a patch file in the build system. It does not impact the broader architecture of the system or require changes across multiple modules. The amount of code change is very small.\n\n2. **Number of Technical Concepts:** Solving this requires a basic understanding of CMake scripting and string comparison operations within CMake. Familiarity with build systems and how patches are applied in a dependency management context (as seen in the `zeromq.mk` file) is necessary but not complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond build configuration are needed. The concept of cache line size and its relevance to performance is tangential and not directly required to implement the fix.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement and error output do not explicitly mention edge cases or additional error handling requirements. The fix addresses a specific build error caused by an incorrect comparison operator in CMake. There is no indication that the change introduces new edge cases or requires additional error handling logic. The simplicity of the fix suggests minimal risk of unintended side effects.\n\n4. **Overall Complexity:** The issue is a straightforward build configuration error that can be resolved with a small, targeted patch. It requires understanding the error message and applying a fix in the build script, which is a routine task for someone with experience in software builds. The problem does not demand deep knowledge of the ZeroMQ library internals or the s390x architecture beyond recognizing the build failure.\n\nGiven these factors, the problem is relatively easy, requiring only a basic understanding of CMake and build systems to implement a simple fix. A score of 0.30 reflects this as an \"Easy\" task, slightly above the lowest difficulty due to the need to interpret build errors and apply a patch in a dependency management system.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Terminal Canary] Cursor doesn't show up in Terminal\n### Windows Terminal version\n\n1.23.10011.0\n\n### Windows build number\n\n10.0.27764.1000\n\n### Other Software\n\nsudo for Windows (1.0.1)\n\n### Steps to reproduce\n\n1. Launch Terminal Canary \n2. Launch a command with `sudo`\n3. Hover over the terminal with the cursor\n\n### Expected Behavior\n\nThe cursor should be visible when you hover over the Terminal launched with administrative privileges.\n\n### Actual Behavior\n\nCursor isn't showing when you hover over the Terminal.\n\nhttps://github.com/user-attachments/assets/b0ace3d3-c69e-475b-bac9-c864db5d76c7\n\n\n", "patch": "diff --git a/.github/actions/spelling/expect/expect.txt b/.github/actions/spelling/expect/expect.txt\nindex 55f9bac881d..b77cf969f49 100644\n--- a/.github/actions/spelling/expect/expect.txt\n+++ b/.github/actions/spelling/expect/expect.txt\n@@ -1354,6 +1354,7 @@ PNMLINK\n pntm\n POBJECT\n Podcast\n+POINTERUPDATE\n POINTSLIST\n policheck\n POLYTEXTW\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 3724edd542c..d40ea2feb7f 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -47,66 +47,6 @@ constexpr std::wstring_view StateCollapsed{ L\"Collapsed\" };\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::CopyFormat);\r\n DEFINE_ENUM_FLAG_OPERATORS(winrt::Microsoft::Terminal::Control::MouseButtonState);\r\n \r\n-// WinUI 3's UIElement.ProtectedCursor property allows someone to set the cursor on a per-element basis.\r\n-// This would allow us to hide the cursor when the TermControl has input focus and someone starts typing.\r\n-// Unfortunately, no equivalent exists for WinUI 2 so we fake it with the CoreWindow.\r\n-// There are 3 downsides:\r\n-// * SetPointerCapture() is global state and may interfere with other components.\r\n-// * You can't start dragging the cursor (for text selection) while it's still hidden.\r\n-// * The CoreWindow covers the union of all window rectangles, so the cursor is hidden even if it's outside\r\n-//   the current foreground window, but still on top of another Terminal window in the background.\r\n-static void hideCursorUntilMoved()\r\n-{\r\n-    static bool cursorIsHidden;\r\n-    static const auto shouldVanish = []() {\r\n-        BOOL shouldVanish = TRUE;\r\n-        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n-        if (!shouldVanish)\r\n-        {\r\n-            return false;\r\n-        }\r\n-\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        static constexpr auto releaseCapture = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                window.ReleasePointerCapture();\r\n-            }\r\n-        };\r\n-        static constexpr auto restoreCursor = [](CoreWindow window, PointerEventArgs) {\r\n-            if (cursorIsHidden)\r\n-            {\r\n-                cursorIsHidden = false;\r\n-                window.PointerCursor(CoreCursor{ CoreCursorType::Arrow, 0 });\r\n-            }\r\n-        };\r\n-\r\n-        winrt::Windows::Foundation::TypedEventHandler<CoreWindow, PointerEventArgs> releaseCaptureHandler{ releaseCapture };\r\n-        std::ignore = window.PointerMoved(releaseCaptureHandler);\r\n-        std::ignore = window.PointerPressed(releaseCaptureHandler);\r\n-        std::ignore = window.PointerReleased(releaseCaptureHandler);\r\n-        std::ignore = window.PointerWheelChanged(releaseCaptureHandler);\r\n-        std::ignore = window.PointerCaptureLost(restoreCursor);\r\n-        return true;\r\n-    }();\r\n-\r\n-    if (shouldVanish && !cursorIsHidden)\r\n-    {\r\n-        try\r\n-        {\r\n-            const auto window = CoreWindow::GetForCurrentThread();\r\n-            window.PointerCursor(nullptr);\r\n-            window.SetPointerCapture();\r\n-            cursorIsHidden = true;\r\n-        }\r\n-        catch (...)\r\n-        {\r\n-            // Swallow the 0x80070057 \"Failed to get pointer information.\" exception that randomly occurs.\r\n-            // Curiously, it doesn't happen during the PointerCursor() but during the SetPointerCapture() call (thanks, WinUI).\r\n-        }\r\n-    }\r\n-}\r\n-\r\n // InputPane::GetForCurrentView() does not reliably work for XAML islands,\r\n // as it assumes that there's a 1:1 relationship between windows and threads.\r\n //\r\n@@ -1551,8 +1491,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n             return;\r\n         }\r\n \r\n-        hideCursorUntilMoved();\r\n-\r\n         const auto ch = e.Character();\r\n         const auto keyStatus = e.KeyStatus();\r\n         const auto scanCode = gsl::narrow_cast<WORD>(keyStatus.ScanCode);\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.cpp b/src/cascadia/WindowsTerminal/IslandWindow.cpp\nindex 4c950cb986d..4b965be4022 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.cpp\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.cpp\n@@ -26,6 +26,48 @@ using VirtualKeyModifiers = winrt::Windows::System::VirtualKeyModifiers;\n #define XAML_HOSTING_WINDOW_CLASS_NAME L\"CASCADIA_HOSTING_WINDOW_CLASS\"\r\n #define IDM_SYSTEM_MENU_BEGIN 0x1000\r\n \r\n+// WinUI doesn't support the \"Hide cursor on input\" setting which is why all the modern Windows apps\r\n+// are broken in that respect. We want to support it though, so we implement an imitation of it here.\r\n+// We use the classic ShowCursor() API to hide it on keydown and show it on a select few messages.\r\n+// WinUI's SetPointerCapture() cannot be used for this, because it races with internal WinUI code\r\n+// calling that function and has proven itself to be very unreliable in practice.\r\n+//\r\n+// With UWP half the input stack got split off, and so most input events get rerouted through\r\n+// the CoreInput child window running in another thread (aka InputHost aka Windows.UI.Input).\r\n+// HideCursor() is called by WindowEmperor because WM_KEYDOWN is otherwise sent directly to that\r\n+// CoreInput window. Same for WM_POINTERUPDATE which we use to reliably detect cursor movement.\r\n+// WM_ACTIVATE on the other hand is only sent to each specific window and cannot be hooked by\r\n+// inspecting the MSG struct coming from GetMessage. That's why the code must be here.\r\n+// Best not think about this too much...\r\n+bool IslandWindow::IsCursorHidden() noexcept\r\n+{\r\n+    return _cursorHidden;\r\n+}\r\n+\r\n+void IslandWindow::HideCursor() noexcept\r\n+{\r\n+    static const auto shouldVanish = []() noexcept {\r\n+        BOOL shouldVanish = TRUE;\r\n+        SystemParametersInfoW(SPI_GETMOUSEVANISH, 0, &shouldVanish, 0);\r\n+        return shouldVanish != FALSE;\r\n+    }();\r\n+\r\n+    if (!_cursorHidden && shouldVanish)\r\n+    {\r\n+        ShowCursor(FALSE);\r\n+        _cursorHidden = true;\r\n+    }\r\n+}\r\n+\r\n+void IslandWindow::ShowCursorMaybe(const UINT message) noexcept\r\n+{\r\n+    if (_cursorHidden && (message == WM_ACTIVATE || message == WM_POINTERUPDATE))\r\n+    {\r\n+        _cursorHidden = false;\r\n+        ShowCursor(TRUE);\r\n+    }\r\n+}\r\n+\r\n IslandWindow::IslandWindow() noexcept :\r\n     _interopWindowHandle{ nullptr },\r\n     _rootGrid{ nullptr },\r\n@@ -425,6 +467,11 @@ void IslandWindow::_OnGetMinMaxInfo(const WPARAM /*wParam*/, const LPARAM lParam\n \r\n [[nodiscard]] LRESULT IslandWindow::MessageHandler(UINT const message, WPARAM const wparam, LPARAM const lparam) noexcept\r\n {\r\n+    if (IsCursorHidden())\r\n+    {\r\n+        ShowCursorMaybe(message);\r\n+    }\r\n+\r\n     switch (message)\r\n     {\r\n     case WM_GETMINMAXINFO:\r\ndiff --git a/src/cascadia/WindowsTerminal/IslandWindow.h b/src/cascadia/WindowsTerminal/IslandWindow.h\nindex 8432d4e8134..47d4e38ce98 100644\n--- a/src/cascadia/WindowsTerminal/IslandWindow.h\n+++ b/src/cascadia/WindowsTerminal/IslandWindow.h\n@@ -14,6 +14,10 @@ class IslandWindow :\n     public BaseWindow<IslandWindow>\n {\n public:\n+    static bool IsCursorHidden() noexcept;\n+    static void HideCursor() noexcept;\n+    static void ShowCursorMaybe(const UINT message) noexcept;\n+\n     IslandWindow() noexcept;\n     virtual ~IslandWindow() override;\n \n@@ -143,7 +147,7 @@ class IslandWindow :\n     bool _minimizeToNotificationArea{ false };\n \n     std::unordered_map<UINT, SystemMenuItemInfo> _systemMenuItems;\n-    UINT _systemMenuNextItemId;\n+    UINT _systemMenuNextItemId = 0;\n     void _resetSystemMenu();\n \n private:\n@@ -154,4 +158,6 @@ class IslandWindow :\n     // though the total height will take into account the non-client area\n     // and the requirements of components hosted in the client area\n     static constexpr float minimumHeight = 0;\n+\n+    inline static bool _cursorHidden;\n };\ndiff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 59f26b50b16..16e128d077b 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -417,6 +417,16 @@ void WindowEmperor::HandleCommandlineArgs(int nCmdShow)\n                 _dispatchSpecialKey(msg);\r\n                 continue;\r\n             }\r\n+\r\n+            if (msg.message == WM_KEYDOWN)\r\n+            {\r\n+                IslandWindow::HideCursor();\r\n+            }\r\n+        }\r\n+\r\n+        if (IslandWindow::IsCursorHidden())\r\n+        {\r\n+            IslandWindow::ShowCursorMaybe(msg.message);\r\n         }\r\n \r\n         TranslateMessage(&msg);\r\n", "instance_id": "microsoft__terminal-18445", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the cursor does not appear when hovering over the Terminal Canary window launched with administrative privileges using `sudo` on Windows. It provides the version of the software, the steps to reproduce, and the expected versus actual behavior, which helps in understanding the context. However, there are minor ambiguities and missing details. For instance, it does not specify whether this issue occurs under specific conditions (e.g., certain terminal profiles, specific hardware, or input devices) or if there are related side effects (e.g., does it affect functionality beyond visibility?). Additionally, there are no explicit constraints or requirements for the solution, such as performance expectations or compatibility concerns. While the attached video link (presumably showing the issue) is helpful, it is not a substitute for a detailed textual description of edge cases or environmental factors. Thus, the statement is valid and mostly clear but lacks some minor details that could aid in fully understanding the scope of the problem.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category (0.6-0.8) due to several factors. First, the scope of code changes spans multiple files (`TermControl.cpp`, `IslandWindow.cpp`, `IslandWindow.h`, `WindowEmperor.cpp`), indicating a need to understand and modify interactions across different components of the Windows Terminal codebase. The changes involve replacing an existing cursor-hiding mechanism (based on `CoreWindow` and `SetPointerCapture`) with a new approach using the classic `ShowCursor` API, which suggests a moderate impact on the system's input handling logic. This is not a trivial refactoring, as it requires careful handling to avoid race conditions or interference with other UI components, as noted in the code comments.\n\nSecond, the number of technical concepts involved is significant. The solution requires knowledge of Windows API calls (`ShowCursor`, `SystemParametersInfoW`), WinUI limitations, UWP input stack intricacies (e.g., CoreInput child window), and message handling in Windows (e.g., `WM_KEYDOWN`, `WM_POINTERUPDATE`, `WM_ACTIVATE`). Understanding the threading model and event routing in the Windows Terminal architecture is also necessary, which adds to the complexity.\n\nThird, while the problem statement does not explicitly mention edge cases, the code changes and comments imply potential challenges, such as ensuring the cursor visibility toggles correctly under various input events and window states (e.g., activation, pointer movement). The previous implementation's issues with global state interference (`SetPointerCapture`) and unreliable behavior highlight the need for robust error handling and testing across different scenarios, which increases the difficulty.\n\nOverall, this problem requires a deep understanding of the Windows Terminal's input handling and UI architecture, along with careful modifications to ensure compatibility and reliability. It is not at the very high end of difficulty (0.8-1.0) because it does not involve system-level redesign or highly specialized domain knowledge, but it is still a challenging task due to the cross-component changes and technical depth required.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[High Contrast] Colored tabs lose color when unfocused\n### Windows Terminal version\n\n1.14.1262.0\n\n### Windows build number\n\n10.0.22621.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Enter high contrast mode\r\n2. color a tab\r\n3. switch focus to another tab\n\n### Expected Behavior\n\ncolored tab should still retain the color\n\n### Actual Behavior\n\ncolored tab reverted to high contrast color (until focused again).\n", "patch": "diff --git a/src/cascadia/TerminalApp/TabBase.cpp b/src/cascadia/TerminalApp/TabBase.cpp\nindex 2d5e8da4433..55f2cffcb57 100644\n--- a/src/cascadia/TerminalApp/TabBase.cpp\n+++ b/src/cascadia/TerminalApp/TabBase.cpp\n@@ -458,45 +458,67 @@ namespace winrt::TerminalApp::implementation\n             deselectedFontBrush.Color(winrt::Windows::UI::Colors::White());\r\n         }\r\n \r\n-        // Prior to MUX 2.7, we set TabViewItemHeaderBackground, but now we can\r\n-        // use TabViewItem().Background() for that. HOWEVER,\r\n-        // TabViewItem().Background() only sets the color of the tab background\r\n-        // when the TabViewItem is unselected. So we still need to set the other\r\n-        // properties ourselves.\r\n-        //\r\n-        // In GH#11294 we thought we'd still need to set\r\n-        // TabViewItemHeaderBackground manually, but GH#11382 discovered that\r\n-        // Background() was actually okay after all.\r\n-\r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n-\r\n-        TabViewItem().Background(deselectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), hoverTabBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n-\r\n-        // Similarly, TabViewItem().Foreground()  sets the color for the text\r\n-        // when the TabViewItem isn't selected, but not when it is hovered,\r\n-        // pressed, dragged, or selected, so we'll need to just set them all\r\n-        // anyways.\r\n-        TabViewItem().Foreground(deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), secondaryFontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), subtleFillColorTertiaryBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), subtleFillColorSecondaryBrush);\r\n-\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n-        tabItemResources.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+        // Add the empty theme dictionaries\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n+        ResourceDictionary lightThemeDictionary;\r\n+        ResourceDictionary darkThemeDictionary;\r\n+        ResourceDictionary highContrastThemeDictionary;\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Light\"), lightThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"Dark\"), darkThemeDictionary);\r\n+        tabItemThemeResources.Insert(winrt::box_value(L\"HighContrast\"), highContrastThemeDictionary);\r\n+\r\n+        // Now actually set the resources we want in them.\r\n+        // Before, we used to put these on the ResourceDictionary directly.\r\n+        // However, HighContrast mode may require some adjustments. So let's just add\r\n+        //   all three so we can make those adjustments on the HighContrast version.\r\n+        for (const auto& [k, v] : tabItemThemeResources)\r\n+        {\r\n+            const bool isHighContrast = winrt::unbox_value<hstring>(k) == L\"HighContrast\";\r\n+            const auto& currentDictionary = v.as<ResourceDictionary>();\r\n+\r\n+            // TabViewItem.Background\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundSelected\"), selectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPointerOver\"), isHighContrast ? fontBrush : hoverTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderBackgroundPressed\"), selectedTabBrush);\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundSelected\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPointerOver\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderForegroundPressed\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForeground\"), deselectedFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPressed\"), isHighContrast ? deselectedFontBrush : secondaryFontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonForegroundPointerOver\"), isHighContrast ? deselectedFontBrush : fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPressedCloseButtonForeground\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderPointerOverCloseButtonForeground\"), isHighContrast ? selectedTabBrush : fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderSelectedCloseButtonForeground\"), fontBrush);\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackground\"), deselectedTabBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPressed\"), isHighContrast ? selectedTabBrush : subtleFillColorTertiaryBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\"), isHighContrast ? selectedTabBrush : subtleFillColorSecondaryBrush);\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundActiveTab\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPressed\"), fontBrush);\r\n+            currentDictionary.Insert(winrt::box_value(L\"TabViewButtonForegroundPointerOver\"), fontBrush);\r\n+\r\n+            // Add a few extra ones for high contrast mode\r\n+            // BODGY: contrary to the docs, Insert() seems to throw if the value already exists\r\n+            //   Make sure you don't touch any that already exist here!\r\n+            if (isHighContrast)\r\n+            {\r\n+                // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPressed\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\"), fontBrush);\r\n+                currentDictionary.Insert(winrt::box_value(L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"), fontBrush);\r\n+            }\r\n+        }\r\n \r\n         _RefreshVisualState();\r\n     }\r\n@@ -511,36 +533,55 @@ namespace winrt::TerminalApp::implementation\n     void TabBase::_ClearTabBackgroundColor()\r\n     {\r\n         static const winrt::hstring keys[] = {\r\n+            // TabViewItem.Background\r\n             L\"TabViewItemHeaderBackground\",\r\n             L\"TabViewItemHeaderBackgroundSelected\",\r\n             L\"TabViewItemHeaderBackgroundPointerOver\",\r\n             L\"TabViewItemHeaderBackgroundPressed\",\r\n+\r\n+            // TabViewItem.Foreground (aka text)\r\n             L\"TabViewItemHeaderForeground\",\r\n             L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderForegroundPointerOver\",\r\n             L\"TabViewItemHeaderForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground (aka X)\r\n             L\"TabViewItemHeaderCloseButtonForeground\",\r\n-            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+            L\"TabViewItemHeaderForegroundSelected\",\r\n             L\"TabViewItemHeaderCloseButtonForegroundPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonForegroundPressed\",\r\n+\r\n+            // TabViewItem.CloseButton.Foreground _when_ interacting with the tab\r\n             L\"TabViewItemHeaderPressedCloseButtonForeground\",\r\n             L\"TabViewItemHeaderPointerOverCloseButtonForeground\",\r\n             L\"TabViewItemHeaderSelectedCloseButtonForeground\",\r\n+\r\n+            // TabViewItem.CloseButton.Background (aka X button)\r\n+            L\"TabViewItemHeaderCloseButtonBackground\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPressed\",\r\n             L\"TabViewItemHeaderCloseButtonBackgroundPointerOver\",\r\n+\r\n+            // A few miscellaneous resources that WinUI said may be removed in the future\r\n             L\"TabViewButtonForegroundActiveTab\",\r\n             L\"TabViewButtonForegroundPressed\",\r\n-            L\"TabViewButtonForegroundPointerOver\"\r\n+            L\"TabViewButtonForegroundPointerOver\",\r\n+\r\n+            // TabViewItem.CloseButton.Border: in HC mode, the border makes the button more clearly visible\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPressed\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushPointerOver\",\r\n+            L\"TabViewItemHeaderCloseButtonBorderBrushSelected\"\r\n         };\r\n \r\n-        const auto& tabItemResources{ TabViewItem().Resources() };\r\n+        const auto& tabItemThemeResources{ TabViewItem().Resources().ThemeDictionaries() };\r\n \r\n         // simply clear any of the colors in the tab's dict\r\n         for (const auto& keyString : keys)\r\n         {\r\n-            auto key = winrt::box_value(keyString);\r\n-            if (tabItemResources.HasKey(key))\r\n+            const auto key = winrt::box_value(keyString);\r\n+            for (const auto& [_, v] : tabItemThemeResources)\r\n             {\r\n-                tabItemResources.Remove(key);\r\n+                const auto& themeDictionary = v.as<ResourceDictionary>();\r\n+                themeDictionary.Remove(key);\r\n             }\r\n         }\r\n \r\n", "instance_id": "microsoft__terminal-18109", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: colored tabs in Windows Terminal lose their color when unfocused in high contrast mode. It provides specific steps to reproduce the issue, the expected behavior (tabs should retain color), and the actual behavior (color reverts to high contrast until focused again). Additionally, it includes relevant context such as the Windows Terminal version and build number. However, it lacks explicit mention of edge cases or specific constraints (e.g., whether this applies to all high contrast themes or specific ones, or if there are performance considerations). While the goal is clear, these minor missing details prevent it from being comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls into the medium range (0.4-0.6) due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`TabBase.cpp`) and a specific section related to tab styling and theme resources. However, the changes are substantial, involving a complete overhaul of how theme dictionaries (Light, Dark, HighContrast) are managed and applied, with specific adjustments for high contrast mode. This requires understanding WinUI resource management, theme dictionaries, and the interaction between different visual states of tabs (selected, deselected, hovered, etc.), which introduces moderate complexity. Second, the technical concepts involved include C++ with WinRT, familiarity with Windows UI frameworks (specifically WinUI and TabViewItem resources), and handling theme-specific logic, which are non-trivial but not extremely advanced. Third, while the problem statement does not explicitly mention edge cases, the code changes suggest considerations for high contrast mode-specific behaviors (e.g., border visibility for close buttons), indicating some implicit edge case handling. Finally, the changes do not appear to impact the broader system architecture but require careful attention to ensure visual consistency across themes. Given the need to understand multiple concepts and implement detailed modifications, but without requiring deep architectural changes or advanced domain knowledge, a difficulty score of 0.55 seems appropriate, placing it in the medium category with a slight lean towards the higher end due to the UI framework complexity.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Resizing the font while playing a sixel video can trigger a crash\n### Windows Terminal version\n\n1.22.2362.0\n\n### Windows build number\n\n10.0.19045.4894\n\n### Other Software\n\n[img2sixel](https://github.com/saitoha/libsixel)\n\n### Steps to reproduce\n\n1. Start a WSL shell in Windows Terminal.\r\n2. Get some content in the buffer so that resizing will force a reflow.\r\n3. View an animated gif with `img2sixel filename.gif` so you've got some sixel content being constantly refreshed.\r\n4. Resize the font with the mouse scroll wheel, so you're rapidly growing and shrinking the animation. Make sure the image sometimes grows larger than the viewport.\n\n### Expected Behavior\n\nThe animation should continue to play without any problems, aside from the fact that some partial frames will be pushed into the scrollback buffer when the image becomes too large to fit the height of the page.\n\n### Actual Behavior\n\nThe terminal eventually crashes.\r\n\r\nThis doesn't happen in OpenConsole, but that is assumedly because it resizes the window when you change the font size, so the text dimensions never change, and thus no reflow is required. Although now that I say that, I suspect you could possibly cause it to crash just by resizing the window in a way that triggers a reflow.\n", "patch": "diff --git a/src/terminal/adapter/SixelParser.cpp b/src/terminal/adapter/SixelParser.cpp\nindex f9dbdf6603a..979dd42371c 100644\n--- a/src/terminal/adapter/SixelParser.cpp\n+++ b/src/terminal/adapter/SixelParser.cpp\n@@ -715,8 +715,16 @@ void SixelParser::_eraseImageBufferRows(const int rowCount, const til::CoordType\n     const auto pixelCount = rowCount * _cellSize.height;\r\n     const auto bufferOffset = rowOffset * _cellSize.height * _imageMaxWidth;\r\n     const auto bufferOffsetEnd = bufferOffset + pixelCount * _imageMaxWidth;\r\n-    _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n-    _imageCursor.y -= pixelCount;\r\n+    if (static_cast<size_t>(bufferOffsetEnd) >= _imageBuffer.size()) [[unlikely]]\r\n+    {\r\n+        _imageBuffer.clear();\r\n+        _imageCursor.y = 0;\r\n+    }\r\n+    else\r\n+    {\r\n+        _imageBuffer.erase(_imageBuffer.begin() + bufferOffset, _imageBuffer.begin() + bufferOffsetEnd);\r\n+        _imageCursor.y -= pixelCount;\r\n+    }\r\n }\r\n \r\n void SixelParser::_maybeFlushImageBuffer(const bool endOfSequence)\r\n", "instance_id": "microsoft__terminal-17951", "clarity": 2, "difficulty": 0.5, "clarity_explanation": "The problem statement is mostly clear in describing the issue: resizing the font while playing a sixel video in Windows Terminal causes a crash. It provides specific steps to reproduce the issue, including the environment (WSL shell, Windows Terminal version, and external software), the actions to trigger the crash (font resizing during sixel animation playback), and the expected versus actual behavior. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define the root cause of the crash (though it hints at reflow issues), nor does it specify constraints or edge cases beyond the general scenario of resizing. Additionally, there are no examples of specific inputs (e.g., particular GIF files or resizing patterns) that might consistently trigger the issue. While the context is sufficient to understand the problem, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code change is relatively small, confined to a single file (`SixelParser.cpp`) and a specific function related to image buffer management. The diff shows a targeted modification to handle a potential buffer overflow or invalid erase operation by adding a bounds check and clearing the buffer if necessary. This suggests a focused bug fix rather than a broad architectural change. However, the problem requires understanding specific technical concepts, such as sixel graphics parsing, buffer management, and the interaction between terminal resizing and content reflow. These concepts are moderately complex, especially since sixel graphics are a niche domain within terminal emulation. Additionally, the crash likely involves edge cases related to buffer size mismatches during rapid resizing, which the code change addresses by introducing a safety check. While the fix itself is straightforward (a conditional check and buffer clearing), identifying the root cause and ensuring the solution handles all edge cases (e.g., partial frame rendering, scrollback buffer interactions) requires a deeper understanding of the terminal's rendering logic. There are no significant performance or system-level considerations apparent in the change, and the impact is localized, which keeps the difficulty from being higher. Overall, this problem balances moderate conceptual complexity with a contained scope, warranting a score of 0.50.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Low reliability of VT replies\n### Windows Terminal version\r\n\r\nLatest source\r\n\r\n### Windows build number\r\n\r\n10.0.19045.4780\r\n\r\n### Other Software\r\n\r\nNo\r\n\r\n### Steps to reproduce\r\n\r\nI want to query some terminal state, in particular the latest and greatest palette (#17729).\r\nTo do so, I build a bunch of those `\"\\x1b]4;N;?\\x1b\\\\\"`, send them in one go and wait for the reply.\r\nSince I want to support not only the latest nightlies and do not want the older versions to deadlock on unknown queries, I prepend and append another query, the one that even prehistoric versions understand: `\"\\x1b[c\"`.\r\nIf there is something between those DA replies, it must be the one I need.\r\nIf there are only two DA replies, then it is probably not supported.\r\n\r\nThis approach works flawlessly in OpenConsole.\r\nIn WT, however, not so much: way, way too often random parts of the reply are simply missing.\r\n\r\n1. Compile the code:\r\n    \r\n<details>\r\n<summary>Code</summary>\r\n  \r\n```C++\r\n#ifndef _CRT_SECURE_NO_WARNINGS\r\n#define _CRT_SECURE_NO_WARNINGS\r\n#endif\r\n\r\n#ifndef _UNICODE\r\n#define _UNICODE\r\n#endif\r\n\r\n#ifndef UNICODE\r\n#define UNICODE\r\n#endif\r\n\r\n#include <algorithm>\r\n#include <format>\r\n#include <exception>\r\n#include <iostream>\r\n#include <optional>\r\n#include <ranges>\r\n#include <string>\r\n#include <string_view>\r\n\r\n#include <string.h>\r\n\r\n#include <windows.h>\r\n\r\nusing namespace std::literals;\r\n\r\nauto win32_error()\r\n{\r\n\treturn std::runtime_error(std::format(\"Error 0x{:08X}, look it up\"sv, GetLastError()));\r\n};\r\n\r\nauto invalid_response()\r\n{\r\n\treturn std::runtime_error(\"Invalid response\");\r\n}\r\n\r\nauto invalid_response(const size_t Index)\r\n{\r\n\treturn std::runtime_error(std::format(\"Invalid response at #{}\"sv, Index));\r\n}\r\n\r\nauto printable(const std::wstring_view Str)\r\n{\r\n\tstd::wstring Printable;\r\n\tstd::ranges::transform(Str, std::back_inserter(Printable), [](wchar_t Char){ return Char < L' ' ? Char + L'\\u2400' : Char; });\r\n\treturn Printable;\r\n}\r\n\r\nvoid write(const std::wstring_view Str)\r\n{\r\n\tDWORD Written;\r\n\tif (!WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), Str.data(), static_cast<DWORD>(Str.size()), &Written, {}))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nvoid write(const std::string_view Str)\r\n{\r\n\twrite(std::wstring(Str.begin(), Str.end()));\r\n}\r\n\r\nstd::wstring query(const std::wstring& Command)\r\n{\r\n\tconst auto Dummy = L\"\\x1b[c\"s;\r\n\r\n\twrite(Dummy + Command + Dummy);\r\n\r\n\t// Sleep(1);\r\n\r\n\tstd::wstring Response;\r\n\r\n\tstd::optional<size_t>\r\n\t\tFirstTokenPrefixPos,\r\n\t\tFirstTokenSuffixPos,\r\n\t\tSecondTokenPrefixPos,\r\n\t\tSecondTokenSuffixPos;\r\n\r\n\tconst auto\r\n\t\tTokenPrefix = L\"\\x1b[?\"sv,\r\n\t\tTokenSuffix = L\"c\"sv;\r\n\r\n\twhile (!SecondTokenSuffixPos)\r\n\t{\r\n\t\twchar_t ResponseBuffer[8192];\r\n\t\tDWORD ResponseSize;\r\n\r\n\t\tif (!ReadConsole(GetStdHandle(STD_INPUT_HANDLE), ResponseBuffer, ARRAYSIZE(ResponseBuffer),  &ResponseSize, {}))\r\n\t\t\tthrow win32_error();\r\n\r\n\t\tResponse.append(ResponseBuffer, ResponseSize);\r\n\r\n\t\tif (!FirstTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix); Pos != Response.npos)\r\n\t\t\t\tFirstTokenPrefixPos = Pos;\r\n\r\n\t\tif (FirstTokenPrefixPos && !FirstTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *FirstTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tFirstTokenSuffixPos = Pos;\r\n\r\n\t\tif (FirstTokenSuffixPos && !SecondTokenPrefixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenPrefix, *FirstTokenSuffixPos + TokenSuffix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenPrefixPos = Pos;\r\n\r\n\t\tif (SecondTokenPrefixPos && !SecondTokenSuffixPos)\r\n\t\t\tif (const auto Pos = Response.find(TokenSuffix, *SecondTokenPrefixPos + TokenPrefix.size()); Pos != Response.npos)\r\n\t\t\t\tSecondTokenSuffixPos = Pos;\r\n\t}\r\n\r\n\tResponse.resize(*SecondTokenPrefixPos);\r\n\tResponse.erase(0, *FirstTokenSuffixPos + TokenSuffix.size());\r\n\r\n\tif (Response.empty())\r\n\t\tthrow std::runtime_error(\"Query is not supported\"s);\r\n\r\n\treturn Response;\r\n}\r\n\r\nvoid set_modes()\r\n{\r\n\tconst auto\r\n\t\tIn = GetStdHandle(STD_INPUT_HANDLE),\r\n\t\tOut = GetStdHandle(STD_OUTPUT_HANDLE);\r\n\r\n\tDWORD InMode;\r\n\tif (!GetConsoleMode(In, &InMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(In, (InMode & ~(ENABLE_LINE_INPUT | ENABLE_ECHO_INPUT | ENABLE_QUICK_EDIT_MODE)) | ENABLE_MOUSE_INPUT | ENABLE_EXTENDED_FLAGS | ENABLE_VIRTUAL_TERMINAL_INPUT))\r\n\t\tthrow win32_error();\r\n\r\n\tDWORD OutMode;\r\n\tif (!GetConsoleMode(Out, &OutMode))\r\n\t\tthrow win32_error();\r\n\r\n\tif (!SetConsoleMode(Out, OutMode | ENABLE_PROCESSED_OUTPUT | ENABLE_VIRTUAL_TERMINAL_PROCESSING))\r\n\t\tthrow win32_error();\r\n}\r\n\r\nint main()\r\n{\r\n\ttry\r\n\t{\r\n\t\tset_modes();\r\n\r\n\t\tstd::wstring Str;\r\n\r\n\t\tfor (size_t i = 0; i != 256; ++i)\r\n\t\t\tstd::format_to(std::back_inserter(Str), L\"\\x1b]4;{};?\\x1b\\\\\"sv, i);\r\n\r\n\t\tfor (;;)\r\n\t\t{\r\n\t\t\tconst auto ReplyData = query(Str);\r\n\r\n\t\t\tstd::wstring_view Reply(ReplyData);\r\n\r\n\t\t\tif (!Reply.ends_with(L\"\\\\\"sv))\r\n\t\t\t\tthrow invalid_response();\r\n\r\n\t\t\tReply.remove_suffix(1);\r\n\r\n\t\t\tsize_t Index = 0;\r\n\r\n\t\t\tfor (const auto& Part: std::views::split(Reply, L\"\\\\\"sv))\r\n\t\t\t{\r\n\t\t\t\tstd::wstring_view ColorStr(Part.begin(), Part.end());\r\n\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\"\\x1b]4;\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\"\\x1b]4;\"sv.size());\r\n\r\n\t\t\t\t\twchar_t* Ptr;\r\n\t\t\t\t\tconst auto ReportedIndex = std::wcstol(ColorStr.data(), &Ptr, 10);\r\n\r\n\t\t\t\t\tif (Ptr == ColorStr.data())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tif (ReportedIndex != Index)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(Ptr - ColorStr.data());\r\n\r\n\t\t\t\t\tconst auto End = ColorStr.find(L\"\\x1b\"sv);\r\n\t\t\t\t\tif (End == ColorStr.npos)\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_suffix(ColorStr.size() - End);\r\n\r\n\t\t\t\t\tif (!ColorStr.starts_with(L\";rgb:\"sv))\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\r\n\t\t\t\t\tColorStr.remove_prefix(L\";rgb:\"sv.size());\r\n\r\n\t\t\t\t\tif (ColorStr.size() != L\"ffff/ffff/ffff\"sv.size())\r\n\t\t\t\t\t\tthrow invalid_response(Index);\r\n\t\t\t\t}\r\n\t\t\t\tcatch (const std::runtime_error& e)\r\n\t\t\t\t{\r\n\t\t\t\t\tBeep(500, 200);\r\n\r\n\t\t\t\t\twrite(e.what());\r\n\t\t\t\t\twrite(L\": \"sv);\r\n\t\t\t\t\twrite(printable(ColorStr));\r\n\t\t\t\t\twrite(L\"\\n\"sv);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t++Index;\r\n\t\t\t}\r\n\r\n\t\t\tstd::wcout << L\"Everything is OK\"sv << std::endl;\r\n\r\n\t\t}\r\n\t}\r\n\tcatch (const std::exception& e)\r\n\t{\r\n\t\tstd::cerr << e.what() << std::endl;\r\n\t}\r\n}\r\n```\r\n</details>\r\n\r\n2. Run it in WT.\r\n \r\n\r\n\r\n### Expected Behavior\r\n\r\nThe program should print \"Everything is OK\" in a loop indefinitely and nothing else:\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\n...and so on.\r\n```\r\n\r\n### Actual Behavior\r\n\r\nThe program prints \"Everything is OK\" a few times, then it detects errors due to missing bits in the reply, e.g.\r\n```\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nEverything is OK\r\nInvalid response at #234: c/1c1c␛\r\nEverything is OK\r\n```\r\n\r\nEventually it deadlocks in `ReadConsole`.\r\n\r\nAdding a delay between sending the query and reading the reply improves the situation dramatically, but still not to 100% and it does not feel like the right thing to do: fixing issues with `Sleep(N)` never works in the long term.\r\n\r\nSplitting it to smaller queries also helps, but again, it is guesswork.\r\nOverall it is about 2700 characters to send and about 7000 to receive. It does not look like something humongous by modern standards.\r\n\r\nMoving the mouse or pressing keyboard keys noticeably increases the error rate. Again, only in WT.\r\n\n", "patch": "diff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex d8d975f667c..357b43c1aa1 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -98,7 +98,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         Connection(connection);\r\n \r\n         _terminal->SetWriteInputCallback([this](std::wstring_view wstr) {\r\n-            _sendInputToConnection(wstr);\r\n+            _pendingResponses.append(wstr);\r\n         });\r\n \r\n         // GH#8969: pre-seed working directory to prevent potential races\r\n@@ -419,6 +419,17 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // Return Value:\r\n     // - <none>\r\n     void ControlCore::_sendInputToConnection(std::wstring_view wstr)\r\n+    {\r\n+        _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+    }\r\n+\r\n+    // Method Description:\r\n+    // - Writes the given sequence as input to the active terminal connection,\r\n+    // Arguments:\r\n+    // - wstr: the string of characters to write to the terminal connection.\r\n+    // Return Value:\r\n+    // - <none>\r\n+    void ControlCore::SendInput(const std::wstring_view wstr)\r\n     {\r\n         if (wstr.empty())\r\n         {\r\n@@ -435,21 +446,10 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         else\r\n         {\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(wstr));\r\n+            _sendInputToConnection(wstr);\r\n         }\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Writes the given sequence as input to the active terminal connection,\r\n-    // Arguments:\r\n-    // - wstr: the string of characters to write to the terminal connection.\r\n-    // Return Value:\r\n-    // - <none>\r\n-    void ControlCore::SendInput(const std::wstring_view wstr)\r\n-    {\r\n-        _sendInputToConnection(wstr);\r\n-    }\r\n-\r\n     bool ControlCore::SendCharEvent(const wchar_t ch,\r\n                                     const WORD scanCode,\r\n                                     const ::Microsoft::Terminal::Core::ControlKeyStates modifiers)\r\n@@ -485,7 +485,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -643,7 +643,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -662,7 +662,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out)\r\n         {\r\n-            _sendInputToConnection(*out);\r\n+            SendInput(*out);\r\n             return true;\r\n         }\r\n         return false;\r\n@@ -1412,7 +1412,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n \r\n         // It's important to not hold the terminal lock while calling this function as sending the data may take a long time.\r\n-        _sendInputToConnection(filtered);\r\n+        SendInput(filtered);\r\n \r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->ClearSelection();\r\n@@ -2107,7 +2107,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // Sending input requires that we're unlocked, because\r\n                     // writing the input pipe may block indefinitely.\r\n                     const auto suspension = _terminal->SuspendLock();\r\n-                    _sendInputToConnection(buffer);\r\n+                    SendInput(buffer);\r\n                 }\r\n             }\r\n         }\r\n@@ -2164,6 +2164,12 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                 _terminal->Write(hstr);\r\n             }\r\n \r\n+            if (!_pendingResponses.empty())\r\n+            {\r\n+                _sendInputToConnection(_pendingResponses);\r\n+                _pendingResponses.clear();\r\n+            }\r\n+\r\n             // Start the throttled update of where our hyperlinks are.\r\n             const auto shared = _shared.lock_shared();\r\n             if (shared->outputIdle)\r\n@@ -2480,9 +2486,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         }\r\n         if (out && !out->empty())\r\n         {\r\n-            // _sendInputToConnection() asserts that we aren't in focus mode,\r\n-            // but window focus events are always fine to send.\r\n-            _connection.WriteInput(winrt_wstring_to_array_view(*out));\r\n+            _sendInputToConnection(*out);\r\n         }\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 938d048243b..57484c0b7b7 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -319,6 +319,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         winrt::com_ptr<ControlSettings> _settings{ nullptr };\r\n \r\n         std::shared_ptr<::Microsoft::Terminal::Core::Terminal> _terminal{ nullptr };\r\n+        std::wstring _pendingResponses;\r\n \r\n         // NOTE: _renderEngine must be ordered before _renderer.\r\n         //\r\ndiff --git a/src/cascadia/TerminalCore/TerminalApi.cpp b/src/cascadia/TerminalCore/TerminalApi.cpp\nindex 26daf24e5d2..82e06b03d4a 100644\n--- a/src/cascadia/TerminalCore/TerminalApi.cpp\n+++ b/src/cascadia/TerminalCore/TerminalApi.cpp\n@@ -24,7 +24,6 @@ void Terminal::ReturnResponse(const std::wstring_view response)\n {\r\n     if (_pfnWriteInput && !response.empty())\r\n     {\r\n-        const auto suspension = _readWriteLock.suspend();\r\n         _pfnWriteInput(response);\r\n     }\r\n }\r\n", "instance_id": "microsoft__terminal-17786", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue of low reliability of VT (Virtual Terminal) replies in Windows Terminal (WT). It provides a detailed context about querying terminal state (specifically palette data) using escape sequences and highlights the discrepancy in behavior between WT and OpenConsole. The expected and actual behaviors are well-documented with examples of output, and the steps to reproduce the issue are provided with a complete C++ code snippet. Additionally, the statement mentions factors like the impact of mouse/keyboard input on error rates and the partial effectiveness of workarounds like delays or smaller queries. However, there are minor ambiguities: the problem does not explicitly define the exact conditions under which replies are missing (e.g., specific terminal settings or workload conditions), nor does it fully clarify the desired fix (e.g., whether the goal is to ensure 100% reliability or just reduce error frequency). Edge cases, such as behavior under high load or specific terminal configurations, are not specified. Thus, while the problem is valid and mostly clear, these missing details prevent it from being comprehensive.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.65, placing this problem in the \"Hard\" category, due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes provided affect multiple files (`ControlCore.cpp`, `ControlCore.h`, and `TerminalApi.cpp`) within the Windows Terminal codebase, which is a complex, multi-layered system. The modifications involve altering how input and responses are handled, specifically by introducing a buffering mechanism (`_pendingResponses`) and adjusting the flow of data through the terminal's input/output pipeline. While the changes are not extensive in terms of lines of code, they impact critical components related to terminal input processing and response handling, requiring a good understanding of the system's architecture to avoid introducing new issues.\n\n2. **Number of Technical Concepts**: Solving this problem requires familiarity with several technical concepts, including Windows Terminal's internal architecture (e.g., how `ControlCore` and `TerminalApi` interact), Virtual Terminal (VT) escape sequence handling, asynchronous input/output processing, and thread safety (as seen in the removal of a lock suspension in `TerminalApi.cpp`). Additionally, knowledge of Windows API calls (e.g., `ReadConsole`, `WriteConsole`) and their behavior under different conditions is necessary to understand the root cause of the missing replies. These concepts are moderately complex and require experience with low-level terminal emulation and system programming.\n\n3. **Potential Edge Cases and Error Handling**: The problem statement highlights that replies are often missing, especially under conditions like mouse or keyboard input, suggesting that race conditions or buffering issues might be at play. The code changes attempt to address this by buffering responses (`_pendingResponses`) and ensuring they are sent at the right time, but this introduces potential new edge cases, such as buffer overflow, timing issues, or interactions with other terminal events. Error handling logic in the modified code is minimal, but ensuring reliability across all scenarios (e.g., high input rates, different terminal configurations) adds to the complexity.\n\n4. **Overall Complexity**: The issue lies in a nuanced area of terminal emulation, where reliability of VT replies depends on subtle timing and synchronization issues. While the provided code changes offer a potential solution, validating and refining this fix requires deep debugging skills and an understanding of the broader impact on terminal behavior. The problem does not reach the \"Very Hard\" category (0.8-1.0) because it does not involve advanced domain-specific knowledge (e.g., distributed systems or novel algorithms), but it is still challenging due to the need to navigate a complex codebase and ensure robust behavior under varied conditions.\n\nIn summary, this problem requires a solid grasp of terminal internals, careful handling of input/output synchronization, and consideration of edge cases, making it a hard but not insurmountable challenge for an experienced developer.\n", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Add color scheme for EGA (the \"16 color ANSI\" palette)\n# Description of the new feature/enhancement\r\nThe 16 color standard EGA palette used on PCs back in the day was a very defining look (and still in use today for the correct look of DOS CLI/TUI programs and ANSI art etc), and I think it should definitely be a default colorscheme that comes with Windows Terminal.\r\n\r\n# Proposed technical implementation details (optional)\r\n\r\nAdd a default color scheme (call it \"EGA\" or \"ANSI\" or \"MS-DOS\" or whatever):\r\n\r\n```json\r\n{\r\n    \"background\": \"#000000\",\r\n    \"black\": \"#000000\",\r\n    \"blue\": \"#0000AA\",\r\n    \"brightBlack\": \"#555555\",\r\n    \"brightBlue\": \"#5555FF\",\r\n    \"brightCyan\": \"#55FFFF\",\r\n    \"brightGreen\": \"#55FF55\",\r\n    \"brightPurple\": \"#FF55FF\",\r\n    \"brightRed\": \"#FF5555\",\r\n    \"brightWhite\": \"#FFFFFF\",\r\n    \"brightYellow\": \"#FFFF55\",\r\n    \"cursorColor\": \"#00AA00\",\r\n    \"cyan\": \"#00AAAA\",\r\n    \"foreground\": \"#AAAAAA\",\r\n    \"green\": \"#00AA00\",\r\n    \"name\": \"16 Color ANSI\",\r\n    \"purple\": \"#AA00AA\",\r\n    \"red\": \"#AA0000\",\r\n    \"selectionBackground\": \"#FFFFFF\",\r\n    \"white\": \"#AAAAAA\",\r\n    \"yellow\": \"#AA5500\"\r\n}\r\n```\n", "patch": "diff --git a/src/cascadia/TerminalSettingsModel/defaults.json b/src/cascadia/TerminalSettingsModel/defaults.json\nindex 360f37afaad..ae8ed369ff6 100644\n--- a/src/cascadia/TerminalSettingsModel/defaults.json\n+++ b/src/cascadia/TerminalSettingsModel/defaults.json\n@@ -281,6 +281,75 @@\n             \"brightPurple\": \"#AD7FA8\",\r\n             \"brightCyan\": \"#34E2E2\",\r\n             \"brightWhite\": \"#EEEEEC\"\r\n+        },\r\n+        {\r\n+            \"name\": \"Dark+\",\r\n+            \"foreground\": \"#cccccc\",\r\n+            \"background\": \"#1e1e1e\",\r\n+            \"cursorColor\": \"#808080\",\r\n+            \"selectionBackground\": \"#ffffff\",\r\n+            \"black\": \"#000000\",\r\n+            \"red\": \"#cd3131\",\r\n+            \"green\": \"#0dbc79\",\r\n+            \"yellow\": \"#e5e510\",\r\n+            \"blue\": \"#2472c8\",\r\n+            \"purple\": \"#bc3fbc\",\r\n+            \"cyan\": \"#11a8cd\",\r\n+            \"white\": \"#e5e5e5\",\r\n+            \"brightBlack\": \"#666666\",\r\n+            \"brightRed\": \"#f14c4c\",\r\n+            \"brightGreen\": \"#23d18b\",\r\n+            \"brightYellow\": \"#f5f543\",\r\n+            \"brightBlue\": \"#3b8eea\",\r\n+            \"brightPurple\": \"#d670d6\",\r\n+            \"brightCyan\": \"#29b8db\",\r\n+            \"brightWhite\": \"#e5e5e5\"\r\n+        },\r\n+        {\r\n+            \"background\": \"#000000\",\r\n+            \"black\": \"#000000\",\r\n+            \"blue\": \"#0000AA\",\r\n+            \"brightBlack\": \"#555555\",\r\n+            \"brightBlue\": \"#5555FF\",\r\n+            \"brightCyan\": \"#55FFFF\",\r\n+            \"brightGreen\": \"#55FF55\",\r\n+            \"brightPurple\": \"#FF55FF\",\r\n+            \"brightRed\": \"#FF5555\",\r\n+            \"brightWhite\": \"#FFFFFF\",\r\n+            \"brightYellow\": \"#FFFF55\",\r\n+            \"cursorColor\": \"#00AA00\",\r\n+            \"cyan\": \"#00AAAA\",\r\n+            \"foreground\": \"#AAAAAA\",\r\n+            \"green\": \"#00AA00\",\r\n+            \"name\": \"CGA\",\r\n+            \"purple\": \"#AA00AA\",\r\n+            \"red\": \"#AA0000\",\r\n+            \"selectionBackground\": \"#FFFFFF\",\r\n+            \"white\": \"#AAAAAA\",\r\n+            \"yellow\": \"#AA5500\"\r\n+        },\r\n+        {\r\n+            \"background\": \"#000000\",\r\n+            \"black\": \"#000000\",\r\n+            \"blue\": \"#0000AA\",\r\n+            \"brightBlack\": \"#555555\",\r\n+            \"brightBlue\": \"#5555FF\",\r\n+            \"brightCyan\": \"#55FFFF\",\r\n+            \"brightGreen\": \"#55FF55\",\r\n+            \"brightPurple\": \"#FF55FF\",\r\n+            \"brightRed\": \"#FF5555\",\r\n+            \"brightWhite\": \"#FFFFFF\",\r\n+            \"brightYellow\": \"#FFFF55\",\r\n+            \"cursorColor\": \"#00AA00\",\r\n+            \"cyan\": \"#00AAAA\",\r\n+            \"foreground\": \"#AAAAAA\",\r\n+            \"green\": \"#00AA00\",\r\n+            \"name\": \"IBM 5153\",\r\n+            \"purple\": \"#AA00AA\",\r\n+            \"red\": \"#AA0000\",\r\n+            \"selectionBackground\": \"#FFFFFF\",\r\n+            \"white\": \"#AAAAAA\",\r\n+            \"yellow\": \"#C47E00\"\r\n         }\r\n     ],\r\n     \"themes\": [\r\n", "instance_id": "microsoft__terminal-16953", "clarity": 2, "difficulty": 0.1, "clarity_explanation": "The problem statement is mostly clear in its intent to add a new color scheme for the EGA (16 color ANSI palette) to the Windows Terminal. The goal is well-defined, and the proposed implementation is provided in the form of a JSON configuration for the color scheme. However, there are minor ambiguities and missing details. For instance, the problem statement suggests naming the scheme \"EGA,\" \"ANSI,\" or \"MS-DOS,\" but the code changes use \"CGA\" and \"IBM 5153,\" which introduces a discrepancy. Additionally, there is no mention of whether this addition requires any specific validation, compatibility checks with existing schemes, or handling of potential conflicts. Edge cases, such as how the terminal should behave if the color scheme is not supported by certain environments, are not addressed. Overall, while the core requirement is clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this task is very low, as it involves a straightforward addition of new color scheme entries to a JSON configuration file within the codebase. The scope of the code change is minimal, confined to a single file (`defaults.json`), and does not require understanding complex interactions between different parts of the codebase or modifying the system's architecture. The amount of code change is small, essentially adding static data with no logic or computation involved. No advanced programming concepts, algorithms, or domain-specific knowledge are required beyond basic familiarity with JSON format and the structure of the configuration file. There are no edge cases or error handling requirements mentioned in the problem statement, and the code changes do not introduce any logic that would necessitate such considerations. This task falls into the \"very easy\" category, as it is a simple modification akin to updating constants or adding predefined data.", "clarity_label": 1, "difficulty_label": 1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Pass vertex and index versions as arguments instead of having them as globals.\nHaving gEncodeVertexVersion and gEncodeIndexVersion as globals makes the meshoptimizer library difficult to use correctly in a multithreaded program, when some threads may be want to write with different versions.\n", "patch": "diff --git a/README.md b/README.md\nindex 9ea6ed923..985d14eff 100644\n--- a/README.md\n+++ b/README.md\n@@ -253,7 +253,7 @@ For optimal compression results, the values must be quantized to small integers.\n For single-precision floating-point data, it's recommended to use `meshopt_quantizeFloat` to remove entropy from the lower bits of the mantissa. Due to current limitations of the codec, the bit count needs to be 15 (23-8) for good results (7 can be used for more extreme compression).\n For normal or tangent vectors, using octahedral encoding is recommended over three components as it reduces redundancy. Similarly to other quantized values, consider using 10-12 bits per component instead of 16.\n \n-When data is bit packed, using v1 vertex codec (via `meshopt_encodeVertexVersion(1)`) and specifying compression level 3 (`meshopt_encodeVertexBufferLevel`) can improve the compression further by redistributing bits between components. Note that v1 vertex codec is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n+When data is bit packed, using v1 vertex codec and specifying compression level 3 (`meshopt_encodeVertexBufferLevel` with level 3 and version 1) can improve the compression further by redistributing bits between components. Note that v1 vertex codec (`meshopt_encodeVertexVersion(1)`) is recommended regardless, as it improves compression ratios and decoding performance even absent bit packing.\n \n To further leverage the inherent structure of some data, the preparation stage can use filters that encode and decode the data in a lossy manner. This is similar to quantization but can be used without having to change the shader code. After decoding, the filter transformation needs to be reversed. For native game engine pipelines, it is usually more optimal to carefully prequantize and pretransform the vertex data, but sometimes (for example when serializing data in glTF format) this is not a practical option and filters are more practical. This library provides three filters:\n \n@@ -618,7 +618,7 @@ Currently, the following APIs are experimental, with the functions marked with `\n - `meshopt_buildMeshletsFlex`\n - `meshopt_buildMeshletsSplit`\n - `meshopt_computeSphereBounds`*\n-- `meshopt_encodeVertexBufferLevel`*\n+- `meshopt_encodeVertexBufferLevel`\n - `meshopt_generateProvokingIndexBuffer`*\n - `meshopt_generateVertexRemapCustom`*\n - `meshopt_partitionClusters`\ndiff --git a/demo/main.cpp b/demo/main.cpp\nindex a98c69461..a06a54f04 100644\n--- a/demo/main.cpp\n+++ b/demo/main.cpp\n@@ -893,7 +893,7 @@ void encodeVertex(const Mesh& mesh, const char* pvn, int level = 2)\n \tdouble start = timestamp();\n \n \tstd::vector<unsigned char> vbuf(meshopt_encodeVertexBufferBound(mesh.vertices.size(), sizeof(PV)));\n-\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level));\n+\tvbuf.resize(meshopt_encodeVertexBufferLevel(&vbuf[0], vbuf.size(), &pv[0], mesh.vertices.size(), sizeof(PV), level, -1));\n \n \tdouble middle = timestamp();\n \ndiff --git a/src/meshoptimizer.h b/src/meshoptimizer.h\nindex 84ba1a7ab..ef6c4a93f 100644\n--- a/src/meshoptimizer.h\n+++ b/src/meshoptimizer.h\n@@ -304,8 +304,9 @@ MESHOPTIMIZER_API size_t meshopt_encodeVertexBufferBound(size_t vertex_count, si\n  * The default compression level implied by meshopt_encodeVertexBuffer is 2.\n  *\n  * level should be in the range [0, 3] with 0 being the fastest and 3 being the slowest and producing the best compression ratio.\n+ * version should be -1 to use the default version (specified via meshopt_encodeVertexVersion), or 0/1 to override the version; per above, level won't take effect if version is 0.\n  */\n-MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level);\n+MESHOPTIMIZER_EXPERIMENTAL size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version);\n \n /**\n  * Set vertex encoder format version\ndiff --git a/src/vertexcodec.cpp b/src/vertexcodec.cpp\nindex 53cf9d753..847589b3d 100644\n--- a/src/vertexcodec.cpp\n+++ b/src/vertexcodec.cpp\n@@ -1643,13 +1643,16 @@ static unsigned int cpuid = getCpuFeatures();\n \n } // namespace meshopt\n \n-size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level)\n+size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size, int level, int version)\n {\n \tusing namespace meshopt;\n \n \tassert(vertex_size > 0 && vertex_size <= 256);\n \tassert(vertex_size % 4 == 0);\n \tassert(level >= 0 && level <= 9); // only a subset of this range is used right now\n+\tassert(version < 0 || unsigned(version) <= kDecodeVertexVersion);\n+\n+\tversion = version < 0 ? gEncodeVertexVersion : version;\n \n #if TRACE\n \tmemset(vertexstats, 0, sizeof(vertexstats));\n@@ -1663,8 +1666,6 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \tif (size_t(data_end - data) < 1)\n \t\treturn 0;\n \n-\tint version = gEncodeVertexVersion;\n-\n \t*data++ = (unsigned char)(kVertexHeader | version);\n \n \tunsigned char first_vertex[256] = {};\n@@ -1777,7 +1778,7 @@ size_t meshopt_encodeVertexBufferLevel(unsigned char* buffer, size_t buffer_size\n \n size_t meshopt_encodeVertexBuffer(unsigned char* buffer, size_t buffer_size, const void* vertices, size_t vertex_count, size_t vertex_size)\n {\n-\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel);\n+\treturn meshopt_encodeVertexBufferLevel(buffer, buffer_size, vertices, vertex_count, vertex_size, meshopt::kEncodeDefaultLevel, meshopt::gEncodeVertexVersion);\n }\n \n size_t meshopt_encodeVertexBufferBound(size_t vertex_count, size_t vertex_size)\ndiff --git a/tools/codecfuzz.cpp b/tools/codecfuzz.cpp\nindex 89bce2409..4992857e3 100644\n--- a/tools/codecfuzz.cpp\n+++ b/tools/codecfuzz.cpp\n@@ -26,12 +26,12 @@ void fuzzRoundtrip(const uint8_t* data, size_t size, size_t stride, int level)\n \tvoid* decoded = malloc(count * stride);\n \tassert(encoded && decoded);\n \n-\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level);\n+\tsize_t res = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded), bound, data, count, stride, level, -1);\n \tassert(res > 0 && res <= bound);\n \n \t// encode again at the boundary to check for memory safety\n \t// this should produce the same output because encoder is deterministic\n-\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level);\n+\tsize_t rese = meshopt_encodeVertexBufferLevel(static_cast<unsigned char*>(encoded) + bound - res, res, data, count, stride, level, -1);\n \tassert(rese == res);\n \n \tint rc = meshopt_decodeVertexBuffer(decoded, count, stride, static_cast<unsigned char*>(encoded) + bound - res, res);\n", "instance_id": "zeux__meshoptimizer-882", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in its intent: it aims to address a threading issue in the meshoptimizer library by passing vertex and index versions as arguments instead of using global variables. The goal is understandable, and the motivation (multithreading safety) is explicitly stated. However, the statement lacks critical details such as specific input/output expectations, constraints on the version values, or how the change should interact with existing functionality. Additionally, there are no examples or edge cases mentioned (e.g., what happens if an invalid version is passed?). While the code changes provide some context, the problem description itself could benefit from more specificity regarding the expected behavior and scope of the modification. Thus, it falls into the \"Mostly Clear\" category with minor details missing.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to the following analysis based on the provided factors:\n\n1. **Scope and Depth of Code Changes:** The changes are relatively localized, affecting a few files (`meshoptimizer.h`, `vertexcodec.cpp`, `demo/main.cpp`, `tools/codecfuzz.cpp`, and `README.md`). The modifications primarily involve adding a new parameter (`version`) to an existing function (`meshopt_encodeVertexBufferLevel`) and updating its usage across the codebase. The changes do not significantly impact the system's architecture, as they are more of a refactoring to improve thread safety rather than a fundamental redesign. The amount of code change is small, mostly involving parameter additions and minor logic updates.\n\n2. **Number of Technical Concepts:** The problem requires understanding basic C++ concepts such as function signatures, parameter passing, and global variables. It also involves a minor grasp of the meshoptimizer library's encoding mechanism (specifically vertex encoding versions). However, no advanced algorithms, design patterns, or domain-specific knowledge beyond basic library usage are needed. The concept of thread safety is mentioned, but the solution does not require implementing complex synchronization mechanisms—just removing reliance on globals.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not explicitly mention edge cases, but the code changes introduce a simple validation (`assert(version < 0 || unsigned(version) <= kDecodeVertexVersion)`) to handle invalid version inputs. The error handling added is minimal and straightforward, and no complex edge cases (e.g., performance implications in multithreaded environments) are addressed or required based on the provided diff.\n\n4. **Overall Complexity:** The task involves straightforward refactoring with a clear goal. It requires understanding the purpose of the `version` parameter and ensuring consistency across function calls, but it does not demand deep knowledge of the codebase or intricate logic. The changes are mechanical in nature—adding a parameter and updating callsites—making this a relatively simple modification for someone familiar with C++.\n\nGiven these points, a difficulty score of 0.35 reflects an \"Easy\" problem that requires understanding some code logic and making simple function modifications. It is slightly above the lower end of the easy range due to the need to ensure consistency across multiple files, but it does not approach medium difficulty as the changes are not complex or impactful enough.", "clarity_label": 1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Handle nicely `SET` failure with `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`\n## Description\r\n\r\nIf you are submitting a reproducible bug report, please provide:\r\n\r\n- [x] A clear description of the issue\r\n\r\nMySQL has changed how the setting `sql_generate_invisible_primary_key` is reported for `Galera`. For version `8.0.28-26.10` error was still `ER_UNKNOWN_SYSTEM_VARIABLE`, yet in newer versions like `8.0.34-26.15` error has changed to `ER_WRONG_ARGUMENTS`:\r\n\r\n```\r\nAnd the error reported by MySQL is now ERROR 1210 (HY000): Variable not supported in combination with Galera\r\n```\r\n\r\nSince this error is equivalent to the one previously reported as `ER_UNKNOWN_SYSTEM_VARIABLE`, we should identify it and handle it the same way we previously did.\r\n\r\n- [x] ProxySQL version\r\n\r\nDevelopment branch `2.x`.\r\n\r\n- [x] The steps to reproduce the issue\r\n\r\nCreate a `mysql` session against ProxySQL using `MySQL Galera` with server version `8.0.34-26.15`. Change the value for `sql_generate_invisible_primary_key` and perform a query. ProxySQL reports the following in the error log:\r\n\r\n```\r\n2024-07-17 11:17:02 MySQL_Session.cpp:2970:handler_again___status_SETTING_GENERIC_VARIABLE(): [WARNING] Error while setting sql_generate_invisible_primary_key to \"ON\" on 127.0.0.1:15307 hg 101 :  1210, Variable not supported in combination with Galera\r\n```\r\n\r\n## Fix\r\n\r\nProposed fix is bundled in PR #4588. \r\n\n", "patch": "diff --git a/include/MySQL_Variables.h b/include/MySQL_Variables.h\nindex 678d594a06..4d0aa5c8a9 100644\n--- a/include/MySQL_Variables.h\n+++ b/include/MySQL_Variables.h\n@@ -20,6 +20,7 @@ bool update_server_variable(MySQL_Session* session, int idx, int &_rc);\n bool verify_server_variable(MySQL_Session* session, int idx, uint32_t client_hash, uint32_t server_hash);\n bool verify_set_names(MySQL_Session* session);\n bool logbin_update_server_variable(MySQL_Session* session, int idx, int &_rc);\n+bool is_perm_track_err(int err, const char* varname);\n \n class MySQL_Variables {\n \tstatic verify_var verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/include/proxysql.h b/include/proxysql.h\nindex 90c881d414..8b6d1d4d50 100644\n--- a/include/proxysql.h\n+++ b/include/proxysql.h\n@@ -117,6 +117,10 @@ void proxy_info_(const char* msg, ...);\n #ifdef DEBUG\n void init_debug_struct();\n void init_debug_struct_from_cmdline();\n+/**\n+ * @brief Add a debug entry in the error log. To be used through 'proxy_debug' macro.\n+ * @details This function saves/restores the previous 'errno' value.\n+ */\n __attribute__((__format__ (__printf__, 7, 8)))\n void proxy_debug_func(enum debug_module, int, int, const char *, int, const char *, const char *, ...);\n void proxy_debug_get_filters(std::set<std::string>&);\ndiff --git a/include/proxysql_structs.h b/include/proxysql_structs.h\nindex f3d322305c..deac187de0 100644\n--- a/include/proxysql_structs.h\n+++ b/include/proxysql_structs.h\n@@ -277,6 +277,11 @@ typedef struct {\n \tchar * default_value;       // default value\n \tbool is_global_variable;\t// is it a global variable?\n } mysql_variable_st;\n+\n+typedef struct {\n+\tint err;\n+\tconst char* name;\n+} var_track_err_st;\n #endif\n \n enum mysql_data_stream_status {\n@@ -1218,10 +1223,9 @@ mysql_variable_st mysql_tracked_variables[] {\n \tsession_track_system_variables\n \tsession_track_transaction_info\n \t*/\n-\n-\n };\n #else\n extern mysql_variable_st mysql_tracked_variables[];\n+extern var_track_err_st perm_track_errs[];\n #endif // PROXYSQL_EXTERN\n #endif // MYSQL_TRACKED_VARIABLES\ndiff --git a/lib/MySQL_Session.cpp b/lib/MySQL_Session.cpp\nindex ae306e36e4..b40d922539 100644\n--- a/lib/MySQL_Session.cpp\n+++ b/lib/MySQL_Session.cpp\n@@ -2974,6 +2974,8 @@ bool MySQL_Session::handler_again___status_SETTING_GENERIC_VARIABLE(int *_rc, co\n \t\t\t\t\t(myerr == 1193) // variable is not found\n \t\t\t\t\t||\n \t\t\t\t\t(myerr == 1651) // Query cache is disabled\n+\t\t\t\t\t||\n+\t\t\t\t\t(is_perm_track_err(myerr, var_name)) // Special permitted tracking errors (~= '1193')\n \t\t\t\t) {\n \t\t\t\t\tint idx = SQL_NAME_LAST_HIGH_WM;\n \t\t\t\t\tfor (int i=0; i<SQL_NAME_LAST_HIGH_WM; i++) {\ndiff --git a/lib/MySQL_Variables.cpp b/lib/MySQL_Variables.cpp\nindex 6f5c1f0481..c0df467820 100644\n--- a/lib/MySQL_Variables.cpp\n+++ b/lib/MySQL_Variables.cpp\n@@ -9,6 +9,7 @@\n #endif\n \n #include <sstream>\n+#include \"mysqld_error.h\"\n \n \n static inline char is_digit(char c) {\n@@ -17,6 +18,23 @@ static inline char is_digit(char c) {\n \treturn 0;\n }\n \n+var_track_err_st perm_track_errs[] {\n+\t// ERROR 1210 (HY000): Variable not supported in combination with Galera:\n+\t// - Changed by MySQL, previously 'ER_UNKNOWN_SYSTEM_VARIABLE'\n+\t{ ER_WRONG_ARGUMENTS, \"sql_generate_invisible_primary_key\" }\n+};\n+\n+bool is_perm_track_err(int err, const char* varname) {\n+\tconst size_t count = sizeof(perm_track_errs) / sizeof(var_track_err_st);\n+\n+\tfor (size_t i = 0; i < count; i++) {\n+\t\tif (perm_track_errs[i].err == err && (strcasecmp(varname, perm_track_errs[i].name) == 0)) {\n+\t\t\treturn true;\n+\t\t}\n+\t}\n+\treturn false;\n+}\n+\n #include \"proxysql_find_charset.h\"\n \n verify_var MySQL_Variables::verifiers[SQL_NAME_LAST_HIGH_WM];\ndiff --git a/lib/ProxySQL_Admin.cpp b/lib/ProxySQL_Admin.cpp\nindex a98d7669db..709ae3492b 100644\n--- a/lib/ProxySQL_Admin.cpp\n+++ b/lib/ProxySQL_Admin.cpp\n@@ -153,7 +153,8 @@ static void BQE1(SQLite3DB *db, const vector<string>& tbs, const string& p1, con\n }\n \n \n-static int round_intv_to_time_interval(int& intv) {\n+static int round_intv_to_time_interval(const char* name, int _intv) {\n+\tint intv = _intv;\n \tif (intv > 300) {\n \t\tintv = 600;\n \t} else {\n@@ -181,6 +182,9 @@ static int round_intv_to_time_interval(int& intv) {\n \t\t\t}\n \t\t}\n \t}\n+\tif (intv != _intv) {\n+\t\tproxy_warning(\"Variable '%s' rounded to interval '%d'\\n\", name, intv);\n+\t}\n \treturn intv;\n }\n \n@@ -8686,7 +8690,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connection_pool\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connection_pool=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connection_pool=intv;\n \t\t\t\treturn true;\n@@ -8697,7 +8701,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_connections\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_connections=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_connections=intv;\n \t\t\t\treturn true;\n@@ -8708,7 +8712,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_mysql_query_cache\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 300) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_mysql_query_cache=intv;\n \t\t\t\tGloProxyStats->variables.stats_mysql_query_cache=intv;\n \t\t\t\treturn true;\n@@ -8729,7 +8733,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_cpu\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_cpu=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_cpu=intv;\n \t\t\t\treturn true;\n@@ -8741,7 +8745,7 @@ bool ProxySQL_Admin::set_variable(char *name, char *value, bool lock) {  // this\n \t\tif (!strcasecmp(name,\"stats_system_memory\")) {\n \t\t\tint intv=atoi(value);\n \t\t\tif (intv >= 0 && intv <= 600) {\n-\t\t\t\tintv = round_intv_to_time_interval(intv);\n+\t\t\t\tintv = round_intv_to_time_interval(name, intv);\n \t\t\t\tvariables.stats_system_memory=intv;\n \t\t\t\tGloProxyStats->variables.stats_system_memory=intv;\n \t\t\t\treturn true;\ndiff --git a/lib/debug.cpp b/lib/debug.cpp\nindex e4eda648f5..4f3755c9c0 100644\n--- a/lib/debug.cpp\n+++ b/lib/debug.cpp\n@@ -131,15 +131,22 @@ void proxy_debug_load_filters(std::set<std::string>& f) {\n \t//pthread_mutex_unlock(&debug_mutex);\n }\n \n+// REMINDER: This function should always save/restore 'errno', otherwise it could influence error handling.\n void proxy_debug_func(enum debug_module module, int verbosity, int thr, const char *__file, int __line, const char *__func, const char *fmt, ...) {\n+\tint saved_errno = errno;\n \tassert(module<PROXY_DEBUG_UNKNOWN);\n \tif (pretime == 0) { // never initialized\n \t\tpretime=realtime_time();\n \t}\n-\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity)\n+\tif (GloVars.global.gdbg_lvl[module].verbosity < verbosity) {\n+\t\terrno = saved_errno;\n \t\treturn;\n-\tif (filter_debug_entry(__file, __line, __func)) // check if the entry must be filtered\n+\t}\n+\t// check if the entry must be filtered\n+\tif (filter_debug_entry(__file, __line, __func)) {\n+\t\terrno = saved_errno;\n \t\treturn;\n+\t}\n \tchar origdebugbuff[DEBUG_MSG_MAXSIZE];\n \tchar debugbuff[DEBUG_MSG_MAXSIZE];\n \tchar longdebugbuff[DEBUG_MSG_MAXSIZE*8];\n@@ -243,6 +250,8 @@ void proxy_debug_func(enum debug_module module, int verbosity, int thr, const ch\n \tpthread_mutex_unlock(&debug_mutex);\n \tif (curtime != 0)\n \t\tpretime=curtime;\n+\n+\terrno = saved_errno;\n };\n #endif\n \ndiff --git a/lib/mysql_connection.cpp b/lib/mysql_connection.cpp\nindex 53b47cc7c4..8ae6a85f5c 100644\n--- a/lib/mysql_connection.cpp\n+++ b/lib/mysql_connection.cpp\n@@ -1252,6 +1252,14 @@ MDB_ASYNC_ST MySQL_Connection::handler(short event) {\n \t\t\t//if (parent->use_ssl) {\n \t\t\t{\n \t\t\t\t// mariadb client library disables NONBLOCK for SSL connections ... re-enable it!\n+\t\t\t\t// CONTEXT: This shouldn't be confused with the previous incompatibility that 'mariadbclient'\n+\t\t\t\t// had between the NONBLOCK flags and SSL connections, and that was reported and solved via\n+\t\t\t\t// CONC-320, our patch for this incompatibility was dropped on connector upgrade for v2.0.9.\n+\t\t\t\t// Setting the socket back to NONBLOCK is SAFE. This is because a connection can be used for\n+\t\t\t\t// BOTH blocking and not blocking calls, as described here:\n+\t\t\t\t// - https://mariadb.com/kb/en/using-the-non-blocking-library/#mixing-blocking-and-non-blocking-operation\n+\t\t\t\t// In case of SSL connections, it's still required to set the socket back to NONBLOCK prior to\n+\t\t\t\t// non-blockig calls.\n \t\t\t\tmysql_options(mysql, MYSQL_OPT_NONBLOCK, 0);\n \t\t\t\tint f=fcntl(mysql->net.fd, F_GETFL);\n #ifdef FD_CLOEXEC\ndiff --git a/lib/mysql_data_stream.cpp b/lib/mysql_data_stream.cpp\nindex 3ff6e5da44..a45e77dc93 100644\n--- a/lib/mysql_data_stream.cpp\n+++ b/lib/mysql_data_stream.cpp\n@@ -570,9 +570,7 @@ int MySQL_Data_Stream::read_from_net() {\n \n \tint r=0;\n \tint s=queue_available(queueIN);\n-\tif (encrypted) {\n-\t//\tproxy_info(\"Queue available of %d bytes\\n\", s);\n-\t}\n+\n \tif (encrypted == false) {\n \t\tif (pkts_recv) {\n \t\t\tr = recv(fd, queue_w_ptr(queueIN), s, 0);\n@@ -592,41 +590,24 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t}\n \t\t}\n \t} else { // encrypted == true\n-/*\n-\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\tint ret = SSL_do_handshake(ssl);\n-\t\t\tint ret2;\n-\t\t\tif (ret != 1) {\n-\t\t\t\t//ERR_print_errors_fp(stderr);\n-\t\t\t\tret2 = SSL_get_error(ssl, ret);\n-\t\t\t\tfprintf(stderr,\"%d\\n\",ret2);\n-\t\t\t}\n-\t\t\treturn 0;\n-\t\t} else {\n-\t\t\tr = SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t}\n-*/\n \t\tPROXY_TRACE();\n \t\tif (s < MY_SSL_BUFFER) {\n \t\t\treturn 0;\t// no enough space for reads\n \t\t}\n \t\tchar buf[MY_SSL_BUFFER];\n-\t\t//ssize_t n = read(fd, buf, sizeof(buf));\n-\t\tint n = recv(fd, buf, sizeof(buf), 0);\n-\t\t//proxy_info(\"SSL recv of %d bytes\\n\", n);\n-\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, n,  rbio_ssl->num_write , rbio_ssl->num_read);\n-\t\tif (n > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n-\t\t\t//on_read_cb(buf, (size_t)n);\n+\t\tint ssl_recv_bytes = recv(fd, buf, sizeof(buf), 0);\n+\t\tproxy_debug(PROXY_DEBUG_NET, 7, \"Session=%p: recv() read %d bytes. num_write: %lu ,  num_read: %lu\\n\", sess, ssl_recv_bytes,  rbio_ssl->num_write , rbio_ssl->num_read);\n \n+\t\tif (ssl_recv_bytes > 0 || rbio_ssl->num_write > rbio_ssl->num_read) {\n \t\t\tchar buf2[MY_SSL_BUFFER];\n \t\t\tint n2;\n \t\t\tenum sslstatus status;\n \t\t\tchar *src = buf;\n-\t\t\tint len = n;\n+\t\t\tint len = ssl_recv_bytes;\n \t\t\twhile (len > 0) {\n \t\t\t\tn2 = BIO_write(rbio_ssl, src, len);\n \t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: write %d bytes into BIO %p, len=%d\\n\", sess, n2, rbio_ssl, len);\n-\t\t\t\t//proxy_info(\"BIO_write with len = %d and %d bytes\\n\", len , n2);\n+\n \t\t\t\tif (n2 <= 0) {\n \t\t\t\t\tshut_soft();\n \t\t\t\t\treturn -1;\n@@ -634,40 +615,29 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\tsrc += n2;\n \t\t\t\tlen -= n2;\n \t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished NOT completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\tif (do_ssl_handshake() == SSLSTATUS_FAIL) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished failed!!\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake failed   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\tshut_soft();\n \t\t\t\t\t\treturn -1;\n \t\t\t\t\t}\n \t\t\t\t\tif (!SSL_is_init_finished(ssl)) {\n-\t\t\t\t\t\t//proxy_info(\"SSL_is_init_finished yet NOT completed\\n\");\n+\t\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake not finished yet   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t\t\treturn 0;\n \t\t\t\t\t}\n \t\t\t\t} else {\n-\t\t\t\t\t//proxy_info(\"SSL_is_init_finished completed\\n\");\n+\t\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"SSL handshake finished   session=%p bytes=%d BIO=%p len=%d\\n\", sess, n2, rbio_ssl, len);\n \t\t\t\t}\n \t\t\t}\n \t\t\tn2 = SSL_read (ssl, queue_w_ptr(queueIN), s);\n \t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from BIO %p into a buffer with %d bytes free\\n\", sess, n2, rbio_ssl, s);\n \t\t\tr = n2;\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n-\t\t\tif (n2 > 0) {\n-\t\t\t}\n-/*\n-\t\t\tdo {\n-\t\t\t\tn2 = SSL_read(ssl, buf2, sizeof(buf2));\n-\t\t\t\tif (n2 > 0) {\n-\t\t\t\t\t\n-\t\t\t\t}\n-\t\t\t} while (n > 0);\n-*/\n \t\t\tstatus = get_sslstatus(ssl, n2);\n-\t\t\t//proxy_info(\"SSL status = %d\\n\", status);\n+\n \t\t\tif (status == SSLSTATUS_WANT_IO) {\n \t\t\t\tdo {\n \t\t\t\t\tn2 = BIO_read(wbio_ssl, buf2, sizeof(buf2));\n-\t\t\t\t\t//proxy_info(\"BIO_read with %d bytes\\n\", n2);\n+\n \t\t\t\t\tif (n2 > 0) {\n           \t\t\t\tqueue_encrypted_bytes(buf2, n2);\n \t\t\t\t\t} else if (!BIO_should_retry(wbio_ssl)) {\n@@ -681,14 +651,18 @@ int MySQL_Data_Stream::read_from_net() {\n \t\t\t\treturn -1;\n \t\t\t}\n \t\t} else {\n-\t\t\tr = n;\n-\t\t\t//r += SSL_read (ssl, queue_w_ptr(queueIN), s);\n-\t\t\t//proxy_info(\"Read %d bytes from SSL\\n\", r);\n+\t\t\t// Shutdown if we either received the EOF, or operation failed with non-retryable error.\n+\t\t\tif (ssl_recv_bytes==0 || (ssl_recv_bytes==-1 && errno != EINTR && errno != EAGAIN)) {\n+\t\t\t\tproxy_debug(PROXY_DEBUG_NET, 5, \"Received EOF, shutting down soft socket -- Session=%p, Datastream=%p\\n\", sess, this);\n+\t\t\t\tshut_soft();\n+\t\t\t\treturn -1;\n+\t\t\t}\n+\t\t\tr = ssl_recv_bytes;\n \t\t}\n \t}\n-//__exit_read_from_next:\n+\n \tproxy_debug(PROXY_DEBUG_NET, 5, \"Session=%p: read %d bytes from fd %d into a buffer of %d bytes free\\n\", sess, r, fd, s);\n-\t//proxy_error(\"read %d bytes from fd %d into a buffer of %d bytes free\\n\", r, fd, s);\n+\n \tif (r < 1) {\n \t\tif (encrypted==false) {\n \t\t\tint myds_errno=errno;\n", "instance_id": "sysown__proxysql-4588", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: MySQL has changed the error code for the `sql_generate_invisible_primary_key` setting in newer versions when used with Galera, and ProxySQL needs to handle the new error code (`ER_WRONG_ARGUMENTS`) in the same way as the old one (`ER_UNKNOWN_SYSTEM_VARIABLE`). The description includes the context of the issue, the specific versions affected, the error message, and a reference to the proposed fix in a pull request. Steps to reproduce the issue are provided, which adds to the clarity. However, there are minor ambiguities: the problem statement does not explicitly define the expected behavior or output after the fix (e.g., should the error be logged differently or suppressed entirely?), and it lacks details on potential edge cases or constraints (e.g., are there other variables or errors that might need similar handling?). Due to these minor missing details, I assign a clarity score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are relatively localized, primarily involving the addition of a new error handling mechanism in `MySQL_Session.cpp` and `MySQL_Variables.cpp`. A new structure `var_track_err_st` and a function `is_perm_track_err` are introduced to handle the specific error code for the variable in question. The changes span a few files (`MySQL_Variables.h`, `proxysql_structs.h`, `MySQL_Session.cpp`, `MySQL_Variables.cpp`), but they are straightforward and do not impact the broader system architecture. The amount of code change is small and focused.\n\n2. **Number of Technical Concepts**: Solving this requires a basic understanding of error handling in C++ and familiarity with MySQL error codes. The solution involves simple array-based lookup logic to match error codes with variable names, which is not conceptually complex. No advanced algorithms, design patterns, or domain-specific knowledge beyond MySQL error handling are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement does not explicitly mention edge cases, but the code change handles a specific error for a specific variable, suggesting a narrow scope. There is no indication of complex edge cases (e.g., handling multiple variables or dynamic error codes), and the error handling logic added is minimal and straightforward.\n\n4. **Overall Complexity**: While the problem requires understanding the context of MySQL error codes and ProxySQL's session handling, the actual implementation is a simple extension of existing logic. The changes do not require deep knowledge of the codebase's architecture or significant refactoring. However, it is slightly more involved than a trivial fix (e.g., changing a constant) due to the need to integrate with existing error handling logic and ensure correctness for the specific variable.\n\nAdditionally, I note that the provided diff includes unrelated changes (e.g., debug logging improvements, SSL handling in `mysql_data_stream.cpp`, and variable rounding in `ProxySQL_Admin.cpp`). These are likely part of a larger pull request and not directly relevant to the described problem. I have focused my evaluation only on the changes related to handling `ER_WRONG_ARGUMENTS` for `sql_generate_invisible_primary_key`. Given the simplicity of the relevant changes and the limited scope, I assign a difficulty score of 0.35, towards the higher end of the \"Easy\" range due to the need for some contextual understanding of MySQL errors and ProxySQL internals.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "If a binlog task blocks the slave for a long period, the master may resume the increment replication from an incorrect  start position after timeout reconnection\n### Is this a regression?\r\n\r\nNo\r\n\r\n### Description\r\n\r\n**在增量同步的过程中，如果某条BinlogTask阻塞了Slave很长时间（超过20s的超时时间），会造成主从断联，当主从再次试图重建连接时，Slave可能会提供一个错误的Binlog Start Point给Master来进行续传**。\r\n\r\n**针对这一Case的展开描述**:\r\n**场景**：假设Slave在增量同步阶段，发生超时转为了TryConnect状态，在发出TrySync请求时，如果相应的BinlogWorker正好还在执行一个上次连接期间的Binlog任务（将该Binlog任务定义为任务A) 。 那么，因为任务A的存在，Slave是否可能会发送了不正确的续传起始Offset给Master ？ 换句话说：虽然最终任务A会在Slave落盘，但是Slave是否可能告知了Master从任务A（所对应的Binlog）开始的位置发送Binlog，导致Master会将任务A对应的Binlog再发一次，且Slave会消费两次任务A所对应的Binlog ？  先做回答: 会出现这种问题。具体梳理在下面：\r\n\r\n**背景补充和定义**：TrySync请求携带的offset(定义为offset A)主要作用是给Master判断是否能做增量同步，真正决定Master初始化发送窗口起始位置（续传Binlog的起始位置）的，是slave在收到TrySync的Resp后发出的一条特殊BinlogACK (is_first_send=true)，该ACK的offst start等于end(定义为Offset B)，且该Offset B就是slave在发出这条特殊Ack时的最新落盘点。在大多数情况下，其实Offset B应该会和Offset A相同，但是在Edge Case 1中，由于发出TrySync时任务A正在执行且最终会执行完毕，Offset B的正确预期应当是  Offset A + BinlogSizeOf(任务A), 或者说Binlog的起始续传位置应该就在任务A对应的Binlogs的后面。\r\n\r\n**现有代码逻辑中**：Offset B可能不会等于正确预期，假如BinlogWork执行任务A执行了比较久，而在任务A的执行期间Slave完成了：TrySync Req发送 ->TrySync Resp处理->在TrySync Resp的处理函数末尾会获取Slave最新的Binlog落盘点（Offset B），发出特殊BinlogAck(is_first_send=true)来告知Master从哪里开始重发Binlog。 如果在获取Offset B的时候，任务A还没落盘，或者落盘了但是还没有将最新的offset更新到version_对象中(Offset B就是从version_对象中取)，就会导致获取的OffsetB就等于Offset A(但正确的应该Offset B应该是 Offset A + Offset A + BinlogSizeOf(任务A))，于是Master会把任务A所对应的那批Binlog再发一遍。\r\n\r\n**后果**：Master会把任务A内部的BInlog再发一次，Slave等于消费了2批同样的Binlog，一次是在上一次Session的末尾（阻塞的那个任务A），一次是在新Session的第一个Binlog任务中。可能会导致主从数据不一致，且在同步没有滞后/完全同步的情况下，Slave的Binlog文件会比Master的对应BInlog文件长一点，在Slave切走这个Binlog文件之前如果发生了断点重连，主从建联可能会报错 binlog offset is not a start point of master, 但是如果slave在处于该Binlog文件期间完全没有断开过，可能消费到了窗口末尾时Master端会报出奇怪的SyncWin Corruption。(另外，在线上实例的主从超时故障中，确实也出现过binlog offset is not a start point of master)\r\n\r\n\r\n**During incremental synchronization, if a BinlogTask blocks the Slave for a long time (exceeding the 20-second timeout), when the Master and Slave attempt to reconnect, the Slave may provide an incorrect Binlog Start Point to the Master for resuming the process.**\r\n\r\n**Expanded description of this case**:\r\n**Scenario**: Suppose during the incremental synchronization phase, the Slave times out and switches to TryConnect state. When sending a TrySync request, if the corresponding BinlogWorker happens to still be executing a Binlog task from the previous connection period (let's define this Binlog task as Task A), then due to the existence of Task A, could the Slave possibly send an incorrect resumption starting Offset to the Master? In other words, even though Task A will eventually be written to the Slave’s disk, could the Slave inform the Master to send the Binlog from the starting point of Task A, causing the Master to resend the Binlog corresponding to Task A and resulting in the Slave consuming the Binlog for Task A twice? The preliminary answer is: yes, this issue can occur. The detailed explanation is below:\r\n\r\n**Background and definition**: The offset carried by the TrySync request (defined as Offset A) primarily serves for the Master to determine whether incremental synchronization can be performed. The actual determination of the starting position of the Master’s initial sending window (the starting position for resuming the Binlog) is done by a special BinlogACK (with is_first_send=true) sent by the Slave after receiving the TrySync response. The start of this ACK’s offset is equal to the end (defined as Offset B), and this Offset B is the latest disk write point of the Slave when sending this special Ack. In most cases, Offset B should be the same as Offset A, but in Edge Case 1, since Task A is executing when the TrySync is sent and will eventually complete, the correct expectation for Offset B should be Offset A + BinlogSizeOf(Task A), or in other words, the starting position for resuming the Binlog should be right after the Binlogs corresponding to Task A.\r\n\r\n**In the current code logic**: Offset B may not equal the correct expectation. If the BinlogWork executing Task A takes a long time, and during the execution of Task A, the Slave completes: sending TrySync Req -> processing TrySync Resp -> obtaining the latest Binlog write point (Offset B) at the end of the TrySync Resp processing function, and sending a special BinlogAck (is_first_send=true) to inform the Master where to start resending the Binlog. If Task A has not been written to disk or the latest offset has not been updated to the version_ object (Offset B is taken from the version_ object) when obtaining Offset B, then the obtained Offset B will equal Offset A (but the correct Offset B should be Offset A + BinlogSizeOf(Task A)), thus causing the Master to resend the batch of Binlogs corresponding to Task A.\r\n\r\n**Consequence**: The Master will resend the Binlogs within Task A, causing the Slave to consume two batches of the same Binlog, once at the end of the last session (the blocking Task A) and once in the first Binlog task of the new session. This can lead to data inconsistency between the Master and Slave. Additionally, if there is no lag in synchronization or if synchronization is complete, the Slave’s Binlog file may be slightly longer than the corresponding Binlog file on the Master. If a breakpoint reconnection occurs before the Slave switches from this Binlog file, the Master-Slave connection might report an error: binlog offset is not a start point of master. However, if the Slave never disconnects during this Binlog file, a strange SyncWin Corruption error might be reported on the Master side when the window reaches the end. (Furthermore, in the actual Master-Slave timeout failures in online instances, the binlog offset is not a start point of master error has indeed occurred.)\r\n\r\n\r\n### Please provide a link to a minimal reproduction of the bug\r\n\r\n_No response_\r\n\r\n### Screenshots or videos\r\n\r\n\r\n### Please provide the version you discovered this bug in (check about page for version information)\r\n\r\n_No response_\r\n\r\n### Anything else?\r\n\r\n_No response_\n", "patch": "diff --git a/conf/pika.conf b/conf/pika.conf\nindex 055208dae5..a99c30b30d 100644\n--- a/conf/pika.conf\n+++ b/conf/pika.conf\n@@ -34,10 +34,17 @@ slow-cmd-thread-pool-size : 1\n # Slow cmd list e.g. hgetall, mset\n slow-cmd-list :\n \n-# The number of sync-thread for data replication from master, those are the threads work on slave nodes\n-# and are used to execute commands sent from master node when replicating.\n+# The number of threads to write DB in slaveNode when replicating.\n+# It's preferable to set slave's sync-thread-num value close to master's thread-pool-size.\n sync-thread-num : 6\n \n+# The num of threads to write binlog in slaveNode when replicating,\n+# each DB cloud only bind to one sync-binlog-thread to write binlog in maximum\n+#[NOTICE] It's highly recommended to set sync-binlog-thread-num equal to conf item 'database'(then each DB cloud have a exclusive thread to write binlog),\n+# eg. if you use 8 DBs(databases_ is 8), sync-binlog-thread-num is preferable to be 8\n+# Valid range of sync-binlog-thread-num is [1, databases], the final value of it is Min(sync-binlog-thread-num, databases)\n+sync-binlog-thread-num : 1\n+\n # Directory to store log files of Pika, which contains multiple types of logs,\n # Including: INFO, WARNING, ERROR log, as well as binglog(write2fine) file which\n # is used for replication.\n@@ -101,6 +108,8 @@ instance-mode : classic\n # The default database id is DB 0. You can select a different one on\n # a per-connection by using SELECT. The db id range is [0, 'databases' value -1].\n # The value range of this parameter is [1, 8].\n+# [NOTICE] It's RECOMMENDED to set sync-binlog-thread-num equal to DB num(databases),\n+# if you've changed the value of databases, remember to check if the value of sync-binlog-thread-num is proper.\n databases : 1\n \n # The number of followers of a master. Only [0, 1, 2, 3, 4] is valid at present.\ndiff --git a/include/pika_conf.h b/include/pika_conf.h\nindex 2a5ed25212..e0cb81062d 100644\n--- a/include/pika_conf.h\n+++ b/include/pika_conf.h\n@@ -65,6 +65,10 @@ class PikaConf : public pstd::BaseConf {\n     std::shared_lock l(rwlock_);\n     return sync_thread_num_;\n   }\n+  int sync_binlog_thread_num() {\n+    std::shared_lock l(rwlock_);\n+    return sync_binlog_thread_num_;\n+  }\n   std::string log_path() {\n     std::shared_lock l(rwlock_);\n     return log_path_;\n@@ -793,6 +797,7 @@ class PikaConf : public pstd::BaseConf {\n   int slow_cmd_thread_pool_size_ = 0;\n   std::unordered_set<std::string> slow_cmd_set_;\n   int sync_thread_num_ = 0;\n+  int sync_binlog_thread_num_ = 0;\n   int expire_dump_days_ = 3;\n   int db_sync_speed_ = 0;\n   std::string slaveof_;\ndiff --git a/include/pika_define.h b/include/pika_define.h\nindex 4d6bf6a846..91ddffeb9f 100644\n--- a/include/pika_define.h\n+++ b/include/pika_define.h\n@@ -30,6 +30,8 @@\n #define PIKA_SERVER_ID_MAX 65535\n \n class PikaServer;\n+/* Global Const */\n+constexpr int MAX_DB_NUM = 8;\n \n /* Port shift */\n const int kPortShiftRSync = 1000;\ndiff --git a/include/pika_repl_client.h b/include/pika_repl_client.h\nindex aa20b83c78..49eb2c9b82 100644\n--- a/include/pika_repl_client.h\n+++ b/include/pika_repl_client.h\n@@ -65,6 +65,7 @@ class PikaReplClient {\n   pstd::Status Close(const std::string& ip, int port);\n \n   void Schedule(net::TaskFunc func, void* arg);\n+  void ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name);\n   void ScheduleWriteBinlogTask(const std::string& db_name, const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n@@ -80,13 +81,15 @@ class PikaReplClient {\n   pstd::Status SendRemoveSlaveNode(const std::string& ip, uint32_t port, const std::string& db_name, const std::string& local_ip);\n \n  private:\n-  size_t GetHashIndex(const std::string& key, bool upper_half);\n-  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(bg_workers_.size()); }\n+  size_t GetBinlogWorkerIndexByDBName(const std::string &db_name);\n+  size_t GetHashIndexByKey(const std::string& key);\n+  void UpdateNextAvail() { next_avail_ = (next_avail_ + 1) % static_cast<int32_t>(write_binlog_workers_.size()); }\n \n   std::unique_ptr<PikaReplClientThread> client_thread_;\n   int next_avail_ = 0;\n   std::hash<std::string> str_hash;\n-  std::vector<std::unique_ptr<PikaReplBgWorker>> bg_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_binlog_workers_;\n+  std::vector<std::unique_ptr<PikaReplBgWorker>> write_db_workers_;\n };\n \n #endif\ndiff --git a/include/pika_rm.h b/include/pika_rm.h\nindex 9cc0c5ef38..b3e310ddf4 100644\n--- a/include/pika_rm.h\n+++ b/include/pika_rm.h\n@@ -182,6 +182,7 @@ class PikaReplicaManager {\n                                const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                const std::shared_ptr<net::PbConn>& conn, void* res_private_data);\n   void ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset, const std::string& db_name);\n+  void ScheduleReplClientBGTaskByDBName(net::TaskFunc , void* arg, const std::string &db_name);\n   void ReplServerRemoveClientConn(int fd);\n   void ReplServerUpdateClientConnMap(const std::string& ip_port, int fd);\n \ndiff --git a/src/pika_admin.cc b/src/pika_admin.cc\nindex 6760ac247b..15d49cdbae 100644\n--- a/src/pika_admin.cc\n+++ b/src/pika_admin.cc\n@@ -942,6 +942,7 @@ void InfoCmd::InfoServer(std::string& info) {\n   tmp_stream << \"tcp_port:\" << g_pika_conf->port() << \"\\r\\n\";\n   tmp_stream << \"thread_num:\" << g_pika_conf->thread_num() << \"\\r\\n\";\n   tmp_stream << \"sync_thread_num:\" << g_pika_conf->sync_thread_num() << \"\\r\\n\";\n+  tmp_stream << \"sync_binlog_thread_num:\" << g_pika_conf->sync_binlog_thread_num() << \"\\r\\n\";\n   tmp_stream << \"uptime_in_seconds:\" << (current_time_s - g_pika_server->start_time_s()) << \"\\r\\n\";\n   tmp_stream << \"uptime_in_days:\" << (current_time_s / (24 * 3600) - g_pika_server->start_time_s() / (24 * 3600) + 1)\n              << \"\\r\\n\";\n@@ -1501,6 +1502,12 @@ void ConfigCmd::ConfigGet(std::string& ret) {\n     EncodeNumber(&config_body, g_pika_conf->sync_thread_num());\n   }\n \n+  if (pstd::stringmatch(pattern.data(), \"sync-binlog-thread-num\", 1) != 0) {\n+     elements += 2;\n+     EncodeString(&config_body, \"sync-binlog-thread-num\");\n+     EncodeNumber(&config_body, g_pika_conf->sync_binlog_thread_num());\n+    }\n+\n   if (pstd::stringmatch(pattern.data(), \"log-path\", 1) != 0) {\n     elements += 2;\n     EncodeString(&config_body, \"log-path\");\ndiff --git a/src/pika_conf.cc b/src/pika_conf.cc\nindex adc1b26d9f..e2e0d4f885 100644\n--- a/src/pika_conf.cc\n+++ b/src/pika_conf.cc\n@@ -176,7 +176,7 @@ int PikaConf::Load() {\n \n   if (classic_mode_.load()) {\n     GetConfInt(\"databases\", &databases_);\n-    if (databases_ < 1 || databases_ > 8) {\n+    if (databases_ < 1 || databases_ > MAX_DB_NUM) {\n       LOG(FATAL) << \"config databases error, limit [1 ~ 8], the actual is: \" << databases_;\n     }\n     for (int idx = 0; idx < databases_; ++idx) {\n@@ -185,6 +185,15 @@ int PikaConf::Load() {\n   }\n   default_db_ = db_structs_[0].db_name;\n \n+  // sync_binlog_thread_num_ must be set after the setting of databases_\n+  GetConfInt(\"sync-binlog-thread-num\", &sync_binlog_thread_num_);\n+  if (sync_binlog_thread_num_ <= 0) {\n+      sync_binlog_thread_num_ = databases_;\n+  } else {\n+      // final value is MIN(sync_binlog_thread_num, databases_)\n+      sync_binlog_thread_num_ = sync_binlog_thread_num_ > databases_ ?  databases_ : sync_binlog_thread_num_;\n+  }\n+\n   int tmp_replication_num = 0;\n   GetConfInt(\"replication-num\", &tmp_replication_num);\n   if (tmp_replication_num > 4 || tmp_replication_num < 0) {\ndiff --git a/src/pika_repl_client.cc b/src/pika_repl_client.cc\nindex 2754eb2f6e..352fbdf7e5 100644\n--- a/src/pika_repl_client.cc\n+++ b/src/pika_repl_client.cc\n@@ -27,8 +27,11 @@ extern std::unique_ptr<PikaReplicaManager> g_pika_rm;\n PikaReplClient::PikaReplClient(int cron_interval, int keepalive_timeout)  {\n   client_thread_ = std::make_unique<PikaReplClientThread>(cron_interval, keepalive_timeout);\n   client_thread_->set_thread_name(\"PikaReplClient\");\n-  for (int i = 0; i < 2 * g_pika_conf->sync_thread_num(); ++i) {\n-    bg_workers_.push_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  for (int i = 0; i < g_pika_conf->sync_binlog_thread_num(); i++) {\n+      write_binlog_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n+  }\n+  for (int i = 0; i < g_pika_conf->sync_thread_num(); ++i) {\n+    write_db_workers_.emplace_back(std::make_unique<PikaReplBgWorker>(PIKA_SYNC_BUFFER_SIZE));\n   }\n }\n \n@@ -43,49 +46,77 @@ int PikaReplClient::Start() {\n     LOG(FATAL) << \"Start ReplClient ClientThread Error: \" << res\n                << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n   }\n-  for (auto & bg_worker : bg_workers_) {\n-    res = bg_worker->StartThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    res = binlog_worker->StartThread();\n     if (res != net::kSuccess) {\n-      LOG(FATAL) << \"Start Pika Repl Worker Thread Error: \" << res\n+      LOG(FATAL) << \"Start Pika Repl Write Binlog Worker Thread Error: \" << res\n                  << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n     }\n   }\n+  for (auto & db_worker : write_db_workers_) {\n+        res = db_worker->StartThread();\n+        if (res != net::kSuccess) {\n+            LOG(FATAL) << \"Start Pika Repl Write DB Worker Thread Error: \" << res\n+                       << (res == net::kCreateThreadError ? \": create thread error \" : \": other error\");\n+        }\n+    }\n   return res;\n }\n \n int PikaReplClient::Stop() {\n   client_thread_->StopThread();\n-  for (auto & bg_worker : bg_workers_) {\n-    bg_worker->StopThread();\n+  for (auto & binlog_worker : write_binlog_workers_) {\n+    binlog_worker->StopThread();\n+  }\n+  for (auto &db_worker: write_db_workers_) {\n+    db_worker->StopThread();\n   }\n   return 0;\n }\n \n void PikaReplClient::Schedule(net::TaskFunc func, void* arg) {\n-  bg_workers_[next_avail_]->Schedule(func, arg);\n+  write_binlog_workers_[next_avail_]->Schedule(func, arg);\n   UpdateNextAvail();\n }\n \n+void PikaReplClient::ScheduleByDBName(net::TaskFunc func, void* arg, const std::string& db_name) {\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  write_binlog_workers_[index]->Schedule(func, arg);\n+};\n+\n void PikaReplClient::ScheduleWriteBinlogTask(const std::string& db_name,\n                                              const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                              const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n-  size_t index = GetHashIndex(db_name, true);\n-  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, bg_workers_[index].get());\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n+  size_t index = GetBinlogWorkerIndexByDBName(db_name);\n+  auto task_arg = new ReplClientWriteBinlogTaskArg(res, conn, res_private_data, write_binlog_workers_[index].get());\n+  write_binlog_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteBinlog, static_cast<void*>(task_arg));\n }\n \n void PikaReplClient::ScheduleWriteDBTask(const std::shared_ptr<Cmd>& cmd_ptr, const LogOffset& offset,\n                                          const std::string& db_name) {\n   const PikaCmdArgsType& argv = cmd_ptr->argv();\n   std::string dispatch_key = argv.size() >= 2 ? argv[1] : argv[0];\n-  size_t index = GetHashIndex(dispatch_key, false);\n+  size_t index = GetHashIndexByKey(dispatch_key);\n   auto task_arg = new ReplClientWriteDBTaskArg(cmd_ptr, offset, db_name);\n-  bg_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+  write_db_workers_[index]->Schedule(&PikaReplBgWorker::HandleBGWorkerWriteDB, static_cast<void*>(task_arg));\n+}\n+\n+size_t PikaReplClient::GetBinlogWorkerIndexByDBName(const std::string &db_name) {\n+    char db_num_c = db_name.back();\n+    int32_t db_num = db_num_c - '0';\n+    //Valid range of db_num is [0, MAX_DB_NUM)\n+    if (db_num < 0 || db_num >= MAX_DB_NUM) {\n+        LOG(ERROR)\n+                << \"Corruption in consuming binlog: the last char of the db_name(extracted from binlog) is not a valid db num, the extracted db_num is \"\n+                << db_num_c << \" while write_binlog_workers.size() is \" << write_binlog_workers_.size();\n+        if (db_num < 0) { assert(false && \"db_num invalid, check if the db_name in the request is valid, also check the ERROR Log of Pika.\"); }\n+    }\n+    return db_num % write_binlog_workers_.size();\n }\n \n-size_t PikaReplClient::GetHashIndex(const std::string& key, bool upper_half) {\n-  size_t hash_base = bg_workers_.size() / 2;\n-  return (str_hash(key) % hash_base) + (upper_half ? 0 : hash_base);\n+size_t PikaReplClient::GetHashIndexByKey(const std::string& key) {\n+  size_t hash_base = write_db_workers_.size();\n+  return (str_hash(key) % hash_base);\n }\n \n Status PikaReplClient::Write(const std::string& ip, const int port, const std::string& msg) {\ndiff --git a/src/pika_repl_client_conn.cc b/src/pika_repl_client_conn.cc\nindex 672648d64d..6c8e001bf1 100644\n--- a/src/pika_repl_client_conn.cc\n+++ b/src/pika_repl_client_conn.cc\n@@ -63,9 +63,12 @@ int PikaReplClientConn::DealMessage() {\n       break;\n     }\n     case InnerMessage::kTrySync: {\n+      const std::string& db_name = response->try_sync().slot().db_name();\n+      //TrySync resp must contain db_name\n+      assert(!db_name.empty());\n       auto task_arg =\n           new ReplClientTaskArg(response, std::dynamic_pointer_cast<PikaReplClientConn>(shared_from_this()));\n-      g_pika_rm->ScheduleReplClientBGTask(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg));\n+      g_pika_rm->ScheduleReplClientBGTaskByDBName(&PikaReplClientConn::HandleTrySyncResponse, static_cast<void*>(task_arg), db_name);\n       break;\n     }\n     case InnerMessage::kBinlogSync: {\n@@ -193,7 +196,6 @@ void PikaReplClientConn::HandleTrySyncResponse(void* arg) {\n     LOG(WARNING) << \"TrySync Failed: \" << reply;\n     return;\n   }\n-\n   const InnerMessage::InnerResponse_TrySync& try_sync_response = response->try_sync();\n   const InnerMessage::Slot& db_response = try_sync_response.slot();\n   std::string db_name = db_response.db_name();\ndiff --git a/src/pika_rm.cc b/src/pika_rm.cc\nindex 3445e9fea6..a996463bc2 100644\n--- a/src/pika_rm.cc\n+++ b/src/pika_rm.cc\n@@ -659,6 +659,10 @@ void PikaReplicaManager::ScheduleReplClientBGTask(net::TaskFunc func, void* arg)\n   pika_repl_client_->Schedule(func, arg);\n }\n \n+void PikaReplicaManager::ScheduleReplClientBGTaskByDBName(net::TaskFunc func, void* arg, const std::string &db_name) {\n+  pika_repl_client_->ScheduleByDBName(func, arg, db_name);\n+}\n+\n void PikaReplicaManager::ScheduleWriteBinlogTask(const std::string& db,\n                                                  const std::shared_ptr<InnerMessage::InnerResponse>& res,\n                                                  const std::shared_ptr<net::PbConn>& conn, void* res_private_data) {\n", "instance_id": "OpenAtomFoundation__pikiwidb-2638", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear in describing the issue related to incorrect Binlog Start Point during incremental synchronization in a master-slave replication scenario. It provides a detailed explanation of the problem, including the scenario, background, current code logic, and consequences of the bug (e.g., data inconsistency and potential errors during reconnection). The use of specific terms like Offset A, Offset B, and Task A, along with a step-by-step breakdown of the issue, helps in understanding the problem's context. However, there are minor ambiguities and missing details that prevent it from being comprehensive. For instance, the problem statement does not explicitly define the expected behavior or solution approach, leaving it somewhat open-ended. Additionally, there are no examples of input/output or specific test cases to reproduce the issue, and the lack of a minimal reproduction link (as noted in the \"No response\" section) makes it harder to validate the problem independently. Lastly, while edge cases are mentioned (e.g., Task A not being written to disk in time), they are not exhaustively specified or accompanied by concrete scenarios. Thus, while the problem is valid and mostly clear, these minor gaps justify a score of 2 (Mostly Clear) rather than 3.\n", "difficulty_explanation": "\nI assign a difficulty score of 0.75, placing this problem in the \"Hard\" category (0.6-0.8), due to the following factors:\n\n1. **Clarity and Complexity of the Problem Description**: The problem involves a nuanced issue in a distributed system (master-slave replication) related to synchronization and binlog handling. Understanding the timing issues between TrySync requests, BinlogTask execution, and offset updates requires a deep grasp of replication mechanics and distributed system challenges, which inherently increases the difficulty.\n\n2. **Scope and Depth of Code Changes**: The provided code changes span multiple files (e.g., `pika_repl_client.cc`, `pika_conf.cc`, `pika_rm.cc`) and introduce significant modifications to the architecture of the replication system. The changes involve splitting worker threads into separate pools for binlog writing (`write_binlog_workers_`) and database writing (`write_db_workers_`), and introducing database-specific scheduling (`ScheduleByDBName`). This impacts multiple modules and requires understanding the interaction between configuration, threading, and task scheduling in the codebase. The amount of code change is moderate but non-trivial, and it affects core replication logic, which is critical to the system's architecture.\n\n3. **Number of Technical Concepts**: Solving this problem requires familiarity with several advanced concepts, including multi-threading (managing separate thread pools for binlog and DB operations), distributed systems (master-slave replication, binlog synchronization), and configuration management (adjusting thread counts based on database numbers). Additionally, the code changes involve C++-specific features like smart pointers (`std::unique_ptr`), thread scheduling, and hash-based task distribution. Understanding and modifying the replication logic also demands domain-specific knowledge of database replication and binlog handling, which adds to the complexity.\n\n4. **Potential Edge Cases and Error Handling**: The problem statement explicitly mentions edge cases, such as a BinlogTask blocking for a long time and the resulting incorrect offset updates leading to duplicate binlog consumption. The code changes attempt to address this by ensuring database-specific thread allocation to prevent contention and ensure correct offset handling. However, implementing these changes requires careful consideration of additional edge cases, such as invalid database names or numbers (as seen in the error logging in `GetBinlogWorkerIndexByDBName`), and ensuring thread safety across the new worker pools. The error handling logic added in the code (e.g., assertions and logging for invalid DB numbers) indicates a need for robust validation, further increasing the complexity.\n\nOverall, this problem requires a deep understanding of the codebase's replication architecture, complex modifications across multiple files, and careful handling of edge cases related to timing and synchronization. While it does not reach the \"Very Hard\" category (0.8-1.0) due to the absence of extremely intricate algorithms or system-level redesigns (e.g., a new consensus protocol), it is still a challenging task that demands significant expertise in distributed systems and C++ programming. Hence, a score of 0.75 is appropriate.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Bug]: Windows showSaveDialog invalid filename bug\n### Preflight Checklist\n\n- [x] I have read the [Contributing Guidelines](https://github.com/electron/electron/blob/main/CONTRIBUTING.md) for this project.\n- [x] I agree to follow the [Code of Conduct](https://github.com/electron/electron/blob/main/CODE_OF_CONDUCT.md) that this project adheres to.\n- [x] I have searched the [issue tracker](https://www.github.com/electron/electron/issues) for a bug report that matches the one I want to file, without success.\n\n### Electron Version\n\n33.0.0\n\n### What operating system(s) are you using?\n\nWindows\n\n### Operating System Version\n\nWindows 11 22H2 22621.4317\n\n### What arch are you using?\n\nx64\n\n### Last Known Working Electron version\n\nNone\n\n### Expected Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters (e.g., 111*222).\n- Expected: The dialog correctly shows a warning that the file name is invalid due to the presence of illegal characters*.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Expected: The dialog should now allow saving the file since all illegal characters have been removed, even if no file extension is added.\n\n### Actual Behavior\n\n1. Open the save dialog using dialog.showSaveDialog.\n2. Enter a file name containing illegal characters* (e.g., 111*222).\n- Actual: The dialog provides no error message or feedback.\n3. Remove the illegal characters* (e.g., change 111*222 to 111222).\n4. Attempt to save the file without adding an extension.\n- Actual: The dialog shows the file name as invalid, even though all illegal characters have been removed.\n5. Now, modify the file name to include a valid extension (e.g., 111222.xml).\n- Actual: The file saves successfully when an extension is added, indicating that the dialog behaves inconsistently by requiring an extension even for valid file names.\n\n### Testcase Gist URL\n\n_No response_\n\n### Additional Information\n\nBelow is a minimal code example to reproduce the issue:\n\nSample Code:\n```\nconst fs = require('fs');\nconst { dialog } = require('electron');\n\nconst saveFileDialog = dialog.showSaveDialog({\n  title: '保存 XML 文件',\n  filters: [\n    { name: 'XML 文件', extensions: ['xml'] }\n  ]\n});\n\nsaveFileDialog.then(result => {\n  if (!result.canceled) {\n    const filePath = result.filePath;\n    console.log(`文件将保存到: ${filePath}`);\n\n    // 你要保存的 XML 内容\n    const xmlContent = `\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<root>\n  <item>\n    <name>示例数据</name>\n    <value>123</value>\n  </item>\n</root>`;\n\n    // 将 XML 内容写入文件\n    fs.writeFile(filePath, xmlContent, (err) => {\n      if (err) {\n        console.error('保存文件时出错:', err);\n      } else {\n        console.log('文件保存成功!');\n      }\n    });\n  } else {\n    console.log('用户取消了保存操作');\n  }\n});\n\n```\nThis behavior only occurs in Electron applications, including those built using Electron, such as Visual Studio Code, QQ,WeChat PC (version 4.0) and other apps.\nHowever, Windows built-in applications like Notepad or third-party editors such as Notepad++ do not exhibit this behavior. In these apps, once illegal characters are removed from the file name, the modified name is accepted without requiring a file extension.\n\nThis inconsistency suggests that the showSaveDialog function in Electron has stricter handling or some kind of caching issue when validating file names, leading to unexpected behavior. This issue affects the user experience, as users are required to manually add file extensions even when they expect the file to save without one.\n\nThis issue seems to be related to or may have similarities with the following issue reported previously:\n[#25615 - SaveDialog doesn’t allow saving a file with some extensions on Windows](https://github.com/electron/electron/issues/25615).\n\nBoth issues may indicate an underlying problem in how the dialog.showSaveDialog function interacts with Windows file system rules.\n\n![Image](https://github.com/user-attachments/assets/3f6bd0c9-5eeb-4642-9a97-1fb488ab573f)\n![Image](https://github.com/user-attachments/assets/297e7f88-d86e-430d-9267-8a41676952d2)\n![Image](https://github.com/user-attachments/assets/7ff1b07d-75a0-44fa-9920-728e4afbd125)\n![Image](https://github.com/user-attachments/assets/ef1b6db9-1ea7-4bd5-8737-9e589b3ee840)\n\n\n\n\n", "patch": "diff --git a/shell/browser/ui/file_dialog_win.cc b/shell/browser/ui/file_dialog_win.cc\nindex cfc8c6068c648..e142477ad0820 100644\n--- a/shell/browser/ui/file_dialog_win.cc\n+++ b/shell/browser/ui/file_dialog_win.cc\n@@ -144,10 +144,14 @@ static void ApplySettings(IFileDialog* dialog, const DialogSettings& settings) {\n   // We set file extension to the first none-wildcard extension to make\n   // sure the dialog will update file extension automatically.\n   for (size_t i = 0; i < filterspec.size(); ++i) {\n-    if (std::wstring(filterspec[i].pszSpec) != L\"*.*\") {\n+    std::wstring spec(filterspec[i].pszSpec);\n+    if (spec != L\"*.*\") {\n       // SetFileTypeIndex is regarded as one-based index.\n       dialog->SetFileTypeIndex(i + 1);\n-      dialog->SetDefaultExtension(filterspec[i].pszSpec);\n+      // \"*.jpg;*.png\" => \"*.jpg\"\n+      std::wstring first_spec = spec.substr(0, spec.find(L';'));\n+      // \"*.jpg\" => \"jpg\"\n+      dialog->SetDefaultExtension(first_spec.substr(2).c_str());\n       break;\n     }\n   }\n", "instance_id": "electron__electron-44296", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue with the `dialog.showSaveDialog` function in Electron on Windows. It outlines the expected and actual behavior with specific steps to reproduce the bug, including the handling of illegal characters and file extensions. The inclusion of sample code and references to related issues (e.g., #25615) adds to the clarity. Additionally, the problem statement is supported by images and mentions of affected applications, which helps in understanding the scope and impact. However, there are minor ambiguities: the statement does not fully specify whether the issue is tied to specific filter settings or dialog configurations beyond the provided sample code, and edge cases (e.g., behavior with different character sets or extremely long filenames) are not explicitly addressed. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of solving this problem falls in the medium range (0.4-0.6) due to several factors. First, the scope of code changes appears limited to a single file (`file_dialog_win.cc`) and a specific function related to setting default file extensions in the Windows file dialog. The provided diff shows a small, targeted modification (adjusting how the default extension is extracted and set), which does not suggest a broad impact on the system's architecture or multiple modules. However, the problem requires a moderate understanding of technical concepts, including the Windows COM API for file dialogs (`IFileDialog`), string manipulation in C++ (handling wide strings and parsing file extension patterns), and Electron's integration with native OS dialogs. Additionally, the developer must understand the nuances of Windows file naming rules and how they interact with Electron's dialog settings. While the edge cases mentioned in the problem statement (e.g., illegal characters, missing extensions) are not overly complex, implementing a robust solution may require careful testing to ensure consistent behavior across different user inputs and filter configurations. There are no significant performance or system-level considerations apparent in this fix. Overall, this problem requires a moderate level of expertise and effort, justifying a difficulty score of 0.45.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Decreasing nMaxIPs when learning from DNS seeds\nCurrently, our `nMaxIPs` when learning from DNS seeds is 256. @TheBlueMatt pointed out to me that if one of the seeds decided to actually return that many addresses, it would bias the addresses we add to `AddrMan` and consequently choose as our initial outbound peers. A quick `drill -t` of all the current seeds show that none yielded more than 26 results, meaning that if any of the seeds decided to return all 256 results (perhaps malicious ones), results from that seed would take over more than half of `AddrMan`.\r\n\r\nIf there were no TCP-fallback, this wouldn't be too much of a problem as at maximum we could fit around 31 IPs in a UDP packet. However, it seems that `glibc` [uses the TCP-fallback](https://bugs.launchpad.net/ubuntu/+source/systemd/+bug/1811471) by default, which would mean that obtaining 256 IPs is entirely possible.\n", "patch": "diff --git a/src/net.cpp b/src/net.cpp\nindex e388f05b037ad..3e959c187c2c7 100644\n--- a/src/net.cpp\n+++ b/src/net.cpp\n@@ -2256,7 +2256,11 @@ void CConnman::ThreadDNSAddressSeed()\n             if (!resolveSource.SetInternal(host)) {\n                 continue;\n             }\n-            unsigned int nMaxIPs = 256; // Limits number of IPs learned from a DNS seed\n+            // Limit number of IPs learned from a single DNS seed. This limit exists to prevent the results from\n+            // one DNS seed from dominating AddrMan. Note that the number of results from a UDP DNS query is\n+            // bounded to 33 already, but it is possible for it to use TCP where a larger number of results can be\n+            // returned.\n+            unsigned int nMaxIPs = 32;\n             const auto addresses{LookupHost(host, nMaxIPs, true)};\n             if (!addresses.empty()) {\n                 for (const CNetAddr& ip : addresses) {\n", "instance_id": "bitcoin__bitcoin-29850", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the current setting of `nMaxIPs` at 256 when learning from DNS seeds. It explains the potential risk of bias in `AddrMan` if a seed returns a large number of addresses, especially with TCP fallback allowing more results than UDP. The goal of reducing this risk is implied through the context and the code change. However, there are minor ambiguities: the statement does not explicitly define the desired outcome or constraints beyond the risk (e.g., why 32 was chosen as the new limit, or if there are specific performance or security thresholds to consider). Additionally, edge cases or potential side effects of this change are not discussed in the problem description. Overall, it is clear enough to understand the intent but lacks some finer details and explicit requirements.", "difficulty_explanation": "The difficulty of this problem is very low, as it involves a straightforward modification of a single constant (`nMaxIPs`) from 256 to 32 in a specific part of the codebase (`net.cpp`). The scope of the change is minimal, affecting only one line in a single file, with no impact on the broader system architecture or interactions between modules. The technical concepts required are basic—understanding the purpose of limiting DNS seed results and the difference between UDP and TCP in DNS queries, which are relatively simple networking concepts. No complex algorithms, design patterns, or domain-specific knowledge beyond basic networking are needed. Edge cases or error handling are not explicitly mentioned in the problem statement or required in the code change, as the modification is a simple value adjustment with a comment for clarity. Overall, this task falls into the \"very easy\" category, requiring only a basic code modification and minimal understanding of the surrounding context.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Settings]: In scan mode, Screen Reader users are not able to open 'Open JSON file' control.\n### Windows Terminal version\n\n1.12.3472.0\n\n### Windows build number\n\n10.0.22504.1010\n\n### Other Software\n\n**Test Environment:**\r\nOS: Windows 11 Version Dev (OS Build 22504.1010)\r\nApp: Windows Terminal Preview\r\nScreen Reader: Narrator\r\nTool: Accessibility Insights for Windows Version 1.1.1741.1\n\n### Steps to reproduce\n\n**Repro Steps:**\r\n1. Open Windows Terminal.\r\n2. Open Settings page using 'Ctr+,'.\r\n3. Open Narrator using 'Win+Ctrl+ Enter' key. Turn ON Narrator scan mode using 'Caps lock + Space' key.\r\n4. Now navigate to 'Open JSON file' control and try to activate it then observe the issue.\r\n\r\n**User Experience:**\r\nScreen Reader users will be impacted here as they are not able to activate a control in scan mode which will not enhance the UX of those users.\r\n\r\n**Guideline Reference:**\r\nEN 301 549 V3.2.1: 11.5.2.12 Execution of available actions\r\n\r\n**Attachments:**\r\n[Uploading In scan mode, Screen Reader users are not able to open 'Open JSON file' control..zip…]()\n\n### Expected Behavior\n\nIn scan mode, Screen Reader users should be able to open 'Open JSON file' control using 'Enter' key.\n\n### Actual Behavior\n\nIn scan mode, Screen Reader users are not able to open 'Open JSON file' control using 'Enter' key. Screen Reader Users is only able to open JSON file in Scan off mode.\n", "patch": "diff --git a/src/cascadia/TerminalSettingsEditor/MainPage.cpp b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\nindex 5daf396b72e..054c8480ccf 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.cpp\n@@ -38,6 +38,7 @@ using namespace winrt::Windows::System;\n using namespace winrt::Windows::UI::Xaml::Controls;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static const std::wstring_view openJsonTag{ L\"OpenJson_Nav\" };\r\n static const std::wstring_view launchTag{ L\"Launch_Nav\" };\r\n static const std::wstring_view interactionTag{ L\"Interaction_Nav\" };\r\n static const std::wstring_view renderingTag{ L\"Rendering_Nav\" };\r\n@@ -324,6 +325,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \r\n             if (const auto navString = clickedItemContainer.Tag().try_as<hstring>())\r\n             {\r\n+                if (*navString == openJsonTag)\r\n+                {\r\n+                    const auto window = CoreWindow::GetForCurrentThread();\r\n+                    const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n+                    const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n+                    const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n+                                            WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n+                    const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n+                    OpenJson.raise(nullptr, target);\r\n+                    return;\r\n+                }\r\n                 _Navigate(*navString, BreadcrumbSubPage::None);\r\n             }\r\n             else if (const auto profile = clickedItemContainer.Tag().try_as<Editor::ProfileViewModel>())\r\n@@ -575,27 +587,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         }\r\n     }\r\n \r\n-    void MainPage::OpenJsonTapped(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& /*args*/)\r\n-    {\r\n-        const auto window = CoreWindow::GetForCurrentThread();\r\n-        const auto rAltState = window.GetKeyState(VirtualKey::RightMenu);\r\n-        const auto lAltState = window.GetKeyState(VirtualKey::LeftMenu);\r\n-        const auto altPressed = WI_IsFlagSet(lAltState, CoreVirtualKeyStates::Down) ||\r\n-                                WI_IsFlagSet(rAltState, CoreVirtualKeyStates::Down);\r\n-\r\n-        const auto target = altPressed ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-        OpenJson.raise(nullptr, target);\r\n-    }\r\n-\r\n-    void MainPage::OpenJsonKeyDown(const IInspectable& /*sender*/, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args)\r\n-    {\r\n-        if (args.Key() == VirtualKey::Enter || args.Key() == VirtualKey::Space)\r\n-        {\r\n-            const auto target = args.KeyStatus().IsMenuKeyDown ? SettingsTarget::DefaultsFile : SettingsTarget::SettingsFile;\r\n-            OpenJson.raise(nullptr, target);\r\n-        }\r\n-    }\r\n-\r\n     void MainPage::SaveButton_Click(const IInspectable& /*sender*/, const RoutedEventArgs& /*args*/)\r\n     {\r\n         _settingsClone.LogSettingChanges(false);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.h b/src/cascadia/TerminalSettingsEditor/MainPage.h\nindex 81724effb11..582f8813b1d 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.h\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.h\n@@ -30,8 +30,6 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n \n         void UpdateSettings(const Model::CascadiaSettings& settings);\n \n-        void OpenJsonKeyDown(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::KeyRoutedEventArgs& args);\n-        void OpenJsonTapped(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::Input::TappedRoutedEventArgs& args);\n         void SettingsNav_Loaded(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\n         void SettingsNav_ItemInvoked(const Microsoft::UI::Xaml::Controls::NavigationView& sender, const Microsoft::UI::Xaml::Controls::NavigationViewItemInvokedEventArgs& args);\n         void SaveButton_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& args);\ndiff --git a/src/cascadia/TerminalSettingsEditor/MainPage.xaml b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\nindex 3a0773062aa..c6d36e8f200 100644\n--- a/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/MainPage.xaml\n@@ -171,8 +171,8 @@\n             <!--  The OpenJson item needs both Tapped and KeyDown handler  -->\r\n             <muxc:NavigationViewItem x:Name=\"OpenJsonNavItem\"\r\n                                      x:Uid=\"Nav_OpenJSON\"\r\n-                                     KeyDown=\"OpenJsonKeyDown\"\r\n-                                     Tapped=\"OpenJsonTapped\">\r\n+                                     SelectsOnInvoked=\"False\"\r\n+                                     Tag=\"OpenJson_Nav\">\r\n                 <muxc:NavigationViewItem.Icon>\r\n                     <FontIcon Glyph=\"&#xE713;\" />\r\n                 </muxc:NavigationViewItem.Icon>\r\n", "instance_id": "microsoft__terminal-18828", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Screen Reader users are unable to activate the 'Open JSON file' control in scan mode using the 'Enter' key in Windows Terminal. It provides detailed steps to reproduce the issue, the expected behavior, and the actual behavior, along with relevant context about the environment and accessibility guidelines. However, there are minor ambiguities, such as the lack of explicit mention of specific edge cases (e.g., behavior with other keys or in different modes beyond scan mode) and no detailed explanation of the underlying cause or expected solution approach. While the goal is clear, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls in the easy range (0.2-0.4) due to the following factors:\n1. **Scope and Depth of Code Changes:** The changes are localized to a few files (`MainPage.cpp`, `MainPage.h`, and `MainPage.xaml`) and involve modifying event handling logic for a specific UI control. The diff shows a moderate amount of code change, primarily moving and adapting existing logic for handling key events (e.g., detecting 'Enter' keypress) into a new context within the navigation item invocation. It does not impact the broader system architecture.\n2. **Technical Concepts Involved:** The solution requires understanding of Windows UI XAML framework, event handling (e.g., `Tapped`, `KeyDown`, and navigation item invocation), and basic keyboard state management (e.g., detecting Alt key states). These are relatively straightforward concepts for someone familiar with Windows application development or UI programming, though they do require specific knowledge of the WinRT and XAML APIs.\n3. **Edge Cases and Error Handling:** The problem statement does not explicitly mention complex edge cases beyond the primary issue of scan mode activation. The code changes handle the basic requirement of detecting key states (e.g., Alt key for choosing between settings and defaults file), but no additional error handling or complex edge case logic is introduced.\n4. **Overall Complexity:** The task involves adapting existing logic to a new event context (NavigationView item invocation) rather than creating entirely new functionality. It requires understanding the intent behind the UI interaction but does not demand deep architectural changes or advanced algorithms.\nGiven these points, a score of 0.35 reflects an easy problem that requires some understanding of the codebase and UI event handling but is not particularly complex or far-reaching in impact.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "[Terminal Chat AI] Allow company wide disabling this feature \n<!-- \n🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨\n\nI ACKNOWLEDGE THE FOLLOWING BEFORE PROCEEDING:\n1. If I delete this entire template and go my own path, the core team may close my issue without further explanation or engagement.\n2. If I list multiple bugs/concerns in this one issue, the core team may close my issue without further explanation or engagement.\n3. If I write an issue that has many duplicates, the core team may close my issue without further explanation or engagement (and without necessarily spending time to find the exact duplicate ID number).\n4. If I leave the title incomplete when filing the issue, the core team may close my issue without further explanation or engagement.\n5. If I file something completely blank in the body, the core team may close my issue without further explanation or engagement.\n\nAll good? Then proceed!\n-->\n\n# Description of the new feature/enhancement\n\nSome companies don't allow the usage of AI features or software that has AI feature for privacy reasons. \n\nPlease implement a way to centrally force disable this feature.\n\n# Proposed technical implementation details (optional)\n\nThis can be a policy or HKLM registry value/setting that admins can use to easily disabled this feature for all users.\n\nThis setting should work for portable, store and manually installed versions and on all chanels.\n\n", "patch": "diff --git a/policies/WindowsTerminal.admx b/policies/WindowsTerminal.admx\nindex 48c36aec7eb..ccda3e0ffd7 100644\n--- a/policies/WindowsTerminal.admx\n+++ b/policies/WindowsTerminal.admx\n@@ -9,6 +9,7 @@\n   <supportedOn>\r\n     <definitions>\r\n       <definition name=\"SUPPORTED_WindowsTerminal_1_21\" displayName=\"$(string.SUPPORTED_WindowsTerminal_1_21)\" />\r\n+      <definition name=\"SUPPORTED_WindowsTerminalCanary_1_23\" displayName=\"$(string.SUPPORTED_WindowsTerminalCanary_1_23)\" />\r\n     </definitions>\r\n   </supportedOn>\r\n   <categories>\r\n@@ -24,5 +25,12 @@\n         <multiText id=\"DisabledProfileSources\" valueName=\"DisabledProfileSources\" required=\"true\" />\r\n       </elements>\r\n     </policy>\r\n+    <policy name=\"EnabledLMProviders\" class=\"Both\" displayName=\"$(string.EnabledLMProviders)\" explainText=\"$(string.EnabledLMProvidersText)\" presentation=\"$(presentation.EnabledLMProviders)\" key=\"Software\\Policies\\Microsoft\\Windows Terminal\">\r\n+      <parentCategory ref=\"WindowsTerminal\" />\r\n+      <supportedOn ref=\"SUPPORTED_WindowsTerminalCanary_1_23\" />\r\n+      <elements>\r\n+        <multiText id=\"EnabledLMProviders\" valueName=\"EnabledLMProviders\" required=\"false\" />\r\n+      </elements>\r\n+    </policy>\r\n   </policies>\r\n </policyDefinitions>\r\ndiff --git a/policies/en-US/WindowsTerminal.adml b/policies/en-US/WindowsTerminal.adml\nindex 5516292e123..089b4bdd7e2 100644\n--- a/policies/en-US/WindowsTerminal.adml\n+++ b/policies/en-US/WindowsTerminal.adml\n@@ -7,6 +7,7 @@\n     <stringTable>\r\n       <string id=\"WindowsTerminal\">Windows Terminal</string>\r\n       <string id=\"SUPPORTED_WindowsTerminal_1_21\">At least Windows Terminal 1.21</string>\r\n+      <string id=\"SUPPORTED_WindowsTerminalCanary_1_23\">At least Windows Terminal Canary 1.23</string>\r\n       <string id=\"DisabledProfileSources\">Disabled Profile Sources</string>\r\n       <string id=\"DisabledProfileSourcesText\">Profiles will not be generated from any sources listed here. Source names can be arbitrary strings. Potential candidates can be found as the \"source\" property on profile definitions in Windows Terminal's settings.json file.\r\n \r\n@@ -18,11 +19,25 @@ Common sources are:\n For instance, setting this policy to Windows.Terminal.Wsl will disable the builtin WSL integration of Windows Terminal.\r\n \r\n Note: Existing profiles will disappear from Windows Terminal after adding their source to this policy.</string>\r\n+      <string id=\"EnabledLMProviders\">Enabled Language Model/AI Providers</string>\r\n+      <string id=\"EnabledLMProvidersText\">The listed Language Models/AI Providers will be available for use in Terminal Chat.\r\n+\r\n+Enabling the policy but leaving the list empty disallows all providers and therefore disables the Terminal Chat feature completely.\r\n+\r\n+Common providers are:\r\n+- AzureOpenAI\r\n+- OpenAI\r\n+- GitHubCopilot\r\n+\r\n+For instance, setting this policy to GitHubCopilot will allow the use of GitHubCopilot in Terminal Chat.</string>\r\n     </stringTable>\r\n     <presentationTable>\r\n       <presentation id=\"DisabledProfileSources\">\r\n         <multiTextBox refId=\"DisabledProfileSources\">List of disabled sources (one per line)</multiTextBox>\r\n       </presentation>\r\n+      <presentation id=\"EnabledLMProviders\">\r\n+        <multiTextBox refId=\"EnabledLMProviders\">List of enabled Language Model/AI Providers (one per line)</multiTextBox>\r\n+      </presentation>\r\n     </presentationTable>\r\n   </resources>\r\n </policyDefinitionResources>\r\ndiff --git a/src/cascadia/QueryExtension/ExtensionPalette.cpp b/src/cascadia/QueryExtension/ExtensionPalette.cpp\nindex 29fec0e9c0d..9606a96d1ea 100644\n--- a/src/cascadia/QueryExtension/ExtensionPalette.cpp\n+++ b/src/cascadia/QueryExtension/ExtensionPalette.cpp\n@@ -99,16 +99,16 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n         _lmProvider = lmProvider;\n         _clearAndInitializeMessages(nullptr, nullptr);\n \n-        const auto brandingData = _lmProvider.BrandingData();\n-        const auto headerIconPath = brandingData.HeaderIconPath().empty() ? terminalChatLogoPath : brandingData.HeaderIconPath();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n+        const auto headerIconPath = (!brandingData || brandingData.HeaderIconPath().empty()) ? terminalChatLogoPath : brandingData.HeaderIconPath();\n         Windows::Foundation::Uri headerImageSourceUri{ headerIconPath };\n         Media::Imaging::BitmapImage headerImageSource{ headerImageSourceUri };\n         HeaderIcon().Source(headerImageSource);\n \n-        const auto headerText = brandingData.HeaderText().empty() ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n+        const auto headerText = (!brandingData || brandingData.HeaderText().empty()) ? RS_(L\"IntroText/Text\") : brandingData.HeaderText();\n         QueryIntro().Text(headerText);\n \n-        const auto subheaderText = brandingData.SubheaderText().empty() ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n+        const auto subheaderText = (!brandingData || brandingData.SubheaderText().empty()) ? RS_(L\"TitleSubheader/Text\") : brandingData.SubheaderText();\n         TitleSubheader().Text(subheaderText);\n     }\n \n@@ -234,9 +234,9 @@ namespace winrt::Microsoft::Terminal::Query::Extension::implementation\n             }\n         }\n \n-        const auto brandingData = _lmProvider.BrandingData();\n+        const auto brandingData = _lmProvider ? _lmProvider.BrandingData() : nullptr;\n         const auto responseAttribution = response.ResponseAttribution().empty() ? _ProfileName : response.ResponseAttribution();\n-        const auto badgeUriPath = _lmProvider ? brandingData.BadgeIconPath() : winrt::hstring{};\n+        const auto badgeUriPath = brandingData ? brandingData.BadgeIconPath() : L\"\";\n         const auto responseGroupedMessages = winrt::make<GroupedChatMessages>(time, false, winrt::single_threaded_vector(std::move(messageParts)), responseAttribution, badgeUriPath);\n         _messages.Append(responseGroupedMessages);\n \ndiff --git a/src/cascadia/TerminalApp/AppActionHandlers.cpp b/src/cascadia/TerminalApp/AppActionHandlers.cpp\nindex 36a2b20b5bf..1aeb8cb013e 100644\n--- a/src/cascadia/TerminalApp/AppActionHandlers.cpp\n+++ b/src/cascadia/TerminalApp/AppActionHandlers.cpp\n@@ -662,18 +662,23 @@ namespace winrt::TerminalApp::implementation\n     void TerminalPage::_HandleToggleAIChat(const IInspectable& /*sender*/,\r\n                                            const ActionEventArgs& args)\r\n     {\r\n-        if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n-        {\r\n-            _loadQueryExtension();\r\n-            ExtensionPresenter().Visibility(Visibility::Visible);\r\n-            _extensionPalette.Visibility(Visibility::Visible);\r\n-        }\r\n-        else\r\n+        args.Handled(false);\r\n+        // only handle this if the feature is allowed\r\n+        if (WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All))\r\n         {\r\n-            _extensionPalette.Visibility(Visibility::Collapsed);\r\n-            ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            if (ExtensionPresenter().Visibility() == Visibility::Collapsed)\r\n+            {\r\n+                _loadQueryExtension();\r\n+                ExtensionPresenter().Visibility(Visibility::Visible);\r\n+                _extensionPalette.Visibility(Visibility::Visible);\r\n+            }\r\n+            else\r\n+            {\r\n+                _extensionPalette.Visibility(Visibility::Collapsed);\r\n+                ExtensionPresenter().Visibility(Visibility::Collapsed);\r\n+            }\r\n+            args.Handled(true);\r\n         }\r\n-        args.Handled(true);\r\n     }\r\n \r\n     void TerminalPage::_HandleSetColorScheme(const IInspectable& /*sender*/,\r\ndiff --git a/src/cascadia/TerminalApp/TerminalPage.cpp b/src/cascadia/TerminalApp/TerminalPage.cpp\nindex f17d32cdea5..fbb1d62c829 100644\n--- a/src/cascadia/TerminalApp/TerminalPage.cpp\n+++ b/src/cascadia/TerminalApp/TerminalPage.cpp\n@@ -989,58 +989,61 @@ namespace winrt::TerminalApp::implementation\n                 _SetAcceleratorForMenuItem(commandPaletteFlyout, commandPaletteKeyChord);\n             }\n \n-            // Create the AI chat button.\n-            auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n-            AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n-            const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n-\n-            WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n-            Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n-\n-            // BODGY\n-            // Manually load this icon from an SVG path; it is ironically much more humane this way.\n-            // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n-            // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n-            {\n-                static constexpr wil::zwstring_view pathSVG{\n-                    L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n-                    \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n-                    \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n-                    \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n-                    \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n-                    \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n-                    \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n-                    \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n-                    \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n-                    \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n-                    \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n-                    \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n-                    \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n-                    \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n-                    \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n-                    \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n-                    \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n-                    \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n-                    \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n-                };\n-                try\n+            // Create the AI chat button if AI features are allowed\n+            if (WI_IsAnyFlagSet(_settings.GlobalSettings().AIInfo().AllowedLMProviders(), EnabledLMProviders::All))\n+            {\n+                auto AIChatFlyout = WUX::Controls::MenuFlyoutItem{};\n+                AIChatFlyout.Text(RS_(L\"AIChatMenuItem\"));\n+                const auto AIChatToolTip = RS_(L\"AIChatToolTip\");\n+\n+                WUX::Controls::ToolTipService::SetToolTip(AIChatFlyout, box_value(AIChatToolTip));\n+                Automation::AutomationProperties::SetHelpText(AIChatFlyout, AIChatToolTip);\n+\n+                // BODGY\n+                // Manually load this icon from an SVG path; it is ironically much more humane this way.\n+                // The XAML resource loader can't resolve theme-light/theme-dark for us, for... well, reasons.\n+                // But also, you can't load a PathIcon with a *string* using the WinRT API... well. Reasons.\n                 {\n-                    hstring hsPathSVG{ pathSVG };\n-                    auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n-                    WUX::Controls::PathIcon pathIcon;\n-                    pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n-                    AIChatFlyout.Icon(pathIcon);\n+                    static constexpr wil::zwstring_view pathSVG{\n+                        L\"m11.799 0c1.4358 0 2.5997 1.1639 2.5997 2.5997\"\n+                        \"v4.6161c-0.3705-0.2371-0.7731-0.42843-1.1998-0.56618\"\n+                        \"v-2.2501h-11.999v7.3991c0 0.7731 0.62673 1.3999 1.3998 1.3999\"\n+                        \"h4.0503c0.06775 0.2097 0.14838 0.4137 0.24109 0.6109l-0.17934 0.5889\"\n+                        \"h-4.1121c-1.4358 0-2.5997-1.1639-2.5997-2.5997\"\n+                        \"v-9.1989c0-1.4358 1.1639-2.5997 2.5997-2.5997\"\n+                        \"h9.1989zm0 1.1999h-9.1989c-0.77311 0-1.3998 0.62673-1.3998 1.3998\"\n+                        \"v0.59993h11.999v-0.59993c0-0.77311-0.6267-1.3998-1.3999-1.3998\"\n+                        \"zm1.3999 6.2987c0.4385 0.1711 0.8428 0.41052 1.1998 0.70512 0.9782 \"\n+                        \"0.80711 1.6017 2.0287 1.6017 3.3959 0 2.4304-1.9702 4.4005-4.4005 \"\n+                        \"4.4005-0.7739 0-1.5013-0.1998-2.1332-0.5508l-1.7496 0.5325c-0.30612 \"\n+                        \"0.0931-0.59233-0.1931-0.49914-0.4993l0.53258-1.749c-0.35108-0.6321-0.55106-1.3596-0.55106-2.1339 \"\n+                        \"0-2.3834 1.8949-4.3243 4.2604-4.3983 0.0395-0.0012 0.0792-0.00192 \"\n+                        \"0.1191-0.00208 0.0069-8e-5 0.0139-8e-5 0.0208-8e-5 0.5641 0 1.1034 \"\n+                        \"0.10607 1.599 0.2994zm0.0012 3.701c0.2209 0 0.4-0.1791 0.4-0.4 \"\n+                        \"0-0.221-0.1791-0.4001-0.4-0.4001h-3.2003c-0.22094 0-0.40003 0.1791-0.40003 \"\n+                        \"0.4001 0 0.2209 0.17909 0.4 0.40003 0.4h3.2003zm-3.2003 1.6001h1.6001c0.221 \"\n+                        \"0 0.4001-0.1791 0.4001-0.4s-0.1791-0.4-0.4001-0.4h-1.6001c-0.22094 0-0.40003 \"\n+                        \"0.1791-0.40003 0.4s0.17909 0.4 0.40003 0.4z\"\n+                    };\n+                    try\n+                    {\n+                        hstring hsPathSVG{ pathSVG };\n+                        auto geometry = Markup::XamlBindingHelper::ConvertValue(winrt::xaml_typename<WUX::Media::Geometry>(), winrt::box_value(hsPathSVG));\n+                        WUX::Controls::PathIcon pathIcon;\n+                        pathIcon.Data(geometry.try_as<WUX::Media::Geometry>());\n+                        AIChatFlyout.Icon(pathIcon);\n+                    }\n+                    CATCH_LOG();\n                 }\n-                CATCH_LOG();\n-            }\n \n-            AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n-            newTabFlyout.Items().Append(AIChatFlyout);\n+                AIChatFlyout.Click({ this, &TerminalPage::_AIChatButtonOnClick });\n+                newTabFlyout.Items().Append(AIChatFlyout);\n \n-            const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n-            if (AIChatKeyChord)\n-            {\n-                _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                const auto AIChatKeyChord{ actionMap.GetKeyBindingForAction(L\"Terminal.OpenTerminalChat\") };\n+                if (AIChatKeyChord)\n+                {\n+                    _SetAcceleratorForMenuItem(AIChatFlyout, AIChatKeyChord);\n+                }\n             }\n \n             // Create the about button.\n@@ -5755,31 +5758,34 @@ namespace winrt::TerminalApp::implementation\n             }\n         }\n \n-        // we now have a provider of the correct type, update that\n-        winrt::hstring newAuthValues = authValuesString;\n-        if (newAuthValues.empty())\n+        if (_lmProvider)\n         {\n-            Windows::Data::Json::JsonObject authValuesJson;\n-            const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n-            switch (providerType)\n+            // we now have a provider of the correct type, update that\n+            winrt::hstring newAuthValues = authValuesString;\n+            if (newAuthValues.empty())\n             {\n-            case LLMProvider::AzureOpenAI:\n-                authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::OpenAI:\n-                authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n-                newAuthValues = authValuesJson.ToString();\n-                break;\n-            case LLMProvider::GithubCopilot:\n-                newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n-                break;\n-            default:\n-                break;\n+                Windows::Data::Json::JsonObject authValuesJson;\n+                const auto settingsAIInfo = _settings.GlobalSettings().AIInfo();\n+                switch (providerType)\n+                {\n+                case LLMProvider::AzureOpenAI:\n+                    authValuesJson.SetNamedValue(L\"endpoint\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIEndpoint()));\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.AzureOpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::OpenAI:\n+                    authValuesJson.SetNamedValue(L\"key\", WDJ::JsonValue::CreateStringValue(settingsAIInfo.OpenAIKey()));\n+                    newAuthValues = authValuesJson.ToString();\n+                    break;\n+                case LLMProvider::GithubCopilot:\n+                    newAuthValues = settingsAIInfo.GithubCopilotAuthValues();\n+                    break;\n+                default:\n+                    break;\n+                }\n             }\n+            _lmProvider.SetAuthentication(newAuthValues);\n         }\n-        _lmProvider.SetAuthentication(newAuthValues);\n \n         if (_extensionPalette)\n         {\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettings.xaml b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\nindex 676071a0930..c99020d6b97 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n+++ b/src/cascadia/TerminalSettingsEditor/AISettings.xaml\n@@ -40,8 +40,9 @@\n                            Style=\"{StaticResource TextBlockSubHeaderStyle}\" />\r\n                 <!--  GitHub Copilot  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_GithubCopilot\"\r\n-                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\"\r\n-                                        Visibility=\"{x:Bind ViewModel.GithubCopilotFeatureEnabled}\">\r\n+                                        CurrentValue=\"{x:Bind ViewModel.GithubCopilotStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.GithubCopilotAllowed}\"\r\n+                                        Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreGithubCopilotTokensSet, Mode=OneWay}\">\r\n                             <Grid.ColumnDefinitions>\r\n@@ -137,6 +138,8 @@\n                 </local:SettingContainer>\r\n                 <!--  Azure OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_AzureOpenAIKeyAndEndpoint\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.AzureOpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.AzureOpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.AreAzureOpenAIKeyAndEndpointSet, Mode=OneWay}\">\r\n@@ -261,6 +264,8 @@\n                 </local:SettingContainer>\r\n                 <!--  OpenAI  -->\r\n                 <local:SettingContainer x:Uid=\"AISettings_OpenAIKey\"\r\n+                                        CurrentValue=\"{x:Bind ViewModel.OpenAIStatus, Mode=OneWay}\"\r\n+                                        IsEnabled=\"{x:Bind ViewModel.OpenAIAllowed}\"\r\n                                         Style=\"{StaticResource ExpanderSettingContainerStyle}\">\r\n                     <StackPanel>\r\n                         <Grid Visibility=\"{x:Bind ViewModel.IsOpenAIKeySet, Mode=OneWay}\">\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\nindex 85ac83dc138..9a7df4b771c 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.cpp\n@@ -17,6 +17,8 @@ using namespace winrt::Windows::UI::Xaml::Controls;\n using namespace winrt::Microsoft::Terminal::Settings::Model;\r\n using namespace winrt::Windows::Foundation::Collections;\r\n \r\n+static constexpr std::wstring_view lockGlyph{ L\"\\uE72E\" };\r\n+\r\n namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\r\n {\r\n     AISettingsViewModel::AISettingsViewModel(Model::CascadiaSettings settings) :\r\n@@ -38,7 +40,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIEndpoint(winrt::hstring endpoint)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIEndpoint(endpoint);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n     }\r\n \r\n     winrt::hstring AISettingsViewModel::AzureOpenAIKey()\r\n@@ -49,7 +51,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::AzureOpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().AzureOpenAIKey(key);\r\n-        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\");\r\n+        _NotifyChanges(L\"AreAzureOpenAIKeyAndEndpointSet\", L\"AzureOpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::AzureOpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::AzureOpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::AzureOpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::AzureOpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsOpenAIKeySet()\r\n@@ -65,7 +77,17 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::OpenAIKey(winrt::hstring key)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().OpenAIKey(key);\r\n-        _NotifyChanges(L\"IsOpenAIKeySet\");\r\n+        _NotifyChanges(L\"IsOpenAIKeySet\", L\"OpenAIStatus\");\r\n+    }\r\n+\r\n+    bool AISettingsViewModel::OpenAIAllowed() const noexcept\r\n+    {\r\n+        return WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::OpenAI);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::OpenAIStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::OpenAI);\r\n     }\r\n \r\n     bool AISettingsViewModel::AzureOpenAIActive()\r\n@@ -78,8 +100,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::AzureOpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::OpenAIActive()\r\n@@ -92,8 +118,12 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::OpenAI);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::AreGithubCopilotTokensSet()\r\n@@ -109,7 +139,7 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::GithubCopilotAuthValues(winrt::hstring authValues)\r\n     {\r\n         _Settings.GlobalSettings().AIInfo().GithubCopilotAuthValues(authValues);\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n     bool AISettingsViewModel::GithubCopilotActive()\r\n@@ -122,13 +152,22 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         if (active)\r\n         {\r\n             _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::GithubCopilot);\r\n-            _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\");\r\n         }\r\n+        else\r\n+        {\r\n+            _Settings.GlobalSettings().AIInfo().ActiveProvider(Model::LLMProvider::None);\r\n+        }\r\n+        _NotifyChanges(L\"AzureOpenAIActive\", L\"OpenAIActive\", L\"GithubCopilotActive\", L\"AzureOpenAIStatus\", L\"OpenAIStatus\", L\"GithubCopilotStatus\");\r\n     }\r\n \r\n-    bool AISettingsViewModel::GithubCopilotFeatureEnabled()\r\n+    bool AISettingsViewModel::GithubCopilotAllowed() const noexcept\r\n     {\r\n-        return Feature_GithubCopilot::IsEnabled();\r\n+        return Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::GithubCopilot);\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::GithubCopilotStatus()\r\n+    {\r\n+        return _getStatusHelper(Model::LLMProvider::GithubCopilot);\r\n     }\r\n \r\n     bool AISettingsViewModel::IsTerminalPackaged()\r\n@@ -152,6 +191,55 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n     void AISettingsViewModel::_OnGithubAuthCompleted(const winrt::hstring& message)\r\n     {\r\n         _githubCopilotAuthMessage = message;\r\n-        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\");\r\n+        _NotifyChanges(L\"AreGithubCopilotTokensSet\", L\"GithubCopilotAuthMessage\", L\"GithubCopilotStatus\");\r\n+    }\r\n+\r\n+    winrt::hstring AISettingsViewModel::_getStatusHelper(const Model::LLMProvider provider)\r\n+    {\r\n+        bool allowed;\r\n+        bool active;\r\n+        bool loggedIn;\r\n+        switch (provider)\r\n+        {\r\n+        case LLMProvider::AzureOpenAI:\r\n+            allowed = AzureOpenAIAllowed();\r\n+            active = AzureOpenAIActive();\r\n+            loggedIn = AreAzureOpenAIKeyAndEndpointSet();\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            allowed = OpenAIAllowed();\r\n+            active = OpenAIActive();\r\n+            loggedIn = IsOpenAIKeySet();\r\n+            break;\r\n+        case LLMProvider::GithubCopilot:\r\n+            allowed = GithubCopilotAllowed();\r\n+            active = GithubCopilotActive();\r\n+            loggedIn = AreGithubCopilotTokensSet();\r\n+            break;\r\n+        default:\r\n+            return L\"\";\r\n+        }\r\n+\r\n+        if (!allowed)\r\n+        {\r\n+            // not allowed, display the lock glyph\r\n+            return winrt::hstring{ lockGlyph } + L\" \" + RS_(L\"AISettings_ProviderNotAllowed\");\r\n+        }\r\n+        else if (active && loggedIn)\r\n+        {\r\n+            // active provider and logged in\r\n+            return RS_(L\"AISettings_ActiveLoggedIn\");\r\n+        }\r\n+        else if (active)\r\n+        {\r\n+            // active provider, not logged in\r\n+            return RS_(L\"AISettings_Active\");\r\n+        }\r\n+        else if (loggedIn)\r\n+        {\r\n+            // logged in, not active provider\r\n+            return RS_(L\"AISettings_LoggedIn\");\r\n+        }\r\n+        return L\"\";\r\n     }\r\n }\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\nindex 41e8e7379b5..a0822dc65a3 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.h\n@@ -24,27 +24,34 @@ namespace winrt::Microsoft::Terminal::Settings::Editor::implementation\n         void AzureOpenAIKey(winrt::hstring key);\r\n         bool AzureOpenAIActive();\r\n         void AzureOpenAIActive(bool active);\r\n+        bool AzureOpenAIAllowed() const noexcept;\r\n+        winrt::hstring AzureOpenAIStatus();\r\n \r\n         bool IsOpenAIKeySet();\r\n         winrt::hstring OpenAIKey();\r\n         void OpenAIKey(winrt::hstring key);\r\n         bool OpenAIActive();\r\n         void OpenAIActive(bool active);\r\n+        bool OpenAIAllowed() const noexcept;\r\n+        winrt::hstring OpenAIStatus();\r\n \r\n         bool AreGithubCopilotTokensSet();\r\n         winrt::hstring GithubCopilotAuthMessage();\r\n         void GithubCopilotAuthValues(winrt::hstring authValues);\r\n         bool GithubCopilotActive();\r\n         void GithubCopilotActive(bool active);\r\n-        bool GithubCopilotFeatureEnabled();\r\n+        bool GithubCopilotAllowed() const noexcept;\r\n         bool IsTerminalPackaged();\r\n         void InitiateGithubAuth_Click(const Windows::Foundation::IInspectable& sender, const Windows::UI::Xaml::RoutedEventArgs& e);\r\n         til::typed_event<Windows::Foundation::IInspectable, Windows::Foundation::IInspectable> GithubAuthRequested;\r\n+        winrt::hstring GithubCopilotStatus();\r\n \r\n     private:\r\n         Model::CascadiaSettings _Settings;\r\n         winrt::hstring _githubCopilotAuthMessage;\r\n \r\n+        winrt::hstring _getStatusHelper(const winrt::Microsoft::Terminal::Settings::Model::LLMProvider provider);\r\n+\r\n         winrt::Microsoft::Terminal::Settings::Editor::MainPage::GithubAuthCompleted_revoker _githubAuthCompleteRevoker;\r\n \r\n         void _OnGithubAuthCompleted(const winrt::hstring& message);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\nindex 6a31438ae84..3844b549800 100644\n--- a/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n+++ b/src/cascadia/TerminalSettingsEditor/AISettingsViewModel.idl\n@@ -15,16 +15,21 @@ namespace Microsoft.Terminal.Settings.Editor\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         Boolean AzureOpenAIActive;\r\n+        Boolean AzureOpenAIAllowed { get; };\r\n+        String AzureOpenAIStatus { get; };\r\n \r\n         Boolean IsOpenAIKeySet { get; };\r\n         String OpenAIKey;\r\n         Boolean OpenAIActive;\r\n+        Boolean OpenAIAllowed { get; };\r\n+        String OpenAIStatus { get; };\r\n \r\n         Boolean AreGithubCopilotTokensSet { get; };\r\n         String GithubCopilotAuthMessage { get; };\r\n         void GithubCopilotAuthValues(String authValues);\r\n         Boolean GithubCopilotActive;\r\n-        Boolean GithubCopilotFeatureEnabled { get; };\r\n+        Boolean GithubCopilotAllowed { get; };\r\n+        String GithubCopilotStatus { get; };\r\n         Boolean IsTerminalPackaged { get; };\r\n \r\n         void InitiateGithubAuth_Click(IInspectable sender, Windows.UI.Xaml.RoutedEventArgs args);\r\ndiff --git a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\nindex 61c71d8a176..1eb01d86b1e 100644\n--- a/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n+++ b/src/cascadia/TerminalSettingsEditor/Resources/en-US/Resources.resw\n@@ -792,6 +792,22 @@\n     <value>Awaiting authentication completion from browser...</value>\r\n     <comment>Text displayed after the user clicks the button to initiate the GitHub authentication flow in their browser.</comment>\r\n   </data>\r\n+  <data name=\"AISettings_Active\" xml:space=\"preserve\">\r\n+    <value>Active</value>\r\n+    <comment>Text displayed when the service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_LoggedIn\" xml:space=\"preserve\">\r\n+    <value>Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ActiveLoggedIn\" xml:space=\"preserve\">\r\n+    <value>Active, Logged in</value>\r\n+    <comment>Text displayed when the user is logged in to the service provider and that service provider is active.</comment>\r\n+  </data>\r\n+  <data name=\"AISettings_ProviderNotAllowed\" xml:space=\"preserve\">\r\n+    <value>Disabled by your administrator</value>\r\n+    <comment>Text displayed when the service provider has been disabled by the administrator.</comment>\r\n+  </data>\r\n   <data name=\"AISettings_PortableModeDisclaimer.Text\" xml:space=\"preserve\">\r\n     <value>Unable to authenticate to GitHub in unpackaged mode. Please launch Terminal as a packaged application to authenticate.</value>\r\n     <comment>Text displayed to the user when Terminal is un unpackaged mode.</comment>\r\n@@ -2109,4 +2125,4 @@\n     <value>Display a shield in the title bar when Windows Terminal is running as Administrator</value>\r\n     <comment>Header for a control to toggle displaying a shield in the title bar of the app. \"Admin\" refers to elevated sessions like \"run as Admin\"</comment>\r\n   </data>\r\n-</root>\n\\ No newline at end of file\n+</root>\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.cpp b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\nindex 7af8678a3b4..562592b05d0 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.cpp\n@@ -19,6 +19,45 @@ static constexpr wil::zwstring_view PasswordVaultAIEndpoint = L\"TerminalAIEndpoi\n static constexpr wil::zwstring_view PasswordVaultOpenAIKey = L\"TerminalOpenAIKey\";\r\n static constexpr wil::zwstring_view PasswordVaultGithubCopilotAuthValues = L\"TerminalGithubCopilotAuthValues\";\r\n \r\n+// When new LM providers are added here, make sure you also update the admx/adml!\r\n+static constexpr wil::zwstring_view AzureOpenAIPolicyKey = L\"AzureOpenAI\";\r\n+static constexpr wil::zwstring_view OpenAIPolicyKey = L\"OpenAI\";\r\n+static constexpr wil::zwstring_view GitHubCopilotPolicyKey = L\"GitHubCopilot\";\r\n+\r\n+winrt::Microsoft::Terminal::Settings::Model::EnabledLMProviders AIConfig::AllowedLMProviders() noexcept\r\n+{\r\n+    Model::EnabledLMProviders enabledLMProviders{ Model::EnabledLMProviders::All };\r\n+    // get our allowed list of LM providers from the registry\r\n+    for (const auto key : { HKEY_LOCAL_MACHINE, HKEY_CURRENT_USER })\r\n+    {\r\n+        wchar_t buffer[512]; // \"640K ought to be enough for anyone\"\r\n+        DWORD bufferSize = sizeof(buffer);\r\n+        if (RegGetValueW(key, LR\"(Software\\Policies\\Microsoft\\Windows Terminal)\", L\"EnabledLMProviders\", RRF_RT_REG_MULTI_SZ, nullptr, buffer, &bufferSize) == 0)\r\n+        {\r\n+            WI_ClearAllFlags(enabledLMProviders, Model::EnabledLMProviders::All);\r\n+            for (auto p = buffer; *p;)\r\n+            {\r\n+                const std::wstring_view value{ p };\r\n+                if (value == AzureOpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::AzureOpenAI);\r\n+                }\r\n+                else if (value == OpenAIPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::OpenAI);\r\n+                }\r\n+                else if (value == GitHubCopilotPolicyKey)\r\n+                {\r\n+                    WI_SetFlag(enabledLMProviders, Model::EnabledLMProviders::GithubCopilot);\r\n+                }\r\n+                p += value.size() + 1;\r\n+            }\r\n+            break;\r\n+        }\r\n+    }\r\n+    return enabledLMProviders;\r\n+}\r\n+\r\n winrt::com_ptr<AIConfig> AIConfig::CopyAIConfig(const AIConfig* source)\r\n {\r\n     auto aiConfig{ winrt::make_self<AIConfig>() };\r\n@@ -108,16 +147,36 @@ winrt::hstring AIConfig::GithubCopilotAuthValues()\n \r\n winrt::Microsoft::Terminal::Settings::Model::LLMProvider AIConfig::ActiveProvider()\r\n {\r\n+    const auto allowedLMProviders = AllowedLMProviders();\r\n     const auto val{ _getActiveProviderImpl() };\r\n     if (val)\r\n     {\r\n-        // an active provider was explicitly set, return that\r\n-        // special case: only allow github copilot if the feature is enabled\r\n-        if (*val == LLMProvider::GithubCopilot && !Feature_GithubCopilot::IsEnabled())\r\n+        const auto setProvider = *val;\r\n+        // an active provider was explicitly set, return that as long as it is allowed\r\n+        switch (setProvider)\r\n         {\r\n-            return LLMProvider{};\r\n+        case LLMProvider::GithubCopilot:\r\n+            if (Feature_GithubCopilot::IsEnabled() && WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::GithubCopilot))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::AzureOpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::AzureOpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        case LLMProvider::OpenAI:\r\n+            if (WI_IsFlagSet(allowedLMProviders, EnabledLMProviders::OpenAI))\r\n+            {\r\n+                return setProvider;\r\n+            }\r\n+            break;\r\n+        default:\r\n+            break;\r\n         }\r\n-        return *val;\r\n+        return LLMProvider{};\r\n     }\r\n     else if (!AzureOpenAIEndpoint().empty() && !AzureOpenAIKey().empty())\r\n     {\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.h b/src/cascadia/TerminalSettingsModel/AIConfig.h\nindex 5bcf5868af4..5d1cf9e1767 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.h\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.h\n@@ -33,6 +33,8 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         Json::Value ToJson() const;\r\n         void LayerJson(const Json::Value& json);\r\n \r\n+        static Model::EnabledLMProviders AllowedLMProviders() noexcept;\r\n+\r\n         // Key and endpoint storage\r\n         // These are not written to the json, they are stored in the Windows Security Storage Vault\r\n         winrt::hstring AzureOpenAIEndpoint() noexcept;\r\n@@ -58,6 +60,7 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n         _BASE_INHERITABLE_SETTING(Model::AIConfig, std::optional<LLMProvider>, ActiveProvider);\r\n \r\n     private:\r\n+        Model::EnabledLMProviders _enabledLMProviders{ Model::EnabledLMProviders::All };\r\n         winrt::hstring _RetrieveCredential(const wil::zwstring_view credential);\r\n         void _SetCredential(const wil::zwstring_view credential, const winrt::hstring& value);\r\n         std::unordered_map<std::wstring, std::wstring> _credentialCache;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/AIConfig.idl b/src/cascadia/TerminalSettingsModel/AIConfig.idl\nindex e3f15435591..f4ee727eece 100644\n--- a/src/cascadia/TerminalSettingsModel/AIConfig.idl\n+++ b/src/cascadia/TerminalSettingsModel/AIConfig.idl\n@@ -7,17 +7,28 @@ namespace Microsoft.Terminal.Settings.Model\n {\r\n     enum LLMProvider\r\n     {\r\n+        None,\r\n         AzureOpenAI,\n         OpenAI,\r\n         GithubCopilot\n     };\r\n \r\n+    [flags] enum EnabledLMProviders\r\n+    {\r\n+        AzureOpenAI = 0x1,\r\n+        OpenAI = 0x2,\r\n+        GithubCopilot = 0x4,\r\n+        All = 0xffffffff\r\n+    };\r\n+\r\n     delegate void AzureOpenAISettingChangedHandler();\r\n     delegate void OpenAISettingChangedHandler();\r\n \r\n     [default_interface] runtimeclass AIConfig {\r\n         INHERITABLE_SETTING(LLMProvider, ActiveProvider);\r\n \r\n+        static EnabledLMProviders AllowedLMProviders { get; };\r\n+\r\n         String AzureOpenAIEndpoint;\r\n         String AzureOpenAIKey;\r\n         static event AzureOpenAISettingChangedHandler AzureOpenAISettingChanged;\r\ndiff --git a/src/cascadia/TerminalSettingsModel/ActionMap.cpp b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\nindex bebe9ac76bd..4a212aa4edd 100644\n--- a/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n+++ b/src/cascadia/TerminalSettingsModel/ActionMap.cpp\n@@ -348,11 +348,18 @@ namespace winrt::Microsoft::Terminal::Settings::Model::implementation\n     // - Actions of the parents are overridden by the children\r\n     void ActionMap::_PopulateCumulativeActionMap(std::unordered_map<hstring, Model::Command>& actionMap)\r\n     {\r\n+        // special case: don't add any ToggleAIChat actions if the feature has been disabled\r\n+        // note: we only refuse to add these actions to the cumulative action map, that way we don't remove them from the user's settings file\r\n+        // this means that these actions won't show up in the command palette, but any keybindings/modifications/etc to them will persist\r\n+        const auto terminalChatDisabled = !WI_IsAnyFlagSet(AIConfig::AllowedLMProviders(), EnabledLMProviders::All);\r\n         for (const auto& [cmdID, cmd] : _ActionMap)\r\n         {\r\n             if (!actionMap.contains(cmdID))\r\n             {\r\n-                actionMap.emplace(cmdID, cmd);\r\n+                if (!terminalChatDisabled || cmd.ActionAndArgs().Action() != ShortcutAction::ToggleAIChat)\r\n+                {\r\n+                    actionMap.emplace(cmdID, cmd);\r\n+                }\r\n             }\r\n         }\r\n \r\n", "instance_id": "microsoft__terminal-18095", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in its intent to implement a feature for centrally disabling the Terminal Chat AI functionality across a company. It specifies the goal of allowing administrators to disable the feature via a policy or registry setting and mentions compatibility with various installation types and channels. However, there are minor ambiguities and missing details. For instance, it does not explicitly define how the policy should interact with existing user configurations or whether there are specific security or logging requirements when the feature is disabled. Additionally, while the proposed technical implementation is mentioned (policy or HKLM registry value), it lacks specifics on expected behavior if the policy is partially set or misconfigured. There are no examples or detailed constraints provided, which could lead to assumptions during implementation. Overall, the statement is valid and clear in its primary objective but misses some finer details and edge case considerations.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files and modules, including policy definitions (ADMX/ADML files), UI components, settings management, and core application logic in a Windows Terminal codebase, likely written in C++. This requires understanding interactions between policy settings, registry values, and application behavior, as well as modifying both frontend and backend components. The changes involve a moderate amount of code, with significant updates to handle feature toggling based on policy settings and ensuring that UI elements (like the AI chat button) and functionality are conditionally available.\n\nTechnically, the problem requires familiarity with several concepts: Windows registry and group policy management (for implementing the disable feature), WinRT and XAML for UI modifications, and the specific architecture of the Windows Terminal application for integrating these changes without breaking existing functionality. The code changes also introduce conditional logic to check for allowed AI providers, which adds complexity in terms of state management and ensuring consistency across different parts of the application.\n\nEdge cases and error handling add to the difficulty. The problem does not explicitly mention edge cases, but the code changes suggest scenarios like partial policy configurations, conflicts between user settings and admin policies, or handling cases where the feature is disabled mid-session. These require careful consideration to avoid unexpected behavior or crashes, especially in a multi-user or enterprise environment. While the problem does not appear to impact the core architecture significantly or require advanced algorithms, the need to ensure robustness across different installation types (portable, store, manual) and channels increases the complexity.\n\nOverall, this task is not trivial but also not extremely challenging. It requires a solid understanding of the codebase and multiple technical domains, placing it in the medium difficulty range of 0.55. It is more complex than a simple bug fix or feature addition but does not reach the level of a major architectural refactor or highly specialized domain knowledge.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Search results steal focus and scroll when the buffer changes at all\n### Windows Terminal version\n\n1.21.1272.0\n\n### Windows build number\n\n10.0.22631.0\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n- Fill the buffer with enough text to make it scrollable (for example, using `Get-Random -Count 1000` in PowerShell),\r\n- search something in such a way that the last result is outside the view,\r\n- select a search result which is not the last (optinal),\r\n- type something in the prompt.\n\n### Expected Behavior\n\nWhile typing in the prompt nothing happen, the select result stays the same, and the view focus the prompt.\n\n### Actual Behavior\n\nWhen typing, the search appear to retrigger, and the focus goes to the last result, moving the prompt outside view.\n", "patch": "diff --git a/src/buffer/out/search.cpp b/src/buffer/out/search.cpp\nindex 31c7081b2b9..75143f047ca 100644\n--- a/src/buffer/out/search.cpp\n+++ b/src/buffer/out/search.cpp\n@@ -16,7 +16,7 @@ bool Search::IsStale(const Microsoft::Console::Render::IRenderData& renderData,\n            _lastMutationId != renderData.GetTextBuffer().GetLastMutationId();\r\n }\r\n \r\n-bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n+void Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse)\r\n {\r\n     const auto& textBuffer = renderData.GetTextBuffer();\r\n \r\n@@ -30,15 +30,15 @@ bool Search::Reset(Microsoft::Console::Render::IRenderData& renderData, const st\n     _results = std::move(result).value_or(std::vector<til::point_span>{});\r\n     _index = reverse ? gsl::narrow_cast<ptrdiff_t>(_results.size()) - 1 : 0;\r\n     _step = reverse ? -1 : 1;\r\n-    return true;\r\n-}\r\n \r\n-void Search::MoveToCurrentSelection()\r\n-{\r\n     if (_renderData->IsSelectionActive())\r\n     {\r\n         MoveToPoint(_renderData->GetTextBuffer().ScreenToBufferPosition(_renderData->GetSelectionAnchor()));\r\n     }\r\n+    else if (const auto span = _renderData->GetSearchHighlightFocused())\r\n+    {\r\n+        MoveToPoint(_step > 0 ? span->start : span->end);\r\n+    }\r\n }\r\n \r\n void Search::MoveToPoint(const til::point anchor) noexcept\r\ndiff --git a/src/buffer/out/search.h b/src/buffer/out/search.h\nindex 763b5d40c73..304de1ab889 100644\n--- a/src/buffer/out/search.h\n+++ b/src/buffer/out/search.h\n@@ -36,9 +36,8 @@ class Search final\n     Search() = default;\r\n \r\n     bool IsStale(const Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags) const noexcept;\r\n-    bool Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n+    void Reset(Microsoft::Console::Render::IRenderData& renderData, const std::wstring_view& needle, SearchFlag flags, bool reverse);\r\n \r\n-    void MoveToCurrentSelection();\r\n     void MoveToPoint(til::point anchor) noexcept;\r\n     void MovePastPoint(til::point anchor) noexcept;\r\n     void FindNext(bool reverse) noexcept;\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.cpp b/src/cascadia/TerminalControl/ControlCore.cpp\nindex cd4f5f58b81..5d379ba6c5e 100644\n--- a/src/cascadia/TerminalControl/ControlCore.cpp\n+++ b/src/cascadia/TerminalControl/ControlCore.cpp\n@@ -1697,38 +1697,41 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     SearchResults ControlCore::Search(SearchRequest request)\r\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n+\r\n         SearchFlag flags{};\r\n         WI_SetFlagIf(flags, SearchFlag::CaseInsensitive, !request.CaseSensitive);\r\n         WI_SetFlagIf(flags, SearchFlag::RegularExpression, request.RegularExpression);\r\n         const auto searchInvalidated = _searcher.IsStale(*_terminal.get(), request.Text, flags);\r\n \r\n-        if (searchInvalidated || !request.Reset)\r\n+        if (searchInvalidated || !request.ResetOnly)\r\n         {\r\n             std::vector<til::point_span> oldResults;\r\n+            til::point_span oldFocused;\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused())\r\n+            {\r\n+                oldFocused = *focused;\r\n+            }\r\n \r\n             if (searchInvalidated)\r\n             {\r\n                 oldResults = _searcher.ExtractResults();\r\n                 _searcher.Reset(*_terminal.get(), request.Text, flags, !request.GoForward);\r\n-\r\n-                if (SnapSearchResultToSelection())\r\n-                {\r\n-                    _searcher.MoveToCurrentSelection();\r\n-                    SnapSearchResultToSelection(false);\r\n-                }\r\n-\r\n                 _terminal->SetSearchHighlights(_searcher.Results());\r\n             }\r\n-            else\r\n+\r\n+            if (!request.ResetOnly)\r\n             {\r\n                 _searcher.FindNext(!request.GoForward);\r\n             }\r\n \r\n-            if (const auto idx = _searcher.CurrentMatch(); idx >= 0)\r\n+            _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(std::max<ptrdiff_t>(0, _searcher.CurrentMatch())));\r\n+            _renderer->TriggerSearchHighlight(oldResults);\r\n+\r\n+            if (const auto focused = _terminal->GetSearchHighlightFocused(); focused && *focused != oldFocused)\r\n             {\r\n-                _terminal->SetSearchHighlightFocused(gsl::narrow<size_t>(idx), request.ScrollOffset);\r\n+                _terminal->ScrollToSearchHighlight(request.ScrollOffset);\r\n             }\r\n-            _renderer->TriggerSearchHighlight(oldResults);\r\n         }\r\n \r\n         int32_t totalMatches = 0;\r\n@@ -1756,27 +1759,11 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     {\r\n         const auto lock = _terminal->LockForWriting();\r\n         _terminal->SetSearchHighlights({});\r\n-        _terminal->SetSearchHighlightFocused({}, 0);\r\n+        _terminal->SetSearchHighlightFocused(0);\r\n         _renderer->TriggerSearchHighlight(_searcher.Results());\r\n         _searcher = {};\r\n     }\r\n \r\n-    // Method Description:\r\n-    // - Tells ControlCore to snap the current search result index to currently\r\n-    //   selected text if the search was started using it.\r\n-    void ControlCore::SnapSearchResultToSelection(bool shouldSnap) noexcept\r\n-    {\r\n-        _snapSearchResultToSelection = shouldSnap;\r\n-    }\r\n-\r\n-    // Method Description:\r\n-    // - Returns true, if we should snap the current search result index to\r\n-    //   the currently selected text after a new search is started, else false.\r\n-    bool ControlCore::SnapSearchResultToSelection() const noexcept\r\n-    {\r\n-        return _snapSearchResultToSelection;\r\n-    }\r\n-\r\n     void ControlCore::Close()\r\n     {\r\n         if (!_IsClosing())\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.h b/src/cascadia/TerminalControl/ControlCore.h\nindex 9ac8e5450c3..2e9f2490d9d 100644\n--- a/src/cascadia/TerminalControl/ControlCore.h\n+++ b/src/cascadia/TerminalControl/ControlCore.h\n@@ -228,8 +228,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         SearchResults Search(SearchRequest request);\r\n         const std::vector<til::point_span>& SearchResultRows() const noexcept;\r\n         void ClearSearch();\r\n-        void SnapSearchResultToSelection(bool snap) noexcept;\r\n-        bool SnapSearchResultToSelection() const noexcept;\r\n \r\n         void LeftClickOnTerminal(const til::point terminalPosition,\r\n                                  const int numberOfClicks,\r\ndiff --git a/src/cascadia/TerminalControl/ControlCore.idl b/src/cascadia/TerminalControl/ControlCore.idl\nindex 3be52269a89..ee1a4787e22 100644\n--- a/src/cascadia/TerminalControl/ControlCore.idl\n+++ b/src/cascadia/TerminalControl/ControlCore.idl\n@@ -55,7 +55,7 @@ namespace Microsoft.Terminal.Control\n         Boolean GoForward;\r\n         Boolean CaseSensitive;\r\n         Boolean RegularExpression;\r\n-        Boolean Reset;\r\n+        Boolean ResetOnly;\r\n         Int32 ScrollOffset;\r\n     };\r\n \r\n@@ -148,7 +148,6 @@ namespace Microsoft.Terminal.Control\n \r\n         SearchResults Search(SearchRequest request);\r\n         void ClearSearch();\r\n-        Boolean SnapSearchResultToSelection;\r\n \r\n         Microsoft.Terminal.Core.Color ForegroundColor { get; };\r\n         Microsoft.Terminal.Core.Color BackgroundColor { get; };\r\ndiff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 565ea02ccf6..5f981f89e65 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -576,7 +576,6 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n                     // but since code paths differ, extra work is required to ensure correctness.\r\n                     if (!_core.HasMultiLineSelection())\r\n                     {\r\n-                        _core.SnapSearchResultToSelection(true);\r\n                         const auto selectedLine{ _core.SelectedText(true) };\r\n                         _searchBox->PopulateTextbox(selectedLine);\r\n                     }\r\n@@ -3844,7 +3843,7 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         const auto goForward = _searchBox->GoForward();\r\n         const auto caseSensitive = _searchBox->CaseSensitive();\r\n         const auto regularExpression = _searchBox->RegularExpression();\r\n-        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _calculateSearchScrollOffset() };\r\n+        const auto request = SearchRequest{ text, goForward, caseSensitive, regularExpression, true, _searchScrollOffset };\r\n         _handleSearchResults(_core.Search(request));\r\n     }\r\n \r\ndiff --git a/src/cascadia/TerminalCore/Terminal.cpp b/src/cascadia/TerminalCore/Terminal.cpp\nindex c5876e1497c..df24a3e8917 100644\n--- a/src/cascadia/TerminalCore/Terminal.cpp\n+++ b/src/cascadia/TerminalCore/Terminal.cpp\n@@ -1259,15 +1259,17 @@ void Terminal::SetSearchHighlights(const std::vector<til::point_span>& highlight\n // Method Description:\r\n // - Stores the focused search highlighted region in the terminal\r\n // - If the region isn't empty, it will be brought into view\r\n-void Terminal::SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset)\r\n+void Terminal::SetSearchHighlightFocused(const size_t focusedIdx) noexcept\r\n {\r\n     _assertLocked();\r\n     _searchHighlightFocused = focusedIdx;\r\n+}\r\n \r\n-    // bring the focused region into the view if the index is in valid range\r\n-    if (focusedIdx < _searchHighlights.size())\r\n+void Terminal::ScrollToSearchHighlight(til::CoordType searchScrollOffset)\r\n+{\r\n+    if (_searchHighlightFocused < _searchHighlights.size())\r\n     {\r\n-        const auto focused = til::at(_searchHighlights, focusedIdx);\r\n+        const auto focused = til::at(_searchHighlights, _searchHighlightFocused);\r\n         const auto adjustedStart = til::point{ focused.start.x, std::max(0, focused.start.y - searchScrollOffset) };\r\n         const auto adjustedEnd = til::point{ focused.end.x, std::max(0, focused.end.y - searchScrollOffset) };\r\n         _ScrollToPoints(adjustedStart, adjustedEnd);\r\ndiff --git a/src/cascadia/TerminalCore/Terminal.hpp b/src/cascadia/TerminalCore/Terminal.hpp\nindex e9d3f1abd0a..d62a76b3bc8 100644\n--- a/src/cascadia/TerminalCore/Terminal.hpp\n+++ b/src/cascadia/TerminalCore/Terminal.hpp\n@@ -234,7 +234,8 @@ class Microsoft::Terminal::Core::Terminal final :\n     void SetClearQuickFixCallback(std::function<void()> pfn) noexcept;\r\n     void SetWindowSizeChangedCallback(std::function<void(int32_t, int32_t)> pfn) noexcept;\r\n     void SetSearchHighlights(const std::vector<til::point_span>& highlights) noexcept;\r\n-    void SetSearchHighlightFocused(const size_t focusedIdx, til::CoordType searchScrollOffset);\r\n+    void SetSearchHighlightFocused(size_t focusedIdx) noexcept;\r\n+    void ScrollToSearchHighlight(til::CoordType searchScrollOffset);\r\n \r\n     void BlinkCursor() noexcept;\r\n     void SetCursorOn(const bool isOn) noexcept;\r\ndiff --git a/src/interactivity/win32/find.cpp b/src/interactivity/win32/find.cpp\nindex 033918e3ae5..07996c47767 100644\n--- a/src/interactivity/win32/find.cpp\n+++ b/src/interactivity/win32/find.cpp\n@@ -57,7 +57,6 @@ INT_PTR CALLBACK FindDialogProc(HWND hWnd, UINT Message, WPARAM wParam, LPARAM l\n             if (searcher.IsStale(gci.renderData, lastFindString, flags))\r\n             {\r\n                 searcher.Reset(gci.renderData, lastFindString, flags, reverse);\r\n-                searcher.MoveToCurrentSelection();\r\n             }\r\n             else\r\n             {\r\n", "instance_id": "microsoft__terminal-17885", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue: search results in Windows Terminal steal focus and scroll when the buffer changes (e.g., while typing in the prompt). It provides specific steps to reproduce the issue, expected behavior, and actual behavior, which helps in understanding the problem context. However, there are minor ambiguities and missing details. For instance, it does not explicitly define whether this behavior should be configurable or if there are specific conditions under which focus should or should not shift. Additionally, edge cases (e.g., behavior with empty buffers or no search results) are not mentioned, which could impact the solution's completeness. Overall, while the goal is clear, the lack of exhaustive constraints or edge case specifications prevents it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes spans multiple files (e.g., `search.cpp`, `ControlCore.cpp`, `Terminal.cpp`) and involves modifications to the interaction between search functionality, focus management, and rendering logic in the Windows Terminal codebase. This requires a solid understanding of the internal architecture, particularly how search results are tracked, highlighted, and interacted with during buffer updates. Second, the technical concepts involved include handling state management for search results, understanding rendering and focus logic, and modifying method signatures and behavior (e.g., changing `Reset` from returning a boolean to void, adjusting focus handling). While these concepts are not extraordinarily complex, they do require familiarity with the specific codebase and C++ intricacies like noexcept specifications and smart pointer usage. Third, the changes impact a moderate amount of code but do not appear to alter the system's core architecture significantly. Finally, potential edge cases (e.g., no search results, invalid indices, or concurrent buffer modifications) are not explicitly handled in the provided diff but may need consideration, adding a layer of complexity to ensure robustness. Overall, this problem requires a moderate level of expertise and effort, involving cross-file modifications and a good grasp of the terminal's search and rendering mechanisms, but it does not reach the level of a hard or very hard problem due to the absence of advanced algorithmic or system-level challenges.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Godot 4.4 silently closes when using OBS advanced scene switcher (detects active window). GameCapture Mode\n### Tested versions\n\n4.4 issue\n4.3 works fine\n\n### System information\n\nGodot v4.4.stable - Windows 10 (build 19045) - Multi-window, 2 monitors - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 2070 (NVIDIA; 32.0.15.6636) - Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz (16 threads)\n\n### Issue description\n\n4.4 Godot Crashes when tabbing into other windows using OBS Scene Switcher Plugin(which detects the current window and changes scene)\n\nI will temporarily go back to 4.3 which does not do this.\n\n I'm not sure what options in the editor have changed or if there are some options I can tick to help with this. I've tried many different options. I know the detection of windows isn't youre problem, but why did it work flawlessly in 4.3?\n\nIt only happens if im using GameCapture for Godot 4.4. I just dont want to stream my whole display monitor. I use the advanced scene switcher plugin to make devlogs. Switching scenes between my notes, editor, ect.\n\n\nNo errors. Just my Godot disappears and closes when I tab into other windows. It works fine if Godot isn't Game Capture. \n\nDid anything change in 4.4 for window detection and compatibility with OBS? Ive even tried setting godot 4.4 to single window mode.\n\n### Steps to reproduce\n\nOpen Godot 4.4,\n\nHave scene setup in game capture mode for Godot 4.4.\n\nUse Window Detection with another application ( OBS Automatic Scene Switcher)\n\nScenes automatically switch based on the active window.\n\nGodot crashes when tabbing into other windows.\n\nOpen Godot 4.3\n\nRepeat steps.\n\nGodot does not close/crash\n\n\n### Minimal reproduction project (MRP)\n\nHappens with any 4.4 project. Even brand new ones.\n\nUnable to replicate in 4.3\n", "patch": "diff --git a/main/main.cpp b/main/main.cpp\nindex 441ba3141ef4..032d367bc18b 100644\n--- a/main/main.cpp\n+++ b/main/main.cpp\n@@ -2517,24 +2517,38 @@ Error Main::setup(const char *execpath, int argc, char *argv[], bool p_second_ph\n \tOS::get_singleton()->_allow_layered = GLOBAL_DEF_RST(\"display/window/per_pixel_transparency/allowed\", false);\n \n #ifdef TOOLS_ENABLED\n-\tif (editor || project_manager) {\n-\t\t// The editor and project manager always detect and use hiDPI if needed.\n-\t\tOS::get_singleton()->_allow_hidpi = true;\n-\t\t// Disable Vulkan overlays in editor, they cause various issues.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_MANGOHUD\", \"1\"); // GH-57403.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_RTSS_LAYER\", \"1\"); // GH-57937.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VKBASALT\", \"1\");\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_reshade_1\", \"1\"); // GH-70849.\n-\t\tOS::get_singleton()->set_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\", \"1\"); // GH-101480.\n-\t\tOS::get_singleton()->set_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\", \"1\"); // GH-101480.\n-\t} else {\n-\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_MANGOHUD\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_RTSS_LAYER\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VKBASALT\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_reshade_1\");\n-\t\tOS::get_singleton()->unset_environment(\"VK_LAYER_bandicam_helper_DEBUG_1\");\n-\t\tOS::get_singleton()->unset_environment(\"DISABLE_VK_LAYER_bandicam_helper_1\");\n+\t{\n+\t\t// Synced with https://github.com/baldurk/renderdoc/blob/2b01465c7/renderdoc/driver/vulkan/vk_layer.cpp#L118-L165\n+\t\tLocalVector<String> layers_to_disable = {\n+\t\t\t\"DISABLE_RTSS_LAYER\", // GH-57937.\n+\t\t\t\"DISABLE_VULKAN_OBS_CAPTURE\", // GH-103800.\n+\t\t\t\"DISABLE_VULKAN_OW_OBS_CAPTURE\", // GH-104154.\n+\t\t\t\"DISABLE_SAMPLE_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_GAMEPP_LAYER\", // GH-104154.\n+\t\t\t\"DISABLE_VK_LAYER_TENCENT_wegame_cross_overlay_1\", // GH-104154.\n+\t\t\t\"NODEVICE_SELECT\", // GH-104154.\n+\t\t\t\"VK_LAYER_bandicam_helper_DEBUG_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_bandicam_helper_1\", // GH-101480.\n+\t\t\t\"DISABLE_VK_LAYER_reshade_1\", // GH-70849.\n+\t\t\t\"DISABLE_VK_LAYER_GPUOpen_GRS\", // GH-104154.\n+\t\t\t\"DISABLE_LAYER\", // GH-104154 (fpsmon).\n+\t\t\t\"DISABLE_MANGOHUD\", // GH-57403.\n+\t\t\t\"DISABLE_VKBASALT\",\n+\t\t};\n+\n+\t\tif (editor || project_manager) {\n+\t\t\t// The editor and project manager always detect and use hiDPI if needed.\n+\t\t\tOS::get_singleton()->_allow_hidpi = true;\n+\t\t\t// Disable Vulkan overlays in editor, they cause various issues.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->set_environment(layer_disable, \"1\");\n+\t\t\t}\n+\t\t} else {\n+\t\t\t// Re-allow using Vulkan overlays, disabled while using the editor.\n+\t\t\tfor (const String &layer_disable : layers_to_disable) {\n+\t\t\t\tOS::get_singleton()->unset_environment(layer_disable);\n+\t\t\t}\n+\t\t}\n \t}\n #endif\n \n", "instance_id": "godotengine__godot-104154", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue: Godot 4.4 crashes when used with OBS Advanced Scene Switcher in GameCapture mode, while Godot 4.3 works fine under the same conditions. The user provides detailed system information, steps to reproduce, and context about their setup (e.g., multi-window, Vulkan rendering, specific hardware). However, there are minor ambiguities and missing details that prevent a perfect score. For instance, the problem statement does not specify if there are any error logs or crash dumps available, which could help pinpoint the root cause. Additionally, while the issue is reproducible with any project, there is no mention of specific configurations or settings in OBS or Godot that might influence the behavior beyond GameCapture mode and window detection. These missing details could be critical for a complete diagnosis, but the overall description is sufficient to understand the issue and its context.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the code changes appears focused on a specific part of the codebase (main.cpp), specifically around Vulkan layer management and environment variable settings to disable certain overlays or capture layers that might interfere with tools like OBS. The provided diff shows a refactoring of how Vulkan layers are disabled or enabled based on whether the editor or project manager is active, with new layers added to address compatibility issues (e.g., \"DISABLE_VULKAN_OBS_CAPTURE\"). This indicates a moderate scope of change, confined to a single file but impacting a critical initialization path.\n\nSecond, the technical concepts involved are moderately complex. Solving this requires understanding Vulkan layers, environment variable manipulation, and how these interact with external tools like OBS for window detection and capture. It also necessitates familiarity with Godot's rendering and windowing system, particularly changes between versions 4.3 and 4.4, which might involve subtle differences in Vulkan handling or window management.\n\nThird, the problem likely involves edge cases related to specific hardware (e.g., NVIDIA GPUs), driver versions, or OBS configurations, though these are not fully detailed in the problem statement. The code change does not explicitly address error handling but focuses on preventing crashes by disabling problematic layers, suggesting an implicit handling of compatibility issues.\n\nFinally, while the change itself is not architecturally significant, diagnosing the root cause (why Godot 4.4 crashes with OBS while 4.3 does not) and ensuring the solution does not introduce regressions across different setups requires a deep understanding of the Godot engine's internals and third-party tool interactions. This pushes the difficulty beyond medium, as it involves non-trivial debugging and cross-version analysis, likely requiring experience with graphics APIs and system-level interactions. A score of 0.65 reflects the challenge of understanding and resolving a specific compatibility issue in a complex system without widespread architectural impact.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Build error when building for Android with `disable_3d=yes`\n### Tested versions\n\n- Reproducible in: 4.4-stable\n- Not reproducible in 4.3-stable and lower\n\n### System information\n\nArch Linux x86_64 6.13.5-arch1-1\n\n### Issue description\n\nGodot doesn't compile when using the `disable_3d=yes` option in scons\n\n```\nplatform/android/java_godot_lib_jni.cpp:478:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:478:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_driver = RenderingServer::get_singleton()->get_current_rendering_driver_name();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: use of undeclared identifier 'RenderingServer'; did you mean 'RenderingDevice'?\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~\n                                  RenderingDevice\nplatform/android/display_server_android.h:38:7: note: 'RenderingDevice' declared here\nclass RenderingDevice;\n      ^\nplatform/android/java_godot_lib_jni.cpp:479:28: error: incomplete type 'RenderingDevice' named in nested name specifier\n        String rendering_method = RenderingServer::get_singleton()->get_current_rendering_method();\n                                  ^~~~~~~~~~~~~~~~~\nplatform/android/display_server_android.h:38:7: note: forward declaration of 'RenderingDevice'\nclass RenderingDevice;\n      ^\n```\n\nTested in Arch Linux and Ubuntu 20.04. No difference.\nThis didn't happen on 4.3 version\nAfter some research it seems like this is connected to this commit: [28d1dcc](https://github.com/godotengine/godot/commit/28d1dccf6370a1754c9bd49b9e5ec3f15db1e535)\n\n### Steps to reproduce\n\n1. Download Godot source code and required build tools\n2. Compile the engine with command `scons platform=android arch=x86_64 disable_3d=yes`\n\n### Minimal reproduction project (MRP)\n\nn/a\n", "patch": "diff --git a/platform/android/java_godot_lib_jni.cpp b/platform/android/java_godot_lib_jni.cpp\nindex 054c809c6e3f..0bb78bb9d974 100644\n--- a/platform/android/java_godot_lib_jni.cpp\n+++ b/platform/android/java_godot_lib_jni.cpp\n@@ -49,6 +49,7 @@\n #include \"core/config/project_settings.h\"\n #include \"core/input/input.h\"\n #include \"main/main.h\"\n+#include \"servers/rendering_server.h\"\n \n #ifndef _3D_DISABLED\n #include \"servers/xr_server.h\"\n", "instance_id": "godotengine__godot-103523", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in describing the issue: a build error occurs when compiling Godot for Android with the `disable_3d=yes` option in version 4.4-stable, which did not occur in version 4.3-stable or lower. It provides specific error messages, the affected file, and a reference to a potentially related commit. Steps to reproduce the issue are also included, which adds to the clarity. However, there are minor ambiguities, such as the lack of explicit mention of the expected behavior or desired outcome (e.g., what should happen when `disable_3d=yes` is set). Additionally, edge cases or specific constraints related to the build configuration are not discussed. While the issue is well-documented with error logs and reproduction steps, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is minimal, involving a single file (`java_godot_lib_jni.cpp`) and a straightforward fix of adding a missing header file (`servers/rendering_server.h`) to resolve the compilation error. This indicates a basic issue of missing dependencies rather than complex logic or architectural changes. Second, the technical concepts required are relatively simple: understanding C++ compilation errors, header file inclusions, and conditional compilation macros (e.g., `_3D_DISABLED`). No advanced algorithms, design patterns, or domain-specific knowledge beyond basic C++ and build systems are needed. Third, the problem does not appear to involve complex edge cases or extensive error handling beyond resolving the immediate compilation issue. Finally, the impact is limited to a specific build configuration (`disable_3d=yes` for Android), and there is no indication of broader architectural or performance implications. Overall, this is a straightforward bug fix that requires minimal effort and understanding of the codebase, justifying a difficulty score of 0.25.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Wayland Cursor custom image doesn't update when using Image instead of Texture2D\n### Tested versions\n\n- v4.4.beta.gentoo [4ce466d7f]\n\n### System information\n\nLinux Gentoo using Wayland\n\n### Issue description\n\nWhen using the Wayland DisplayServer you can only update the custom mouse cursor once if you are using Image instead of Texture2D resources and the images have the same hotspot.\n\nThe function `Input.set_custom_mouse_cursor` claims that it is okay to use either an Image or a Texture2D as a custom cursor image. The caching code in `DisplayServerWayland::cursor_set_custom_image` checks for cursor reuse using \"get_rid()\" on the provided resource. Since an Image does not have a RID, any image will always enter the branch `// We have a cached cursor. Nice.`.\n\nBug is visible since #96647 was fixed, although the underlying bug was already older than that.\n\n### Workarounds\n* Use Texture2D instead of image resources - may cause undesired overhead to convert back to image\n* Reset the cursor in between - may cause cursor flickering\n* Move the hotspot locations to force a cache miss - unwanted extra work to make images suitable with different hotspots\n\n### Steps to reproduce\n\n* Force editor and game to use the Wayland display server\n* Make sure the referenced `img1` and `img2` are imported as Image and not as Texture.\n\n```gdscript\nInput.set_custom_mouse_cursor(img1, Input.CURSOR_ARROW)\n# Correctly shows img1 as the cursor\nInput.set_custom_mouse_cursor(img2, Input.CURSOR_ARROW)\n# Still shows img1 as the cursor\n```\n\n### Minimal reproduction project (MRP)\n\n[wayland-cursor-reproducer.zip](https://github.com/user-attachments/files/18510307/wayland-cursor-reproducer.zip)\n", "patch": "diff --git a/platform/linuxbsd/wayland/display_server_wayland.cpp b/platform/linuxbsd/wayland/display_server_wayland.cpp\nindex 532eaa6bcf49..f9b34ff043bf 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.cpp\n+++ b/platform/linuxbsd/wayland/display_server_wayland.cpp\n@@ -1033,7 +1033,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \t\tHashMap<CursorShape, CustomCursor>::Iterator cursor_c = custom_cursors.find(p_shape);\n \n \t\tif (cursor_c) {\n-\t\t\tif (cursor_c->value.rid == p_cursor->get_rid() && cursor_c->value.hotspot == p_hotspot) {\n+\t\t\tif (cursor_c->value.resource == p_cursor && cursor_c->value.hotspot == p_hotspot) {\n \t\t\t\t// We have a cached cursor. Nice.\n \t\t\t\twayland_thread.cursor_set_shape(p_shape);\n \t\t\t\treturn;\n@@ -1049,7 +1049,7 @@ void DisplayServerWayland::cursor_set_custom_image(const Ref<Resource> &p_cursor\n \n \t\tCustomCursor &cursor = custom_cursors[p_shape];\n \n-\t\tcursor.rid = p_cursor->get_rid();\n+\t\tcursor.resource = p_cursor;\n \t\tcursor.hotspot = p_hotspot;\n \n \t\twayland_thread.cursor_shape_set_custom_image(p_shape, image, p_hotspot);\ndiff --git a/platform/linuxbsd/wayland/display_server_wayland.h b/platform/linuxbsd/wayland/display_server_wayland.h\nindex 8c3bac9c7e3b..43a8b01b3208 100644\n--- a/platform/linuxbsd/wayland/display_server_wayland.h\n+++ b/platform/linuxbsd/wayland/display_server_wayland.h\n@@ -101,7 +101,7 @@ class DisplayServerWayland : public DisplayServer {\n \t};\n \n \tstruct CustomCursor {\n-\t\tRID rid;\n+\t\tRef<Resource> resource;\n \t\tPoint2i hotspot;\n \t};\n \n", "instance_id": "godotengine__godot-101987", "clarity": 2, "difficulty": 0.35, "clarity_explanation": "The problem statement is mostly clear and provides a detailed description of the issue, including the context (Wayland DisplayServer on Linux Gentoo), the specific bug (custom cursor not updating when using Image instead of Texture2D), and the conditions under which it occurs (same hotspot). It also includes steps to reproduce, a minimal reproduction project, and workarounds, which are helpful for understanding the problem. However, there are minor ambiguities: the problem statement does not explicitly define what constitutes a \"RID\" (Resource ID) or why Images lack it, which is critical to understanding the root cause of the caching issue. Additionally, while edge cases like hotspot differences are mentioned in workarounds, the statement does not fully clarify expected behavior for other potential edge cases (e.g., mixed usage of Image and Texture2D). Overall, it is clear enough to work on but lacks some technical depth in the explanation of underlying mechanisms.", "difficulty_explanation": "The difficulty of this problem falls in the \"Easy\" range (0.2-0.4) due to the following factors:\n\n1. **Scope and Depth of Code Changes**: The code changes are localized to a single class (`DisplayServerWayland`) in two files (`display_server_wayland.cpp` and `display_server_wayland.h`). The modification involves changing how cursor resources are cached and compared, replacing a `RID` (Resource ID) with a direct reference to the `Resource` object. The amount of code change is minimal (a few lines), and it does not impact the broader system architecture or require extensive refactoring.\n\n2. **Technical Concepts Involved**: Solving this requires a basic understanding of C++ (specifically, working with references and smart pointers like `Ref<Resource>`), familiarity with the Godot engine's resource management system, and a general understanding of Wayland's cursor handling. These concepts are not overly complex for someone with moderate experience in C++ or game engine development. No advanced algorithms, design patterns, or domain-specific knowledge beyond the Godot engine are needed.\n\n3. **Edge Cases and Error Handling**: The problem statement and code changes do not explicitly address new edge cases or error handling beyond fixing the caching logic for Images. The change from `RID` to `Ref<Resource>` might implicitly handle comparison better, but no additional error checking or complex edge case logic is introduced in the provided diff. The workarounds mentioned (e.g., hotspot manipulation) suggest potential edge cases, but the fix itself does not tackle them directly.\n\n4. **Overall Complexity**: The bug fix is straightforward—replacing an identifier-based comparison with a direct resource reference comparison. It requires understanding why `get_rid()` fails for Images (as they lack a RID), but this is a relatively simple logical deduction once the issue is identified. The impact is limited to cursor handling in Wayland, and there are no performance or scalability concerns evident in the change.\n\nGiven these points, a score of 0.35 reflects an \"Easy\" problem that requires understanding some specific codebase logic (Godot's resource system and Wayland cursor handling) and making a simple, targeted modification. It is slightly above the lower end of the range due to the need for domain-specific knowledge of Godot's internals, but it does not approach medium difficulty as the scope and complexity remain low.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Excessive error spam when a global script is not valid\n### Tested versions\n\n4.4 dev7\n\n### System information\n\nW10\n\n### Issue description\n\nIf you have a global script (with `class_name`) and it has an error, the error will be spammed occasionally when using editor. I observed it e.g. when opening CreateDialog to add a node (happens once), or every time you try to autocomplete something.\nhttps://github.com/user-attachments/assets/97e7b7f2-e148-42ee-a481-025a07a2d38f\nWhat's relevant though is that the error appears at all. It means the script is loaded and/or parsed needlessly *very often* and it probably applies to all global scripts. We should find a way to avoid that. The scripts should be parsed only after they change and use some cache whenever the editor needs something script-related.\n\n### Steps to reproduce\n\n1. Add a script with class name\n2. Introduce some parsing error, e.g. a random word wherever\n3. In another script, try autocompleting something\n\n### Minimal reproduction project (MRP)\n\nN/A\n", "patch": "diff --git a/core/config/project_settings.cpp b/core/config/project_settings.cpp\nindex fdcd4f9b6064..a12b89683118 100644\n--- a/core/config/project_settings.cpp\n+++ b/core/config/project_settings.cpp\n@@ -1263,10 +1263,10 @@ void ProjectSettings::refresh_global_class_list() {\n \tArray script_classes = get_global_class_list();\n \tfor (int i = 0; i < script_classes.size(); i++) {\n \t\tDictionary c = script_classes[i];\n-\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\tcontinue;\n \t\t}\n-\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\tScriptServer::add_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t}\n }\n \ndiff --git a/core/object/script_language.cpp b/core/object/script_language.cpp\nindex 4ef53dba1dff..33bf7ab48a0f 100644\n--- a/core/object/script_language.cpp\n+++ b/core/object/script_language.cpp\n@@ -269,10 +269,10 @@ void ScriptServer::init_languages() {\n \n \t\t\tfor (const Variant &script_class : script_classes) {\n \t\t\t\tDictionary c = script_class;\n-\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\t\tcontinue;\n \t\t\t\t}\n-\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t\t}\n \t\t\tProjectSettings::get_singleton()->clear(\"_global_script_classes\");\n \t\t}\n@@ -281,10 +281,10 @@ void ScriptServer::init_languages() {\n \t\tArray script_classes = ProjectSettings::get_singleton()->get_global_class_list();\n \t\tfor (const Variant &script_class : script_classes) {\n \t\t\tDictionary c = script_class;\n-\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\")) {\n+\t\t\tif (!c.has(\"class\") || !c.has(\"language\") || !c.has(\"path\") || !c.has(\"base\") || !c.has(\"is_abstract\") || !c.has(\"is_tool\")) {\n \t\t\t\tcontinue;\n \t\t\t}\n-\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"]);\n+\t\t\tadd_global_class(c[\"class\"], c[\"base\"], c[\"language\"], c[\"path\"], c[\"is_abstract\"], c[\"is_tool\"]);\n \t\t}\n \t}\n \n@@ -390,7 +390,7 @@ void ScriptServer::global_classes_clear() {\n \tinheriters_cache.clear();\n }\n \n-void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path) {\n+void ScriptServer::add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool) {\n \tERR_FAIL_COND_MSG(p_class == p_base || (global_classes.has(p_base) && get_global_class_native_base(p_base) == p_class), \"Cyclic inheritance in script class.\");\n \tGlobalScriptClass *existing = global_classes.getptr(p_class);\n \tif (existing) {\n@@ -399,6 +399,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\t\texisting->base = p_base;\n \t\t\texisting->path = p_path;\n \t\t\texisting->language = p_language;\n+\t\t\texisting->is_abstract = p_is_abstract;\n+\t\t\texisting->is_tool = p_is_tool;\n \t\t\tinheriters_cache_dirty = true;\n \t\t}\n \t} else {\n@@ -407,6 +409,8 @@ void ScriptServer::add_global_class(const StringName &p_class, const StringName\n \t\tg.language = p_language;\n \t\tg.path = p_path;\n \t\tg.base = p_base;\n+\t\tg.is_abstract = p_is_abstract;\n+\t\tg.is_tool = p_is_tool;\n \t\tglobal_classes[p_class] = g;\n \t\tinheriters_cache_dirty = true;\n \t}\n@@ -480,6 +484,16 @@ StringName ScriptServer::get_global_class_native_base(const String &p_class) {\n \treturn base;\n }\n \n+bool ScriptServer::is_global_class_abstract(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_abstract;\n+}\n+\n+bool ScriptServer::is_global_class_tool(const String &p_class) {\n+\tERR_FAIL_COND_V(!global_classes.has(p_class), false);\n+\treturn global_classes[p_class].is_tool;\n+}\n+\n void ScriptServer::get_global_class_list(List<StringName> *r_global_classes) {\n \tList<StringName> classes;\n \tfor (const KeyValue<StringName, GlobalScriptClass> &E : global_classes) {\n@@ -507,12 +521,15 @@ void ScriptServer::save_global_classes() {\n \tget_global_class_list(&gc);\n \tArray gcarr;\n \tfor (const StringName &E : gc) {\n+\t\tconst GlobalScriptClass &global_class = global_classes[E];\n \t\tDictionary d;\n \t\td[\"class\"] = E;\n-\t\td[\"language\"] = global_classes[E].language;\n-\t\td[\"path\"] = global_classes[E].path;\n-\t\td[\"base\"] = global_classes[E].base;\n+\t\td[\"language\"] = global_class.language;\n+\t\td[\"path\"] = global_class.path;\n+\t\td[\"base\"] = global_class.base;\n \t\td[\"icon\"] = class_icons.get(E, \"\");\n+\t\td[\"is_abstract\"] = global_class.is_abstract;\n+\t\td[\"is_tool\"] = global_class.is_tool;\n \t\tgcarr.push_back(d);\n \t}\n \tProjectSettings::get_singleton()->store_global_class_list(gcarr);\ndiff --git a/core/object/script_language.h b/core/object/script_language.h\nindex 6ceeb4287512..8158d633ae14 100644\n--- a/core/object/script_language.h\n+++ b/core/object/script_language.h\n@@ -62,6 +62,8 @@ class ScriptServer {\n \t\tStringName language;\n \t\tString path;\n \t\tStringName base;\n+\t\tbool is_abstract = false;\n+\t\tbool is_tool = false;\n \t};\n \n \tstatic HashMap<StringName, GlobalScriptClass> global_classes;\n@@ -86,7 +88,7 @@ class ScriptServer {\n \tstatic void thread_exit();\n \n \tstatic void global_classes_clear();\n-\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path);\n+\tstatic void add_global_class(const StringName &p_class, const StringName &p_base, const StringName &p_language, const String &p_path, bool p_is_abstract, bool p_is_tool);\n \tstatic void remove_global_class(const StringName &p_class);\n \tstatic void remove_global_class_by_path(const String &p_path);\n \tstatic bool is_global_class(const StringName &p_class);\n@@ -94,6 +96,8 @@ class ScriptServer {\n \tstatic String get_global_class_path(const String &p_class);\n \tstatic StringName get_global_class_base(const String &p_class);\n \tstatic StringName get_global_class_native_base(const String &p_class);\n+\tstatic bool is_global_class_abstract(const String &p_class);\n+\tstatic bool is_global_class_tool(const String &p_class);\n \tstatic void get_global_class_list(List<StringName> *r_global_classes);\n \tstatic void get_inheriters_list(const StringName &p_base_type, List<StringName> *r_classes);\n \tstatic void save_global_classes();\n@@ -443,7 +447,7 @@ class ScriptLanguage : public Object {\n \tvirtual void frame();\n \n \tvirtual bool handles_global_class_type(const String &p_type) const { return false; }\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const { return String(); }\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const { return String(); }\n \n \tvirtual ~ScriptLanguage() {}\n };\ndiff --git a/core/object/script_language_extension.h b/core/object/script_language_extension.h\nindex 09c395e71e8d..715ec43fb35a 100644\n--- a/core/object/script_language_extension.h\n+++ b/core/object/script_language_extension.h\n@@ -672,7 +672,7 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \n \tGDVIRTUAL1RC_REQUIRED(Dictionary, _get_global_class_name, const String &)\n \n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override {\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override {\n \t\tDictionary ret;\n \t\tGDVIRTUAL_CALL(_get_global_class_name, p_path, ret);\n \t\tif (!ret.has(\"name\")) {\n@@ -684,6 +684,12 @@ class ScriptLanguageExtension : public ScriptLanguage {\n \t\tif (r_icon_path != nullptr && ret.has(\"icon_path\")) {\n \t\t\t*r_icon_path = ret[\"icon_path\"];\n \t\t}\n+\t\tif (r_is_abstract != nullptr && ret.has(\"is_abstract\")) {\n+\t\t\t*r_is_abstract = ret[\"is_abstract\"];\n+\t\t}\n+\t\tif (r_is_tool != nullptr && ret.has(\"is_tool\")) {\n+\t\t\t*r_is_tool = ret[\"is_tool\"];\n+\t\t}\n \t\treturn ret[\"name\"];\n \t}\n };\ndiff --git a/editor/connections_dialog.cpp b/editor/connections_dialog.cpp\nindex 429467d3403c..dca43411e10b 100644\n--- a/editor/connections_dialog.cpp\n+++ b/editor/connections_dialog.cpp\n@@ -1446,7 +1446,7 @@ void ConnectionsDock::update_tree() {\n \t\t\t\tdoc_class_name = String();\n \t\t\t}\n \n-\t\t\tclass_icon = editor_data.get_script_icon(script_base);\n+\t\t\tclass_icon = editor_data.get_script_icon(script_base->get_path());\n \t\t\tif (class_icon.is_null() && has_theme_icon(native_base, EditorStringName(EditorIcons))) {\n \t\t\t\tclass_icon = get_editor_theme_icon(native_base);\n \t\t\t}\ndiff --git a/editor/create_dialog.cpp b/editor/create_dialog.cpp\nindex 7f1670bcb648..5eebb1c492e5 100644\n--- a/editor/create_dialog.cpp\n+++ b/editor/create_dialog.cpp\n@@ -257,14 +257,9 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\tinherits = ClassDB::get_parent_class(p_type);\n \t\tinherited_type = TypeCategory::CPP_TYPE;\n \t} else {\n-\t\tif (p_type_category == TypeCategory::PATH_TYPE || ScriptServer::is_global_class(p_type)) {\n-\t\t\tRef<Script> scr;\n-\t\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n-\t\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n-\t\t\t\tscr = ResourceLoader::load(p_type, \"Script\");\n-\t\t\t} else {\n-\t\t\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_type);\n-\t\t\t}\n+\t\tif (p_type_category == TypeCategory::PATH_TYPE) {\n+\t\t\tERR_FAIL_COND(!ResourceLoader::exists(p_type, \"Script\"));\n+\t\t\tRef<Script> scr = ResourceLoader::load(p_type, \"Script\");\n \t\t\tERR_FAIL_COND(scr.is_null());\n \n \t\t\tRef<Script> base = scr->get_base_script();\n@@ -286,6 +281,10 @@ void CreateDialog::_add_type(const StringName &p_type, TypeCategory p_type_categ\n \t\t\t\t\tinherited_type = TypeCategory::PATH_TYPE;\n \t\t\t\t}\n \t\t\t}\n+\t\t} else if (ScriptServer::is_global_class(p_type)) {\n+\t\t\tinherits = ScriptServer::get_global_class_base(p_type);\n+\t\t\tbool is_native_class = ClassDB::class_exists(inherits);\n+\t\t\tinherited_type = is_native_class ? TypeCategory::CPP_TYPE : TypeCategory::OTHER_TYPE;\n \t\t} else {\n \t\t\tinherits = custom_type_parents[p_type];\n \t\t\tif (ClassDB::class_exists(inherits)) {\n@@ -315,18 +314,14 @@ void CreateDialog::_configure_search_option_item(TreeItem *r_item, const StringN\n \t\tr_item->set_metadata(0, p_type);\n \t\tr_item->set_text(0, p_type);\n \n-\t\tString script_path = ScriptServer::get_global_class_path(p_type);\n-\t\tRef<Script> scr = ResourceLoader::load(script_path, \"Script\");\n-\n-\t\tERR_FAIL_COND(scr.is_null());\n-\t\tis_abstract = scr->is_abstract();\n+\t\tis_abstract = ScriptServer::is_global_class_abstract(p_type);\n \n \t\tString tooltip = TTR(\"Script path: %s\");\n-\t\tbool is_tool = scr->is_tool();\n+\t\tbool is_tool = ScriptServer::is_global_class_tool(p_type);\n \t\tif (is_tool) {\n \t\t\ttooltip = TTR(\"The script will run in the editor.\") + \"\\n\" + tooltip;\n \t\t}\n-\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, script_path));\n+\t\tr_item->add_button(0, get_editor_theme_icon(SNAME(\"Script\")), 1, false, vformat(tooltip, ScriptServer::get_global_class_path(p_type)));\n \t\tif (is_tool) {\n \t\t\tint button_index = r_item->get_button_count(0) - 1;\n \t\t\tr_item->set_button_color(0, button_index, get_theme_color(SNAME(\"accent_color\"), EditorStringName(Editor)));\ndiff --git a/editor/editor_data.cpp b/editor/editor_data.cpp\nindex 73af9f39a6f5..f31e6aba4169 100644\n--- a/editor/editor_data.cpp\n+++ b/editor/editor_data.cpp\n@@ -983,20 +983,6 @@ bool EditorData::script_class_is_parent(const String &p_class, const String &p_i\n \treturn true;\n }\n \n-StringName EditorData::script_class_get_base(const String &p_class) const {\n-\tRef<Script> script = script_class_load_script(p_class);\n-\tif (script.is_null()) {\n-\t\treturn StringName();\n-\t}\n-\n-\tRef<Script> base_script = script->get_base_script();\n-\tif (base_script.is_null()) {\n-\t\treturn ScriptServer::get_global_class_base(p_class);\n-\t}\n-\n-\treturn script->get_language()->get_global_class_name(base_script->get_path());\n-}\n-\n Variant EditorData::script_class_instance(const String &p_class) {\n \tif (ScriptServer::is_global_class(p_class)) {\n \t\tRef<Script> script = script_class_load_script(p_class);\n@@ -1026,22 +1012,25 @@ void EditorData::script_class_set_icon_path(const String &p_class, const String\n \t_script_class_icon_paths[p_class] = p_icon_path;\n }\n \n-String EditorData::script_class_get_icon_path(const String &p_class) const {\n-\tif (!ScriptServer::is_global_class(p_class)) {\n-\t\treturn String();\n-\t}\n-\n+String EditorData::script_class_get_icon_path(const String &p_class, bool *r_valid) const {\n \tString current = p_class;\n-\tString ret = _script_class_icon_paths[current];\n-\twhile (ret.is_empty()) {\n-\t\tcurrent = script_class_get_base(current);\n+\twhile (true) {\n \t\tif (!ScriptServer::is_global_class(current)) {\n+\t\t\t// If the classnames chain has a native class ancestor, we're done with success.\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = ClassDB::class_exists(current);\n+\t\t\t}\n \t\t\treturn String();\n \t\t}\n-\t\tret = _script_class_icon_paths.has(current) ? _script_class_icon_paths[current] : String();\n+\t\tHashMap<StringName, String>::ConstIterator E = _script_class_icon_paths.find(current);\n+\t\tif ((bool)E) {\n+\t\t\tif (r_valid) {\n+\t\t\t\t*r_valid = true;\n+\t\t\t}\n+\t\t\treturn E->value;\n+\t\t}\n+\t\tcurrent = ScriptServer::get_global_class_base(current);\n \t}\n-\n-\treturn ret;\n }\n \n StringName EditorData::script_class_get_name(const String &p_path) const {\n@@ -1126,28 +1115,42 @@ Ref<Texture2D> EditorData::_load_script_icon(const String &p_path) const {\n \treturn nullptr;\n }\n \n-Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n+Ref<Texture2D> EditorData::get_script_icon(const String &p_script_path) {\n \t// Take from the local cache, if available.\n-\tif (_script_icon_cache.has(p_script)) {\n+\tif (_script_icon_cache.has(p_script_path)) {\n \t\t// Can be an empty value if we can't resolve any icon for this script.\n \t\t// An empty value is still cached to avoid unnecessary attempts at resolving it again.\n-\t\treturn _script_icon_cache[p_script];\n+\t\treturn _script_icon_cache[p_script_path];\n+\t}\n+\n+\t// Fast path in case the whole hierarchy is made of global classes.\n+\tStringName class_name = script_class_get_name(p_script_path);\n+\t{\n+\t\tif (class_name != StringName()) {\n+\t\t\tbool icon_valid = false;\n+\t\t\tString icon_path = script_class_get_icon_path(class_name, &icon_valid);\n+\t\t\tif (icon_valid) {\n+\t\t\t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n+\t\t\t\t_script_icon_cache[p_script_path] = icon;\n+\t\t\t\treturn icon;\n+\t\t\t}\n+\t\t}\n \t}\n \n-\tRef<Script> base_scr = p_script;\n+\tRef<Script> base_scr = ResourceLoader::load(p_script_path, \"Script\");\n \twhile (base_scr.is_valid()) {\n \t\t// Check for scripted classes.\n \t\tString icon_path;\n-\t\tStringName class_name = script_class_get_name(base_scr->get_path());\n-\t\tif (base_scr->is_built_in() || class_name == StringName()) {\n+\t\tStringName base_class_name = script_class_get_name(base_scr->get_path());\n+\t\tif (base_scr->is_built_in() || base_class_name == StringName()) {\n \t\t\ticon_path = base_scr->get_class_icon_path();\n \t\t} else {\n-\t\t\ticon_path = script_class_get_icon_path(class_name);\n+\t\t\ticon_path = script_class_get_icon_path(base_class_name);\n \t\t}\n \n \t\tRef<Texture2D> icon = _load_script_icon(icon_path);\n \t\tif (icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = icon;\n+\t\t\t_script_icon_cache[p_script_path] = icon;\n \t\t\treturn icon;\n \t\t}\n \n@@ -1155,7 +1158,7 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\t// TODO: Should probably be deprecated in 4.x\n \t\tconst EditorData::CustomType *ctype = get_custom_type_by_path(base_scr->get_path());\n \t\tif (ctype && ctype->icon.is_valid()) {\n-\t\t\t_script_icon_cache[p_script] = ctype->icon;\n+\t\t\t_script_icon_cache[p_script_path] = ctype->icon;\n \t\t\treturn ctype->icon;\n \t\t}\n \n@@ -1163,21 +1166,16 @@ Ref<Texture2D> EditorData::get_script_icon(const Ref<Script> &p_script) {\n \t\tbase_scr = base_scr->get_base_script();\n \t}\n \n-\t// No custom icon was found in the inheritance chain, so check the base\n-\t// class of the script instead.\n-\tString base_type;\n-\tp_script->get_language()->get_global_class_name(p_script->get_path(), &base_type);\n-\n \t// Check if the base type is an extension-defined type.\n-\tRef<Texture2D> ext_icon = extension_class_get_icon(base_type);\n+\tRef<Texture2D> ext_icon = extension_class_get_icon(class_name);\n \tif (ext_icon.is_valid()) {\n-\t\t_script_icon_cache[p_script] = ext_icon;\n+\t\t_script_icon_cache[p_script_path] = ext_icon;\n \t\treturn ext_icon;\n \t}\n \n \t// If no icon found, cache it as null.\n-\t_script_icon_cache[p_script] = Ref<Texture>();\n-\treturn nullptr;\n+\t_script_icon_cache[p_script_path] = Ref<Texture2D>();\n+\treturn Ref<Texture2D>();\n }\n \n void EditorData::clear_script_icon_cache() {\ndiff --git a/editor/editor_data.h b/editor/editor_data.h\nindex 5b49304c73f2..943c661b6b2e 100644\n--- a/editor/editor_data.h\n+++ b/editor/editor_data.h\n@@ -147,7 +147,7 @@ class EditorData {\n \n \tHashMap<StringName, String> _script_class_icon_paths;\n \tHashMap<String, StringName> _script_class_file_to_path;\n-\tHashMap<Ref<Script>, Ref<Texture>> _script_icon_cache;\n+\tHashMap<String, Ref<Texture>> _script_icon_cache;\n \n \tRef<Texture2D> _load_script_icon(const String &p_path) const;\n \n@@ -241,7 +241,6 @@ class EditorData {\n \tvoid notify_scene_saved(const String &p_path);\n \n \tbool script_class_is_parent(const String &p_class, const String &p_inherits);\n-\tStringName script_class_get_base(const String &p_class) const;\n \tVariant script_class_instance(const String &p_class);\n \n \tRef<Script> script_class_load_script(const String &p_class) const;\n@@ -249,7 +248,7 @@ class EditorData {\n \tStringName script_class_get_name(const String &p_path) const;\n \tvoid script_class_set_name(const String &p_path, const StringName &p_class);\n \n-\tString script_class_get_icon_path(const String &p_class) const;\n+\tString script_class_get_icon_path(const String &p_class, bool *r_valid = nullptr) const;\n \tvoid script_class_set_icon_path(const String &p_class, const String &p_icon_path);\n \tvoid script_class_clear_icon_paths() { _script_class_icon_paths.clear(); }\n \tvoid script_class_save_icon_paths();\n@@ -257,7 +256,7 @@ class EditorData {\n \n \tRef<Texture2D> extension_class_get_icon(const String &p_class) const;\n \n-\tRef<Texture2D> get_script_icon(const Ref<Script> &p_script);\n+\tRef<Texture2D> get_script_icon(const String &p_script_path);\n \tvoid clear_script_icon_cache();\n \n \tEditorData();\ndiff --git a/editor/editor_file_system.cpp b/editor/editor_file_system.cpp\nindex b8ce3ff65bf7..1db6c2a188e4 100644\n--- a/editor/editor_file_system.cpp\n+++ b/editor/editor_file_system.cpp\n@@ -49,7 +49,7 @@\n \n EditorFileSystem *EditorFileSystem::singleton = nullptr;\n //the name is the version, to keep compatibility with different versions of Godot\n-#define CACHE_FILE_NAME \"filesystem_cache8\"\n+#define CACHE_FILE_NAME \"filesystem_cache10\"\n \n int EditorFileSystemDirectory::find_file_index(const String &p_file) const {\n \tfor (int i = 0; i < files.size(); i++) {\n@@ -166,19 +166,19 @@ uint64_t EditorFileSystemDirectory::get_file_import_modified_time(int p_idx) con\n }\n \n String EditorFileSystemDirectory::get_file_script_class_name(int p_idx) const {\n-\treturn files[p_idx]->script_class_name;\n+\treturn files[p_idx]->class_info.name;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_extends(int p_idx) const {\n-\treturn files[p_idx]->script_class_extends;\n+\treturn files[p_idx]->class_info.extends;\n }\n \n String EditorFileSystemDirectory::get_file_script_class_icon_path(int p_idx) const {\n-\treturn files[p_idx]->script_class_icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n String EditorFileSystemDirectory::get_file_icon_path(int p_idx) const {\n-\treturn files[p_idx]->icon_path;\n+\treturn files[p_idx]->class_info.icon_path;\n }\n \n StringName EditorFileSystemDirectory::get_file_type(int p_idx) const {\n@@ -303,13 +303,13 @@ void EditorFileSystem::_first_scan_process_scripts(const ScannedDirectory *p_sca\n \t\t\tconst String type = ResourceLoader::get_resource_type(path);\n \n \t\t\tif (ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n-\t\t\t\tString script_class_extends;\n-\t\t\t\tString script_class_icon_path;\n-\t\t\t\tString script_class_name = _get_global_script_class(type, path, &script_class_extends, &script_class_icon_path);\n-\t\t\t\t_register_global_class_script(path, path, type, script_class_name, script_class_extends, script_class_icon_path);\n+\t\t\t\tconst ScriptClassInfo &info = _get_global_script_class(type, path);\n+\t\t\t\tScriptClassInfoUpdate update(info);\n+\t\t\t\tupdate.type = type;\n+\t\t\t\t_register_global_class_script(path, path, update);\n \n-\t\t\t\tif (!script_class_name.is_empty()) {\n-\t\t\t\t\tp_existing_class_names.insert(script_class_name);\n+\t\t\t\tif (!info.name.is_empty()) {\n+\t\t\t\t\tp_existing_class_names.insert(info.name);\n \t\t\t\t}\n \t\t\t}\n \t\t}\n@@ -383,33 +383,25 @@ void EditorFileSystem::_scan_filesystem() {\n \t\t\t\t\tname = cpath.path_join(name);\n \n \t\t\t\t\tFileCache fc;\n-\t\t\t\t\tfc.type = split[1];\n-\t\t\t\t\tif (fc.type.contains_char('/')) {\n-\t\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n-\t\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n-\t\t\t\t\t}\n+\t\t\t\t\tfc.type = split[1].get_slice(\"/\", 0);\n+\t\t\t\t\tfc.resource_script_class = split[1].get_slice(\"/\", 1);\n \t\t\t\t\tfc.uid = split[2].to_int();\n \t\t\t\t\tfc.modification_time = split[3].to_int();\n \t\t\t\t\tfc.import_modification_time = split[4].to_int();\n \t\t\t\t\tfc.import_valid = split[5].to_int() != 0;\n \t\t\t\t\tfc.import_group_file = split[6].strip_edges();\n-\t\t\t\t\tfc.script_class_name = split[7].get_slice(\"<>\", 0);\n-\t\t\t\t\tfc.script_class_extends = split[7].get_slice(\"<>\", 1);\n-\t\t\t\t\tfc.script_class_icon_path = split[7].get_slice(\"<>\", 2);\n-\t\t\t\t\tfc.import_md5 = split[7].get_slice(\"<>\", 3);\n-\t\t\t\t\tString dest_paths = split[7].get_slice(\"<>\", 4);\n-\t\t\t\t\tif (!dest_paths.is_empty()) {\n-\t\t\t\t\t\tfc.import_dest_paths = dest_paths.split(\"<*>\");\n-\t\t\t\t\t}\n-\n-\t\t\t\t\tString deps = split[8].strip_edges();\n-\t\t\t\t\tif (deps.length()) {\n-\t\t\t\t\t\tVector<String> dp = deps.split(\"<>\");\n-\t\t\t\t\t\tfor (int i = 0; i < dp.size(); i++) {\n-\t\t\t\t\t\t\tconst String &path = dp[i];\n-\t\t\t\t\t\t\tfc.deps.push_back(path);\n-\t\t\t\t\t\t}\n+\t\t\t\t\t{\n+\t\t\t\t\t\tconst Vector<String> &slices = split[7].split(\"<>\");\n+\t\t\t\t\t\tERR_CONTINUE(slices.size() < 7);\n+\t\t\t\t\t\tfc.class_info.name = slices[0];\n+\t\t\t\t\t\tfc.class_info.extends = slices[1];\n+\t\t\t\t\t\tfc.class_info.icon_path = slices[2];\n+\t\t\t\t\t\tfc.class_info.is_abstract = slices[3].to_int();\n+\t\t\t\t\t\tfc.class_info.is_tool = slices[4].to_int();\n+\t\t\t\t\t\tfc.import_md5 = slices[5];\n+\t\t\t\t\t\tfc.import_dest_paths = slices[6].split(\"<*>\");\n \t\t\t\t\t}\n+\t\t\t\t\tfc.deps = split[8].strip_edges().split(\"<>\");\n \n \t\t\t\t\tfile_cache[name] = fc;\n \t\t\t\t}\n@@ -859,7 +851,7 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\t}\n \n \t\t\t\tif (ClassDB::is_parent_class(ia.new_file->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(new_file_path, ia.new_file->type, ia.new_file->script_class_name, ia.new_file->script_class_extends, ia.new_file->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(new_file_path, ScriptClassInfoUpdate::from_file_info(ia.new_file));\n \t\t\t\t}\n \t\t\t\tif (ia.new_file->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(new_file_path);\n@@ -870,9 +862,9 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tint idx = ia.dir->find_file_index(ia.file);\n \t\t\t\tERR_CONTINUE(idx == -1);\n \n-\t\t\t\tString script_class_name = ia.dir->files[idx]->script_class_name;\n+\t\t\t\tString class_name = ia.dir->files[idx]->class_info.name;\n \t\t\t\tif (ClassDB::is_parent_class(ia.dir->files[idx]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), \"\", \"\", \"\", \"\");\n+\t\t\t\t\t_queue_update_script_class(ia.dir->get_file_path(idx), ScriptClassInfoUpdate());\n \t\t\t\t}\n \t\t\t\tif (ia.dir->files[idx]->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t_queue_update_scene_groups(ia.dir->get_file_path(idx));\n@@ -883,11 +875,11 @@ bool EditorFileSystem::_update_scan_actions() {\n \t\t\t\tia.dir->files.remove_at(idx);\n \n \t\t\t\t// Restore another script with the same global class name if it exists.\n-\t\t\t\tif (!script_class_name.is_empty()) {\n+\t\t\t\tif (!class_name.is_empty()) {\n \t\t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n-\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, script_class_name, old_fi);\n+\t\t\t\t\tString old_file = _get_file_by_class_name(filesystem, class_name, old_fi);\n \t\t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \n@@ -1161,10 +1153,8 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = fc->import_md5;\n \t\t\t\tfi->import_dest_paths = fc->import_dest_paths;\n \t\t\t\tfi->import_valid = fc->import_valid;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n \t\t\t\tfi->import_group_file = fc->import_group_file;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\t// Ensures backward compatibility when the project is loaded for the first time with the added import_md5\n \t\t\t\t// and import_dest_paths properties in the file cache.\n@@ -1202,7 +1192,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t} else {\n \t\t\t\t// Using get_resource_import_info() to prevent calling 3 times ResourceFormatImporter::_get_path_and_type.\n \t\t\t\tResourceFormatImporter::get_singleton()->get_resource_import_info(path, fi->type, fi->uid, fi->import_group_file);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->modified_time = 0;\n \t\t\t\tfi->import_modified_time = 0;\n \t\t\t\tfi->import_md5 = \"\";\n@@ -1227,22 +1217,20 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\tfi->import_md5 = \"\";\n \t\t\t\tfi->import_dest_paths = Vector<String>();\n \t\t\t\tfi->import_valid = true;\n-\t\t\t\tfi->script_class_name = fc->script_class_name;\n-\t\t\t\tfi->script_class_extends = fc->script_class_extends;\n-\t\t\t\tfi->script_class_icon_path = fc->script_class_icon_path;\n+\t\t\t\tfi->class_info = fc->class_info;\n \n \t\t\t\tif (first_scan && ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n \t\t\t\t\tbool update_script = false;\n-\t\t\t\t\tString old_class_name = fi->script_class_name;\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n-\t\t\t\t\tif (old_class_name != fi->script_class_name) {\n+\t\t\t\t\tString old_class_name = fi->class_info.name;\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n+\t\t\t\t\tif (old_class_name != fi->class_info.name) {\n \t\t\t\t\t\tupdate_script = true;\n-\t\t\t\t\t} else if (!fi->script_class_name.is_empty() && (!ScriptServer::is_global_class(fi->script_class_name) || ScriptServer::get_global_class_path(fi->script_class_name) != path)) {\n+\t\t\t\t\t} else if (!fi->class_info.name.is_empty() && (!ScriptServer::is_global_class(fi->class_info.name) || ScriptServer::get_global_class_path(fi->class_info.name) != path)) {\n \t\t\t\t\t\t// This script has a class name but is not in the global class names or the path of the class has changed.\n \t\t\t\t\t\tupdate_script = true;\n \t\t\t\t\t}\n \t\t\t\t\tif (update_script) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t} else {\n@@ -1256,7 +1244,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t}\n \t\t\t\tfi->uid = ResourceLoader::get_resource_uid(path);\n-\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\tfi->deps = _get_dependencies(path);\n \t\t\t\tfi->modified_time = mt;\n \t\t\t\tfi->import_modified_time = 0;\n@@ -1267,7 +1255,7 @@ void EditorFileSystem::_process_file_system(const ScannedDirectory *p_scan_dir,\n \t\t\t\t// Files in dep_update_list are forced for rescan to update dependencies. They don't need other updates.\n \t\t\t\tif (!dep_update_list.has(path)) {\n \t\t\t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t\t_queue_update_script_class(path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t\t\t_queue_update_script_class(path, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t\t\t}\n \t\t\t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t\t\t_queue_update_scene_groups(path);\n@@ -1428,7 +1416,7 @@ void EditorFileSystem::_scan_fs_changes(EditorFileSystemDirectory *p_dir, ScanPr\n \t\t\t\t\tif (fi->type == \"\" && other_file_extensions.has(ext)) {\n \t\t\t\t\t\tfi->type = \"OtherFile\";\n \t\t\t\t\t}\n-\t\t\t\t\tfi->script_class_name = _get_global_script_class(fi->type, path, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\t\t\tfi->class_info = _get_global_script_class(fi->type, path);\n \t\t\t\t\tfi->import_valid = (fi->type == \"TextFile\" || fi->type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(path);\n \t\t\t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(path);\n \n@@ -1587,7 +1575,7 @@ void EditorFileSystem::_remove_invalid_global_class_names(const HashSet<String>\n \n String EditorFileSystem::_get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info) {\n \tfor (EditorFileSystemDirectory::FileInfo *fi : p_dir->files) {\n-\t\tif (fi->script_class_name == p_class_name) {\n+\t\tif (fi->class_info.name == p_class_name) {\n \t\t\tr_file_info = fi;\n \t\t\treturn p_dir->get_path().path_join(fi->file);\n \t\t}\n@@ -1768,7 +1756,7 @@ void EditorFileSystem::_save_filesystem_cache(EditorFileSystemDirectory *p_dir,\n \t\tcache_string.append(itos(file_info->import_modified_time));\n \t\tcache_string.append(itos(file_info->import_valid));\n \t\tcache_string.append(file_info->import_group_file);\n-\t\tcache_string.append(String(\"<>\").join({ file_info->script_class_name, file_info->script_class_extends, file_info->script_class_icon_path, file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n+\t\tcache_string.append(String(\"<>\").join({ file_info->class_info.name, file_info->class_info.extends, file_info->class_info.icon_path, itos(file_info->class_info.is_abstract), itos(file_info->class_info.is_tool), file_info->import_md5, String(\"<*>\").join(file_info->import_dest_paths) }));\n \t\tcache_string.append(String(\"<>\").join(file_info->deps));\n \n \t\tp_file->store_line(String(\"::\").join(cache_string));\n@@ -1980,29 +1968,21 @@ Vector<String> EditorFileSystem::_get_dependencies(const String &p_path) {\n \treturn ret;\n }\n \n-String EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const {\n+EditorFileSystem::ScriptClassInfo EditorFileSystem::_get_global_script_class(const String &p_type, const String &p_path) const {\n+\tScriptClassInfo info;\n \tfor (int i = 0; i < ScriptServer::get_language_count(); i++) {\n \t\tif (ScriptServer::get_language(i)->handles_global_class_type(p_type)) {\n-\t\t\tString global_name;\n-\t\t\tString extends;\n-\t\t\tString icon_path;\n-\n-\t\t\tglobal_name = ScriptServer::get_language(i)->get_global_class_name(p_path, &extends, &icon_path);\n-\t\t\t*r_extends = extends;\n-\t\t\t*r_icon_path = icon_path;\n-\t\t\treturn global_name;\n+\t\t\tinfo.name = ScriptServer::get_language(i)->get_global_class_name(p_path, &info.extends, &info.icon_path, &info.is_abstract, &info.is_tool);\n \t\t}\n \t}\n-\t*r_extends = String();\n-\t*r_icon_path = String();\n-\treturn String();\n+\treturn info;\n }\n \n void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInfo *file_info) {\n \tString icon_path;\n \tif (file_info->resource_script_class != StringName()) {\n \t\ticon_path = EditorNode::get_editor_data().script_class_get_icon_path(file_info->resource_script_class);\n-\t} else if (file_info->script_class_icon_path.is_empty() && !file_info->deps.is_empty()) {\n+\t} else if (file_info->class_info.icon_path.is_empty() && !file_info->deps.is_empty()) {\n \t\tconst String &script_dep = file_info->deps[0]; // Assuming the first dependency is a script.\n \t\tconst String &script_path = script_dep.contains(\"::\") ? script_dep.get_slice(\"::\", 2) : script_dep;\n \t\tif (!script_path.is_empty()) {\n@@ -2014,7 +1994,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t\t\t\tint script_file;\n \t\t\t\t\tEditorFileSystemDirectory *efsd = find_file(script_path, &script_file);\n \t\t\t\t\tif (efsd) {\n-\t\t\t\t\t\ticon_path = efsd->files[script_file]->script_class_icon_path;\n+\t\t\t\t\t\ticon_path = efsd->files[script_file]->class_info.icon_path;\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tfile_icon_cache.insert(script_path, icon_path);\n@@ -2029,7 +2009,7 @@ void EditorFileSystem::_update_file_icon_path(EditorFileSystemDirectory::FileInf\n \t\t}\n \t}\n \n-\tfile_info->icon_path = icon_path;\n+\tfile_info->class_info.icon_path = icon_path;\n }\n \n void EditorFileSystem::_update_files_icon_path(EditorFileSystemDirectory *edp) {\n@@ -2068,10 +2048,10 @@ void EditorFileSystem::_update_script_classes() {\n \t\t}\n \n \t\tint step_count = 0;\n-\t\tfor (const KeyValue<String, ScriptInfo> &E : update_script_paths) {\n-\t\t\t_register_global_class_script(E.key, E.key, E.value.type, E.value.script_class_name, E.value.script_class_extends, E.value.script_class_icon_path);\n+\t\tfor (const KeyValue<String, ScriptClassInfoUpdate> &E : update_script_paths) {\n+\t\t\t_register_global_class_script(E.key, E.key, E.value);\n \t\t\tif (ep) {\n-\t\t\t\tep->step(E.value.script_class_name, step_count++, false);\n+\t\t\t\tep->step(E.value.name, step_count++, false);\n \t\t\t}\n \t\t}\n \n@@ -2181,16 +2161,10 @@ void EditorFileSystem::_process_update_pending() {\n \t_update_pending_scene_groups();\n }\n \n-void EditorFileSystem::_queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update) {\n \tMutexLock update_script_lock(update_script_mutex);\n \n-\tScriptInfo si;\n-\tsi.type = p_type;\n-\tsi.script_class_name = p_script_class_name;\n-\tsi.script_class_extends = p_script_class_extends;\n-\tsi.script_class_icon_path = p_script_class_icon_path;\n-\tupdate_script_paths.insert(p_path, si);\n-\n+\tupdate_script_paths.insert(p_path, p_script_update);\n \tupdate_script_paths_documentation.insert(p_path);\n }\n \n@@ -2291,8 +2265,10 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t\t\t}\n \t\t\t\t}\n \t\t\t\tif (ClassDB::is_parent_class(fs->files[cpos]->type, SNAME(\"Script\"))) {\n-\t\t\t\t\t_queue_update_script_class(file, fs->files[cpos]->type, \"\", \"\", \"\");\n-\t\t\t\t\tif (!fs->files[cpos]->script_class_icon_path.is_empty()) {\n+\t\t\t\t\tScriptClassInfoUpdate update;\n+\t\t\t\t\tupdate.type = fs->files[cpos]->type;\n+\t\t\t\t\t_queue_update_script_class(file, update);\n+\t\t\t\t\tif (!fs->files[cpos]->class_info.icon_path.is_empty()) {\n \t\t\t\t\t\tupdate_files_icon_cache = true;\n \t\t\t\t\t}\n \t\t\t\t}\n@@ -2349,16 +2325,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\t}\n \n \t\t\tEditorFileSystemDirectory::FileInfo *fi = fs->files[cpos];\n-\t\t\tconst String old_script_class_icon_path = fi->script_class_icon_path;\n-\t\t\tconst String old_class_name = fi->script_class_name;\n+\t\t\tconst String old_script_class_icon_path = fi->class_info.icon_path;\n+\t\t\tconst String old_class_name = fi->class_info.name;\n \t\t\tfi->type = type;\n \t\t\tfi->resource_script_class = script_class;\n \t\t\tfi->uid = uid;\n-\t\t\tfi->script_class_name = _get_global_script_class(type, file, &fi->script_class_extends, &fi->script_class_icon_path);\n+\t\t\tfi->class_info = _get_global_script_class(type, file);\n \t\t\tfi->import_group_file = ResourceLoader::get_import_group_file(file);\n \t\t\tfi->modified_time = FileAccess::get_modified_time(file);\n \t\t\tfi->deps = _get_dependencies(file);\n-\t\t\tfi->import_valid = type == \"TextFile\" || type == \"OtherFile\" || ResourceLoader::is_import_valid(file);\n+\t\t\tfi->import_valid = (type == \"TextFile\" || type == \"OtherFile\") ? true : ResourceLoader::is_import_valid(file);\n \n \t\t\tif (uid != ResourceUID::INVALID_ID) {\n \t\t\t\tif (ResourceUID::get_singleton()->has_id(uid)) {\n@@ -2384,7 +2360,7 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \t\t\tEditorResourcePreview::get_singleton()->check_for_invalidation(file);\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Script\"))) {\n-\t\t\t\t_queue_update_script_class(file, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\t\t\t_queue_update_script_class(file, ScriptClassInfoUpdate::from_file_info(fi));\n \t\t\t}\n \t\t\tif (fi->type == SNAME(\"PackedScene\")) {\n \t\t\t\t_queue_update_scene_groups(file);\n@@ -2392,16 +2368,16 @@ void EditorFileSystem::update_files(const Vector<String> &p_script_paths) {\n \n \t\t\tif (ClassDB::is_parent_class(fi->type, SNAME(\"Resource\"))) {\n \t\t\t\tfiles_to_update_icon_path.push_back(fi);\n-\t\t\t} else if (old_script_class_icon_path != fi->script_class_icon_path) {\n+\t\t\t} else if (old_script_class_icon_path != fi->class_info.icon_path) {\n \t\t\t\tupdate_files_icon_cache = true;\n \t\t\t}\n \n \t\t\t// Restore another script as the global class name if multiple scripts had the same old class name.\n-\t\t\tif (!old_class_name.is_empty() && fi->script_class_name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n+\t\t\tif (!old_class_name.is_empty() && fi->class_info.name != old_class_name && ClassDB::is_parent_class(type, SNAME(\"Script\"))) {\n \t\t\t\tEditorFileSystemDirectory::FileInfo *old_fi = nullptr;\n \t\t\t\tString old_file = _get_file_by_class_name(filesystem, old_class_name, old_fi);\n \t\t\t\tif (!old_file.is_empty() && old_fi) {\n-\t\t\t\t\t_queue_update_script_class(old_file, old_fi->type, old_fi->script_class_name, old_fi->script_class_extends, old_fi->script_class_icon_path);\n+\t\t\t\t\t_queue_update_script_class(old_file, ScriptClassInfoUpdate::from_file_info(old_fi));\n \t\t\t\t}\n \t\t\t}\n \t\t\tupdated = true;\n@@ -2435,16 +2411,16 @@ HashSet<String> EditorFileSystem::get_valid_extensions() const {\n \treturn valid_extensions;\n }\n \n-void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path) {\n+void EditorFileSystem::_register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update) {\n \tScriptServer::remove_global_class_by_path(p_search_path); // First remove, just in case it changed\n \n-\tif (p_script_class_name.is_empty()) {\n+\tif (p_script_update.name.is_empty()) {\n \t\treturn;\n \t}\n \n \tString lang;\n \tfor (int j = 0; j < ScriptServer::get_language_count(); j++) {\n-\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_type)) {\n+\t\tif (ScriptServer::get_language(j)->handles_global_class_type(p_script_update.type)) {\n \t\t\tlang = ScriptServer::get_language(j)->get_name();\n \t\t\tbreak;\n \t\t}\n@@ -2453,9 +2429,9 @@ void EditorFileSystem::_register_global_class_script(const String &p_search_path\n \t\treturn; // No lang found that can handle this global class\n \t}\n \n-\tScriptServer::add_global_class(p_script_class_name, p_script_class_extends, lang, p_target_path);\n-\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_class_name, p_script_class_icon_path);\n-\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_class_name);\n+\tScriptServer::add_global_class(p_script_update.name, p_script_update.extends, lang, p_target_path, p_script_update.is_abstract, p_script_update.is_tool);\n+\tEditorNode::get_editor_data().script_class_set_icon_path(p_script_update.name, p_script_update.icon_path);\n+\tEditorNode::get_editor_data().script_class_set_name(p_target_path, p_script_update.name);\n }\n \n void EditorFileSystem::register_global_class_script(const String &p_search_path, const String &p_target_path) {\n@@ -2463,7 +2439,7 @@ void EditorFileSystem::register_global_class_script(const String &p_search_path,\n \tEditorFileSystemDirectory *efsd = find_file(p_search_path, &index_file);\n \tif (efsd) {\n \t\tconst EditorFileSystemDirectory::FileInfo *fi = efsd->files[index_file];\n-\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, fi->type, fi->script_class_name, fi->script_class_extends, fi->script_class_icon_path);\n+\t\tEditorFileSystem::get_singleton()->_register_global_class_script(p_search_path, p_target_path, ScriptClassInfoUpdate::from_file_info(fi));\n \t} else {\n \t\tScriptServer::remove_global_class_by_path(p_search_path);\n \t}\ndiff --git a/editor/editor_file_system.h b/editor/editor_file_system.h\nindex 61041209a7fd..5b78b86a3f3f 100644\n--- a/editor/editor_file_system.h\n+++ b/editor/editor_file_system.h\n@@ -66,11 +66,15 @@ class EditorFileSystemDirectory : public Object {\n \t\tString import_group_file;\n \t\tVector<String> deps;\n \t\tbool verified = false; //used for checking changes\n-\t\t// These are for script resources only.\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n-\t\tString icon_path;\n+\t\t// This is for script resources only.\n+\t\tstruct ScriptClassInfo {\n+\t\t\tString name;\n+\t\t\tString extends;\n+\t\t\tString icon_path;\n+\t\t\tbool is_abstract = false;\n+\t\t\tbool is_tool = false;\n+\t\t};\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tVector<FileInfo *> files;\n@@ -203,9 +207,11 @@ class EditorFileSystem : public Node {\n \n \tstatic EditorFileSystem *singleton;\n \n+\tusing ScriptClassInfo = EditorFileSystemDirectory::FileInfo::ScriptClassInfo;\n+\n \t/* Used for reading the filesystem cache file */\n \tstruct FileCache {\n-\t\tString type;\n+\t\tStringName type;\n \t\tString resource_script_class;\n \t\tResourceUID::ID uid = ResourceUID::INVALID_ID;\n \t\tuint64_t modification_time = 0;\n@@ -215,9 +221,7 @@ class EditorFileSystem : public Node {\n \t\tVector<String> deps;\n \t\tbool import_valid = false;\n \t\tString import_group_file;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\t\tScriptClassInfo class_info;\n \t};\n \n \tHashMap<String, FileCache> file_cache;\n@@ -288,17 +292,27 @@ class EditorFileSystem : public Node {\n \t\t}\n \t};\n \n-\tstruct ScriptInfo {\n-\t\tString type;\n-\t\tString script_class_name;\n-\t\tString script_class_extends;\n-\t\tString script_class_icon_path;\n+\tstruct ScriptClassInfoUpdate : public ScriptClassInfo {\n+\t\tStringName type;\n+\t\tScriptClassInfoUpdate() = default;\n+\t\texplicit ScriptClassInfoUpdate(const ScriptClassInfo &p_info) :\n+\t\t\t\tScriptClassInfo(p_info) {}\n+\t\tstatic ScriptClassInfoUpdate from_file_info(const EditorFileSystemDirectory::FileInfo *p_fi) {\n+\t\t\tScriptClassInfoUpdate update;\n+\t\t\tupdate.type = p_fi->type;\n+\t\t\tupdate.name = p_fi->class_info.name;\n+\t\t\tupdate.extends = p_fi->class_info.extends;\n+\t\t\tupdate.icon_path = p_fi->class_info.icon_path;\n+\t\t\tupdate.is_abstract = p_fi->class_info.is_abstract;\n+\t\t\tupdate.is_tool = p_fi->class_info.is_tool;\n+\t\t\treturn update;\n+\t\t}\n \t};\n \n \tMutex update_script_mutex;\n-\tHashMap<String, ScriptInfo> update_script_paths;\n+\tHashMap<String, ScriptClassInfoUpdate> update_script_paths;\n \tHashSet<String> update_script_paths_documentation;\n-\tvoid _queue_update_script_class(const String &p_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _queue_update_script_class(const String &p_path, const ScriptClassInfoUpdate &p_script_update);\n \tvoid _update_script_classes();\n \tvoid _update_script_documentation();\n \tvoid _process_update_pending();\n@@ -312,7 +326,7 @@ class EditorFileSystem : public Node {\n \tvoid _update_pending_scene_groups();\n \tvoid _get_all_scenes(EditorFileSystemDirectory *p_dir, HashSet<String> &r_list);\n \n-\tString _get_global_script_class(const String &p_type, const String &p_path, String *r_extends, String *r_icon_path) const;\n+\tScriptClassInfo _get_global_script_class(const String &p_type, const String &p_path) const;\n \n \tstatic Error _resource_import(const String &p_path);\n \tstatic Ref<Resource> _load_resource_on_startup(ResourceFormatImporter *p_importer, const String &p_path, Error *r_error, bool p_use_sub_threads, float *r_progress, ResourceFormatLoader::CacheMode p_cache_mode);\n@@ -359,7 +373,7 @@ class EditorFileSystem : public Node {\n \tvoid _remove_invalid_global_class_names(const HashSet<String> &p_existing_class_names);\n \tString _get_file_by_class_name(EditorFileSystemDirectory *p_dir, const String &p_class_name, EditorFileSystemDirectory::FileInfo *&r_file_info);\n \n-\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const String &p_type, const String &p_script_class_name, const String &p_script_class_extends, const String &p_script_class_icon_path);\n+\tvoid _register_global_class_script(const String &p_search_path, const String &p_target_path, const ScriptClassInfoUpdate &p_script_update);\n \n protected:\n \tvoid _notification(int p_what);\ndiff --git a/editor/editor_node.cpp b/editor/editor_node.cpp\nindex 4b7abdf2b072..3ada85d3de91 100644\n--- a/editor/editor_node.cpp\n+++ b/editor/editor_node.cpp\n@@ -4805,13 +4805,13 @@ void EditorNode::_pick_main_scene_custom_action(const String &p_custom_action_na\n \t}\n }\n \n-Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback, bool p_fallback_script_to_theme) {\n+Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback, bool p_fallback_script_to_theme) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \tEditorData &ed = EditorNode::get_editor_data();\n \n \t// Check for a script icon first.\n-\tif (p_script.is_valid()) {\n-\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script);\n+\tif (!p_script_path.is_empty()) {\n+\t\tRef<Texture2D> script_icon = ed.get_script_icon(p_script_path);\n \t\tif (script_icon.is_valid()) {\n \t\t\treturn script_icon;\n \t\t}\n@@ -4819,14 +4819,15 @@ Ref<Texture2D> EditorNode::_get_class_or_script_icon(const String &p_class, cons\n \t\tif (p_fallback_script_to_theme) {\n \t\t\t// Look for the native base type in the editor theme. This is relevant for\n \t\t\t// scripts extending other scripts and for built-in classes.\n-\t\t\tString script_class_name = p_script->get_language()->get_global_class_name(p_script->get_path());\n \t\t\tString base_type;\n-\t\t\tif (script_class_name.is_empty()) {\n-\t\t\t\tbase_type = p_script->get_instance_base_type();\n+\t\t\tif (ScriptServer::is_global_class(p_class)) {\n+\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(p_class);\n \t\t\t} else {\n-\t\t\t\tbase_type = ScriptServer::get_global_class_native_base(script_class_name);\n+\t\t\t\tRef<Script> scr = ResourceLoader::load(p_script_path, \"Script\");\n+\t\t\t\tif (scr.is_valid()) {\n+\t\t\t\t\tbase_type = scr->get_instance_base_type();\n+\t\t\t\t}\n \t\t\t}\n-\n \t\t\tif (theme.is_valid() && theme->has_icon(base_type, EditorStringName(EditorIcons))) {\n \t\t\t\treturn theme->get_icon(base_type, EditorStringName(EditorIcons));\n \t\t\t}\n@@ -4899,21 +4900,21 @@ Ref<Texture2D> EditorNode::get_object_icon(const Object *p_object, const String\n \tif (Object::cast_to<MultiNodeEdit>(p_object)) {\n \t\treturn get_class_icon(Object::cast_to<MultiNodeEdit>(p_object)->get_edited_class_name(), p_fallback);\n \t} else {\n-\t\treturn _get_class_or_script_icon(p_object->get_class(), scr, p_fallback);\n+\t\treturn _get_class_or_script_icon(p_object->get_class(), scr.is_valid() ? scr->get_path() : String(), p_fallback);\n \t}\n }\n \n Ref<Texture2D> EditorNode::get_class_icon(const String &p_class, const String &p_fallback) {\n \tERR_FAIL_COND_V_MSG(p_class.is_empty(), nullptr, \"Class name cannot be empty.\");\n \n-\tRef<Script> scr;\n+\tString script_path;\n \tif (ScriptServer::is_global_class(p_class)) {\n-\t\tscr = EditorNode::get_editor_data().script_class_load_script(p_class);\n+\t\tscript_path = ScriptServer::get_global_class_path(p_class);\n \t} else if (ResourceLoader::exists(p_class)) { // If the script is not a class_name we check if the script resource exists.\n-\t\tscr = ResourceLoader::load(p_class);\n+\t\tscript_path = p_class;\n \t}\n \n-\treturn _get_class_or_script_icon(p_class, scr, p_fallback, true);\n+\treturn _get_class_or_script_icon(p_class, script_path, p_fallback, true);\n }\n \n bool EditorNode::is_object_of_custom_type(const Object *p_object, const StringName &p_class) {\ndiff --git a/editor/editor_node.h b/editor/editor_node.h\nindex b77f6553fe96..2410996c948e 100644\n--- a/editor/editor_node.h\n+++ b/editor/editor_node.h\n@@ -648,7 +648,7 @@ class EditorNode : public Node {\n \tvoid _feature_profile_changed();\n \tbool _is_class_editor_disabled_by_feature_profile(const StringName &p_class);\n \n-\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const Ref<Script> &p_script, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n+\tRef<Texture2D> _get_class_or_script_icon(const String &p_class, const String &p_script_path, const String &p_fallback = \"Object\", bool p_fallback_script_to_theme = false);\n \n \tvoid _pick_main_scene_custom_action(const String &p_custom_action_name);\n \ndiff --git a/modules/gdscript/gdscript.cpp b/modules/gdscript/gdscript.cpp\nindex db5a3b65ccb0..2383401630c4 100644\n--- a/modules/gdscript/gdscript.cpp\n+++ b/modules/gdscript/gdscript.cpp\n@@ -2831,7 +2831,7 @@ bool GDScriptLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == \"GDScript\";\n }\n \n-String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tError err;\n \tRef<FileAccess> f = FileAccess::open(p_path, FileAccess::READ, &err);\n \tif (err) {\n@@ -2932,6 +2932,12 @@ String GDScriptLanguage::get_global_class_name(const String &p_path, String *r_b\n \tif (r_icon_path) {\n \t\t*r_icon_path = c->simplified_icon_path;\n \t}\n+\tif (r_is_abstract) {\n+\t\t*r_is_abstract = false;\n+\t}\n+\tif (r_is_tool) {\n+\t\t*r_is_tool = parser.is_tool();\n+\t}\n \treturn c->identifier != nullptr ? String(c->identifier->name) : String();\n }\n \ndiff --git a/modules/gdscript/gdscript.h b/modules/gdscript/gdscript.h\nindex ed04482f4811..9e96b8833496 100644\n--- a/modules/gdscript/gdscript.h\n+++ b/modules/gdscript/gdscript.h\n@@ -638,7 +638,7 @@ class GDScriptLanguage : public ScriptLanguage {\n \t/* GLOBAL CLASSES */\n \n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \tvoid add_orphan_subclass(const String &p_qualified_name, const ObjectID &p_subclass);\n \tRef<GDScript> get_orphan_subclass(const String &p_qualified_name);\ndiff --git a/modules/mono/csharp_script.cpp b/modules/mono/csharp_script.cpp\nindex e9a821c65a95..76c3ca3cb3eb 100644\n--- a/modules/mono/csharp_script.cpp\n+++ b/modules/mono/csharp_script.cpp\n@@ -445,9 +445,9 @@ bool CSharpLanguage::handles_global_class_type(const String &p_type) const {\n \treturn p_type == get_type();\n }\n \n-String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path) const {\n+String CSharpLanguage::get_global_class_name(const String &p_path, String *r_base_type, String *r_icon_path, bool *r_is_abstract, bool *r_is_tool) const {\n \tString class_name;\n-\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, &class_name);\n+\tGDMonoCache::managed_callbacks.ScriptManagerBridge_GetGlobalClassName(&p_path, r_base_type, r_icon_path, r_is_abstract, r_is_tool, &class_name);\n \treturn class_name;\n }\n \ndiff --git a/modules/mono/csharp_script.h b/modules/mono/csharp_script.h\nindex 525357a4c413..4dfed135f861 100644\n--- a/modules/mono/csharp_script.h\n+++ b/modules/mono/csharp_script.h\n@@ -530,7 +530,7 @@ class CSharpLanguage : public ScriptLanguage {\n \n \t/* SCRIPT GLOBAL CLASS FUNCTIONS */\n \tvirtual bool handles_global_class_type(const String &p_type) const override;\n-\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr) const override;\n+\tvirtual String get_global_class_name(const String &p_path, String *r_base_type = nullptr, String *r_icon_path = nullptr, bool *r_is_abstract = nullptr, bool *r_is_tool = nullptr) const override;\n \n \t/* DEBUGGER FUNCTIONS */\n \tString debug_get_error() const override;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\nindex c7be0464b6c8..b0ff041fa49a 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ManagedCallbacks.cs\n@@ -19,7 +19,7 @@ public unsafe struct ManagedCallbacks\n         public delegate* unmanaged<godot_string_name*, IntPtr, IntPtr> ScriptManagerBridge_CreateManagedForGodotObjectBinding;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_variant**, int, godot_bool> ScriptManagerBridge_CreateManagedForGodotObjectScriptInstance;\n         public delegate* unmanaged<IntPtr, godot_string_name*, void> ScriptManagerBridge_GetScriptNativeName;\n-        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n+        public delegate* unmanaged<godot_string*, godot_string*, godot_string*, godot_bool*, godot_bool*, godot_string*, void> ScriptManagerBridge_GetGlobalClassName;\n         public delegate* unmanaged<IntPtr, IntPtr, void> ScriptManagerBridge_SetGodotObjectPtr;\n         public delegate* unmanaged<IntPtr, godot_string_name*, godot_variant**, int, godot_bool*, void> ScriptManagerBridge_RaiseEventSignal;\n         public delegate* unmanaged<IntPtr, IntPtr, godot_bool> ScriptManagerBridge_ScriptIsOrInherits;\ndiff --git a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\nindex e53f05f05825..a327b9cd354b 100644\n--- a/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n+++ b/modules/mono/glue/GodotSharp/GodotSharp/Core/Bridge/ScriptManagerBridge.cs\n@@ -199,7 +199,7 @@ internal static unsafe void GetScriptNativeName(IntPtr scriptPtr, godot_string_n\n         }\n \n         [UnmanagedCallersOnly]\n-        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_string* outClassName)\n+        internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_string* outBaseType, godot_string* outIconPath, godot_bool* outIsAbstract, godot_bool* outIsTool, godot_string* outClassName)\n         {\n             // This method must always return the outBaseType for every script, even if the script is\n             // not a global class. But if the script is not a global class it must return an empty\n@@ -254,6 +254,16 @@ internal static unsafe void GetGlobalClassName(godot_string* scriptPath, godot_s\n                 }\n             }\n \n+            if (outIsAbstract != null)\n+            {\n+                *outIsAbstract = scriptType.IsAbstract.ToGodotBool();\n+            }\n+\n+            if (outIsTool != null)\n+            {\n+                *outIsTool = Attribute.IsDefined(scriptType, typeof(ToolAttribute)).ToGodotBool();\n+            }\n+\n             if (!IsGlobalClass(scriptType))\n             {\n                 // Scripts that are not global classes should not have a name.\ndiff --git a/modules/mono/mono_gd/gd_mono_cache.h b/modules/mono/mono_gd/gd_mono_cache.h\nindex 7c24f28b3a2a..f618921cd02b 100644\n--- a/modules/mono/mono_gd/gd_mono_cache.h\n+++ b/modules/mono/mono_gd/gd_mono_cache.h\n@@ -85,7 +85,7 @@ struct ManagedCallbacks {\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectBinding = GCHandleIntPtr(GD_CLR_STDCALL *)(const StringName *, Object *);\n \tusing FuncScriptManagerBridge_CreateManagedForGodotObjectScriptInstance = bool(GD_CLR_STDCALL *)(const CSharpScript *, Object *, const Variant **, int32_t);\n \tusing FuncScriptManagerBridge_GetScriptNativeName = void(GD_CLR_STDCALL *)(const CSharpScript *, StringName *);\n-\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, String *);\n+\tusing FuncScriptManagerBridge_GetGlobalClassName = void(GD_CLR_STDCALL *)(const String *, String *, String *, bool *, bool *, String *);\n \tusing FuncScriptManagerBridge_SetGodotObjectPtr = void(GD_CLR_STDCALL *)(GCHandleIntPtr, Object *);\n \tusing FuncScriptManagerBridge_RaiseEventSignal = void(GD_CLR_STDCALL *)(GCHandleIntPtr, const StringName *, const Variant **, int32_t, bool *);\n \tusing FuncScriptManagerBridge_ScriptIsOrInherits = bool(GD_CLR_STDCALL *)(const CSharpScript *, const CSharpScript *);\n", "instance_id": "godotengine__godot-101489", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue of excessive error spam when a global script contains an error in the editor. It specifies the context (global scripts with `class_name`), the observed behavior (error spam during editor interactions like autocompletion or node creation), and the desired improvement (avoid unnecessary parsing by using caching). Steps to reproduce are provided, which helps in understanding the issue. However, there are minor ambiguities: the statement lacks explicit mention of expected input/output formats for the solution, and it does not detail specific edge cases or constraints (e.g., performance impact of caching or handling of script dependencies). Additionally, the problem statement does not fully align with the provided code changes, as the changes seem to focus on extending global class properties (like `is_abstract` and `is_tool`) rather than directly addressing caching or error spam reduction. This discrepancy introduces some confusion about the intended solution scope.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of code changes is significant, spanning multiple files and modules (e.g., `ScriptServer`, `EditorFileSystem`, `EditorData`, and language-specific implementations like GDScript and C#). This requires a deep understanding of the Godot engine's architecture, particularly how global scripts are managed, parsed, and integrated into the editor. Second, the changes involve multiple technical concepts, including script language extensions, editor data caching, file system interactions, and handling of script metadata (e.g., abstract and tool properties). Third, while the problem statement focuses on error spam, the code changes suggest a broader refactoring of how global class information is stored and accessed, which impacts the system's architecture and requires careful consideration of backward compatibility and performance. Finally, potential edge cases (e.g., handling invalid or cyclic script dependencies, ensuring cache consistency across editor sessions) and error handling modifications add to the complexity. A score of 0.65 reflects the need for a solid grasp of the codebase and the ability to navigate complex interactions, though it does not reach the \"Very Hard\" range as it does not involve advanced domain-specific algorithms or system-level redesigns.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "GPUParticles2D emission mask captures random color instead of pixel color\n### Tested versions\n\n- Reproducible in: v4.2.stable.mono.official [46dc27791]\n\n### System information\n\nGodot v4.2.stable.mono - Windows 10.0.22621 - Vulkan (Forward+) - dedicated NVIDIA GeForce RTX 3060 (NVIDIA; 31.0.15.4629) - 13th Gen Intel(R) Core(TM) i5-13600KF (20 Threads)\n\n### Issue description\n\nEmission mask for GPUParticles2D captures colors incorrectly, instead of copying colors from place where particles spawned, it uses random color from mask texture\n\n### Steps to reproduce\n\n1. Create `GPUParticles2D` node\r\n2. Set `Amount` to 10000 to make it look more detailed\r\n3. Create `ParticlesProcessMaterial` for it\r\n4. Load emission mask for it, using some color texture and with options `Solid pixels` and `Capture Colors from Pixels` (`centered` doesn't matter)\r\n5. View result\n\n### Minimal reproduction project (MRP)\n\n[Bug.zip](https://github.com/godotengine/godot/files/14071691/Bug.zip)\r\n\n", "patch": "diff --git a/scene/resources/particle_process_material.cpp b/scene/resources/particle_process_material.cpp\nindex dd81b1c4380d..13bc02014b01 100644\n--- a/scene/resources/particle_process_material.cpp\n+++ b/scene/resources/particle_process_material.cpp\n@@ -523,6 +523,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tfloat animation_offset;\\n\";\n \tcode += \"\tfloat lifetime;\\n\";\n \tcode += \"\tvec4 color;\\n\";\n+\tcode += \"\tfloat emission_texture_position;\\n\";\n \tcode += \"};\\n\\n\";\n \n \tcode += \"struct DynamicsParameters {\\n\";\n@@ -579,11 +580,15 @@ void ParticleProcessMaterial::_update_shader() {\n \tif (color_initial_ramp.is_valid()) {\n \t\tcode += \"\tparams.color *= texture(color_initial_ramp, vec2(rand_from_seed(alt_seed)));\\n\";\n \t}\n-\tif (emission_color_texture.is_valid() && (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS)) {\n-\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n-\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n-\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n-\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n+\t\tcode += \"\tparams.emission_texture_position = rand_from_seed(alt_seed);\\n\";\n+\n+\t\tif (emission_color_texture.is_valid()) {\n+\t\t\tcode += \"\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n+\t\t\tcode += \"\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n+\t\t\tcode += \"\tparams.color *= texelFetch(emission_texture_color, emission_tex_ofs, 0);\\n\";\n+\t\t}\n \t}\n \tcode += \"}\\n\\n\";\n \n@@ -614,7 +619,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t}\n \tcode += \"}\\n\\n\";\n \n-\tcode += \"vec3 calculate_initial_position(inout uint alt_seed) {\\n\";\n+\tcode += \"vec3 calculate_initial_position(inout DisplayParameters params, inout uint alt_seed) {\\n\";\n \tcode += \"\tfloat pi = 3.14159;\\n\";\n \tcode += \"\tvec3 pos = vec3(0.0);\\n\";\n \tcode += \"\t{ // Emission shape.\\n\";\n@@ -639,7 +644,7 @@ void ParticleProcessMaterial::_update_shader() {\n \t\tcode += \"\t\tpos = vec3(rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0, rand_from_seed(alt_seed) * 2.0 - 1.0) * emission_box_extents;\\n\";\n \t}\n \tif (emission_shape == EMISSION_SHAPE_POINTS || emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tcode += \"\t\tpos = texelFetch(emission_texture_points, emission_tex_ofs, 0).xyz;\\n\";\n@@ -860,7 +865,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\t\tTRANSFORM[2].xyz = vec3(0.0, 0.0, 1.0);\\n\";\n \tcode += \"\t}\\n\";\n \tcode += \"\tif (RESTART_POSITION) {\\n\";\n-\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(alt_seed);\\n\";\n+\tcode += \"\t\tTRANSFORM[3].xyz = calculate_initial_position(params, alt_seed);\\n\";\n \tif (turbulence_enabled) {\n \t\tcode += \"\t\tfloat initial_turbulence_displacement = mix(turbulence_initial_displacement_min, turbulence_initial_displacement_max, rand_from_seed(alt_seed));\\n\";\n \t\tcode += \"\t\tvec3 noise_direction = get_noise_direction(TRANSFORM[3].xyz);\\n\";\n@@ -871,7 +876,7 @@ void ParticleProcessMaterial::_update_shader() {\n \tcode += \"\tif (RESTART_VELOCITY) {\\n\";\n \tcode += \"\t\tVELOCITY = get_random_direction_from_spread(alt_seed, spread) * dynamic_params.initial_velocity_multiplier;\\n\";\n \tif (emission_shape == EMISSION_SHAPE_DIRECTED_POINTS) {\n-\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(rand_from_seed(alt_seed) * float(emission_texture_point_count)));\\n\";\n+\t\tcode += \"\t\tint point = min(emission_texture_point_count - 1, int(params.emission_texture_position * float(emission_texture_point_count)));\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_size = textureSize(emission_texture_points, 0);\\n\";\n \t\tcode += \"\t\tivec2 emission_tex_ofs = ivec2(point % emission_tex_size.x, point / emission_tex_size.x);\\n\";\n \t\tif (particle_flags[PARTICLE_FLAG_DISABLE_Z]) {\n", "instance_id": "godotengine__godot-101162", "clarity": 2, "difficulty": 0.55, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the GPUParticles2D emission mask in the Godot engine, where it captures random colors instead of the pixel color from the mask texture at the particle spawn location. It provides specific steps to reproduce the issue, system information, and a minimal reproduction project (MRP), which are helpful for understanding the context. However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly define the expected behavior beyond \"copying colors from the place where particles spawned,\" leaving some room for interpretation about how the color mapping should precisely work. Additionally, edge cases or specific constraints (e.g., texture formats, performance implications) are not mentioned, which could be critical for a complete solution. Overall, while the issue is valid and mostly clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively focused, primarily affecting a single file (`particle_process_material.cpp`) and a specific part of the shader generation logic for particle emission in the Godot engine. The changes involve modifying how random values are used to select points from an emission texture to ensure consistent behavior for position and color sampling, which requires understanding the shader code generation process and the interaction between different parameters (e.g., `alt_seed`, `emission_texture_position`). \n\nSecond, the technical concepts involved include shader programming, texture sampling, random number generation in shaders, and the specific mechanics of Godot's particle system. These are moderately complex, especially for someone unfamiliar with graphics programming or Godot's internals, but they are not overly advanced for an experienced developer in this domain. \n\nThird, the code changes impact a critical visual feature (particle color emission), but they do not appear to affect the broader system architecture or require extensive refactoring. The amount of code changed is small, but the logic requires precision to avoid introducing new bugs, such as inconsistent particle behavior or performance issues due to repeated random calculations.\n\nFinally, while the problem statement does not explicitly mention edge cases, the nature of the fix (ens Ascertainable edge cases include scenarios where the emission texture might have varying dimensions or formats, or where the particle count (`Amount`) is extremely high, potentially affecting performance. The code changes do not explicitly add new error handling, but ensuring the random seed (`alt_seed`) behaves consistently across different shader invocations could be tricky and might require subtle adjustments to avoid synchronization issues.\n\nOverall, this problem requires a moderate level of expertise in graphics programming and a good understanding of Godot's particle system internals, along with careful handling of shader logic. It is not a trivial fix, but it is also not a deeply architectural or highly complex issue, placing it in the medium difficulty range at 0.55.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "4.4-dev6: Signals don't work in exported builds if .godot dir was created by dev6\n### Tested versions\n\n- Reproducible in: v4.4.dev6.official [1f47e4c4e]\n- Not reproducible in: v4.4.dev5.official [9e6098432]\n\n### System information\n\nGodot v4.4.dev6 - Ubuntu 24.04.1 LTS 24.04 on X11 - X11 display driver, Multi-window, 2 monitors - OpenGL 3 (Compatibility) - NVIDIA GeForce GTX 1060 6GB (nvidia; 535.183.01) - Intel(R) Core(TM) i5-4570 CPU @ 3.20GHz (4 threads)\n\n### Issue description\n\nIn 4.4-dev6, _signals do not work, at all_ in exported builds. The signal handlers are never called. I have tried both built-in signals (such as clicking a button) and custom signals (calling `.emit()`).\n\nHowever, the circumstances are extremely weird. It is not tied to the Godot version you used to export, but rather, _the Godot version that created the `.godot` directory_.\n\nTo elaborate:\n* If you create a new project in 4.4-dev6, then export it, signals are broken.\n* If you create a project in 4.4-dev5, then upgrade to 4.4-dev6, then export, signals work.\n* However, if you delete the `.godot` directory, then re-open with 4.4-dev6, signals are broken.\n* But, if you then re-open the project (with the `.godot` dir created in dev6) in 4.4-dev5, and export, signals are still broken!\n\nSo this bug can manifest in 4.4-dev5 and earlier, but only if the `.godot` dir was created by dev6.\n\nI'm at a loss to explain this behaviour, but I have tested it extensively (on Linux), both on a \"real\" project and in a minimal repro. I have compared the \"good\" and \"bad\" `.godot` directories and can't see much that would distinguish them - the binary `.scn` files are different but you would expect those to regenerate every time you re-save the scene. And shader cache files are different, but you wouldn't expect that to affect something as unrelated as signals.\n\nAnd to be clear, everything works fine in the editor. It's only broken for exported builds.\n\nI have tested both the Linux native and Web exports, and the issue affects both.\n\n### Steps to reproduce\n\n1. Create a new project using 4.4-dev6.\n2. Create a new \"User Interface\" scene.\n3. Attach a script to the scene.\n4. Add a Button to the scene and give it some text.\n5. In the editor, connect the Button's `pressed()` signal up to a new method.\n6. Add the code `print('Button pressed')` to the signal handler. For good measure, also `$Button.text = 'Pressed'`.\n7. Run the project (setting the scene as the main scene) and verify that clicking the button prints \"Button pressed\" to the console and changes the button text.\n8. Project > Export and add a Linux native export, without changing any settings.\n9. Export Project. Ensure that \"Export With Debug\" is ticked.\n10. From the command line, run `New Game Project.x86_64`.\n11. Observe that clicking the button has no effect, neither printing to the console, nor changing the text.\n\nAs mentioned above, there are some very weird interactions if we change Godot versions:\n- Open the project in dev5 - it is still broken.\n- Delete the `.godot` dir and re-open in dev5 - it now works.\n- Open the project in dev6 - it still works.\n- Delete the `.godot` dir and re-open in dev6 - it is now broken again.\n\n### Minimal reproduction project (MRP)\n\n[signal-repro.zip](https://github.com/user-attachments/files/18038555/signal-repro.zip)\n\n", "patch": "diff --git a/core/object/object.h b/core/object/object.h\nindex da8e8d1b86ee..11b94a7fbf0a 100644\n--- a/core/object/object.h\n+++ b/core/object/object.h\n@@ -572,7 +572,7 @@ class Object {\n \t\tCONNECT_PERSIST = 2, // hint for scene to save this connection\n \t\tCONNECT_ONE_SHOT = 4,\n \t\tCONNECT_REFERENCE_COUNTED = 8,\n-\t\tCONNECT_INHERITED = 16, // Whether or not the connection is in an instance of a scene.\n+\t\tCONNECT_INHERITED = 16, // Used in editor builds.\n \t};\n \n \tstruct Connection {\ndiff --git a/scene/resources/packed_scene.cpp b/scene/resources/packed_scene.cpp\nindex 8b1cbdf488a5..d6748ed2e64f 100644\n--- a/scene/resources/packed_scene.cpp\n+++ b/scene/resources/packed_scene.cpp\n@@ -1060,12 +1060,6 @@ Error SceneState::_parse_connections(Node *p_owner, Node *p_node, HashMap<String\n \t\t\t\tcontinue;\n \t\t\t}\n \n-\t\t\t// Don't include signals that are from scene instances\n-\t\t\t// (they are already saved in the scenes themselves).\n-\t\t\tif (c.flags & CONNECT_INHERITED) {\n-\t\t\t\tcontinue;\n-\t\t\t}\n-\n \t\t\t// only connections that originate or end into main saved scene are saved\n \t\t\t// everything else is discarded\n \n", "instance_id": "godotengine__godot-100235", "clarity": 2, "difficulty": 0.75, "clarity_explanation": "\nThe problem statement is mostly clear and provides a detailed description of the issue, including the specific Godot version affected (4.4-dev6), the nature of the bug (signals not working in exported builds), and the peculiar dependency on the version that created the `.godot` directory. It includes comprehensive steps to reproduce the issue, system information, and even a minimal reproduction project (MRP). The description of the issue's behavior across different versions and conditions is thorough, which aids in understanding the problem's scope. However, there are minor ambiguities that prevent a perfect score: the problem statement does not explicitly discuss potential causes or Ascend (a common issue in bug reports) or provide hints about where in the codebase the issue might lie (e.g., signal handling, export process, or project file management). Additionally, while edge cases are indirectly implied through the version-specific behavior, they are not explicitly outlined as specific test cases beyond the basic reproduction steps. Overall, the statement is clear enough to guide a developer toward diagnosing and fixing the issue, but it lacks some critical technical depth or hypotheses that could further clarify the root cause.\n", "difficulty_explanation": "\nThis problem falls into the \"Hard\" category due to several factors. First, the scope and depth of the issue are significant: the bug affects a core feature (signals) in exported builds, which likely involves understanding the interaction between multiple parts of the Godot engine, such as the scene serialization system (related to the `.godot` directory), signal handling mechanisms, and the export process. The provided code changes, while minimal (modifying a flag's comment and removing a condition in `packed_scene.cpp`), suggest that the fix requires a deep understanding of the engine's internals—specifically, how connections are saved and loaded in packed scenes and the implications of the `CONNECT_INHERITED` flag. The changes impact two files (`object.h` and `packed_scene.cpp`), indicating a need to navigate and modify core components of the codebase, which often have far-reaching architectural implications.\n\nSecond, the number of technical concepts involved is substantial. Solving this requires familiarity with Godot's architecture, particularly scene management, signal systems, and the export pipeline. It also demands knowledge of C++ (the language Godot is written in), including how flags and bitwise operations are used for connection properties. Additionally, debugging version-specific issues tied to project directory metadata (`.godot`) suggests a need for domain-specific knowledge about Godot's project structure and file handling.\n\nThird, potential edge cases and error handling add to the difficulty. While the problem statement does not explicitly list edge cases beyond version interactions, the nature of the bug implies complex scenarios: signals failing in exported builds could involve various signal types (built-in and custom), different export targets (Linux and Web), and interactions between project files created by different engine versions. The fix must ensure that removing the `CONNECT_INHERITED` check does not introduce regressions or break other functionality, such as scene instance handling, which requires careful testing and validation.\n\nFinally, the difficulty is compounded by the fact that the bug manifests only in exported builds, not in the editor, which suggests a discrepancy between runtime environments that must be traced and resolved. This requires advanced debugging skills and potentially performance considerations if signal handling is a critical path in the engine. Overall, while the code change itself is small, the process of identifying the root cause, understanding the implications of the fix, and ensuring no side effects push this problem into the higher end of the difficulty spectrum at 0.75.\n", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Double lock detected in `Warnings::GetMessages()`\n### Is there an existing issue for this?\n\n- [X] I have searched the existing issues\n\n### Current behaviour\n\nRunning `bitcoin-qt -testnet` results in it eventually deadlocking due to a double lock in the warnings code.\n\n### Expected behaviour\n\nShould not double lock.\n\n### Steps to reproduce\n\n1. Build with `--enable-debug` (or define `DEBUG_LOCKORDER`\r\n2. Run `bitcoin-qt -testnet`, and either sync or reindex\r\n3. It will assert and crash on its own (without `DEBUG_LOCKORDER`, it will eventually hang)\n\n### Relevant log output\n\n\r\n```\r\n2024-07-05T23:22:12.212000Z [scheduler] [../../../src/qt/bitcoin.cpp:215] [DebugMessageHandler] [qt] GUI: ClientModel: NotifyAlertChanged\r\n2024-07-05T23:22:12.212029Z [scheduler] [../../../src/sync.cpp:129] [double_lock_detected] DOUBLE LOCK DETECTED\r\n2024-07-05T23:22:12.212052Z [scheduler] [../../../src/sync.cpp:130] [double_lock_detected] Lock order:\r\n2024-07-05T23:22:12.212072Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:31 (in thread 'scheduler')\r\n2024-07-05T23:22:12.212092Z [scheduler] [../../../src/sync.cpp:136] [double_lock_detected]  (*) 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler')\r\nAssertion failed: detected double lock for 'm_mutex' in ../../../src/node/warnings.cpp:46 (in thread 'scheduler'), details in debug log.\r\n```\n\n### How did you obtain Bitcoin Core\n\nCompiled from source\n\n### What version of Bitcoin Core are you using?\n\nbd5d1688b4311e21c0e0ff89a3ae02ef7d0543b8\n\n### Operating system and version\n\nArch\n\n### Machine specifications\n\n_No response_\n", "patch": "diff --git a/src/node/warnings.cpp b/src/node/warnings.cpp\nindex b99c845900abf..87389e472b934 100644\n--- a/src/node/warnings.cpp\n+++ b/src/node/warnings.cpp\n@@ -28,8 +28,7 @@ Warnings::Warnings()\n }\n bool Warnings::Set(warning_type id, bilingual_str message)\n {\n-    LOCK(m_mutex);\n-    const auto& [_, inserted]{m_warnings.insert({id, std::move(message)})};\n+    const auto& [_, inserted]{WITH_LOCK(m_mutex, return m_warnings.insert({id, std::move(message)}))};\n     if (inserted) uiInterface.NotifyAlertChanged();\n     return inserted;\n }\n", "instance_id": "bitcoin__bitcoin-30404", "clarity": 2, "difficulty": 0.25, "clarity_explanation": "The problem statement is mostly clear in identifying the issue: a double lock in the `Warnings::GetMessages()` function leading to a deadlock when running `bitcoin-qt -testnet`. It provides steps to reproduce the issue, relevant log output, and context about the environment (compiled from source, specific version, OS). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly describe the expected behavior beyond \"should not double lock,\" nor does it clarify the broader impact of the deadlock on the system or specify any constraints or edge cases to consider when fixing the issue. Additionally, while the log output points to the specific lines in the code, the statement lacks a detailed explanation of why the double lock occurs or the threading context leading to it. Overall, the problem is valid and mostly clear, but these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem is relatively low, falling into the \"Easy\" range (0.2-0.4). Here's the breakdown based on the evaluation factors:\n\n1. **Scope and Depth of Code Changes:** The provided code change is minimal and confined to a single file (`warnings.cpp`) and a specific function. It replaces a manual `LOCK` macro with a `WITH_LOCK` macro, which is a straightforward modification to address the double lock issue. The change does not impact the broader system architecture or require modifications across multiple modules. The amount of code change is very small, essentially a one-line fix.\n\n2. **Number of Technical Concepts:** Solving this problem requires a basic understanding of threading and mutex locking in C++, specifically within the context of the Bitcoin Core codebase. Familiarity with the `LOCK` and `WITH_LOCK` macros (likely custom utilities for mutex management in the project) is necessary, but these are not overly complex concepts for someone with moderate experience in C++ and multithreaded programming. No advanced algorithms, design patterns, or domain-specific knowledge beyond basic synchronization are required.\n\n3. **Potential Edge Cases and Error Handling:** The problem statement does not mention specific edge cases or additional error handling requirements. The code change itself does not introduce new error handling logic; it simply adjusts the locking mechanism to prevent a deadlock. While deadlocks can be tricky to debug in general, the provided fix and the nature of the issue suggest that edge cases are not a significant concern in this particular solution.\n\n4. **Overall Complexity:** The issue is a bug fix related to thread synchronization, which is a common challenge in C++ programming but not inherently complex in this instance due to the localized and minimal nature of the change. The fix does not require deep understanding of the entire Bitcoin Core codebase or its architecture, as the problem is isolated to a specific locking issue in the warnings module.\n\nGiven these factors, the difficulty score of 0.25 reflects an easy problem that requires understanding some code logic (threading and mutex usage) and making a simple modification. It is slightly above the \"Very Easy\" range due to the need to understand the context of mutex locking and the project's custom macros, but it remains a straightforward fix for a developer with basic to intermediate C++ experience.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "\\n with ENABLE_PROCESSED_OUTPUT and without ENABLE_WRAP_AT_EOL_OUTPUT\n### Windows Terminal version\n\n1.22.2362\n\n### Windows build number\n\n10.0.19045\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nDisable ENABLE_WRAP_AT_EOL_OUTPUT, keep ENABLE_PROCESSED_OUTPUT enabled, write to the end of line, then insert \\n .  Traditionally the newline would operate as CRLF (processed output semantics) and start at the beginning of the following line.  Note this is Win32 semantics, VT semantics are different; in this sequence, VT support is not enabled.\n\nIn WT 1.22.x, this generates VT semantics.  Replacing \\n with \\r\\n works as expected.\n\n```\n#include <windows.h>\n\nint main(int argc, char * argv[])\n{\n    CONSOLE_SCREEN_BUFFER_INFO screenBufferInfo;\n    DWORD consoleWidth;\n    DWORD charIndex;\n    DWORD lineIndex;\n    DWORD charsWritten;\n    HANDLE consoleHandle;\n    LPSTR buffer;\n\n    consoleHandle = GetStdHandle(STD_OUTPUT_HANDLE);\n    GetConsoleScreenBufferInfo(consoleHandle, &screenBufferInfo);\n    consoleWidth = screenBufferInfo.dwSize.X;\n\n    //\n    //  Disable ENABLE_WRAP_AT_EOL_OUTPUT\n    //\n    SetConsoleMode(consoleHandle, ENABLE_PROCESSED_OUTPUT);\n    buffer = malloc(consoleWidth + 1);\n\n    for (lineIndex = 0; lineIndex < 3; lineIndex++) {\n        for (charIndex = 0; charIndex < consoleWidth; charIndex++) {\n            buffer[charIndex] = '1' + lineIndex;\n        }\n        WriteConsole(consoleHandle, buffer, consoleWidth, &charsWritten, NULL);\n        WriteConsole(consoleHandle, \"\\n\", 1, &charsWritten, NULL);\n    }\n\n    return 0;\n}\n```\n\n### Expected Behavior\n\nBehavior in WT 1.21, as well as Conhost, including OpenConsole from WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/77fcdf2e-5693-4294-965c-08c7f5e3a1f8)\n\n### Actual Behavior\n\nBehavior in WT 1.22:\n\n![Image](https://github.com/user-attachments/assets/296a4a57-0c42-4c7b-bd65-6c165e28eb35)\n\n\n", "patch": "diff --git a/src/host/_stream.cpp b/src/host/_stream.cpp\nindex 85cadb1cfef..30901515402 100644\n--- a/src/host/_stream.cpp\n+++ b/src/host/_stream.cpp\n@@ -269,17 +269,26 @@ void WriteCharsLegacy(SCREEN_INFORMATION& screenInfo, const std::wstring_view& t\n             case UNICODE_LINEFEED:\r\n             {\r\n                 auto pos = cursor.GetPosition();\r\n-                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN) && pos.x != 0)\r\n+\r\n+                // If DISABLE_NEWLINE_AUTO_RETURN is not set, any LF behaves like a CRLF.\r\n+                if (WI_IsFlagClear(screenInfo.OutputMode, DISABLE_NEWLINE_AUTO_RETURN))\r\n                 {\r\n                     pos.x = 0;\r\n-                    // This causes the current \\n to be replaced with a \\r\\n in the ConPTY VT output.\r\n-                    wch = 0;\r\n-                    lastCharWrapped = true;\r\n+\r\n+                    // Setting wch=0 and lastCharWrapped=true will cause the code at the end\r\n+                    // of the loop to emit a CRLF. However, we only do this if the preceding\r\n+                    // character isn't already a CR. We don't want to emit CR CR LF after all.\r\n+                    if (it == beg || it[-1] != '\\r')\r\n+                    {\r\n+                        wch = 0;\r\n+                        lastCharWrapped = true;\r\n+                    }\r\n                 }\r\n \r\n                 textBuffer.GetMutableRowByOffset(pos.y).SetWrapForced(false);\r\n                 pos.y = pos.y + 1;\r\n                 AdjustCursorPosition(screenInfo, pos, psScrollY);\r\n+\r\n                 break;\r\n             }\r\n             case UNICODE_CARRIAGERETURN:\r\n", "instance_id": "microsoft__terminal-18781", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue with newline behavior in Windows Terminal version 1.22 when `ENABLE_WRAP_AT_EOL_OUTPUT` is disabled and `ENABLE_PROCESSED_OUTPUT` is enabled. It provides a reproducible code snippet, expected behavior, actual behavior, and visual aids (images) to illustrate the discrepancy. The goal is evident: to restore the traditional Win32 semantics for newline handling (CRLF behavior) instead of the current VT semantics. However, there are minor ambiguities. For instance, the problem statement does not explicitly discuss potential edge cases or constraints beyond the provided example (e.g., behavior with mixed CR/LF sequences or different console modes). Additionally, it lacks detailed context about the broader impact on other terminal features or configurations. While the issue is well-defined for the specific scenario, these missing details prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of code changes is relatively narrow, confined to a single file (`_stream.cpp`) and a specific function (`WriteCharsLegacy`). The diff shows a focused modification of around 10-15 lines, primarily adjusting the logic for handling newline characters (`UNICODE_LINEFEED`) to ensure CRLF behavior under specific conditions. This does not impact the broader system architecture significantly. Second, the technical concepts involved include understanding Windows console modes (`DISABLE_NEWLINE_AUTO_RETURN`, `ENABLE_PROCESSED_OUTPUT`), character encoding nuances (CRLF vs. LF), and the interaction between Win32 and VT semantics. These concepts are moderately complex but not overly advanced, requiring a solid grasp of low-level console I/O rather than intricate algorithms or design patterns. Third, the problem requires handling a specific edge case—ensuring that a preceding CR does not result in duplicate CR emissions (as addressed in the code change)—but the problem statement and diff do not suggest extensive additional edge cases or complex error handling beyond this. Overall, solving this requires understanding specific parts of the codebase and making targeted, logical modifications, fitting a medium difficulty level of 0.45.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "New window instances do not gain foreground rights\n### Windows Terminal version\n\n1.23.3471.0\n\n### Windows build number\n\n_No response_\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n* Set \"New instance behavior\" to \"Create a new window\"\n* Launch from the start menu (= first window, first tab)\n* Explicitly minimize\n* Launch from the start menu again\n\n### Expected Behavior\n\nNew window is in the foreground.\n\n### Actual Behavior\n\nNew window fails to gain foreground rights.\n", "patch": "diff --git a/src/cascadia/WindowsTerminal/WindowEmperor.cpp b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\nindex 66bc375d0af..6c25d4c8ade 100644\n--- a/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n+++ b/src/cascadia/WindowsTerminal/WindowEmperor.cpp\n@@ -170,6 +170,14 @@ static wil::unique_mutex acquireMutexOrAttemptHandoff(const wchar_t* className,\n                 .cbData = gsl::narrow<DWORD>(payload.size()),\r\n                 .lpData = payload.data(),\r\n             };\r\n+\r\n+            // Allow the existing instance to gain foreground rights.\r\n+            DWORD processId = 0;\r\n+            if (GetWindowThreadProcessId(hwnd, &processId) && processId)\r\n+            {\r\n+                AllowSetForegroundWindow(processId);\r\n+            }\r\n+\r\n             if (SendMessageTimeoutW(hwnd, WM_COPYDATA, 0, reinterpret_cast<LPARAM>(&cds), SMTO_ABORTIFHUNG | SMTO_ERRORONEXIT, 5000, nullptr))\r\n             {\r\n                 return {};\r\n", "instance_id": "microsoft__terminal-18325", "clarity": 2, "difficulty": 0.3, "clarity_explanation": "The problem statement is mostly clear in describing the issue: new window instances of Windows Terminal fail to gain foreground rights when launched under specific conditions (e.g., after minimizing the first window). The steps to reproduce, expected behavior, and actual behavior are provided, which helps in understanding the goal. However, there are minor ambiguities and missing details. For instance, the problem does not specify whether this behavior is consistent across different Windows versions or configurations, nor does it mention any specific constraints or edge cases (e.g., behavior with multiple monitors, user permissions, or other running applications). Additionally, there are no examples of logs or error messages that might provide deeper context. While the issue is valid and understandable, these missing details prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Easy\" range (0.2-0.4) due to several factors. First, the scope of the code change is limited to a single file (`WindowEmperor.cpp`) and involves a small, targeted modification of adding a few lines of code to allow the existing instance to gain foreground rights using `AllowSetForegroundWindow`. This does not impact the broader system architecture or require changes across multiple modules. Second, the technical concepts involved are relatively straightforward: understanding Windows API calls (specifically `AllowSetForegroundWindow` and `GetWindowThreadProcessId`) and basic inter-process communication via `SendMessageTimeoutW`. These are not overly complex for someone familiar with Windows programming. Third, the problem does not explicitly mention edge cases or additional error handling requirements beyond the provided fix, and the code change itself does not introduce significant complexity in this regard. Overall, solving this issue requires understanding some code logic and making a simple modification, but it does not demand deep architectural knowledge or handling of intricate edge cases, justifying a score of 0.30.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "Command History (F7) is added to when selected command from the list\n### Windows Terminal version\n\n1.20.11781.0\n\n### Windows build number\n\n10.0.22631.4037\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\n1. Open a clean command prompt - nothing in the list in F7.\r\n2. Type in a command, e.g. \"dir\"\r\n3. Type in a second different command, e.g. \"dir D*\"\r\n4. Press F7 to see the command list - it will contain two commands. Select the first one from the list.\r\n5. Press F7 to see the command list again, it will now contain three commands. This is unexpected. \n\n### Expected Behavior\n\nSelecting the command from the command list was previously (in Windows 10 command prompt) the way you issued it to ensure it didn't get added to the history, thus allowing you to maintain a nice tidy command list.\n\n### Actual Behavior\n\nInstead it was added to the history.\n", "patch": "diff --git a/src/host/settings.cpp b/src/host/settings.cpp\nindex e2dd84b78e7..0df97dbd354 100644\n--- a/src/host/settings.cpp\n+++ b/src/host/settings.cpp\n@@ -36,7 +36,7 @@ Settings::Settings() :\n     _bAutoPosition(true),\r\n     _uHistoryBufferSize(DEFAULT_NUMBER_OF_COMMANDS),\r\n     _uNumberOfHistoryBuffers(DEFAULT_NUMBER_OF_BUFFERS),\r\n-    _bHistoryNoDup(false),\r\n+    _bHistoryNoDup(true),\r\n     // ColorTable initialized below\r\n     _uCodePage(ServiceLocator::LocateGlobals().uiOEMCP),\r\n     _uScrollScale(1),\r\n@@ -110,7 +110,7 @@ void Settings::ApplyDesktopSpecificDefaults()\n     _bQuickEdit = TRUE;\r\n     _uHistoryBufferSize = 50;\r\n     _uNumberOfHistoryBuffers = 4;\r\n-    _bHistoryNoDup = FALSE;\r\n+    _bHistoryNoDup = true;\r\n \r\n     _renderSettings.ResetColorTable();\r\n \r\ndiff --git a/src/propsheet/registry.cpp b/src/propsheet/registry.cpp\nindex 64d392aa76d..3a7283e080e 100644\n--- a/src/propsheet/registry.cpp\n+++ b/src/propsheet/registry.cpp\n@@ -79,7 +79,7 @@ VOID InitRegistryValues(\n     pStateInfo->CursorSize = 25;\r\n     pStateInfo->HistoryBufferSize = 25;\r\n     pStateInfo->NumberOfHistoryBuffers = 4;\r\n-    pStateInfo->HistoryNoDup = 0;\r\n+    pStateInfo->HistoryNoDup = 1;\r\n \r\n     // clang-format off\r\n     if (pStateInfo->fIsV2Console)\r\n", "instance_id": "microsoft__terminal-17852", "clarity": 2, "difficulty": 0.15, "clarity_explanation": "The problem statement is mostly clear in describing the issue with the command history feature in Windows Terminal. It provides a specific scenario (using F7 to view and select commands) and clearly states the expected behavior (selecting a command should not add it to history) versus the actual behavior (it gets added to history). Steps to reproduce are well-defined, and the context of the issue is provided with version numbers. However, there are minor ambiguities: the problem does not explicitly mention whether this behavior should apply to all command prompts or specific configurations, nor does it discuss potential edge cases (e.g., what happens if the history buffer is full, or if the same command is selected multiple times). Additionally, there are no examples of what a \"tidy command list\" means in terms of constraints or limits. These missing details prevent it from being fully comprehensive, hence a score of 2 (Mostly Clear).", "difficulty_explanation": "The difficulty of this problem is very low, as the code changes provided are minimal and straightforward. The modification involves changing a single boolean flag (`_bHistoryNoDup`) from `false` to `true` in multiple places across two files (`settings.cpp` and `registry.cpp`). This change appears to enable a feature to prevent duplicate entries in the command history, directly addressing the reported issue. The scope of the change is limited to initialization values and does not require deep understanding of the codebase, complex logic, or interactions between modules. No advanced language features, algorithms, or design patterns are involved—just a simple configuration tweak. There are no apparent edge cases or error handling requirements introduced by this change, as it is a static setting adjustment. The impact on the system's architecture is negligible. Therefore, I assign a difficulty score of 0.15, placing it in the \"Very Easy\" range (0.0-0.2), as it requires only basic code modification with minimal cognitive load.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "'unfocusedAppearance' option with any value including empty dictionary causes Windows Terminal to crash all instances when closing just one\n### Windows Terminal version\n\n1.20.11781\n\n### Windows build number\n\n10.0.22631.2861\n\n### Other Software\n\n_No response_\n\n### Steps to reproduce\n\nSo after quite a bit of troubleshooting (including re-installing my entire Windows 11 OS), I've narrowed down the bug and can consistently replicate it.\n\n\n1. Add the `unfocusedAppearance` option in the `defaults` section of your Windows Terminal config, e.g.\n\n```\n   \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        ...\n    },\n```\n\n2. OR alternative use this full config (minimal example):\n\n```md\n{\n    \"$help\": \"https://aka.ms/terminal-documentation\",\n    \"$schema\": \"https://aka.ms/terminal-profiles-schema\",\n    \"actions\": \n    [\n        {\n            \"command\": \n            {\n                \"action\": \"copy\",\n                \"singleLine\": false\n            },\n            \"keys\": \"ctrl+c\"\n        },\n        {\n            \"command\": \"paste\",\n            \"keys\": \"ctrl+v\"\n        },\n        {\n            \"command\": \"find\",\n            \"keys\": \"ctrl+shift+f\"\n        },\n        {\n            \"command\": \n            {\n                \"action\": \"splitPane\",\n                \"split\": \"auto\",\n                \"splitMode\": \"duplicate\"\n            },\n            \"keys\": \"alt+shift+d\"\n        }\n    ],\n    \"copyFormatting\": \"none\",\n    \"copyOnSelect\": false,\n    \"defaultProfile\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n    \"newTabMenu\": \n    [\n        {\n            \"type\": \"remainingProfiles\"\n        }\n    ],\n    \"profiles\": \n    {\n        \"defaults\": \n        {\n            \"opacity\": 90,\n            \"unfocusedAppearance\": \n            {\n            }\n        },\n        \"list\": \n        [\n            {\n                \"guid\": \"{61c54bbd-c2c6-5271-96e7-009a87ff44bf}\",\n                \"hidden\": false,\n                \"name\": \"Windows PowerShell\"\n            },\n            {\n                \"guid\": \"{0caa0dad-35be-5f56-a8ff-afceeeaa6101}\",\n                \"hidden\": false,\n                \"name\": \"Command Prompt\"\n            }\n        ]\n    },\n    \"schemes\": \n    [\n        {\n            \"background\": \"#0C0C0C\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#012456\",\n            \"black\": \"#0C0C0C\",\n            \"blue\": \"#0037DA\",\n            \"brightBlack\": \"#767676\",\n            \"brightBlue\": \"#3B78FF\",\n            \"brightCyan\": \"#61D6D6\",\n            \"brightGreen\": \"#16C60C\",\n            \"brightPurple\": \"#B4009E\",\n            \"brightRed\": \"#E74856\",\n            \"brightWhite\": \"#F2F2F2\",\n            \"brightYellow\": \"#F9F1A5\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#3A96DD\",\n            \"foreground\": \"#CCCCCC\",\n            \"green\": \"#13A10E\",\n            \"name\": \"Campbell Powershell\",\n            \"purple\": \"#881798\",\n            \"red\": \"#C50F1F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#CCCCCC\",\n            \"yellow\": \"#C19C00\"\n        },\n        {\n            \"background\": \"#282C34\",\n            \"black\": \"#282C34\",\n            \"blue\": \"#61AFEF\",\n            \"brightBlack\": \"#5A6374\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B6C2\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C678DD\",\n            \"brightRed\": \"#E06C75\",\n            \"brightWhite\": \"#DCDFE4\",\n            \"brightYellow\": \"#E5C07B\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#56B6C2\",\n            \"foreground\": \"#DCDFE4\",\n            \"green\": \"#98C379\",\n            \"name\": \"One Half Dark\",\n            \"purple\": \"#C678DD\",\n            \"red\": \"#E06C75\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#DCDFE4\",\n            \"yellow\": \"#E5C07B\"\n        },\n        {\n            \"background\": \"#FAFAFA\",\n            \"black\": \"#383A42\",\n            \"blue\": \"#0184BC\",\n            \"brightBlack\": \"#4F525D\",\n            \"brightBlue\": \"#61AFEF\",\n            \"brightCyan\": \"#56B5C1\",\n            \"brightGreen\": \"#98C379\",\n            \"brightPurple\": \"#C577DD\",\n            \"brightRed\": \"#DF6C75\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#E4C07A\",\n            \"cursorColor\": \"#4F525D\",\n            \"cyan\": \"#0997B3\",\n            \"foreground\": \"#383A42\",\n            \"green\": \"#50A14F\",\n            \"name\": \"One Half Light\",\n            \"purple\": \"#A626A4\",\n            \"red\": \"#E45649\",\n            \"selectionBackground\": \"#4F525D\",\n            \"white\": \"#FAFAFA\",\n            \"yellow\": \"#C18301\"\n        },\n        {\n            \"background\": \"#002B36\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#839496\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Dark\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#FDF6E3\",\n            \"black\": \"#002B36\",\n            \"blue\": \"#268BD2\",\n            \"brightBlack\": \"#073642\",\n            \"brightBlue\": \"#839496\",\n            \"brightCyan\": \"#93A1A1\",\n            \"brightGreen\": \"#586E75\",\n            \"brightPurple\": \"#6C71C4\",\n            \"brightRed\": \"#CB4B16\",\n            \"brightWhite\": \"#FDF6E3\",\n            \"brightYellow\": \"#657B83\",\n            \"cursorColor\": \"#002B36\",\n            \"cyan\": \"#2AA198\",\n            \"foreground\": \"#657B83\",\n            \"green\": \"#859900\",\n            \"name\": \"Solarized Light\",\n            \"purple\": \"#D33682\",\n            \"red\": \"#DC322F\",\n            \"selectionBackground\": \"#073642\",\n            \"white\": \"#EEE8D5\",\n            \"yellow\": \"#B58900\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#D3D7CF\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Dark\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#FFFFFF\",\n            \"black\": \"#000000\",\n            \"blue\": \"#3465A4\",\n            \"brightBlack\": \"#555753\",\n            \"brightBlue\": \"#729FCF\",\n            \"brightCyan\": \"#34E2E2\",\n            \"brightGreen\": \"#8AE234\",\n            \"brightPurple\": \"#AD7FA8\",\n            \"brightRed\": \"#EF2929\",\n            \"brightWhite\": \"#EEEEEC\",\n            \"brightYellow\": \"#FCE94F\",\n            \"cursorColor\": \"#000000\",\n            \"cyan\": \"#06989A\",\n            \"foreground\": \"#555753\",\n            \"green\": \"#4E9A06\",\n            \"name\": \"Tango Light\",\n            \"purple\": \"#75507B\",\n            \"red\": \"#CC0000\",\n            \"selectionBackground\": \"#555753\",\n            \"white\": \"#D3D7CF\",\n            \"yellow\": \"#C4A000\"\n        },\n        {\n            \"background\": \"#000000\",\n            \"black\": \"#000000\",\n            \"blue\": \"#000080\",\n            \"brightBlack\": \"#808080\",\n            \"brightBlue\": \"#0000FF\",\n            \"brightCyan\": \"#00FFFF\",\n            \"brightGreen\": \"#00FF00\",\n            \"brightPurple\": \"#FF00FF\",\n            \"brightRed\": \"#FF0000\",\n            \"brightWhite\": \"#FFFFFF\",\n            \"brightYellow\": \"#FFFF00\",\n            \"cursorColor\": \"#FFFFFF\",\n            \"cyan\": \"#008080\",\n            \"foreground\": \"#C0C0C0\",\n            \"green\": \"#008000\",\n            \"name\": \"Vintage\",\n            \"purple\": \"#800080\",\n            \"red\": \"#800000\",\n            \"selectionBackground\": \"#FFFFFF\",\n            \"white\": \"#C0C0C0\",\n            \"yellow\": \"#808000\"\n        }\n    ],\n    \"themes\": []\n}\n```\n\n3. Now launch two instances of Windows Terminal.\n4. Using your mouse, press the 'x' button on the top-right of the first instance.\n5. The first instance will freeze a bit, crash, and cause both instances to shut.\n6. If you view Event Viewer logs, under Application logs, you will see that the application has indeed crashed with an ERROR.\n\nOther things to know:\n- Removing the `unfocusedAppearance` option fixes the issue (but you lose that feature).\n- The `unfocusedAppearance` use to work for me on older builds (I don't know which ones but I use to use this feature a lot).\n- Adding any options in the `unfocusedAppearance` still causes the crash.\n- Shutting any of the Windows Terminal using 'CTRL+W' shortcut avoids this crashing behaviour.\n\n### Expected Behavior\n\nWhen I shut a single instance of Windows Terminal, it should only shut that instance and not shut all other instances. This likely happens because the parent process crashes, killing all spawned windows terminal children.\n\n### Actual Behavior\n\nPressing the 'x' button causes all windows terminal instances to shut.\n", "patch": "diff --git a/src/cascadia/TerminalControl/TermControl.cpp b/src/cascadia/TerminalControl/TermControl.cpp\nindex 045762a3ac0..8f8f9f0df66 100644\n--- a/src/cascadia/TerminalControl/TermControl.cpp\n+++ b/src/cascadia/TerminalControl/TermControl.cpp\n@@ -717,11 +717,14 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n         // terminal.\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _core.UpdateSettings(settings, unfocusedAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _core.UpdateSettings(settings, unfocusedAppearance);\r\n \r\n-        _UpdateSettingsFromUIThread();\r\n+            _UpdateSettingsFromUIThread();\r\n \r\n-        _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+            _UpdateAppearanceFromUIThread(_focused ? _core.FocusedAppearance() : _core.UnfocusedAppearance());\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n@@ -730,10 +733,15 @@ namespace winrt::Microsoft::Terminal::Control::implementation\n     // - newAppearance: the new appearance to set\r\n     winrt::fire_and_forget TermControl::UpdateAppearance(IControlAppearance newAppearance)\r\n     {\r\n+        auto weakThis{ get_weak() };\r\n+\r\n         // Dispatch a call to the UI thread\r\n         co_await wil::resume_foreground(Dispatcher());\r\n \r\n-        _UpdateAppearanceFromUIThread(newAppearance);\r\n+        if (auto strongThis{ weakThis.get() })\r\n+        {\r\n+            _UpdateAppearanceFromUIThread(newAppearance);\r\n+        }\r\n     }\r\n \r\n     // Method Description:\r\n", "instance_id": "microsoft__terminal-17770", "clarity": 2, "difficulty": 0.45, "clarity_explanation": "The problem statement is mostly clear in describing the issue: the `unfocusedAppearance` option in the Windows Terminal configuration causes all instances to crash when closing just one instance using the 'x' button. It provides detailed steps to reproduce the issue, including a minimal configuration example, and specifies the expected versus actual behavior. Additionally, it includes relevant context such as the Windows Terminal version, Windows build number, and observations about the crash behavior (e.g., Event Viewer logs and alternative closing methods like 'CTRL+W' not causing the issue). However, there are minor ambiguities and missing details. For instance, the problem statement does not explicitly mention whether the crash occurs under specific conditions beyond the provided configuration (e.g., specific hardware or other software interactions). Edge cases related to different configuration values or system states are not fully explored, which could be critical for a comprehensive fix. Overall, while the problem is well-documented for reproduction, these minor gaps prevent it from being fully comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the medium range due to several factors. First, the scope of the code changes appears limited to a single file (`TermControl.cpp`) and involves modifications to specific methods (`UpdateSettings` and `UpdateAppearance`). The changes introduce weak reference checks (`weakThis.get()`) to prevent potential crashes due to object lifetime issues, suggesting a bug related to accessing invalid or destroyed objects during UI updates. This requires understanding C++ concepts such as smart pointers, object lifetime management, and asynchronous programming with `co_await` in the context of Windows Terminal's UI thread dispatching. While the code change itself is small (adding null checks), the difficulty lies in diagnosing the root cause of the crash, which likely involves understanding the interaction between the UI thread, terminal core settings, and appearance updates. The problem does not seem to impact the broader system architecture significantly, but it does require careful handling of potential edge cases, such as ensuring the weak reference check does not introduce new issues (e.g., skipped updates). Additionally, debugging crashes in a multi-instance application like Windows Terminal may involve analyzing stack traces or logs, which adds moderate complexity. Overall, this problem requires a solid understanding of C++ and the Windows Terminal codebase but does not appear to demand extensive refactoring or advanced domain-specific knowledge, placing it in the medium difficulty range of 0.4-0.6.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
{"problem_statement": "ConPTY does not pass Device Control Strings (DCS) to 3rd-party terminals\n### Windows Terminal version\r\n\r\n1.19.11213.0\r\n\r\n### Windows build number\r\n\r\n10.0.22631.0\r\n\r\n### Other Software\r\n\r\n_No response_\r\n\r\n### Steps to reproduce\r\n\r\nWe're thrilled by the release and development of ConPTY. We're hoping it can support our usage of Device Control Strings.\r\n\r\nFrom any 3rd-party terminal that wishes to \"speak ANSI\" using ConPTY, run any command that outputs a DCS escape sequence. (I'm using a locally built alacritty)\r\n\r\n```\r\nPowerShell 7.4.2\r\necho \"`eP <some data for terminal> `e\\\"\r\n```\r\n\r\nAlacritty does not receive the DCS.\r\n\r\n### Expected Behavior\r\n\r\nI expect DCS escape sequences to be output by ConPTY so that 3rd-party terminals may use this to implement more advanced features.\r\n\r\n### Context\r\n\r\nI work for Warp and we'd like to bring Warp Terminal to Windows. Warp depends heavily on DCS strings for its key features.\r\n\r\n### Alternatives Considered\r\n\r\nWe tried utilizing a custom OSC sequence instead. We notice that unhandled OSC gets [flushed to the terminal](https://github.com/microsoft/terminal/blob/e826203bb7e200f6f7029b6d8be68fb330c18735/src/terminal/parser/OutputStateMachineEngine.cpp#L924-L927). Although with this method Warp is able to receive these data as we'd like, the ordering is not preserved, i.e. if the shell outputs an OSC interleaved with text, when it is read out of ConPTY by the terminal, the OSC is not received in the same order in which it was produced. Warp does depend on that ordering, which is an invariant on UNIX PTYs.\r\n\r\nIt would be nice if DCS had similar logic where `_pfnFlushToTerminal` was called like it is for OSC, but where ordering is preserved.\r\n\r\n### Actual Behavior\r\n\r\nOnly DCS escape sequences that Windows Terminal recognizes are being dispatched. As we understand it, ConPTY is an interface intended to be used by 3rd-party terminals for optimal compatibility. Therefore, it makes sense to expand support for arbitrary DCS sequences that other terminals might depend on.\n", "patch": "", "instance_id": "microsoft__terminal-17510", "clarity": 2, "difficulty": 0.65, "clarity_explanation": "The problem statement is mostly clear in describing the issue with ConPTY not passing Device Control Strings (DCS) to third-party terminals. It provides context about the expected behavior, actual behavior, and the importance of DCS for the requester's application (Warp Terminal). Steps to reproduce are included, along with a specific example of a command to test the issue. Additionally, alternatives considered (using OSC sequences) and their shortcomings are mentioned, which adds depth to the problem description. However, there are minor ambiguities and missing details. For instance, the problem does not explicitly define the full range of DCS sequences that need to be supported or provide detailed examples of the ordering issue with OSC sequences. Edge cases, such as malformed DCS sequences or performance implications of handling arbitrary DCS, are not addressed. Overall, while the goal and context are clear, these minor gaps prevent it from being comprehensive.", "difficulty_explanation": "The difficulty of this problem falls into the \"Hard\" category due to several factors. First, the scope of the change likely involves modifying the ConPTY layer within the Windows Terminal codebase, which is a critical component responsible for terminal emulation and communication with third-party terminals. This requires a deep understanding of the terminal's architecture, specifically how escape sequences (like DCS and OSC) are parsed and dispatched. The reference to specific lines of code in `OutputStateMachineEngine.cpp` suggests that the change may be localized to a specific module, but implementing a solution that preserves ordering while flushing unhandled DCS sequences to the terminal will require careful design to avoid breaking existing behavior. \n\nSecond, the technical concepts involved include low-level terminal emulation, ANSI escape sequence handling, and potentially threading or buffering mechanisms to maintain sequence ordering. This demands familiarity with Windows-specific APIs (like ConPTY), as well as domain-specific knowledge of terminal protocols, which are niche and complex.\n\nThird, edge cases and error handling are likely to be significant. The problem statement does not explicitly mention edge cases, but supporting arbitrary DCS sequences introduces risks such as handling malformed input, ensuring compatibility with various third-party terminals, and managing performance impacts of flushing large or frequent sequences. These considerations add to the complexity.\n\nFinally, while the exact code changes are not provided, the impact of modifying ConPTY could affect the broader system, as it is a foundational interface for terminal compatibility. Balancing the needs of third-party terminals like Warp with the existing behavior of Windows Terminal will require careful testing and validation. Given these factors, I rate the difficulty as 0.65, reflecting a hard problem that requires deep technical expertise and thoughtful implementation, though it may not reach the extreme complexity of system-level redesigns or highly intricate algorithms.", "clarity_label": -1, "difficulty_label": -1, "human_clarity": -1, "human_difficulty": -1}
